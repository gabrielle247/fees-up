#!/bin/bash
# perf-profile - Performance analysis utility for Batch One
# Usage: perf-profile <file_paths...>

set -euo pipefail

TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
OUTPUT_FILE="./perf_profiles/perf_profile_${TIMESTAMP}.md"

mkdir -p "./perf_profiles"

{
  echo "# Batch One - Performance Profile Report"
  echo "## Generated: $(date)"
  echo "## Files Analyzed:"
  for file in "$@"; do
    echo "  - $file"
  done
  echo ""
  echo "## Performance Findings"
  echo ""
} > "$OUTPUT_FILE"

for file in "$@"; do
  if [[ ! -f "$file" ]]; then
    continue
  fi
  
  {
    echo "### File: $file"
    echo ""
    
    # Check for inefficient loops
    loops=$(grep -n -E "(for.*in|while|\.forEach)" "$file" 2>/dev/null || true)
    if [[ -n "$loops" ]]; then
      echo "**Loop Operations:**"
      echo "\`\`\`dart"
      echo "$loops"
      echo "\`\`\`"
      echo ""
    fi
    
    # Check for potential memory issues
    collections=$(grep -n -E "(\.toList\(|\.toSet\(|\.toMap\()" "$file" 2>/dev/null || true)
    if [[ -n "$collections" ]]; then
      echo "**Collection Operations:**"
      echo "\`\`\`dart"
      echo "$collections"
      echo "\`\`\`"
      echo ""
    fi
    
    # Check for async/await patterns
    async_ops=$(grep -n -E "(async|await|Future|Stream)" "$file" 2>/dev/null || true)
    if [[ -n "$async_ops" ]]; then
      echo "**Async Operations:**"
      echo "\`\`\`dart"
      echo "$async_ops"
      echo "\`\`\`"
      echo ""
    fi
    
    # Check for UI build methods
    build_methods=$(grep -n -E "(build|Widget)" "$file" 2>/dev/null || true)
    if [[ -n "$build_methods" ]]; then
      echo "**UI Build Methods:**"
      echo "\`\`\`dart"
      echo "$build_methods"
      echo "\`\`\`"
      echo ""
    fi
    
    echo ""
  } >> "$OUTPUT_FILE"
done

echo "Performance profile complete. Report saved to: $OUTPUT_FILE"

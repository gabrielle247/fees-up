
// ==========================================
// FILE: ./announcements/compose_broadcast_dialog.dart
// ==========================================

import 'package:fees_up/data/providers/broadcast_provider.dart';
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../../core/constants/app_colors.dart';

class ComposeBroadcastDialog extends ConsumerStatefulWidget {
  const ComposeBroadcastDialog({super.key});

  @override
  ConsumerState<ComposeBroadcastDialog> createState() => _ComposeBroadcastDialogState();
}

class _ComposeBroadcastDialogState extends ConsumerState<ComposeBroadcastDialog> {
  final _formKey = GlobalKey<FormState>();
  final _titleCtrl = TextEditingController();
  final _bodyCtrl = TextEditingController();
  String _priority = 'normal';
  bool _isLoading = false;

  Future<void> _submit() async {
    if (!_formKey.currentState!.validate()) return;

    setState(() => _isLoading = true);

    try {
      await ref.read(broadcastLogicProvider).post(
        title: _titleCtrl.text.trim(),
        body: _bodyCtrl.text.trim(),
        priority: _priority,
      );
      if (mounted) Navigator.pop(context);
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text("Error: $e"), backgroundColor: AppColors.errorRed),
        );
      }
    } finally {
      if (mounted) setState(() => _isLoading = false);
    }
  }

  @override
  Widget build(BuildContext context) {
    return Dialog(
      backgroundColor: AppColors.surfaceGrey,
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
      child: Container(
        width: 500,
        padding: const EdgeInsets.all(24),
        child: Form(
          key: _formKey,
          child: Column(
            mainAxisSize: MainAxisSize.min,
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              const Text("Post Broadcast", style: TextStyle(color: AppColors.textWhite, fontSize: 18, fontWeight: FontWeight.bold)),
              const SizedBox(height: 24),
              TextFormField(
                controller: _titleCtrl,
                style: const TextStyle(color: AppColors.textWhite),
                validator: (v) => v!.isEmpty ? "Required" : null,
                decoration: _inputDecoration("Title"),
              ),
              const SizedBox(height: 16),
              TextFormField(
                controller: _bodyCtrl,
                style: const TextStyle(color: AppColors.textWhite),
                validator: (v) => v!.isEmpty ? "Required" : null,
                maxLines: 4,
                decoration: _inputDecoration("Body"),
              ),
              const SizedBox(height: 16),
              DropdownButtonFormField<String>(
                initialValue: _priority, // Controlled value
                dropdownColor: AppColors.surfaceGrey,
                style: const TextStyle(color: AppColors.textWhite),
                decoration: _inputDecoration("Priority"),
                items: const [
                  DropdownMenuItem(value: 'normal', child: Text("Normal")),
                  DropdownMenuItem(value: 'high', child: Text("High")),
                  DropdownMenuItem(value: 'critical', child: Text("Critical")),
                ],
                onChanged: (v) => setState(() => _priority = v!),
              ),
              const SizedBox(height: 32),
              Row(
                mainAxisAlignment: MainAxisAlignment.end,
                children: [
                  TextButton(
                    onPressed: _isLoading ? null : () => Navigator.pop(context),
                    child: const Text("Cancel", style: TextStyle(color: AppColors.textWhite70)),
                  ),
                  const SizedBox(width: 12),
                  ElevatedButton.icon(
                    onPressed: _isLoading ? null : _submit,
                    icon: _isLoading 
                        ? const SizedBox(width: 16, height: 16, child: CircularProgressIndicator(strokeWidth: 2, color: Colors.white))
                        : const Icon(Icons.send, size: 16),
                    label: Text(_isLoading ? "Posting..." : "Post"),
                    style: ElevatedButton.styleFrom(backgroundColor: AppColors.primaryBlue, foregroundColor: Colors.white),
                  ),
                ],
              ),
            ],
          ),
        ),
      ),
    );
  }

  InputDecoration _inputDecoration(String label) {
    return InputDecoration(
      labelText: label,
      labelStyle: const TextStyle(color: AppColors.textWhite54),
      filled: true,
      fillColor: AppColors.backgroundBlack,
      border: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.divider)),
    );
  }
}
// ==========================================
// FILE: ./announcements/broadcast_kpi_cards.dart
// ==========================================

import 'package:fees_up/data/providers/broadcast_provider.dart';
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../../core/constants/app_colors.dart';

class BroadcastKpiCards extends ConsumerWidget {
  const BroadcastKpiCards({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    // --- THE FIX: AGGREGATED CONTEXT ---
    // We watch both streams to provide a holistic view for the Super Admin
    final schoolFeedAsync = ref.watch(schoolBroadcastProvider);
    final hqFeedAsync = ref.watch(internalHQBroadcastProvider);

    return Row(
      children: [
        // 1. Critical Alerts (From School Feed)
        _buildAsyncCard(
          schoolFeedAsync,
          title: "Critical Alerts",
          icon: Icons.warning_amber_rounded,
          color: AppColors.errorRed,
          bgColor: AppColors.errorRedBg,
          countLogic: (list) => list.where((b) => b.priority == 'critical').length,
        ),
        const SizedBox(width: 24),

        // 2. System Notices (From Greyway HQ Feed)
        // Loophole Closed: This now tracks Global HQ alerts specifically [cite: 2025-12-30]
        _buildAsyncCard(
          hqFeedAsync,
          title: "HQ Internal",
          icon: Icons.security_outlined,
          color: AppColors.accentPurple,
          bgColor: AppColors.accentPurple.withAlpha(25),
          countLogic: (list) => list.length,
        ),
        const SizedBox(width: 24),

        // 3. Active Broadcasts (Total Local School messages)
        _buildAsyncCard(
          schoolFeedAsync,
          title: "Active Broadcasts",
          icon: Icons.campaign_outlined,
          color: AppColors.successGreen,
          bgColor: AppColors.successGreenBg,
          countLogic: (list) => list.length,
        ),
      ],
    );
  }

  /// Helper to build cards that handle their own loading/error states per stream [cite: 2025-12-30]
  Widget _buildAsyncCard(
    AsyncValue<List<dynamic>> asyncValue, {
    required String title,
    required IconData icon,
    required Color color,
    required Color bgColor,
    required int Function(List<dynamic>) countLogic,
  }) {
    return Expanded(
      child: Container(
        padding: const EdgeInsets.all(20),
        decoration: BoxDecoration(
          color: AppColors.surfaceGrey,
          borderRadius: BorderRadius.circular(12),
          border: Border.all(color: AppColors.divider),
        ),
        child: asyncValue.when(
          data: (list) => Row(
            children: [
              Container(
                padding: const EdgeInsets.all(12),
                decoration: BoxDecoration(color: bgColor, borderRadius: BorderRadius.circular(8)),
                child: Icon(icon, color: color, size: 24),
              ),
              const SizedBox(width: 16),
              Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(title, style: const TextStyle(color: AppColors.textWhite70, fontSize: 13)),
                  Text(
                    countLogic(list).toString(),
                    style: const TextStyle(color: AppColors.textWhite, fontSize: 24, fontWeight: FontWeight.bold),
                  ),
                ],
              ),
            ],
          ),
          loading: () => const Center(child: SizedBox(width: 20, height: 20, child: CircularProgressIndicator(strokeWidth: 2))),
          error: (_, __) => const Icon(Icons.error_outline, color: AppColors.errorRed, size: 20),
        ),
      ),
    );
  }
}
// ==========================================
// FILE: ./announcements/broadcast_list.dart
// ==========================================

import 'package:fees_up/data/providers/broadcast_provider.dart';
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:intl/intl.dart';
import '../../../../core/constants/app_colors.dart';
import '../../../../data/models/broadcast_model.dart';
import 'compose_broadcast_dialog.dart';

class BroadcastList extends ConsumerStatefulWidget {
  const BroadcastList({super.key});

  @override
  ConsumerState<BroadcastList> createState() => _BroadcastListState();
}

class _BroadcastListState extends ConsumerState<BroadcastList> {
  String _filter = 'All'; // 'All', 'System', 'Internal'

  @override
  Widget build(BuildContext context) {
    // SWITCHER LOGIC: Select the correct Fortress Stream [cite: 2025-12-30]
    final AsyncValue<List<Broadcast>> feedAsync = (_filter == 'Internal')
        ? ref.watch(internalHQBroadcastProvider)
        : ref.watch(schoolBroadcastProvider);

    return Container(
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: AppColors.divider),
      ),
      child: Column(
        children: [
          Padding(
            padding: const EdgeInsets.all(16),
            child: Row(
              children: [
                _buildFilterTab("All"),
                _buildFilterTab("System"),
                _buildFilterTab("Internal"),
                const Spacer(),
                OutlinedButton.icon(
                  onPressed: () => _filter == 'Internal' 
                      ? ref.refresh(internalHQBroadcastProvider) 
                      : ref.refresh(schoolBroadcastProvider),
                  icon: const Icon(Icons.refresh, size: 16),
                  label: const Text("Refresh Feed"),
                  style: OutlinedButton.styleFrom(
                    foregroundColor: AppColors.textWhite,
                    side: const BorderSide(color: AppColors.divider),
                  ),
                ),
                const SizedBox(width: 12),
                ElevatedButton.icon(
                  onPressed: () => _showComposeDialog(context),
                  icon: const Icon(Icons.edit, size: 16),
                  label: const Text("Post Update"),
                  style: ElevatedButton.styleFrom(backgroundColor: AppColors.primaryBlue, foregroundColor: Colors.white),
                ),
              ],
            ),
          ),
          const Divider(height: 1, color: AppColors.divider),
          feedAsync.when(
            data: (broadcasts) {
              final filtered = _filter == 'System' 
                  ? broadcasts.where((b) => b.isSystemMessage).toList() 
                  : broadcasts;
              
              if (filtered.isEmpty) {
                return _buildEmptyState();
              }

              return ListView.separated(
                shrinkWrap: true,
                physics: const NeverScrollableScrollPhysics(),
                itemCount: filtered.length,
                separatorBuilder: (context, index) => const Divider(height: 1, color: AppColors.divider),
                itemBuilder: (context, index) => _buildBroadcastItem(filtered[index]),
              );
            },
            loading: () => const Padding(padding: EdgeInsets.all(40), child: Center(child: CircularProgressIndicator())),
            error: (e, s) => Padding(padding: const EdgeInsets.all(20), child: Text("Error: $e", style: const TextStyle(color: AppColors.errorRed))),
          ),
        ],
      ),
    );
  }

  Widget _buildBroadcastItem(Broadcast item) {
    final timeStr = DateFormat('MMM d, h:mm a').format(item.createdAt);
    return Container(
      padding: const EdgeInsets.all(20),
      color: item.isInternalHQ ? AppColors.purpleBg : (item.isSystemMessage ? AppColors.primaryBlueBg : null),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          CircleAvatar(
            backgroundColor: item.badgeColor.withAlpha(40),
            child: Icon(item.icon, color: item.badgeColor, size: 20),
          ),
          const SizedBox(width: 16),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(
                  children: [
                    Container(
                      padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                      decoration: BoxDecoration(color: item.badgeColor.withAlpha(50), borderRadius: BorderRadius.circular(4)),
                      child: Text(item.authorLabel.toUpperCase(), style: TextStyle(color: item.badgeColor, fontSize: 10, fontWeight: FontWeight.bold)),
                    ),
                    const SizedBox(width: 8),
                    Text(item.title, style: const TextStyle(color: AppColors.textWhite, fontWeight: FontWeight.bold, fontSize: 14)),
                  ],
                ),
                const SizedBox(height: 8),
                Text(item.body, style: const TextStyle(color: AppColors.textWhite70, fontSize: 13, height: 1.4)),
              ],
            ),
          ),
          Column(
            crossAxisAlignment: CrossAxisAlignment.end,
            children: [
              Text(timeStr, style: const TextStyle(color: AppColors.textWhite38, fontSize: 12)),
              const SizedBox(height: 8),
              if (item.priority == 'critical') const Icon(Icons.report, color: AppColors.errorRed, size: 16),
            ],
          ),
        ],
      ),
    );
  }

  Widget _buildFilterTab(String label) {
    final isActive = _filter == label;
    return GestureDetector(
      onTap: () => setState(() => _filter = label),
      child: Container(
        margin: const EdgeInsets.only(right: 8),
        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
        decoration: BoxDecoration(
          color: isActive ? AppColors.backgroundBlack : Colors.transparent,
          borderRadius: BorderRadius.circular(6),
          border: isActive ? Border.all(color: AppColors.divider) : null,
        ),
        child: Text(label, style: TextStyle(color: isActive ? AppColors.textWhite : AppColors.textWhite70, fontSize: 13)),
      ),
    );
  }

  Widget _buildEmptyState() {
    return const Padding(
      padding: EdgeInsets.all(48.0),
      child: Center(child: Text("No broadcasts in this category", style: TextStyle(color: AppColors.textWhite38))),
    );
  }

  void _showComposeDialog(BuildContext context) {
    showDialog(
      context: context,
      barrierColor: AppColors.overlayDark,
      builder: (context) => const ComposeBroadcastDialog(),
    );
  }
}
// ==========================================
// FILE: ./students/students_table.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:intl/intl.dart';
import '../../../../core/constants/app_colors.dart';
import '../../../../core/utils/safe_data.dart';
import '../../../../data/providers/students_provider.dart';
import 'edit_student_dialog.dart';
import 'quick_payment_dialog.dart';
import 'student_bills_dialog.dart';

class StudentsTable extends ConsumerStatefulWidget {
  final String schoolId;
  const StudentsTable({super.key, required this.schoolId});

  @override
  ConsumerState<StudentsTable> createState() => _StudentsTableState();
}

class _StudentsTableState extends ConsumerState<StudentsTable> {
  List<String> _grades = [];
  List<String> _classes = [];
  bool _classesAvailable = false;

  @override
  void initState() {
    super.initState();
    _loadGradesAndClasses();
  }

  Future<void> _loadGradesAndClasses() async {
    // Load ZIMSEC grades (fixed for Zimbabwe)
    setState(() {
      _grades = ['All Grades', ...zimsecGrades];
    });
  }

  @override
  Widget build(BuildContext context) {
    final filteredStudents =
        ref.watch(filteredStudentsProvider(widget.schoolId));

    // Watch classes to determine if filter should be enabled
    final classesAsync = ref.watch(classesProvider(widget.schoolId));

    // Update classes availability
    classesAsync.when(
      data: (classes) {
        _classes = ['All Classes', ...classes.map((c) => c['name'] as String)];
        _classesAvailable = classes.isNotEmpty;
      },
      loading: () {},
      error: (_, __) {},
    );

    return Container(
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: AppColors.divider),
      ),
      child: Column(
        children: [
          // --- 1. Filter Bar ---
          _buildFilterBar(),
          const Divider(height: 1, color: AppColors.divider),

          // --- 2. Table Headers ---
          _buildTableHeader(),
          const Divider(height: 1, color: AppColors.divider),

          // --- 3. Real Data List (Provider-Powered) ---
          Builder(
            builder: (context) {
              if (filteredStudents.isEmpty) {
                return const Padding(
                  padding: EdgeInsets.all(40.0),
                  child: Center(
                      child: Text(
                          "No students found. Try adjusting your filters.",
                          style: TextStyle(color: AppColors.textGrey))),
                );
              }

              return ListView.separated(
                shrinkWrap: true,
                physics: const NeverScrollableScrollPhysics(),
                itemCount: filteredStudents.length,
                separatorBuilder: (_, __) =>
                    const Divider(height: 1, color: AppColors.divider),
                itemBuilder: (context, index) {
                  final s = filteredStudents[index];
                  return _buildStudentRow(s);
                },
              );
            },
          ),

          // --- 4. Pagination Footer ---
          _buildFooter(filteredStudents.length),
        ],
      ),
    );
  }

  Widget _buildFilterBar() {
    final selectedGrade = ref.watch(studentGradeFilterProvider);
    final selectedClass = ref.watch(studentClassFilterProvider);
    final selectedStatus = ref.watch(studentStatusFilterProvider);
    final selectedFinancial = ref.watch(studentFinancialFilterProvider);

    return Padding(
      padding: const EdgeInsets.all(16),
      child: Row(
        children: [
          // Grade Filter - Always enabled
          _buildDropdownButton(
            label: selectedGrade ?? "All Grades",
            items: _grades,
            enabled: true,
            onSelected: (value) {
              ref.read(studentGradeFilterProvider.notifier).state = value;
            },
          ),
          const SizedBox(width: 12),
          // Class Filter - Disabled if no classes exist
          _buildDropdownButton(
            label: selectedClass ?? "All Classes",
            items: _classes.isEmpty ? ['All Classes'] : _classes,
            enabled: _classesAvailable,
            onSelected: _classesAvailable
                ? (value) {
                    ref.read(studentClassFilterProvider.notifier).state = value;
                  }
                : null,
          ),
          const SizedBox(width: 12),
          // Status Filter - Now includes Suspended and Banned Forever
          _buildDropdownButton(
            label: selectedStatus ?? "Status: All",
            items: studentStatusOptions,
            enabled: true,
            onSelected: (value) {
              ref.read(studentStatusFilterProvider.notifier).state = value;
            },
          ),
          const SizedBox(width: 12),
          // Financial Filter
          _buildDropdownButton(
            label: selectedFinancial ?? "Financial: All",
            items: const [
              "Financial: All",
              "Financial: Owed",
              "Financial: Paid"
            ],
            enabled: true,
            onSelected: (value) {
              ref.read(studentFinancialFilterProvider.notifier).state = value;
            },
          ),
          const Spacer(),
          TextButton(
            onPressed: () {
              ref.read(studentSearchProvider.notifier).state = '';
              ref.read(studentGradeFilterProvider.notifier).state = null;
              ref.read(studentClassFilterProvider.notifier).state = null;
              ref.read(studentStatusFilterProvider.notifier).state = null;
              ref.read(studentFinancialFilterProvider.notifier).state = null;
            },
            child: const Text("Clear Filters",
                style: TextStyle(color: AppColors.primaryBlue, fontSize: 13)),
          )
        ],
      ),
    );
  }

  Widget _buildDropdownButton(
      {required String label,
      required List<String> items,
      required bool enabled,
      required Function(String?)? onSelected}) {
    return Opacity(
      opacity: enabled ? 1.0 : 0.5,
      child: PopupMenuButton<String>(
        enabled: enabled,
        onSelected: onSelected,
        child: Container(
          height: 36,
          padding: const EdgeInsets.symmetric(horizontal: 12),
          decoration: BoxDecoration(
            color: AppColors.backgroundBlack,
            borderRadius: BorderRadius.circular(6),
            border: Border.all(
                color: enabled ? AppColors.divider : AppColors.textWhite38),
          ),
          child: Row(
            children: [
              Text(label,
                  style: TextStyle(
                      color:
                          enabled ? AppColors.textWhite : AppColors.textWhite54,
                      fontSize: 13)),
              const SizedBox(width: 8),
              Icon(Icons.keyboard_arrow_down,
                  color:
                      enabled ? AppColors.textWhite54 : AppColors.textWhite38,
                  size: 16),
            ],
          ),
        ),
        itemBuilder: (context) => items
            .map((item) => PopupMenuItem<String>(
                  value: item,
                  child: Text(item),
                ))
            .toList(),
      ),
    );
  }

  Widget _buildTableHeader() {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 16),
      child: Row(
        children: [
          _col("STUDENT NAME", 3),
          _col("ID / GRADE", 2),
          _col("PARENT CONTACT", 3),
          _col("STATUS", 2),
          _col("OWED AMOUNT", 2, alignRight: true),
          _col("ACTIONS", 1, alignRight: true),
        ],
      ),
    );
  }

  Widget _col(String text, int flex, {bool alignRight = false}) {
    return Expanded(
      flex: flex,
      child: Text(
        text,
        textAlign: alignRight ? TextAlign.right : TextAlign.left,
        style: const TextStyle(
            color: AppColors.textWhite38,
            fontSize: 11,
            fontWeight: FontWeight.bold,
            letterSpacing: 0.8),
      ),
    );
  }

  Widget _buildStudentRow(Map<String, dynamic> s) {
    final name = s['full_name'] ?? 'Unknown';
    final id = s['student_id'] ?? '---';
    final grade = s['grade'] ?? 'N/A';
    final parentName = s['emergency_contact_name'] ?? 'No Contact';
    final contact = s['parent_contact'] ?? '';
    final isActive = SafeData.parseInt(s['is_active']) == 1;
    final isSuspended = SafeData.parseInt(s['is_suspended']) == 1;
    final owed = SafeData.parseDouble(s['owed_total'], 0.0);

    // Initials for Avatar
    final initials = name.isNotEmpty ? name.substring(0, 1).toUpperCase() : "?";

    // Determine status display
    String statusLabel;
    Color statusColor;
    Color statusBackgroundColor;

    if (isSuspended) {
      statusLabel = "Banned Forever";
      statusColor = AppColors.errorRed;
      statusBackgroundColor = AppColors.errorRed.withValues(alpha: 0.15);
    } else if (!isActive) {
      statusLabel = "Inactive";
      statusColor = AppColors.textGrey;
      statusBackgroundColor = AppColors.surfaceLightGrey;
    } else {
      statusLabel = "Active";
      statusColor = AppColors.successGreen;
      statusBackgroundColor = AppColors.successGreen.withValues(alpha: 0.15);
    }

    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 16),
      child: Row(
        children: [
          // 1. Name & Avatar
          Expanded(
            flex: 3,
            child: Row(
              children: [
                CircleAvatar(
                  radius: 16,
                  backgroundColor: AppColors.primaryBlue.withValues(alpha: 0.2),
                  child: Text(initials,
                      style: const TextStyle(
                          color: AppColors.primaryBlue,
                          fontWeight: FontWeight.bold,
                          fontSize: 12)),
                ),
                const SizedBox(width: 12),
                Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(name,
                        style: const TextStyle(
                            color: AppColors.textWhite,
                            fontWeight: FontWeight.w500,
                            fontSize: 13)),
                    Text("Class $grade",
                        style: const TextStyle(
                            color: AppColors.textWhite38, fontSize: 11)),
                  ],
                ),
              ],
            ),
          ),

          // 2. ID / Grade
          Expanded(
            flex: 2,
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text("#$id",
                    style: const TextStyle(
                        color: AppColors.textWhite, fontSize: 13)),
                Container(
                  margin: const EdgeInsets.only(top: 4),
                  padding:
                      const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                  decoration: BoxDecoration(
                      color: AppColors.surfaceLightGrey,
                      borderRadius: BorderRadius.circular(4)),
                  child: Text("Grade $grade",
                      style: const TextStyle(
                          color: AppColors.textWhite70, fontSize: 10)),
                ),
              ],
            ),
          ),

          // 3. Parent Contact
          Expanded(
            flex: 3,
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(parentName,
                    style: const TextStyle(
                        color: AppColors.textWhite, fontSize: 13)),
                Text(contact,
                    style: const TextStyle(
                        color: AppColors.textWhite38, fontSize: 11)),
              ],
            ),
          ),

          // 4. Status
          Expanded(
            flex: 2,
            child: Row(
              children: [
                Container(
                  padding:
                      const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                  decoration: BoxDecoration(
                    color: statusBackgroundColor,
                    borderRadius: BorderRadius.circular(4),
                  ),
                  child: Text(
                    statusLabel,
                    style: TextStyle(
                        color: statusColor,
                        fontSize: 11,
                        fontWeight: FontWeight.bold),
                  ),
                ),
              ],
            ),
          ),

          // 5. Owed Amount
          Expanded(
            flex: 2,
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.end,
              children: [
                Text(NumberFormat.simpleCurrency().format(owed),
                    style: const TextStyle(
                        color: AppColors.textWhite,
                        fontWeight: FontWeight.bold,
                        fontSize: 13)),
                Text(
                  owed > 0 ? "Overdue" : "Paid",
                  style: TextStyle(
                      color: owed > 0
                          ? AppColors.errorRed
                          : AppColors.successGreen,
                      fontSize: 11),
                ),
              ],
            ),
          ),

          // 6. Actions - Quick Actions Popup Menu
          Expanded(
            flex: 1,
            child: Row(
              mainAxisAlignment: MainAxisAlignment.end,
              children: [
                PopupMenuButton<String>(
                  icon: const Icon(Icons.more_vert,
                      size: 18, color: AppColors.textWhite54),
                  color: AppColors.surfaceGrey,
                  offset: const Offset(0, 40),
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(8),
                    side: const BorderSide(color: AppColors.divider),
                  ),
                  itemBuilder: (context) => [
                    const PopupMenuItem<String>(
                      value: 'view',
                      child: Row(
                        children: [
                          Icon(Icons.visibility_outlined,
                              size: 16, color: AppColors.primaryBlue),
                          SizedBox(width: 12),
                          Text('View Details',
                              style: TextStyle(color: AppColors.textWhite)),
                        ],
                      ),
                    ),
                    const PopupMenuItem<String>(
                      value: 'pay',
                      child: Row(
                        children: [
                          Icon(Icons.payment,
                              size: 16, color: AppColors.successGreen),
                          SizedBox(width: 12),
                          Text('Record Payment',
                              style: TextStyle(color: AppColors.textWhite)),
                        ],
                      ),
                    ),
                    const PopupMenuItem<String>(
                      value: 'sms',
                      child: Row(
                        children: [
                          Icon(Icons.message_outlined,
                              size: 16, color: AppColors.textWhite70),
                          SizedBox(width: 12),
                          Text('Send SMS',
                              style: TextStyle(color: AppColors.textWhite)),
                        ],
                      ),
                    ),
                    const PopupMenuItem<String>(
                      value: 'edit',
                      child: Row(
                        children: [
                          Icon(Icons.edit_outlined,
                              size: 16, color: AppColors.textWhite70),
                          SizedBox(width: 12),
                          Text('Edit Student',
                              style: TextStyle(color: AppColors.textWhite)),
                        ],
                      ),
                    ),
                    const PopupMenuDivider(),
                    const PopupMenuItem<String>(
                      value: 'bills',
                      child: Row(
                        children: [
                          Icon(Icons.receipt_long,
                              size: 16, color: AppColors.textWhite70),
                          SizedBox(width: 12),
                          Text('View Bills',
                              style: TextStyle(color: AppColors.textWhite)),
                        ],
                      ),
                    ),
                  ],
                  onSelected: (value) {
                    switch (value) {
                      case 'view':
                        // Set selected student to show details
                        ref.read(selectedStudentProvider.notifier).state = s;
                        break;
                      case 'pay':
                        // Open payment dialog
                        final owed = SafeData.parseDouble(s['owed_total'], 0.0);
                        showDialog(
                          context: context,
                          barrierDismissible: false,
                          builder: (_) => QuickPaymentDialog(
                            schoolId: widget.schoolId,
                            studentId: s['id'] ?? '',
                            studentName: s['full_name'] ?? 'Student',
                            outstandingAmount: owed,
                          ),
                        );
                        break;
                      case 'sms':
                        // TODO: Open SMS dialog
                        ScaffoldMessenger.of(context).showSnackBar(
                          const SnackBar(
                              content: Text('SMS feature coming soon')),
                        );
                        break;
                      case 'edit':
                        // Open edit student dialog
                        showDialog(
                          context: context,
                          barrierDismissible: false,
                          builder: (_) => EditStudentDialog(
                            studentData: s,
                            schoolId: widget.schoolId,
                          ),
                        );
                        break;
                      case 'bills':
                        final studentId = s['student_id'] ?? s['id'] ?? '';
                        final studentName = s['full_name'] ?? 'Student';
                        showDialog(
                          context: context,
                          barrierDismissible: true,
                          builder: (_) => StudentBillsDialog(
                            studentId: studentId,
                            studentName: studentName,
                          ),
                        );
                        break;
                    }
                  },
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildFooter(int count) {
    return Padding(
      padding: const EdgeInsets.all(16.0),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.end,
        children: [
          Text("Showing $count results",
              style:
                  const TextStyle(color: AppColors.textWhite54, fontSize: 13)),
          const SizedBox(width: 24),
          _paginationBtn("Previous", false),
          const SizedBox(width: 8),
          _paginationBtn("Next", false), // Logic can be added later
        ],
      ),
    );
  }

  Widget _paginationBtn(String label, bool active) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
      decoration: BoxDecoration(
        color: active ? AppColors.primaryBlue : AppColors.backgroundBlack,
        borderRadius: BorderRadius.circular(4),
        border: Border.all(color: AppColors.divider),
      ),
      child: Text(label,
          style: TextStyle(
              color: active ? Colors.white : AppColors.textWhite70,
              fontSize: 12)),
    );
  }
}

// ==========================================
// FILE: ./students/students_header.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../../core/constants/app_colors.dart';
import '../../../../data/providers/dashboard_provider.dart';
import '../../../../data/providers/students_provider.dart';
import '../../../../data/services/database_service.dart';

class StudentsHeader extends ConsumerStatefulWidget {
  const StudentsHeader({super.key});

  @override
  ConsumerState<StudentsHeader> createState() => _StudentsHeaderState();
}

class _StudentsHeaderState extends ConsumerState<StudentsHeader> {
  late TextEditingController _searchController;

  @override
  void initState() {
    super.initState();
    _searchController = TextEditingController();
  }

  @override
  void dispose() {
    _searchController.dispose();
    super.dispose();
  }

  String _getInitials(String name) {
    if (name.isEmpty) return "U";
    final parts = name.trim().split(' ');
    if (parts.length > 1) {
      return "${parts[0][0]}${parts[1][0]}".toUpperCase();
    }
    return name[0].toUpperCase();
  }

  @override
  Widget build(BuildContext context) {
    final dashboardAsync = ref.watch(dashboardDataProvider);
    final bool isConnected = DatabaseService().db.currentStatus.connected;

    return Container(
      height: 70,
      padding: const EdgeInsets.symmetric(horizontal: 24),
      color: AppColors.backgroundBlack,
      child: Row(
        children: [
          const Icon(Icons.school, color: AppColors.primaryBlue, size: 28),
          const SizedBox(width: 12),
          const Text(
            "Students",
            style: TextStyle(
              color: AppColors.textWhite,
              fontSize: 20,
              fontWeight: FontWeight.bold,
              letterSpacing: 0.5,
            ),
          ),

          const Spacer(),

          // --- Search Bar (Fixed Style) ---
          SizedBox(
            width: 300,
            height: 40,
            child: TextField(
              textAlignVertical: TextAlignVertical.center,
              onChanged: (value) {
                ref.read(studentSearchProvider.notifier).state = value;
              },
              style: const TextStyle(color: AppColors.textWhite, fontSize: 13),
              decoration: InputDecoration(
                isDense: true,
                filled: true,
                fillColor: AppColors.surfaceGrey,
                hintText: "Search students, IDs, or parents...",
                hintStyle: const TextStyle(color: AppColors.textWhite38),
                prefixIcon: const Icon(Icons.search,
                    size: 18, color: AppColors.textWhite54),
                contentPadding: EdgeInsets.zero,
                enabledBorder: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(8),
                  borderSide: const BorderSide(color: AppColors.divider),
                ),
                focusedBorder: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(8),
                  borderSide: const BorderSide(color: AppColors.primaryBlue),
                ),
                border: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(8),
                  borderSide: const BorderSide(color: AppColors.divider),
                ),
              ),
            ),
          ),
          const SizedBox(width: 24),

          // --- Notification ---
          IconButton(
            onPressed: () {},
            icon: const Icon(Icons.notifications_none,
                color: AppColors.textWhite70),
          ),
          const SizedBox(width: 16),

          // --- Profile & Connectivity ---
          dashboardAsync.when(
            loading: () => _buildProfileLoading(),
            error: (err, _) => _buildProfileError(isConnected),
            data: (data) {
              final initials = _getInitials(data.userName);
              String subtitle = data.schoolName;
              if (data.schoolName == 'Loading...') {
                subtitle = isConnected ? "Syncing Data..." : "Offline Mode";
              }

              return Row(
                children: [
                  Column(
                    mainAxisAlignment: MainAxisAlignment.center,
                    crossAxisAlignment: CrossAxisAlignment.end,
                    children: [
                      Text(data.userName.isEmpty ? "User" : data.userName,
                          style: const TextStyle(
                              color: AppColors.textWhite,
                              fontWeight: FontWeight.bold,
                              fontSize: 13)),
                      Text(subtitle,
                          style: TextStyle(
                              color: (subtitle == "Offline Mode")
                                  ? AppColors.warningOrange
                                  : AppColors.textWhite38,
                              fontSize: 11)),
                    ],
                  ),
                  const SizedBox(width: 12),
                  CircleAvatar(
                    backgroundColor:
                        AppColors.primaryBlue.withValues(alpha: 0.2),
                    child: Text(initials,
                        style: const TextStyle(
                            color: AppColors.primaryBlue,
                            fontWeight: FontWeight.bold,
                            fontSize: 12)),
                  ),
                ],
              );
            },
          ),
        ],
      ),
    );
  }

  Widget _buildProfileLoading() {
    return const CircleAvatar(
        backgroundColor: AppColors.surfaceGrey, radius: 16);
  }

  Widget _buildProfileError(bool isConnected) {
    return Icon(isConnected ? Icons.error_outline : Icons.wifi_off,
        color: AppColors.errorRed);
  }
}

// ==========================================
// FILE: ./students/quick_payment_dialog.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:intl/intl.dart';
import 'package:uuid/uuid.dart';
import 'dart:async';

import '../../../../core/constants/app_colors.dart';
import '../../../../core/utils/safe_data.dart';
import '../../../../data/services/database_service.dart';

class QuickPaymentDialog extends ConsumerStatefulWidget {
  final String schoolId;
  final String studentId;
  final String studentName;
  final double outstandingAmount;

  const QuickPaymentDialog({
    super.key,
    required this.schoolId,
    required this.studentId,
    required this.studentName,
    required this.outstandingAmount,
  });

  @override
  ConsumerState<QuickPaymentDialog> createState() => _QuickPaymentDialogState();
}

class _QuickPaymentDialogState extends ConsumerState<QuickPaymentDialog> {
  final _formKey = GlobalKey<FormState>();
  final DatabaseService _dbService = DatabaseService();

  // Controllers
  final _amountController = TextEditingController();
  final _payerNameController = TextEditingController();

  // State
  DateTime _selectedDate = DateTime.now();
  String _selectedMethod = 'Cash';
  String _selectedCategory = 'Tuition';
  bool _isLoading = false;

  // üõ°Ô∏è Issue #1, #8: Stream subscription for payment history
  StreamSubscription? _paymentSubscription;
  List<Map<String, dynamic>> _payments = [];

  // Constants
  final List<String> _methods = [
    'Cash',
    'Bank Transfer',
    'Mobile Money',
    'Cheque'
  ];
  final List<String> _categories = [
    'Tuition',
    'Uniform',
    'Levy',
    'Transport',
    'Donation'
  ];

  @override
  void initState() {
    super.initState();
    _payerNameController.text = widget.studentName;
    // Pre-fill with outstanding amount
    if (widget.outstandingAmount > 0) {
      _amountController.text = widget.outstandingAmount.toStringAsFixed(2);
    }

    // üõ°Ô∏è Issue #1, #8: Subscribe to payment stream with broadcast
    _paymentSubscription = _dbService.db
        .watch(
          'SELECT * FROM payments WHERE student_id = ? ORDER BY date_paid DESC',
          parameters: [widget.studentId],
        )
        .asBroadcastStream() // Issue #1: Broadcast to allow multiple listeners
        .listen(
          (payments) {
            if (mounted) {
              setState(() => _payments = payments);
            }
          },
          onError: (e) => debugPrint('‚ö†Ô∏è Payment stream error: $e'),
        );
  }

  @override
  void dispose() {
    // üõ°Ô∏è Issue #8: Critical cleanup of stream subscription
    _paymentSubscription?.cancel();
    _amountController.dispose();
    _payerNameController.dispose();
    super.dispose();
  }

  // --- LOGIC ---

  Future<void> _recordPayment() async {
    if (!_formKey.currentState!.validate()) return;

    setState(() => _isLoading = true);

    try {
      final db = _dbService;

      // üõ°Ô∏è Issue #9: Safe amount parsing with bounds validation
      final amount = SafeData.parseDouble(_amountController.text, 0.0);

      // Validation: Amount must be > 0
      if (amount <= 0) {
        _showError('Please enter a valid amount greater than 0');
        return;
      }

      // Validation: Amount must be ‚â§ 50,000 (reasonable max)
      if (amount > 50000) {
        _showError(
            'Amount exceeds maximum allowed (‚Ç¶50,000). Please verify and try again.');
        return;
      }

      // üõ°Ô∏è Issue #10: Safe bill data access with field validation
      String billId = '';
      double billAmount = 0.0;
      
      try {
        final bills = await db.db.getAll(
          '''SELECT id, total_amount FROM bills 
             WHERE student_id = ? AND is_paid = 0
             ORDER BY created_at ASC LIMIT 1''',
          [widget.studentId],
        );

        if (bills.isNotEmpty) {
          billId = SafeData.safeGet<String>(bills[0], 'id', '');
          billAmount = SafeData.parseDouble(bills[0]['total_amount'], 0.0);
          
          if (billId.isEmpty) {
            debugPrint('‚ö†Ô∏è Warning: Bill ID is empty');
          }
        }
      } catch (e) {
        debugPrint('‚ö†Ô∏è Bill fetch error: $e');
        // Continue without bill link (Issue #6: prevent race conditions)
      }

      // üõ°Ô∏è Issue #6: Sanitize payer name to prevent data corruption
      final payerName = SafeData.sanitize(_payerNameController.text);

      // Create payment record
      final paymentData = {
        'id': const Uuid().v4(),
        'school_id': widget.schoolId,
        'student_id': widget.studentId,
        'bill_id': billId.isEmpty ? null : billId,
        'amount': amount,
        'date_paid': DateFormat('yyyy-MM-dd').format(_selectedDate),
        'category': _selectedCategory,
        'payer_name': payerName,
        'method': _selectedMethod,
        'created_at': DateTime.now().toIso8601String(),
      };

      // üõ°Ô∏è Issue #6 & #10: Atomic transaction - payment + bill update
      // First: Insert payment
      await db.insert('payments', paymentData);
      debugPrint('‚úÖ Payment inserted: ‚Ç¶${amount.toStringAsFixed(2)}');

      // Then: Mark bill as paid if payment covers full amount
      if (billId.isNotEmpty && amount >= billAmount) {
        try {
          await db.update('bills', billId,
              {'is_paid': 1, 'updated_at': DateTime.now().toIso8601String()});
          debugPrint('‚úÖ Bill marked as paid: $billId');
        } catch (e) {
          // Bill update failed - payment still recorded
          debugPrint('‚ö†Ô∏è Bill update failed (payment was recorded): $e');
          if (mounted) {
            _showWarning('Payment recorded, but bill marking failed. '
                'Please check the bill status manually.');
          }
        }
      }

      if (mounted) {
        _showSuccess('Payment recorded successfully!');
        Navigator.of(context).pop();
      }
    } catch (e) {
      debugPrint('‚ùå Payment record error: $e');
      if (mounted) {
        _showError('Error recording payment: $e');
      }
    } finally {
      if (mounted) setState(() => _isLoading = false);
    }
  }

  /// Helper: Show error snackbar (Issue #6: consistent error handling)
  void _showError(String message) {
    setState(() => _isLoading = false);
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(message),
        backgroundColor: AppColors.errorRed,
        duration: const Duration(seconds: 3),
      ),
    );
  }

  /// Helper: Show warning snackbar
  void _showWarning(String message) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(message),
        backgroundColor: Colors.orange,
        duration: const Duration(seconds: 4),
      ),
    );
  }

  /// Helper: Show success snackbar
  void _showSuccess(String message) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(message),
        backgroundColor: AppColors.successGreen,
        duration: const Duration(seconds: 2),
      ),
    );
  }

  // --- UI BUILD ---

  @override
  Widget build(BuildContext context) {
    return Dialog(
      backgroundColor: Colors.transparent,
      insetPadding: const EdgeInsets.all(24),
      child: Container(
        width: 1100,
        height: 700,
        decoration: BoxDecoration(
          color: AppColors.backgroundBlack,
          borderRadius: BorderRadius.circular(16),
          border: Border.all(color: AppColors.surfaceLightGrey),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withValues(alpha: 0.5),
              blurRadius: 20,
              offset: const Offset(0, 10),
            )
          ],
        ),
        child: Column(
          children: [
            // --- HEADER ---
            Padding(
              padding: const EdgeInsets.symmetric(horizontal: 32, vertical: 24),
              child: Row(
                children: [
                  Container(
                    padding: const EdgeInsets.all(8),
                    decoration: BoxDecoration(
                      color: AppColors.primaryBlue.withValues(alpha: 0.2),
                      borderRadius: BorderRadius.circular(8),
                    ),
                    child: const Icon(Icons.account_balance_wallet,
                        color: AppColors.primaryBlue),
                  ),
                  const SizedBox(width: 16),
                  Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      const Text("Record Payment",
                          style: TextStyle(
                              color: AppColors.textWhite,
                              fontSize: 18,
                              fontWeight: FontWeight.bold)),
                      Text("For ${widget.studentName}",
                          style: const TextStyle(
                              color: AppColors.textGrey, fontSize: 13)),
                    ],
                  ),
                  const Spacer(),
                  IconButton(
                    onPressed: () => Navigator.pop(context),
                    icon: const Icon(Icons.close, color: AppColors.textGrey),
                  ),
                ],
              ),
            ),
            const Divider(height: 1, color: AppColors.divider),

            // --- BODY (Split View) ---
            Expanded(
              child: Row(
                children: [
                  // --- LEFT: FORM SECTION (Flex 4) ---
                  Expanded(
                    flex: 4,
                    child: Padding(
                      padding: const EdgeInsets.all(32),
                      child: Form(
                        key: _formKey,
                        child: SingleChildScrollView(
                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              const Text("PAYMENT DETAILS",
                                  style: TextStyle(
                                      color: AppColors.textGrey,
                                      fontSize: 12,
                                      fontWeight: FontWeight.bold,
                                      letterSpacing: 1.2)),
                              const SizedBox(height: 24),

                              // Outstanding Alert
                              if (widget.outstandingAmount > 0)
                                Container(
                                  padding: const EdgeInsets.all(12),
                                  margin: const EdgeInsets.only(bottom: 16),
                                  decoration: BoxDecoration(
                                    color: AppColors.errorRed
                                        .withValues(alpha: 0.1),
                                    borderRadius: BorderRadius.circular(8),
                                    border: Border.all(
                                        color: AppColors.errorRed
                                            .withValues(alpha: 0.3)),
                                  ),
                                  child: Row(
                                    children: [
                                      const Icon(Icons.warning_outlined,
                                          color: AppColors.errorRed, size: 18),
                                      const SizedBox(width: 12),
                                      Expanded(
                                        child: Text(
                                          'Outstanding: ZWL ${widget.outstandingAmount.toStringAsFixed(2)}',
                                          style: const TextStyle(
                                            color: AppColors.textWhite,
                                            fontSize: 13,
                                            fontWeight: FontWeight.w500,
                                          ),
                                        ),
                                      ),
                                    ],
                                  ),
                                ),

                              // Student Name (Read-only)
                              _buildLabel("Student", AppColors.textWhite),
                              Container(
                                padding: const EdgeInsets.symmetric(
                                    horizontal: 16, vertical: 14),
                                decoration: BoxDecoration(
                                  color: AppColors.surfaceGrey,
                                  borderRadius: BorderRadius.circular(8),
                                  border: Border.all(
                                      color: AppColors.surfaceLightGrey),
                                ),
                                child: Row(
                                  children: [
                                    const Icon(Icons.person,
                                        color: AppColors.textWhite54),
                                    const SizedBox(width: 12),
                                    Text(
                                      widget.studentName,
                                      style: const TextStyle(
                                          color: AppColors.textWhite,
                                          fontSize: 14),
                                    ),
                                  ],
                                ),
                              ),
                              const SizedBox(height: 16),

                              // Amount & Date Row
                              Row(
                                children: [
                                  Expanded(
                                    child: Column(
                                      crossAxisAlignment:
                                          CrossAxisAlignment.start,
                                      children: [
                                        _buildLabel(
                                            "Amount", AppColors.textWhite),
                                        _buildTextInput(
                                          controller: _amountController,
                                          hint: "0.00",
                                          isNumber: true,
                                          prefix: "\$ ",
                                        ),
                                      ],
                                    ),
                                  ),
                                  const SizedBox(width: 16),
                                  Expanded(
                                    child: Column(
                                      crossAxisAlignment:
                                          CrossAxisAlignment.start,
                                      children: [
                                        _buildLabel("Payment Date",
                                            AppColors.textWhite),
                                        _buildDatePicker(
                                            context,
                                            _selectedDate,
                                            (d) => setState(
                                                () => _selectedDate = d)),
                                      ],
                                    ),
                                  ),
                                ],
                              ),
                              const SizedBox(height: 16),

                              // Category & Method Row
                              Row(
                                children: [
                                  Expanded(
                                    child: Column(
                                      crossAxisAlignment:
                                          CrossAxisAlignment.start,
                                      children: [
                                        _buildLabel(
                                            "Category", AppColors.textWhite),
                                        _buildDropdown(
                                          value: _selectedCategory,
                                          items: _categories,
                                          onChanged: (v) => setState(
                                              () => _selectedCategory = v!),
                                        ),
                                      ],
                                    ),
                                  ),
                                  const SizedBox(width: 16),
                                  Expanded(
                                    child: Column(
                                      crossAxisAlignment:
                                          CrossAxisAlignment.start,
                                      children: [
                                        _buildLabel("Payment Method",
                                            AppColors.textWhite),
                                        _buildDropdown(
                                          value: _selectedMethod,
                                          items: _methods,
                                          onChanged: (v) => setState(
                                              () => _selectedMethod = v!),
                                        ),
                                      ],
                                    ),
                                  ),
                                ],
                              ),
                              const SizedBox(height: 16),

                              // Payer Name
                              _buildLabel("Payer Name (Parent/Guardian)",
                                  AppColors.textWhite),
                              _buildTextInput(
                                controller: _payerNameController,
                                hint: "e.g. Mr. Smith",
                                prefixIcon: Icons.person_outline,
                              ),

                              const SizedBox(height: 40),
                            ],
                          ),
                        ),
                      ),
                    ),
                  ),

                  const VerticalDivider(width: 1, color: AppColors.divider),

                  // --- RIGHT: STUDENT'S PAYMENT HISTORY ---
                  Expanded(
                    flex: 3,
                    child: Container(
                      color: AppColors.surfaceDarkGrey,
                      padding: const EdgeInsets.all(24),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Row(
                            mainAxisAlignment: MainAxisAlignment.spaceBetween,
                            children: [
                              const Text("PAYMENT HISTORY",
                                  style: TextStyle(
                                      color: AppColors.textGrey,
                                      fontSize: 12,
                                      fontWeight: FontWeight.bold,
                                      letterSpacing: 1.2)),
                              // üõ°Ô∏è Issue #1 & #8: State-based rendering instead of StreamBuilder
                              Builder(builder: (context) {
                                if (_payments.isEmpty) {
                                  return const Text("\$0.00",
                                      style: TextStyle(
                                          color: AppColors.textWhite,
                                          fontWeight: FontWeight.bold));
                                }
                                double total = 0;
                                for (var p in _payments) {
                                  total +=
                                      SafeData.parseDouble(p['amount'], 0.0);
                                }
                                return Text(
                                    "Total: \$${total.toStringAsFixed(2)}",
                                    style: const TextStyle(
                                        color: AppColors.textWhite,
                                        fontWeight: FontWeight.bold));
                              }),
                            ],
                          ),
                          const SizedBox(height: 24),

                          // List of Student Payments
                          Expanded(
                            // üõ°Ô∏è Issue #1 & #8: State-based list instead of StreamBuilder
                            child: Builder(builder: (context) {
                              final payments = _payments;

                              if (payments.isEmpty) {
                                return Center(
                                  child: Column(
                                    mainAxisAlignment: MainAxisAlignment.center,
                                    children: [
                                      Icon(Icons.receipt_long,
                                          size: 48,
                                          color: AppColors.textGrey
                                              .withValues(alpha: 0.2)),
                                      const SizedBox(height: 12),
                                      const Text("No payments yet",
                                          style: TextStyle(
                                              color: AppColors.textGrey)),
                                    ],
                                  ),
                                );
                              }

                              return ListView.separated(
                                itemCount: payments.length,
                                separatorBuilder: (_, __) =>
                                    const SizedBox(height: 12),
                                itemBuilder: (context, index) {
                                  final p = payments[index];
                                  final amount =
                                      SafeData.parseDouble(p['amount'], 0.0);
                                  final date = SafeData.safeGet<String>(
                                      p, 'date_paid', '');
                                  final method = SafeData.safeGet<String>(
                                      p, 'method', 'Cash');
                                  final category = SafeData.safeGet<String>(
                                      p, 'category', 'Tuition');
                                  final methodColor = _getMethodColor(method);
                                  final methodIcon = _getMethodIcon(method);

                                  return Container(
                                    padding: const EdgeInsets.all(16),
                                    decoration: BoxDecoration(
                                      color: AppColors.surfaceGrey,
                                      borderRadius: BorderRadius.circular(12),
                                      border: Border.all(
                                          color: Colors.white
                                              .withValues(alpha: 0.05)),
                                    ),
                                    child: Row(
                                      children: [
                                        Container(
                                          padding: const EdgeInsets.all(10),
                                          decoration: BoxDecoration(
                                            color: methodColor.withValues(
                                                alpha: 0.2),
                                            borderRadius:
                                                BorderRadius.circular(8),
                                          ),
                                          child: Icon(methodIcon,
                                              color: methodColor, size: 20),
                                        ),
                                        const SizedBox(width: 16),
                                        Expanded(
                                          child: Column(
                                            crossAxisAlignment:
                                                CrossAxisAlignment.start,
                                            children: [
                                              Text(
                                                "\$${amount.toStringAsFixed(2)}",
                                                style: const TextStyle(
                                                    color: AppColors.textWhite,
                                                    fontSize: 16,
                                                    fontWeight:
                                                        FontWeight.bold),
                                              ),
                                              const SizedBox(height: 4),
                                              Text(
                                                "$category ‚Ä¢ $method",
                                                style: const TextStyle(
                                                    color:
                                                        AppColors.textWhite70,
                                                    fontSize: 12),
                                              ),
                                              Text(
                                                date,
                                                style: const TextStyle(
                                                    color: AppColors.textGrey,
                                                    fontSize: 11),
                                              ),
                                            ],
                                          ),
                                        ),
                                      ],
                                    ),
                                  );
                                },
                              );
                            }),
                          ),
                        ],
                      ),
                    ),
                  ),
                ],
              ),
            ),

            // --- FOOTER ---
            Padding(
              padding: const EdgeInsets.symmetric(horizontal: 32, vertical: 20),
              child: Row(
                mainAxisAlignment: MainAxisAlignment.end,
                children: [
                  TextButton(
                    onPressed: () => Navigator.of(context).pop(),
                    child: const Text("Cancel",
                        style: TextStyle(color: AppColors.textWhite70)),
                  ),
                  const SizedBox(width: 16),
                  ElevatedButton.icon(
                    onPressed: _isLoading ? null : _recordPayment,
                    style: ElevatedButton.styleFrom(
                      backgroundColor: AppColors.primaryBlue,
                      padding: const EdgeInsets.symmetric(
                          horizontal: 24, vertical: 16),
                      shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(8)),
                      foregroundColor: AppColors.textWhite,
                    ),
                    icon: _isLoading
                        ? const SizedBox(
                            width: 16,
                            height: 16,
                            child: CircularProgressIndicator(
                                strokeWidth: 2, color: AppColors.textWhite))
                        : const Icon(Icons.check, size: 18),
                    label: Text(_isLoading ? "Saving..." : "Record Payment",
                        style: const TextStyle(fontWeight: FontWeight.bold)),
                  ),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }

  // --- WIDGET HELPERS ---

  Widget _buildLabel(String text, Color color) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 8.0),
      child: Text(text,
          style: TextStyle(
              color: color.withValues(alpha: 0.9),
              fontSize: 14,
              fontWeight: FontWeight.w500)),
    );
  }

  Widget _buildTextInput({
    required TextEditingController controller,
    required String hint,
    String? prefix,
    IconData? prefixIcon,
    bool isNumber = false,
  }) {
    return TextFormField(
      controller: controller,
      keyboardType: isNumber
          ? const TextInputType.numberWithOptions(decimal: true)
          : TextInputType.text,
      validator: (val) {
        if (val == null || val.isEmpty) return 'Required';
        if (isNumber) {
          final amount = double.tryParse(val);
          if (amount == null) return 'Invalid number';
          if (amount <= 0) return 'Must be greater than 0';
        }
        return null;
      },
      style: const TextStyle(color: AppColors.textWhite),
      decoration: InputDecoration(
        filled: true,
        fillColor: AppColors.surfaceGrey,
        hintText: hint,
        hintStyle: TextStyle(color: AppColors.textWhite.withValues(alpha: 0.3)),
        prefixText: prefix,
        prefixStyle: const TextStyle(
          color: AppColors.textWhite,
          fontWeight: FontWeight.bold,
        ),
        prefixIcon: prefixIcon != null
            ? Icon(prefixIcon, color: AppColors.textWhite54)
            : null,
        border: OutlineInputBorder(
            borderRadius: BorderRadius.circular(8),
            borderSide: const BorderSide(color: AppColors.surfaceLightGrey)),
        enabledBorder: OutlineInputBorder(
            borderRadius: BorderRadius.circular(8),
            borderSide: const BorderSide(color: AppColors.surfaceLightGrey)),
        focusedBorder: OutlineInputBorder(
            borderRadius: BorderRadius.circular(8),
            borderSide:
                const BorderSide(color: AppColors.primaryBlue, width: 2)),
        contentPadding:
            const EdgeInsets.symmetric(horizontal: 16, vertical: 14),
      ),
    );
  }

  Widget _buildDropdown({
    required String value,
    required List<String> items,
    required Function(String?) onChanged,
  }) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 16),
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(8),
        border: Border.all(color: AppColors.surfaceLightGrey),
      ),
      child: DropdownButtonHideUnderline(
        child: DropdownButton<String>(
          value: value,
          isExpanded: true,
          style: const TextStyle(color: AppColors.textWhite),
          dropdownColor: AppColors.surfaceGrey,
          onChanged: onChanged,
          items: items
              .map((g) => DropdownMenuItem(value: g, child: Text(g)))
              .toList(),
        ),
      ),
    );
  }

  Widget _buildDatePicker(
      BuildContext context, DateTime selected, Function(DateTime) onChanged) {
    return InkWell(
      onTap: () async {
        final picked = await showDatePicker(
          context: context,
          initialDate: selected,
          firstDate: DateTime(2020),
          lastDate: DateTime.now().add(const Duration(days: 30)),
          builder: (context, child) => Theme(
            data: Theme.of(context).copyWith(
              dialogTheme: Theme.of(context).dialogTheme.copyWith(
                    backgroundColor: AppColors.backgroundBlack,
                  ),
            ),
            child: child!,
          ),
        );
        if (picked != null) onChanged(picked);
      },
      child: Container(
        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 14),
        decoration: BoxDecoration(
          color: AppColors.surfaceGrey,
          borderRadius: BorderRadius.circular(8),
          border: Border.all(color: AppColors.surfaceLightGrey),
        ),
        child: Row(
          children: [
            const Icon(Icons.calendar_today,
                size: 16, color: AppColors.textWhite54),
            const SizedBox(width: 12),
            Text(
              DateFormat('MMM dd, yyyy').format(selected),
              style: const TextStyle(color: AppColors.textWhite),
            ),
          ],
        ),
      ),
    );
  }

  // --- HELPER METHODS FOR VISUAL CONSISTENCY ---

  Color _getMethodColor(String method) {
    switch (method) {
      case 'Cash':
        return AppColors.successGreen;
      case 'Bank Transfer':
        return AppColors.primaryBlue;
      case 'Mobile Money':
        return AppColors.warningOrange;
      case 'Cheque':
        return AppColors.textWhite70;
      default:
        return AppColors.textGrey;
    }
  }

  IconData _getMethodIcon(String method) {
    switch (method) {
      case 'Cash':
        return Icons.money;
      case 'Bank Transfer':
        return Icons.account_balance;
      case 'Mobile Money':
        return Icons.phone_android;
      case 'Cheque':
        return Icons.receipt;
      default:
        return Icons.payment;
    }
  }
}

// ==========================================
// FILE: ./students/student_bills_dialog.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:intl/intl.dart';
import '../../../../core/constants/app_colors.dart';
import '../../../../data/providers/invoices_provider.dart';
import '../../../../core/utils/safe_data.dart';

class StudentBillsDialog extends ConsumerWidget {
  final String studentId;
  final String studentName;
  const StudentBillsDialog(
      {super.key, required this.studentId, required this.studentName});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final billsAsync = ref.watch(studentInvoicesProvider(studentId));

    return Dialog(
      backgroundColor: AppColors.backgroundBlack,
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
      child: Container(
        width: 520,
        padding: const EdgeInsets.all(20),
        decoration: BoxDecoration(
          color: AppColors.surfaceGrey,
          borderRadius: BorderRadius.circular(12),
          border: Border.all(color: AppColors.divider),
        ),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      'Bills for $studentName',
                      style: const TextStyle(
                        color: AppColors.textWhite,
                        fontSize: 16,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                    const SizedBox(height: 4),
                    Text(
                      studentId,
                      style: const TextStyle(
                          color: AppColors.textWhite54, fontSize: 12),
                    ),
                  ],
                ),
                IconButton(
                  onPressed: () => Navigator.of(context).pop(),
                  icon: const Icon(Icons.close, color: AppColors.textWhite54),
                ),
              ],
            ),
            const SizedBox(height: 16),
            Container(height: 1, color: AppColors.divider),
            const SizedBox(height: 16),
            billsAsync.when(
              loading: () => const Center(
                child: Padding(
                  padding: EdgeInsets.all(24),
                  child:
                      CircularProgressIndicator(color: AppColors.primaryBlue),
                ),
              ),
              error: (err, _) => Padding(
                padding: const EdgeInsets.all(16.0),
                child: Text('Failed to load bills: $err',
                    style: const TextStyle(color: AppColors.errorRed)),
              ),
              data: (bills) {
                if (bills.isEmpty) {
                  return const Padding(
                    padding: EdgeInsets.all(16.0),
                    child: Text('No bills found for this student.',
                        style: TextStyle(color: AppColors.textWhite54)),
                  );
                }

                return ConstrainedBox(
                  constraints: const BoxConstraints(maxHeight: 360),
                  child: ListView.separated(
                    shrinkWrap: true,
                    itemCount: bills.length,
                    separatorBuilder: (_, __) =>
                        const Divider(color: AppColors.divider),
                    itemBuilder: (context, index) {
                      final bill = bills[index];
                      final title = (bill['title'] ?? 'Bill').toString();
                      final total =
                          SafeData.parseDouble(bill['total_amount'], 0.0);
                      final paid =
                          SafeData.parseDouble(bill['paid_amount'], 0.0);
                      final status = (bill['status'] ?? '').toString();
                      final created = (bill['created_at'] ?? '').toString();
                      final dateLabel = created.isEmpty
                          ? ''
                          : DateFormat('MMM d, yyyy').format(
                              DateTime.tryParse(created) ?? DateTime.now());

                      final isPaid = (bill['is_paid'] as int?) == 1 ||
                          status.toLowerCase() == 'paid';
                      final balance = (total - paid).clamp(0, double.infinity);

                      return ListTile(
                        dense: true,
                        contentPadding: EdgeInsets.zero,
                        title: Text(title,
                            style: const TextStyle(
                                color: AppColors.textWhite,
                                fontSize: 14,
                                fontWeight: FontWeight.w600)),
                        subtitle: Text(dateLabel,
                            style: const TextStyle(
                                color: AppColors.textWhite54, fontSize: 12)),
                        trailing: Column(
                          crossAxisAlignment: CrossAxisAlignment.end,
                          mainAxisAlignment: MainAxisAlignment.center,
                          children: [
                            Text(NumberFormat.simpleCurrency().format(total),
                                style: const TextStyle(
                                    color: AppColors.textWhite,
                                    fontSize: 13,
                                    fontWeight: FontWeight.bold)),
                            const SizedBox(height: 4),
                            Row(
                              mainAxisSize: MainAxisSize.min,
                              children: [
                                Container(
                                  padding: const EdgeInsets.symmetric(
                                      horizontal: 8, vertical: 4),
                                  decoration: BoxDecoration(
                                    color: isPaid
                                        ? AppColors.successGreen
                                            .withValues(alpha: 0.2)
                                        : AppColors.warningOrange
                                            .withValues(alpha: 0.2),
                                    borderRadius: BorderRadius.circular(6),
                                  ),
                                  child: Text(
                                    isPaid ? 'Paid' : 'Unpaid',
                                    style: TextStyle(
                                      color: isPaid
                                          ? AppColors.successGreen
                                          : AppColors.warningOrange,
                                      fontSize: 11,
                                      fontWeight: FontWeight.bold,
                                    ),
                                  ),
                                ),
                                const SizedBox(width: 8),
                                Text(
                                  balance > 0
                                      ? '- ${NumberFormat.simpleCurrency().format(balance)}'
                                      : 'Settled',
                                  style: TextStyle(
                                    color: balance > 0
                                        ? AppColors.textWhite70
                                        : AppColors.successGreen,
                                    fontSize: 11,
                                  ),
                                ),
                              ],
                            ),
                          ],
                        ),
                      );
                    },
                  ),
                );
              },
            ),
          ],
        ),
      ),
    );
  }
}

// ==========================================
// FILE: ./students/student_viewer_sidebar.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:intl/intl.dart';
import '../../../../core/constants/app_colors.dart';
import '../../../../data/providers/students_provider.dart';

class StudentViewerSidebar extends ConsumerWidget {
  const StudentViewerSidebar({super.key});

  String _getInitials(String name) {
    if (name.isEmpty) return "U";
    final parts = name.trim().split(' ');
    if (parts.length > 1) {
      return "${parts[0][0]}${parts[1][0]}".toUpperCase();
    }
    return name[0].toUpperCase();
  }

  String _getStatusLabel(Map<String, dynamic> student) {
    final isActive = (student['is_active'] as int?) == 1;
    final isSuspended = (student['is_suspended'] as int?) == 1;

    if (isSuspended) {
      return "Banned Forever";
    } else if (!isActive) {
      return "Inactive";
    }
    return "Active";
  }

  Color _getStatusColor(Map<String, dynamic> student) {
    final isActive = (student['is_active'] as int?) == 1;
    final isSuspended = (student['is_suspended'] as int?) == 1;

    if (isSuspended) {
      return AppColors.errorRed;
    } else if (!isActive) {
      return AppColors.textGrey;
    }
    return AppColors.successGreen;
  }

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final selectedStudent = ref.watch(selectedStudentProvider);

    // If no student is selected, show empty state
    if (selectedStudent == null) {
      return Container(
        width: 350,
        color: AppColors.backgroundBlack,
        decoration: const BoxDecoration(
          border: Border(left: BorderSide(color: AppColors.divider)),
        ),
        child: Column(
          children: [
            // Header
            Container(
              padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 16),
              decoration: const BoxDecoration(
                border: Border(bottom: BorderSide(color: AppColors.divider)),
              ),
              child: Row(
                children: [
                  const Icon(Icons.person_outline,
                      color: AppColors.primaryBlue, size: 20),
                  const SizedBox(width: 8),
                  const Text(
                    "Student Details",
                    style: TextStyle(
                      color: AppColors.textWhite,
                      fontSize: 16,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                  const Spacer(),
                  IconButton(
                    icon: const Icon(Icons.close,
                        color: AppColors.textWhite54, size: 20),
                    onPressed: () {
                      ref.read(selectedStudentProvider.notifier).state = null;
                    },
                  ),
                ],
              ),
            ),
            // Empty State
            const Expanded(
              child: Center(
                child: Column(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    Icon(Icons.person_search,
                        size: 64, color: AppColors.textWhite38),
                    SizedBox(height: 16),
                    Text(
                      "Select a student to view details",
                      style: TextStyle(
                        color: AppColors.textWhite54,
                        fontSize: 14,
                      ),
                    ),
                  ],
                ),
              ),
            ),
          ],
        ),
      );
    }

    // Student is selected, show details
    final name = selectedStudent['full_name'] ?? 'Unknown';
    final id = selectedStudent['student_id'] ?? '---';
    final grade = selectedStudent['grade'] ?? 'N/A';
    final parentName =
        selectedStudent['emergency_contact_name'] ?? 'No Contact';
    final parentContact = selectedStudent['parent_contact'] ?? 'No contact';
    final address = selectedStudent['address'] ?? 'Not provided';
    final dob = selectedStudent['date_of_birth'] ?? 'Not provided';
    final gender = selectedStudent['gender'] ?? 'Not specified';
    final enrollmentDate = selectedStudent['enrollment_date'] ?? 'Not provided';
    final medicalNotes = selectedStudent['medical_notes'] ?? 'None';
    final subjects = selectedStudent['subjects'] ?? 'Not assigned';
    final owed = (selectedStudent['owed_total'] as num?)?.toDouble() ?? 0.0;
    final paid = (selectedStudent['paid_total'] as num?)?.toDouble() ?? 0.0;
    final initials = _getInitials(name);
    final statusLabel = _getStatusLabel(selectedStudent);
    final statusColor = _getStatusColor(selectedStudent);

    return Container(
      width: 350,
      color: AppColors.backgroundBlack,
      decoration: const BoxDecoration(
        border: Border(left: BorderSide(color: AppColors.divider)),
      ),
      child: Column(
        children: [
          // Header with close button
          Container(
            padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 16),
            decoration: const BoxDecoration(
              border: Border(bottom: BorderSide(color: AppColors.divider)),
            ),
            child: Row(
              children: [
                const Icon(Icons.person_outline,
                    color: AppColors.primaryBlue, size: 20),
                const SizedBox(width: 8),
                const Text(
                  "Student Details",
                  style: TextStyle(
                    color: AppColors.textWhite,
                    fontSize: 16,
                    fontWeight: FontWeight.bold,
                  ),
                ),
                const Spacer(),
                IconButton(
                  icon: const Icon(Icons.close,
                      color: AppColors.textWhite54, size: 20),
                  onPressed: () {
                    ref.read(selectedStudentProvider.notifier).state = null;
                  },
                ),
              ],
            ),
          ),
          // Scrollable content
          Expanded(
            child: SingleChildScrollView(
              padding: const EdgeInsets.all(20),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  // Profile Card
                  Container(
                    padding: const EdgeInsets.all(16),
                    decoration: BoxDecoration(
                      color: AppColors.surfaceGrey,
                      borderRadius: BorderRadius.circular(12),
                      border: Border.all(color: AppColors.divider),
                    ),
                    child: Column(
                      children: [
                        CircleAvatar(
                          radius: 40,
                          backgroundColor:
                              AppColors.primaryBlue.withValues(alpha: 0.2),
                          child: Text(
                            initials,
                            style: const TextStyle(
                              color: AppColors.primaryBlue,
                              fontWeight: FontWeight.bold,
                              fontSize: 24,
                            ),
                          ),
                        ),
                        const SizedBox(height: 12),
                        Text(
                          name,
                          textAlign: TextAlign.center,
                          style: const TextStyle(
                            color: AppColors.textWhite,
                            fontSize: 16,
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                        const SizedBox(height: 4),
                        Text(
                          "ID: $id",
                          style: const TextStyle(
                            color: AppColors.textWhite54,
                            fontSize: 12,
                          ),
                        ),
                        const SizedBox(height: 8),
                        Container(
                          padding: const EdgeInsets.symmetric(
                              horizontal: 12, vertical: 6),
                          decoration: BoxDecoration(
                            color: statusColor.withValues(alpha: 0.15),
                            borderRadius: BorderRadius.circular(4),
                          ),
                          child: Text(
                            statusLabel,
                            style: TextStyle(
                              color: statusColor,
                              fontSize: 11,
                              fontWeight: FontWeight.bold,
                            ),
                          ),
                        ),
                      ],
                    ),
                  ),
                  const SizedBox(height: 20),

                  // Academic Section
                  _buildSectionTitle("Academic"),
                  _buildDetailRow("Grade/Form", grade),
                  _buildDetailRow("Subjects", subjects),
                  const SizedBox(height: 16),

                  // Personal Information
                  _buildSectionTitle("Personal Information"),
                  _buildDetailRow("Date of Birth", dob),
                  _buildDetailRow("Gender", gender),
                  _buildDetailRow("Address", address),
                  const SizedBox(height: 16),

                  // Enrollment
                  _buildSectionTitle("Enrollment"),
                  _buildDetailRow("Enrollment Date", enrollmentDate),
                  const SizedBox(height: 16),

                  // Parent/Guardian
                  _buildSectionTitle("Parent/Guardian"),
                  _buildDetailRow("Name", parentName),
                  _buildDetailRow("Contact", parentContact),
                  const SizedBox(height: 16),

                  // Financial Summary
                  _buildSectionTitle("Financial Summary"),
                  Container(
                    padding: const EdgeInsets.all(12),
                    decoration: BoxDecoration(
                      color: AppColors.surfaceGrey,
                      borderRadius: BorderRadius.circular(8),
                    ),
                    child: Row(
                      mainAxisAlignment: MainAxisAlignment.spaceAround,
                      children: [
                        Column(
                          children: [
                            const Text(
                              "Paid",
                              style: TextStyle(
                                color: AppColors.textWhite54,
                                fontSize: 11,
                              ),
                            ),
                            const SizedBox(height: 4),
                            Text(
                              NumberFormat.simpleCurrency().format(paid),
                              style: const TextStyle(
                                color: AppColors.successGreen,
                                fontSize: 12,
                                fontWeight: FontWeight.bold,
                              ),
                            ),
                          ],
                        ),
                        Container(
                          width: 1,
                          height: 30,
                          color: AppColors.divider,
                        ),
                        Column(
                          children: [
                            const Text(
                              "Owed",
                              style: TextStyle(
                                color: AppColors.textWhite54,
                                fontSize: 11,
                              ),
                            ),
                            const SizedBox(height: 4),
                            Text(
                              NumberFormat.simpleCurrency().format(owed),
                              style: TextStyle(
                                color: owed > 0
                                    ? AppColors.errorRed
                                    : AppColors.successGreen,
                                fontSize: 12,
                                fontWeight: FontWeight.bold,
                              ),
                            ),
                          ],
                        ),
                      ],
                    ),
                  ),
                  const SizedBox(height: 16),

                  // Medical Notes
                  _buildSectionTitle("Medical Notes"),
                  Container(
                    padding: const EdgeInsets.all(12),
                    decoration: BoxDecoration(
                      color: AppColors.surfaceGrey,
                      borderRadius: BorderRadius.circular(8),
                      border: Border.all(color: AppColors.divider),
                    ),
                    child: Text(
                      medicalNotes,
                      style: const TextStyle(
                        color: AppColors.textWhite70,
                        fontSize: 12,
                        height: 1.5,
                      ),
                    ),
                  ),
                  const SizedBox(height: 20),
                ],
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildSectionTitle(String title) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 12),
      child: Text(
        title,
        style: const TextStyle(
          color: AppColors.textWhite,
          fontSize: 13,
          fontWeight: FontWeight.bold,
          letterSpacing: 0.5,
        ),
      ),
    );
  }

  Widget _buildDetailRow(String label, String value) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 8),
      child: Row(
        children: [
          Text(
            label,
            style: const TextStyle(
              color: AppColors.textWhite54,
              fontSize: 12,
            ),
          ),
          const Spacer(),
          Text(
            value,
            textAlign: TextAlign.right,
            style: const TextStyle(
              color: AppColors.textWhite,
              fontSize: 12,
              fontWeight: FontWeight.w500,
            ),
          ),
        ],
      ),
    );
  }
}

// ==========================================
// FILE: ./students/students_stats.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../../core/constants/app_colors.dart';
import '../../../../data/providers/students_provider.dart';

class StudentsStats extends ConsumerWidget {
  final String schoolId;
  const StudentsStats({super.key, required this.schoolId});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    // Uses provider for real-time stats
    final studentsAsync = ref.watch(studentsProvider(schoolId));

    return studentsAsync.when(
      loading: () => const SizedBox(
        height: 140,
        child: Center(
            child: CircularProgressIndicator(color: AppColors.primaryBlue)),
      ),
      error: (error, stack) => SizedBox(
        height: 140,
        child: Center(
            child: Text("Error: $error",
                style: const TextStyle(color: AppColors.errorRed))),
      ),
      data: (students) {
        // 1. Calculate Stats
        final total = students.length;
        final active =
            students.where((s) => (s['is_active'] as int?) == 1).length;

        // Example logic: "New Enrollments" = students created this month
        final now = DateTime.now();
        final newEnrollments = students.where((s) {
          if (s['created_at'] == null) return false;
          final created =
              DateTime.tryParse(s['created_at'].toString()) ?? DateTime(2000);
          return created.month == now.month && created.year == now.year;
        }).length;

        // Example logic: "Unpaid" = owed_total > 0
        final unpaidCount = students.where((s) {
          final owed = (s['owed_total'] as num?)?.toDouble() ?? 0.0;
          return owed > 0;
        }).length;

        return SizedBox(
          height: 140,
          child: Row(
            children: [
              // 1. Total Students
              Expanded(
                child: _StatCard(
                  title: "Total Students",
                  value: total.toString(),
                  subtext: "$active Active Users",
                  icon: Icons.people,
                  iconColor: AppColors.primaryBlue,
                  showProgress: true,
                  progressVal: total > 0 ? (active / total) : 0,
                ),
              ),
              const SizedBox(width: 16),

              // 2. New Enrollments
              Expanded(
                child: _StatCard(
                  title: "New Enrollments",
                  value: newEnrollments.toString(),
                  subtext: "+$newEnrollments this month",
                  subtextColor: AppColors.successGreen,
                  icon: Icons.person_add,
                  iconColor: AppColors.successGreen,
                ),
              ),
              const SizedBox(width: 16),

              // 3. Attendance Rate (Mocked for now as we don't have attendance stream here)
              const Expanded(
                child: _StatCard(
                  title: "Attendance Rate",
                  value: "94%",
                  subtext: "Avg. daily attendance",
                  icon: Icons.event_available,
                  iconColor: AppColors.accentPurple,
                ),
              ),
              const SizedBox(width: 16),

              // 4. Unpaid Fees (Red Alert Style)
              Expanded(
                child: Container(
                  padding: const EdgeInsets.all(20),
                  decoration: BoxDecoration(
                      color: AppColors.surfaceGrey,
                      borderRadius: BorderRadius.circular(12),
                      border: Border.all(
                          color: AppColors.errorRed.withValues(alpha: 0.5)),
                      gradient: LinearGradient(
                        colors: [
                          AppColors.surfaceGrey,
                          AppColors.errorRed.withValues(alpha: 0.05)
                        ],
                        begin: Alignment.centerLeft,
                        end: Alignment.centerRight,
                      )),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    mainAxisAlignment: MainAxisAlignment.spaceBetween,
                    children: [
                      const Row(
                        mainAxisAlignment: MainAxisAlignment.spaceBetween,
                        children: [
                          Text("UNPAID FEES",
                              style: TextStyle(
                                  color: AppColors.textGrey,
                                  fontSize: 11,
                                  fontWeight: FontWeight.bold)),
                          Icon(Icons.warning_amber_rounded,
                              color: AppColors.errorRed, size: 20),
                        ],
                      ),
                      Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text(unpaidCount.toString(),
                              style: const TextStyle(
                                  color: AppColors.textWhite,
                                  fontSize: 28,
                                  fontWeight: FontWeight.bold)),
                          const SizedBox(height: 4),
                          const Text("Action required",
                              style: TextStyle(
                                  color: AppColors.errorRed,
                                  fontSize: 12,
                                  fontWeight: FontWeight.bold)),
                        ],
                      ),
                    ],
                  ),
                ),
              ),
            ],
          ),
        );
      },
    );
  }
}

class _StatCard extends StatelessWidget {
  final String title;
  final String value;
  final String subtext;
  final Color? subtextColor;
  final IconData icon;
  final Color iconColor;
  final bool showProgress;
  final double progressVal;

  const _StatCard({
    required this.title,
    required this.value,
    required this.subtext,
    this.subtextColor,
    required this.icon,
    required this.iconColor,
    this.showProgress = false,
    this.progressVal = 0,
  });

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: AppColors.divider),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Text(title.toUpperCase(),
                  style: const TextStyle(
                      color: AppColors.textGrey,
                      fontSize: 11,
                      fontWeight: FontWeight.bold)),
              Container(
                padding: const EdgeInsets.all(6),
                decoration: BoxDecoration(
                  color: iconColor.withValues(alpha: 0.15),
                  borderRadius: BorderRadius.circular(6),
                ),
                child: Icon(icon, color: iconColor, size: 18),
              ),
            ],
          ),
          Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text(value,
                  style: const TextStyle(
                      color: AppColors.textWhite,
                      fontSize: 24,
                      fontWeight: FontWeight.bold)),
              const SizedBox(height: 8),
              if (showProgress)
                Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    ClipRRect(
                      borderRadius: BorderRadius.circular(2),
                      child: LinearProgressIndicator(
                        value: progressVal,
                        backgroundColor: AppColors.backgroundBlack,
                        color: iconColor,
                        minHeight: 4,
                      ),
                    ),
                    const SizedBox(height: 6),
                  ],
                ),
              Text(subtext,
                  style: TextStyle(
                      color: subtextColor ?? AppColors.textWhite38,
                      fontSize: 11)),
            ],
          ),
        ],
      ),
    );
  }
}

// ==========================================
// FILE: ./students/financial_ledger_dialog.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:intl/intl.dart';
import '../../../../core/constants/app_colors.dart';
import '../../../../core/utils/safe_data.dart';

/// Enhanced Financial Ledger Dialog - displays comprehensive transaction history
class FinancialLedgerDialog extends ConsumerStatefulWidget {
  final String studentId;
  final String studentName;
  final String studentRid;
  final AsyncValue<List<Map<String, dynamic>>> billsAsync;
  final AsyncValue<List<Map<String, dynamic>>> paymentsAsync;

  const FinancialLedgerDialog({
    super.key,
    required this.studentId,
    required this.studentName,
    required this.studentRid,
    required this.billsAsync,
    required this.paymentsAsync,
  });

  @override
  ConsumerState<FinancialLedgerDialog> createState() =>
      _FinancialLedgerDialogState();
}

class _FinancialLedgerDialogState extends ConsumerState<FinancialLedgerDialog> {
  late String _selectedTransactionFilter;
  late String _selectedYearFilter;
  final ScrollController _horizontalScrollController = ScrollController();
  final ScrollController _verticalScrollController = ScrollController();

  @override
  void initState() {
    super.initState();
    _selectedTransactionFilter = 'All Transactions';
    _selectedYearFilter = 'This Academic Year';
  }

  @override
  void dispose() {
    _horizontalScrollController.dispose();
    _verticalScrollController.dispose();
    super.dispose();
  }

  String _formatCurrency(dynamic value) {
    final amount = SafeData.parseDouble(value, 0.0);
    return NumberFormat.simpleCurrency().format(amount);
  }

  String _formatDate(String? isoDate) {
    if (isoDate == null || isoDate.isEmpty) return 'N/A';
    try {
      final date = DateTime.parse(isoDate);
      return DateFormat('MMM dd, yyyy').format(date);
    } catch (_) {
      return isoDate;
    }
  }

  /// Build unified transaction list (bills + payments) with chronological ordering
  List<Map<String, dynamic>> _buildTransactionList(
    List<Map<String, dynamic>> bills,
    List<Map<String, dynamic>> payments,
  ) {
    final transactions = <Map<String, dynamic>>[];

    // Add bills as debits
    for (final bill in bills) {
      transactions.add({
        'type': 'bill',
        'date': bill['created_at'] ?? '',
        'ref_id': bill['id'] ?? 'INV-${bill['created_at']?.substring(0, 10)}',
        'description': bill['title'] ?? 'Bill',
        'category': bill['category'] ?? 'General',
        'debit': SafeData.parseDouble(bill['total_amount'], 0.0),
        'credit': 0.0,
        'is_paid': SafeData.parseInt(bill['is_paid']) == 1,
        'notes': bill['notes'] ?? '',
        'original': bill,
      });
    }

    // Add payments as credits
    for (final payment in payments) {
      transactions.add({
        'type': 'payment',
        'date': payment['date_paid'] ?? '',
        'ref_id':
            payment['reference'] ?? 'PAY-${payment['id']?.substring(0, 8)}',
        'description': 'Payment Received',
        'category': payment['payment_method'] ?? 'Bank Transfer',
        'debit': 0.0,
        'credit': SafeData.parseDouble(payment['amount'], 0.0),
        'is_paid': true,
        'notes': payment['notes'] ?? '',
        'original': payment,
      });
    }

    // Sort by date descending (newest first)
    transactions.sort((a, b) {
      final dateA = DateTime.tryParse(a['date'] ?? '') ?? DateTime(2000);
      final dateB = DateTime.tryParse(b['date'] ?? '') ?? DateTime(2000);
      return dateB.compareTo(dateA);
    });

    return transactions;
  }

  /// Calculate running balance and totals
  Map<String, dynamic> _calculateTotals(
      List<Map<String, dynamic>> transactions) {
    double totalDebit = 0.0;
    double totalCredit = 0.0;
    double balance = 0.0;

    // Calculate from oldest to newest for proper balance progression
    final sorted = List<Map<String, dynamic>>.from(transactions.reversed);
    for (final tx in sorted) {
      final debit = SafeData.parseDouble(tx['debit'], 0.0);
      final credit = SafeData.parseDouble(tx['credit'], 0.0);
      totalDebit += debit;
      totalCredit += credit;
      balance = totalCredit -
          totalDebit; // Positive = credit (overpaid), Negative = debit (owed)
    }

    return {
      'total_invoiced': totalDebit,
      'total_paid': totalCredit,
      'balance': balance,
    };
  }

  /// Get transaction color based on type
  Color _getTransactionColor(Map<String, dynamic> tx) {
    if (tx['type'] == 'payment') {
      return AppColors.successGreen;
    }
    return tx['is_paid'] ? AppColors.successGreen : AppColors.errorRed;
  }

  /// Detect missing billing-period metadata on bills to warn the user.
  List<String> _collectBillingPeriodIssues(List<Map<String, dynamic>> bills) {
    int missingYear = 0;
    int missingMonth = 0;
    int missingCycle = 0;

    for (final bill in bills) {
      final hasYear = (bill['school_year_id']?.toString().isNotEmpty ?? false);
      final hasMonth = (bill['month_index']?.toString().isNotEmpty ?? false);
      final hasCycle =
          (bill['billing_cycle_start']?.toString().isNotEmpty ?? false) &&
              (bill['billing_cycle_end']?.toString().isNotEmpty ?? false);

      if (!hasYear) missingYear++;
      if (!hasMonth) missingMonth++;
      if (!hasCycle) missingCycle++;
    }

    final issues = <String>[];
    if (missingYear > 0) {
      issues.add('$missingYear bill(s) missing school year linkage.');
    }
    if (missingMonth > 0) {
      issues.add('$missingMonth bill(s) missing month index.');
    }
    if (missingCycle > 0) {
      issues.add('$missingCycle bill(s) missing billing cycle dates.');
    }

    return issues;
  }

  Widget _buildWarningBanner(List<String> issues) {
    return Container(
      width: double.infinity,
      padding: const EdgeInsets.all(12),
      decoration: BoxDecoration(
        color: AppColors.warningOrange.withValues(alpha: 0.12),
        borderRadius: BorderRadius.circular(8),
        border:
            Border.all(color: AppColors.warningOrange.withValues(alpha: 0.5)),
      ),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          const Icon(Icons.warning_amber_rounded,
              color: AppColors.warningOrange, size: 18),
          const SizedBox(width: 8),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const Text(
                  'Billing period issues detected',
                  style: TextStyle(
                      color: AppColors.textWhite,
                      fontWeight: FontWeight.w600,
                      fontSize: 13),
                ),
                const SizedBox(height: 4),
                ...issues.map(
                  (issue) => Text(
                    issue,
                    style: const TextStyle(
                        color: AppColors.textWhite70, fontSize: 12),
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    return Dialog(
      backgroundColor: AppColors.backgroundBlack,
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
      child: Container(
        width: MediaQuery.of(context).size.width * 0.85,
        height: MediaQuery.of(context).size.height * 0.8,
        decoration: BoxDecoration(
          color: AppColors.backgroundBlack,
          borderRadius: BorderRadius.circular(12),
          border: Border.all(color: AppColors.divider),
        ),
        child: Column(
          children: [
            // Header
            Container(
              padding: const EdgeInsets.all(20),
              decoration: const BoxDecoration(
                border: Border(bottom: BorderSide(color: AppColors.divider)),
              ),
              child: Row(
                children: [
                  const Icon(Icons.receipt_long_outlined,
                      color: AppColors.primaryBlue, size: 24),
                  const SizedBox(width: 12),
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        const Text(
                          'Financial Ledger',
                          style: TextStyle(
                            color: AppColors.textWhite,
                            fontSize: 18,
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                        const SizedBox(height: 4),
                        Text(
                          'Transaction history for ${widget.studentName} (${widget.studentRid})',
                          style: const TextStyle(
                            color: AppColors.textWhite54,
                            fontSize: 12,
                          ),
                        ),
                      ],
                    ),
                  ),
                  IconButton(
                    onPressed: () => Navigator.of(context).pop(),
                    icon: const Icon(Icons.close, color: AppColors.textWhite),
                  ),
                ],
              ),
            ),

            // Filters Row
            Container(
              padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 16),
              child: Row(
                children: [
                  // Transaction Type Filter
                  Expanded(
                    child: _buildFilterDropdown(
                      label: 'All Transactions',
                      value: _selectedTransactionFilter,
                      options: [
                        'All Transactions',
                        'Invoices Only',
                        'Payments Only',
                        'Outstanding',
                      ],
                      onChanged: (value) {
                        setState(() => _selectedTransactionFilter = value);
                      },
                    ),
                  ),
                  const SizedBox(width: 16),

                  // Year Filter
                  Expanded(
                    child: _buildFilterDropdown(
                      label: 'This Academic Year',
                      value: _selectedYearFilter,
                      options: [
                        'This Academic Year',
                        'Last Academic Year',
                        'All Time',
                      ],
                      onChanged: (value) {
                        setState(() => _selectedYearFilter = value);
                      },
                    ),
                  ),
                  const SizedBox(width: 32),

                  // Summary Totals
                  widget.billsAsync.when(
                    data: (bills) {
                      final transactions = _buildTransactionList(bills, []);
                      final totals = _calculateTotals(transactions);
                      return Row(
                        children: [
                          _buildSummaryChip(
                            label: 'Total Invoiced',
                            amount: totals['total_invoiced'],
                            color: AppColors.errorRed,
                          ),
                          const SizedBox(width: 16),
                          _buildSummaryChip(
                            label: 'Total Paid',
                            amount: totals['total_paid'],
                            color: AppColors.successGreen,
                          ),
                        ],
                      );
                    },
                    loading: () => const SizedBox(
                      width: 200,
                      child: CircularProgressIndicator(
                        valueColor:
                            AlwaysStoppedAnimation(AppColors.primaryBlue),
                        strokeWidth: 2,
                      ),
                    ),
                    error: (err, _) => const Text(
                      'Error loading totals',
                      style: TextStyle(color: AppColors.errorRed),
                    ),
                  ),
                ],
              ),
            ),

            // Transactions Table
            Expanded(
              child: widget.billsAsync.when(
                data: (bills) {
                  return widget.paymentsAsync.when(
                    data: (payments) {
                      final transactions =
                          _buildTransactionList(bills, payments);
                      final filtered = transactions.where((tx) {
                        if (_selectedTransactionFilter == 'Invoices Only' &&
                            tx['type'] != 'bill') {
                          return false;
                        }
                        if (_selectedTransactionFilter == 'Payments Only' &&
                            tx['type'] != 'payment') {
                          return false;
                        }
                        if (_selectedTransactionFilter == 'Outstanding' &&
                            tx['is_paid'] == true) {
                          return false;
                        }
                        return true;
                      }).toList();

                      final periodIssues = _collectBillingPeriodIssues(bills);

                      if (filtered.isEmpty) {
                        return Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            if (periodIssues.isNotEmpty)
                              Padding(
                                padding: const EdgeInsets.symmetric(
                                    horizontal: 20, vertical: 8),
                                child: _buildWarningBanner(periodIssues),
                              ),
                            const Expanded(
                              child: Center(
                                child: Text(
                                  'No transactions found',
                                  style: TextStyle(
                                    color: AppColors.textWhite54,
                                    fontSize: 14,
                                  ),
                                ),
                              ),
                            ),
                          ],
                        );
                      }

                      double runningBalance = 0.0;
                      final txWithBalance = filtered.map((tx) {
                        final debit = SafeData.parseDouble(tx['debit'], 0.0);
                        final credit = SafeData.parseDouble(tx['credit'], 0.0);
                        runningBalance = credit - debit + runningBalance;
                        return {...tx, 'balance': runningBalance};
                      }).toList();

                      return Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          if (periodIssues.isNotEmpty)
                            Padding(
                              padding: const EdgeInsets.symmetric(
                                  horizontal: 20, vertical: 8),
                              child: _buildWarningBanner(periodIssues),
                            ),
                          Expanded(
                            child: Scrollbar(
                              controller: _verticalScrollController,
                              child: SingleChildScrollView(
                                controller: _verticalScrollController,
                                child: Scrollbar(
                                  controller: _horizontalScrollController,
                                  child: SingleChildScrollView(
                                    controller: _horizontalScrollController,
                                    scrollDirection: Axis.horizontal,
                                    child: DataTable(
                                      dataRowMinHeight: 48,
                                      headingRowHeight: 44,
                                      headingRowColor: WidgetStateProperty.all(
                                        AppColors.surfaceGrey,
                                      ),
                                      columns: const [
                                        DataColumn(
                                          label: Text(
                                            'DATE',
                                            style: TextStyle(
                                              color: AppColors.textWhite38,
                                              fontSize: 11,
                                              fontWeight: FontWeight.bold,
                                              letterSpacing: 0.5,
                                            ),
                                          ),
                                        ),
                                        DataColumn(
                                          label: Text(
                                            'REF ID',
                                            style: TextStyle(
                                              color: AppColors.textWhite38,
                                              fontSize: 11,
                                              fontWeight: FontWeight.bold,
                                              letterSpacing: 0.5,
                                            ),
                                          ),
                                        ),
                                        DataColumn(
                                          label: Text(
                                            'DESCRIPTION',
                                            style: TextStyle(
                                              color: AppColors.textWhite38,
                                              fontSize: 11,
                                              fontWeight: FontWeight.bold,
                                              letterSpacing: 0.5,
                                            ),
                                          ),
                                        ),
                                        DataColumn(
                                          label: Text(
                                            'DEBIT',
                                            style: TextStyle(
                                              color: AppColors.textWhite38,
                                              fontSize: 11,
                                              fontWeight: FontWeight.bold,
                                              letterSpacing: 0.5,
                                            ),
                                          ),
                                          numeric: true,
                                        ),
                                        DataColumn(
                                          label: Text(
                                            'CREDIT',
                                            style: TextStyle(
                                              color: AppColors.textWhite38,
                                              fontSize: 11,
                                              fontWeight: FontWeight.bold,
                                              letterSpacing: 0.5,
                                            ),
                                          ),
                                          numeric: true,
                                        ),
                                        DataColumn(
                                          label: Text(
                                            'BALANCE',
                                            style: TextStyle(
                                              color: AppColors.textWhite38,
                                              fontSize: 11,
                                              fontWeight: FontWeight.bold,
                                              letterSpacing: 0.5,
                                            ),
                                          ),
                                          numeric: true,
                                        ),
                                        DataColumn(
                                          label: Text(
                                            'STATUS',
                                            style: TextStyle(
                                              color: AppColors.textWhite38,
                                              fontSize: 11,
                                              fontWeight: FontWeight.bold,
                                              letterSpacing: 0.5,
                                            ),
                                          ),
                                        ),
                                        DataColumn(
                                          label: Text(
                                            'NOTES',
                                            style: TextStyle(
                                              color: AppColors.textWhite38,
                                              fontSize: 11,
                                              fontWeight: FontWeight.bold,
                                              letterSpacing: 0.5,
                                            ),
                                          ),
                                        ),
                                      ],
                                      rows: txWithBalance.map((tx) {
                                        return DataRow(
                                          cells: [
                                            DataCell(Text(
                                              _formatDate(tx['date']),
                                              style: const TextStyle(
                                                  color: AppColors.textWhite,
                                                  fontSize: 12),
                                            )),
                                            DataCell(Text(
                                              tx['ref_id'],
                                              style: const TextStyle(
                                                  color: AppColors.textWhite,
                                                  fontSize: 12,
                                                  fontWeight: FontWeight.w600),
                                            )),
                                            DataCell(Text(
                                              tx['description'],
                                              style: const TextStyle(
                                                  color: AppColors.textWhite,
                                                  fontSize: 12),
                                            )),
                                            DataCell(Text(
                                              tx['debit'] > 0
                                                  ? _formatCurrency(tx['debit'])
                                                  : '-',
                                              style: const TextStyle(
                                                  color: AppColors.errorRed,
                                                  fontSize: 12,
                                                  fontWeight: FontWeight.w600),
                                            )),
                                            DataCell(Text(
                                              tx['credit'] > 0
                                                  ? _formatCurrency(
                                                      tx['credit'])
                                                  : '-',
                                              style: const TextStyle(
                                                  color: AppColors.successGreen,
                                                  fontSize: 12,
                                                  fontWeight: FontWeight.w600),
                                            )),
                                            DataCell(Text(
                                              _formatCurrency(tx['balance']),
                                              style: const TextStyle(
                                                  color: AppColors.textWhite,
                                                  fontSize: 12,
                                                  fontWeight: FontWeight.bold),
                                            )),
                                            DataCell(Row(
                                              children: [
                                                Container(
                                                  width: 8,
                                                  height: 8,
                                                  decoration: BoxDecoration(
                                                    color: _getTransactionColor(
                                                        tx),
                                                    shape: BoxShape.circle,
                                                  ),
                                                ),
                                                const SizedBox(width: 6),
                                                Text(
                                                  tx['type'] == 'payment'
                                                      ? 'Payment'
                                                      : tx['is_paid']
                                                          ? 'Paid'
                                                          : 'Due',
                                                  style: TextStyle(
                                                    color: _getTransactionColor(
                                                        tx),
                                                    fontSize: 12,
                                                    fontWeight: FontWeight.w600,
                                                  ),
                                                ),
                                              ],
                                            )),
                                            DataCell(Text(
                                              tx['notes'] ?? '-',
                                              style: const TextStyle(
                                                  color: AppColors.textWhite54,
                                                  fontSize: 12),
                                            )),
                                          ],
                                        );
                                      }).toList(),
                                    ),
                                  ),
                                ),
                              ),
                            ),
                          ),
                        ],
                      );
                    },
                    loading: () => const Center(
                      child: CircularProgressIndicator(
                        valueColor:
                            AlwaysStoppedAnimation(AppColors.primaryBlue),
                      ),
                    ),
                    error: (err, _) => Center(
                      child: Text(
                        'Error loading payments: $err',
                        style: const TextStyle(color: AppColors.errorRed),
                      ),
                    ),
                  );
                },
                loading: () => const Center(
                  child: CircularProgressIndicator(
                    valueColor: AlwaysStoppedAnimation(AppColors.primaryBlue),
                  ),
                ),
                error: (err, _) => Center(
                  child: Text(
                    'Error loading bills: $err',
                    style: const TextStyle(color: AppColors.errorRed),
                  ),
                ),
              ),
            ),

            // Footer with Action Buttons
            Container(
              padding: const EdgeInsets.all(20),
              decoration: const BoxDecoration(
                border: Border(top: BorderSide(color: AppColors.divider)),
              ),
              child: Row(
                mainAxisAlignment: MainAxisAlignment.end,
                children: [
                  OutlinedButton.icon(
                    onPressed: () {
                      ScaffoldMessenger.of(context).showSnackBar(
                        const SnackBar(
                          content: Text('Print functionality coming soon'),
                          backgroundColor: AppColors.primaryBlue,
                          duration: Duration(seconds: 2),
                        ),
                      );
                    },
                    icon: const Icon(Icons.print_outlined, size: 18),
                    label: const Text('Print Statement'),
                    style: OutlinedButton.styleFrom(
                      foregroundColor: AppColors.primaryBlue,
                      side: const BorderSide(color: AppColors.primaryBlue),
                      padding: const EdgeInsets.symmetric(
                          horizontal: 16, vertical: 12),
                    ),
                  ),
                  const SizedBox(width: 12),
                  ElevatedButton.icon(
                    onPressed: () {
                      ScaffoldMessenger.of(context).showSnackBar(
                        const SnackBar(
                          content: Text('PDF download coming soon'),
                          backgroundColor: AppColors.primaryBlue,
                          duration: Duration(seconds: 2),
                        ),
                      );
                    },
                    icon: const Icon(Icons.download_outlined, size: 18),
                    label: const Text('Download PDF'),
                    style: ElevatedButton.styleFrom(
                      backgroundColor: AppColors.primaryBlue,
                      padding: const EdgeInsets.symmetric(
                          horizontal: 16, vertical: 12),
                    ),
                  ),
                  const SizedBox(width: 12),
                  TextButton(
                    onPressed: () => Navigator.of(context).pop(),
                    child: const Text('Close'),
                  ),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildFilterDropdown({
    required String label,
    required String value,
    required List<String> options,
    required Function(String) onChanged,
  }) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(8),
        border: Border.all(color: AppColors.divider),
      ),
      child: DropdownButton<String>(
        value: value,
        onChanged: (newValue) {
          if (newValue != null) onChanged(newValue);
        },
        isExpanded: true,
        underline: const SizedBox.shrink(),
        icon: const Icon(Icons.expand_more, color: AppColors.textWhite54),
        style: const TextStyle(
          color: AppColors.textWhite,
          fontSize: 13,
        ),
        dropdownColor: AppColors.surfaceGrey,
        items: options
            .map((option) => DropdownMenuItem(
                  value: option,
                  child: Text(option),
                ))
            .toList(),
      ),
    );
  }

  Widget _buildSummaryChip({
    required String label,
    required double amount,
    required Color color,
  }) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(8),
        border: Border.all(color: color.withAlpha((0.3 * 255) as int)),
      ),
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Text(
            label,
            style: const TextStyle(
              color: AppColors.textWhite54,
              fontSize: 10,
              fontWeight: FontWeight.bold,
              letterSpacing: 0.5,
            ),
          ),
          const SizedBox(height: 4),
          Text(
            _formatCurrency(amount),
            style: TextStyle(
              color: color,
              fontSize: 14,
              fontWeight: FontWeight.bold,
            ),
          ),
        ],
      ),
    );
  }
}

// ==========================================
// FILE: ./students/edit_student_dialog.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:intl/intl.dart';

import '../../../../core/constants/app_colors.dart';
import '../../../../core/utils/safe_data.dart';
import '../../../../data/models/subjects.dart';
import '../../../../data/services/database_service.dart';

class EditStudentDialog extends ConsumerStatefulWidget {
  final Map<String, dynamic> studentData;
  final String schoolId;

  const EditStudentDialog({
    super.key,
    required this.studentData,
    required this.schoolId,
  });

  @override
  ConsumerState<EditStudentDialog> createState() => _EditStudentDialogState();
}

class _EditStudentDialogState extends ConsumerState<EditStudentDialog> {
  final _formKey = GlobalKey<FormState>();
  final DatabaseService _dbService = DatabaseService();

  // -- Controllers --
  late TextEditingController _fullNameController;
  late TextEditingController _studentIdController;
  late TextEditingController _parentContactController;
  late TextEditingController _emergencyContactController;
  late TextEditingController _addressController;
  late TextEditingController _feeController;
  late TextEditingController _medicalNotesController;

  // -- State --
  late DateTime _dob;
  late DateTime _registrationDate;
  late DateTime _enrollmentDate;
  late DateTime _billingDate;
  late String _selectedGender;
  late String _selectedGrade;
  late String _selectedBillingType;
  late String _selectedTerm;
  List<String> _selectedSubjects = [];
  bool _isActive = true;
  bool _photoConsent = false;
  bool _isLoading = false;

  // -- Constants --
  final List<String> _genders = ['Male', 'Female'];
  final List<String> _grades = [
    'ECD A',
    'ECD B',
    'GRADE 1',
    'GRADE 2',
    'GRADE 3',
    'GRADE 4',
    'GRADE 5',
    'GRADE 6',
    'GRADE 7',
    'FORM 1',
    'FORM 2',
    'FORM 3',
    'FORM 4',
    'LOWER 6',
    'UPPER 6'
  ];
  final List<String> _billingTypes = ['monthly', 'termly'];
  final List<String> _terms = ['Term 1', 'Term 2', 'Term 3', 'Term 4'];

  @override
  void initState() {
    super.initState();
    _initializeControllers();
  }

  void _initializeControllers() {
    _fullNameController =
        TextEditingController(text: widget.studentData['full_name'] ?? '');
    _studentIdController =
        TextEditingController(text: widget.studentData['student_id'] ?? '');
    _parentContactController =
        TextEditingController(text: widget.studentData['parent_contact'] ?? '');
    _emergencyContactController = TextEditingController(
        text: widget.studentData['emergency_contact_name'] ?? '');
    _addressController =
        TextEditingController(text: widget.studentData['address'] ?? '');
    _feeController = TextEditingController(
        text: (widget.studentData['default_fee'] ?? 0).toString());
    _medicalNotesController =
        TextEditingController(text: widget.studentData['medical_notes'] ?? '');

    // Parse subjects string into list (üõ°Ô∏è Safe parsing)
    final String subjectsStr = widget.studentData['subjects'] ?? '';
    _selectedSubjects = subjectsStr.isNotEmpty
        ? subjectsStr
            .split(',')
            .map((e) => e.trim())
            .where((e) => e.isNotEmpty)
            .toList()
        : [];

    // Parse dates (üõ°Ô∏è Issue #7: Safe date parsing)
    _dob = SafeData.parseDate(
      widget.studentData['date_of_birth'],
      fallback: DateTime(2010, 1, 1),
    );

    _registrationDate = SafeData.parseDate(
      widget.studentData['registration_date'],
      fallback: DateTime.now(),
    );

    _enrollmentDate = SafeData.parseDate(
      widget.studentData['enrollment_date'],
      fallback: DateTime.now(),
    );

    _billingDate = SafeData.parseDate(
      widget.studentData['billing_date'],
      fallback: DateTime.now(),
    );

    _selectedGender = widget.studentData['gender'] ?? 'Male';
    // Ensure selected grade is valid, otherwise default to FORM 1
    final rawGrade = widget.studentData['grade'];
    _selectedGrade = _grades.contains(rawGrade) ? rawGrade : 'FORM 1';

    _selectedBillingType = widget.studentData['billing_type'] ?? 'monthly';
    _selectedTerm = widget.studentData['term_id'] ?? 'Term 1';
    _isActive = SafeData.parseInt(widget.studentData['is_active']) == 1;
    _photoConsent = SafeData.parseInt(widget.studentData['photo_consent']) == 1;
  }

  @override
  void dispose() {
    _fullNameController.dispose();
    _studentIdController.dispose();
    _parentContactController.dispose();
    _emergencyContactController.dispose();
    _addressController.dispose();
    _feeController.dispose();
    _medicalNotesController.dispose();
    super.dispose();
  }

  Future<void> _saveChanges() async {
    if (!_formKey.currentState!.validate()) return;

    setState(() => _isLoading = true);

    try {
      final db = _dbService;
      final studentId = widget.studentData['id'];

      // üõ°Ô∏è Issue #5: Field-level validation
      final fullName = SafeData.sanitize(_fullNameController.text);
      final parentContact = SafeData.sanitize(_parentContactController.text);
      final emergencyContact =
          SafeData.sanitize(_emergencyContactController.text);
      final address = SafeData.sanitize(_addressController.text);
      final medicalNotes = SafeData.sanitize(_medicalNotesController.text);
      final defaultFee =
          SafeData.parseDouble(_feeController.text.replaceAll(',', ''), 0.0);

      // Validate critical fields
      if (fullName.isEmpty || fullName.length < 3) {
        if (mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(
              content: Text('Full name must be at least 3 characters'),
              backgroundColor: AppColors.errorRed,
            ),
          );
        }
        setState(() => _isLoading = false);
        return;
      }

      if (parentContact.isNotEmpty && !SafeData.isValidPhone(parentContact)) {
        if (mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(
              content: Text('Please enter a valid phone number'),
              backgroundColor: AppColors.errorRed,
            ),
          );
        }
        setState(() => _isLoading = false);
        return;
      }

      // üõ°Ô∏è Issue #12: Sanitized update data (ALL schema fields)
      final updateData = {
        'full_name': fullName,
        'parent_contact': parentContact,
        'emergency_contact_name': emergencyContact,
        'address': address,
        'medical_notes': medicalNotes,
        'subjects': _selectedSubjects.join(','),
        'date_of_birth': DateFormat('yyyy-MM-dd').format(_dob),
        'registration_date': DateFormat('yyyy-MM-dd').format(_registrationDate),
        'enrollment_date': DateFormat('yyyy-MM-dd').format(_enrollmentDate),
        'billing_date': DateFormat('yyyy-MM-dd').format(_billingDate),
        'gender': _selectedGender,
        'grade': _selectedGrade,
        'billing_type': _selectedBillingType,
        'term_id': _selectedTerm,
        'default_fee': defaultFee,
        'photo_consent': _photoConsent ? 1 : 0,
        'is_active': _isActive ? 1 : 0,
        'updated_at': DateTime.now().toIso8601String(),
      };

      await db.update('students', studentId, updateData);

      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
            content: Text('‚úÖ Student updated successfully!'),
            backgroundColor: AppColors.successGreen,
          ),
        );
        Navigator.of(context).pop();
      }
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Error: $e'),
            backgroundColor: AppColors.errorRed,
          ),
        );
      }
    } finally {
      if (mounted) setState(() => _isLoading = false);
    }
  }

  // --- SUB-DIALOGS (Subject Selector) ---
  void _openSubjectSelector() {
    showDialog(
      context: context,
      builder: (context) {
        final allSubjects = ZimsecSubject.allNames;
        List<String> tempSelected = List.from(_selectedSubjects);
        String searchQuery = "";

        return StatefulBuilder(builder: (context, setState) {
          final filteredSubjects = allSubjects
              .where((s) => s.toLowerCase().contains(searchQuery.toLowerCase()))
              .toList();

          return AlertDialog(
            backgroundColor: AppColors.surfaceGrey,
            title: const Text("Select Subjects",
                style: TextStyle(color: AppColors.textWhite)),
            content: SizedBox(
              width: 400,
              height: 500,
              child: Column(
                children: [
                  TextField(
                    onChanged: (val) => setState(() => searchQuery = val),
                    style: const TextStyle(color: AppColors.textWhite),
                    decoration: InputDecoration(
                      hintText: "Search subjects...",
                      hintStyle: const TextStyle(color: AppColors.textWhite38),
                      prefixIcon: const Icon(Icons.search,
                          color: AppColors.textWhite54),
                      filled: true,
                      fillColor: Colors.black12,
                      border: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(8),
                          borderSide: BorderSide.none),
                    ),
                  ),
                  const SizedBox(height: 12),
                  Expanded(
                    child: ListView.builder(
                      itemCount: filteredSubjects.length,
                      itemBuilder: (context, index) {
                        final subject = filteredSubjects[index];
                        final isSelected = tempSelected.contains(subject);
                        return CheckboxListTile(
                          title: Text(subject,
                              style: const TextStyle(
                                  color: AppColors.textWhite70)),
                          value: isSelected,
                          activeColor: AppColors.primaryBlue,
                          checkColor: AppColors.textWhite,
                          contentPadding: EdgeInsets.zero,
                          onChanged: (val) {
                            setState(() {
                              if (val == true) {
                                tempSelected.add(subject);
                              } else {
                                tempSelected.remove(subject);
                              }
                            });
                          },
                        );
                      },
                    ),
                  ),
                ],
              ),
            ),
            actions: [
              TextButton(
                onPressed: () => Navigator.pop(context),
                child: const Text("Cancel",
                    style: TextStyle(color: AppColors.textGrey)),
              ),
              ElevatedButton(
                onPressed: () {
                  this.setState(() => _selectedSubjects = tempSelected);
                  Navigator.pop(context);
                },
                style: ElevatedButton.styleFrom(
                    backgroundColor: AppColors.primaryBlue),
                child: const Text("Confirm",
                    style: TextStyle(color: AppColors.textWhite)),
              ),
            ],
          );
        });
      },
    );
  }

  @override
  Widget build(BuildContext context) {
    return Dialog(
      backgroundColor: Colors.transparent,
      insetPadding: const EdgeInsets.all(24),
      child: Container(
        width: 1100,
        height: 800,
        decoration: BoxDecoration(
          color: AppColors.backgroundBlack,
          borderRadius: BorderRadius.circular(16),
          border: Border.all(color: AppColors.surfaceLightGrey),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withValues(alpha: 0.5),
              blurRadius: 20,
              offset: const Offset(0, 10),
            )
          ],
        ),
        child: Column(
          children: [
            // Header
            Padding(
              padding: const EdgeInsets.symmetric(horizontal: 32, vertical: 24),
              child: Row(
                children: [
                  Container(
                    padding: const EdgeInsets.all(8),
                    decoration: BoxDecoration(
                      color: AppColors.primaryBlue.withValues(alpha: 0.2),
                      borderRadius: BorderRadius.circular(8),
                    ),
                    child: const Icon(Icons.edit, color: AppColors.primaryBlue),
                  ),
                  const SizedBox(width: 16),
                  const Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        "Edit Student Profile",
                        style: TextStyle(
                          color: AppColors.textWhite,
                          fontSize: 18,
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                      Text(
                        "Update student details",
                        style: TextStyle(
                          color: AppColors.textGrey,
                          fontSize: 13,
                        ),
                      ),
                    ],
                  ),
                  const Spacer(),
                  IconButton(
                    onPressed: () => Navigator.pop(context),
                    icon: const Icon(Icons.close, color: AppColors.textGrey),
                  ),
                ],
              ),
            ),
            const Divider(height: 1, color: AppColors.divider),

            // Content
            Expanded(
              child: Row(
                children: [
                  // --- LEFT: FORM (Flex 5) ---
                  Expanded(
                    flex: 5,
                    child: Padding(
                      padding: const EdgeInsets.all(32),
                      child: Form(
                        key: _formKey,
                        child: SingleChildScrollView(
                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              // Personal Info Section
                              const Text("STUDENT DETAILS",
                                  style: TextStyle(
                                      color: AppColors.textGrey,
                                      fontSize: 12,
                                      fontWeight: FontWeight.bold,
                                      letterSpacing: 1.2)),
                              const SizedBox(height: 24),
                              _buildLabel("Full Name", AppColors.textWhite),
                              _buildTextField(
                                controller: _fullNameController,
                                hint: "e.g. Gabriel",
                                prefixIcon: Icons.person_outline,
                              ),
                              const SizedBox(height: 16),
                              Row(
                                children: [
                                  Expanded(
                                    child: Column(
                                      crossAxisAlignment:
                                          CrossAxisAlignment.start,
                                      children: [
                                        _buildLabel(
                                            "Student ID", AppColors.textWhite),
                                        _buildTextField(
                                          controller: _studentIdController,
                                          hint: "STU-...",
                                          readOnly: true,
                                        ),
                                      ],
                                    ),
                                  ),
                                  const SizedBox(width: 16),
                                  Expanded(
                                    child: Column(
                                      crossAxisAlignment:
                                          CrossAxisAlignment.start,
                                      children: [
                                        _buildLabel(
                                            "Grade", AppColors.textWhite),
                                        _buildDropdown(
                                          value: _selectedGrade,
                                          items: _grades,
                                          onChanged: (v) => setState(
                                              () => _selectedGrade = v!),
                                        ),
                                      ],
                                    ),
                                  ),
                                ],
                              ),
                              const SizedBox(height: 16),
                              Row(
                                children: [
                                  Expanded(
                                    child: Column(
                                      crossAxisAlignment:
                                          CrossAxisAlignment.start,
                                      children: [
                                        _buildLabel("Date of Birth",
                                            AppColors.textWhite),
                                        _buildDatePicker(
                                          context,
                                          _dob,
                                          (d) => setState(() => _dob = d),
                                        ),
                                      ],
                                    ),
                                  ),
                                  const SizedBox(width: 16),
                                  Expanded(
                                    child: Column(
                                      crossAxisAlignment:
                                          CrossAxisAlignment.start,
                                      children: [
                                        _buildLabel(
                                            "Gender", AppColors.textWhite),
                                        _buildDropdown(
                                          value: _selectedGender,
                                          items: _genders,
                                          onChanged: (v) => setState(
                                              () => _selectedGender = v!),
                                        ),
                                      ],
                                    ),
                                  ),
                                ],
                              ),
                              const SizedBox(height: 16),
                              _buildLabel("Subjects", AppColors.textWhite),
                              InkWell(
                                onTap: _openSubjectSelector,
                                child: Container(
                                  padding: const EdgeInsets.symmetric(
                                      horizontal: 16, vertical: 14),
                                  decoration: BoxDecoration(
                                    color: AppColors.surfaceGrey,
                                    borderRadius: BorderRadius.circular(8),
                                    border: Border.all(
                                        color: AppColors.surfaceLightGrey),
                                  ),
                                  child: Row(
                                    mainAxisAlignment:
                                        MainAxisAlignment.spaceBetween,
                                    children: [
                                      Text(
                                        _selectedSubjects.isEmpty
                                            ? "Select Subjects..."
                                            : "${_selectedSubjects.length} subjects selected",
                                        style: TextStyle(
                                            color: _selectedSubjects.isEmpty
                                                ? AppColors.textWhite54
                                                : AppColors.textWhite),
                                      ),
                                      const Icon(Icons.arrow_drop_down,
                                          color: AppColors.textWhite54),
                                    ],
                                  ),
                                ),
                              ),
                              if (_selectedSubjects.isNotEmpty) ...[
                                const SizedBox(height: 8),
                                Wrap(
                                  spacing: 8,
                                  runSpacing: 8,
                                  children: _selectedSubjects
                                      .take(10)
                                      .map((s) => Chip(
                                            label: Text(s,
                                                style: const TextStyle(
                                                    fontSize: 10,
                                                    color:
                                                        AppColors.textWhite)),
                                            backgroundColor: AppColors
                                                .primaryBlue
                                                .withValues(alpha: 0.2),
                                            padding: EdgeInsets.zero,
                                            side: BorderSide.none,
                                          ))
                                      .toList(),
                                ),
                              ],
                              const SizedBox(height: 16),
                              _buildLabel("Medical Notes", AppColors.textWhite),
                              _buildTextField(
                                controller: _medicalNotesController,
                                hint: "Allergies, conditions, etc.",
                                prefixIcon: Icons.medical_information_outlined,
                                maxLines: 2,
                              ),
                              const SizedBox(height: 24),

                              // Contact Section
                              const Text("CONTACT & FINANCIAL",
                                  style: TextStyle(
                                      color: AppColors.textGrey,
                                      fontSize: 12,
                                      fontWeight: FontWeight.bold,
                                      letterSpacing: 1.2)),
                              const SizedBox(height: 24),
                              _buildLabel("Address", AppColors.textWhite),
                              _buildTextField(
                                controller: _addressController,
                                hint: "Street address...",
                                prefixIcon: Icons.location_on_outlined,
                              ),
                              const SizedBox(height: 16),
                              Row(
                                children: [
                                  Expanded(
                                    child: Column(
                                      crossAxisAlignment:
                                          CrossAxisAlignment.start,
                                      children: [
                                        _buildLabel(
                                            "Tuition Fee", AppColors.textWhite),
                                        _buildTextField(
                                          controller: _feeController,
                                          hint: "0.00",
                                          prefix: "\$ ",
                                          isNumber: true,
                                        ),
                                      ],
                                    ),
                                  ),
                                ],
                              ),
                              const SizedBox(height: 24),

                              // Enrollment & Billing Section
                              const Text("ENROLLMENT & BILLING",
                                  style: TextStyle(
                                      color: AppColors.textGrey,
                                      fontSize: 12,
                                      fontWeight: FontWeight.bold,
                                      letterSpacing: 1.2)),
                              const SizedBox(height: 24),
                              Row(
                                children: [
                                  Expanded(
                                    child: Column(
                                      crossAxisAlignment:
                                          CrossAxisAlignment.start,
                                      children: [
                                        _buildLabel("Registration Date",
                                            AppColors.textWhite),
                                        _buildDatePicker(
                                          context,
                                          _registrationDate,
                                          (d) => setState(
                                              () => _registrationDate = d),
                                        ),
                                      ],
                                    ),
                                  ),
                                  const SizedBox(width: 16),
                                  Expanded(
                                    child: Column(
                                      crossAxisAlignment:
                                          CrossAxisAlignment.start,
                                      children: [
                                        _buildLabel("Enrollment Date",
                                            AppColors.textWhite),
                                        _buildDatePicker(
                                          context,
                                          _enrollmentDate,
                                          (d) => setState(
                                              () => _enrollmentDate = d),
                                        ),
                                      ],
                                    ),
                                  ),
                                ],
                              ),
                              const SizedBox(height: 16),
                              Row(
                                children: [
                                  Expanded(
                                    child: Column(
                                      crossAxisAlignment:
                                          CrossAxisAlignment.start,
                                      children: [
                                        _buildLabel("Billing Date",
                                            AppColors.textWhite),
                                        _buildDatePicker(
                                          context,
                                          _billingDate,
                                          (d) =>
                                              setState(() => _billingDate = d),
                                        ),
                                      ],
                                    ),
                                  ),
                                  const SizedBox(width: 16),
                                  Expanded(
                                    child: Column(
                                      crossAxisAlignment:
                                          CrossAxisAlignment.start,
                                      children: [
                                        _buildLabel(
                                            "Term", AppColors.textWhite),
                                        _buildDropdown(
                                          value: _selectedTerm,
                                          items: _terms,
                                          onChanged: (v) => setState(
                                              () => _selectedTerm = v!),
                                        ),
                                      ],
                                    ),
                                  ),
                                ],
                              ),
                              const SizedBox(height: 16),
                              Row(
                                children: [
                                  Expanded(
                                    child: Column(
                                      crossAxisAlignment:
                                          CrossAxisAlignment.start,
                                      children: [
                                        _buildLabel("Billing Type",
                                            AppColors.textWhite),
                                        Container(
                                          height: 52,
                                          decoration: BoxDecoration(
                                            color: AppColors.surfaceGrey,
                                            borderRadius:
                                                BorderRadius.circular(8),
                                            border: Border.all(
                                                color:
                                                    AppColors.surfaceLightGrey),
                                          ),
                                          padding: const EdgeInsets.all(4),
                                          child: Row(
                                            children: _billingTypes.map((type) {
                                              final isSelected =
                                                  _selectedBillingType == type;
                                              return Expanded(
                                                child: GestureDetector(
                                                  onTap: () => setState(() =>
                                                      _selectedBillingType =
                                                          type),
                                                  child: Container(
                                                    decoration: BoxDecoration(
                                                      color: isSelected
                                                          ? AppColors
                                                              .primaryBlue
                                                          : Colors.transparent,
                                                      borderRadius:
                                                          BorderRadius.circular(
                                                              6),
                                                    ),
                                                    alignment: Alignment.center,
                                                    child: Text(
                                                      type.toUpperCase(),
                                                      style: TextStyle(
                                                          fontSize: 12,
                                                          fontWeight:
                                                              FontWeight.bold,
                                                          color: isSelected
                                                              ? AppColors
                                                                  .textWhite
                                                              : AppColors
                                                                  .textGrey),
                                                    ),
                                                  ),
                                                ),
                                              );
                                            }).toList(),
                                          ),
                                        ),
                                      ],
                                    ),
                                  ),
                                ],
                              ),
                              const SizedBox(height: 24),

                              // Status & Preferences Section
                              const Text("STATUS & PREFERENCES",
                                  style: TextStyle(
                                      color: AppColors.textGrey,
                                      fontSize: 12,
                                      fontWeight: FontWeight.bold,
                                      letterSpacing: 1.2)),
                              const SizedBox(height: 16),
                              Row(
                                children: [
                                  Expanded(
                                    child: _buildCheckbox(
                                      label: "Active",
                                      value: _isActive,
                                      onChanged: (v) =>
                                          setState(() => _isActive = v!),
                                    ),
                                  ),
                                  const SizedBox(width: 32),
                                  Expanded(
                                    child: _buildCheckbox(
                                      label: "Photo Consent",
                                      value: _photoConsent,
                                      onChanged: (v) =>
                                          setState(() => _photoConsent = v!),
                                    ),
                                  ),
                                ],
                              ),
                            ],
                          ),
                        ),
                      ),
                    ),
                  ),

                  const VerticalDivider(width: 1, color: AppColors.divider),

                  // --- RIGHT: INFO/SUMMARY (Flex 4) ---
                  Expanded(
                    flex: 4,
                    child: Container(
                      color: AppColors.surfaceDarkGrey,
                      padding: const EdgeInsets.all(24),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          const Text("PROFILE SUMMARY",
                              style: TextStyle(
                                  color: AppColors.textGrey,
                                  fontSize: 12,
                                  fontWeight: FontWeight.bold,
                                  letterSpacing: 1.2)),
                          const SizedBox(height: 24),

                          // Summary Card
                          Container(
                            padding: const EdgeInsets.all(24),
                            width: double.infinity,
                            decoration: BoxDecoration(
                              color: AppColors.surfaceGrey,
                              borderRadius: BorderRadius.circular(16),
                              border: Border.all(
                                  color: Colors.white.withValues(alpha: 0.05)),
                            ),
                            child: Column(
                              children: [
                                CircleAvatar(
                                  radius: 40,
                                  backgroundColor: AppColors.primaryBlue
                                      .withValues(alpha: 0.2),
                                  child: Text(
                                    _fullNameController.text.isNotEmpty
                                        ? _fullNameController.text[0]
                                            .toUpperCase()
                                        : '?',
                                    style: const TextStyle(
                                        fontSize: 32,
                                        fontWeight: FontWeight.bold,
                                        color: AppColors.primaryBlue),
                                  ),
                                ),
                                const SizedBox(height: 16),
                                Text(
                                  _fullNameController.text.isNotEmpty
                                      ? _fullNameController.text
                                      : 'Student Name',
                                  style: const TextStyle(
                                      color: AppColors.textWhite,
                                      fontSize: 18,
                                      fontWeight: FontWeight.bold),
                                ),
                                const SizedBox(height: 8),
                                Text(
                                  "${_studentIdController.text} ‚Ä¢ $_selectedGrade",
                                  style: const TextStyle(
                                      color: AppColors.textGrey),
                                ),
                                const SizedBox(height: 24),
                                const Divider(color: AppColors.divider),
                                const SizedBox(height: 24),
                                _buildSummaryRow(
                                    "Status",
                                    _isActive ? "Active" : "Inactive",
                                    _isActive
                                        ? AppColors.successGreen
                                        : AppColors.errorRed),
                                const SizedBox(height: 12),
                                _buildSummaryRow(
                                    "Billing",
                                    _selectedBillingType.toUpperCase(),
                                    AppColors.textWhite),
                              ],
                            ),
                          ),
                          const Spacer(),
                          Container(
                            padding: const EdgeInsets.all(16),
                            decoration: BoxDecoration(
                              color:
                                  AppColors.primaryBlue.withValues(alpha: 0.1),
                              borderRadius: BorderRadius.circular(8),
                              border: Border.all(
                                  color: AppColors.primaryBlue
                                      .withValues(alpha: 0.3)),
                            ),
                            child: const Row(
                              children: [
                                Icon(Icons.info_outline,
                                    color: AppColors.primaryBlue),
                                SizedBox(width: 12),
                                Expanded(
                                  child: Text(
                                    "Student ID is read-only. Contact admin for changes.",
                                    style: TextStyle(
                                        color: AppColors.textWhite70,
                                        fontSize: 12),
                                  ),
                                ),
                              ],
                            ),
                          ),
                        ],
                      ),
                    ),
                  ),
                ],
              ),
            ),

            const Divider(height: 1, color: AppColors.divider),

            // Footer
            Padding(
              padding: const EdgeInsets.symmetric(horizontal: 32, vertical: 24),
              child: Row(
                mainAxisAlignment: MainAxisAlignment.end,
                children: [
                  TextButton(
                    onPressed: () => Navigator.of(context).pop(),
                    child: const Text(
                      "Cancel",
                      style: TextStyle(color: AppColors.textWhite70),
                    ),
                  ),
                  const SizedBox(width: 16),
                  ElevatedButton.icon(
                    onPressed: _isLoading ? null : _saveChanges,
                    style: ElevatedButton.styleFrom(
                      backgroundColor: AppColors.primaryBlue,
                      padding: const EdgeInsets.symmetric(
                        horizontal: 24,
                        vertical: 16,
                      ),
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(8),
                      ),
                      foregroundColor: AppColors.textWhite,
                    ),
                    icon: _isLoading
                        ? const SizedBox(
                            width: 16,
                            height: 16,
                            child: CircularProgressIndicator(
                              strokeWidth: 2,
                              color: AppColors.textWhite,
                            ),
                          )
                        : const Icon(Icons.check, size: 18),
                    label: Text(
                      _isLoading ? "Saving..." : "Save Changes",
                      style: const TextStyle(fontWeight: FontWeight.bold),
                    ),
                  ),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }

  // --- WIDGET HELPERS ---

  Widget _buildLabel(String text, Color color) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 8.0),
      child: Text(text,
          style: TextStyle(
              color: color.withValues(alpha: 0.9),
              fontSize: 14,
              fontWeight: FontWeight.w500)),
    );
  }

  Widget _buildSummaryRow(String label, String value, Color valueColor) {
    return Row(
      mainAxisAlignment: MainAxisAlignment.spaceBetween,
      children: [
        Text(label, style: const TextStyle(color: AppColors.textGrey)),
        Text(value,
            style: TextStyle(color: valueColor, fontWeight: FontWeight.bold)),
      ],
    );
  }

  Widget _buildTextField({
    required TextEditingController controller,
    required String hint,
    String? prefix,
    IconData? prefixIcon,
    IconData? suffixIcon,
    VoidCallback? onSuffixTap,
    bool isNumber = false,
    bool readOnly = false,
    int maxLines = 1,
  }) {
    return TextFormField(
      controller: controller,
      readOnly: readOnly,
      maxLines: maxLines,
      keyboardType: isNumber
          ? const TextInputType.numberWithOptions(decimal: true)
          : TextInputType.text,
      validator: (val) => val == null || val.isEmpty ? 'Required' : null,
      style: const TextStyle(color: AppColors.textWhite),
      decoration: InputDecoration(
        filled: true,
        fillColor: AppColors.surfaceGrey,
        hintText: hint,
        hintStyle: TextStyle(color: AppColors.textWhite.withValues(alpha: 0.3)),
        prefixText: prefix,
        prefixStyle: const TextStyle(
            color: AppColors.textWhite, fontWeight: FontWeight.bold),
        prefixIcon: prefixIcon != null
            ? Icon(prefixIcon, color: AppColors.textWhite54, size: 20)
            : null,
        suffixIcon: suffixIcon != null
            ? GestureDetector(
                onTap: onSuffixTap,
                child: Icon(suffixIcon, color: AppColors.textWhite54, size: 20))
            : null,
        border: OutlineInputBorder(
            borderRadius: BorderRadius.circular(8),
            borderSide: const BorderSide(color: AppColors.surfaceLightGrey)),
        enabledBorder: OutlineInputBorder(
            borderRadius: BorderRadius.circular(8),
            borderSide: const BorderSide(color: AppColors.surfaceLightGrey)),
        focusedBorder: OutlineInputBorder(
            borderRadius: BorderRadius.circular(8),
            borderSide:
                const BorderSide(color: AppColors.primaryBlue, width: 2)),
        contentPadding:
            const EdgeInsets.symmetric(horizontal: 16, vertical: 16),
      ),
    );
  }

  Widget _buildDropdown({
    required String value,
    required List<String> items,
    required Function(String?) onChanged,
  }) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 16),
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(8),
        border: Border.all(color: AppColors.surfaceLightGrey),
      ),
      child: DropdownButtonHideUnderline(
        child: DropdownButton<String>(
          value: value,
          dropdownColor: AppColors.surfaceGrey,
          icon: const Icon(Icons.keyboard_arrow_down,
              color: AppColors.textWhite54),
          isExpanded: true,
          style: const TextStyle(color: AppColors.textWhite),
          items: items
              .map((e) => DropdownMenuItem(value: e, child: Text(e)))
              .toList(),
          onChanged: onChanged,
        ),
      ),
    );
  }

  Widget _buildDatePicker(
      BuildContext context, DateTime initial, Function(DateTime) onPicked) {
    return GestureDetector(
      onTap: () async {
        final picked = await showDatePicker(
          context: context,
          initialDate: initial,
          firstDate: DateTime(1990),
          lastDate: DateTime(2030),
          builder: (context, child) => Theme(
            data: ThemeData.dark().copyWith(
              colorScheme: const ColorScheme.dark(
                  primary: AppColors.primaryBlue,
                  onPrimary: AppColors.textWhite,
                  surface: AppColors.surfaceGrey),
            ),
            child: child!,
          ),
        );
        if (picked != null) onPicked(picked);
      },
      child: Container(
        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 14),
        decoration: BoxDecoration(
          color: AppColors.surfaceGrey,
          borderRadius: BorderRadius.circular(8),
          border: Border.all(color: AppColors.surfaceLightGrey),
        ),
        child: Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            Text(DateFormat('MMM dd, yyyy').format(initial),
                style: const TextStyle(color: AppColors.textWhite)),
            const Icon(Icons.calendar_today_outlined,
                size: 18, color: AppColors.textWhite54),
          ],
        ),
      ),
    );
  }

  Widget _buildCheckbox({
    required String label,
    required bool value,
    required Function(bool?) onChanged,
  }) {
    return CheckboxListTile(
      value: value,
      onChanged: onChanged,
      title: Text(
        label,
        style: const TextStyle(color: AppColors.textWhite),
      ),
      fillColor: WidgetStateProperty.resolveWith(
        (states) => states.contains(WidgetState.selected)
            ? AppColors.primaryBlue
            : Colors.transparent,
      ),
      side: const BorderSide(color: AppColors.divider),
      contentPadding: EdgeInsets.zero,
    );
  }
}

// ==========================================
// FILE: ./reports/reports_header.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../../core/constants/app_colors.dart';
import '../../../../data/providers/dashboard_provider.dart';
import '../../../../data/services/database_service.dart';

class ReportsHeader extends ConsumerWidget {
  const ReportsHeader({super.key});

  String _getInitials(String name) {
    if (name.isEmpty) return "U";
    final parts = name.trim().split(' ');
    if (parts.length > 1) {
      return "${parts[0][0]}${parts[1][0]}".toUpperCase();
    }
    return name[0].toUpperCase();
  }

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final dashboardAsync = ref.watch(dashboardDataProvider);
    final bool isConnected = DatabaseService().db.currentStatus.connected;

    return Container(
      height: 70,
      padding: const EdgeInsets.symmetric(horizontal: 24),
      color: AppColors.backgroundBlack,
      child: Row(
        children: [
          const Icon(Icons.analytics, color: AppColors.primaryBlue, size: 28),
          const SizedBox(width: 12),
          const Text(
            "Reports Center",
            style: TextStyle(
              color: AppColors.textWhite,
              fontSize: 20,
              fontWeight: FontWeight.bold,
              letterSpacing: 0.5,
            ),
          ),

          const Spacer(),

          // Search Bar
          SizedBox(
            width: 300,
            height: 40,
            child: TextField(
              textAlignVertical: TextAlignVertical.center,
              style: const TextStyle(color: AppColors.textWhite, fontSize: 13),
              decoration: InputDecoration(
                isDense: true,
                filled: true,
                fillColor: AppColors.surfaceGrey,
                hintText: "Search saved reports...",
                hintStyle: const TextStyle(color: AppColors.textWhite38),
                prefixIcon: const Icon(Icons.search,
                    size: 18, color: AppColors.textWhite54),
                contentPadding: EdgeInsets.zero,
                enabledBorder: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(8),
                  borderSide: const BorderSide(color: AppColors.divider),
                ),
                focusedBorder: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(8),
                  borderSide: const BorderSide(color: AppColors.primaryBlue),
                ),
                border: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(8),
                  borderSide: const BorderSide(color: AppColors.divider),
                ),
              ),
            ),
          ),
          const SizedBox(width: 24),

          IconButton(
            onPressed: () {
              ScaffoldMessenger.of(context).showSnackBar(
                const SnackBar(
                  content: Text('Notifications panel coming soon'),
                  backgroundColor: AppColors.primaryBlue,
                  duration: Duration(seconds: 2),
                ),
              );
            },
            icon: const Icon(Icons.notifications_none,
                color: AppColors.textWhite70),
          ),
          const SizedBox(width: 16),

          // Profile & Connectivity
          dashboardAsync.when(
            loading: () => const CircleAvatar(
                backgroundColor: AppColors.surfaceGrey, radius: 16),
            error: (_, __) => Icon(
                isConnected ? Icons.error_outline : Icons.wifi_off,
                color: AppColors.errorRed),
            data: (data) {
              final initials = _getInitials(data.userName);
              String subtitle = data.schoolName;
              if (data.schoolName == 'Loading...') {
                subtitle = isConnected ? "Syncing Data..." : "Offline Mode";
              }

              return Row(
                children: [
                  Column(
                    mainAxisAlignment: MainAxisAlignment.center,
                    crossAxisAlignment: CrossAxisAlignment.end,
                    children: [
                      Text(data.userName.isEmpty ? "User" : data.userName,
                          style: const TextStyle(
                              color: AppColors.textWhite,
                              fontWeight: FontWeight.bold,
                              fontSize: 13)),
                      Text(subtitle,
                          style: TextStyle(
                              color: (subtitle == "Offline Mode")
                                  ? AppColors.warningOrange
                                  : AppColors.textWhite38,
                              fontSize: 11)),
                    ],
                  ),
                  const SizedBox(width: 12),
                  CircleAvatar(
                    backgroundColor:
                        AppColors.primaryBlue.withValues(alpha: 0.2),
                    child: Text(initials,
                        style: const TextStyle(
                            color: AppColors.primaryBlue,
                            fontWeight: FontWeight.bold,
                            fontSize: 12)),
                  ),
                ],
              );
            },
          ),
        ],
      ),
    );
  }
}

// ==========================================
// FILE: ./reports/report_card.dart
// ==========================================

import 'package:flutter/material.dart';
import '../../../../core/constants/app_colors.dart';

class ReportCard extends StatelessWidget {
  final String title;
  final String desc;
  final IconData icon;
  final Color color;
  final List<String> tags;
  final bool isPopular;
  final VoidCallback onTap;

  const ReportCard({
    super.key,
    required this.title,
    required this.desc,
    required this.icon,
    required this.color,
    required this.tags,
    required this.onTap,
    this.isPopular = false,
  });

  @override
  Widget build(BuildContext context) {
    return InkWell(
      onTap: onTap,
      borderRadius: BorderRadius.circular(16),
      hoverColor: AppColors.textWhite.withValues(alpha: 0.02),
      child: Container(
        padding: const EdgeInsets.all(24),
        decoration: BoxDecoration(
          color: AppColors.surfaceGrey,
          borderRadius: BorderRadius.circular(16),
          border: Border.all(
            color: isPopular ? AppColors.primaryBlue.withValues(alpha: 0.5) : AppColors.divider,
            width: isPopular ? 1.5 : 1
          ),
        ),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                Container(
                  padding: const EdgeInsets.all(10),
                  decoration: BoxDecoration(
                    color: color.withValues(alpha: 0.15),
                    borderRadius: BorderRadius.circular(8),
                  ),
                  child: Icon(icon, color: color, size: 20),
                ),
                if (isPopular)
                  Container(
                    padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                    decoration: BoxDecoration(
                      color: AppColors.primaryBlue,
                      borderRadius: BorderRadius.circular(20),
                    ),
                    child: const Text("Most Popular", style: TextStyle(color: Colors.white, fontSize: 10, fontWeight: FontWeight.bold)),
                  ),
              ],
            ),
            const SizedBox(height: 16),
            Text(title, style: const TextStyle(color: AppColors.textWhite, fontSize: 16, fontWeight: FontWeight.bold)),
            const SizedBox(height: 8),
            Text(desc, style: const TextStyle(color: AppColors.textWhite54, fontSize: 12, height: 1.5), maxLines: 3, overflow: TextOverflow.ellipsis),
            const Spacer(),
            const Divider(color: AppColors.divider),
            const SizedBox(height: 8),
            Row(
              children: [
                ...tags.map((t) => Padding(
                  padding: const EdgeInsets.only(right: 8.0),
                  child: Text(t, style: const TextStyle(color: AppColors.textWhite38, fontSize: 10, fontWeight: FontWeight.w500)),
                )),
                const Spacer(),
                const Icon(Icons.arrow_forward, color: AppColors.textWhite38, size: 16),
              ],
            )
          ],
        ),
      ),
    );
  }
}
// ==========================================
// FILE: ./reports/report_preview_dialog.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:intl/intl.dart';
import '../../../../core/constants/app_colors.dart';
import '../../../../data/providers/financial_reports_provider.dart';
import '../../../../data/providers/report_builder_provider.dart';

/// Report Preview Dialog - Shows report data preview
/// Complies with Law of Fragments: Separate dialog logic
void showReportPreviewDialog(
  BuildContext context,
  WidgetRef ref,
  String schoolId,
  ReportBuilderState reportState,
) {
  showDialog(
    context: context,
    builder: (context) => Dialog(
      backgroundColor: Colors.transparent,
      child: Container(
        width: 800,
        height: 600,
        decoration: BoxDecoration(
          color: AppColors.backgroundBlack,
          borderRadius: BorderRadius.circular(16),
          border: Border.all(color: AppColors.surfaceLightGrey),
        ),
        child: Column(
          children: [
            _buildHeader(context),
            const Divider(height: 1, color: AppColors.divider),
            Expanded(
              child: _buildContent(ref, schoolId, reportState),
            ),
            _buildFooter(context),
          ],
        ),
      ),
    ),
  );
}

Widget _buildHeader(BuildContext context) {
  return Padding(
    padding: const EdgeInsets.all(24),
    child: Row(
      children: [
        const Icon(Icons.preview, color: AppColors.primaryBlue),
        const SizedBox(width: 16),
        const Text(
          'Report Preview',
          style: TextStyle(
            color: AppColors.textWhite,
            fontSize: 20,
            fontWeight: FontWeight.bold,
          ),
        ),
        const Spacer(),
        IconButton(
          onPressed: () => Navigator.pop(context),
          icon: const Icon(Icons.close, color: AppColors.textGrey),
        ),
      ],
    ),
  );
}

Widget _buildContent(
  WidgetRef ref,
  String schoolId,
  ReportBuilderState reportState,
) {
  return Consumer(
    builder: (context, ref, child) {
      final invoiceStatsAsync = ref.watch(invoiceStatsProvider(
        InvoiceStatsParams(
          schoolId: schoolId,
          startDate: reportState.dateRange.start,
          endDate: reportState.dateRange.end,
        ),
      ));

      return invoiceStatsAsync.when(
        data: (stats) => SingleChildScrollView(
          padding: const EdgeInsets.all(32),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              _buildPreviewSection(
                'Invoice Statistics',
                [
                  _buildPreviewRow(
                    'Total Invoices',
                    stats['total_invoices'].toString(),
                  ),
                  _buildPreviewRow(
                    'Paid Invoices',
                    stats['paid_count'].toString(),
                  ),
                  _buildPreviewRow(
                    'Pending Invoices',
                    stats['sent_count'].toString(),
                  ),
                  _buildPreviewRow(
                    'Total Billed',
                    '\$${NumberFormat('#,##0.00').format(stats['total_billed'])}',
                  ),
                  _buildPreviewRow(
                    'Total Collected',
                    '\$${NumberFormat('#,##0.00').format(stats['total_collected'])}',
                  ),
                  _buildPreviewRow(
                    'Collection Rate',
                    '${stats['collection_rate']}%',
                  ),
                ],
              ),
            ],
          ),
        ),
        loading: () => const Center(
          child: CircularProgressIndicator(color: AppColors.primaryBlue),
        ),
        error: (err, stack) => Center(
          child: Text(
            'Error loading preview: $err',
            style: const TextStyle(color: AppColors.errorRed),
          ),
        ),
      );
    },
  );
}

Widget _buildFooter(BuildContext context) {
  return Container(
    padding: const EdgeInsets.all(24),
    decoration: const BoxDecoration(
      border: Border(top: BorderSide(color: AppColors.divider)),
    ),
    child: Row(
      mainAxisAlignment: MainAxisAlignment.end,
      children: [
        TextButton(
          onPressed: () => Navigator.pop(context),
          child: const Text('Close'),
        ),
      ],
    ),
  );
}

Widget _buildPreviewSection(String title, List<Widget> rows) {
  return Column(
    crossAxisAlignment: CrossAxisAlignment.start,
    children: [
      Text(
        title,
        style: const TextStyle(
          color: AppColors.textWhite,
          fontSize: 18,
          fontWeight: FontWeight.bold,
        ),
      ),
      const SizedBox(height: 16),
      Container(
        decoration: BoxDecoration(
          color: AppColors.surfaceGrey,
          borderRadius: BorderRadius.circular(8),
          border: Border.all(color: AppColors.divider),
        ),
        child: Column(children: rows),
      ),
    ],
  );
}

Widget _buildPreviewRow(String label, String value) {
  return Container(
    padding: const EdgeInsets.all(16),
    decoration: const BoxDecoration(
      border: Border(bottom: BorderSide(color: AppColors.divider)),
    ),
    child: Row(
      mainAxisAlignment: MainAxisAlignment.spaceBetween,
      children: [
        Text(
          label,
          style: const TextStyle(color: AppColors.textWhite70),
        ),
        Text(
          value,
          style: const TextStyle(
            color: AppColors.textWhite,
            fontWeight: FontWeight.bold,
          ),
        ),
      ],
    ),
  );
}

// ==========================================
// FILE: ./reports/custom_report_builder.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:intl/intl.dart';
import '../../../../core/constants/app_colors.dart';
import '../../../../data/providers/report_builder_provider.dart';
import 'report_preview_dialog.dart';

/// Custom Report Builder Fragment - Form for building custom reports
/// Complies with Law of Fragments: Self-contained report builder logic
class CustomReportBuilderWidget extends ConsumerWidget {
  final String schoolId;

  const CustomReportBuilderWidget({
    super.key,
    required this.schoolId,
  });

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final reportState = ref.watch(reportBuilderProvider);
    final notifier = ref.read(reportBuilderProvider.notifier);
    final summary = ref.watch(reportSummaryProvider);

    return Container(
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: AppColors.divider),
      ),
      child: Column(
        children: [
          const _BuilderHeader(),
          const Divider(height: 1, color: AppColors.divider),
          Padding(
            padding: const EdgeInsets.all(32),
            child: Row(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Expanded(
                  flex: 3,
                  child: _ReportFormSection(
                    reportState: reportState,
                    notifier: notifier,
                  ),
                ),
                const SizedBox(width: 48),
                Expanded(
                  flex: 2,
                  child: _ReportSummaryPanel(
                    summary: summary,
                    reportState: reportState,
                    schoolId: schoolId,
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }
}

/// Builder Header Widget
class _BuilderHeader extends StatelessWidget {
  const _BuilderHeader();

  @override
  Widget build(BuildContext context) {
    return const Padding(
      padding: EdgeInsets.all(24),
      child: Row(
        children: [
          Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text(
                "Custom Report Builder",
                style: TextStyle(
                  color: AppColors.textWhite,
                  fontSize: 18,
                  fontWeight: FontWeight.bold,
                ),
              ),
              SizedBox(height: 4),
              Text(
                "Configure specific data points to generate a one-time report.",
                style: TextStyle(color: AppColors.textWhite54),
              ),
            ],
          ),
        ],
      ),
    );
  }
}

/// Report Form Section Widget
class _ReportFormSection extends StatelessWidget {
  final ReportBuilderState reportState;
  final ReportBuilderNotifier notifier;

  const _ReportFormSection({
    required this.reportState,
    required this.notifier,
  });

  @override
  Widget build(BuildContext context) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        _buildLabel("Report Category"),
        _buildDropdown(
          value: reportState.category,
          items: [
            "Tuition & Fee Collection",
            "Expense Analysis",
            "Student Attendance",
            "Payroll Summary",
          ],
          onChanged: (v) => notifier.setCategory(v!),
        ),
        const SizedBox(height: 24),
        Row(
          children: [
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  _buildLabel("Date Range"),
                  _buildDateRangePicker(
                    context,
                    reportState.dateRange,
                    (range) => notifier.setDateRange(range),
                  ),
                ],
              ),
            ),
            const SizedBox(width: 24),
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  _buildLabel("Grade Level / Department"),
                  _buildDropdown(
                    value: reportState.gradeFilter,
                    items: [
                      "All Grades",
                      "Grade 1",
                      "Grade 2",
                      "Grade 3",
                      "Grade 4",
                      "Grade 5",
                    ],
                    onChanged: (v) => notifier.setGradeFilter(v!),
                  ),
                ],
              ),
            ),
          ],
        ),
        const SizedBox(height: 24),
        _buildLabel("Export Format"),
        Row(
          children: [
            _buildRadioTile(
              "PDF Document",
              "Best for printing",
              reportState.exportFormat == 'PDF',
              () => notifier.setExportFormat('PDF'),
            ),
            const SizedBox(width: 16),
            _buildRadioTile(
              "Excel / CSV",
              "Best for analysis",
              reportState.exportFormat == 'Excel/CSV',
              () => notifier.setExportFormat('Excel/CSV'),
            ),
          ],
        ),
      ],
    );
  }

  Widget _buildLabel(String text) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 8.0),
      child: Text(
        text,
        style: const TextStyle(color: AppColors.textWhite70, fontSize: 13),
      ),
    );
  }

  Widget _buildDropdown({
    required String value,
    required List<String> items,
    required Function(String?) onChanged,
  }) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 16),
      decoration: BoxDecoration(
        color: AppColors.backgroundBlack,
        borderRadius: BorderRadius.circular(8),
        border: Border.all(color: AppColors.divider),
      ),
      child: DropdownButtonHideUnderline(
        child: DropdownButton<String>(
          value: items.contains(value) ? value : items.first,
          isExpanded: true,
          dropdownColor: AppColors.surfaceGrey,
          icon: const Icon(
            Icons.keyboard_arrow_down,
            color: AppColors.textWhite54,
          ),
          style: const TextStyle(color: AppColors.textWhite),
          items: items
              .map((e) => DropdownMenuItem(value: e, child: Text(e)))
              .toList(),
          onChanged: onChanged,
        ),
      ),
    );
  }

  Widget _buildDateRangePicker(
    BuildContext context,
    DateTimeRange current,
    Function(DateTimeRange) onSelect,
  ) {
    return InkWell(
      onTap: () async {
        final picked = await showDateRangePicker(
          context: context,
          firstDate: DateTime(2020),
          lastDate: DateTime.now(),
          initialDateRange: current,
          builder: (context, child) => Theme(
            data: ThemeData.dark().copyWith(
              colorScheme: const ColorScheme.dark(
                primary: AppColors.primaryBlue,
                onPrimary: Colors.white,
                surface: AppColors.surfaceGrey,
                onSurface: AppColors.textWhite,
              ),
            ),
            child: child!,
          ),
        );
        if (picked != null) onSelect(picked);
      },
      child: Container(
        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 14),
        decoration: BoxDecoration(
          color: AppColors.backgroundBlack,
          borderRadius: BorderRadius.circular(8),
          border: Border.all(color: AppColors.divider),
        ),
        child: Row(
          children: [
            const Icon(
              Icons.calendar_today,
              size: 16,
              color: AppColors.textWhite54,
            ),
            const SizedBox(width: 12),
            Text(
              "${DateFormat('MMM d, yyyy').format(current.start)} - ${DateFormat('MMM d, yyyy').format(current.end)}",
              style: const TextStyle(color: AppColors.textWhite),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildRadioTile(
    String title,
    String sub,
    bool selected,
    VoidCallback onTap,
  ) {
    return Expanded(
      child: InkWell(
        onTap: onTap,
        borderRadius: BorderRadius.circular(8),
        child: Container(
          padding: const EdgeInsets.all(16),
          decoration: BoxDecoration(
            color: selected
                ? AppColors.primaryBlue.withValues(alpha: 0.1)
                : AppColors.backgroundBlack,
            borderRadius: BorderRadius.circular(8),
            border: Border.all(
              color: selected ? AppColors.primaryBlue : AppColors.divider,
            ),
          ),
          child: Row(
            children: [
              Icon(
                selected
                    ? Icons.radio_button_checked
                    : Icons.radio_button_unchecked,
                color: selected ? AppColors.primaryBlue : AppColors.textWhite54,
                size: 20,
              ),
              const SizedBox(width: 12),
              Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    title,
                    style: TextStyle(
                      color: selected
                          ? AppColors.primaryBlue
                          : AppColors.textWhite,
                      fontWeight: FontWeight.bold,
                      fontSize: 13,
                    ),
                  ),
                  Text(
                    sub,
                    style: const TextStyle(
                      color: AppColors.textWhite38,
                      fontSize: 11,
                    ),
                  ),
                ],
              ),
            ],
          ),
        ),
      ),
    );
  }
}

/// Report Summary Panel Widget
class _ReportSummaryPanel extends ConsumerWidget {
  final Map<String, String> summary;
  final ReportBuilderState reportState;
  final String schoolId;

  const _ReportSummaryPanel({
    required this.summary,
    required this.reportState,
    required this.schoolId,
  });

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    return Container(
      padding: const EdgeInsets.all(24),
      decoration: BoxDecoration(
        color: AppColors.backgroundBlack,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: AppColors.divider),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          const Text(
            "SUMMARY",
            style: TextStyle(
              color: AppColors.textWhite,
              fontWeight: FontWeight.bold,
              letterSpacing: 1.2,
              fontSize: 12,
            ),
          ),
          const SizedBox(height: 24),
          _buildSummaryRow("Type:", summary['Type']!),
          _buildSummaryRow("Period:", summary['Period']!),
          _buildSummaryRow("Scope:", summary['Scope']!),
          _buildSummaryRow("Format:", summary['Format']!),
          const SizedBox(height: 32),
          SizedBox(
            width: double.infinity,
            child: ElevatedButton(
              onPressed: () => _generateReport(context, ref, reportState),
              style: ElevatedButton.styleFrom(
                backgroundColor: AppColors.primaryBlue,
                padding: const EdgeInsets.symmetric(vertical: 18),
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(8),
                ),
              ),
              child: const Text(
                "Generate Report",
                style: TextStyle(
                  color: Colors.white,
                  fontWeight: FontWeight.bold,
                ),
              ),
            ),
          ),
          const SizedBox(height: 12),
          SizedBox(
            width: double.infinity,
            child: OutlinedButton.icon(
              onPressed: () => showReportPreviewDialog(
                context,
                ref,
                schoolId,
                reportState,
              ),
              icon: const Icon(Icons.preview, size: 16),
              label: const Text("Preview Data"),
              style: OutlinedButton.styleFrom(
                foregroundColor: AppColors.textWhite,
                side: const BorderSide(color: AppColors.divider),
                padding: const EdgeInsets.symmetric(vertical: 18),
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(8),
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildSummaryRow(String label, String value) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 16.0),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          Text(
            label,
            style: const TextStyle(color: AppColors.textWhite54, fontSize: 13),
          ),
          Text(
            value,
            style: const TextStyle(
              color: AppColors.textWhite,
              fontWeight: FontWeight.w600,
              fontSize: 13,
              letterSpacing: 0.5,
            ),
            textAlign: TextAlign.end,
          ),
        ],
      ),
    );
  }

  void _generateReport(
    BuildContext context,
    WidgetRef ref,
    ReportBuilderState reportState,
  ) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text('${reportState.category} export is coming soon'),
        backgroundColor: AppColors.primaryBlue,
      ),
    );
  }
}

// ==========================================
// FILE: ./reports/financial_summary_cards.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:intl/intl.dart';
import '../../../../core/constants/app_colors.dart';
import '../../../../data/providers/financial_reports_provider.dart';

/// Financial Summary Cards Fragment - Displays invoice and transaction stats
/// Complies with Law of Fragments: Encapsulated financial data cards
class FinancialSummaryCards extends ConsumerWidget {
  final String schoolId;
  final VoidCallback? onInvoiceCardTap;
  final VoidCallback? onTransactionCardTap;
  final VoidCallback? onGenerateReport;

  const FinancialSummaryCards({
    super.key,
    required this.schoolId,
    this.onInvoiceCardTap,
    this.onTransactionCardTap,
    this.onGenerateReport,
  });

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final invoiceStatsAsync = ref.watch(invoiceStatsProvider(
      InvoiceStatsParams(schoolId: schoolId),
    ));
    final transactionSummaryAsync = ref.watch(transactionSummaryProvider(
      TransactionSummaryParams(schoolId: schoolId),
    ));

    return SizedBox(
      height: 220,
      child: Row(
        children: [
          Expanded(
            child: invoiceStatsAsync.when(
              data: (stats) => _InvoiceStatsCard(
                stats: stats,
                onTap: onInvoiceCardTap,
              ),
              loading: () => _buildLoadingCard(0),
              error: (err, _) => _buildErrorCard(
                'Failed to load invoice stats: $err',
                ref,
                schoolId,
              ),
            ),
          ),
          const SizedBox(width: 16),
          Expanded(
            child: transactionSummaryAsync.when(
              data: (summary) => _TransactionSummaryCard(
                summary: summary,
                onTap: onTransactionCardTap,
              ),
              loading: () => _buildLoadingCard(1),
              error: (err, _) => _buildErrorCard(
                'Failed to load transactions: $err',
                ref,
                schoolId,
              ),
            ),
          ),
          const SizedBox(width: 16),
          Expanded(
            child: _QuickActionCard(onGenerateReport: onGenerateReport),
          ),
        ],
      ),
    );
  }

  Widget _buildLoadingCard(int index) {
    return Container(
      margin: EdgeInsets.only(right: index < 2 ? 16 : 0),
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: AppColors.divider),
      ),
      child: const Center(
        child: CircularProgressIndicator(
          color: AppColors.primaryBlue,
          strokeWidth: 2,
        ),
      ),
    );
  }

  Widget _buildErrorCard(String error, WidgetRef ref, String schoolId) {
    return Container(
      decoration: BoxDecoration(
        color: AppColors.errorRed.withValues(alpha: 0.1),
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: AppColors.errorRed.withValues(alpha: 0.3)),
      ),
      child: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            const Icon(Icons.error_outline,
                color: AppColors.errorRed, size: 32),
            const SizedBox(height: 8),
            const Text(
              'Failed to load',
              style: TextStyle(
                color: AppColors.textWhite,
                fontSize: 13,
                fontWeight: FontWeight.bold,
              ),
            ),
            const SizedBox(height: 8),
            ElevatedButton(
              onPressed: () {
                ref.invalidate(invoiceStatsProvider(
                  InvoiceStatsParams(schoolId: schoolId),
                ));
                ref.invalidate(transactionSummaryProvider(
                  TransactionSummaryParams(schoolId: schoolId),
                ));
              },
              style: ElevatedButton.styleFrom(
                backgroundColor: AppColors.primaryBlue,
                padding:
                    const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
              ),
              child: const Text('Retry', style: TextStyle(fontSize: 11)),
            ),
          ],
        ),
      ),
    );
  }
}

/// Invoice Stats Card Widget
class _InvoiceStatsCard extends StatelessWidget {
  final Map<String, dynamic> stats;
  final VoidCallback? onTap;

  const _InvoiceStatsCard({required this.stats, this.onTap});

  @override
  Widget build(BuildContext context) {
    return InkWell(
      onTap: onTap,
      borderRadius: BorderRadius.circular(12),
      child: Container(
        padding: const EdgeInsets.all(20),
        decoration: BoxDecoration(
          color: AppColors.surfaceGrey,
          borderRadius: BorderRadius.circular(12),
          border: Border.all(color: AppColors.divider),
        ),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                const Text(
                  'Invoice Statistics',
                  style: TextStyle(
                    color: AppColors.textWhite,
                    fontSize: 14,
                    fontWeight: FontWeight.bold,
                  ),
                ),
                Container(
                  padding: const EdgeInsets.all(8),
                  decoration: BoxDecoration(
                    color: AppColors.primaryBlueBg,
                    borderRadius: BorderRadius.circular(8),
                  ),
                  child: const Icon(
                    Icons.receipt_long,
                    color: AppColors.primaryBlue,
                    size: 20,
                  ),
                ),
              ],
            ),
            const SizedBox(height: 20),
            Text(
              '\$${NumberFormat('#,##0.00').format(stats['total_billed'] ?? 0)}',
              style: const TextStyle(
                color: AppColors.textWhite,
                fontSize: 28,
                fontWeight: FontWeight.bold,
              ),
            ),
            const SizedBox(height: 4),
            Text(
              'Total Billed (${stats['total_invoices'] ?? 0} invoices)',
              style:
                  const TextStyle(color: AppColors.textWhite54, fontSize: 12),
            ),
            const SizedBox(height: 16),
            Row(
              children: [
                _buildMiniStat('Collected',
                    '\$${NumberFormat('#,##0').format(stats['total_collected'] ?? 0)}'),
                const Spacer(),
                _buildMiniStat('Rate', '${stats['collection_rate'] ?? 0}%'),
              ],
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildMiniStat(String label, String value) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          label,
          style: const TextStyle(color: AppColors.textWhite38, fontSize: 10),
        ),
        const SizedBox(height: 2),
        Text(
          value,
          style: const TextStyle(
            color: AppColors.primaryBlue,
            fontWeight: FontWeight.bold,
            fontSize: 13,
          ),
        ),
      ],
    );
  }
}

/// Transaction Summary Card Widget
class _TransactionSummaryCard extends StatelessWidget {
  final Map<String, dynamic> summary;
  final VoidCallback? onTap;

  const _TransactionSummaryCard({required this.summary, this.onTap});

  @override
  Widget build(BuildContext context) {
    return InkWell(
      onTap: onTap,
      borderRadius: BorderRadius.circular(12),
      child: Container(
        padding: const EdgeInsets.all(20),
        decoration: BoxDecoration(
          color: AppColors.surfaceGrey,
          borderRadius: BorderRadius.circular(12),
          border: Border.all(color: AppColors.divider),
        ),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                const Text(
                  'Transaction Summary',
                  style: TextStyle(
                    color: AppColors.textWhite,
                    fontSize: 14,
                    fontWeight: FontWeight.bold,
                  ),
                ),
                Container(
                  padding: const EdgeInsets.all(8),
                  decoration: BoxDecoration(
                    color: AppColors.successGreen.withValues(alpha: 0.1),
                    borderRadius: BorderRadius.circular(8),
                  ),
                  child: const Icon(
                    Icons.account_balance_wallet,
                    color: AppColors.successGreen,
                    size: 20,
                  ),
                ),
              ],
            ),
            const SizedBox(height: 20),
            Text(
              '${summary['total_count'] ?? 0} Transactions',
              style: const TextStyle(
                color: AppColors.textWhite,
                fontSize: 24,
                fontWeight: FontWeight.bold,
              ),
            ),
            const SizedBox(height: 4),
            const Text(
              'Last 30 days',
              style: TextStyle(color: AppColors.textWhite54, fontSize: 12),
            ),
            const SizedBox(height: 16),
            Row(
              children: [
                _buildMiniStat('Revenue',
                    '\$${NumberFormat('#,##0').format(summary['total_revenue'] ?? 0)}'),
                const Spacer(),
                _buildMiniStat('Expenses',
                    '\$${NumberFormat('#,##0').format(summary['total_expenses'] ?? 0)}'),
              ],
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildMiniStat(String label, String value) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          label,
          style: const TextStyle(color: AppColors.textWhite38, fontSize: 10),
        ),
        const SizedBox(height: 2),
        Text(
          value,
          style: const TextStyle(
            color: AppColors.successGreen,
            fontWeight: FontWeight.bold,
            fontSize: 13,
          ),
        ),
      ],
    );
  }
}

/// Quick Action Card - Generate Report Button
class _QuickActionCard extends StatelessWidget {
  final VoidCallback? onGenerateReport;

  const _QuickActionCard({this.onGenerateReport});

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        gradient: const LinearGradient(
          colors: [AppColors.primaryBlue, AppColors.accentPurple],
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
        ),
        borderRadius: BorderRadius.circular(12),
      ),
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          const Icon(Icons.auto_graph, color: Colors.white, size: 40),
          const SizedBox(height: 16),
          const Text(
            'Quick Export',
            style: TextStyle(
              color: Colors.white,
              fontSize: 16,
              fontWeight: FontWeight.bold,
            ),
          ),
          const SizedBox(height: 8),
          const Text(
            'Generate a comprehensive financial report',
            style: TextStyle(color: Colors.white70, fontSize: 11),
            textAlign: TextAlign.center,
          ),
          const SizedBox(height: 16),
          ElevatedButton(
            onPressed: onGenerateReport,
            style: ElevatedButton.styleFrom(
              backgroundColor: Colors.white,
              foregroundColor: AppColors.primaryBlue,
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(8),
              ),
            ),
            child: const Text('Generate'),
          ),
        ],
      ),
    );
  }
}

// ==========================================
// FILE: ./logout_dialog.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:supabase_flutter/supabase_flutter.dart';
import 'package:go_router/go_router.dart';

class LogoutDialog extends StatefulWidget {
  const LogoutDialog({super.key});

  @override
  State<LogoutDialog> createState() => _LogoutDialogState();
}

class _LogoutDialogState extends State<LogoutDialog> {
  bool _isLoading = false;

  Future<void> _handleLogout() async {
    setState(() => _isLoading = true);
    try {
      // 1. Sign out from Supabase
      await Supabase.instance.client.auth.signOut();
      
      if (mounted) {
        // 2. Close dialog
        Navigator.of(context).pop(); 
        
        // 3. The Router (GoRouter) should detect the auth state change 
        // and redirect to /login automatically. 
        // But for safety, we can explicitly go there if the listener lags.
        context.go('/login');
      }
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text("Logout failed: $e"), backgroundColor: Colors.red),
        );
        setState(() => _isLoading = false);
      }
    }
  }

  @override
  Widget build(BuildContext context) {
    // ignore: unused_local_variable
    const bgColor = Color(0xFF151718);
    const surfaceColor = Color(0xFF1F2227); // Slightly lighter for dialog
    const textWhite = Colors.white;
    const textGrey = Color(0xFF9CA3AF);
    const dangerRed = Color(0xFFEF4444);

    return Dialog(
      backgroundColor: surfaceColor,
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
      child: Container(
        width: 400,
        padding: const EdgeInsets.all(24),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          crossAxisAlignment: CrossAxisAlignment.start, // Align left as per design
          children: [
            Row(
              children: [
                Container(
                  padding: const EdgeInsets.all(10),
                  decoration: BoxDecoration(
                    color: dangerRed.withAlpha(30),
                    shape: BoxShape.circle,
                  ),
                  child: const Icon(Icons.logout, color: dangerRed, size: 24),
                ),
                const SizedBox(width: 16),
                const Text(
                  "Confirm Logout",
                  style: TextStyle(
                    color: textWhite,
                    fontSize: 18,
                    fontWeight: FontWeight.bold,
                  ),
                ),
              ],
            ),
            const SizedBox(height: 16),
            const Text(
              "Are you sure you want to log out of the Financial Portal? Any unsaved changes on the current page will be preserved locally.",
              style: TextStyle(color: textGrey, fontSize: 14, height: 1.5),
            ),
            const SizedBox(height: 32),
            Row(
              mainAxisAlignment: MainAxisAlignment.end,
              children: [
                TextButton(
                  onPressed: () => Navigator.pop(context),
                  child: const Text("Cancel", style: TextStyle(color: textGrey)),
                ),
                const SizedBox(width: 12),
                ElevatedButton(
                  onPressed: _isLoading ? null : _handleLogout,
                  style: ElevatedButton.styleFrom(
                    backgroundColor: dangerRed,
                    foregroundColor: Colors.white,
                    shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
                    padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 12),
                  ),
                  child: _isLoading 
                    ? const SizedBox(width: 16, height: 16, child: CircularProgressIndicator(color: Colors.white, strokeWidth: 2))
                    : const Text("Log Out", style: TextStyle(fontWeight: FontWeight.bold)),
                ),
              ],
            ),
          ],
        ),
      ),
    );
  }
}
// ==========================================
// FILE: ./profile/two_factor_dialog.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import '../../../../core/constants/app_colors.dart';

class EnableTwoFactorDialog extends StatefulWidget {
  const EnableTwoFactorDialog({super.key});

  @override
  State<EnableTwoFactorDialog> createState() => _EnableTwoFactorDialogState();
}

class _EnableTwoFactorDialogState extends State<EnableTwoFactorDialog> {
  final TextEditingController _codeController = TextEditingController();
  final String _manualCode = "J7X9 2K4M P5Q8 R3V1";

  @override
  void dispose() {
    _codeController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Dialog(
      backgroundColor: AppColors.surfaceGrey,
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
      child: Container(
        width: 480, // Fixed width for the dialog
        padding: const EdgeInsets.all(24),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // 1. HEADER
            Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                const Row(
                  children: [
                    Icon(Icons.shield_outlined, color: AppColors.primaryBlue, size: 20),
                    SizedBox(width: 12),
                    Text("Enable 2FA", style: TextStyle(color: AppColors.textWhite, fontSize: 18, fontWeight: FontWeight.bold)),
                  ],
                ),
                IconButton(
                  onPressed: () => Navigator.of(context).pop(),
                  icon: const Icon(Icons.close, color: AppColors.textWhite54),
                  padding: EdgeInsets.zero,
                  constraints: const BoxConstraints(),
                ),
              ],
            ),
            const SizedBox(height: 24),

            // 2. QR CODE SECTION
            const Text(
              "Scan this QR code with your authenticator app (like Google Authenticator or Authy) to generate your verification code.",
              style: TextStyle(color: AppColors.textWhite70, fontSize: 14, height: 1.5),
            ),
            const SizedBox(height: 24),
            Center(
              child: Container(
                width: 160,
                height: 160,
                padding: const EdgeInsets.all(12),
                decoration: BoxDecoration(
                  color: Colors.white,
                  borderRadius: BorderRadius.circular(12),
                ),
                // Replace with your actual QR code image asset or generator
                child: const Center(
                  child: Icon(Icons.qr_code_2, size: 100, color: AppColors.backgroundBlack),
                ),
              ),
            ),
            const SizedBox(height: 24),

            // 3. MANUAL ENTRY SECTION
            const Row(
              children: [
                Expanded(child: Divider(color: AppColors.divider)),
                Padding(
                  padding: EdgeInsets.symmetric(horizontal: 16),
                  child: Text("OR ENTER CODE MANUALLY", style: TextStyle(color: AppColors.textWhite38, fontSize: 12, fontWeight: FontWeight.bold)),
                ),
                Expanded(child: Divider(color: AppColors.divider)),
              ],
            ),
            const SizedBox(height: 24),
            Container(
              padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
              decoration: BoxDecoration(
                color: AppColors.backgroundBlack,
                borderRadius: BorderRadius.circular(8),
                border: Border.all(color: AppColors.divider),
              ),
              child: Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  Text(
                    _manualCode,
                    style: const TextStyle(color: AppColors.primaryBlue, fontSize: 14, fontWeight: FontWeight.bold, letterSpacing: 1.2),
                  ),
                  IconButton(
                    onPressed: () {
                      Clipboard.setData(ClipboardData(text: _manualCode));
                      ScaffoldMessenger.of(context).showSnackBar(
                        const SnackBar(content: Text("Code copied to clipboard")),
                      );
                    },
                    icon: const Icon(Icons.copy, color: AppColors.textWhite54, size: 18),
                    padding: EdgeInsets.zero,
                    constraints: const BoxConstraints(),
                  ),
                ],
              ),
            ),
            const SizedBox(height: 24),

            // 4. VERIFICATION SECTION
            const Text("Enter 6-digit verification code", style: TextStyle(color: AppColors.textWhite70, fontSize: 14)),
            const SizedBox(height: 12),
            TextFormField(
              controller: _codeController,
              style: const TextStyle(color: AppColors.textWhite, letterSpacing: 2),
              keyboardType: TextInputType.number,
              maxLength: 6,
              decoration: InputDecoration(
                filled: true,
                fillColor: AppColors.backgroundBlack,
                hintText: "000 000",
                hintStyle: const TextStyle(color: AppColors.textWhite38),
                prefixIcon: const Icon(Icons.lock_clock_outlined, color: AppColors.textWhite38, size: 18),
                counterText: "", // Hide max length counter
                contentPadding: const EdgeInsets.all(16),
                border: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.divider)),
                enabledBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.divider)),
                focusedBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.primaryBlue)),
              ),
            ),
            const SizedBox(height: 32),

            // 5. ACTIONS
            Row(
              mainAxisAlignment: MainAxisAlignment.end,
              children: [
                TextButton(
                  onPressed: () => Navigator.of(context).pop(),
                  style: TextButton.styleFrom(
                    foregroundColor: AppColors.textWhite70,
                    padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 16),
                  ),
                  child: const Text("Cancel"),
                ),
                const SizedBox(width: 12),
                ElevatedButton(
                  onPressed: () {
                    // TODO: Implement verification logic
                    Navigator.of(context).pop();
                    ScaffoldMessenger.of(context).showSnackBar(
                      const SnackBar(content: Text("2FA Enabled Successfully!")),
                    );
                  },
                  style: ElevatedButton.styleFrom(
                    backgroundColor: AppColors.primaryBlue,
                    foregroundColor: Colors.white,
                    padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 16),
                    shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
                  ),
                  child: const Text("Verify & Enable"),
                ),
              ],
            ),
          ],
        ),
      ),
    );
  }
}
// ==========================================
// FILE: ./profile/activity_log_view.dart
// ==========================================

import 'package:flutter/material.dart';
import '../../../../../core/constants/app_colors.dart';

class ActivityLogView extends StatelessWidget {
  const ActivityLogView({super.key});

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.all(24),
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: AppColors.divider),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              const Text("Recent Activity", style: TextStyle(color: AppColors.textWhite, fontSize: 16, fontWeight: FontWeight.bold)),
              OutlinedButton.icon(
                onPressed: (){}, 
                icon: const Icon(Icons.download, size: 14),
                label: const Text("Export Log", style: TextStyle(fontSize: 12)),
                style: OutlinedButton.styleFrom(
                  foregroundColor: AppColors.textWhite,
                  side: const BorderSide(color: AppColors.divider),
                  padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
                ),
              ),
            ],
          ),
          const SizedBox(height: 8),
          const Text("Audit log of actions performed by your account.", style: TextStyle(color: AppColors.textWhite54, fontSize: 13)),
          const SizedBox(height: 32),

          // Log Items
          _buildLogItem(
            action: "Updated Billing Settings",
            detail: "Changed late fee percentage from 1.2% to 1.5%",
            time: "2 hours ago",
            icon: Icons.edit_note,
            iconColor: AppColors.primaryBlue,
          ),
          _buildTimelineConnector(),
          
          _buildLogItem(
            action: "User Login",
            detail: "Successful login from Chrome on Windows 11 (IP: 192.168.1.42)",
            time: "Today, 09:41 AM",
            icon: Icons.login,
            iconColor: AppColors.successGreen,
          ),
          _buildTimelineConnector(),

          _buildLogItem(
            action: "Exported Data",
            detail: "Downloaded 'Student_List_Oct.csv'",
            time: "Yesterday, 4:20 PM",
            icon: Icons.cloud_download,
            iconColor: Colors.orange,
          ),
          _buildTimelineConnector(),

          _buildLogItem(
            action: "Password Changed",
            detail: "Security update via Profile Settings",
            time: "Oct 28, 2023",
            icon: Icons.lock_reset,
            iconColor: AppColors.textWhite,
          ),
        ],
      ),
    );
  }

  Widget _buildTimelineConnector() {
    return Container(
      width: 1,
      height: 24,
      margin: const EdgeInsets.only(left: 20), // Align with circle center (12 padding + 8 radius)
      color: AppColors.divider,
    );
  }

  Widget _buildLogItem({
    required String action, 
    required String detail, 
    required String time, 
    required IconData icon, 
    required Color iconColor
  }) {
    return Row(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Container(
          padding: const EdgeInsets.all(8),
          decoration: BoxDecoration(
            color: AppColors.backgroundBlack,
            shape: BoxShape.circle,
            border: Border.all(color: AppColors.divider),
          ),
          child: Icon(icon, color: iconColor, size: 16),
        ),
        const SizedBox(width: 16),
        Expanded(
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  Text(action, style: const TextStyle(color: AppColors.textWhite, fontSize: 14, fontWeight: FontWeight.w600)),
                  Text(time, style: const TextStyle(color: AppColors.textWhite38, fontSize: 12)),
                ],
              ),
              const SizedBox(height: 4),
              Text(detail, style: const TextStyle(color: AppColors.textWhite54, fontSize: 13, height: 1.4)),
            ],
          ),
        ),
      ],
    );
  }
}
// ==========================================
// FILE: ./profile/role_permissions_view.dart
// ==========================================

import 'package:flutter/material.dart';
import '../../../../../core/constants/app_colors.dart';

class RolePermissionsView extends StatelessWidget {
  const RolePermissionsView({super.key});

  @override
  Widget build(BuildContext context) {
    return Column(
      children: [
        // --- ROLE HIGHLIGHT CARD ---
        Container(
          width: double.infinity,
          padding: const EdgeInsets.all(32),
          decoration: BoxDecoration(
            // Special gradient for Admin Highlight
            gradient: LinearGradient(
              colors: [
                AppColors.primaryBlue.withValues(alpha: 0.15), 
                AppColors.surfaceGrey
              ],
              begin: Alignment.topLeft,
              end: Alignment.bottomRight,
            ),
            borderRadius: BorderRadius.circular(16),
            border: Border.all(color: AppColors.primaryBlue.withValues(alpha: 0.4)),
          ),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Row(
                children: [
                  Container(
                    padding: const EdgeInsets.all(8),
                    decoration: BoxDecoration(
                      color: AppColors.primaryBlue,
                      shape: BoxShape.circle,
                      boxShadow: [
                        BoxShadow(color: AppColors.primaryBlue.withValues(alpha: 0.4), blurRadius: 12, offset: const Offset(0, 4))
                      ]
                    ),
                    child: const Icon(Icons.verified_user, color: Colors.white, size: 24),
                  ),
                  const SizedBox(width: 16),
                  Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      const Text("Current Role Assignment", style: TextStyle(color: AppColors.textWhite54, fontSize: 12, letterSpacing: 1)),
                      const SizedBox(height: 4),
                      Row(
                        children: [
                          const Text("School Administrator", style: TextStyle(color: AppColors.textWhite, fontSize: 20, fontWeight: FontWeight.bold)),
                          const SizedBox(width: 12),
                          Container(
                            padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 4),
                            decoration: BoxDecoration(
                              color: AppColors.primaryBlue,
                              borderRadius: BorderRadius.circular(20),
                            ),
                            child: const Text("SUPER USER", style: TextStyle(color: Colors.white, fontSize: 10, fontWeight: FontWeight.bold, letterSpacing: 1)),
                          ),
                        ],
                      ),
                    ],
                  ),
                ],
              ),
              const SizedBox(height: 24),
              const Text(
                "You have full access to all modules within this school organization. You can manage users, billing configurations, and academic records.",
                style: TextStyle(color: AppColors.textWhite70, fontSize: 14, height: 1.6),
              ),
            ],
          ),
        ),
        
        const SizedBox(height: 24),

        // --- PERMISSIONS LIST ---
        Container(
          padding: const EdgeInsets.all(24),
          decoration: BoxDecoration(
            color: AppColors.surfaceGrey,
            borderRadius: BorderRadius.circular(16),
            border: Border.all(color: AppColors.divider),
          ),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              const Text("Active Permissions", style: TextStyle(color: AppColors.textWhite, fontSize: 16, fontWeight: FontWeight.bold)),
              const SizedBox(height: 24),
              
              _buildPermItem(
                Icons.account_balance_wallet, 
                "Financial Access", 
                "Full read/write access to invoices, payments, and ledgers."
              ),
              const Divider(color: AppColors.divider, height: 32),
              
              _buildPermItem(
                Icons.people_alt, 
                "User Management", 
                "Can invite teachers, students, and modify roles."
              ),
              const Divider(color: AppColors.divider, height: 32),
              
              _buildPermItem(
                Icons.settings, 
                "System Configuration", 
                "Can modify school year, billing cycles, and global settings."
              ),
            ],
          ),
        ),
      ],
    );
  }

  Widget _buildPermItem(IconData icon, String title, String desc) {
    return Row(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Icon(icon, color: AppColors.textWhite54, size: 22),
        const SizedBox(width: 16),
        Expanded(
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text(title, style: const TextStyle(color: AppColors.textWhite, fontSize: 14, fontWeight: FontWeight.bold)),
              const SizedBox(height: 4),
              Text(desc, style: const TextStyle(color: AppColors.textWhite54, fontSize: 13)),
            ],
          ),
        ),
        const Icon(Icons.check_circle, color: AppColors.successGreen, size: 20),
      ],
    );
  }
}
// ==========================================
// FILE: ./profile/personal_info_form.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../../../core/constants/app_colors.dart';
import '../../../../../data/providers/dashboard_provider.dart';

class PersonalInfoForm extends ConsumerWidget {
  const PersonalInfoForm({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final dashboardAsync = ref.watch(dashboardDataProvider);

    return Container(
      padding: const EdgeInsets.all(24),
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: AppColors.divider),
      ),
      child: dashboardAsync.when(
        data: (data) => _buildFormContent(context, data.userName, data.schoolName),
        loading: () => _buildFormContent(context, "", ""),
        error: (err, _) => Center(
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              const Icon(Icons.error_outline, color: AppColors.warningOrange, size: 48),
              const SizedBox(height: 12),
              Text("Failed to load profile: $err", style: const TextStyle(color: AppColors.textWhite70)),
              const SizedBox(height: 12),
              ElevatedButton.icon(
                onPressed: () => ref.invalidate(dashboardDataProvider),
                icon: const Icon(Icons.refresh, size: 18),
                label: const Text("Retry"),
                style: ElevatedButton.styleFrom(backgroundColor: AppColors.primaryBlue),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildFormContent(BuildContext context, String fullName, String schoolName) {
    // Split name into first/last
    final nameParts = fullName.trim().split(' ');
    final firstName = nameParts.isNotEmpty ? nameParts[0] : "";
    final lastName = nameParts.length > 1 ? nameParts.sublist(1).join(' ') : "";

    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            const Text("Personal Information", style: TextStyle(color: AppColors.textWhite, fontSize: 16, fontWeight: FontWeight.bold)),
            Icon(Icons.badge, color: AppColors.textWhite.withValues(alpha: 0.2), size: 20),
          ],
        ),
        const SizedBox(height: 4),
        const Text("Update your personal details and contact info here.", style: TextStyle(color: AppColors.textWhite54, fontSize: 13)),
        const SizedBox(height: 24),

        Row(
          children: [
            Expanded(child: _buildInput("First Name", firstName.isEmpty ? "Not set" : firstName, Icons.person_outline)),
            const SizedBox(width: 24),
            Expanded(child: _buildInput("Last Name", lastName.isEmpty ? "Not set" : lastName, Icons.person_outline)),
          ],
        ),
        const SizedBox(height: 24),
        
        _buildInput("School", schoolName.isEmpty ? "Not set" : schoolName, Icons.school_outlined),
        const SizedBox(height: 24),
        
        _buildInput("Role", "Administrator", Icons.work_outline),
        const SizedBox(height: 24),

        const Text("Bio / Role Description", style: TextStyle(color: AppColors.textWhite70, fontSize: 13)),
        const SizedBox(height: 8),
        TextFormField(
          initialValue: "Responsible for overseeing all financial operations, including student billing, expense tracking, and ledger reconciliation.",
          maxLines: 4,
          style: const TextStyle(color: AppColors.textWhite),
          decoration: InputDecoration(
            filled: true,
            fillColor: AppColors.backgroundBlack,
            border: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.divider)),
            enabledBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.divider)),
            focusedBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.primaryBlue)),
          ),
        ),
      ],
    );
  }

  Widget _buildInput(String label, String value, IconData icon) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(label, style: const TextStyle(color: AppColors.textWhite70, fontSize: 13)),
        const SizedBox(height: 8),
        TextFormField(
          initialValue: value,
          style: const TextStyle(color: AppColors.textWhite),
          decoration: InputDecoration(
            filled: true,
            fillColor: AppColors.backgroundBlack,
            prefixIcon: Icon(icon, color: AppColors.textWhite38, size: 18),
            border: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.divider)),
            enabledBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.divider)),
            focusedBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.primaryBlue)),
          ),
        ),
      ],
    );
  }
}
// ==========================================
// FILE: ./profile/account_security_card.dart
// ==========================================

import 'package:flutter/material.dart';
import '../../../../../core/constants/app_colors.dart';
import 'package:fees_up/pc/widgets/profile/two_factor_dialog.dart'; // Absolute import for safety

class AccountSecurityCard extends StatelessWidget {
  const AccountSecurityCard({super.key});

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: AppColors.backgroundBlack,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: AppColors.divider),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          const Text("Account Security", style: TextStyle(color: AppColors.textWhite, fontSize: 14, fontWeight: FontWeight.bold)),
          const SizedBox(height: 16),
          
          // Password Status
          Container(
            padding: const EdgeInsets.all(12),
            decoration: BoxDecoration(
              color: AppColors.successGreen.withValues(alpha: 0.1),
              borderRadius: BorderRadius.circular(8),
              border: Border.all(color: AppColors.successGreen.withValues(alpha: 0.3)),
            ),
            child: const Row(
              children: [
                Icon(Icons.shield, color: AppColors.successGreen, size: 20),
                SizedBox(width: 12),
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text("Strong Password", style: TextStyle(color: AppColors.successGreen, fontWeight: FontWeight.bold, fontSize: 12)),
                      Text("Last changed 30 days ago", style: TextStyle(color: AppColors.textWhite54, fontSize: 10)),
                    ],
                  ),
                ),
                Icon(Icons.check_circle, color: AppColors.successGreen, size: 16),
              ],
            ),
          ),
          const SizedBox(height: 12),

          // 2FA Status
          Container(
            padding: const EdgeInsets.all(12),
            decoration: BoxDecoration(
              color: Colors.orange.withValues(alpha: 0.1),
              borderRadius: BorderRadius.circular(8),
              border: Border.all(color: Colors.orange.withValues(alpha: 0.3)),
            ),
            child: Row(
              children: [
                const Icon(Icons.phonelink_lock, color: Colors.orange, size: 20),
                const SizedBox(width: 12),
                const Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text("2FA Inactive", style: TextStyle(color: Colors.orange, fontWeight: FontWeight.bold, fontSize: 12)),
                      Text("Recommended for admins", style: TextStyle(color: AppColors.textWhite54, fontSize: 10)),
                    ],
                  ),
                ),
                TextButton(
                  onPressed: () {
                    showDialog(
                      context: context,
                      barrierColor: Colors.black.withValues(alpha: 0.7),
                      builder: (context) => const EnableTwoFactorDialog(),
                    );
                  },
                  style: TextButton.styleFrom(
                    backgroundColor: Colors.orange,
                    foregroundColor: Colors.black,
                    // Use VisualDensity for compact layout without killing the hit target
                    visualDensity: VisualDensity.compact, 
                    padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
                    shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(6)),
                  ),
                  child: const Text("Enable", style: TextStyle(fontSize: 11, fontWeight: FontWeight.bold)),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }
}
// ==========================================
// FILE: ./profile/profile_header_card.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../../../core/constants/app_colors.dart';
import '../../../../../data/providers/dashboard_provider.dart';

class ProfileHeaderCard extends ConsumerWidget {
  const ProfileHeaderCard({super.key});

  String _getInitials(String name) {
    if (name.isEmpty) return "U";
    final parts = name.trim().split(' ');
    if (parts.length > 1) {
      return "${parts[0][0]}${parts[1][0]}".toUpperCase();
    }
    return name[0].toUpperCase();
  }

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final dashboardAsync = ref.watch(dashboardDataProvider);

    return Container(
      height: 200,
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: AppColors.divider),
      ),
      child: Stack(
        children: [
          // Blue Gradient Banner
          Container(
            height: 100,
            decoration: BoxDecoration(
              borderRadius: const BorderRadius.vertical(top: Radius.circular(15)),
              gradient: LinearGradient(
                colors: [const Color(0xFF1E3A8A), AppColors.primaryBlue.withValues(alpha: 0.6)],
                begin: Alignment.topLeft,
                end: Alignment.bottomRight,
              ),
            ),
          ),
          
          // Profile Details Layer
          Positioned(
            left: 32,
            bottom: 24,
            right: 32,
            child: dashboardAsync.when(
              data: (data) => _buildProfileContent(context, data.userName, data.schoolName),
              loading: () => _buildProfileContent(context, "Loading...", ""),
              error: (err, stack) => _buildProfileContent(context, "Error", ""),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildProfileContent(BuildContext context, String userName, String schoolName) {
    final initials = _getInitials(userName);
    
    return Row(
      crossAxisAlignment: CrossAxisAlignment.end,
      children: [
        // Avatar Group
        Stack(
          children: [
            Container(
              padding: const EdgeInsets.all(4),
              decoration: const BoxDecoration(color: AppColors.surfaceGrey, shape: BoxShape.circle),
              child: CircleAvatar(
                radius: 42,
                backgroundColor: AppColors.primaryBlue.withValues(alpha: 0.2),
                child: Text(
                  initials,
                  style: const TextStyle(
                    fontSize: 24,
                    fontWeight: FontWeight.bold,
                    color: AppColors.primaryBlue,
                  ),
                ),
              ),
            ),
            Positioned(
              bottom: 4,
              right: 4,
              child: Container(
                padding: const EdgeInsets.all(6),
                decoration: const BoxDecoration(color: AppColors.primaryBlue, shape: BoxShape.circle),
                child: const Icon(Icons.camera_alt, size: 14, color: Colors.white),
              ),
            )
          ],
        ),
        const SizedBox(width: 20),
        
        // Info Text
        Expanded(
          child: Padding(
            padding: const EdgeInsets.only(bottom: 8.0),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  userName.isEmpty ? "User" : userName,
                  style: const TextStyle(
                    color: AppColors.textWhite,
                    fontSize: 24,
                    fontWeight: FontWeight.bold,
                  ),
                ),
                const SizedBox(height: 6),
                Row(
                  children: [
                    const Icon(Icons.verified, size: 16, color: AppColors.primaryBlue),
                    const SizedBox(width: 6),
                    Flexible(
                      child: Text(
                        schoolName.isNotEmpty 
                            ? "Administrator  ‚Ä¢  $schoolName"
                            : "Administrator  ‚Ä¢  School Portal",
                        style: const TextStyle(color: AppColors.textWhite70, fontSize: 13),
                        overflow: TextOverflow.ellipsis,
                      ),
                    ),
                  ],
                ),
              ],
            ),
          ),
        ),

        // Action Buttons
        Padding(
          padding: const EdgeInsets.only(bottom: 12.0),
          child: Row(
            children: [
              OutlinedButton(
                onPressed: () {
                  ScaffoldMessenger.of(context).showSnackBar(
                    const SnackBar(content: Text('Public profile coming soon')),
                  );
                },
                style: OutlinedButton.styleFrom(
                  foregroundColor: AppColors.textWhite,
                  side: const BorderSide(color: AppColors.divider),
                  padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 16),
                ),
                child: const Text("View Public Profile"),
              ),
              const SizedBox(width: 12),
              ElevatedButton(
                onPressed: () {
                  ScaffoldMessenger.of(context).showSnackBar(
                    const SnackBar(content: Text('Profile saved'), backgroundColor: AppColors.successGreen),
                  );
                },
                style: ElevatedButton.styleFrom(
                  backgroundColor: AppColors.primaryBlue,
                  foregroundColor: Colors.white,
                  padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 16),
                ),
                child: const Text("Save Changes"),
              ),
            ],
          ),
        ),
      ],
    );
  }
}
// ==========================================
// FILE: ./profile/security_password_view.dart
// ==========================================

import 'package:flutter/material.dart';
import '../../../../../core/constants/app_colors.dart';

class SecurityPasswordView extends StatelessWidget {
  const SecurityPasswordView({super.key});

  @override
  Widget build(BuildContext context) {
    return Column(
      children: [
        // Password Card
        Container(
          padding: const EdgeInsets.all(24),
          decoration: BoxDecoration(
            color: AppColors.surfaceGrey,
            borderRadius: BorderRadius.circular(12),
            border: Border.all(color: AppColors.divider),
          ),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              const Text("Change Password",
                  style: TextStyle(
                      color: AppColors.textWhite,
                      fontSize: 16,
                      fontWeight: FontWeight.bold)),
              const SizedBox(height: 4),
              const Text(
                  "Ensure your account is using a long, random password to stay secure.",
                  style: TextStyle(color: AppColors.textWhite54, fontSize: 13)),
              const SizedBox(height: 24),

              _buildLabel("Current Password"),
              _buildInput("‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢", isPassword: true),
              const SizedBox(height: 24),

              Row(
                children: [
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        _buildLabel("New Password"),
                        _buildInput("‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢", isPassword: true, isNew: true),
                      ],
                    ),
                  ),
                  const SizedBox(width: 24),
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        _buildLabel("Confirm New Password"),
                        _buildInput("‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢", isPassword: true),
                      ],
                    ),
                  ),
                ],
              ),
              const SizedBox(height: 16),

              // Strength Meter
              Container(
                padding: const EdgeInsets.all(16),
                decoration: BoxDecoration(
                  color: AppColors.backgroundBlack,
                  borderRadius: BorderRadius.circular(8),
                  border: Border.all(color: AppColors.divider),
                ),
                child: Column(
                  children: [
                    const Row(
                      mainAxisAlignment: MainAxisAlignment.spaceBetween,
                      children: [
                        Text("Password Strength",
                            style: TextStyle(
                                color: AppColors.textWhite70, fontSize: 11)),
                        Text("Strong",
                            style: TextStyle(
                                color: AppColors.successGreen,
                                fontSize: 11,
                                fontWeight: FontWeight.bold)),
                      ],
                    ),
                    const SizedBox(height: 8),
                    ClipRRect(
                      borderRadius: BorderRadius.circular(2),
                      child: const LinearProgressIndicator(
                        value: 0.85,
                        minHeight: 4,
                        backgroundColor: AppColors.divider,
                        color: AppColors.successGreen,
                      ),
                    ),
                    const SizedBox(height: 8),
                    const Row(
                      children: [
                        Icon(Icons.check,
                            size: 12, color: AppColors.successGreen),
                        SizedBox(width: 6),
                        Text(
                            "Contains at least 8 characters, one number, and one symbol.",
                            style: TextStyle(
                                color: AppColors.textWhite54, fontSize: 11)),
                      ],
                    ),
                  ],
                ),
              ),

              const SizedBox(height: 24),
              Row(
                mainAxisAlignment: MainAxisAlignment.end,
                children: [
                  TextButton(
                    onPressed: () {
                      ScaffoldMessenger.of(context).showSnackBar(
                        const SnackBar(
                          content: Text('Password reset flow coming soon'),
                          backgroundColor: AppColors.primaryBlue,
                          duration: Duration(seconds: 2),
                        ),
                      );
                    },
                    child: const Text("Forgot Password?",
                        style: TextStyle(color: AppColors.textWhite70)),
                  ),
                  const SizedBox(width: 12),
                  ElevatedButton(
                    onPressed: () {
                      ScaffoldMessenger.of(context).showSnackBar(
                        const SnackBar(
                          content: Text('Updating password coming soon'),
                          backgroundColor: AppColors.primaryBlue,
                          duration: Duration(seconds: 2),
                        ),
                      );
                    },
                    style: ElevatedButton.styleFrom(
                        backgroundColor: AppColors.primaryBlue,
                        foregroundColor: Colors.white),
                    child: const Text("Update Password"),
                  ),
                ],
              ),
            ],
          ),
        ),

        const SizedBox(height: 24),

        // 2FA Card
        Container(
          padding: const EdgeInsets.all(24),
          decoration: BoxDecoration(
            color: AppColors.surfaceGrey,
            borderRadius: BorderRadius.circular(12),
            border: Border.all(color: AppColors.divider),
          ),
          child: const Row(
            children: [
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text("Two-Factor Authentication",
                        style: TextStyle(
                            color: AppColors.textWhite,
                            fontSize: 16,
                            fontWeight: FontWeight.bold)),
                    SizedBox(height: 4),
                    Text(
                        "Add an extra layer of security by requiring a code from your phone.",
                        style: TextStyle(
                            color: AppColors.textWhite54, fontSize: 13)),
                  ],
                ),
              ),
              Icon(Icons.phonelink_lock,
                  size: 32, color: AppColors.textWhite38),
            ],
          ),
        ),
      ],
    );
  }

  Widget _buildLabel(String text) => Padding(
      padding: const EdgeInsets.only(bottom: 8),
      child: Text(text,
          style: const TextStyle(color: AppColors.textWhite70, fontSize: 13)));

  Widget _buildInput(String hint,
      {bool isPassword = false, bool isNew = false}) {
    return TextFormField(
      obscureText: isPassword,
      style: const TextStyle(color: AppColors.textWhite),
      decoration: InputDecoration(
        filled: true,
        fillColor: AppColors.backgroundBlack,
        hintText: hint,
        hintStyle:
            const TextStyle(color: AppColors.textWhite38, letterSpacing: 2),
        prefixIcon:
            const Icon(Icons.key, color: AppColors.textWhite38, size: 18),
        suffixIcon: isNew
            ? const Icon(Icons.visibility_off,
                color: AppColors.textWhite38, size: 18)
            : null,
        border: OutlineInputBorder(
            borderRadius: BorderRadius.circular(8),
            borderSide: const BorderSide(color: AppColors.divider)),
        enabledBorder: OutlineInputBorder(
            borderRadius: BorderRadius.circular(8),
            borderSide: const BorderSide(color: AppColors.divider)),
        focusedBorder: OutlineInputBorder(
            borderRadius: BorderRadius.circular(8),
            borderSide: const BorderSide(color: AppColors.primaryBlue)),
      ),
    );
  }
}

// ==========================================
// FILE: ./invoices/payment_allocations_dialog.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:intl/intl.dart';
import '../../../../core/constants/app_colors.dart';
import '../../../../core/utils/safe_data.dart';
import '../../../data/providers/payment_allocations_provider.dart';
import '../../../data/providers/invoices_provider.dart';

class PaymentAllocationsDialog extends ConsumerStatefulWidget {
  final String paymentId;
  final String studentId;
  final double paymentAmount;
  final String paymentDate;

  const PaymentAllocationsDialog({
    super.key,
    required this.paymentId,
    required this.studentId,
    required this.paymentAmount,
    required this.paymentDate,
  });

  @override
  ConsumerState<PaymentAllocationsDialog> createState() =>
      _PaymentAllocationsDialogState();
}

class _PaymentAllocationsDialogState
    extends ConsumerState<PaymentAllocationsDialog> {
  @override
  Widget build(BuildContext context) {
    final allocationsAsync =
        ref.watch(paymentAllocationsProvider(widget.paymentId));
    final unallocatedAsync =
        ref.watch(unallocatedPaymentAmountProvider(widget.paymentId));
    final billsAsync = ref.watch(studentInvoicesProvider(widget.studentId));

    return Dialog(
      backgroundColor: AppColors.surfaceGrey,
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
      child: Container(
        width: 700,
        constraints: const BoxConstraints(maxHeight: 600),
        decoration: BoxDecoration(
          color: AppColors.surfaceGrey,
          borderRadius: BorderRadius.circular(12),
          border: Border.all(color: AppColors.divider),
        ),
        child: Column(
          children: [
            // Header
            Container(
              padding: const EdgeInsets.all(24),
              decoration: const BoxDecoration(
                border: Border(bottom: BorderSide(color: AppColors.divider)),
              ),
              child: Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  const Text(
                    'Payment Allocation Details',
                    style: TextStyle(
                      color: AppColors.textWhite,
                      fontSize: 18,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                  IconButton(
                    icon: const Icon(Icons.close, color: AppColors.textWhite54),
                    onPressed: () => Navigator.pop(context),
                  ),
                ],
              ),
            ),
            // Body
            Expanded(
              child: SingleChildScrollView(
                padding: const EdgeInsets.all(24),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    // Payment Summary
                    Container(
                      padding: const EdgeInsets.all(16),
                      decoration: BoxDecoration(
                        color: AppColors.backgroundBlack,
                        borderRadius: BorderRadius.circular(8),
                        border: Border.all(color: AppColors.divider),
                      ),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          const Text('Payment Summary',
                              style: TextStyle(
                                color: AppColors.textWhite70,
                                fontSize: 12,
                                fontWeight: FontWeight.bold,
                              )),
                          const SizedBox(height: 12),
                          Row(
                            mainAxisAlignment: MainAxisAlignment.spaceBetween,
                            children: [
                              const Text('Payment Amount',
                                  style:
                                      TextStyle(color: AppColors.textWhite54)),
                              Text(
                                NumberFormat.simpleCurrency()
                                    .format(widget.paymentAmount),
                                style: const TextStyle(
                                    color: AppColors.textWhite,
                                    fontWeight: FontWeight.bold),
                              ),
                            ],
                          ),
                          const SizedBox(height: 8),
                          Row(
                            mainAxisAlignment: MainAxisAlignment.spaceBetween,
                            children: [
                              const Text('Payment Date',
                                  style:
                                      TextStyle(color: AppColors.textWhite54)),
                              Text(
                                widget.paymentDate,
                                style:
                                    const TextStyle(color: AppColors.textWhite),
                              ),
                            ],
                          ),
                          const Divider(
                            color: AppColors.divider,
                            height: 16,
                          ),
                          unallocatedAsync.when(
                            data: (unallocated) {
                              final color = unallocated > 0
                                  ? AppColors.warningOrange
                                  : AppColors.successGreen;
                              return Row(
                                mainAxisAlignment:
                                    MainAxisAlignment.spaceBetween,
                                children: [
                                  Text('Unallocated',
                                      style: TextStyle(
                                          color: color,
                                          fontWeight: FontWeight.bold)),
                                  Text(
                                    NumberFormat.simpleCurrency()
                                        .format(unallocated),
                                    style: TextStyle(
                                      color: color,
                                      fontWeight: FontWeight.bold,
                                    ),
                                  ),
                                ],
                              );
                            },
                            loading: () => const Center(
                                child: CircularProgressIndicator()),
                            error: (_, __) => const Text('Error loading',
                                style: TextStyle(color: AppColors.errorRed)),
                          ),
                        ],
                      ),
                    ),
                    const SizedBox(height: 24),

                    // Current Allocations
                    const Text('Current Allocations',
                        style: TextStyle(
                          color: AppColors.textWhite,
                          fontSize: 14,
                          fontWeight: FontWeight.bold,
                        )),
                    const SizedBox(height: 12),
                    allocationsAsync.when(
                      data: (allocations) {
                        if (allocations.isEmpty) {
                          return Container(
                            padding: const EdgeInsets.all(16),
                            decoration: BoxDecoration(
                              color: AppColors.backgroundBlack,
                              borderRadius: BorderRadius.circular(8),
                              border: Border.all(color: AppColors.divider),
                            ),
                            child: const Center(
                              child: Text('No allocations yet',
                                  style:
                                      TextStyle(color: AppColors.textWhite54)),
                            ),
                          );
                        }

                        return ListView.separated(
                          shrinkWrap: true,
                          physics: const NeverScrollableScrollPhysics(),
                          itemCount: allocations.length,
                          separatorBuilder: (_, __) =>
                              const SizedBox(height: 8),
                          itemBuilder: (context, index) {
                            final alloc = allocations[index];
                            final billTitle = alloc['bill_title'] ?? 'Unknown';
                            final allocAmount =
                                SafeData.parseDouble(alloc['amount'], 0.0);

                            return Container(
                              padding: const EdgeInsets.all(12),
                              decoration: BoxDecoration(
                                color: AppColors.backgroundBlack,
                                borderRadius: BorderRadius.circular(8),
                                border: Border.all(color: AppColors.divider),
                              ),
                              child: Row(
                                mainAxisAlignment:
                                    MainAxisAlignment.spaceBetween,
                                children: [
                                  Expanded(
                                    child: Column(
                                      crossAxisAlignment:
                                          CrossAxisAlignment.start,
                                      children: [
                                        Text(billTitle,
                                            style: const TextStyle(
                                              color: AppColors.textWhite,
                                              fontWeight: FontWeight.bold,
                                            ),
                                            maxLines: 1,
                                            overflow: TextOverflow.ellipsis),
                                        Text(
                                            'Bill ID: ${alloc['bill_id'].toString().substring(0, 8)}...',
                                            style: const TextStyle(
                                              color: AppColors.textWhite54,
                                              fontSize: 11,
                                            )),
                                      ],
                                    ),
                                  ),
                                  Column(
                                    crossAxisAlignment: CrossAxisAlignment.end,
                                    children: [
                                      Text(
                                        NumberFormat.simpleCurrency()
                                            .format(allocAmount),
                                        style: const TextStyle(
                                          color: AppColors.successGreen,
                                          fontWeight: FontWeight.bold,
                                        ),
                                      ),
                                      SizedBox(
                                        height: 20,
                                        child: TextButton(
                                          onPressed: () {
                                            ref
                                                .read(
                                                    paymentAllocationNotifierProvider
                                                        .notifier)
                                                .removeAllocation(
                                                  allocationId:
                                                      alloc['id'].toString(),
                                                  billId: alloc['bill_id']
                                                      .toString(),
                                                )
                                                .then((_) {
                                              ScaffoldMessenger.of(context)
                                                  .showSnackBar(
                                                const SnackBar(
                                                  content: Text(
                                                      '‚úÖ Allocation removed'),
                                                ),
                                              );
                                            }).catchError((e) {
                                              ScaffoldMessenger.of(context)
                                                  .showSnackBar(
                                                SnackBar(
                                                  content: Text('‚ùå Error: $e'),
                                                ),
                                              );
                                            });
                                          },
                                          style: TextButton.styleFrom(
                                            padding: EdgeInsets.zero,
                                            minimumSize:
                                                const Size.fromHeight(0),
                                            tapTargetSize: MaterialTapTargetSize
                                                .shrinkWrap,
                                          ),
                                          child: const Text('Remove',
                                              style: TextStyle(
                                                color: AppColors.warningOrange,
                                                fontSize: 10,
                                              )),
                                        ),
                                      ),
                                    ],
                                  ),
                                ],
                              ),
                            );
                          },
                        );
                      },
                      loading: () =>
                          const Center(child: CircularProgressIndicator()),
                      error: (err, _) => Text('Error: $err',
                          style: const TextStyle(color: AppColors.errorRed)),
                    ),
                    const SizedBox(height: 24),

                    // Allocate to Outstanding Bills
                    unallocatedAsync.when(
                      data: (unallocated) {
                        if (unallocated <= 0) {
                          return const SizedBox.shrink();
                        }

                        return Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            const Text('Allocate to Outstanding Bills',
                                style: TextStyle(
                                  color: AppColors.textWhite,
                                  fontSize: 14,
                                  fontWeight: FontWeight.bold,
                                )),
                            const SizedBox(height: 12),
                            billsAsync.when(
                              data: (bills) {
                                final outstanding = bills
                                    .where((b) =>
                                        SafeData.parseInt(b['is_paid'] ?? 0) !=
                                        1)
                                    .toList();

                                if (outstanding.isEmpty) {
                                  return Container(
                                    padding: const EdgeInsets.all(16),
                                    decoration: BoxDecoration(
                                      color: AppColors.backgroundBlack,
                                      borderRadius: BorderRadius.circular(8),
                                      border:
                                          Border.all(color: AppColors.divider),
                                    ),
                                    child: const Center(
                                      child: Text('No outstanding bills',
                                          style: TextStyle(
                                              color: AppColors.textWhite54)),
                                    ),
                                  );
                                }

                                return ListView.separated(
                                  shrinkWrap: true,
                                  physics: const NeverScrollableScrollPhysics(),
                                  itemCount: outstanding.length,
                                  separatorBuilder: (_, __) =>
                                      const SizedBox(height: 8),
                                  itemBuilder: (context, index) {
                                    final bill = outstanding[index];
                                    final billTitle = bill['title'] ?? '---';
                                    final owed = SafeData.parseDouble(
                                        bill['total_amount'], 0.0);
                                    final paid = SafeData.parseDouble(
                                        bill['paid_amount'], 0.0);
                                    final remaining = owed - paid;

                                    return Container(
                                      padding: const EdgeInsets.all(12),
                                      decoration: BoxDecoration(
                                        color: AppColors.backgroundBlack,
                                        borderRadius: BorderRadius.circular(8),
                                        border: Border.all(
                                            color: AppColors.divider),
                                      ),
                                      child: Row(
                                        mainAxisAlignment:
                                            MainAxisAlignment.spaceBetween,
                                        children: [
                                          Expanded(
                                            child: Column(
                                              crossAxisAlignment:
                                                  CrossAxisAlignment.start,
                                              children: [
                                                Text(billTitle,
                                                    style: const TextStyle(
                                                      color:
                                                          AppColors.textWhite,
                                                      fontWeight:
                                                          FontWeight.bold,
                                                    ),
                                                    maxLines: 1,
                                                    overflow:
                                                        TextOverflow.ellipsis),
                                                Text(
                                                    'Balance: ${NumberFormat.simpleCurrency().format(remaining)}',
                                                    style: const TextStyle(
                                                      color:
                                                          AppColors.textWhite54,
                                                      fontSize: 11,
                                                    )),
                                              ],
                                            ),
                                          ),
                                          ElevatedButton(
                                            onPressed: () {
                                              final allocAmount =
                                                  remaining < unallocated
                                                      ? remaining
                                                      : unallocated;
                                              ref
                                                  .read(
                                                      paymentAllocationNotifierProvider
                                                          .notifier)
                                                  .allocatePayment(
                                                    paymentId: widget.paymentId,
                                                    billId:
                                                        bill['id'].toString(),
                                                    amount: allocAmount,
                                                  )
                                                  .then((_) {
                                                ScaffoldMessenger.of(context)
                                                    .showSnackBar(
                                                  SnackBar(
                                                    content: Text(
                                                        '‚úÖ Allocated ${NumberFormat.simpleCurrency().format(allocAmount)}'),
                                                  ),
                                                );
                                              }).catchError((e) {
                                                ScaffoldMessenger.of(context)
                                                    .showSnackBar(
                                                  SnackBar(
                                                    content:
                                                        Text('‚ùå Error: $e'),
                                                  ),
                                                );
                                              });
                                            },
                                            style: ElevatedButton.styleFrom(
                                              backgroundColor:
                                                  AppColors.primaryBlue,
                                              padding:
                                                  const EdgeInsets.symmetric(
                                                horizontal: 12,
                                                vertical: 8,
                                              ),
                                            ),
                                            child: const Text('Allocate',
                                                style: TextStyle(fontSize: 12)),
                                          ),
                                        ],
                                      ),
                                    );
                                  },
                                );
                              },
                              loading: () => const Center(
                                  child: CircularProgressIndicator()),
                              error: (err, _) => Text('Error: $err',
                                  style: const TextStyle(
                                      color: AppColors.errorRed)),
                            ),
                          ],
                        );
                      },
                      loading: () =>
                          const Center(child: CircularProgressIndicator()),
                      error: (_, __) => const SizedBox.shrink(),
                    ),
                  ],
                ),
              ),
            ),
            // Footer
            Container(
              padding: const EdgeInsets.all(16),
              decoration: const BoxDecoration(
                border: Border(top: BorderSide(color: AppColors.divider)),
              ),
              child: Row(
                mainAxisAlignment: MainAxisAlignment.end,
                children: [
                  TextButton(
                    onPressed: () => Navigator.pop(context),
                    child: const Text('Close',
                        style: TextStyle(color: AppColors.textWhite54)),
                  ),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }
}

// ==========================================
// FILE: ./invoices/invoices_stats.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:intl/intl.dart';
import '../../../../core/constants/app_colors.dart';
import '../../../../data/providers/invoices_provider.dart';
import '../../../../data/providers/device_authority_provider.dart';

class InvoicesStats extends ConsumerWidget {
  final String schoolId;
  final VoidCallback onCreateInvoice;

  const InvoicesStats({
    super.key,
    required this.schoolId,
    required this.onCreateInvoice,
  });

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final stats = ref.watch(invoiceStatsProvider(schoolId));

    return SizedBox(
      height: 140,
      child: _buildStatsRow(stats, ref),
    );
  }

  Widget _buildStatsRow(InvoiceStats stats, WidgetRef ref) {
    final formatter = NumberFormat.simpleCurrency();

    final totalBilled = stats.totalBilled;
    final pendingAmount = stats.pendingAmount;
    final overdueAmount = stats.overdueAmount;
    final totalInvoices = stats.totalInvoices;
    final paidCount = stats.paidCount;
    final overdueCount = stats.overdueCount;
    final collectionRate = stats.collectionRate;

    return Row(
      children: [
        // 1. Total Invoiced
        Expanded(
          child: _StatCard(
            title: "Total Invoiced",
            value: formatter.format(totalBilled),
            subtext:
                "$totalInvoices invoices ‚Ä¢ ${collectionRate.toStringAsFixed(1)}% collected",
            subtextColor: AppColors.successGreen,
            icon: Icons.bar_chart,
            iconColor: AppColors.primaryBlue,
          ),
        ),
        const SizedBox(width: 16),

        // 2. Pending Payment
        Expanded(
          child: _StatCard(
            title: "Pending Payment",
            value: formatter.format(pendingAmount),
            subtext: "${totalInvoices - paidCount} active invoices",
            subtextColor: AppColors.warningOrange,
            icon: Icons.pending_actions,
            iconColor: AppColors.warningOrange,
          ),
        ),
        const SizedBox(width: 16),

        // 3. Overdue
        Expanded(
          child: _StatCard(
            title: "Overdue",
            value: formatter.format(overdueAmount),
            subtext: overdueCount > 0
                ? "Needs attention ($overdueCount students)"
                : "All payments on track",
            subtextColor:
                overdueCount > 0 ? AppColors.errorRed : AppColors.successGreen,
            icon: Icons.warning_amber_rounded,
            iconColor:
                overdueCount > 0 ? AppColors.errorRed : AppColors.successGreen,
          ),
        ),
        const SizedBox(width: 16),

        // 4. Create New Action Card
        Expanded(
          child: _CreateInvoiceCard(
            onTap: onCreateInvoice,
            schoolId: schoolId,
          ),
        ),
      ],
    );
  }
}

class _StatCard extends StatelessWidget {
  final String title;
  final String value;
  final String subtext;
  final Color subtextColor;
  final IconData icon;
  final Color iconColor;

  const _StatCard({
    required this.title,
    required this.value,
    required this.subtext,
    required this.subtextColor,
    required this.icon,
    required this.iconColor,
  });

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: AppColors.divider),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Text(title,
                  style:
                      const TextStyle(color: AppColors.textGrey, fontSize: 13)),
              Container(
                padding: const EdgeInsets.all(6),
                decoration: BoxDecoration(
                  color: iconColor.withAlpha(38),
                  borderRadius: BorderRadius.circular(6),
                ),
                child: Icon(icon, color: iconColor, size: 18),
              ),
            ],
          ),
          Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text(value,
                  style: const TextStyle(
                      color: AppColors.textWhite,
                      fontSize: 24,
                      fontWeight: FontWeight.bold)),
              const SizedBox(height: 4),
              Text(subtext,
                  style: TextStyle(
                      color: subtextColor,
                      fontSize: 12,
                      fontWeight: FontWeight.w500)),
            ],
          ),
        ],
      ),
    );
  }
}

class _CreateInvoiceCard extends ConsumerWidget {
  final VoidCallback onTap;
  final String schoolId;

  const _CreateInvoiceCard({
    required this.onTap,
    required this.schoolId,
  });

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final isBillingEngineAsync = ref.watch(isBillingEngineProvider(schoolId));

    return isBillingEngineAsync.when(
      data: (isBillingEngine) {
        if (!isBillingEngine) {
          // Non-billing engine: Show read-only card
          return Container(
            decoration: BoxDecoration(
              color: AppColors.surfaceDarkGrey.withAlpha(128),
              borderRadius: BorderRadius.circular(12),
              border: Border.all(color: AppColors.divider.withAlpha(128)),
            ),
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                Container(
                  width: 48,
                  height: 48,
                  decoration: const BoxDecoration(
                    color: AppColors.textWhite54,
                    shape: BoxShape.circle,
                  ),
                  child: const Icon(Icons.lock,
                      color: AppColors.textWhite38, size: 24),
                ),
                const SizedBox(height: 12),
                const Padding(
                  padding: EdgeInsets.symmetric(horizontal: 8.0),
                  child: Column(
                    children: [
                      Text(
                        "Read-Only",
                        style: TextStyle(
                          color: AppColors.textWhite70,
                          fontWeight: FontWeight.w600,
                          fontSize: 12,
                        ),
                      ),
                      SizedBox(height: 4),
                      Text(
                        "Billing engine only",
                        style: TextStyle(
                          color: AppColors.textWhite38,
                          fontSize: 11,
                        ),
                        textAlign: TextAlign.center,
                      ),
                    ],
                  ),
                ),
              ],
            ),
          );
        }

        // Billing engine: Show interactive create button
        return InkWell(
          onTap: onTap,
          borderRadius: BorderRadius.circular(12),
          child: Container(
            decoration: BoxDecoration(
              color: AppColors.surfaceDarkGrey,
              borderRadius: BorderRadius.circular(12),
              border: Border.all(
                  color: AppColors.divider,
                  style: BorderStyle
                      .solid), // Dashed effect requires custom painter, using solid for now to stay clean
            ),
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                Container(
                  width: 48,
                  height: 48,
                  decoration: BoxDecoration(
                    color: AppColors.primaryBlue.withAlpha(26),
                    shape: BoxShape.circle,
                  ),
                  child: const Icon(Icons.add,
                      color: AppColors.primaryBlue, size: 24),
                ),
                const SizedBox(height: 12),
                const Text(
                  "Create New Invoice",
                  style: TextStyle(
                      color: AppColors.textWhite, fontWeight: FontWeight.w600),
                ),
              ],
            ),
          ),
        );
      },
      loading: () => Container(
        decoration: BoxDecoration(
          color: AppColors.surfaceGrey,
          borderRadius: BorderRadius.circular(12),
          border: Border.all(color: AppColors.divider),
        ),
        child: const Center(
          child: CircularProgressIndicator(
            color: AppColors.primaryBlue,
            strokeWidth: 2,
          ),
        ),
      ),
      error: (err, _) => Container(
        decoration: BoxDecoration(
          color: AppColors.errorRed.withAlpha(26),
          borderRadius: BorderRadius.circular(12),
          border: Border.all(color: AppColors.errorRed.withAlpha(77)),
        ),
        child: const Center(
          child: Icon(Icons.error_outline, color: AppColors.errorRed),
        ),
      ),
    );
  }
}

// ==========================================
// FILE: ./invoices/invoices_table.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:intl/intl.dart';
import '../../../../core/constants/app_colors.dart';
import '../../../../data/providers/dashboard_provider.dart';
import '../../../../data/providers/invoices_provider.dart';
import '../../../../data/services/database_service.dart';

class InvoicesTable extends ConsumerStatefulWidget {
  const InvoicesTable({super.key});

  @override
  ConsumerState<InvoicesTable> createState() => _InvoicesTableState();
}

class _InvoicesTableState extends ConsumerState<InvoicesTable> {
  // Filters & Search
  String _searchQuery = '';
  String _statusFilter = 'All';
  DateTime? _startDate;
  DateTime? _endDate;

  // State
  String _sortColumn = 'created_at';
  bool _sortAscending = false;

  @override
  Widget build(BuildContext context) {
    final dashboardAsync = ref.watch(dashboardDataProvider);

    return dashboardAsync.when(
      loading: () => const Center(child: CircularProgressIndicator()),
      error: (err, stack) => Center(child: Text('Error: $err')),
      data: (dashboardData) {
        final schoolId = dashboardData.schoolId;
        final invoicesAsync = ref.watch(invoicesProvider(schoolId));

        return Column(
          children: [
            // --- FILTER BAR ---
            _buildFilterBar(schoolId),
            const SizedBox(height: 16),

            // --- DATA TABLE ---
            Container(
              decoration: BoxDecoration(
                color: AppColors.surfaceGrey,
                borderRadius: BorderRadius.circular(12),
                border: Border.all(color: AppColors.divider),
              ),
              child: Column(
                children: [
                  // Header Row
                  _buildTableHeader(),
                  const Divider(height: 1, color: AppColors.divider),

                  // Data Rows
                  invoicesAsync.when(
                    loading: () => const Padding(
                      padding: EdgeInsets.all(16.0),
                      child: Center(
                          child: CircularProgressIndicator(
                              color: AppColors.primaryBlue)),
                    ),
                    error: (error, stack) => Padding(
                      padding: const EdgeInsets.all(16.0),
                      child: Center(
                          child: Text('Error loading invoices: $error',
                              style:
                                  const TextStyle(color: AppColors.errorRed))),
                    ),
                    data: (invoices) {
                      // Apply filters safely
                      final filtered = _applyFilters(invoices);

                      if (filtered.isEmpty) {
                        return const Padding(
                          padding: EdgeInsets.all(16.0),
                          child: Center(
                              child: Text('No invoices match your filters',
                                  style:
                                      TextStyle(color: AppColors.textWhite54))),
                        );
                      }

                      return Column(
                        children: _buildInvoiceRows(filtered),
                      );
                    },
                  ),
                ],
              ),
            ),
          ],
        );
      },
    );
  }

  /// Apply search and filters to invoices safely
  List<Map<String, dynamic>> _applyFilters(
      List<Map<String, dynamic>> invoices) {
    // --- FIX START: Create a Mutable Copy ---
    // This breaks the link to the read-only ResultSet so we can sort/filter
    var filtered = List<Map<String, dynamic>>.from(invoices);
    // --- FIX END ---

    // 1. Status filter
    if (_statusFilter != 'All') {
      filtered = filtered.where((inv) {
        final isPaidVal = inv['is_paid'];
        // Handle boolean or int (0/1) from DB
        final isPaid = isPaidVal == 1 || isPaidVal == true;

        if (_statusFilter == 'Paid') return isPaid;
        if (_statusFilter == 'Unpaid') return !isPaid;
        return true;
      }).toList();
    }

    // 2. Date range filter
    if (_startDate != null || _endDate != null) {
      filtered = filtered.where((inv) {
        final createdStr = inv['created_at']?.toString();
        if (createdStr == null) return false;
        final date = DateTime.tryParse(createdStr);
        if (date == null) return false;

        // Use strict boundaries for dates
        if (_startDate != null && date.isBefore(_startDate!)) return false;
        if (_endDate != null && date.isAfter(_endDate!)) return false;
        return true;
      }).toList();
    }

    // 3. Search query
    if (_searchQuery.isNotEmpty) {
      final query = _searchQuery.toLowerCase();
      filtered = filtered.where((inv) {
        final title = (inv['title']?.toString() ?? '').toLowerCase();
        final studentId = (inv['student_id']?.toString() ?? '').toLowerCase();
        return title.contains(query) || studentId.contains(query);
      }).toList();
    }

    // 4. Sort
    filtered.sort((a, b) {
      var aVal = a[_sortColumn];
      var bVal = b[_sortColumn];

      // Null handling for sort
      if (aVal == null && bVal == null) return 0;
      if (aVal == null) return 1;
      if (bVal == null) return -1;

      int result = 0;
      // Compare as strings or numbers safely
      if (aVal is num && bVal is num) {
        result = aVal.compareTo(bVal);
      } else {
        result = aVal.toString().compareTo(bVal.toString());
      }

      return _sortAscending ? result : -result;
    });

    return filtered;
  }

  Widget _buildFilterBar(String schoolId) {
    return Row(
      children: [
        // --- Search Bar ---
        Expanded(
          child: SizedBox(
            height: 44,
            child: TextField(
              onChanged: (value) => setState(() => _searchQuery = value),
              textAlignVertical: TextAlignVertical.center,
              style: const TextStyle(color: AppColors.textWhite),
              decoration: InputDecoration(
                isDense: true,
                filled: true,
                fillColor: AppColors.surfaceGrey,
                hintText: "Search...",
                hintStyle:
                    const TextStyle(color: AppColors.textWhite38, fontSize: 13),
                prefixIcon: const Icon(Icons.search,
                    color: AppColors.textWhite38, size: 18),
                border: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(8),
                  borderSide: const BorderSide(color: AppColors.divider),
                ),
                enabledBorder: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(8),
                  borderSide: const BorderSide(color: AppColors.divider),
                ),
                focusedBorder: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(8),
                  borderSide: const BorderSide(color: AppColors.primaryBlue),
                ),
                contentPadding: EdgeInsets.zero,
              ),
            ),
          ),
        ),
        const SizedBox(width: 12),

        // Status Dropdown
        _buildStatusDropdown(),
        const SizedBox(width: 12),

        // Date Range Picker
        _buildDateRangeButton(),
        const SizedBox(width: 12),

        // Clear Filters Button (Only shows when active)
        if (_searchQuery.isNotEmpty ||
            _statusFilter != 'All' ||
            _startDate != null ||
            _endDate != null)
          GestureDetector(
            onTap: () {
              setState(() {
                _searchQuery = '';
                _statusFilter = 'All';
                _startDate = null;
                _endDate = null;
              });
            },
            child: Container(
              height: 44,
              padding: const EdgeInsets.symmetric(horizontal: 16),
              decoration: BoxDecoration(
                color: AppColors.errorRed.withAlpha(30),
                borderRadius: BorderRadius.circular(8),
                border: Border.all(color: AppColors.errorRed),
              ),
              child: const Row(
                children: [
                  Icon(Icons.clear, color: AppColors.errorRed, size: 16),
                  SizedBox(width: 8),
                  Text("Clear",
                      style:
                          TextStyle(color: AppColors.errorRed, fontSize: 13)),
                ],
              ),
            ),
          )
        else
          const SizedBox(),
        const SizedBox(width: 12),

        // Export Button
        GestureDetector(
          onTap: () => _exportToCSV(schoolId),
          child: Container(
            height: 44,
            padding: const EdgeInsets.symmetric(horizontal: 20),
            decoration: BoxDecoration(
              color: AppColors.primaryBlue,
              borderRadius: BorderRadius.circular(8),
            ),
            child: const Row(
              children: [
                Icon(Icons.download, color: Colors.white, size: 16),
                SizedBox(width: 8),
                Text("Export CSV",
                    style: TextStyle(
                        color: Colors.white,
                        fontWeight: FontWeight.bold,
                        fontSize: 13)),
              ],
            ),
          ),
        ),
      ],
    );
  }

  Widget _buildStatusDropdown() {
    final statuses = ['All', 'Paid', 'Unpaid'];

    return PopupMenuButton<String>(
      onSelected: (value) => setState(() => _statusFilter = value),
      itemBuilder: (context) => statuses
          .map((status) => PopupMenuItem(
                value: status,
                child: Row(
                  children: [
                    if (_statusFilter == status)
                      const Icon(Icons.check,
                          color: AppColors.primaryBlue, size: 16)
                    else
                      const SizedBox(width: 16),
                    const SizedBox(width: 8),
                    Text(status),
                  ],
                ),
              ))
          .toList(),
      child: Container(
        height: 44,
        padding: const EdgeInsets.symmetric(horizontal: 16),
        decoration: BoxDecoration(
          color: AppColors.surfaceGrey,
          borderRadius: BorderRadius.circular(8),
          border: Border.all(color: AppColors.divider),
        ),
        child: Row(
          children: [
            Text("Status: $_statusFilter",
                style:
                    const TextStyle(color: AppColors.textWhite, fontSize: 13)),
            const SizedBox(width: 8),
            const Icon(Icons.keyboard_arrow_down,
                color: AppColors.textWhite54, size: 16),
          ],
        ),
      ),
    );
  }

  Widget _buildDateRangeButton() {
    final hasDateFilter = _startDate != null || _endDate != null;
    final dateLabel = hasDateFilter
        ? '${DateFormat('MM/dd').format(_startDate!)} - ${DateFormat('MM/dd').format(_endDate!)}'
        : 'Select Date';

    return GestureDetector(
      onTap: () async {
        final picked = await showDateRangePicker(
          context: context,
          firstDate: DateTime(2020),
          lastDate: DateTime.now(),
          initialDateRange: hasDateFilter
              ? DateTimeRange(start: _startDate!, end: _endDate!)
              : null,
        );

        if (picked != null) {
          setState(() {
            _startDate = picked.start;
            _endDate = picked.end;
          });
        }
      },
      child: Container(
        height: 44,
        padding: const EdgeInsets.symmetric(horizontal: 16),
        decoration: BoxDecoration(
          color: AppColors.surfaceGrey,
          borderRadius: BorderRadius.circular(8),
          border: Border.all(
            color: hasDateFilter ? AppColors.primaryBlue : AppColors.divider,
          ),
        ),
        child: Row(
          children: [
            Icon(Icons.calendar_today,
                color: hasDateFilter
                    ? AppColors.primaryBlue
                    : AppColors.textWhite54,
                size: 16),
            const SizedBox(width: 8),
            Text(dateLabel,
                style: TextStyle(
                    color: hasDateFilter
                        ? AppColors.primaryBlue
                        : AppColors.textWhite,
                    fontSize: 13)),
          ],
        ),
      ),
    );
  }

  Widget _buildTableHeader() {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 16),
      child: Row(
        children: [
          _buildSortableCol("INVOICE", 'title', 2),
          _buildSortableCol("STUDENT", 'student_id', 2),
          _buildSortableCol("AMOUNT", 'total_amount', 1),
          _buildSortableCol("DUE DATE", 'billing_cycle_end', 2),
          _buildSortableCol("STATUS", 'is_paid', 1),
          _col("ACTIONS", 1, align: TextAlign.end),
        ],
      ),
    );
  }

  Widget _buildSortableCol(String text, String column, int flex) {
    final isActive = _sortColumn == column;
    return Expanded(
      flex: flex,
      child: GestureDetector(
        onTap: () {
          setState(() {
            if (_sortColumn == column) {
              _sortAscending = !_sortAscending;
            } else {
              _sortColumn = column;
              _sortAscending = false;
            }
          });
        },
        child: Row(
          children: [
            Text(
              text,
              style: TextStyle(
                  color:
                      isActive ? AppColors.primaryBlue : AppColors.textWhite38,
                  fontSize: 11,
                  fontWeight: FontWeight.bold,
                  letterSpacing: 0.8),
            ),
            if (isActive)
              Icon(
                _sortAscending ? Icons.arrow_upward : Icons.arrow_downward,
                color: AppColors.primaryBlue,
                size: 12,
              )
          ],
        ),
      ),
    );
  }

  Widget _col(String text, int flex, {TextAlign align = TextAlign.start}) {
    return Expanded(
      flex: flex,
      child: Text(
        text,
        textAlign: align,
        style: const TextStyle(
            color: AppColors.textWhite38,
            fontSize: 11,
            fontWeight: FontWeight.bold,
            letterSpacing: 0.8),
      ),
    );
  }

  List<Widget> _buildInvoiceRows(List<Map<String, dynamic>> invoices) {
    return invoices.map((invoice) {
      return Column(
        children: [
          _buildInvoiceRowFromMap(invoice),
          const Divider(height: 1, color: AppColors.divider),
        ],
      );
    }).toList();
  }

  Widget _buildInvoiceRowFromMap(Map<String, dynamic> invoice) {
    final title = invoice['title']?.toString() ?? 'Invoice';
    final studentId = invoice['student_id']?.toString() ?? 'Unknown';
    // Safer double parsing
    final totalAmount =
        double.tryParse(invoice['total_amount']?.toString() ?? '0') ?? 0.0;
    final dueDateStr = invoice['billing_cycle_end']?.toString() ?? '';

    // Check for boolean or 0/1 integer
    final isPaidVal = invoice['is_paid'];
    final isPaid = isPaidVal == 1 || isPaidVal == true;

    final invoiceId = invoice['id']?.toString() ?? '';

    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 16),
      child: Row(
        children: [
          // Invoice Title
          Expanded(
            flex: 2,
            child: Text(
              title,
              style: const TextStyle(
                  color: AppColors.textWhite, fontWeight: FontWeight.w500),
              maxLines: 1,
              overflow: TextOverflow.ellipsis,
            ),
          ),
          // Student ID
          Expanded(
            flex: 2,
            child: Text(
              studentId,
              style: const TextStyle(color: AppColors.textWhite70),
            ),
          ),
          // Amount
          Expanded(
            flex: 1,
            child: Text(
              '\$${totalAmount.toStringAsFixed(2)}',
              style: const TextStyle(
                  color: AppColors.textWhite, fontWeight: FontWeight.bold),
            ),
          ),
          // Due Date
          Expanded(
            flex: 2,
            child: Text(
              dueDateStr.isNotEmpty
                  ? DateFormat('MM/dd/yyyy')
                      .format(DateTime.tryParse(dueDateStr) ?? DateTime.now())
                  : 'N/A',
              style: TextStyle(
                color: isPaid ? AppColors.textWhite70 : AppColors.errorRed,
              ),
            ),
          ),
          // Status
          Expanded(
            flex: 1,
            child: Container(
              padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
              decoration: BoxDecoration(
                color: isPaid
                    ? AppColors.successGreen.withAlpha(51)
                    : AppColors.warningOrange.withAlpha(51),
                borderRadius: BorderRadius.circular(4),
              ),
              child: Text(
                isPaid ? 'Paid' : 'Unpaid',
                style: TextStyle(
                  color:
                      isPaid ? AppColors.successGreen : AppColors.warningOrange,
                  fontSize: 11,
                  fontWeight: FontWeight.bold,
                ),
              ),
            ),
          ),
          // Actions
          Expanded(
            flex: 1,
            child: Row(
              mainAxisAlignment: MainAxisAlignment.end,
              children: [
                IconButton(
                  icon: const Icon(Icons.visibility,
                      size: 18, color: AppColors.textWhite54),
                  onPressed: () {
                    ScaffoldMessenger.of(context).showSnackBar(
                      SnackBar(
                        content: Text('Viewing invoice: $invoiceId'),
                        backgroundColor: AppColors.primaryBlue,
                      ),
                    );
                  },
                ),
                IconButton(
                  icon: const Icon(Icons.more_vert,
                      size: 18, color: AppColors.textWhite54),
                  onPressed: () => _showInvoiceActions(context, invoice),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  void _showInvoiceActions(BuildContext context, Map<String, dynamic> invoice) {
    final invoiceId = invoice['id']?.toString() ?? '';
    final isPaidVal = invoice['is_paid'];
    final isPaid = isPaidVal == 1 || isPaidVal == true;

    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        backgroundColor: AppColors.surfaceGrey,
        title: const Text('Invoice Actions',
            style: TextStyle(color: AppColors.textWhite)),
        content: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            ListTile(
              title: const Text('View Details',
                  style: TextStyle(color: AppColors.textWhite)),
              onTap: () {
                Navigator.pop(context);
                ScaffoldMessenger.of(context).showSnackBar(
                  SnackBar(
                    content: Text('Viewing invoice: $invoiceId'),
                    backgroundColor: AppColors.primaryBlue,
                  ),
                );
              },
            ),
            if (!isPaid)
              ListTile(
                title: const Text('Mark as Paid',
                    style: TextStyle(color: AppColors.successGreen)),
                onTap: () {
                  Navigator.pop(context);
                  _markInvoiceAsPaid(invoiceId);
                },
              ),
            ListTile(
              title: const Text('Delete',
                  style: TextStyle(color: AppColors.errorRed)),
              onTap: () {
                Navigator.pop(context);
                _deleteInvoice(invoiceId);
              },
            ),
          ],
        ),
      ),
    );
  }

  Future<void> _markInvoiceAsPaid(String invoiceId) async {
    try {
      final db = DatabaseService();
      await db.update('bills', invoiceId, {
        'is_paid': 1,
        'updated_at': DateTime.now().toIso8601String(),
      });
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
            content: Text('Invoice marked as paid'),
            backgroundColor: AppColors.successGreen,
          ),
        );
      }
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Error: $e'),
            backgroundColor: AppColors.errorRed,
          ),
        );
      }
    }
  }

  Future<void> _deleteInvoice(String invoiceId) async {
    try {
      final db = DatabaseService();
      await db.delete('bills', invoiceId);
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
            content: Text('Invoice deleted'),
            backgroundColor: AppColors.successGreen,
          ),
        );
      }
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Error: $e'),
            backgroundColor: AppColors.errorRed,
          ),
        );
      }
    }
  }

  Future<void> _exportToCSV(String schoolId) async {
    try {
      final db = DatabaseService();
      final invoices = await db.select(
        'SELECT * FROM bills WHERE school_id = ? ORDER BY created_at DESC',
        [schoolId],
      );

      if (invoices.isEmpty) {
        if (mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(
              content: Text('No invoices to export'),
              backgroundColor: AppColors.warningOrange,
            ),
          );
        }
        return;
      }
      // Placeholder for actual CSV logic
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
            content: Text('Exporting CSV...'),
            backgroundColor: AppColors.primaryBlue,
          ),
        );
      }
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Export failed: $e'),
            backgroundColor: AppColors.errorRed,
          ),
        );
      }
    }
  }
}

// ==========================================
// FILE: ./invoices/invoices_header.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../../core/constants/app_colors.dart';
import '../../../../data/providers/dashboard_provider.dart';
import '../../../../data/services/database_service.dart'; // Import DatabaseService

class InvoicesHeader extends ConsumerWidget {
  const InvoicesHeader({super.key});

  String _getInitials(String name) {
    if (name.isEmpty) return "U";
    final parts = name.trim().split(' ');
    if (parts.length > 1) {
      return "${parts[0][0]}${parts[1][0]}".toUpperCase();
    }
    return name[0].toUpperCase();
  }

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final dashboardAsync = ref.watch(dashboardDataProvider);

    // Check connectivity status directly for UI feedback
    final bool isConnected = DatabaseService().db.currentStatus.connected;

    return Container(
      height: 70,
      padding: const EdgeInsets.symmetric(horizontal: 24),
      color: AppColors.backgroundBlack,
      child: Row(
        children: [
          // --- Page Title ---
          const Icon(Icons.description, color: AppColors.primaryBlue, size: 28),
          const SizedBox(width: 12),
          const Text(
            "Invoices",
            style: TextStyle(
              color: AppColors.textWhite,
              fontSize: 20,
              fontWeight: FontWeight.bold,
              letterSpacing: 0.5,
            ),
          ),

          const Spacer(),

          // --- Global Search Bar (Fixed) ---
          SizedBox(
            width: 300,
            height: 40,
            child: TextField(
              textAlignVertical: TextAlignVertical.center,
              style: const TextStyle(color: AppColors.textWhite, fontSize: 13),
              decoration: InputDecoration(
                isDense: true,
                filled: true,
                fillColor: AppColors.surfaceGrey,
                hintText: "Search payments, invoices...",
                hintStyle: const TextStyle(color: AppColors.textWhite38),
                prefixIcon: const Icon(Icons.search,
                    size: 18, color: AppColors.textWhite54),

                // Content Padding zero to center text vertically
                contentPadding: EdgeInsets.zero,

                // Default Border
                enabledBorder: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(8),
                  borderSide: const BorderSide(color: AppColors.divider),
                ),

                // Focused Border
                focusedBorder: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(8),
                  borderSide: const BorderSide(color: AppColors.primaryBlue),
                ),

                // Fallback Border
                border: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(8),
                  borderSide: const BorderSide(color: AppColors.divider),
                ),
              ),
            ),
          ),

          const SizedBox(width: 24),

          // --- Notification Bell ---
          Stack(
            children: [
              IconButton(
                onPressed: () {
                  ScaffoldMessenger.of(context).showSnackBar(
                    const SnackBar(
                      content: Text('Notifications panel coming soon'),
                      backgroundColor: AppColors.primaryBlue,
                      duration: Duration(seconds: 2),
                    ),
                  );
                },
                icon: const Icon(Icons.notifications_none,
                    color: AppColors.textWhite70),
                tooltip: "Notifications",
              ),
              Positioned(
                right: 10,
                top: 10,
                child: Container(
                  width: 8,
                  height: 8,
                  decoration: const BoxDecoration(
                      color: AppColors.errorRed, shape: BoxShape.circle),
                ),
              )
            ],
          ),

          const SizedBox(width: 16),

          // --- Profile with Connectivity Logic ---
          dashboardAsync.when(
            loading: () => _buildProfileLoading(),
            error: (err, _) => _buildProfileError(isConnected),
            data: (data) {
              final initials = _getInitials(data.userName);

              // Determine subtitle based on data state AND connectivity
              String subtitle = data.schoolName;
              if (data.schoolName == 'Loading...') {
                subtitle = isConnected ? "Syncing Data..." : "Offline Mode";
              }

              return Row(
                children: [
                  Column(
                    mainAxisAlignment: MainAxisAlignment.center,
                    crossAxisAlignment: CrossAxisAlignment.end,
                    children: [
                      Text(data.userName.isEmpty ? "User" : data.userName,
                          style: const TextStyle(
                              color: AppColors.textWhite,
                              fontWeight: FontWeight.bold,
                              fontSize: 13)),
                      Text(subtitle,
                          style: TextStyle(
                              color: (subtitle == "Offline Mode")
                                  ? AppColors.warningOrange
                                  : AppColors.textWhite38,
                              fontSize: 11)),
                    ],
                  ),
                  const SizedBox(width: 12),
                  CircleAvatar(
                    backgroundColor:
                        AppColors.primaryBlue.withValues(alpha: 0.2),
                    child: Text(initials,
                        style: const TextStyle(
                            color: AppColors.primaryBlue,
                            fontWeight: FontWeight.bold,
                            fontSize: 12)),
                  ),
                ],
              );
            },
          ),
        ],
      ),
    );
  }

  // --- Loading/Error States ---

  Widget _buildProfileLoading() {
    return Row(
      children: [
        Column(
          mainAxisAlignment: MainAxisAlignment.center,
          crossAxisAlignment: CrossAxisAlignment.end,
          children: [
            Container(width: 80, height: 12, color: AppColors.surfaceGrey),
            const SizedBox(height: 4),
            Container(width: 50, height: 10, color: AppColors.surfaceGrey),
          ],
        ),
        const SizedBox(width: 12),
        const CircleAvatar(
          backgroundColor: AppColors.surfaceGrey,
          radius: 20,
        ),
      ],
    );
  }

  Widget _buildProfileError(bool isConnected) {
    return Row(
      children: [
        Text(isConnected ? "Sync Error" : "Offline",
            style: TextStyle(
                color:
                    isConnected ? AppColors.errorRed : AppColors.warningOrange,
                fontSize: 12)),
        const SizedBox(width: 12),
        CircleAvatar(
          backgroundColor: AppColors.surfaceGrey,
          child: Icon(isConnected ? Icons.error_outline : Icons.wifi_off,
              size: 16,
              color:
                  isConnected ? AppColors.errorRed : AppColors.warningOrange),
        ),
      ],
    );
  }
}

// ==========================================
// FILE: ./invoices/invoice_dialog.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:intl/intl.dart';
import 'package:uuid/uuid.dart';

import '../../../../core/constants/app_colors.dart';
import '../../../../data/services/database_service.dart';
// Use your provider for access
// ignore: unused_import
import '../../../../data/providers/school_provider.dart'; 

class InvoiceDialog extends ConsumerStatefulWidget {
  final String schoolId;
  const InvoiceDialog({super.key, required this.schoolId});

  @override
  ConsumerState<InvoiceDialog> createState() => _InvoiceDialogState();
}

class _InvoiceDialogState extends ConsumerState<InvoiceDialog> {
  final _formKey = GlobalKey<FormState>();
  
  // Use the Singleton directly as per your architecture
  final DatabaseService _dbService = DatabaseService();

  // Controllers
  final _titleController = TextEditingController();
  final _amountController = TextEditingController();
  final _descController = TextEditingController();

  // State
  String? _selectedStudentId;
  DateTime _dueDate = DateTime.now().add(const Duration(days: 7));
  String _generatedInvoiceNum = "Loading...";
  String _invoiceStatus = 'draft'; // ‚úÖ NEW: Draft status support
  bool _isLoading = false;

  @override
  void initState() {
    super.initState();
    _fetchNextInvoiceNumber();
  }

  @override
  void dispose() {
    _titleController.dispose();
    _amountController.dispose();
    _descController.dispose();
    super.dispose();
  }

  // --- LOGIC (Production Ready) ---

  Future<void> _fetchNextInvoiceNumber() async {
    try {
      // 1. Use the new .select() method you added to DatabaseService
      final result = await _dbService.select(
        'SELECT invoice_number FROM bills WHERE school_id = ? ORDER BY invoice_number DESC LIMIT 1',
        [widget.schoolId],
      );

      int nextNum = 1;
      if (result.isNotEmpty) {
        final lastInv = result.first['invoice_number'] as String?;
        if (lastInv != null && lastInv.startsWith('INV-')) {
          final numericPart = int.tryParse(lastInv.split('-')[1]);
          if (numericPart != null) {
            nextNum = numericPart + 1;
          }
        }
      }

      if (mounted) {
        setState(() {
          _generatedInvoiceNum = 'INV-${nextNum.toString().padLeft(5, '0')}';
        });
      }
    } catch (e) {
      if (mounted) setState(() => _generatedInvoiceNum = "INV-ERROR");
    }
  }

  Future<void> _submitInvoice() async {
    if (!_formKey.currentState!.validate()) return;
    if (_selectedStudentId == null) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text("Please select a student"), backgroundColor: AppColors.errorRed),
      );
      return;
    }

    setState(() => _isLoading = true);

    try {
      final newId = const Uuid().v4();
      final amount = double.tryParse(_amountController.text.trim()) ?? 0.0;
      final now = DateTime.now();

      // ‚úÖ CORRECT: No schema hacks - database supports null values for adhoc bills
      final billData = {
        'id': newId,
        'school_id': widget.schoolId,
        'student_id': _selectedStudentId,
        'title': _titleController.text.trim(),
        'invoice_number': _generatedInvoiceNum, 
        'status': _invoiceStatus, // ‚úÖ NEW: Respects draft/sent status
        'total_amount': amount,
        'paid_amount': 0.0,
        'is_paid': 0, 
        'is_closed': 0,
        'bill_type': 'adhoc', // Manual entry
        'due_date': DateFormat('yyyy-MM-dd').format(_dueDate),
        'created_at': now.toIso8601String(),
        'updated_at': now.toIso8601String(),
        'month_year': DateFormat('yyyy-MM').format(now),
        // ‚úÖ FIXED: Removed artificial 'term_id': 'adhoc-manual' hack
        // Database schema properly handles null values for school_year_id, month_index, term_id
        // These fields are intentionally left null for adhoc bills
      };

      await _dbService.insert('bills', billData);

      if (mounted) {
        Navigator.of(context).pop();
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text("Invoice $_generatedInvoiceNum generated successfully"), 
            backgroundColor: AppColors.successGreen
          ),
        );
      }
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text("Error: $e"), backgroundColor: AppColors.errorRed),
        );
      }
    } finally {
      if (mounted) setState(() => _isLoading = false);
    }
  }

  // --- UI BUILD (Same visual, real logic) ---

  @override
  Widget build(BuildContext context) {
    return Dialog(
      backgroundColor: Colors.transparent,
      insetPadding: const EdgeInsets.all(24),
      child: Container(
        width: 1100,
        height: 750,
        decoration: BoxDecoration(
          color: AppColors.backgroundBlack,
          borderRadius: BorderRadius.circular(16),
          border: Border.all(color: AppColors.surfaceLightGrey),
          boxShadow: [
            BoxShadow(color: Colors.black.withValues(alpha: 0.5), blurRadius: 20, offset: const Offset(0, 10))
          ],
        ),
        child: Column(
          children: [
            _buildHeader(),
            const Divider(height: 1, color: AppColors.divider),
            
            // MAIN CONTENT (Split View)
            Expanded(
              child: Row(
                children: [
                  // LEFT: FORM
                  Expanded(
                    flex: 5,
                    child: Padding(
                      padding: const EdgeInsets.all(32),
                      child: Form(
                        key: _formKey,
                        child: SingleChildScrollView(
                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              Row(
                                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                                children: [
                                  const Text("INVOICE DETAILS", style: TextStyle(color: AppColors.textGrey, fontSize: 12, fontWeight: FontWeight.bold, letterSpacing: 1.2)),
                                  Container(
                                    padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
                                    decoration: BoxDecoration(
                                      color: AppColors.surfaceGrey,
                                      borderRadius: BorderRadius.circular(4),
                                      border: Border.all(color: AppColors.surfaceLightGrey),
                                    ),
                                    child: Text(
                                      _generatedInvoiceNum, 
                                      style: const TextStyle(color: AppColors.primaryBlueLight, fontWeight: FontWeight.bold, fontFamily: 'monospace')
                                    ),
                                  ),
                                ],
                              ),
                              const SizedBox(height: 24),

                              _buildLabel("Select Student"),
                              // Uses DatabaseService.watchStudents (Real Data)
                              _buildStudentAutocomplete(),
                              const SizedBox(height: 16),

                              _buildLabel("Title / Reason"),
                              _buildTextField(
                                controller: _titleController,
                                hint: "e.g. Broken Science Equipment",
                                validator: (v) => v!.isEmpty ? "Required" : null,
                              ),
                              const SizedBox(height: 16),

                              Row(
                                children: [
                                  Expanded(
                                    child: Column(
                                      crossAxisAlignment: CrossAxisAlignment.start,
                                      children: [
                                        _buildLabel("Amount Due"),
                                        _buildTextField(
                                          controller: _amountController,
                                          hint: "0.00",
                                          prefix: "\$ ",
                                          isNumber: true,
                                          validator: (v) {
                                            if (v == null || v.isEmpty) return "Required";
                                            if (double.tryParse(v) == null) return "Invalid";
                                            return null;
                                          },
                                        ),
                                      ],
                                    ),
                                  ),
                                  const SizedBox(width: 16),
                                  Expanded(
                                    child: Column(
                                      crossAxisAlignment: CrossAxisAlignment.start,
                                      children: [
                                        _buildLabel("Due Date"),
                                        _buildDatePicker(context),
                                      ],
                                    ),
                                  ),
                                  const SizedBox(width: 16),
                                  Expanded(
                                    child: Column(
                                      crossAxisAlignment: CrossAxisAlignment.start,
                                      children: [
                                        _buildLabel("Invoice Status"),
                                        _buildStatusDropdown(),
                                      ],
                                    ),
                                  ),
                                ],
                              ),
                              const SizedBox(height: 16),

                              _buildLabel("Notes (Internal Only)"),
                              _buildTextField(
                                controller: _descController,
                                hint: "Additional context about this charge...",
                                maxLines: 3,
                              ),
                            ],
                          ),
                        ),
                      ),
                    ),
                  ),

                  const VerticalDivider(width: 1, color: AppColors.divider),

                  // RIGHT: RECENT INVOICES LIST (Real Data Stream)
                  Expanded(
                    flex: 4,
                    child: Container(
                      color: AppColors.surfaceDarkGrey,
                      padding: const EdgeInsets.all(24),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          const Text("RECENT INVOICES", style: TextStyle(color: AppColors.textGrey, fontSize: 12, fontWeight: FontWeight.bold, letterSpacing: 1.2)),
                          const SizedBox(height: 24),
                          Expanded(
                            child: StreamBuilder<List<Map<String, dynamic>>>(
                              // Uses DatabaseService.db.watch directly
                              stream: _dbService.db.watch(
                                'SELECT * FROM bills WHERE school_id = ? AND invoice_number IS NOT NULL ORDER BY created_at DESC LIMIT 20', 
                                parameters: [widget.schoolId]
                              ),
                              builder: (context, snapshot) {
                                if (!snapshot.hasData) return const Center(child: CircularProgressIndicator(color: AppColors.primaryBlue));
                                final bills = snapshot.data ?? [];
                                
                                if (bills.isEmpty) {
                                  return const Center(child: Text("No invoices generated yet.", style: TextStyle(color: AppColors.textGrey)));
                                }

                                return ListView.separated(
                                  itemCount: bills.length,
                                  separatorBuilder: (_, __) => const SizedBox(height: 12),
                                  itemBuilder: (context, index) {
                                    final bill = bills[index];
                                    final invNum = bill['invoice_number'] ?? '---';
                                    final amount = (bill['total_amount'] as num?)?.toDouble() ?? 0.0;
                                    final title = bill['title'] ?? 'Unknown Charge';
                                    final status = bill['status'] ?? 'pending';

                                    return Container(
                                      padding: const EdgeInsets.all(16),
                                      decoration: BoxDecoration(
                                        color: AppColors.surfaceGrey,
                                        borderRadius: BorderRadius.circular(12),
                                        border: Border.all(color: Colors.white.withValues(alpha: 0.05)),
                                      ),
                                      child: Row(
                                        children: [
                                          Container(
                                            width: 40, height: 40,
                                            decoration: BoxDecoration(
                                              color: AppColors.primaryBlue.withValues(alpha: 0.1),
                                              borderRadius: BorderRadius.circular(8),
                                            ),
                                            child: const Icon(Icons.receipt, color: AppColors.primaryBlue, size: 20),
                                          ),
                                          const SizedBox(width: 12),
                                          Expanded(
                                            child: Column(
                                              crossAxisAlignment: CrossAxisAlignment.start,
                                              children: [
                                                Text(invNum, style: const TextStyle(color: AppColors.primaryBlueLight, fontSize: 12, fontWeight: FontWeight.bold, fontFamily: 'monospace')),
                                                const SizedBox(height: 2),
                                                Text(title, style: const TextStyle(color: AppColors.textWhite, fontWeight: FontWeight.w500), maxLines: 1, overflow: TextOverflow.ellipsis),
                                              ],
                                            ),
                                          ),
                                          Column(
                                            crossAxisAlignment: CrossAxisAlignment.end,
                                            children: [
                                              Text("\$${amount.toStringAsFixed(2)}", style: const TextStyle(color: AppColors.textWhite, fontWeight: FontWeight.bold)),
                                              Text(status.toString().toUpperCase(), style: TextStyle(color: _getStatusColor(status), fontSize: 10, fontWeight: FontWeight.bold)),
                                            ],
                                          ),
                                        ],
                                      ),
                                    );
                                  },
                                );
                              },
                            ),
                          ),
                        ],
                      ),
                    ),
                  ),
                ],
              ),
            ),

            const Divider(height: 1, color: AppColors.divider),

            // FOOTER
            Padding(
              padding: const EdgeInsets.all(24),
              child: Row(
                mainAxisAlignment: MainAxisAlignment.end,
                children: [
                  TextButton(
                    onPressed: () => Navigator.of(context).pop(),
                    child: const Text("Cancel", style: TextStyle(color: AppColors.textWhite70)),
                  ),
                  const SizedBox(width: 16),
                  ElevatedButton.icon(
                    onPressed: _isLoading ? null : _submitInvoice,
                    style: ElevatedButton.styleFrom(
                      backgroundColor: AppColors.primaryBlue,
                      padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 16),
                      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
                      foregroundColor: AppColors.textWhite,
                    ),
                    icon: _isLoading 
                      ? const SizedBox(width: 16, height: 16, child: CircularProgressIndicator(strokeWidth: 2, color: AppColors.textWhite)) 
                      : const Icon(Icons.print, size: 18),
                    label: Text(_isLoading ? "Processing..." : "Generate Invoice", style: const TextStyle(fontWeight: FontWeight.bold)),
                  ),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }

  // --- UI HELPERS ---

  Widget _buildHeader() {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 32, vertical: 24),
      child: Row(
        children: [
          Container(
            padding: const EdgeInsets.all(8),
            decoration: BoxDecoration(
              color: AppColors.primaryBlue.withValues(alpha: 0.2), 
              borderRadius: BorderRadius.circular(8)
            ),
            child: const Icon(Icons.description, color: AppColors.primaryBlue),
          ),
          const SizedBox(width: 16),
          const Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text("Create Invoice", style: TextStyle(color: AppColors.textWhite, fontSize: 18, fontWeight: FontWeight.bold)),
              Text("Manually generate a bill for a student", style: TextStyle(color: AppColors.textGrey, fontSize: 13)),
            ],
          ),
          const Spacer(),
          IconButton(
            onPressed: () => Navigator.of(context).pop(),
            icon: const Icon(Icons.close, color: AppColors.textGrey),
          ),
        ],
      ),
    );
  }

  Widget _buildStudentAutocomplete() {
    return StreamBuilder<List<Map<String, dynamic>>>(
      stream: _dbService.watchStudents(widget.schoolId),
      builder: (context, snapshot) {
        if (!snapshot.hasData) return const LinearProgressIndicator(color: AppColors.primaryBlue, backgroundColor: AppColors.surfaceGrey);
        
        final students = snapshot.data!;
        
        return LayoutBuilder(
          builder: (context, constraints) {
            return Autocomplete<Map<String, dynamic>>(
              optionsBuilder: (TextEditingValue val) {
                if (val.text.isEmpty) return students;
                return students.where((s) {
                  return s['full_name'].toString().toLowerCase().contains(val.text.toLowerCase()) || 
                         (s['student_id'] ?? '').toString().toLowerCase().contains(val.text.toLowerCase());
                });
              },
              displayStringForOption: (option) => "${option['full_name']} (${option['student_id'] ?? 'N/A'})",
              onSelected: (selection) => setState(() => _selectedStudentId = selection['id']),
              
              fieldViewBuilder: (context, controller, focusNode, onFieldSubmitted) {
                return TextFormField(
                  controller: controller,
                  focusNode: focusNode,
                  style: const TextStyle(color: AppColors.textWhite),
                  decoration: InputDecoration(
                    filled: true,
                    fillColor: AppColors.surfaceGrey,
                    hintText: "Search student...",
                    hintStyle: TextStyle(color: AppColors.textWhite.withValues(alpha: 0.3)),
                    prefixIcon: const Icon(Icons.search, color: AppColors.textWhite54),
                    border: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.surfaceLightGrey)),
                    enabledBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.surfaceLightGrey)),
                    focusedBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.primaryBlue)),
                  ),
                );
              },
              optionsViewBuilder: (context, onSelected, options) {
                return Align(
                  alignment: Alignment.topLeft,
                  child: Material(
                    color: AppColors.surfaceGrey,
                    elevation: 4,
                    borderRadius: const BorderRadius.vertical(bottom: Radius.circular(8)),
                    child: Container(
                      width: constraints.maxWidth,
                      constraints: const BoxConstraints(maxHeight: 250),
                      decoration: BoxDecoration(border: Border.all(color: AppColors.surfaceLightGrey)),
                      child: ListView.builder(
                        padding: EdgeInsets.zero,
                        itemCount: options.length,
                        itemBuilder: (context, index) {
                          final option = options.elementAt(index);
                          return ListTile(
                            title: Text(option['full_name'], style: const TextStyle(color: AppColors.textWhite)),
                            subtitle: Text(option['student_id'] ?? 'No ID', style: const TextStyle(color: AppColors.textGrey, fontSize: 12)),
                            onTap: () => onSelected(option),
                            hoverColor: AppColors.textWhite.withValues(alpha: 0.1),
                          );
                        },
                      ),
                    ),
                  ),
                );
              },
            );
          }
        );
      },
    );
  }

  Widget _buildLabel(String text) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 8.0),
      child: Text(text, style: TextStyle(color: AppColors.textWhite.withValues(alpha: 0.9), fontSize: 14, fontWeight: FontWeight.w500)),
    );
  }

  Widget _buildTextField({
    required TextEditingController controller,
    required String hint,
    String? prefix,
    bool isNumber = false,
    int maxLines = 1,
    String? Function(String?)? validator,
  }) {
    return TextFormField(
      controller: controller,
      keyboardType: isNumber ? const TextInputType.numberWithOptions(decimal: true) : TextInputType.text,
      maxLines: maxLines,
      validator: validator,
      style: const TextStyle(color: AppColors.textWhite),
      decoration: InputDecoration(
        filled: true,
        fillColor: AppColors.surfaceGrey,
        hintText: hint,
        hintStyle: TextStyle(color: AppColors.textWhite.withValues(alpha: 0.3)),
        prefixText: prefix, prefixStyle: const TextStyle(color: AppColors.textWhite, fontWeight: FontWeight.bold),
        border: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.surfaceLightGrey)),
        enabledBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.surfaceLightGrey)),
        focusedBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.primaryBlue, width: 2)),
      ),
    );
  }

  Widget _buildDatePicker(BuildContext context) {
    return GestureDetector(
      onTap: () async {
        final picked = await showDatePicker(
          context: context,
          initialDate: _dueDate,
          firstDate: DateTime.now().subtract(const Duration(days: 365)),
          lastDate: DateTime.now().add(const Duration(days: 365)),
          builder: (context, child) => Theme(
            data: ThemeData.dark().copyWith(
              colorScheme: const ColorScheme.dark(
                primary: AppColors.primaryBlue,
                onPrimary: AppColors.textWhite,
                surface: AppColors.surfaceGrey,
                onSurface: AppColors.textWhite,
              ),
            ),
            child: child!,
          ),
        );
        if (picked != null) setState(() => _dueDate = picked);
      },
      child: Container(
        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 16), // Match input height
        decoration: BoxDecoration(
          color: AppColors.surfaceGrey,
          borderRadius: BorderRadius.circular(8),
          border: Border.all(color: AppColors.surfaceLightGrey),
        ),
        child: Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            Text(DateFormat('MMM dd, yyyy').format(_dueDate), style: const TextStyle(color: AppColors.textWhite)),
            const Icon(Icons.calendar_today_outlined, size: 18, color: AppColors.textWhite54),
          ],
        ),
      ),
    );
  }

  Color _getStatusColor(String status) {
    switch(status.toLowerCase()) {
      case 'paid': return AppColors.successGreen;
      case 'draft': return AppColors.textGrey;
      case 'overdue': return AppColors.errorRed;
      case 'sent': return AppColors.primaryBlueLight;
      default: return AppColors.textGrey;
    }
  }

  /// ‚úÖ NEW: Status dropdown for draft/sent selection
  Widget _buildStatusDropdown() {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 12),
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(8),
        border: Border.all(color: AppColors.surfaceLightGrey),
      ),
      child: DropdownButton<String>(
        value: _invoiceStatus,
        isExpanded: true,
        underline: const SizedBox(),
        dropdownColor: AppColors.surfaceGrey,
        style: const TextStyle(color: AppColors.textWhite),
        items: [
          DropdownMenuItem(
            value: 'draft',
            child: Row(
              children: [
                Container(
                  width: 8,
                  height: 8,
                  decoration: const BoxDecoration(
                    color: AppColors.textGrey,
                    shape: BoxShape.circle,
                  ),
                ),
                const SizedBox(width: 8),
                const Text('Draft', style: TextStyle(color: AppColors.textWhite)),
              ],
            ),
          ),
          DropdownMenuItem(
            value: 'sent',
            child: Row(
              children: [
                Container(
                  width: 8,
                  height: 8,
                  decoration: const BoxDecoration(
                    color: AppColors.primaryBlueLight,
                    shape: BoxShape.circle,
                  ),
                ),
                const SizedBox(width: 8),
                const Text('Sent', style: TextStyle(color: AppColors.textWhite)),
              ],
            ),
          ),
        ],
        onChanged: (value) {
          if (value != null) {
            setState(() => _invoiceStatus = value);
          }
        },
      ),
    );
  }
}
// ==========================================
// FILE: ./settings/users_permissions_view.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../../core/constants/app_colors.dart';
import '../../../../data/providers/dashboard_provider.dart';
import '../../../../data/providers/users_provider.dart';
import 'add_user_dialog.dart';

class UsersPermissionsView extends ConsumerStatefulWidget {
  const UsersPermissionsView({super.key});

  @override
  ConsumerState<UsersPermissionsView> createState() => _UsersPermissionsViewState();
}

class _UsersPermissionsViewState extends ConsumerState<UsersPermissionsView> {
  // --- Local State for Filters ---
  String _searchQuery = "";
  String _selectedRole = "All Roles";
  String _selectedStatus = "All Status";

  @override
  Widget build(BuildContext context) {
    final usersAsync = ref.watch(schoolUsersProvider);
    final dashboardAsync = ref.watch(dashboardDataProvider);

    return Column(
      children: [
        // 1. FILTER & ACTION BAR
        Row(
          children: [
            // Search Field
            Expanded(
              child: _buildSearchField(),
            ),
            const SizedBox(width: 16),
            
            // Role Dropdown
            _buildDropdown(
              value: _selectedRole,
              items: ["All Roles", "School Admin", "Teacher", "Student"],
              onChanged: (val) => setState(() => _selectedRole = val!),
            ),
            const SizedBox(width: 16),
            
            // Status Dropdown
            _buildDropdown(
              value: _selectedStatus,
              items: ["All Status", "Active", "Banned"],
              onChanged: (val) => setState(() => _selectedStatus = val!),
            ),
            const SizedBox(width: 16),
            
            // Export Button
            OutlinedButton.icon(
              onPressed: () {},
              icon: const Icon(Icons.download, size: 16),
              label: const Text("Export"),
              style: OutlinedButton.styleFrom(
                foregroundColor: AppColors.textWhite,
                side: const BorderSide(color: AppColors.divider),
                padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 18),
              ),
            ),
            const SizedBox(width: 16),
            
            // Add User Button
            ElevatedButton.icon(
              onPressed: () {
                dashboardAsync.whenData((data) {
                  showDialog(
                    context: context,
                    builder: (_) => AddUserDialog(schoolId: data.schoolId),
                  );
                });
              },
              icon: const Icon(Icons.person_add, size: 16),
              label: const Text("Add User"),
              style: ElevatedButton.styleFrom(
                backgroundColor: AppColors.primaryBlue,
                foregroundColor: Colors.white,
                padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 18),
              ),
            ),
          ],
        ),
        const SizedBox(height: 24),

        // 2. USERS TABLE
        Container(
          decoration: BoxDecoration(
            color: AppColors.surfaceGrey,
            borderRadius: BorderRadius.circular(12),
            border: Border.all(color: AppColors.divider),
          ),
          child: Column(
            children: [
              _buildTableHeader(),
              const Divider(height: 1, color: AppColors.divider),
              
              usersAsync.when(
                loading: () => const Padding(
                  padding: EdgeInsets.all(40), 
                  child: CircularProgressIndicator(color: AppColors.primaryBlue),
                ),
                error: (e, _) => Padding(
                  padding: const EdgeInsets.all(40), 
                  child: Text("Error: $e", style: const TextStyle(color: AppColors.errorRed)),
                ),
                data: (allUsers) {
                  // --- FILTER LOGIC ---
                  final filteredUsers = allUsers.where((user) {
                    final name = (user['full_name'] ?? '').toString().toLowerCase();
                    final email = (user['email'] ?? '').toString().toLowerCase();
                    final role = (user['role'] ?? '').toString().toLowerCase();
                    final isBanned = user['status'] == true; // SQL maps is_banned -> status

                    // 1. Search Filter
                    if (_searchQuery.isNotEmpty) {
                      if (!name.contains(_searchQuery.toLowerCase()) && 
                          !email.contains(_searchQuery.toLowerCase())) {
                        return false;
                      }
                    }

                    // 2. Role Filter
                    if (_selectedRole != "All Roles") {
                      // Map UI string to DB value
                      String requiredRole = _selectedRole.toLowerCase().replaceAll(" ", "_");
                      if (role != requiredRole) return false;
                    }

                    // 3. Status Filter
                    if (_selectedStatus != "All Status") {
                      if (_selectedStatus == "Active" && isBanned) return false;
                      if (_selectedStatus == "Banned" && !isBanned) return false;
                    }

                    return true;
                  }).toList();

                  if (filteredUsers.isEmpty) {
                    return const Padding(
                      padding: EdgeInsets.all(40), 
                      child: Text("No users found matching filters.", style: TextStyle(color: AppColors.textWhite54)),
                    );
                  }

                  return ListView.separated(
                    shrinkWrap: true,
                    physics: const NeverScrollableScrollPhysics(),
                    itemCount: filteredUsers.length,
                    separatorBuilder: (_, __) => const Divider(height: 1, color: AppColors.divider),
                    itemBuilder: (ctx, index) => _UserRow(user: filteredUsers[index]),
                  );
                },
              ),
            ],
          ),
        ),
      ],
    );
  }

  // --- WIDGET HELPERS ---

  Widget _buildSearchField() {
    return SizedBox(
      height: 44,
      child: TextField(
        textAlignVertical: TextAlignVertical.center,
        style: const TextStyle(color: AppColors.textWhite),
        onChanged: (val) => setState(() => _searchQuery = val), // Updates State
        decoration: InputDecoration(
          isDense: true,
          filled: true,
          fillColor: AppColors.backgroundBlack,
          hintText: "Search by name, email...",
          hintStyle: const TextStyle(color: AppColors.textWhite38, fontSize: 13),
          prefixIcon: const Icon(Icons.search, color: AppColors.textWhite38, size: 18),
          contentPadding: EdgeInsets.zero,
          border: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.divider)),
          enabledBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.divider)),
          focusedBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.primaryBlue)),
        ),
      ),
    );
  }

  Widget _buildDropdown({
    required String value, 
    required List<String> items, 
    required Function(String?) onChanged
  }) {
    return Container(
      height: 44,
      padding: const EdgeInsets.symmetric(horizontal: 16),
      decoration: BoxDecoration(
        color: AppColors.backgroundBlack,
        borderRadius: BorderRadius.circular(8),
        border: Border.all(color: AppColors.divider),
      ),
      child: DropdownButtonHideUnderline(
        child: DropdownButton<String>(
          value: items.contains(value) ? value : items.first,
          dropdownColor: AppColors.surfaceGrey,
          icon: const Icon(Icons.keyboard_arrow_down, color: AppColors.textWhite54, size: 16),
          style: const TextStyle(color: AppColors.textWhite, fontSize: 13),
          onChanged: onChanged,
          items: items.map((e) => DropdownMenuItem(value: e, child: Text(e))).toList(),
        ),
      ),
    );
  }

  Widget _buildTableHeader() {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 16),
      child: Row(
        children: [
          _col("USER PROFILE", 3),
          _col("ROLE", 2),
          _col("ASSOCIATIONS", 2),
          _col("PERMISSIONS", 2),
          _col("STATUS", 2),
          _col("", 1), // Actions
        ],
      ),
    );
  }

  Widget _col(String text, int flex) {
    return Expanded(
      flex: flex,
      child: Text(
        text,
        style: const TextStyle(color: AppColors.textWhite38, fontSize: 11, fontWeight: FontWeight.bold, letterSpacing: 0.8),
      ),
    );
  }
}

class _UserRow extends ConsumerWidget {
  final Map<String, dynamic> user;
  const _UserRow({required this.user});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final name = user['full_name'] ?? 'Unknown';
    final email = user['email'] ?? '';
    final role = user['role'] ?? 'student';
    final isBanned = user['status'] == true;
    final isActive = !isBanned;

    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 16),
      child: Row(
        children: [
          // 1. Profile
          Expanded(
            flex: 3,
            child: Row(
              children: [
                CircleAvatar(
                  radius: 18,
                  backgroundColor: _getRoleColor(role).withValues(alpha: 0.2),
                  child: Text(name.isNotEmpty ? name.substring(0, 1).toUpperCase() : "?", 
                    style: TextStyle(color: _getRoleColor(role), fontWeight: FontWeight.bold)),
                ),
                const SizedBox(width: 12),
                Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(name, style: const TextStyle(color: AppColors.textWhite, fontWeight: FontWeight.w500, fontSize: 13)),
                    Text(email, style: const TextStyle(color: AppColors.textWhite38, fontSize: 11)),
                  ],
                ),
              ],
            ),
          ),
          
          // 2. Role Badge
          Expanded(
            flex: 2,
            child: Row(
              children: [
                Container(
                  padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                  decoration: BoxDecoration(
                    color: _getRoleColor(role).withValues(alpha: 0.1),
                    borderRadius: BorderRadius.circular(4),
                    border: Border.all(color: _getRoleColor(role).withValues(alpha: 0.3)),
                  ),
                  child: Text(
                    _formatRole(role),
                    style: TextStyle(color: _getRoleColor(role), fontSize: 11, fontWeight: FontWeight.bold),
                  ),
                ),
              ],
            ),
          ),

          // 3. Associations
          const Expanded(
            flex: 2,
            child: Text("Global / 5 Classes", style: TextStyle(color: AppColors.textWhite70, fontSize: 12)),
          ),

          // 4. Permissions
          Expanded(
            flex: 2,
            child: Text(
              role == 'school_admin' ? "Full System Access" : "Limited (Academic)", 
              style: const TextStyle(color: AppColors.textWhite54, fontSize: 12)
            ),
          ),

          // 5. Status Toggle
          Expanded(
            flex: 2,
            child: Row(
              children: [
                Switch(
                  value: isActive,
                  activeThumbColor: AppColors.primaryBlue,
                  activeTrackColor: AppColors.primaryBlue.withValues(alpha: 0.3),
                  inactiveThumbColor: AppColors.surfaceLightGrey,
                  inactiveTrackColor: AppColors.surfaceDarkGrey,
                  onChanged: (val) async {
                    final dashboard = await ref.read(dashboardDataProvider.future);
                    await ref.read(usersRepositoryProvider).toggleStatus(
                      userId: user['id'],
                      schoolId: dashboard.schoolId,
                      ban: !val,
                    );
                    // ignore: unused_result
                    ref.refresh(schoolUsersProvider);
                  },
                ),
                const SizedBox(width: 8),
                Text(
                  isActive ? "Active" : "Banned",
                  style: TextStyle(color: isActive ? AppColors.successGreen : AppColors.errorRed, fontSize: 12, fontWeight: FontWeight.bold),
                ),
              ],
            ),
          ),

          // 6. Actions
          Expanded(
            flex: 1,
            child: Row(
              mainAxisAlignment: MainAxisAlignment.end,
              children: [
                TextButton(
                  onPressed: () {}, 
                  child: const Text("Edit", style: TextStyle(color: AppColors.primaryBlue, fontSize: 12))
                ),
                const Icon(Icons.more_vert, size: 16, color: AppColors.textWhite54),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Color _getRoleColor(String role) {
    switch (role) {
      case 'school_admin': return AppColors.errorRed; 
      case 'teacher': return AppColors.successGreen;
      case 'student': return AppColors.textGrey;
      default: return AppColors.primaryBlue;
    }
  }

  String _formatRole(String role) {
    return role.replaceAll('_', ' ').split(' ').map((str) => str.isNotEmpty ? str[0].toUpperCase() + str.substring(1) : str).join(' ');
  }
}
// ==========================================
// FILE: ./settings/organization_card.dart
// ==========================================

import 'dart:convert';
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../../core/constants/app_colors.dart';
import '../../../data/providers/dashboard_provider.dart';
import '../../../data/services/database_service.dart';

class OrganizationCard extends ConsumerStatefulWidget {
  const OrganizationCard({super.key});

  @override
  ConsumerState<OrganizationCard> createState() => _OrganizationCardState();
}

class _OrganizationCardState extends ConsumerState<OrganizationCard> {
  final _nameController = TextEditingController();
  final _addressController = TextEditingController();
  final _emailController = TextEditingController();
  final _logoController = TextEditingController();

  bool _hydrated = false;
  bool _saving = false;
  Map<String, dynamic>? _schoolData;

  @override
  void dispose() {
    _nameController.dispose();
    _addressController.dispose();
    _emailController.dispose();
    _logoController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final dashboardAsync = ref.watch(dashboardDataProvider);

    return dashboardAsync.when(
      loading: () => _loadingCard(),
      error: (err, _) => _errorCard('Error loading school: $err'),
      data: (dashboard) {
        if (dashboard.schoolId.isEmpty) {
          return _errorCard('No school context');
        }

        if (!_hydrated) {
          _loadSchoolData(dashboard.schoolId);
        }

        return _buildContent(context, dashboard.schoolId);
      },
    );
  }

  Widget _buildContent(BuildContext context, String schoolId) {
    return Container(
      padding: const EdgeInsets.all(24),
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: AppColors.divider),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              const Text("Organization",
                  style: TextStyle(
                      color: AppColors.textWhite,
                      fontSize: 16,
                      fontWeight: FontWeight.bold)),
              Container(
                padding: const EdgeInsets.all(6),
                decoration: BoxDecoration(
                    color: Colors.purple.withValues(alpha: 0.1),
                    borderRadius: BorderRadius.circular(6)),
                child:
                    const Icon(Icons.business, color: Colors.purple, size: 18),
              ),
            ],
          ),
          const SizedBox(height: 4),
          const Text("Public details.",
              style: TextStyle(color: AppColors.textWhite54, fontSize: 12)),
          const SizedBox(height: 24),
          _buildInput("School Name", _nameController),
          const SizedBox(height: 16),
          _buildInput("Address", _addressController, maxLines: 3),
          const SizedBox(height: 16),
          _buildInput("Contact Email", _emailController),
          const SizedBox(height: 16),
          _buildInput("Logo URL", _logoController,
              helper: "Public image link for invoices and dashboards."),
          const SizedBox(height: 16),
          if (_logoController.text.isNotEmpty) _buildLogoPreview(),
          const SizedBox(height: 24),
          Row(
            mainAxisAlignment: MainAxisAlignment.end,
            children: [
              TextButton(
                onPressed: _hydrated && _schoolData != null
                    ? () => _loadSchoolData(schoolId, force: true)
                    : null,
                child: const Text('Reset'),
              ),
              const SizedBox(width: 12),
              ElevatedButton(
                onPressed: _saving ? null : () => _onSave(context, schoolId),
                child: _saving
                    ? const SizedBox(
                        width: 18,
                        height: 18,
                        child: CircularProgressIndicator(strokeWidth: 2),
                      )
                    : const Text('Save'),
              ),
            ],
          ),
        ],
      ),
    );
  }

  Future<void> _loadSchoolData(String schoolId, {bool force = false}) async {
    if (_hydrated && !force) return;

    try {
      final db = DatabaseService();
      final results = await db.db.getAll(
        'SELECT * FROM schools WHERE id = ?',
        [schoolId],
      );

      if (results.isEmpty) {
        if (mounted) setState(() => _hydrated = true);
        return;
      }

      final school = results.first;
      _schoolData = school;

      // Parse address/email from JSON if stored there, otherwise use separate columns if they exist
      String address = school['address'] as String? ?? '';
      String email = school['contact_email'] as String? ?? '';
      String logoUrl = school['logo_url'] as String? ?? '';

      // Check if there's a contact_info JSON field
      final contactInfoRaw = school['contact_info'] as String? ?? '';
      if (contactInfoRaw.isNotEmpty) {
        try {
          final contactInfo =
              jsonDecode(contactInfoRaw) as Map<String, dynamic>;
          address = contactInfo['address'] as String? ?? '';
          email = contactInfo['email'] as String? ?? '';
          logoUrl = contactInfo['logo'] as String? ?? logoUrl;
        } catch (_) {}
      }

      if (mounted) {
        setState(() {
          _nameController.text = school['name'] as String? ?? '';
          _addressController.text = address;
          _emailController.text = email;
          _logoController.text = logoUrl;
          _hydrated = true;
        });
      }
    } catch (e) {
      debugPrint('‚ö†Ô∏è Error loading school data: $e');
      if (mounted) setState(() => _hydrated = true);
    }
  }

  Future<void> _onSave(BuildContext context, String schoolId) async {
    setState(() => _saving = true);

    try {
      final db = DatabaseService();

      // Store contact info as JSON in a text field
      final contactInfo = jsonEncode({
        'address': _addressController.text.trim(),
        'email': _emailController.text.trim(),
        'logo': _logoController.text.trim(),
      });

      // Check if contact_info column exists, if not just update name
      try {
        await db.db.execute(
          '''UPDATE schools 
             SET name = ?, contact_info = ?, logo_url = ?
             WHERE id = ?''',
          [
            _nameController.text.trim(),
            contactInfo,
            _logoController.text.trim(),
            schoolId,
          ],
        );
      } catch (_) {
        // contact_info column doesn't exist, just update name
        await db.db.execute(
          'UPDATE schools SET name = ? WHERE id = ?',
          [_nameController.text.trim(), schoolId],
        );
      }

      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(content: Text('Organization details updated')),
        );
      }
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text('Failed to save: $e')),
        );
      }
    } finally {
      if (mounted) setState(() => _saving = false);
    }
  }

  Widget _buildLogoPreview() {
    final logoUrl = _logoController.text.trim();
    if (logoUrl.isEmpty) return const SizedBox.shrink();

    // Check if it's a Supabase storage path (filename without full URL)
    String displayUrl = logoUrl;
    if (!logoUrl.startsWith('http')) {
      // Assume it's a Supabase avatars bucket path
      // Format: https://<supabase-url>/storage/v1/object/public/avatars/<filename>
      displayUrl =
          'https://fzopzlktsvmgskrqpgma.supabase.co/storage/v1/object/public/avatars/$logoUrl';
    }

    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        const Text("Logo Preview",
            style: TextStyle(color: AppColors.textWhite70, fontSize: 13)),
        const SizedBox(height: 8),
        Container(
          padding: const EdgeInsets.all(16),
          decoration: BoxDecoration(
            color: AppColors.backgroundBlack,
            borderRadius: BorderRadius.circular(8),
            border: Border.all(color: AppColors.divider),
          ),
          child: ClipRRect(
            borderRadius: BorderRadius.circular(6),
            child: Image.network(
              displayUrl,
              width: 120,
              height: 120,
              fit: BoxFit.cover,
              loadingBuilder: (context, child, loadingProgress) {
                if (loadingProgress == null) return child;
                return Container(
                  width: 120,
                  height: 120,
                  decoration: BoxDecoration(
                    color: AppColors.surfaceGrey,
                    borderRadius: BorderRadius.circular(6),
                  ),
                  child: const Center(
                    child: CircularProgressIndicator(strokeWidth: 2),
                  ),
                );
              },
              errorBuilder: (context, error, stackTrace) {
                return Container(
                  width: 120,
                  height: 120,
                  decoration: BoxDecoration(
                    color: AppColors.surfaceGrey,
                    borderRadius: BorderRadius.circular(6),
                  ),
                  child: const Center(
                    child: Column(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        Icon(Icons.image_not_supported,
                            color: AppColors.warningOrange),
                        SizedBox(height: 4),
                        Text("Image not found",
                            style: TextStyle(
                                color: AppColors.textWhite38, fontSize: 11)),
                      ],
                    ),
                  ),
                );
              },
            ),
          ),
        ),
      ],
    );
  }

  Widget _buildInput(String label, TextEditingController controller,
      {int maxLines = 1, String? helper}) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(label,
            style: const TextStyle(color: AppColors.textWhite70, fontSize: 13)),
        const SizedBox(height: 8),
        TextFormField(
          controller: controller,
          maxLines: maxLines,
          style: const TextStyle(color: AppColors.textWhite),
          decoration: InputDecoration(
            filled: true,
            fillColor: AppColors.backgroundBlack,
            contentPadding: const EdgeInsets.all(16),
            border: OutlineInputBorder(
                borderRadius: BorderRadius.circular(8),
                borderSide: const BorderSide(color: AppColors.divider)),
            enabledBorder: OutlineInputBorder(
                borderRadius: BorderRadius.circular(8),
                borderSide: const BorderSide(color: AppColors.divider)),
            focusedBorder: OutlineInputBorder(
                borderRadius: BorderRadius.circular(8),
                borderSide: const BorderSide(color: AppColors.primaryBlue)),
          ),
        ),
        if (helper != null) ...[
          const SizedBox(height: 6),
          Text(helper,
              style:
                  const TextStyle(color: AppColors.textWhite38, fontSize: 11)),
        ]
      ],
    );
  }

  Widget _loadingCard() {
    return Container(
      padding: const EdgeInsets.all(48),
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: AppColors.divider),
      ),
      child: const Center(
        child: CircularProgressIndicator(),
      ),
    );
  }

  Widget _errorCard(String message) {
    return Container(
      padding: const EdgeInsets.all(24),
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: AppColors.warningOrange),
      ),
      child: Row(
        children: [
          const Icon(Icons.error_outline, color: AppColors.warningOrange),
          const SizedBox(width: 12),
          Expanded(
            child: Text(
              message,
              style: const TextStyle(color: AppColors.warningOrange),
            ),
          ),
        ],
      ),
    );
  }
}

// ==========================================
// FILE: ./settings/notifications_settings_view.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../../core/constants/app_colors.dart';
import '../../../data/providers/dashboard_provider.dart';
import '../../../data/providers/notification_preferences_provider.dart';

class NotificationsSettingsView extends ConsumerStatefulWidget {
  const NotificationsSettingsView({super.key});

  @override
  ConsumerState<NotificationsSettingsView> createState() =>
      _NotificationsSettingsViewState();
}

class _NotificationsSettingsViewState
    extends ConsumerState<NotificationsSettingsView> {
  bool _hydrated = false;
  String? _hydratedSchoolId;
  bool _saving = false;

  bool _billingInApp = true;
  bool _billingEmail = true;
  String _billingFreq = "Immediate";

  bool _campaignInApp = true;
  bool _campaignEmail = false;

  bool _attendanceInApp = true;
  bool _attendanceEmail = false;

  bool _announceInApp = true;
  bool _announceEmail = true;

  bool _channelEmail = true;
  bool _channelPush = true;
  bool _channelSMS = false;

  bool _dndEnabled = false;
  final TimeOfDay _dndStart = const TimeOfDay(hour: 22, minute: 0);
  final TimeOfDay _dndEnd = const TimeOfDay(hour: 7, minute: 0);

  @override
  Widget build(BuildContext context) {
    final dashboardAsync = ref.watch(dashboardDataProvider);

    return dashboardAsync.when(
      loading: _buildLoading,
      error: (err, _) => _buildError('Error loading dashboard: $err'),
      data: (dashboard) {
        final schoolId = dashboard.schoolId;
        if (schoolId.isEmpty) {
          return _buildError('No school context');
        }

        final prefsAsync = ref.watch(notificationPreferencesProvider(schoolId));
        return prefsAsync.when(
          loading: _buildLoading,
          error: (err, _) =>
              _buildError('Error loading notification preferences: $err'),
          data: (prefs) {
            if (!_hydrated || _hydratedSchoolId != schoolId) {
              WidgetsBinding.instance.addPostFrameCallback((_) {
                if (!mounted) return;
                setState(() => _applyPrefs(prefs, schoolId));
              });
            }
            return _buildContent(schoolId, prefs);
          },
        );
      },
    );
  }

  Widget _buildContent(String schoolId, NotificationPreferences prefs) {
    return Row(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        // --- LEFT COLUMN: PREFERENCES ---
        Expanded(
          flex: 3,
          child: Container(
            padding: const EdgeInsets.all(24),
            decoration: BoxDecoration(
              color: AppColors.surfaceGrey,
              borderRadius: BorderRadius.circular(12),
              border: Border.all(color: AppColors.divider),
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: [
                    const Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text("Notification Preferences",
                            style: TextStyle(
                                color: AppColors.textWhite,
                                fontSize: 16,
                                fontWeight: FontWeight.bold)),
                        SizedBox(height: 4),
                        Text("Manage what alerts you receive and how.",
                            style: TextStyle(
                                color: AppColors.textWhite54, fontSize: 13)),
                      ],
                    ),
                    IconButton(
                      onPressed: () {},
                      icon:
                          const Icon(Icons.tune, color: AppColors.primaryBlue),
                      tooltip: "Advanced Filters",
                    )
                  ],
                ),
                const SizedBox(height: 24),
                _NotificationGroupTile(
                  title: "Billing & Finance",
                  subtitle:
                      "Alerts for invoice payments, late fees, and daily totals.",
                  icon: Icons.payments,
                  iconColor: AppColors.successGreen,
                  inAppVal: _billingInApp,
                  emailVal: _billingEmail,
                  onInAppChanged: (v) => setState(() => _billingInApp = v),
                  onEmailChanged: (v) => setState(() => _billingEmail = v),
                  extraContent: _buildDropdownRow(
                      "EMAIL FREQUENCY",
                      _billingFreq,
                      ["Immediate", "Daily Digest", "Weekly Summary"]),
                ),
                const Divider(color: AppColors.divider, height: 1),
                _NotificationGroupTile(
                  title: "Campaign Updates",
                  subtitle:
                      "Status changes for fundraising and marketing campaigns.",
                  icon: Icons.campaign,
                  iconColor: AppColors.accentPurple,
                  inAppVal: _campaignInApp,
                  emailVal: _campaignEmail,
                  onInAppChanged: (v) => setState(() => _campaignInApp = v),
                  onEmailChanged: (v) => setState(() => _campaignEmail = v),
                ),
                const Divider(color: AppColors.divider, height: 1),
                _NotificationGroupTile(
                  title: "Attendance Issues",
                  subtitle:
                      "Critical absentee alerts and staff attendance logs.",
                  icon: Icons.warning_amber_rounded,
                  iconColor: AppColors.warningOrange,
                  inAppVal: _attendanceInApp,
                  emailVal: _attendanceEmail,
                  onInAppChanged: (v) => setState(() => _attendanceInApp = v),
                  onEmailChanged: (v) => setState(() => _attendanceEmail = v),
                ),
                const Divider(color: AppColors.divider, height: 1),
                _NotificationGroupTile(
                  title: "General Announcements",
                  subtitle: "System-wide messages from administration.",
                  icon: Icons.campaign_outlined,
                  iconColor: AppColors.primaryBlue,
                  inAppVal: _announceInApp,
                  emailVal: _announceEmail,
                  onInAppChanged: (v) => setState(() => _announceInApp = v),
                  onEmailChanged: (v) => setState(() => _announceEmail = v),
                ),
              ],
            ),
          ),
        ),

        const SizedBox(width: 24),

        // --- RIGHT COLUMN: GLOBAL & DND ---
        Expanded(
          flex: 2,
          child: Column(
            children: [
              Container(
                padding: const EdgeInsets.all(24),
                decoration: BoxDecoration(
                  color: AppColors.surfaceGrey,
                  borderRadius: BorderRadius.circular(12),
                  border: Border.all(color: AppColors.divider),
                ),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    const Text("Global Delivery Channels",
                        style: TextStyle(
                            color: AppColors.textWhite,
                            fontSize: 14,
                            fontWeight: FontWeight.bold)),
                    const SizedBox(height: 24),
                    _DeliveryChannelTile(
                        icon: Icons.email,
                        title: "Email",
                        subtitle: "Send to primary address",
                        value: _channelEmail,
                        onChanged: (v) => setState(() => _channelEmail = v)),
                    const SizedBox(height: 20),
                    _DeliveryChannelTile(
                        icon: Icons.smartphone,
                        title: "Push Notifications",
                        subtitle: "Browser & mobile app",
                        value: _channelPush,
                        onChanged: (v) => setState(() => _channelPush = v)),
                    const SizedBox(height: 20),
                    _DeliveryChannelTile(
                      icon: Icons.sms,
                      title: "SMS Alerts",
                      subtitle: "Premium plan only",
                      value: _channelSMS,
                      onChanged: (v) => setState(() => _channelSMS = v),
                      isDisabled: true,
                    ),
                  ],
                ),
              ),
              const SizedBox(height: 24),
              Container(
                padding: const EdgeInsets.all(24),
                decoration: BoxDecoration(
                  color: AppColors.backgroundBlack,
                  borderRadius: BorderRadius.circular(12),
                  border: Border.all(color: AppColors.divider),
                ),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    const Row(
                      mainAxisAlignment: MainAxisAlignment.spaceBetween,
                      children: [
                        Text("Do Not Disturb",
                            style: TextStyle(
                                color: AppColors.textWhite,
                                fontSize: 14,
                                fontWeight: FontWeight.bold)),
                        Icon(Icons.dark_mode, color: Colors.amber, size: 18),
                      ],
                    ),
                    const SizedBox(height: 24),
                    Row(
                      mainAxisAlignment: MainAxisAlignment.spaceBetween,
                      children: [
                        const Text("Pause all notifications",
                            style: TextStyle(
                                color: AppColors.textWhite, fontSize: 13)),
                        Switch(
                          value: _dndEnabled,
                          onChanged: (v) => setState(() => _dndEnabled = v),
                          activeThumbColor: AppColors.primaryBlue,
                          activeTrackColor:
                              AppColors.primaryBlue.withValues(alpha: 0.3),
                          inactiveThumbColor: AppColors.textWhite,
                          inactiveTrackColor: AppColors.surfaceGrey,
                        ),
                      ],
                    ),
                    const SizedBox(height: 16),
                    Row(
                      children: [
                        Expanded(child: _buildTimePicker("From", _dndStart)),
                        const SizedBox(width: 16),
                        Expanded(child: _buildTimePicker("To", _dndEnd)),
                      ],
                    ),
                    const SizedBox(height: 16),
                    const Text(
                      "During this time, notifications will be muted and delivered quietly to your in-app inbox.",
                      style: TextStyle(
                          color: AppColors.textWhite38,
                          fontSize: 11,
                          height: 1.4),
                    ),
                  ],
                ),
              ),
              const SizedBox(height: 24),
              Row(
                children: [
                  Expanded(
                    child: ElevatedButton(
                      onPressed: _saving ? null : () => _onSave(schoolId),
                      style: ElevatedButton.styleFrom(
                        backgroundColor: AppColors.primaryBlue,
                        padding: const EdgeInsets.symmetric(vertical: 16),
                        shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(8)),
                      ),
                      child: _saving
                          ? const SizedBox(
                              height: 18,
                              width: 18,
                              child: CircularProgressIndicator(strokeWidth: 2),
                            )
                          : const Text("Save Changes",
                              style: TextStyle(
                                  color: Colors.white,
                                  fontWeight: FontWeight.bold)),
                    ),
                  ),
                  const SizedBox(width: 16),
                  Expanded(
                    child: OutlinedButton(
                      onPressed: () {
                        setState(() => _applyPrefs(prefs, schoolId));
                      },
                      style: OutlinedButton.styleFrom(
                        side: const BorderSide(color: AppColors.divider),
                        padding: const EdgeInsets.symmetric(vertical: 16),
                        shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(8)),
                      ),
                      child: const Text("Reset",
                          style: TextStyle(color: AppColors.textWhite)),
                    ),
                  ),
                ],
              ),
            ],
          ),
        ),
      ],
    );
  }

  // --- HELPERS ---

  Widget _buildDropdownRow(String label, String value, List<String> items) {
    return Row(
      mainAxisAlignment: MainAxisAlignment.spaceBetween,
      children: [
        Text(label,
            style: const TextStyle(
                color: AppColors.textWhite38,
                fontSize: 11,
                fontWeight: FontWeight.bold,
                letterSpacing: 0.5)),
        Container(
          height: 32,
          padding: const EdgeInsets.symmetric(horizontal: 12),
          decoration: BoxDecoration(
            color: AppColors.backgroundBlack,
            borderRadius: BorderRadius.circular(6),
            border: Border.all(color: AppColors.divider),
          ),
          child: DropdownButtonHideUnderline(
            child: DropdownButton<String>(
              value: value,
              dropdownColor: AppColors.surfaceGrey,
              icon: const Icon(Icons.keyboard_arrow_down,
                  size: 16, color: AppColors.textWhite54),
              style: const TextStyle(color: AppColors.textWhite, fontSize: 12),
              items: items
                  .map((e) => DropdownMenuItem(value: e, child: Text(e)))
                  .toList(),
              onChanged: (v) => setState(() => _billingFreq = v!),
            ),
          ),
        ),
      ],
    );
  }

  Widget _buildTimePicker(String label, TimeOfDay time) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(label,
            style: const TextStyle(color: AppColors.textWhite54, fontSize: 11)),
        const SizedBox(height: 6),
        Container(
          padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 10),
          decoration: BoxDecoration(
            color: AppColors.backgroundBlack,
            borderRadius: BorderRadius.circular(6),
            border: Border.all(color: AppColors.divider),
          ),
          child: Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Text(time.format(context),
                  style: const TextStyle(
                      color: AppColors.textWhite, fontSize: 13)),
              const Icon(Icons.access_time,
                  size: 14, color: AppColors.textWhite38),
            ],
          ),
        ),
      ],
    );
  }

  NotificationPreferences _prefsFromState() {
    return NotificationPreferences(
      billingInApp: _billingInApp,
      billingEmail: _billingEmail,
      billingFreq: _billingFreq,
      campaignInApp: _campaignInApp,
      campaignEmail: _campaignEmail,
      attendanceInApp: _attendanceInApp,
      attendanceEmail: _attendanceEmail,
      announceInApp: _announceInApp,
      announceEmail: _announceEmail,
      channelEmail: _channelEmail,
      channelPush: _channelPush,
      channelSMS: _channelSMS,
      dndEnabled: _dndEnabled,
      dndStart:
          '${_dndStart.hour.toString().padLeft(2, '0')}:${_dndStart.minute.toString().padLeft(2, '0')}',
      dndEnd:
          '${_dndEnd.hour.toString().padLeft(2, '0')}:${_dndEnd.minute.toString().padLeft(2, '0')}',
    );
  }

  void _applyPrefs(NotificationPreferences prefs, String schoolId) {
    _billingInApp = prefs.billingInApp;
    _billingEmail = prefs.billingEmail;
    _billingFreq = prefs.billingFreq;
    _campaignInApp = prefs.campaignInApp;
    _campaignEmail = prefs.campaignEmail;
    _attendanceInApp = prefs.attendanceInApp;
    _attendanceEmail = prefs.attendanceEmail;
    _announceInApp = prefs.announceInApp;
    _announceEmail = prefs.announceEmail;
    _channelEmail = prefs.channelEmail;
    _channelPush = prefs.channelPush;
    _channelSMS = prefs.channelSMS;
    _dndEnabled = prefs.dndEnabled;
    _hydrated = true;
    _hydratedSchoolId = schoolId;
  }

  Future<void> _onSave(String schoolId) async {
    setState(() => _saving = true);
    final notifier =
        ref.read(notificationPreferencesProvider(schoolId).notifier);
    final prefs = _prefsFromState();

    try {
      await notifier.savePreferences(prefs);
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(content: Text('Notification preferences saved')),
        );
      }
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text('Failed to save: $e')),
        );
      }
    } finally {
      if (mounted) setState(() => _saving = false);
    }
  }

  Widget _buildLoading() {
    return const Center(child: CircularProgressIndicator());
  }

  Widget _buildError(String message) {
    return Container(
      padding: const EdgeInsets.all(24),
      decoration: BoxDecoration(
        color: AppColors.backgroundBlack,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: AppColors.warningOrange),
      ),
      child: Row(
        children: [
          const Icon(Icons.error_outline, color: AppColors.warningOrange),
          const SizedBox(width: 12),
          Expanded(
            child: Text(
              message,
              style: const TextStyle(color: AppColors.warningOrange),
            ),
          ),
        ],
      ),
    );
  }
}

// --- PRIVATE WIDGETS FOR FRAGMENTATION ---

class _NotificationGroupTile extends StatelessWidget {
  final String title;
  final String subtitle;
  final IconData icon;
  final Color iconColor;
  final bool inAppVal;
  final bool emailVal;
  final Function(bool) onInAppChanged;
  final Function(bool) onEmailChanged;
  final Widget? extraContent;

  const _NotificationGroupTile({
    required this.title,
    required this.subtitle,
    required this.icon,
    required this.iconColor,
    required this.inAppVal,
    required this.emailVal,
    required this.onInAppChanged,
    required this.onEmailChanged,
    this.extraContent,
  });

  @override
  Widget build(BuildContext context) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 24),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Container(
            padding: const EdgeInsets.all(10),
            decoration: BoxDecoration(
              color: iconColor.withValues(alpha: 0.1),
              borderRadius: BorderRadius.circular(8),
            ),
            child: Icon(icon, color: iconColor, size: 20),
          ),
          const SizedBox(width: 16),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(title,
                    style: const TextStyle(
                        color: AppColors.textWhite,
                        fontSize: 14,
                        fontWeight: FontWeight.bold)),
                const SizedBox(height: 4),
                Text(subtitle,
                    style: const TextStyle(
                        color: AppColors.textWhite54, fontSize: 12)),
                const SizedBox(height: 16),

                // Toggles Row
                _buildToggleRow(
                    "In-App Notifications", inAppVal, onInAppChanged),
                const SizedBox(height: 12),
                _buildToggleRow("Email Alerts", emailVal, onEmailChanged),

                if (extraContent != null) ...[
                  const SizedBox(height: 16),
                  const Divider(color: AppColors.divider),
                  const SizedBox(height: 16),
                  extraContent!,
                ],
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildToggleRow(String label, bool val, Function(bool) onChange) {
    return Row(
      mainAxisAlignment: MainAxisAlignment.spaceBetween,
      children: [
        Text(label,
            style: const TextStyle(color: AppColors.textWhite70, fontSize: 13)),
        SizedBox(
          height: 24,
          child: Switch(
            value: val,
            onChanged: onChange,
            activeThumbColor: Colors.white,
            activeTrackColor: AppColors.primaryBlue,
            inactiveThumbColor: AppColors.textWhite,
            inactiveTrackColor: AppColors.backgroundBlack,
          ),
        ),
      ],
    );
  }
}

class _DeliveryChannelTile extends StatelessWidget {
  final IconData icon;
  final String title;
  final String subtitle;
  final bool value;
  final Function(bool) onChanged;
  final bool isDisabled;

  const _DeliveryChannelTile({
    required this.icon,
    required this.title,
    required this.subtitle,
    required this.value,
    required this.onChanged,
    this.isDisabled = false,
  });

  @override
  Widget build(BuildContext context) {
    return Row(
      children: [
        Icon(icon,
            size: 20,
            color: isDisabled ? AppColors.textWhite38 : AppColors.textWhite54),
        const SizedBox(width: 12),
        Expanded(
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text(title,
                  style: TextStyle(
                      color: isDisabled
                          ? AppColors.textWhite38
                          : AppColors.textWhite,
                      fontSize: 13,
                      fontWeight: FontWeight.w500)),
              Text(subtitle,
                  style: const TextStyle(
                      color: AppColors.textWhite38, fontSize: 11)),
            ],
          ),
        ),
        Switch(
          value: value,
          onChanged: isDisabled ? null : onChanged,
          activeThumbColor: Colors.white,
          activeTrackColor: AppColors.primaryBlue,
          inactiveThumbColor: AppColors.textWhite38,
          inactiveTrackColor: AppColors.backgroundBlack,
        ),
      ],
    );
  }
}

// ==========================================
// FILE: ./settings/integrations/security_permissions_card.dart
// ==========================================

import 'package:flutter/material.dart';
import '../../../../../core/constants/app_colors.dart';

class SecurityPermissionsCard extends StatefulWidget {
  const SecurityPermissionsCard({super.key});

  @override
  State<SecurityPermissionsCard> createState() => _SecurityPermissionsCardState();
}

class _SecurityPermissionsCardState extends State<SecurityPermissionsCard> {
  bool _whitelist = false;
  bool _readAttend = false;
  bool _writeAttend = false;
  bool _readCamp = true;
  bool _readFin = false;

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.all(24),
      decoration: BoxDecoration(
        color: AppColors.backgroundBlack, // Darker contrast
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: AppColors.divider),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          const Text("Security & Permissions", style: TextStyle(color: AppColors.textWhite, fontSize: 16, fontWeight: FontWeight.bold)),
          const SizedBox(height: 4),
          const Text("Global settings for external access.", style: TextStyle(color: AppColors.textWhite54, fontSize: 13)),
          
          const SizedBox(height: 24),
          const Divider(color: AppColors.divider),
          const SizedBox(height: 24),

          // IP Whitelist
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              const Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text("Require IP Whitelisting", style: TextStyle(color: AppColors.textWhite, fontWeight: FontWeight.bold, fontSize: 13)),
                  Text("Only allow access tokens to be used from known school IP addresses.", style: TextStyle(color: AppColors.textWhite54, fontSize: 12)),
                ],
              ),
              Switch(
                value: _whitelist, 
                onChanged: (v) => setState(() => _whitelist = v),
                activeThumbColor: AppColors.primaryBlue,
              ),
            ],
          ),

          const SizedBox(height: 32),
          const Text("Default Token Permissions", style: TextStyle(color: AppColors.textWhite, fontSize: 13, fontWeight: FontWeight.bold)),
          const SizedBox(height: 16),

          // Permissions Grid
          Row(
            children: [
              Expanded(child: _permTile("Attendance Read", "Allow viewing student attendance.", _readAttend, (v) => setState(() => _readAttend = v!))),
              const SizedBox(width: 16),
              Expanded(child: _permTile("Attendance Write", "Allow marking attendance.", _writeAttend, (v) => setState(() => _writeAttend = v!))),
            ],
          ),
          const SizedBox(height: 16),
          Row(
            children: [
              Expanded(child: _permTile("Campaign Read", "Allow viewing campaign stats.", _readCamp, (v) => setState(() => _readCamp = v!))),
              const SizedBox(width: 16),
              Expanded(child: _permTile("Financial Read", "Allow viewing basic financial summaries.", _readFin, (v) => setState(() => _readFin = v!))),
            ],
          ),
        ],
      ),
    );
  }

  Widget _permTile(String label, String sub, bool value, Function(bool?) onChanged) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 12),
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(8),
        border: Border.all(color: value ? AppColors.primaryBlue : AppColors.divider),
      ),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          SizedBox(
            width: 20, height: 20,
            child: Checkbox(
              value: value, 
              onChanged: onChanged,
              activeColor: AppColors.primaryBlue,
              side: const BorderSide(color: AppColors.textWhite54),
              shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(4)),
            ),
          ),
          const SizedBox(width: 12),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(label, style: const TextStyle(color: AppColors.textWhite, fontSize: 13, fontWeight: FontWeight.w500)),
                Text(sub, style: const TextStyle(color: AppColors.textWhite54, fontSize: 11)),
              ],
            ),
          ),
        ],
      ),
    );
  }
}
// ==========================================
// FILE: ./settings/integrations/teacher_tokens_card.dart
// ==========================================

import 'package:flutter/material.dart';
import '../../../../../core/constants/app_colors.dart';

class TeacherTokensCard extends StatelessWidget {
  const TeacherTokensCard({super.key});

  @override
  Widget build(BuildContext context) {
    return Container(
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: AppColors.divider),
      ),
      child: Column(
        children: [
          // Header
          Padding(
            padding: const EdgeInsets.all(24),
            child: Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                const Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text("Teacher Access Tokens", style: TextStyle(color: AppColors.textWhite, fontSize: 16, fontWeight: FontWeight.bold)),
                    SizedBox(height: 4),
                    Text("Manage temporary access for attendance and campaign tools.", style: TextStyle(color: AppColors.textWhite54, fontSize: 13)),
                  ],
                ),
                ElevatedButton.icon(
                  onPressed: () {}, // Open Generator Dialog
                  icon: const Icon(Icons.add, size: 16),
                  label: const Text("Generate Token"),
                  style: ElevatedButton.styleFrom(
                    backgroundColor: AppColors.primaryBlue,
                    foregroundColor: Colors.white,
                    padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 14),
                  ),
                ),
              ],
            ),
          ),
          const Divider(height: 1, color: AppColors.divider),

          // Table Header
          Padding(
            padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 16),
            child: Row(
              children: [
                _col("TOKEN ID / NAME", 4),
                _col("PERMISSION\nTYPE", 3),
                _col("EXPIRES AT", 3),
                _col("STATUS", 2),
              ],
            ),
          ),
          const Divider(height: 1, color: AppColors.divider),

          // Rows
          const _TokenRow(
            name: "Ms. Johnson - Fall",
            id: "tk_live_...4829",
            type: "Attendance",
            typeColor: Color(0xFF4F46E5), // Indigo
            expiry: "Dec 15, 2023",
            status: "Active",
            statusColor: AppColors.successGreen,
            icon: Icons.vpn_key,
          ),
          const Divider(height: 1, color: AppColors.divider),
          
          const _TokenRow(
            name: "Fundraiser Team",
            id: "tk_live_...9921",
            type: "Campaign Mgr",
            typeColor: Color(0xFF9333EA), // Purple
            expiry: "Nov 30, 2023",
            status: "Used (12)",
            statusColor: Colors.amber,
            icon: Icons.campaign,
          ),
          const Divider(height: 1, color: AppColors.divider),

          const _TokenRow(
            name: "Temp Staff",
            id: "tk_test_...1162",
            type: "Read Only",
            typeColor: AppColors.textWhite38,
            expiry: "Oct 01, 2023",
            status: "Expired",
            statusColor: AppColors.errorRed,
            icon: Icons.lock_clock,
          ),

          // Footer
          const Padding(
            padding: EdgeInsets.all(16.0),
            child: Row(
              mainAxisAlignment: MainAxisAlignment.end,
              children: [
                Text("Showing 3 of 15 tokens", style: TextStyle(color: AppColors.textWhite54, fontSize: 12)),
                SizedBox(width: 16),
                // Simple Pagination
                Icon(Icons.chevron_left, color: AppColors.textWhite38),
                SizedBox(width: 8),
                Icon(Icons.chevron_right, color: AppColors.textWhite),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _col(String text, int flex) {
    return Expanded(
      flex: flex,
      child: Text(
        text,
        style: const TextStyle(color: AppColors.textWhite38, fontSize: 10, fontWeight: FontWeight.bold, letterSpacing: 0.8),
      ),
    );
  }
}

class _TokenRow extends StatelessWidget {
  final String name;
  final String id;
  final String type;
  final Color typeColor;
  final String expiry;
  final String status;
  final Color statusColor;
  final IconData icon;

  const _TokenRow({
    required this.name, required this.id, required this.type, required this.typeColor,
    required this.expiry, required this.status, required this.statusColor, required this.icon
  });

  @override
  Widget build(BuildContext context) {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 16),
      child: Row(
        children: [
          // 1. Name & ID
          Expanded(
            flex: 4,
            child: Row(
              children: [
                Container(
                  padding: const EdgeInsets.all(8),
                  decoration: BoxDecoration(color: AppColors.backgroundBlack, borderRadius: BorderRadius.circular(8)),
                  child: Icon(icon, size: 16, color: typeColor),
                ),
                const SizedBox(width: 12),
                Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(name, style: const TextStyle(color: AppColors.textWhite, fontSize: 13, fontWeight: FontWeight.w600)),
                    Text(id, style: const TextStyle(color: AppColors.textWhite38, fontFamily: 'monospace', fontSize: 11)),
                  ],
                ),
              ],
            ),
          ),
          
          // 2. Type Badge
          Expanded(
            flex: 3,
            child: Row(
              children: [
                Container(
                  padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                  decoration: BoxDecoration(
                    color: typeColor.withAlpha(38),
                    borderRadius: BorderRadius.circular(4),
                    border: Border.all(color: typeColor.withAlpha(77)),
                  ),
                  child: Text(type, style: TextStyle(color: typeColor, fontSize: 10, fontWeight: FontWeight.bold)),
                ),
              ],
            ),
          ),

          // 3. Expiry
          Expanded(
            flex: 3,
            child: Text(expiry, style: const TextStyle(color: AppColors.textWhite70, fontSize: 13)),
          ),

          // 4. Status
          Expanded(
            flex: 2,
            child: Row(
              children: [
                Container(width: 6, height: 6, decoration: BoxDecoration(color: statusColor, shape: BoxShape.circle)),
                const SizedBox(width: 8),
                Text(status, style: const TextStyle(color: AppColors.textWhite, fontSize: 13)),
              ],
            ),
          ),
        ],
      ),
    );
  }
}
// ==========================================
// FILE: ./settings/integrations/api_config_card.dart
// ==========================================

import 'package:flutter/material.dart';
import '../../../../../core/constants/app_colors.dart';

class ApiConfigCard extends StatelessWidget {
  const ApiConfigCard({super.key});

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.all(24),
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: AppColors.divider),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          const Text("API Configuration", style: TextStyle(color: AppColors.textWhite, fontSize: 14, fontWeight: FontWeight.bold)),
          const SizedBox(height: 24),

          const Text("Base URL", style: TextStyle(color: AppColors.textWhite54, fontSize: 12)),
          const SizedBox(height: 8),
          Row(
            children: [
              Container(
                padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 12),
                decoration: const BoxDecoration(
                  color: AppColors.divider,
                  borderRadius: BorderRadius.horizontal(left: Radius.circular(6)),
                ),
                child: const Text("GET", style: TextStyle(color: AppColors.textWhite70, fontSize: 12, fontFamily: 'monospace')),
              ),
              Expanded(
                child: Container(
                  padding: const EdgeInsets.all(12),
                  decoration: const BoxDecoration(
                    color: AppColors.backgroundBlack,
                    borderRadius: BorderRadius.horizontal(right: Radius.circular(6)),
                  ),
                  child: const Text("https://api.schooladmin.io/v1/", style: TextStyle(color: AppColors.textWhite, fontSize: 13, fontFamily: 'monospace')),
                ),
              ),
            ],
          ),

          const SizedBox(height: 16),
          const Text("Webhook Secret", style: TextStyle(color: AppColors.textWhite54, fontSize: 12)),
          const SizedBox(height: 8),
          Container(
            decoration: BoxDecoration(
              color: AppColors.backgroundBlack,
              borderRadius: BorderRadius.circular(6),
              border: Border.all(color: AppColors.divider),
            ),
            child: Row(
              children: [
                const Expanded(
                  child: Padding(
                    padding: EdgeInsets.all(12),
                    child: Text("‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢", style: TextStyle(color: AppColors.textWhite54, letterSpacing: 2)),
                  ),
                ),
                IconButton(
                  onPressed: () {},
                  icon: const Icon(Icons.visibility, size: 16, color: AppColors.textWhite54),
                )
              ],
            ),
          ),

          const SizedBox(height: 24),
          const Text(
            "View API Documentation ‚Üó", 
            style: TextStyle(color: AppColors.primaryBlue, fontSize: 12),
          ),
        ],
      ),
    );
  }
}
// ==========================================
// FILE: ./settings/integrations/connected_services_card.dart
// ==========================================

import 'package:flutter/material.dart';
import '../../../../../core/constants/app_colors.dart';

class ConnectedServicesCard extends StatelessWidget {
  const ConnectedServicesCard({super.key});

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.all(24),
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: AppColors.divider),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              const Text("Connected Services", style: TextStyle(color: AppColors.textWhite, fontSize: 14, fontWeight: FontWeight.bold)),
              Icon(Icons.extension, color: Colors.orange[800], size: 18),
            ],
          ),
          const SizedBox(height: 24),

          const Text("ACCOUNTING SOFTWARE", style: TextStyle(color: AppColors.textWhite38, fontSize: 10, fontWeight: FontWeight.bold, letterSpacing: 1.0)),
          const SizedBox(height: 16),
          
          const _ServiceRow(
            name: "QuickBooks\nOnline",
            isConnected: true,
            icon: "QB",
            color: Color(0xFF2CA01C), // QB Green
          ),
          const SizedBox(height: 16),
          const _ServiceRow(
            name: "Xero",
            isConnected: false,
            icon: "X",
            color: Color(0xFF13B5EA), // Xero Blue
          ),

          const SizedBox(height: 24),
          const Divider(color: AppColors.divider),
          const SizedBox(height: 24),

          const Text("COMMUNICATION", style: TextStyle(color: AppColors.textWhite38, fontSize: 10, fontWeight: FontWeight.bold, letterSpacing: 1.0)),
          const SizedBox(height: 16),
          const _ServiceRow(
            name: "Mailgun",
            isConnected: true, // Special state "Configure"
            isConfigurable: true,
            desc: "Email delivery service",
            icon: "M",
            color: Color(0xFFFD5D5D), // Mailgun Red/Orange
          ),
        ],
      ),
    );
  }
}

class _ServiceRow extends StatelessWidget {
  final String name;
  final bool isConnected;
  final bool isConfigurable;
  final String icon;
  final Color color;
  final String? desc;

  const _ServiceRow({
    required this.name,
    required this.isConnected,
    this.isConfigurable = false,
    required this.icon,
    required this.color,
    this.desc,
  });

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: AppColors.backgroundBlack,
        borderRadius: BorderRadius.circular(8),
        border: Border.all(color: AppColors.divider),
      ),
      child: Row(
        children: [
          Container(
            width: 40, height: 40,
            alignment: Alignment.center,
            decoration: BoxDecoration(color: color, borderRadius: BorderRadius.circular(8)),
            child: Text(icon, style: const TextStyle(color: Colors.white, fontWeight: FontWeight.bold, fontSize: 16)),
          ),
          const SizedBox(width: 12),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(name, style: const TextStyle(color: AppColors.textWhite, fontSize: 13, fontWeight: FontWeight.bold, height: 1.1)),
                if (isConnected && !isConfigurable) 
                  const Text("‚óè Connected", style: TextStyle(color: AppColors.successGreen, fontSize: 11))
                else if (desc != null)
                  Text(desc!, style: const TextStyle(color: AppColors.textWhite38, fontSize: 11))
                else
                  const Text("Not connected", style: TextStyle(color: AppColors.textWhite38, fontSize: 11)),
              ],
            ),
          ),
          if (isConfigurable)
            TextButton(onPressed: (){}, child: const Text("Configure", style: TextStyle(fontSize: 12)))
          else if (isConnected)
            TextButton(onPressed: (){}, child: const Text("Disconnect", style: TextStyle(color: AppColors.textWhite54, fontSize: 12)))
          else
            TextButton(onPressed: (){}, child: const Text("Connect", style: TextStyle(color: AppColors.primaryBlue, fontSize: 12))),
        ],
      ),
    );
  }
}
// ==========================================
// FILE: ./settings/billing_config_card.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';

import '../../../../core/constants/app_colors.dart';
import '../../../data/providers/billing_config_provider.dart';
import '../../../data/providers/dashboard_provider.dart';

class BillingConfigCard extends ConsumerStatefulWidget {
  const BillingConfigCard({super.key});

  @override
  ConsumerState<BillingConfigCard> createState() => _BillingConfigCardState();
}

class _BillingConfigCardState extends ConsumerState<BillingConfigCard> {
  final _currencyController = TextEditingController();
  final _taxController = TextEditingController();
  final _defaultFeeController = TextEditingController();
  final _registrationFeeController = TextEditingController();
  final _lateFeeController = TextEditingController();
  final _graceDaysController = TextEditingController();
  final _invoicePrefixController = TextEditingController();
  final _invoiceSequenceController = TextEditingController();
  final _invoiceFooterController = TextEditingController();

  bool _allowPartialPayments = true;
  bool _hydrated = false;
  bool _saving = false;
  Map<String, dynamic>? _lastConfig;

  @override
  void dispose() {
    _currencyController.dispose();
    _taxController.dispose();
    _defaultFeeController.dispose();
    _registrationFeeController.dispose();
    _lateFeeController.dispose();
    _graceDaysController.dispose();
    _invoicePrefixController.dispose();
    _invoiceSequenceController.dispose();
    _invoiceFooterController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final dashboardAsync = ref.watch(dashboardDataProvider);

    return dashboardAsync.when(
      loading: () => _loadingCard(),
      error: (err, _) => _errorCard('Dashboard load failed: $err'),
      data: (dashboard) {
        if (dashboard.schoolId.isEmpty) {
          return _errorCard('No school context found.');
        }

        final configAsync =
            ref.watch(billingConfigProvider(dashboard.schoolId));
        return configAsync.when(
          loading: () => _loadingCard(),
          error: (err, _) => _errorCard('Billing config load failed: $err'),
          data: (config) {
            _hydrateIfNeeded(config);
            return _buildContent(context, dashboard.schoolId);
          },
        );
      },
    );
  }

  Widget _buildContent(BuildContext context, String schoolId) {
    return Container(
      padding: const EdgeInsets.all(24),
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: AppColors.divider),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              const Text(
                'Billing Configuration',
                style: TextStyle(
                  color: AppColors.textWhite,
                  fontSize: 16,
                  fontWeight: FontWeight.bold,
                ),
              ),
              Container(
                padding: const EdgeInsets.all(6),
                decoration: BoxDecoration(
                  color: AppColors.primaryBlue.withValues(alpha: 0.1),
                  borderRadius: BorderRadius.circular(6),
                ),
                child: const Icon(
                  Icons.account_balance_wallet,
                  color: AppColors.primaryBlue,
                  size: 18,
                ),
              ),
            ],
          ),
          const SizedBox(height: 4),
          const Text(
            'Manage currency, taxes, fees, and invoice defaults.',
            style: TextStyle(color: AppColors.textWhite54, fontSize: 12),
          ),
          const SizedBox(height: 24),
          const Divider(color: AppColors.divider),
          const SizedBox(height: 24),
          Row(
            children: [
              Expanded(
                child: _buildInput(
                  label: 'Base Currency',
                  controller: _currencyController,
                  isDropdown: true,
                ),
              ),
              const SizedBox(width: 24),
              Expanded(
                child: _buildInput(
                  label: 'Default Tax Rate (%)',
                  controller: _taxController,
                  suffix: '%',
                ),
              ),
            ],
          ),
          const SizedBox(height: 32),
          const Text(
            'Default Fee Settings',
            style: TextStyle(
              color: AppColors.textWhite,
              fontSize: 13,
              fontWeight: FontWeight.bold,
            ),
          ),
          const SizedBox(height: 16),
          Row(
            children: [
              Expanded(
                child: _buildInput(
                  label: 'Annual Tuition Fee',
                  controller: _defaultFeeController,
                  prefix: '\$',
                ),
              ),
              const SizedBox(width: 24),
              Expanded(
                child: _buildInput(
                  label: 'One-time Registration Fee',
                  controller: _registrationFeeController,
                  prefix: '\$',
                ),
              ),
            ],
          ),
          const SizedBox(height: 32),
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              const Text(
                'Payment & Late Fee Policy',
                style: TextStyle(
                  color: AppColors.textWhite,
                  fontSize: 13,
                  fontWeight: FontWeight.bold,
                ),
              ),
              Row(
                children: [
                  const Text(
                    'Allow Partial Payments',
                    style:
                        TextStyle(color: AppColors.textWhite54, fontSize: 12),
                  ),
                  const SizedBox(width: 8),
                  Switch(
                    value: _allowPartialPayments,
                    onChanged: (v) => setState(() => _allowPartialPayments = v),
                    activeThumbColor: AppColors.primaryBlue,
                  ),
                ],
              ),
            ],
          ),
          const SizedBox(height: 16),
          Row(
            children: [
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    _buildInput(
                      label: 'Late Fee Percentage',
                      controller: _lateFeeController,
                      suffix: '%',
                    ),
                    const SizedBox(height: 4),
                    const Text(
                      'Applied monthly to outstanding balance.',
                      style:
                          TextStyle(color: AppColors.textWhite38, fontSize: 10),
                    ),
                  ],
                ),
              ),
              const SizedBox(width: 24),
              Expanded(
                child: _buildInput(
                  label: 'Grace Period (Days)',
                  controller: _graceDaysController,
                ),
              ),
            ],
          ),
          const SizedBox(height: 32),
          Row(
            children: [
              Expanded(
                child: _buildInput(
                  label: 'Invoice Prefix',
                  controller: _invoicePrefixController,
                ),
              ),
              const SizedBox(width: 24),
              Expanded(
                child: _buildInput(
                  label: 'Invoice Sequence Seed',
                  controller: _invoiceSequenceController,
                ),
              ),
            ],
          ),
          const SizedBox(height: 32),
          _buildInput(
            label: 'Invoice Footer Note',
            controller: _invoiceFooterController,
            maxLines: 4,
            helper:
                'This text will appear at the bottom of every invoice generated.',
          ),
          const SizedBox(height: 24),
          Align(
            alignment: Alignment.centerRight,
            child: Row(
              mainAxisAlignment: MainAxisAlignment.end,
              children: [
                TextButton(
                  onPressed: _hydrated && _lastConfig != null
                      ? () => _hydrateIfNeeded(_lastConfig!, force: true)
                      : null,
                  child: const Text('Reset'),
                ),
                const SizedBox(width: 12),
                ElevatedButton(
                  onPressed: _saving ? null : () => _onSave(context, schoolId),
                  child: _saving
                      ? const SizedBox(
                          width: 18,
                          height: 18,
                          child: CircularProgressIndicator(strokeWidth: 2),
                        )
                      : const Text('Save Changes'),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  void _hydrateIfNeeded(Map<String, dynamic> config, {bool force = false}) {
    if (_hydrated && !force) return;
    _lastConfig = config;

    _currencyController.text = (config['currency_code'] ?? 'USD').toString();
    _taxController.text = _formatNumber(config['tax_rate_percentage']);
    _defaultFeeController.text = _formatNumber(config['default_fee']);
    _registrationFeeController.text = _formatNumber(config['registration_fee']);
    _lateFeeController.text = _formatNumber(config['late_fee_percentage']);
    _graceDaysController.text = (config['grace_period_days'] ?? 0).toString();
    _invoicePrefixController.text =
        (config['invoice_prefix'] ?? 'INV-').toString();
    _invoiceSequenceController.text =
        (config['invoice_sequence_seed'] ?? 1000).toString();
    _invoiceFooterController.text =
        (config['invoice_footer_note'] ?? '').toString();

    final partialRaw = config['allow_partial_payments'];
    _allowPartialPayments =
        partialRaw is bool ? partialRaw : (partialRaw ?? 1) == 1;

    _hydrated = true;
    setState(() {});
  }

  Future<void> _onSave(BuildContext context, String schoolId) async {
    // Validate before saving
    final validation = _validateBillingConfig();
    if (validation.isNotEmpty) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('‚ö†Ô∏è ${validation.join(", ")}'),
            backgroundColor: AppColors.warningOrange,
            duration: const Duration(seconds: 4),
          ),
        );
      }
      return;
    }

    setState(() => _saving = true);
    try {
      await ref.read(billingConfigProvider(schoolId).notifier).saveConfig(
            currencyCode: _currencyController.text.trim().isEmpty
                ? 'USD'
                : _currencyController.text.trim(),
            taxRate: _parseDouble(_taxController.text),
            registrationFee: _parseDouble(_registrationFeeController.text),
            gracePeriodDays: _parseInt(_graceDaysController.text, fallback: 7),
            invoicePrefix: _invoicePrefixController.text.trim().isEmpty
                ? 'INV-'
                : _invoicePrefixController.text.trim(),
            invoiceSequenceSeed:
                _parseInt(_invoiceSequenceController.text, fallback: 1000),
            lateFeePercentage: _parseDouble(_lateFeeController.text),
            defaultFee: _parseDouble(_defaultFeeController.text),
            allowPartialPayments: _allowPartialPayments,
            invoiceFooterNote: _invoiceFooterController.text.trim(),
          );

      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(content: Text('‚úÖ Billing settings saved')),
        );
      }
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text('‚ùå Error: $e')),
        );
      }
    } finally {
      if (mounted) setState(() => _saving = false);
    }
  }

  /// Validate billing config for logical consistency
  List<String> _validateBillingConfig() {
    final errors = <String>[];
    final taxRate = _parseDouble(_taxController.text);
    final lateFee = _parseDouble(_lateFeeController.text);
    final graceDays = _parseInt(_graceDaysController.text, fallback: 7);
    final invoicePrefix = _invoicePrefixController.text.trim();
    final defaultFee = _parseDouble(_defaultFeeController.text);
    final registrationFee = _parseDouble(_registrationFeeController.text);

    if (taxRate < 0 || taxRate > 100) {
      errors.add('Tax rate must be 0-100%');
    }
    if (lateFee < 0 || lateFee > 100) {
      errors.add('Late fee must be 0-100%');
    }
    if (graceDays < 0 || graceDays > 90) {
      errors.add('Grace period must be 0-90 days');
    }
    if (invoicePrefix.isEmpty) {
      errors.add('Invoice prefix required');
    }
    if (defaultFee < 0) {
      errors.add('Default fee cannot be negative');
    }
    if (registrationFee < 0) {
      errors.add('Registration fee cannot be negative');
    }

    return errors;
  }

  Widget _loadingCard() {
    return Container(
      padding: const EdgeInsets.all(24),
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: AppColors.divider),
      ),
      child: const Center(
        child: SizedBox(
          height: 24,
          width: 24,
          child: CircularProgressIndicator(strokeWidth: 2),
        ),
      ),
    );
  }

  Widget _errorCard(String message) {
    return Container(
      padding: const EdgeInsets.all(24),
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: AppColors.warningOrange),
      ),
      child: Row(
        children: [
          const Icon(Icons.error_outline, color: AppColors.warningOrange),
          const SizedBox(width: 12),
          Expanded(
            child: Text(
              message,
              style: const TextStyle(color: AppColors.warningOrange),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildInput({
    required String label,
    required TextEditingController controller,
    bool isDropdown = false,
    String? suffix,
    String? prefix,
    int maxLines = 1,
    String? helper,
  }) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(label,
            style: const TextStyle(color: AppColors.textWhite70, fontSize: 13)),
        const SizedBox(height: 8),
        TextFormField(
          controller: controller,
          maxLines: maxLines,
          style: const TextStyle(color: AppColors.textWhite),
          keyboardType:
              maxLines > 1 ? TextInputType.multiline : TextInputType.text,
          decoration: InputDecoration(
            filled: true,
            fillColor: AppColors.backgroundBlack,
            contentPadding: const EdgeInsets.all(16),
            suffixText: suffix,
            prefixText: prefix,
            suffixStyle: const TextStyle(color: AppColors.textWhite54),
            prefixStyle: const TextStyle(color: AppColors.textWhite54),
            suffixIcon: isDropdown
                ? const Icon(Icons.keyboard_arrow_down,
                    color: AppColors.textWhite54)
                : null,
            border: OutlineInputBorder(
              borderRadius: BorderRadius.circular(8),
              borderSide: const BorderSide(color: AppColors.divider),
            ),
            enabledBorder: OutlineInputBorder(
              borderRadius: BorderRadius.circular(8),
              borderSide: const BorderSide(color: AppColors.divider),
            ),
            focusedBorder: OutlineInputBorder(
              borderRadius: BorderRadius.circular(8),
              borderSide: const BorderSide(color: AppColors.primaryBlue),
            ),
          ),
        ),
        if (helper != null) ...[
          const SizedBox(height: 4),
          Text(helper,
              style:
                  const TextStyle(color: AppColors.textWhite38, fontSize: 10)),
        ],
      ],
    );
  }

  String _formatNumber(dynamic value) {
    if (value == null) return '0';
    if (value is num) return value.toString();
    return double.tryParse(value.toString())?.toString() ?? '0';
  }

  double _parseDouble(String value) {
    return double.tryParse(value.trim()) ?? 0.0;
  }

  int _parseInt(String value, {required int fallback}) {
    return int.tryParse(value.trim()) ?? fallback;
  }
}

// ==========================================
// FILE: ./settings/audit_trail_view.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:intl/intl.dart';
import '../../../../core/constants/app_colors.dart';
import '../../../data/services/database_service.dart';
import '../../../data/providers/dashboard_provider.dart';

class AuditTrailView extends ConsumerStatefulWidget {
  const AuditTrailView({super.key});

  @override
  ConsumerState<AuditTrailView> createState() => _AuditTrailViewState();
}

class _AuditTrailViewState extends ConsumerState<AuditTrailView> {
  final _db = DatabaseService();
  DateTime? _startDate;
  DateTime? _endDate;
  String _selectedAction = 'All Actions';

  final List<String> _actionFilters = [
    'All Actions',
    'Invoice Created',
    'Payment Recorded',
    'Config Updated',
    'Bill Status Changed',
  ];

  @override
  Widget build(BuildContext context) {
    final dashboardAsync = ref.watch(dashboardDataProvider);

    return dashboardAsync.when(
      loading: () => _buildLoading(),
      error: (err, _) => _buildError('Failed to load school: $err'),
      data: (dashboard) {
        if (dashboard.schoolId.isEmpty) {
          return _buildError('No school context');
        }
        return _buildContent(context, dashboard.schoolId);
      },
    );
  }

  Widget _buildContent(BuildContext context, String schoolId) {
    return Container(
      padding: const EdgeInsets.all(24),
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: AppColors.divider),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Header
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              const Text(
                'Audit Trail',
                style: TextStyle(
                  color: AppColors.textWhite,
                  fontSize: 16,
                  fontWeight: FontWeight.bold,
                ),
              ),
              Container(
                padding: const EdgeInsets.all(6),
                decoration: BoxDecoration(
                  color: Colors.amber.withValues(alpha: 0.1),
                  borderRadius: BorderRadius.circular(6),
                ),
                child: const Icon(Icons.history, color: Colors.amber, size: 18),
              ),
            ],
          ),
          const SizedBox(height: 4),
          const Text(
            'Read-only log of billing system changes',
            style: TextStyle(color: AppColors.textWhite54, fontSize: 12),
          ),
          const SizedBox(height: 24),

          // Filters
          Row(
            children: [
              Expanded(
                child: _buildFilterDropdown(
                  label: _selectedAction,
                  items: _actionFilters,
                  onChanged: (value) =>
                      setState(() => _selectedAction = value ?? 'All Actions'),
                ),
              ),
              const SizedBox(width: 12),
              SizedBox(
                width: 150,
                child: _buildDateFilterButton(
                  label: _startDate == null
                      ? 'From Date'
                      : DateFormat('MMM d').format(_startDate!),
                  onTap: () async {
                    final picked = await showDatePicker(
                      context: context,
                      initialDate: _startDate ?? DateTime.now(),
                      firstDate:
                          DateTime.now().subtract(const Duration(days: 365)),
                      lastDate: DateTime.now(),
                    );
                    if (picked != null) {
                      setState(() => _startDate = picked);
                    }
                  },
                ),
              ),
              const SizedBox(width: 12),
              SizedBox(
                width: 150,
                child: _buildDateFilterButton(
                  label: _endDate == null
                      ? 'To Date'
                      : DateFormat('MMM d').format(_endDate!),
                  onTap: () async {
                    final picked = await showDatePicker(
                      context: context,
                      initialDate: _endDate ?? DateTime.now(),
                      firstDate: _startDate ??
                          DateTime.now().subtract(const Duration(days: 365)),
                      lastDate: DateTime.now(),
                    );
                    if (picked != null) {
                      setState(() => _endDate = picked);
                    }
                  },
                ),
              ),
              const SizedBox(width: 12),
              TextButton(
                onPressed: () {
                  setState(() {
                    _startDate = null;
                    _endDate = null;
                    _selectedAction = 'All Actions';
                  });
                },
                child: const Text('Clear',
                    style: TextStyle(color: AppColors.primaryBlue)),
              ),
            ],
          ),
          const SizedBox(height: 24),

          // Audit Log Table
          Expanded(
            child: FutureBuilder<List<Map<String, dynamic>>>(
              future: _fetchAuditLog(schoolId),
              builder: (context, snapshot) {
                if (snapshot.connectionState == ConnectionState.waiting) {
                  return const Center(child: CircularProgressIndicator());
                }

                if (snapshot.hasError) {
                  return Center(
                    child: Text(
                      'Error loading audit log: ${snapshot.error}',
                      style: const TextStyle(color: AppColors.errorRed),
                    ),
                  );
                }

                final logs = snapshot.data ?? [];
                if (logs.isEmpty) {
                  return const Center(
                    child: Text(
                      'No audit log entries found',
                      style: TextStyle(color: AppColors.textWhite54),
                    ),
                  );
                }

                return ListView.separated(
                  itemCount: logs.length,
                  separatorBuilder: (_, __) =>
                      const Divider(color: AppColors.divider),
                  itemBuilder: (context, index) {
                    final log = logs[index];
                    return _buildAuditLogRow(log);
                  },
                );
              },
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildAuditLogRow(Map<String, dynamic> log) {
    final action = log['action'] ?? 'Unknown';
    final description = log['description'] ?? '';
    final changedBy = log['changed_by'] ?? 'System';
    final timestamp = log['created_at'] ?? '';
    final details = log['details'] ?? '';

    Color actionColor = AppColors.textWhite54;
    IconData actionIcon = Icons.info_outline;

    if (action.contains('Created')) {
      actionColor = AppColors.successGreen;
      actionIcon = Icons.add_circle_outline;
    } else if (action.contains('Updated') || action.contains('Changed')) {
      actionColor = AppColors.primaryBlue;
      actionIcon = Icons.edit_note;
    } else if (action.contains('Deleted')) {
      actionColor = AppColors.errorRed;
      actionIcon = Icons.delete_outline;
    }

    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 12),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Icon(actionIcon, color: actionColor, size: 20),
          const SizedBox(width: 16),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  action,
                  style: TextStyle(
                    color: actionColor,
                    fontWeight: FontWeight.bold,
                    fontSize: 13,
                  ),
                ),
                if (description.isNotEmpty) ...[
                  const SizedBox(height: 4),
                  Text(
                    description,
                    style: const TextStyle(
                      color: AppColors.textWhite,
                      fontSize: 12,
                    ),
                  ),
                ],
                if (details.isNotEmpty) ...[
                  const SizedBox(height: 6),
                  Container(
                    padding: const EdgeInsets.all(8),
                    decoration: BoxDecoration(
                      color: AppColors.backgroundBlack,
                      borderRadius: BorderRadius.circular(4),
                    ),
                    child: Text(
                      details,
                      style: const TextStyle(
                        color: AppColors.textWhite54,
                        fontSize: 11,
                        fontFamily: 'monospace',
                      ),
                      maxLines: 2,
                      overflow: TextOverflow.ellipsis,
                    ),
                  ),
                ],
                const SizedBox(height: 6),
                Row(
                  children: [
                    Text(
                      'by $changedBy',
                      style: const TextStyle(
                        color: AppColors.textWhite54,
                        fontSize: 11,
                      ),
                    ),
                    const SizedBox(width: 12),
                    Text(
                      _formatTimestamp(timestamp),
                      style: const TextStyle(
                        color: AppColors.textWhite38,
                        fontSize: 11,
                      ),
                    ),
                  ],
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildFilterDropdown({
    required String label,
    required List<String> items,
    required Function(String?) onChanged,
  }) {
    return PopupMenuButton<String>(
      onSelected: onChanged,
      child: Container(
        height: 40,
        padding: const EdgeInsets.symmetric(horizontal: 12),
        decoration: BoxDecoration(
          color: AppColors.backgroundBlack,
          borderRadius: BorderRadius.circular(6),
          border: Border.all(color: AppColors.divider),
        ),
        child: Row(
          children: [
            Expanded(
              child: Text(
                label,
                style: const TextStyle(
                  color: AppColors.textWhite,
                  fontSize: 13,
                ),
              ),
            ),
            const Icon(Icons.keyboard_arrow_down,
                color: AppColors.textWhite54, size: 16),
          ],
        ),
      ),
      itemBuilder: (context) => items
          .map((item) => PopupMenuItem(value: item, child: Text(item)))
          .toList(),
    );
  }

  Widget _buildDateFilterButton({
    required String label,
    required VoidCallback onTap,
  }) {
    return GestureDetector(
      onTap: onTap,
      child: Container(
        height: 40,
        padding: const EdgeInsets.symmetric(horizontal: 12),
        decoration: BoxDecoration(
          color: AppColors.backgroundBlack,
          borderRadius: BorderRadius.circular(6),
          border: Border.all(color: AppColors.divider),
        ),
        child: Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            Text(
              label,
              style: const TextStyle(
                color: AppColors.textWhite,
                fontSize: 13,
              ),
            ),
            const Icon(Icons.calendar_today,
                color: AppColors.textWhite54, size: 16),
          ],
        ),
      ),
    );
  }

  Future<List<Map<String, dynamic>>> _fetchAuditLog(String schoolId) async {
    // Note: This query assumes a billing_audit_log table exists
    // For now, we'll return sample data structure
    // In production, this should be an RPC call to Supabase
    try {
      var query = 'SELECT * FROM billing_audit_log WHERE school_id = ?';
      var params = [schoolId];

      if (_selectedAction != 'All Actions') {
        query += ' AND action = ?';
        params.add(_selectedAction);
      }

      if (_startDate != null) {
        query += ' AND created_at >= ?';
        params.add(_startDate!.toIso8601String());
      }

      if (_endDate != null) {
        query += ' AND created_at <= ?';
        params.add(_endDate!.add(const Duration(days: 1)).toIso8601String());
      }

      query += ' ORDER BY created_at DESC LIMIT 500';

      final result = await _db.db.getAll(query, params);
      return result;
    } catch (e) {
      debugPrint('Error fetching audit log: $e');
      return [];
    }
  }

  String _formatTimestamp(String timestamp) {
    try {
      final dt = DateTime.parse(timestamp);
      return DateFormat('MMM d, HH:mm').format(dt);
    } catch (_) {
      return 'Unknown';
    }
  }

  Widget _buildLoading() {
    return Container(
      padding: const EdgeInsets.all(48),
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: AppColors.divider),
      ),
      child: const Center(child: CircularProgressIndicator()),
    );
  }

  Widget _buildError(String message) {
    return Container(
      padding: const EdgeInsets.all(24),
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: AppColors.warningOrange),
      ),
      child: Row(
        children: [
          const Icon(Icons.error_outline, color: AppColors.warningOrange),
          const SizedBox(width: 12),
          Expanded(
            child: Text(
              message,
              style: const TextStyle(color: AppColors.warningOrange),
            ),
          ),
        ],
      ),
    );
  }
}

// ==========================================
// FILE: ./settings/year_configuration_card.dart
// ==========================================

import 'dart:convert';
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:intl/intl.dart';
import 'package:uuid/uuid.dart';
import '../../../../core/constants/app_colors.dart';
import '../../../data/providers/dashboard_provider.dart';
import '../../../data/services/database_service.dart';

class YearConfigurationCard extends ConsumerStatefulWidget {
  final String yearId;
  const YearConfigurationCard({super.key, required this.yearId});

  @override
  ConsumerState<YearConfigurationCard> createState() =>
      _YearConfigurationCardState();
}

class _YearConfigurationCardState extends ConsumerState<YearConfigurationCard> {
  final _labelController = TextEditingController();
  final _startDateController = TextEditingController();
  final _endDateController = TextEditingController();
  final _descriptionController = TextEditingController();

  bool _hydrated = false;
  bool _saving = false;
  bool _active = false;
  List<Map<String, dynamic>> _terms = [];
  List<Map<String, dynamic>> _months = [];
  Map<String, dynamic>? _yearData;
  final Set<String> _removedTermIds = {};

  @override
  void dispose() {
    _labelController.dispose();
    _startDateController.dispose();
    _endDateController.dispose();
    _descriptionController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final dashboardAsync = ref.watch(dashboardDataProvider);

    return dashboardAsync.when(
      loading: () => _loadingCard(),
      error: (err, _) => _errorCard('Dashboard error: $err'),
      data: (dashboard) {
        if (dashboard.schoolId.isEmpty) {
          return _errorCard('No school context');
        }

        if (!_hydrated) {
          _loadYearData(dashboard.schoolId);
        }

        return _buildContent(context, dashboard.schoolId);
      },
    );
  }

  Widget _buildContent(BuildContext context, String schoolId) {
    return Container(
      decoration: BoxDecoration(
        color: AppColors.backgroundBlack,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: AppColors.primaryBlue, width: 1.5),
      ),
      child: Column(
        children: [
          // 1. Config Header
          Padding(
            padding: const EdgeInsets.all(24),
            child: Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text("Configure: ${widget.yearId}",
                        style: const TextStyle(
                            color: AppColors.textWhite,
                            fontSize: 16,
                            fontWeight: FontWeight.bold)),
                    const SizedBox(height: 4),
                    const Text("Editing details, terms, and billing settings.",
                        style: TextStyle(
                            color: AppColors.textWhite54, fontSize: 13)),
                  ],
                ),
                Container(
                  padding:
                      const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
                  decoration: BoxDecoration(
                    color: _active
                        ? AppColors.successGreen
                        : AppColors.textWhite54,
                    borderRadius: BorderRadius.circular(16),
                  ),
                  child: Text(_active ? "Active" : "Inactive",
                      style: const TextStyle(
                          color: Colors.white,
                          fontSize: 11,
                          fontWeight: FontWeight.bold)),
                ),
              ],
            ),
          ),
          const Divider(height: 1, color: AppColors.divider),

          // 2. Form Body
          Padding(
            padding: const EdgeInsets.all(32),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                // Row 1: Label & Dates
                Row(
                  children: [
                    Expanded(child: _buildInput("Label", _labelController)),
                    const SizedBox(width: 24),
                    Expanded(
                        child: _buildDateInput(
                            "Start Date", _startDateController,
                            isStartDate: true, schoolId: schoolId)),
                    const SizedBox(width: 24),
                    Expanded(
                        child: _buildDateInput("End Date", _endDateController,
                            isStartDate: false, schoolId: schoolId)),
                  ],
                ),
                const SizedBox(height: 24),

                // Row 2: Description & Active Toggle
                Row(
                  children: [
                    Expanded(
                      child: _buildInput("Description", _descriptionController,
                          helper:
                              "Brief description for administrative reference."),
                    ),
                    const SizedBox(width: 24),
                    Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        const Text("Active Year",
                            style: TextStyle(
                                color: AppColors.textWhite70, fontSize: 13)),
                        const SizedBox(height: 8),
                        Switch(
                          value: _active,
                          onChanged: (v) => setState(() => _active = v),
                          activeThumbColor: AppColors.successGreen,
                        ),
                      ],
                    ),
                  ],
                ),

                const SizedBox(height: 40),
                const Divider(color: AppColors.divider),
                const SizedBox(height: 32),

                // 3. Terms Management Section
                Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: [
                    const Row(
                      children: [
                        Icon(Icons.date_range,
                            color: AppColors.textWhite70, size: 20),
                        SizedBox(width: 12),
                        Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text("Terms Management",
                                style: TextStyle(
                                    color: AppColors.textWhite,
                                    fontSize: 14,
                                    fontWeight: FontWeight.bold)),
                            Text(
                                "Define academic terms (Semesters/Trimesters) for this year.",
                                style: TextStyle(
                                    color: AppColors.textWhite54,
                                    fontSize: 12)),
                          ],
                        ),
                      ],
                    ),
                    OutlinedButton.icon(
                      onPressed: _addTerm,
                      icon: const Icon(Icons.add, size: 14),
                      label: const Text("Add Term"),
                      style: OutlinedButton.styleFrom(
                        foregroundColor: AppColors.textWhite,
                        side: const BorderSide(color: AppColors.divider),
                      ),
                    ),
                  ],
                ),
                const SizedBox(height: 24),

                // Dynamic Terms
                if (_terms.isEmpty)
                  Container(
                    padding: const EdgeInsets.all(24),
                    decoration: BoxDecoration(
                      color: AppColors.surfaceGrey.withValues(alpha: 0.3),
                      borderRadius: BorderRadius.circular(8),
                      border: Border.all(color: AppColors.divider),
                    ),
                    child: const Center(
                      child: Text(
                        'No terms defined. Click "Add Term" to create one.',
                        style: TextStyle(
                            color: AppColors.textWhite54, fontSize: 13),
                      ),
                    ),
                  )
                else
                  ..._terms.asMap().entries.map((entry) {
                    final idx = entry.key;
                    final term = entry.value;
                    return Padding(
                      padding: EdgeInsets.only(
                          bottom: idx < _terms.length - 1 ? 16 : 0),
                      child: _buildTermRow(idx, term),
                    );
                  }),

                const SizedBox(height: 32),
                const Divider(color: AppColors.divider),
                const SizedBox(height: 24),

                // 4. Months & Billability
                Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: [
                    const Row(
                      children: [
                        Icon(Icons.calendar_month,
                            color: AppColors.textWhite70, size: 20),
                        SizedBox(width: 12),
                        Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text("Months & Billability",
                                style: TextStyle(
                                    color: AppColors.textWhite,
                                    fontSize: 14,
                                    fontWeight: FontWeight.bold)),
                            Text(
                                "Toggle which months are billable for this year.",
                                style: TextStyle(
                                    color: AppColors.textWhite54,
                                    fontSize: 12)),
                          ],
                        ),
                      ],
                    ),
                    TextButton(
                      onPressed: _months.isEmpty
                          ? null
                          : () {
                              setState(() {
                                final shouldEnable = _months
                                    .any((m) => m['is_billable'] == false);
                                for (final m in _months) {
                                  m['is_billable'] = shouldEnable;
                                }
                              });
                            },
                      child: const Text('Toggle All'),
                    ),
                  ],
                ),
                const SizedBox(height: 16),

                if (_months.isEmpty)
                  Container(
                    padding: const EdgeInsets.all(24),
                    decoration: BoxDecoration(
                      color: AppColors.surfaceGrey.withValues(alpha: 0.3),
                      borderRadius: BorderRadius.circular(8),
                      border: Border.all(color: AppColors.divider),
                    ),
                    child: const Center(
                      child: Text(
                        'No months found for this year.',
                        style: TextStyle(
                            color: AppColors.textWhite54, fontSize: 13),
                      ),
                    ),
                  )
                else
                  ..._months.asMap().entries.map((entry) {
                    final idx = entry.key;
                    final month = entry.value;
                    return Padding(
                      padding: EdgeInsets.only(
                          bottom: idx < _months.length - 1 ? 12 : 0),
                      child: _buildMonthRow(month),
                    );
                  }),

                const SizedBox(height: 32),

                // Save/Reset Buttons
                Row(
                  mainAxisAlignment: MainAxisAlignment.end,
                  children: [
                    TextButton(
                      onPressed: _hydrated && _yearData != null
                          ? () => _loadYearData(schoolId, force: true)
                          : null,
                      child: const Text('Reset'),
                    ),
                    const SizedBox(width: 12),
                    ElevatedButton(
                      onPressed:
                          _saving ? null : () => _onSave(context, schoolId),
                      child: _saving
                          ? const SizedBox(
                              width: 18,
                              height: 18,
                              child: CircularProgressIndicator(strokeWidth: 2),
                            )
                          : const Text('Save Changes'),
                    ),
                  ],
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Future<void> _loadYearData(String schoolId, {bool force = false}) async {
    if (_hydrated && !force) return;

    try {
      final db = DatabaseService();
      final results = await db.db.getAll(
        'SELECT * FROM school_years WHERE id = ? AND school_id = ?',
        [widget.yearId, schoolId],
      );

      if (results.isEmpty) {
        if (mounted) {
          setState(() {
            _hydrated = true;
            _labelController.text = '';
            _startDateController.text = '';
            _endDateController.text = '';
            _descriptionController.text = '';
            _active = false;
            _terms = [];
            _months = [];
          });
        }
        return;
      }

      final year = results.first;
      _yearData = year;

      // Load terms from dedicated table; fallback to encoded description
      List<Map<String, dynamic>> parsedTerms = [];
      final desc = year['description'] as String? ?? '';

      final termRows = await db.db.getAll(
        '''SELECT id, name, start_date, end_date
           FROM school_terms
           WHERE school_year_id = ? AND school_id = ?
           ORDER BY start_date''',
        [widget.yearId, schoolId],
      );

      if (termRows.isNotEmpty) {
        parsedTerms = termRows
            .map((t) => {
                  'id': t['id'],
                  'name': (t['name'] ?? '').toString(),
                  'start_date': (t['start_date'] ?? '').toString(),
                  'end_date': (t['end_date'] ?? '').toString(),
                })
            .toList();
      } else if (desc.isNotEmpty) {
        try {
          final decoded = jsonDecode(desc);
          if (decoded is Map && decoded.containsKey('terms')) {
            final termsList = decoded['terms'] as List?;
            if (termsList != null) {
              parsedTerms = termsList
                  .map((t) => {
                        'id':
                            (t['id'] ?? '').toString().isEmpty ? null : t['id'],
                        'name': (t['name'] ?? '').toString(),
                        'start_date': (t['start_date'] ?? '').toString(),
                        'end_date': (t['end_date'] ?? '').toString(),
                      })
                  .toList();
            }
          }
        } catch (_) {
          // Not JSON, treat as plain description
        }
      }

      if (mounted) {
        setState(() {
          _labelController.text = year['year_label'] as String? ?? '';
          _startDateController.text = year['start_date'] as String? ?? '';
          _endDateController.text = year['end_date'] as String? ?? '';
          _descriptionController.text =
              (desc.isNotEmpty && parsedTerms.isEmpty) ? desc : '';
          _active = (year['active'] as int? ?? 0) == 1;
          _terms = parsedTerms;
          _removedTermIds.clear();
          _hydrated = true;
        });
      }

      // Load months for this year
      final months = await db.db.getAll(
        '''SELECT id, name, month_index, start_date, end_date, is_billable, term_id
            FROM school_year_months
           WHERE school_year_id = ? AND school_id = ?
            ORDER BY month_index''',
        [widget.yearId, schoolId],
      );

      if (mounted) {
        setState(() {
          _months = months
              .map((m) => {
                    'id': m['id'],
                    'name': (m['name'] ?? '').toString(),
                    'month_index': m['month_index'],
                    'start_date': (m['start_date'] ?? '').toString(),
                    'end_date': (m['end_date'] ?? '').toString(),
                    'is_billable': (m['is_billable'] as int? ?? 0) == 1,
                    'term_id': (m['term_id'] ?? '').toString().isEmpty
                        ? null
                        : m['term_id'],
                  })
              .toList();
        });
      }
    } catch (e) {
      debugPrint('‚ö†Ô∏è Error loading year data: $e');
      if (mounted) setState(() => _hydrated = true);
    }
  }

  void _addTerm() {
    setState(() {
      _terms.add({
        'id': const Uuid().v4(),
        'name': 'Term ${_terms.length + 1}',
        'start_date': '',
        'end_date': '',
      });
    });
  }

  void _removeTerm(int index) {
    setState(() {
      final removed = _terms.removeAt(index);
      final removedId = removed['id']?.toString();
      if (removedId != null && removedId.isNotEmpty) {
        _removedTermIds.add(removedId);
        for (final m in _months) {
          if (m['term_id']?.toString() == removedId) {
            m['term_id'] = null;
          }
        }
      }
    });
  }

  void _updateTerm(int index, String field, String value) {
    setState(() {
      _terms[index][field] = value;
    });
  }

  void _toggleMonthBillable(dynamic monthId, bool value) {
    setState(() {
      for (final m in _months) {
        if (m['id'] == monthId) {
          m['is_billable'] = value;
          break;
        }
      }
    });
  }

  void _setMonthTerm(dynamic monthId, String? termId) {
    setState(() {
      for (final m in _months) {
        if (m['id'] == monthId) {
          m['term_id'] = termId;
          break;
        }
      }
    });
  }

  Future<void> _onSave(BuildContext context, String schoolId) async {
    setState(() => _saving = true);

    try {
      final db = DatabaseService();

      // Build description JSON if there are terms
      String descriptionValue;
      if (_terms.isNotEmpty) {
        descriptionValue = jsonEncode({
          'description': _descriptionController.text.trim(),
          'terms': _terms,
        });
      } else {
        descriptionValue = _descriptionController.text.trim();
      }

      await db.db.execute(
        '''UPDATE school_years 
           SET year_label = ?, start_date = ?, end_date = ?, description = ?, active = ?
           WHERE id = ? AND school_id = ?''',
        [
          _labelController.text.trim(),
          _startDateController.text.trim(),
          _endDateController.text.trim(),
          descriptionValue,
          _active ? 1 : 0,
          widget.yearId,
          schoolId,
        ],
      );

      // Upsert terms with IDs for FK usage
      for (final term in _terms) {
        final termId = (term['id']?.toString().isNotEmpty ?? false)
            ? term['id'].toString()
            : const Uuid().v4();
        term['id'] = termId;

        await db.db.execute(
          '''INSERT OR REPLACE INTO school_terms
             (id, school_id, school_year_id, name, start_date, end_date, academic_year, created_at)
             VALUES (?, ?, ?, ?, ?, ?, ?, COALESCE((SELECT created_at FROM school_terms WHERE id = ?), datetime('now')))''',
          [
            termId,
            schoolId,
            widget.yearId,
            (term['name'] ?? '').toString().trim(),
            (term['start_date'] ?? '').toString().trim(),
            (term['end_date'] ?? '').toString().trim(),
            null,
            termId,
          ],
        );
      }

      for (final termId in _removedTermIds) {
        await db.db.execute(
          'DELETE FROM school_terms WHERE id = ? AND school_id = ?',
          [termId, schoolId],
        );
      }
      _removedTermIds.clear();

      // Persist month billability toggles
      for (final m in _months) {
        if (m['id'] == null) continue;
        final isBillable = (m['is_billable'] as bool? ?? false) ? 1 : 0;
        final termId = (m['term_id']?.toString().isNotEmpty ?? false)
            ? m['term_id'].toString()
            : null;
        await db.db.execute(
          '''UPDATE school_year_months
             SET is_billable = ?, term_id = ?
             WHERE id = ? AND school_id = ?''',
          [isBillable, termId, m['id'], schoolId],
        );
      }

      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(content: Text('School year updated successfully')),
        );
      }
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text('Failed to save: $e')),
        );
      }
    } finally {
      if (mounted) setState(() => _saving = false);
    }
  }

  Widget _buildInput(String label, TextEditingController controller,
      {IconData? icon, String? helper, int maxLines = 1}) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(label,
            style: const TextStyle(color: AppColors.textWhite70, fontSize: 13)),
        const SizedBox(height: 8),
        TextFormField(
          controller: controller,
          maxLines: maxLines,
          style: const TextStyle(color: AppColors.textWhite),
          decoration: InputDecoration(
            filled: true,
            fillColor: AppColors.surfaceGrey,
            contentPadding: const EdgeInsets.all(16),
            suffixIcon: icon != null
                ? Icon(icon, color: AppColors.textWhite54, size: 18)
                : null,
            border: OutlineInputBorder(
                borderRadius: BorderRadius.circular(8),
                borderSide: const BorderSide(color: AppColors.divider)),
            enabledBorder: OutlineInputBorder(
                borderRadius: BorderRadius.circular(8),
                borderSide: const BorderSide(color: AppColors.divider)),
            focusedBorder: OutlineInputBorder(
                borderRadius: BorderRadius.circular(8),
                borderSide: const BorderSide(color: AppColors.primaryBlue)),
          ),
        ),
        if (helper != null) ...[
          const SizedBox(height: 6),
          Text(helper,
              style:
                  const TextStyle(color: AppColors.textWhite38, fontSize: 11)),
        ]
      ],
    );
  }

  Widget _buildTermRow(int index, Map<String, dynamic> term) {
    return Container(
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey.withValues(alpha: 0.5),
        borderRadius: BorderRadius.circular(8),
        border: Border.all(color: AppColors.divider),
      ),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.end,
        children: [
          Expanded(
              flex: 4,
              child: _buildSubInput("Term Name", term['name'] ?? '',
                  onChanged: (v) => _updateTerm(index, 'name', v))),
          const SizedBox(width: 16),
          Expanded(
              flex: 3,
              child: _buildSubInput("Start Date", term['start_date'] ?? '',
                  icon: Icons.calendar_today,
                  onChanged: (v) => _updateTerm(index, 'start_date', v))),
          const SizedBox(width: 16),
          Expanded(
              flex: 3,
              child: _buildSubInput("End Date", term['end_date'] ?? '',
                  icon: Icons.calendar_today,
                  onChanged: (v) => _updateTerm(index, 'end_date', v))),
          const SizedBox(width: 16),
          Padding(
            padding: const EdgeInsets.only(bottom: 8),
            child: IconButton(
              onPressed: () => _removeTerm(index),
              icon: const Icon(Icons.delete_outline,
                  color: AppColors.textWhite54),
              tooltip: "Remove Term",
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildMonthRow(Map<String, dynamic> month) {
    final bool billable = month['is_billable'] as bool? ?? false;
    final name = (month['name'] ?? '').toString();
    final range = _formatRange(
      (month['start_date'] ?? '').toString(),
      (month['end_date'] ?? '').toString(),
    );
    final selectedTermId = (month['term_id']?.toString().isNotEmpty ?? false)
        ? month['term_id'].toString()
        : null;

    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 14),
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey.withValues(alpha: 0.5),
        borderRadius: BorderRadius.circular(8),
        border: Border.all(color: AppColors.divider),
      ),
      child: Row(
        children: [
          Expanded(
            flex: 6,
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(name,
                    style: const TextStyle(
                        color: AppColors.textWhite,
                        fontWeight: FontWeight.w600,
                        fontSize: 13)),
                const SizedBox(height: 2),
                Text(range,
                    style: const TextStyle(
                        color: AppColors.textWhite54, fontSize: 11)),
                if (_terms.isNotEmpty) ...[
                  const SizedBox(height: 10),
                  Row(
                    children: [
                      const Text('Term',
                          style: TextStyle(
                              color: AppColors.textWhite54, fontSize: 12)),
                      const SizedBox(width: 8),
                      Container(
                        padding: const EdgeInsets.symmetric(
                            horizontal: 12, vertical: 6),
                        decoration: BoxDecoration(
                          color: AppColors.backgroundBlack,
                          borderRadius: BorderRadius.circular(8),
                          border: Border.all(color: AppColors.divider),
                        ),
                        child: DropdownButtonHideUnderline(
                          child: DropdownButton<String?>(
                            value: selectedTermId,
                            dropdownColor: AppColors.surfaceGrey,
                            icon: const Icon(Icons.keyboard_arrow_down,
                                size: 14, color: AppColors.textWhite54),
                            style: const TextStyle(
                                color: AppColors.textWhite, fontSize: 12),
                            items: [
                              const DropdownMenuItem<String?>(
                                  value: null, child: Text('Unassigned')),
                              ..._terms.map(
                                (t) => DropdownMenuItem<String?>(
                                  value: t['id']?.toString(),
                                  child: Text((t['name'] ?? '').toString()),
                                ),
                              ),
                            ],
                            onChanged: (val) =>
                                _setMonthTerm(month['id'], val?.trim()),
                          ),
                        ),
                      ),
                    ],
                  ),
                ],
              ],
            ),
          ),
          Switch(
            value: billable,
            onChanged: (v) => _toggleMonthBillable(month['id'], v),
            activeColor: AppColors.primaryBlue,
          ),
          const SizedBox(width: 8),
          Text(
            billable ? 'Billable' : 'Not billable',
            style: TextStyle(
              color: billable ? AppColors.textWhite : AppColors.textWhite54,
              fontSize: 12,
              fontWeight: billable ? FontWeight.w600 : FontWeight.normal,
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildSubInput(String label, String value,
      {IconData? icon, required ValueChanged<String> onChanged}) {
    final controller = TextEditingController(text: value);
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(label,
            style: const TextStyle(color: AppColors.textWhite38, fontSize: 11)),
        const SizedBox(height: 6),
        SizedBox(
          height: 40,
          child: TextFormField(
            controller: controller,
            onChanged: onChanged,
            style: const TextStyle(color: AppColors.textWhite, fontSize: 13),
            decoration: InputDecoration(
              isDense: true,
              filled: true,
              fillColor: AppColors.backgroundBlack,
              contentPadding:
                  const EdgeInsets.symmetric(horizontal: 12, vertical: 12),
              suffixIcon: icon != null
                  ? Icon(icon, color: AppColors.textWhite38, size: 16)
                  : null,
              border: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(6),
                  borderSide: const BorderSide(color: AppColors.divider)),
              enabledBorder: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(6),
                  borderSide: const BorderSide(color: AppColors.divider)),
              focusedBorder: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(6),
                  borderSide: const BorderSide(color: AppColors.textWhite38)),
            ),
          ),
        ),
      ],
    );
  }

  Widget _buildDateInput(String label, TextEditingController controller,
      {required bool isStartDate, required String schoolId}) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(label,
            style: const TextStyle(color: AppColors.textWhite70, fontSize: 13)),
        const SizedBox(height: 8),
        TextFormField(
          controller: controller,
          readOnly: true,
          style: const TextStyle(color: AppColors.textWhite),
          decoration: InputDecoration(
            filled: true,
            fillColor: AppColors.surfaceGrey,
            contentPadding: const EdgeInsets.all(16),
            suffixIcon: GestureDetector(
              onTap: () => _pickDate(isStartDate, controller),
              child: const Icon(Icons.calendar_today,
                  color: AppColors.textWhite54, size: 18),
            ),
            border: OutlineInputBorder(
                borderRadius: BorderRadius.circular(8),
                borderSide: const BorderSide(color: AppColors.divider)),
            enabledBorder: OutlineInputBorder(
                borderRadius: BorderRadius.circular(8),
                borderSide: const BorderSide(color: AppColors.divider)),
            focusedBorder: OutlineInputBorder(
                borderRadius: BorderRadius.circular(8),
                borderSide: const BorderSide(color: AppColors.primaryBlue)),
          ),
        ),
      ],
    );
  }

  Future<void> _pickDate(
      bool isStartDate, TextEditingController controller) async {
    try {
      final now = DateTime.now();
      final initialDate = controller.text.isNotEmpty
          ? DateTime.tryParse(controller.text) ?? now
          : now;

      final picked = await showDatePicker(
        context: context,
        initialDate: initialDate,
        firstDate: DateTime(1900),
        lastDate: DateTime(2100),
        builder: (context, child) => Theme(
          data: Theme.of(context).copyWith(
            colorScheme: const ColorScheme.dark(
              primary: AppColors.primaryBlue,
              surface: AppColors.surfaceGrey,
            ),
          ),
          child: child!,
        ),
      );

      if (picked == null) return;

      final formatted = DateFormat('yyyy-MM-dd').format(picked);
      setState(() {
        if (isStartDate) {
          _startDateController.text = formatted;
          final endDate = _endDateController.text.isNotEmpty
              ? DateTime.tryParse(_endDateController.text)
              : null;
          if (endDate != null && picked.isAfter(endDate)) {
            final newEndDate = DateTime(picked.year, 12, 31);
            _endDateController.text =
                DateFormat('yyyy-MM-dd').format(newEndDate);
            _regenerateMonthDates();
          }
        } else {
          final startDate = _startDateController.text.isNotEmpty
              ? DateTime.tryParse(_startDateController.text)
              : null;
          if (startDate != null && picked.isBefore(startDate)) {
            ScaffoldMessenger.of(context).showSnackBar(
              const SnackBar(
                  content: Text('End date cannot be before start date')),
            );
            return;
          }
          _endDateController.text = formatted;
          _regenerateMonthDates();
        }
      });
    } catch (e) {
      debugPrint('‚ö†Ô∏è Error picking date: $e');
    }
  }

  void _regenerateMonthDates() {
    if (_startDateController.text.isEmpty || _endDateController.text.isEmpty)
      return;

    try {
      final start = DateTime.tryParse(_startDateController.text);
      final end = DateTime.tryParse(_endDateController.text);

      if (start == null || end == null || start.isAfter(end)) return;

      setState(() {
        for (int i = 0; i < _months.length; i++) {
          final month = _months[i];
          final monthIndex = month['month_index'] as int? ?? (i + 1);

          final monthStart = DateTime(start.year, monthIndex, 1);
          final monthEnd = DateTime(start.year, monthIndex + 1, 0);

          if (monthStart.isBefore(end) && monthEnd.isAfter(start)) {
            month['start_date'] = DateFormat('yyyy-MM-dd')
                .format(monthStart.isBefore(start) ? start : monthStart);
            month['end_date'] = DateFormat('yyyy-MM-dd')
                .format(monthEnd.isAfter(end) ? end : monthEnd);
          }
        }
      });
    } catch (e) {
      debugPrint('‚ö†Ô∏è Error regenerating month dates: $e');
    }
  }

  Widget _loadingCard() {
    return Container(
      padding: const EdgeInsets.all(48),
      decoration: BoxDecoration(
        color: AppColors.backgroundBlack,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: AppColors.divider),
      ),
      child: const Center(
        child: CircularProgressIndicator(),
      ),
    );
  }

  String _formatRange(String start, String end) {
    if (start.isEmpty && end.isEmpty) return '';
    if (start.isEmpty) return end;
    if (end.isEmpty) return start;
    return '$start ‚Üí $end';
  }

  Widget _errorCard(String message) {
    return Container(
      padding: const EdgeInsets.all(24),
      decoration: BoxDecoration(
        color: AppColors.backgroundBlack,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: AppColors.warningOrange),
      ),
      child: Row(
        children: [
          const Icon(Icons.error_outline, color: AppColors.warningOrange),
          const SizedBox(width: 12),
          Expanded(
            child: Text(
              message,
              style: const TextStyle(color: AppColors.warningOrange),
            ),
          ),
        ],
      ),
    );
  }
}

// ==========================================
// FILE: ./settings/general_financial_view.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../../core/constants/app_colors.dart';
import 'billing_config_card.dart';
import 'organization_card.dart';

class GeneralFinancialView extends ConsumerWidget {
  const GeneralFinancialView({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    // We would typically watch a settingsProvider here to load initial data
    
    return Column(
      children: [
        // WARNING BANNER (Policy Requirement)
        Container(
          margin: const EdgeInsets.only(bottom: 24),
          padding: const EdgeInsets.all(12),
          decoration: BoxDecoration(
            color: AppColors.warningOrange.withValues(alpha: 0.1),
            borderRadius: BorderRadius.circular(8),
            border: Border.all(color: AppColors.warningOrange.withValues(alpha: 0.3)),
          ),
          child: const Row(
            children: [
              Icon(Icons.warning_amber_rounded, color: AppColors.warningOrange, size: 20),
              SizedBox(width: 12),
              Expanded(
                child: Text(
                  "Changes to Financial Settings are applied immediately to the server. There is no Undo functionality. Ensure you have authorization.",
                  style: TextStyle(color: AppColors.warningOrange, fontSize: 13),
                ),
              ),
            ],
          ),
        ),

        Row(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // LEFT: Billing Configuration
            const Expanded(
              flex: 3,
              child: BillingConfigCard(),
            ),
            const SizedBox(width: 24),
            
            // RIGHT: Organization & Integrations
            Expanded(
              flex: 2,
              child: Column(
                children: [
                  const OrganizationCard(),
                  const SizedBox(height: 24),
                  _buildSchoolLogoCard(),
                  const SizedBox(height: 24),
                  _buildIntegrationsCard(),
                ],
              ),
            ),
          ],
        ),
        
        // FOOTER TERMS (Policy Requirement)
        const Padding(
          padding: EdgeInsets.only(top: 32, bottom: 16),
          child: Text(
            "By saving, you agree to the Greyway.Co Data Integrity Policy. Fees Up is not responsible for data loss due to misconfiguration.",
            style: TextStyle(color: AppColors.textWhite38, fontSize: 11),
            textAlign: TextAlign.center,
          ),
        ),
      ],
    );
  }

  Widget _buildSchoolLogoCard() {
    return Container(
      padding: const EdgeInsets.all(24),
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: AppColors.divider),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          const Text("School Logo", style: TextStyle(color: AppColors.textWhite, fontWeight: FontWeight.bold)),
          const SizedBox(height: 24),
          Center(
            child: Column(
              children: [
                Container(
                  width: 100, height: 100,
                  decoration: BoxDecoration(
                    color: AppColors.backgroundBlack,
                    shape: BoxShape.circle,
                    border: Border.all(color: AppColors.textWhite54, style: BorderStyle.solid),
                  ),
                  child: const Icon(Icons.camera_alt, color: AppColors.textWhite54),
                ),
                const SizedBox(height: 12),
                const Text("Upload new logo", style: TextStyle(color: AppColors.primaryBlue, fontSize: 13, fontWeight: FontWeight.bold)),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildIntegrationsCard() {
    return Container(
      padding: const EdgeInsets.all(24),
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: AppColors.divider),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              const Text("Integrations", style: TextStyle(color: AppColors.textWhite, fontWeight: FontWeight.bold)),
              Icon(Icons.extension, color: Colors.orange[700], size: 20),
            ],
          ),
          const SizedBox(height: 16),
          const Text("TEACHER ACCESS TOKEN", style: TextStyle(color: AppColors.textWhite38, fontSize: 11, fontWeight: FontWeight.bold)),
          const SizedBox(height: 8),
          Row(
            children: [
              Expanded(
                child: Container(
                  height: 40,
                  padding: const EdgeInsets.symmetric(horizontal: 12),
                  decoration: BoxDecoration(
                    color: AppColors.backgroundBlack,
                    borderRadius: BorderRadius.circular(8),
                    border: Border.all(color: AppColors.divider),
                  ),
                  alignment: Alignment.centerLeft,
                  child: const Text("sk_live_8372...9283", style: TextStyle(color: AppColors.textWhite54, fontFamily: 'monospace')),
                ),
              ),
              const SizedBox(width: 8),
              Container(
                width: 40, height: 40,
                decoration: BoxDecoration(
                  color: AppColors.surfaceLightGrey,
                  borderRadius: BorderRadius.circular(8),
                ),
                child: const Icon(Icons.copy, size: 16, color: AppColors.textWhite70),
              ),
            ],
          ),
        ],
      ),
    );
  }
}
// ==========================================
// FILE: ./settings/integrations_settings_view.dart
// ==========================================

import 'package:flutter/material.dart';
import 'integrations/teacher_tokens_card.dart';
import 'integrations/security_permissions_card.dart';
import 'integrations/connected_services_card.dart';
import 'integrations/api_config_card.dart';

class IntegrationsSettingsView extends StatelessWidget {
  const IntegrationsSettingsView({super.key});

  @override
  Widget build(BuildContext context) {
    return const Row(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        // --- LEFT COLUMN (Tokens & Security) ---
        Expanded(
          flex: 3,
          child: Column(
            children: [
              TeacherTokensCard(),
              SizedBox(height: 24),
              SecurityPermissionsCard(),
            ],
          ),
        ),
        
        SizedBox(width: 24),

        // --- RIGHT COLUMN (Services & API) ---
        Expanded(
          flex: 2,
          child: Column(
            children: [
              ConnectedServicesCard(),
              SizedBox(height: 24),
              ApiConfigCard(),
            ],
          ),
        ),
      ],
    );
  }
}
// ==========================================
// FILE: ./settings/settings_header.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../../core/constants/app_colors.dart';
import '../../../../data/providers/dashboard_provider.dart';
import '../../../../data/services/database_service.dart';

// Search Data Model
class _SearchOption {
  final String label;
  final int tabIndex;
  const _SearchOption(this.label, this.tabIndex);
}

class SettingsHeader extends ConsumerWidget {
  final Function(int) onSearchNavigation;

  const SettingsHeader({super.key, required this.onSearchNavigation});

  // --- Search Registry ---
  static const List<_SearchOption> _searchOptions = [
    _SearchOption("General Settings", 0),
    _SearchOption("School Profile", 0),
    _SearchOption("Currency & Finance", 0),
    _SearchOption("Academic Years", 1),
    _SearchOption("Terms & Semesters", 1),
    _SearchOption("Users", 2),
    _SearchOption("Permissions & Roles", 2),
    _SearchOption("Teachers & Admins", 2),
    _SearchOption("Notifications", 3),
    _SearchOption("Email Alerts", 3),
    _SearchOption("Integrations", 4),
    _SearchOption("API Tokens", 4),
    _SearchOption("QuickBooks / Xero", 4),
  ];

  String _getInitials(String name) {
    if (name.isEmpty) return "U";
    final parts = name.trim().split(' ');
    if (parts.length > 1) {
      return "${parts[0][0]}${parts[1][0]}".toUpperCase();
    }
    return name[0].toUpperCase();
  }

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final dashboardAsync = ref.watch(dashboardDataProvider);
    final bool isConnected = DatabaseService().db.currentStatus.connected;

    return Container(
      height: 70,
      padding: const EdgeInsets.symmetric(horizontal: 24),
      color: AppColors.backgroundBlack,
      child: Row(
        children: [
          // --- Page Title ---
          Container(
            padding: const EdgeInsets.all(8),
            decoration: BoxDecoration(
              color: AppColors.primaryBlue.withAlpha(26),
              borderRadius: BorderRadius.circular(8),
            ),
            child: const Icon(Icons.settings, color: AppColors.primaryBlue, size: 20),
          ),
          const SizedBox(width: 12),
          const Text(
            "Settings",
            style: TextStyle(
              color: AppColors.textWhite,
              fontSize: 20,
              fontWeight: FontWeight.bold,
              letterSpacing: 0.5,
            ),
          ),
          
          const Spacer(),

          // --- Autocomplete Search Bar ---
          SizedBox(
            width: 300,
            child: Autocomplete<_SearchOption>(
              optionsBuilder: (TextEditingValue textEditingValue) {
                if (textEditingValue.text == '') {
                  return const Iterable<_SearchOption>.empty();
                }
                return _searchOptions.where((option) {
                  return option.label
                      .toLowerCase()
                      .contains(textEditingValue.text.toLowerCase());
                });
              },
              displayStringForOption: (_SearchOption option) => option.label,
              onSelected: (_SearchOption selection) {
                onSearchNavigation(selection.tabIndex);
              },
              
              // Custom Input Field Styling
              fieldViewBuilder: (context, controller, focusNode, onFieldSubmitted) {
                return SizedBox(
                  height: 40,
                  child: TextField(
                    controller: controller,
                    focusNode: focusNode,
                    textAlignVertical: TextAlignVertical.center,
                    style: const TextStyle(color: AppColors.textWhite, fontSize: 13),
                    decoration: InputDecoration(
                      isDense: true,
                      filled: true,
                      fillColor: AppColors.surfaceGrey,
                      hintText: "Search settings...",
                      hintStyle: const TextStyle(color: AppColors.textWhite38),
                      prefixIcon: const Icon(Icons.search, size: 18, color: AppColors.textWhite54),
                      contentPadding: EdgeInsets.zero,
                      enabledBorder: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(8),
                        borderSide: const BorderSide(color: AppColors.divider),
                      ),
                      focusedBorder: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(8),
                        borderSide: const BorderSide(color: AppColors.primaryBlue),
                      ),
                      border: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(8),
                        borderSide: const BorderSide(color: AppColors.divider),
                      ),
                    ),
                  ),
                );
              },

              // Custom Dropdown Styling for Dark Mode
              optionsViewBuilder: (context, onSelected, options) {
                return Align(
                  alignment: Alignment.topLeft,
                  child: Material(
                    color: Colors.transparent,
                    child: Container(
                      width: 300,
                      margin: const EdgeInsets.only(top: 10),
                      decoration: BoxDecoration(
                        color: AppColors.surfaceGrey,
                        borderRadius: BorderRadius.circular(8),
                        border: Border.all(color: AppColors.divider),
                        boxShadow: [
                          BoxShadow(
                            color: Colors.black.withAlpha(51),
                            blurRadius: 10,
                            offset: const Offset(0, 4),
                          )
                        ],
                      ),
                      child: ListView.builder(
                        padding: EdgeInsets.zero,
                        shrinkWrap: true,
                        itemCount: options.length,
                        itemBuilder: (BuildContext context, int index) {
                          final option = options.elementAt(index);
                          return InkWell(
                            onTap: () => onSelected(option),
                            child: Padding(
                              padding: const EdgeInsets.symmetric(vertical: 12, horizontal: 16),
                              child: Text(
                                option.label,
                                style: const TextStyle(color: AppColors.textWhite, fontSize: 13),
                              ),
                            ),
                          );
                        },
                      ),
                    ),
                  ),
                );
              },
            ),
          ),
          
          const SizedBox(width: 24),

          // --- Actions ---
          IconButton(
            onPressed: () {},
            icon: const Icon(Icons.notifications_none, color: AppColors.textWhite70),
            tooltip: "Notifications",
          ),
          IconButton(
            onPressed: () {},
            icon: const Icon(Icons.help_outline, color: AppColors.textWhite70),
            tooltip: "Help & Support",
          ),
          const SizedBox(width: 16),

          // --- Profile with Connectivity Logic ---
          dashboardAsync.when(
            loading: () => _buildProfileLoading(),
            error: (err, _) => _buildProfileError(isConnected),
            data: (data) {
              final initials = _getInitials(data.userName);
              String subtitle = "Administrator";
              Color subtitleColor = AppColors.textWhite38;

              if (data.schoolName == 'Loading...') {
                subtitle = isConnected ? "Syncing..." : "Offline Mode";
                subtitleColor = isConnected ? AppColors.primaryBlueLight : AppColors.errorRed;
              } else if (!isConnected) {
                subtitle = "Offline Mode";
                subtitleColor = AppColors.errorRed;
              }

              return Row(
                children: [
                  Column(
                    mainAxisAlignment: MainAxisAlignment.center,
                    crossAxisAlignment: CrossAxisAlignment.end,
                    children: [
                      Text(
                        data.userName.isEmpty ? "User" : data.userName, 
                        style: const TextStyle(color: AppColors.textWhite, fontWeight: FontWeight.bold, fontSize: 13)
                      ),
                      Text(
                        subtitle, 
                        style: TextStyle(color: subtitleColor, fontSize: 11)
                      ),
                    ],
                  ),
                  const SizedBox(width: 12),
                  CircleAvatar(
                    backgroundColor: AppColors.primaryBlue.withAlpha(51),
                    child: Text(
                      initials, 
                      style: const TextStyle(color: AppColors.primaryBlue, fontWeight: FontWeight.bold, fontSize: 12)
                    ),
                  ),
                ],
              );
            },
          ),
        ],
      ),
    );
  }

  // --- Loading/Error States ---
  Widget _buildProfileLoading() {
    return Row(
      children: [
        Column(
          mainAxisAlignment: MainAxisAlignment.center,
          crossAxisAlignment: CrossAxisAlignment.end,
          children: [
            Container(width: 80, height: 12, color: AppColors.surfaceGrey),
            const SizedBox(height: 4),
            Container(width: 50, height: 10, color: AppColors.surfaceGrey),
          ],
        ),
        const SizedBox(width: 12),
        const CircleAvatar(
          backgroundColor: AppColors.surfaceGrey,
          radius: 20,
        ),
      ],
    );
  }

  Widget _buildProfileError(bool isConnected) {
    return Row(
      children: [
        Text(
          isConnected ? "Sync Error" : "Offline", 
          style: TextStyle(color: isConnected ? AppColors.errorRed : AppColors.warningOrange, fontSize: 12)
        ),
        const SizedBox(width: 12),
        CircleAvatar(
          backgroundColor: AppColors.surfaceGrey,
          child: Icon(
            isConnected ? Icons.error_outline : Icons.wifi_off, 
            size: 16, 
            color: isConnected ? AppColors.errorRed : AppColors.warningOrange
          ),
        ),
      ],
    );
  }
}
// ==========================================
// FILE: ./settings/add_user_dialog.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../../core/constants/app_colors.dart';
import '../../../../data/providers/users_provider.dart';

class AddUserDialog extends ConsumerStatefulWidget {
  final String schoolId;
  const AddUserDialog({super.key, required this.schoolId});

  @override
  ConsumerState<AddUserDialog> createState() => _AddUserDialogState();
}

class _AddUserDialogState extends ConsumerState<AddUserDialog> {
  final _emailController = TextEditingController();
  String _selectedRole = 'teacher';
  bool _isLoading = false;
  String? _error;

  Future<void> _submit() async {
    setState(() { _isLoading = true; _error = null; });
    try {
      await ref.read(usersRepositoryProvider).addUserByEmail(
        email: _emailController.text.trim(),
        schoolId: widget.schoolId,
        role: _selectedRole,
      );
      
      // Refresh list and close
      // ignore: unused_result
      ref.refresh(schoolUsersProvider);
      if (mounted) Navigator.of(context).pop();
      
    } catch (e) {
      setState(() => _error = e.toString());
    } finally {
      if (mounted) setState(() => _isLoading = false);
    }
  }

  @override
  Widget build(BuildContext context) {
    return Dialog(
      backgroundColor: AppColors.surfaceGrey,
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
      child: Container(
        width: 500,
        padding: const EdgeInsets.all(24),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            const Text("Add New User", style: TextStyle(color: AppColors.textWhite, fontSize: 20, fontWeight: FontWeight.bold)),
            const SizedBox(height: 8),
            const Text("Link an existing account to your school by email.", style: TextStyle(color: AppColors.textWhite54)),
            const SizedBox(height: 24),

            // Email Input
            const Text("User Email", style: TextStyle(color: AppColors.textWhite70, fontSize: 13)),
            const SizedBox(height: 8),
            TextField(
              controller: _emailController,
              style: const TextStyle(color: AppColors.textWhite),
              decoration: InputDecoration(
                filled: true,
                fillColor: AppColors.backgroundBlack,
                hintText: "e.g. sarah.jones@school.edu",
                hintStyle: const TextStyle(color: AppColors.textWhite38),
                border: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.divider)),
              ),
            ),
            const SizedBox(height: 24),

            // Role Selection
            const Text("Assign Role", style: TextStyle(color: AppColors.textWhite70, fontSize: 13)),
            const SizedBox(height: 8),
            Container(
              padding: const EdgeInsets.symmetric(horizontal: 12),
              decoration: BoxDecoration(
                color: AppColors.backgroundBlack,
                borderRadius: BorderRadius.circular(8),
                border: Border.all(color: AppColors.divider),
              ),
              child: DropdownButtonHideUnderline(
                child: DropdownButton<String>(
                  value: _selectedRole,
                  isExpanded: true,
                  dropdownColor: AppColors.surfaceGrey,
                  style: const TextStyle(color: AppColors.textWhite),
                  items: const [
                    DropdownMenuItem(value: 'teacher', child: Text("Teacher")),
                    DropdownMenuItem(value: 'school_admin', child: Text("School Admin")),
                    DropdownMenuItem(value: 'student', child: Text("Student")),
                  ],
                  onChanged: (v) => setState(() => _selectedRole = v!),
                ),
              ),
            ),

            if (_error != null) ...[
              const SizedBox(height: 16),
              Container(
                padding: const EdgeInsets.all(12),
                decoration: BoxDecoration(color: AppColors.errorRed.withAlpha(26), borderRadius: BorderRadius.circular(8)),
                child: Row(children: [
                  const Icon(Icons.error, color: AppColors.errorRed, size: 20),
                  const SizedBox(width: 8),
                  Expanded(child: Text(_error!, style: const TextStyle(color: AppColors.errorRed, fontSize: 12))),
                ]),
              )
            ],

            const SizedBox(height: 32),
            Row(
              mainAxisAlignment: MainAxisAlignment.end,
              children: [
                TextButton(
                  onPressed: () => Navigator.pop(context),
                  child: const Text("Cancel", style: TextStyle(color: AppColors.textWhite54)),
                ),
                const SizedBox(width: 16),
                ElevatedButton(
                  onPressed: _isLoading ? null : _submit,
                  style: ElevatedButton.styleFrom(backgroundColor: AppColors.primaryBlue),
                  child: Text(_isLoading ? "Linking..." : "Add User"),
                ),
              ],
            ),
          ],
        ),
      ),
    );
  }
}
// ==========================================
// FILE: ./settings/billing_period_dialog.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:intl/intl.dart';
import 'package:supabase_flutter/supabase_flutter.dart';
import 'package:uuid/uuid.dart';
import '../../../../core/constants/app_colors.dart';
import '../../../../data/providers/dashboard_provider.dart';

/// Universal Billing Period Configuration Dialog
/// Can be launched from anywhere in the app
class BillingPeriodDialog extends ConsumerStatefulWidget {
  final String? schoolId;
  final String? existingConfigId; // For editing existing config

  const BillingPeriodDialog({
    super.key,
    this.schoolId,
    this.existingConfigId,
  });

  @override
  ConsumerState<BillingPeriodDialog> createState() =>
      _BillingPeriodDialogState();
}

class _BillingPeriodDialogState extends ConsumerState<BillingPeriodDialog> {
  final _formKey = GlobalKey<FormState>();
  final _supabase = Supabase.instance.client;

  // Controllers
  final TextEditingController _tuitionController = TextEditingController();
  final TextEditingController _uniformController = TextEditingController();
  final TextEditingController _levyController = TextEditingController();
  final TextEditingController _transportController = TextEditingController();
  final TextEditingController _lateFeeController =
      TextEditingController(text: '5.0');

  // State
  String _selectedFrequency = 'monthly';
  int _billingDay = 1;
  int _dueDay = 15;
  String _selectedGrade = 'All Grades';
  bool _isLoading = false;
  bool _isActive = true;
  DateTime _effectiveFrom = DateTime.now();

  final List<String> _frequencies = ['monthly', 'termly', 'annual', 'adhoc'];
  final List<String> _grades = [
    'All Grades',
    'Grade 1',
    'Grade 2',
    'Grade 3',
    'Grade 4',
    'Grade 5',
    'Grade 6',
    'Grade 7',
    'Grade 8',
    'Grade 9',
    'Grade 10',
    'Grade 11',
    'Grade 12'
  ];

  @override
  void initState() {
    super.initState();
    if (widget.existingConfigId != null) {
      _loadExistingConfig();
    }
  }

  Future<void> _loadExistingConfig() async {
    setState(() => _isLoading = true);
    try {
      final config = await _supabase
          .from('billing_configs')
          .select()
          .eq('id', widget.existingConfigId!)
          .single();

      if (mounted) {
        _tuitionController.text = (config['default_fee'] ?? 0).toString();
        _lateFeeController.text =
            (config['late_fee_percentage'] ?? 5.0).toString();
        setState(() => _isLoading = false);
      }
    } catch (e) {
      if (mounted) {
        setState(() => _isLoading = false);
        _showError('Failed to load configuration: $e');
      }
    }
  }

  Future<void> _saveBillingPeriod() async {
    if (!_formKey.currentState!.validate()) return;

    setState(() => _isLoading = true);

    try {
      // Get school_id
      final schoolId = widget.schoolId ??
          (await ref.read(dashboardDataProvider.future)).schoolId;

      if (schoolId.isEmpty) {
        throw Exception('School ID not found');
      }

      final configData = {
        'id': widget.existingConfigId ?? const Uuid().v4(),
        'school_id': schoolId,
        'currency_code': 'USD',
        'late_fee_percentage': double.tryParse(_lateFeeController.text) ?? 5.0,
        'allow_partial_payments': true,
        'invoice_footer_note': 'Thank you for your payment',
        'default_fee': double.tryParse(_tuitionController.text) ?? 0.0,
        'updated_at': DateTime.now().toIso8601String(),
      };

      // Upsert billing config
      await _supabase.from('billing_configs').upsert(configData);

      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
            content: Text('‚úÖ Billing configuration saved successfully'),
            backgroundColor: AppColors.successGreen,
          ),
        );
        Navigator.of(context).pop(true); // Return true to indicate success
      }
    } catch (e) {
      _showError('Failed to save configuration: $e');
    } finally {
      if (mounted) setState(() => _isLoading = false);
    }
  }

  void _showError(String message) {
    if (!mounted) return;
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(message),
        backgroundColor: AppColors.errorRed,
      ),
    );
  }

  @override
  void dispose() {
    _tuitionController.dispose();
    _uniformController.dispose();
    _levyController.dispose();
    _transportController.dispose();
    _lateFeeController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Dialog(
      backgroundColor: Colors.transparent,
      insetPadding: const EdgeInsets.all(24),
      child: Container(
        width: 900,
        constraints: const BoxConstraints(maxHeight: 720),
        decoration: BoxDecoration(
          color: AppColors.backgroundBlack,
          borderRadius: BorderRadius.circular(16),
          border: Border.all(color: AppColors.surfaceLightGrey),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withValues(alpha: 0.5),
              blurRadius: 20,
              offset: const Offset(0, 10),
            )
          ],
        ),
        child: Column(
          children: [
            // Header
            _buildHeader(),
            const Divider(height: 1, color: AppColors.divider),

            // Body
            Expanded(
              child: _isLoading
                  ? const Center(
                      child: CircularProgressIndicator(
                        color: AppColors.primaryBlue,
                      ),
                    )
                  : SingleChildScrollView(
                      padding: const EdgeInsets.all(32),
                      child: Form(
                        key: _formKey,
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            _buildFrequencySection(),
                            const SizedBox(height: 32),
                            _buildFeeComponentsSection(),
                            const SizedBox(height: 32),
                            _buildBillingDatesSection(),
                            const SizedBox(height: 32),
                            _buildAdvancedSettings(),
                          ],
                        ),
                      ),
                    ),
            ),

            // Footer
            _buildFooter(),
          ],
        ),
      ),
    );
  }

  Widget _buildHeader() {
    return Padding(
      padding: const EdgeInsets.all(24),
      child: Row(
        children: [
          Container(
            padding: const EdgeInsets.all(12),
            decoration: BoxDecoration(
              color: AppColors.primaryBlue.withValues(alpha: 0.2),
              borderRadius: BorderRadius.circular(12),
            ),
            child: const Icon(
              Icons.calendar_month,
              color: AppColors.primaryBlue,
              size: 24,
            ),
          ),
          const SizedBox(width: 16),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  widget.existingConfigId != null
                      ? 'Edit Billing Configuration'
                      : 'Create Billing Period',
                  style: const TextStyle(
                    color: AppColors.textWhite,
                    fontSize: 20,
                    fontWeight: FontWeight.bold,
                  ),
                ),
                const SizedBox(height: 4),
                const Text(
                  'Configure recurring billing cycles and fee structures',
                  style: TextStyle(
                    color: AppColors.textGrey,
                    fontSize: 13,
                  ),
                ),
              ],
            ),
          ),
          IconButton(
            onPressed: () => Navigator.of(context).pop(),
            icon: const Icon(Icons.close, color: AppColors.textGrey),
            tooltip: 'Close',
          ),
        ],
      ),
    );
  }

  Widget _buildFrequencySection() {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        const Text(
          'Billing Frequency',
          style: TextStyle(
            color: AppColors.textWhite,
            fontSize: 16,
            fontWeight: FontWeight.bold,
          ),
        ),
        const SizedBox(height: 16),
        Row(
          children: [
            Expanded(
              child: _buildDropdownField(
                label: 'Frequency',
                value: _selectedFrequency,
                items: _frequencies,
                onChanged: (value) {
                  setState(() => _selectedFrequency = value!);
                },
                icon: Icons.repeat,
              ),
            ),
            const SizedBox(width: 16),
            Expanded(
              child: _buildDropdownField(
                label: 'Grade Level',
                value: _selectedGrade,
                items: _grades,
                onChanged: (value) {
                  setState(() => _selectedGrade = value!);
                },
                icon: Icons.school,
              ),
            ),
          ],
        ),
      ],
    );
  }

  Widget _buildFeeComponentsSection() {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        const Text(
          'Fee Components',
          style: TextStyle(
            color: AppColors.textWhite,
            fontSize: 16,
            fontWeight: FontWeight.bold,
          ),
        ),
        const SizedBox(height: 4),
        const Text(
          'Set standard fees for this billing period',
          style: TextStyle(color: AppColors.textGrey, fontSize: 12),
        ),
        const SizedBox(height: 16),
        Row(
          children: [
            Expanded(
              child: _buildTextField(
                controller: _tuitionController,
                label: 'Tuition',
                hint: '5000.00',
                icon: Icons.school,
                prefix: '\$',
              ),
            ),
            const SizedBox(width: 16),
            Expanded(
              child: _buildTextField(
                controller: _uniformController,
                label: 'Uniform',
                hint: '150.00',
                icon: Icons.checkroom,
                prefix: '\$',
              ),
            ),
          ],
        ),
        const SizedBox(height: 16),
        Row(
          children: [
            Expanded(
              child: _buildTextField(
                controller: _levyController,
                label: 'Levy',
                hint: '200.00',
                icon: Icons.account_balance,
                prefix: '\$',
              ),
            ),
            const SizedBox(width: 16),
            Expanded(
              child: _buildTextField(
                controller: _transportController,
                label: 'Transport',
                hint: '300.00',
                icon: Icons.directions_bus,
                prefix: '\$',
              ),
            ),
          ],
        ),
      ],
    );
  }

  Widget _buildBillingDatesSection() {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        const Text(
          'Billing Schedule',
          style: TextStyle(
            color: AppColors.textWhite,
            fontSize: 16,
            fontWeight: FontWeight.bold,
          ),
        ),
        const SizedBox(height: 16),
        Row(
          children: [
            Expanded(
              child: _buildNumberField(
                label: 'Billing Day',
                value: _billingDay,
                min: 1,
                max: 28,
                onChanged: (value) => setState(() => _billingDay = value),
                helper: 'Day of month when bills are generated',
              ),
            ),
            const SizedBox(width: 16),
            Expanded(
              child: _buildNumberField(
                label: 'Due Day',
                value: _dueDay,
                min: 1,
                max: 31,
                onChanged: (value) => setState(() => _dueDay = value),
                helper: 'Payment deadline day',
              ),
            ),
          ],
        ),
        const SizedBox(height: 16),
        _buildDateField(
          label: 'Effective From',
          value: _effectiveFrom,
          onChanged: (date) => setState(() => _effectiveFrom = date),
        ),
      ],
    );
  }

  Widget _buildAdvancedSettings() {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        const Text(
          'Advanced Settings',
          style: TextStyle(
            color: AppColors.textWhite,
            fontSize: 16,
            fontWeight: FontWeight.bold,
          ),
        ),
        const SizedBox(height: 16),
        Row(
          children: [
            Expanded(
              flex: 2,
              child: _buildTextField(
                controller: _lateFeeController,
                label: 'Late Fee Percentage',
                hint: '5.0',
                icon: Icons.percent,
                suffix: '%',
              ),
            ),
            const SizedBox(width: 16),
            Expanded(
              flex: 3,
              child: Container(
                padding: const EdgeInsets.all(16),
                decoration: BoxDecoration(
                  color: AppColors.surfaceGrey,
                  borderRadius: BorderRadius.circular(8),
                  border: Border.all(color: AppColors.divider),
                ),
                child: Row(
                  children: [
                    const Icon(Icons.info_outline,
                        color: AppColors.textGrey, size: 20),
                    const SizedBox(width: 12),
                    Expanded(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          const Text(
                            'Late Fee Calculation',
                            style: TextStyle(
                              color: AppColors.textWhite,
                              fontSize: 12,
                              fontWeight: FontWeight.bold,
                            ),
                          ),
                          const SizedBox(height: 4),
                          Text(
                            'Applied ${_lateFeeController.text}% after due date',
                            style: const TextStyle(
                              color: AppColors.textGrey,
                              fontSize: 11,
                            ),
                          ),
                        ],
                      ),
                    ),
                  ],
                ),
              ),
            ),
          ],
        ),
        const SizedBox(height: 16),
        SwitchListTile(
          value: _isActive,
          onChanged: (value) => setState(() => _isActive = value),
          title: const Text(
            'Active Configuration',
            style: TextStyle(color: AppColors.textWhite, fontSize: 14),
          ),
          subtitle: const Text(
            'Enable this billing period for new students',
            style: TextStyle(color: AppColors.textGrey, fontSize: 12),
          ),
          activeThumbColor: AppColors.successGreen,
          contentPadding: EdgeInsets.zero,
        ),
      ],
    );
  }

  Widget _buildFooter() {
    return Container(
      padding: const EdgeInsets.all(24),
      decoration: const BoxDecoration(
        border: Border(top: BorderSide(color: AppColors.divider)),
      ),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.end,
        children: [
          TextButton(
            onPressed: _isLoading ? null : () => Navigator.of(context).pop(),
            child: const Text(
              'Cancel',
              style: TextStyle(color: AppColors.textGrey),
            ),
          ),
          const SizedBox(width: 16),
          ElevatedButton.icon(
            onPressed: _isLoading ? null : _saveBillingPeriod,
            icon: _isLoading
                ? const SizedBox(
                    width: 16,
                    height: 16,
                    child: CircularProgressIndicator(
                      strokeWidth: 2,
                      color: Colors.white,
                    ),
                  )
                : const Icon(Icons.check, size: 20),
            label: Text(_isLoading ? 'Saving...' : 'Save Configuration'),
            style: ElevatedButton.styleFrom(
              backgroundColor: AppColors.primaryBlue,
              foregroundColor: Colors.white,
              padding: const EdgeInsets.symmetric(
                horizontal: 24,
                vertical: 16,
              ),
            ),
          ),
        ],
      ),
    );
  }

  // Helper Widgets

  Widget _buildTextField({
    required TextEditingController controller,
    required String label,
    required String hint,
    IconData? icon,
    String? prefix,
    String? suffix,
  }) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          label,
          style: const TextStyle(
            color: AppColors.textWhite70,
            fontSize: 12,
            fontWeight: FontWeight.w500,
          ),
        ),
        const SizedBox(height: 8),
        TextFormField(
          controller: controller,
          keyboardType: TextInputType.number,
          style: const TextStyle(color: AppColors.textWhite),
          decoration: InputDecoration(
            hintText: hint,
            hintStyle: const TextStyle(color: AppColors.textGrey),
            prefixIcon: icon != null
                ? Icon(icon, color: AppColors.textGrey, size: 20)
                : null,
            prefixText: prefix,
            suffixText: suffix,
            filled: true,
            fillColor: AppColors.surfaceGrey,
            border: OutlineInputBorder(
              borderRadius: BorderRadius.circular(8),
              borderSide: const BorderSide(color: AppColors.divider),
            ),
            enabledBorder: OutlineInputBorder(
              borderRadius: BorderRadius.circular(8),
              borderSide: const BorderSide(color: AppColors.divider),
            ),
            focusedBorder: OutlineInputBorder(
              borderRadius: BorderRadius.circular(8),
              borderSide: const BorderSide(color: AppColors.primaryBlue),
            ),
          ),
          validator: (value) {
            if (value == null || value.isEmpty) return null;
            if (double.tryParse(value) == null) {
              return 'Enter a valid number';
            }
            return null;
          },
        ),
      ],
    );
  }

  Widget _buildDropdownField({
    required String label,
    required String value,
    required List<String> items,
    required ValueChanged<String?> onChanged,
    IconData? icon,
  }) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          label,
          style: const TextStyle(
            color: AppColors.textWhite70,
            fontSize: 12,
            fontWeight: FontWeight.w500,
          ),
        ),
        const SizedBox(height: 8),
        DropdownButtonFormField<String>(
          initialValue: value,
          onChanged: onChanged,
          dropdownColor: AppColors.surfaceGrey,
          style: const TextStyle(color: AppColors.textWhite),
          decoration: InputDecoration(
            prefixIcon: icon != null
                ? Icon(icon, color: AppColors.textGrey, size: 20)
                : null,
            filled: true,
            fillColor: AppColors.surfaceGrey,
            border: OutlineInputBorder(
              borderRadius: BorderRadius.circular(8),
              borderSide: const BorderSide(color: AppColors.divider),
            ),
            enabledBorder: OutlineInputBorder(
              borderRadius: BorderRadius.circular(8),
              borderSide: const BorderSide(color: AppColors.divider),
            ),
          ),
          items: items.map((item) {
            return DropdownMenuItem(
              value: item,
              child: Text(
                item
                    .split('_')
                    .map((word) => word[0].toUpperCase() + word.substring(1))
                    .join(' '),
              ),
            );
          }).toList(),
        ),
      ],
    );
  }

  Widget _buildNumberField({
    required String label,
    required int value,
    required int min,
    required int max,
    required ValueChanged<int> onChanged,
    String? helper,
  }) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          label,
          style: const TextStyle(
            color: AppColors.textWhite70,
            fontSize: 12,
            fontWeight: FontWeight.w500,
          ),
        ),
        const SizedBox(height: 8),
        Container(
          decoration: BoxDecoration(
            color: AppColors.surfaceGrey,
            borderRadius: BorderRadius.circular(8),
            border: Border.all(color: AppColors.divider),
          ),
          child: Row(
            children: [
              IconButton(
                onPressed: value > min ? () => onChanged(value - 1) : null,
                icon: const Icon(Icons.remove),
                color: AppColors.textWhite,
              ),
              Expanded(
                child: Text(
                  value.toString(),
                  textAlign: TextAlign.center,
                  style: const TextStyle(
                    color: AppColors.textWhite,
                    fontSize: 16,
                    fontWeight: FontWeight.bold,
                  ),
                ),
              ),
              IconButton(
                onPressed: value < max ? () => onChanged(value + 1) : null,
                icon: const Icon(Icons.add),
                color: AppColors.textWhite,
              ),
            ],
          ),
        ),
        if (helper != null) ...[
          const SizedBox(height: 4),
          Text(
            helper,
            style: const TextStyle(
              color: AppColors.textGrey,
              fontSize: 11,
            ),
          ),
        ],
      ],
    );
  }

  Widget _buildDateField({
    required String label,
    required DateTime value,
    required ValueChanged<DateTime> onChanged,
  }) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          label,
          style: const TextStyle(
            color: AppColors.textWhite70,
            fontSize: 12,
            fontWeight: FontWeight.w500,
          ),
        ),
        const SizedBox(height: 8),
        InkWell(
          onTap: () async {
            final picked = await showDatePicker(
              context: context,
              initialDate: value,
              firstDate: DateTime(2020),
              lastDate: DateTime(2030),
              builder: (context, child) {
                return Theme(
                  data: ThemeData.dark().copyWith(
                    colorScheme: const ColorScheme.dark(
                      primary: AppColors.primaryBlue,
                      surface: AppColors.surfaceGrey,
                    ),
                  ),
                  child: child!,
                );
              },
            );
            if (picked != null) onChanged(picked);
          },
          child: Container(
            padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 16),
            decoration: BoxDecoration(
              color: AppColors.surfaceGrey,
              borderRadius: BorderRadius.circular(8),
              border: Border.all(color: AppColors.divider),
            ),
            child: Row(
              children: [
                const Icon(Icons.calendar_today,
                    color: AppColors.textGrey, size: 20),
                const SizedBox(width: 12),
                Text(
                  DateFormat('MMM dd, yyyy').format(value),
                  style: const TextStyle(
                    color: AppColors.textWhite,
                    fontSize: 14,
                  ),
                ),
              ],
            ),
          ),
        ),
      ],
    );
  }
}

/// Helper function to show billing period dialog from anywhere
Future<bool?> showBillingPeriodDialog(
  BuildContext context, {
  String? schoolId,
  String? existingConfigId,
}) {
  return showDialog<bool>(
    context: context,
    barrierDismissible: false,
    builder: (context) => BillingPeriodDialog(
      schoolId: schoolId,
      existingConfigId: existingConfigId,
    ),
  );
}

// ==========================================
// FILE: ./settings/school_year_registry_card.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../../core/constants/app_colors.dart';
import '../../../../data/providers/settings_provider.dart';

class SchoolYearRegistryCard extends ConsumerWidget {
  final Function(String) onEdit;
  final String? activeEditingId;

  const SchoolYearRegistryCard({
    super.key,
    required this.onEdit,
    this.activeEditingId,
  });

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final schoolYearsAsync = ref.watch(schoolYearsProvider);

    return Container(
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: AppColors.divider),
      ),
      child: Column(
        children: [
          // Header
          Padding(
            padding: const EdgeInsets.all(24),
            child: Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                const Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text("School Year Registry",
                        style: TextStyle(
                            color: AppColors.textWhite,
                            fontSize: 18,
                            fontWeight: FontWeight.bold)),
                    SizedBox(height: 4),
                    Text("Define academic years, active periods, and archives.",
                        style: TextStyle(
                            color: AppColors.textWhite54, fontSize: 13)),
                  ],
                ),
                ElevatedButton.icon(
                  onPressed: () {},
                  icon: const Icon(Icons.add, size: 16),
                  label: const Text("Add New Year"),
                  style: ElevatedButton.styleFrom(
                    backgroundColor: AppColors.primaryBlue,
                    foregroundColor: Colors.white,
                    padding: const EdgeInsets.symmetric(
                        horizontal: 20, vertical: 16),
                  ),
                ),
              ],
            ),
          ),
          const Divider(height: 1, color: AppColors.divider),

          // Column Headers
          Padding(
            padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 16),
            child: Row(
              children: [
                _headerCol("ACADEMIC YEAR", 3),
                _headerCol("DESCRIPTION", 4),
                _headerCol("DATE RANGE", 3),
                _headerCol("STATUS", 2),
                const Spacer(), // Actions space
              ],
            ),
          ),
          const Divider(height: 1, color: AppColors.divider),

          // Rows
          if (schoolYearsAsync.isLoading)
            const Padding(
              padding: EdgeInsets.all(16.0),
              child: Center(child: CircularProgressIndicator()),
            )
          else if (schoolYearsAsync.hasError)
            Padding(
              padding: const EdgeInsets.all(16.0),
              child: Center(
                  child: Text(
                      'Error loading school years: ${schoolYearsAsync.error}')),
            )
          else
            ..._buildRows(schoolYearsAsync.value ?? []),
        ],
      ),
    );
  }

  List<Widget> _buildRows(List<Map<String, dynamic>> years) {
    if (years.isEmpty) {
      return [
        const Padding(
          padding: EdgeInsets.all(16.0),
          child: Center(
              child: Text('No school years found',
                  style: TextStyle(color: AppColors.textWhite54))),
        )
      ];
    }

    final rows = <Widget>[];
    for (final year in years) {
      rows.add(_buildRowFromMap(year));
      rows.add(const Divider(height: 1, color: AppColors.divider));
    }
    // Remove last divider
    if (rows.isNotEmpty) rows.removeLast();
    return rows;
  }

  Widget _buildRowFromMap(Map<String, dynamic> year) {
    final id = year['id'] as String? ?? '';
    final label = year['year_label'] as String? ?? 'Unknown';
    final desc = year['description'] as String? ?? '';
    final startDate = year['start_date'] as String? ?? '';
    final endDate = year['end_date'] as String? ?? '';
    final dates = startDate.isNotEmpty && endDate.isNotEmpty
        ? '$startDate - $endDate'
        : '';
    final active = (year['active'] as int? ?? 0) == 1;
    final status = active ? 'Active' : 'Inactive';
    final statusColor = active ? AppColors.successGreen : AppColors.textWhite54;
    const isEditable = true; // Always allow editing

    return _buildRow(
      id: id,
      label: label,
      desc: desc,
      dates: dates,
      status: status,
      statusColor: statusColor,
      isEditable: isEditable,
    );
  }

  Widget _headerCol(String text, int flex) {
    return Expanded(
      flex: flex,
      child: Text(
        text,
        style: const TextStyle(
            color: AppColors.textWhite38,
            fontSize: 11,
            fontWeight: FontWeight.bold,
            letterSpacing: 0.8),
      ),
    );
  }

  Widget _buildRow({
    required String id,
    required String label,
    required String desc,
    required String dates,
    required String status,
    required Color statusColor,
    bool isEditable = false,
  }) {
    final bool isEditing = activeEditingId == id;

    return Container(
      color: isEditing ? AppColors.primaryBlue.withValues(alpha: 0.05) : null,
      padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 18),
      child: Row(
        children: [
          // Year
          Expanded(
            flex: 3,
            child: Row(
              children: [
                Text(label,
                    style: const TextStyle(
                        color: AppColors.textWhite,
                        fontWeight: FontWeight.w600,
                        fontSize: 13)),
                if (isEditable) ...[
                  const SizedBox(width: 8),
                  const Icon(Icons.edit,
                      size: 12, color: AppColors.primaryBlue),
                ]
              ],
            ),
          ),
          // Description
          Expanded(
              flex: 4,
              child: Text(desc,
                  style: const TextStyle(
                      color: AppColors.textWhite54, fontSize: 13))),
          // Dates
          Expanded(
              flex: 3,
              child: Text(dates,
                  style: const TextStyle(
                      color: AppColors.textWhite54, fontSize: 13))),
          // Status
          Expanded(
            flex: 2,
            child: Row(
              children: [
                Container(
                  padding:
                      const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                  decoration: BoxDecoration(
                    color: statusColor.withValues(alpha: 0.1),
                    borderRadius: BorderRadius.circular(4),
                  ),
                  child: Text(status,
                      style: TextStyle(
                          color: statusColor,
                          fontSize: 11,
                          fontWeight: FontWeight.bold)),
                ),
              ],
            ),
          ),
          // Action Button
          TextButton(
            onPressed: () => onEdit(id),
            child: Text(
              isEditing ? "Editing" : "Edit",
              style: TextStyle(
                  color:
                      isEditing ? AppColors.primaryBlue : AppColors.textWhite54,
                  fontWeight: isEditing ? FontWeight.bold : FontWeight.normal),
            ),
          ),
        ],
      ),
    );
  }
}

// ==========================================
// FILE: ./settings/school_year_settings_view.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../../core/constants/app_colors.dart';
import '../../../../data/providers/school_year_generator_provider.dart';
import '../../../../data/providers/dashboard_provider.dart';
import 'school_year_registry_card.dart';
import 'year_configuration_card.dart';

class SchoolYearSettingsView extends ConsumerStatefulWidget {
  const SchoolYearSettingsView({super.key});

  @override
  ConsumerState<SchoolYearSettingsView> createState() =>
      _SchoolYearSettingsViewState();
}

class _SchoolYearSettingsViewState
    extends ConsumerState<SchoolYearSettingsView> {
  // State to track which year is currently being edited
  String? _editingYearId = "2024-2025";
  bool _hasSeeded = false;

  @override
  void initState() {
    super.initState();
    // Trigger one-time seeding on first load
    WidgetsBinding.instance.addPostFrameCallback((_) {
      _seedYearsIfNeeded();
    });
  }

  /// Runs the year seeder for the current school (one-time)
  Future<void> _seedYearsIfNeeded() async {
    if (_hasSeeded) return;

    final dashboardAsync = ref.read(dashboardDataProvider);
    dashboardAsync.whenData((data) {
      if (data.schoolId.isNotEmpty) {
        setState(() => _hasSeeded = true);
        // Trigger the seeder provider (it's idempotent)
        ref.read(schoolYearSeederProvider(data.schoolId));
      }
    });
  }

  @override
  Widget build(BuildContext context) {
    final dashboardAsync = ref.watch(dashboardDataProvider);

    return dashboardAsync.when(
      loading: () => const Center(child: CircularProgressIndicator()),
      error: (err, _) => Center(
        child: Text(
          'Error loading dashboard: $err',
          style: const TextStyle(color: AppColors.errorRed),
        ),
      ),
      data: (dashboard) {
        final schoolId = dashboard.schoolId;
        if (schoolId.isEmpty) {
          return const Center(
            child: Text(
              '‚ö†Ô∏è No school context found',
              style: TextStyle(color: AppColors.textWhite54),
            ),
          );
        }

        final seederAsync = ref.watch(schoolYearSeederProvider(schoolId));

        // Show seeding progress overlay
        if (seederAsync.isLoading) {
          return const Center(
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                CircularProgressIndicator(),
                SizedBox(height: 16),
                Text(
                  'üìÖ Generating 15 years of academic calendar...',
                  style: TextStyle(color: AppColors.textWhite70),
                ),
                SizedBox(height: 8),
                Text(
                  'This is a one-time operation.',
                  style: TextStyle(color: AppColors.textWhite38, fontSize: 12),
                ),
              ],
            ),
          );
        }

        return Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // 1. Registry Table (Top Card)
            SchoolYearRegistryCard(
              onEdit: (yearId) {
                setState(() => _editingYearId = yearId);
              },
              activeEditingId: _editingYearId,
            ),

            const SizedBox(height: 32),

            // 2. Active Configuration (Bottom Card)
            // Only shows if a year is selected for editing
            if (_editingYearId != null)
              YearConfigurationCard(yearId: _editingYearId!),
          ],
        );
      },
    );
  }
}

// ==========================================
// FILE: ./sidebar.dart
// ==========================================

import 'package:fees_up/pc/widgets/logout_dialog.dart';
import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import '../../core/constants/app_colors.dart';

class DashboardSidebar extends StatefulWidget {
  const DashboardSidebar({super.key});

  @override
  State<DashboardSidebar> createState() => _DashboardSidebarState();
}

class _DashboardSidebarState extends State<DashboardSidebar> {
  
  /// Calculates the active index to highlight the correct item
  /// Returns a unique ID or index for logic if needed.
  String _getCurrentRoute(BuildContext context) {
    return GoRouterState.of(context).uri.toString();
  }

  bool _isActive(String currentRoute, String itemRoute) {
    if (itemRoute == '/' && currentRoute != '/') return false;
    return currentRoute.startsWith(itemRoute);
  }

  // GROUP 1: OPERATIONAL (Day-to-day Management)
  final List<Map<String, dynamic>> _operationalItems = [
    {'icon': Icons.grid_view_rounded, 'label': 'Overview', 'route': '/'},
    {'icon': Icons.receipt_long_rounded, 'label': 'Transactions', 'route': '/transactions'},
    {'icon': Icons.description_outlined, 'label': 'Invoices', 'route': '/invoices'},
    {'icon': Icons.school_outlined, 'label': 'Students', 'route': '/students'},
    {'icon': Icons.bar_chart_rounded, 'label': 'Reports', 'route': '/reports'},
  ];

  // GROUP 2: MESSAGING (Communication Hub)
  final List<Map<String, dynamic>> _messagingItems = [
    {'icon': Icons.campaign_outlined, 'label': 'Broadcasts', 'route': '/announcements'}, // System-wide
    {'icon': Icons.notifications_none_rounded, 'label': 'Notifications', 'route': '/notifications'}, // Personal
  ];

  @override
  Widget build(BuildContext context) {
    final currentRoute = _getCurrentRoute(context);

    return Container(
      width: 260,
      color: const Color(0xFF0F1115),
      child: Column(
        children: [
          // 1. BRAND HEADER
          Padding(
            padding: const EdgeInsets.all(24.0),
            child: Row(
              children: [
                Container(
                  padding: const EdgeInsets.all(8),
                  decoration: BoxDecoration(
                    color: AppColors.surfaceGrey,
                    borderRadius: BorderRadius.circular(8),
                    border: Border.all(color: Colors.white12),
                  ),
                  child: const Icon(Icons.shield_outlined, color: AppColors.primaryBlue, size: 20),
                ),
                const SizedBox(width: 12),
                Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    const Text(
                      "School Admin",
                      style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold, fontSize: 14),
                    ),
                    Text(
                      "Financial Portal",
                      style: TextStyle(color: Colors.white.withValues(alpha: 0.5), fontSize: 12),
                    ),
                  ],
                )
              ],
            ),
          ),

          // 2. SCROLLABLE MENU AREA
          Expanded(
            child: ListView(
              padding: const EdgeInsets.symmetric(horizontal: 16),
              children: [
                // --- SECTION: OPERATIONS ---
                ..._operationalItems.map((item) => _SidebarItem(
                  icon: item['icon'],
                  label: item['label'],
                  isSelected: _isActive(currentRoute, item['route']),
                  onTap: () => context.go(item['route']),
                )),

                const SizedBox(height: 24),
                
                // --- SECTION: MESSAGING ---
                _sectionLabel("MESSAGING"),
                ..._messagingItems.map((item) => _SidebarItem(
                  icon: item['icon'],
                  label: item['label'],
                  isSelected: _isActive(currentRoute, item['route']),
                  onTap: () => context.go(item['route']),
                )),
              ],
            ),
          ),

          // 3. BOTTOM PREFERENCES
          const Divider(color: Colors.white10, indent: 20, endIndent: 20),
          Padding(
            padding: const EdgeInsets.all(16.0),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                _sectionLabel("PREFERENCES"),
                
                _SidebarItem(
                  icon: Icons.person_outline_rounded,
                  label: "Profile",
                  isSelected: _isActive(currentRoute, '/profile'),
                  onTap: () => context.go('/profile'),
                ),
                const SizedBox(height: 4),

                _SidebarItem(
                  icon: Icons.settings_outlined,
                  label: "Settings",
                  isSelected: _isActive(currentRoute, '/settings'),
                  onTap: () => context.go('/settings'),
                ),
                const SizedBox(height: 4),

                _SidebarItem(
                  icon: Icons.logout_rounded,
                  label: "Log Out",
                  isSelected: false,
                  isDestructive: true,
                  onTap: () {
                    showDialog(
                      context: context,
                      barrierColor: Colors.black.withValues(alpha: 0.7),
                      builder: (context) => const LogoutDialog(),
                    );
                  },
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _sectionLabel(String text) {
    return Padding(
      padding: const EdgeInsets.only(left: 12, bottom: 8, top: 4),
      child: Text(
        text,
        style: TextStyle(
          color: Colors.white.withValues(alpha: 0.4),
          fontSize: 11,
          fontWeight: FontWeight.bold,
          letterSpacing: 1.2,
        ),
      ),
    );
  }
}

class _SidebarItem extends StatefulWidget {
  final IconData icon;
  final String label;
  final bool isSelected;
  final bool isDestructive;
  final VoidCallback onTap;

  const _SidebarItem({
    required this.icon,
    required this.label,
    required this.isSelected,
    this.isDestructive = false,
    required this.onTap,
  });

  @override
  State<_SidebarItem> createState() => _SidebarItemState();
}

class _SidebarItemState extends State<_SidebarItem> {
  bool _isHovered = false;

  @override
  Widget build(BuildContext context) {
    final Color bgColor = widget.isSelected
        ? AppColors.primaryBlue
        : (_isHovered ? Colors.white.withValues(alpha: 0.05) : Colors.transparent);

    final Color textColor = widget.isDestructive
        ? AppColors.errorRed
        : (widget.isSelected ? Colors.white : Colors.white70);

    final Color iconColor = widget.isDestructive
        ? AppColors.errorRed
        : (widget.isSelected ? Colors.white : Colors.white54);

    return MouseRegion(
      onEnter: (_) => setState(() => _isHovered = true),
      onExit: (_) => setState(() => _isHovered = false),
      cursor: SystemMouseCursors.click,
      child: GestureDetector(
        onTap: widget.onTap,
        child: AnimatedContainer(
          duration: const Duration(milliseconds: 200),
          curve: Curves.easeInOut,
          margin: const EdgeInsets.only(bottom: 8),
          padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
          decoration: BoxDecoration(
            color: bgColor,
            borderRadius: BorderRadius.circular(12),
          ),
          child: Row(
            children: [
              Icon(widget.icon, size: 20, color: iconColor),
              const SizedBox(width: 12),
              Text(
                widget.label,
                style: TextStyle(
                  color: textColor,
                  fontWeight: widget.isSelected ? FontWeight.bold : FontWeight.w500,
                  fontSize: 14,
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}
// ==========================================
// FILE: ./transactions/transactions_table.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../../core/constants/app_colors.dart';
import '../../../../data/providers/dashboard_provider.dart';
import '../../../../data/providers/transactions_provider.dart';

class TransactionsTable extends ConsumerStatefulWidget {
  const TransactionsTable({super.key});

  @override
  ConsumerState<TransactionsTable> createState() => _TransactionsTableState();
}

class _TransactionsTableState extends ConsumerState<TransactionsTable> {
  late int _selectedFilterIndex = 0;
  late String _searchQuery = '';
  late final String _sortColumn = 'transaction_date';
  late final bool _sortAscending = false;
  late int _currentPage = 1;
  late final int _pageSize = 10;
  late String _selectedDateFilter =
      'this_month'; // 'this_month', 'last_month', 'all_time'

  final List<String> _filters = [
    "All Transactions",
    "Income",
    "Expenses",
    "Pending"
  ];

  final List<MapEntry<String, String>> _dateFilters = [
    const MapEntry('this_month', 'This Month'),
    const MapEntry('last_month', 'Last Month'),
    const MapEntry('last_3_months', 'Last 3 Months'),
    const MapEntry('this_year', 'This Year'),
    const MapEntry('all_time', 'All Time'),
  ];

  @override
  Widget build(BuildContext context) {
    final dashboardAsync = ref.watch(dashboardDataProvider);

    return dashboardAsync.when(
      loading: () => const Center(child: CircularProgressIndicator()),
      error: (err, stack) => Center(child: Text('Error: $err')),
      data: (dashboardData) {
        final schoolId = dashboardData.schoolId;
        final transactionsAsync = ref.watch(allTransactionsProvider(schoolId));

        return transactionsAsync.when(
          loading: () => const Center(child: CircularProgressIndicator()),
          error: (err, stack) => Center(child: Text('Error: $err')),
          data: (transactions) => _buildContent(transactions),
        );
      },
    );
  }

  Widget _buildContent(List<Map<String, dynamic>> transactions) {
    // Apply filters
    var filtered = _applyFilters(transactions);

    // Calculate pagination
    final totalItems = filtered.length;
    final totalPages = (totalItems / _pageSize).ceil().clamp(1, 999);
    if (_currentPage > totalPages) {
      _currentPage = totalPages;
    }

    final startIndex = (_currentPage - 1) * _pageSize;
    final endIndex = (startIndex + _pageSize).clamp(0, totalItems);
    final paginatedItems = filtered.sublist(
      startIndex,
      endIndex > totalItems ? totalItems : endIndex,
    );

    return Container(
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: AppColors.divider),
      ),
      child: Column(
        children: [
          // 1. TOOLBAR
          Padding(
            padding: const EdgeInsets.all(16),
            child: Row(
              children: [
                // Filter Tabs (Pills)
                ...List.generate(_filters.length, (index) {
                  return _buildFilterTab(
                    label: _filters[index],
                    isSelected: _selectedFilterIndex == index,
                    onTap: () => setState(() => _selectedFilterIndex = index),
                  );
                }),

                const Spacer(),

                // Date Filter (Standardized)
                Container(
                  height: 36,
                  padding: const EdgeInsets.symmetric(horizontal: 12),
                  decoration: BoxDecoration(
                    color: AppColors.backgroundBlack,
                    borderRadius: BorderRadius.circular(8),
                    border: Border.all(color: AppColors.divider),
                  ),
                  child: DropdownButton<String>(
                    value: _selectedDateFilter,
                    underline: const SizedBox(),
                    dropdownColor: AppColors.backgroundBlack,
                    style: const TextStyle(
                        color: AppColors.textWhite, fontSize: 13),
                    icon: const Icon(Icons.keyboard_arrow_down,
                        color: AppColors.textWhite54, size: 16),
                    items: _dateFilters
                        .map((entry) => DropdownMenuItem(
                              value: entry.key,
                              child: Text(entry.value),
                            ))
                        .toList(),
                    onChanged: (newValue) {
                      setState(() {
                        _selectedDateFilter = newValue ?? 'this_month';
                        _currentPage = 1; // Reset to first page
                      });
                    },
                  ),
                ),
                const SizedBox(width: 12),

                // More Actions Icon
                IconButton(
                  onPressed: () => _resetFilters(),
                  icon: const Icon(Icons.filter_list,
                      color: AppColors.textWhite70, size: 20),
                  tooltip: "Reset Filters",
                ),
              ],
            ),
          ),
          const Divider(height: 1, color: AppColors.divider),

          // 2. COLUMN HEADERS
          Padding(
            padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 16),
            child: Row(
              children: [
                _headerText("REFERENCE ID", flex: 2),
                _headerText("DATE", flex: 2),
                _headerText("ENTITY / STUDENT", flex: 3),
                _headerText("CATEGORY", flex: 3),
                _headerText("METHOD", flex: 2),
                _headerText("AMOUNT", flex: 2, alignRight: true),
              ],
            ),
          ),
          const Divider(height: 1, color: AppColors.divider),

          // 3. ROWS
          ..._buildTransactionRows(paginatedItems),

          // 4. FOOTER (Pagination)
          Padding(
            padding: const EdgeInsets.all(16.0),
            child: Row(
              mainAxisAlignment: MainAxisAlignment.end,
              children: [
                Text("Showing ${startIndex + 1} to $endIndex of $totalItems",
                    style: const TextStyle(
                        color: AppColors.textWhite54, fontSize: 13)),
                const SizedBox(width: 24),
                _paginationBtn(
                  icon: Icons.chevron_left,
                  onPressed: _currentPage > 1
                      ? () => setState(() => _currentPage = (_currentPage - 1))
                      : null,
                ),
                const SizedBox(width: 8),
                ..._buildPageButtons(totalPages),
                const SizedBox(width: 8),
                _paginationBtn(
                  icon: Icons.chevron_right,
                  onPressed: _currentPage < totalPages
                      ? () => setState(() => _currentPage = (_currentPage + 1))
                      : null,
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  List<Widget> _buildTransactionRows(List<Map<String, dynamic>> transactions) {
    if (transactions.isEmpty) {
      return [
        const Padding(
          padding: EdgeInsets.all(16.0),
          child: Center(
              child: Text('No transactions found',
                  style: TextStyle(color: AppColors.textWhite54))),
        )
      ];
    }

    final rows = <Widget>[];
    for (final transaction in transactions) {
      rows.add(_TransactionRowFromMap(transaction: transaction));
      rows.add(const Divider(height: 1, color: AppColors.divider));
    }
    // Remove last divider
    if (rows.isNotEmpty) rows.removeLast();
    return rows;
  }

  // --- FILTERS ---

  List<Map<String, dynamic>> _applyFilters(
      List<Map<String, dynamic>> transactions) {
    // Create mutable copy to avoid read-only error
    var filtered = List<Map<String, dynamic>>.from(transactions);

    // Apply filter based on selected index
    if (_selectedFilterIndex == 1) {
      // Income (payments + donations)
      filtered = filtered.where((t) {
        final type = t['transaction_type'] as String?;
        return type == 'payment' || type == 'donation';
      }).toList();
    } else if (_selectedFilterIndex == 2) {
      // Expenses
      filtered =
          filtered.where((t) => t['transaction_type'] == 'expense').toList();
    } else if (_selectedFilterIndex == 3) {
      // Pending - would need bills data, skip for now
      filtered = [];
    }

    // Apply search if needed (for future)
    if (_searchQuery.isNotEmpty) {
      filtered = filtered.where((t) {
        final id = (t['id'] as String? ?? '').toLowerCase();
        final entity = (t['entity_name'] as String? ?? '').toLowerCase();
        final category = (t['category'] as String? ?? '').toLowerCase();
        final method = (t['method'] as String? ?? '').toLowerCase();
        final query = _searchQuery.toLowerCase();
        return id.contains(query) ||
            entity.contains(query) ||
            category.contains(query) ||
            method.contains(query);
      }).toList();
    }

    // Apply sorting
    if (_sortColumn.isNotEmpty) {
      filtered.sort((a, b) {
        final aVal = a[_sortColumn];
        final bVal = b[_sortColumn];
        if (aVal == null && bVal == null) return 0;
        if (aVal == null) return 1;
        if (bVal == null) return -1;
        final comparison = aVal.toString().compareTo(bVal.toString());
        return _sortAscending ? comparison : -comparison;
      });
    }

    return filtered;
  }

  // --- HELPERS ---

  Widget _buildFilterTab(
      {required String label,
      required bool isSelected,
      required VoidCallback onTap}) {
    return GestureDetector(
      onTap: onTap,
      child: Container(
        margin: const EdgeInsets.only(right: 8),
        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
        decoration: BoxDecoration(
          color: isSelected ? AppColors.primaryBlue : Colors.transparent,
          borderRadius: BorderRadius.circular(6),
          // Add border for unselected state to define clickable area clearly
          border: isSelected ? null : Border.all(color: Colors.transparent),
        ),
        child: Text(
          label,
          style: TextStyle(
            color: isSelected ? Colors.white : AppColors.textWhite70,
            fontWeight: isSelected ? FontWeight.bold : FontWeight.normal,
            fontSize: 13,
          ),
        ),
      ),
    );
  }

  Widget _headerText(String text, {int flex = 1, bool alignRight = false}) {
    return Expanded(
      flex: flex,
      child: Text(
        text,
        textAlign: alignRight ? TextAlign.right : TextAlign.left,
        style: const TextStyle(
          color: AppColors.textWhite38,
          fontSize: 11,
          fontWeight: FontWeight.bold,
          letterSpacing: 0.8, // Slightly increased spacing for legibility
        ),
      ),
    );
  }

  Widget _paginationBtn(
      {String? label,
      IconData? icon,
      bool isActive = false,
      VoidCallback? onPressed}) {
    final isDisabled = onPressed == null;
    return GestureDetector(
      onTap: isDisabled ? null : onPressed,
      child: Container(
        width: 32,
        height: 32,
        alignment: Alignment.center,
        decoration: BoxDecoration(
          color: isActive ? AppColors.primaryBlue : Colors.transparent,
          borderRadius: BorderRadius.circular(4),
          border: Border.all(
              color: isDisabled
                  ? AppColors.divider.withValues(alpha: 0.3)
                  : isActive
                      ? AppColors.primaryBlue
                      : AppColors.divider),
        ),
        child: icon != null
            ? Icon(icon,
                size: 16,
                color:
                    isDisabled ? AppColors.textWhite38 : AppColors.textWhite70)
            : Text(label!,
                style: TextStyle(
                    color: isDisabled
                        ? AppColors.textWhite38
                        : isActive
                            ? Colors.white
                            : AppColors.textWhite70,
                    fontSize: 12)),
      ),
    );
  }

  void _resetFilters() {
    setState(() {
      _selectedFilterIndex = 0;
      _searchQuery = '';
      _currentPage = 1;
      _selectedDateFilter = 'this_month';
    });
  }

  List<Widget> _buildPageButtons(int totalPages) {
    final buttons = <Widget>[];
    int startPage = 1;
    int endPage = totalPages;

    // Show max 5 page buttons
    if (totalPages > 5) {
      startPage = (_currentPage - 2).clamp(1, totalPages - 4);
      endPage = startPage + 4;
    }

    if (startPage > 1) {
      buttons.add(_paginationBtn(
        label: "1",
        onPressed: () => setState(() => _currentPage = 1),
      ));
      buttons.add(const SizedBox(width: 8));
      if (startPage > 2) {
        buttons.add(_paginationBtn(label: "..."));
        buttons.add(const SizedBox(width: 8));
      }
    }

    for (int i = startPage; i <= endPage; i++) {
      buttons.add(_paginationBtn(
        label: i.toString(),
        isActive: i == _currentPage,
        onPressed: () => setState(() => _currentPage = i),
      ));
      if (i < endPage) {
        buttons.add(const SizedBox(width: 8));
      }
    }

    if (endPage < totalPages) {
      buttons.add(const SizedBox(width: 8));
      if (endPage < totalPages - 1) {
        buttons.add(_paginationBtn(label: "..."));
        buttons.add(const SizedBox(width: 8));
      }
      buttons.add(_paginationBtn(
        label: totalPages.toString(),
        onPressed: () => setState(() => _currentPage = totalPages),
      ));
    }

    return buttons;
  }
}

class _TransactionRowFromMap extends StatelessWidget {
  final Map<String, dynamic> transaction;
  const _TransactionRowFromMap({required this.transaction});

  @override
  Widget build(BuildContext context) {
    final id = transaction['id'] as String? ?? 'Unknown';
    final date = transaction['date_paid'] as String? ?? '';
    final method = transaction['method'] as String? ?? 'Unknown';
    final amount = transaction['amount'] as num? ?? 0;
    final isExpense = amount < 0;
    final amountText = isExpense
        ? '-\$${amount.abs().toStringAsFixed(2)}'
        : '+\$${amount.toStringAsFixed(2)}';
    final amountColor =
        isExpense ? AppColors.textWhite : AppColors.successGreen;

    return Container(
      decoration: const BoxDecoration(
        border: Border(bottom: BorderSide(color: AppColors.divider)),
      ),
      child: Material(
        color: Colors.transparent,
        child: InkWell(
          hoverColor: AppColors.textWhite.withValues(alpha: 0.03),
          onTap: () {},
          child: Padding(
            padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 16),
            child: Row(
              children: [
                // 1. REF ID
                Expanded(
                  flex: 2,
                  child: Text(
                    id,
                    style: const TextStyle(
                        color: AppColors.textWhite,
                        fontWeight: FontWeight.bold,
                        fontFamily: 'monospace'),
                  ),
                ),
                // 2. DATE
                Expanded(
                  flex: 2,
                  child: Text(
                    date,
                    style: const TextStyle(color: AppColors.textWhite),
                  ),
                ),
                // 3. METHOD
                Expanded(
                  flex: 2,
                  child: Text(
                    method,
                    style: const TextStyle(color: AppColors.textWhite),
                  ),
                ),
                // 4. AMOUNT
                Expanded(
                  flex: 2,
                  child: Text(
                    amountText,
                    textAlign: TextAlign.right,
                    style: TextStyle(
                        color: amountColor, fontWeight: FontWeight.bold),
                  ),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }
}

// ==========================================
// FILE: ./transactions/payment_allocation_dialog.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:supabase_flutter/supabase_flutter.dart';

import '../../../../core/constants/app_colors.dart';
import '../../../../data/services/transaction_service.dart';

/// üîí SECURE Payment Allocation Dialog
/// Allows users to allocate a payment across one or more bills
/// Supports partial payments and multi-bill allocation
class PaymentAllocationDialog extends ConsumerStatefulWidget {
  final String paymentId;
  final double paymentAmount;
  final List<Map<String, dynamic>> outstandingBills;
  final String studentId;
  final String schoolId;
  final VoidCallback onAllocationComplete;

  const PaymentAllocationDialog({
    super.key,
    required this.paymentId,
    required this.paymentAmount,
    required this.outstandingBills,
    required this.studentId,
    required this.schoolId,
    required this.onAllocationComplete,
  });

  @override
  ConsumerState<PaymentAllocationDialog> createState() =>
      _PaymentAllocationDialogState();
}

class _PaymentAllocationDialogState
    extends ConsumerState<PaymentAllocationDialog> {
  late final TransactionService _transactionService;
  final Map<String, double> _allocations = {}; // billId -> allocatedAmount
  double _remainingAmount = 0.0;
  bool _isLoading = false;

  @override
  void initState() {
    super.initState();
    _transactionService = TransactionService(supabase: Supabase.instance.client);
    _remainingAmount = widget.paymentAmount;

    // Initialize allocations with zero for each bill
    for (final bill in widget.outstandingBills) {
      _allocations[bill['id'] as String] = 0.0;
    }
  }

  /// Update allocation for a bill
  void _updateAllocation(String billId, double amount) {
    setState(() {
      _allocations[billId] = amount.clamp(0.0, widget.paymentAmount);

      // Recalculate remaining
      _remainingAmount = widget.paymentAmount -
          _allocations.values.fold(0.0, (sum, val) => sum + val);
    });
  }

  /// Auto-allocate: Fill bills in order until payment is exhausted
  void _autoAllocate() {
    setState(() {
      double remaining = widget.paymentAmount;
      _allocations.clear();

      for (final bill in widget.outstandingBills) {
        final billId = bill['id'] as String;
        final outstanding = bill['outstanding_balance'] as double? ?? 0.0;

        if (remaining <= 0) {
          _allocations[billId] = 0.0;
        } else if (remaining >= outstanding) {
          _allocations[billId] = outstanding;
          remaining -= outstanding;
        } else {
          _allocations[billId] = remaining;
          remaining = 0.0;
        }
      }

      _remainingAmount = remaining;
    });
  }

  /// Split equally across all bills
  void _splitEqually() {
    final perBill = widget.paymentAmount / widget.outstandingBills.length;
    setState(() {
      for (final bill in widget.outstandingBills) {
        _allocations[bill['id'] as String] = perBill;
      }
      _remainingAmount = 0.0;
    });
  }

  /// Submit allocations
  Future<void> _submitAllocations() async {
    // Validate: at least one allocation
    final hasAllocations =
        _allocations.values.any((amount) => amount > 0);
    if (!hasAllocations) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text('Allocate payment to at least one bill'),
          backgroundColor: AppColors.errorRed,
        ),
      );
      return;
    }

    setState(() => _isLoading = true);

    try {
      // Get non-zero allocations
      final allocationsToProcess = _allocations.entries
          .where((e) => e.value > 0)
          .map((e) => MapEntry(e.key, e.value))
          .toList();

      // Allocate payment to bills
      await _transactionService.allocatePaymentToMultipleBills(
        paymentId: widget.paymentId,
        billAllocations: allocationsToProcess, schoolId: '',
      );

      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
            content: Text('Payment allocated successfully'),
            backgroundColor: AppColors.successGreen,
          ),
        );

        widget.onAllocationComplete();
        Navigator.of(context).pop();
      }
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Error: $e'),
            backgroundColor: AppColors.errorRed,
          ),
        );
      }
    } finally {
      if (mounted) setState(() => _isLoading = false);
    }
  }

  @override
  Widget build(BuildContext context) {
    return Dialog(
      backgroundColor: Colors.transparent,
      insetPadding: const EdgeInsets.all(24),
      child: Container(
        width: 900,
        constraints: const BoxConstraints(maxHeight: 700),
        decoration: BoxDecoration(
          color: AppColors.backgroundBlack,
          borderRadius: BorderRadius.circular(16),
          border: Border.all(color: AppColors.surfaceLightGrey),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withValues(alpha: 0.5),
              blurRadius: 20,
              offset: const Offset(0, 10),
            )
          ],
        ),
        child: Column(
          children: [
            // HEADER
            Padding(
              padding: const EdgeInsets.symmetric(horizontal: 32, vertical: 24),
              child: Row(
                children: [
                  Container(
                    padding: const EdgeInsets.all(8),
                    decoration: BoxDecoration(
                      color: AppColors.primaryBlue.withValues(alpha: 0.2),
                      borderRadius: BorderRadius.circular(8),
                    ),
                    child: const Icon(Icons.attach_money,
                        color: AppColors.primaryBlue),
                  ),
                  const SizedBox(width: 16),
                  Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      const Text("Allocate Payment",
                          style: TextStyle(
                              color: AppColors.textWhite,
                              fontSize: 18,
                              fontWeight: FontWeight.bold)),
                      Text(
                          'Payment: \$${widget.paymentAmount.toStringAsFixed(2)}',
                          style: const TextStyle(
                              color: AppColors.textGrey, fontSize: 13)),
                    ],
                  ),
                  const Spacer(),
                  IconButton(
                    onPressed: () => Navigator.pop(context),
                    icon: const Icon(Icons.close, color: AppColors.textGrey),
                  ),
                ],
              ),
            ),
            const Divider(height: 1, color: AppColors.divider),

            // CONTENT
            Expanded(
              child: SingleChildScrollView(
                padding: const EdgeInsets.all(32),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    // Quick Actions
                    Row(
                      children: [
                        ElevatedButton.icon(
                          onPressed: _autoAllocate,
                          style: ElevatedButton.styleFrom(
                            backgroundColor:
                                AppColors.primaryBlue.withValues(alpha: 0.2),
                            foregroundColor: AppColors.primaryBlue,
                            shape: RoundedRectangleBorder(
                              borderRadius: BorderRadius.circular(8),
                            ),
                          ),
                          icon: const Icon(Icons.auto_awesome, size: 18),
                          label: const Text('Auto-Allocate'),
                        ),
                        const SizedBox(width: 12),
                        ElevatedButton.icon(
                          onPressed: _splitEqually,
                          style: ElevatedButton.styleFrom(
                            backgroundColor:
                                AppColors.primaryBlue.withValues(alpha: 0.2),
                            foregroundColor: AppColors.primaryBlue,
                            shape: RoundedRectangleBorder(
                              borderRadius: BorderRadius.circular(8),
                            ),
                          ),
                          icon: const Icon(Icons.rule_folder, size: 18),
                          label: const Text('Split Equally'),
                        ),
                      ],
                    ),
                    const SizedBox(height: 24),

                    // Bills List
                    Text('Outstanding Bills',
                        style: TextStyle(
                          color: AppColors.textWhite.withValues(alpha: 0.9),
                          fontSize: 14,
                          fontWeight: FontWeight.w500,
                        )),
                    const SizedBox(height: 16),

                    if (widget.outstandingBills.isEmpty)
                      Container(
                        padding: const EdgeInsets.all(24),
                        decoration: BoxDecoration(
                          color: AppColors.surfaceGrey,
                          borderRadius: BorderRadius.circular(8),
                        ),
                        child: const Center(
                          child: Text('No outstanding bills',
                              style: TextStyle(color: AppColors.textGrey)),
                        ),
                      )
                    else
                      ListView.separated(
                        shrinkWrap: true,
                        physics: const NeverScrollableScrollPhysics(),
                        itemCount: widget.outstandingBills.length,
                        separatorBuilder: (_, __) => const SizedBox(height: 12),
                        itemBuilder: (context, index) {
                          final bill = widget.outstandingBills[index];
                          final billId = bill['id'] as String;
                          final title = bill['title'] as String? ?? 'Unknown Bill';
                          final outstanding =
                              bill['outstanding_balance'] as double? ?? 0.0;
                          final allocated = _allocations[billId] ?? 0.0;

                          return _buildBillAllocationRow(
                            billId: billId,
                            title: title,
                            outstandingAmount: outstanding,
                            allocatedAmount: allocated,
                            onAllocationChanged: _updateAllocation,
                          );
                        },
                      ),

                    const SizedBox(height: 24),

                    // Summary
                    Container(
                      padding: const EdgeInsets.all(16),
                      decoration: BoxDecoration(
                        color: AppColors.surfaceDarkGrey,
                        borderRadius: BorderRadius.circular(8),
                        border: Border.all(color: AppColors.surfaceLightGrey),
                      ),
                      child: Row(
                        mainAxisAlignment: MainAxisAlignment.spaceBetween,
                        children: [
                          Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              Text('Total Allocated',
                                  style: TextStyle(
                                    color: AppColors.textWhite
                                        .withValues(alpha: 0.7),
                                    fontSize: 12,
                                  )),
                              Text(
                                '\$${(widget.paymentAmount - _remainingAmount).toStringAsFixed(2)}',
                                style: const TextStyle(
                                  color: AppColors.textWhite,
                                  fontSize: 20,
                                  fontWeight: FontWeight.bold,
                                ),
                              ),
                            ],
                          ),
                          Container(
                            width: 1,
                            height: 40,
                            color: AppColors.surfaceLightGrey,
                          ),
                          Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              Text('Remaining',
                                  style: TextStyle(
                                    color: AppColors.textWhite
                                        .withValues(alpha: 0.7),
                                    fontSize: 12,
                                  )),
                              Text(
                                '\$${_remainingAmount.toStringAsFixed(2)}',
                                style: TextStyle(
                                  color: _remainingAmount > 0.01
                                      ? AppColors.warningOrange
                                      : AppColors.successGreen,
                                  fontSize: 20,
                                  fontWeight: FontWeight.bold,
                                ),
                              ),
                            ],
                          ),
                        ],
                      ),
                    ),
                  ],
                ),
              ),
            ),

            const Divider(height: 1, color: AppColors.divider),

            // FOOTER
            Padding(
              padding: const EdgeInsets.all(24),
              child: Row(
                mainAxisAlignment: MainAxisAlignment.end,
                children: [
                  TextButton(
                    onPressed: () => Navigator.pop(context),
                    child: const Text('Cancel',
                        style: TextStyle(color: AppColors.textWhite70)),
                  ),
                  const SizedBox(width: 16),
                  ElevatedButton.icon(
                    onPressed: _isLoading ? null : _submitAllocations,
                    style: ElevatedButton.styleFrom(
                      backgroundColor: AppColors.primaryBlue,
                      padding: const EdgeInsets.symmetric(
                          horizontal: 24, vertical: 16),
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(8),
                      ),
                      foregroundColor: AppColors.textWhite,
                    ),
                    icon: _isLoading
                        ? const SizedBox(
                            width: 16,
                            height: 16,
                            child: CircularProgressIndicator(
                              strokeWidth: 2,
                              color: AppColors.textWhite,
                            ),
                          )
                        : const Icon(Icons.check, size: 18),
                    label: Text(
                      _isLoading ? 'Allocating...' : 'Confirm Allocation',
                      style: const TextStyle(fontWeight: FontWeight.bold),
                    ),
                  ),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildBillAllocationRow({
    required String billId,
    required String title,
    required double outstandingAmount,
    required double allocatedAmount,
    required Function(String, double) onAllocationChanged,
  }) {
    final controller = TextEditingController(
      text: allocatedAmount > 0 ? allocatedAmount.toStringAsFixed(2) : '',
    );

    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(8),
        border: Border.all(color: AppColors.surfaceLightGrey),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(title,
                      style: const TextStyle(
                          color: AppColors.textWhite,
                          fontWeight: FontWeight.w500)),
                  const SizedBox(height: 4),
                  Text(
                      'Outstanding: \$${outstandingAmount.toStringAsFixed(2)}',
                      style: const TextStyle(
                          color: AppColors.textGrey, fontSize: 12)),
                ],
              ),
              Text(
                _getProgressBar(allocatedAmount, outstandingAmount),
                style: const TextStyle(
                  color: AppColors.primaryBlueLight,
                  fontSize: 12,
                  fontWeight: FontWeight.bold,
                ),
              ),
            ],
          ),
          const SizedBox(height: 12),
          Row(
            children: [
              const Text('\$',
                  style: TextStyle(
                      color: AppColors.textWhite,
                      fontWeight: FontWeight.bold)),
              const SizedBox(width: 8),
              Expanded(
                child: TextField(
                  controller: controller,
                  keyboardType:
                      const TextInputType.numberWithOptions(decimal: true),
                  style: const TextStyle(color: AppColors.textWhite),
                  decoration: InputDecoration(
                    filled: true,
                    fillColor: AppColors.surfaceDarkGrey,
                    hintText: '0.00',
                    hintStyle: TextStyle(
                        color: AppColors.textWhite.withValues(alpha: 0.3)),
                    border: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(4),
                      borderSide: const BorderSide(
                          color: AppColors.surfaceLightGrey),
                    ),
                    enabledBorder: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(4),
                      borderSide: const BorderSide(
                          color: AppColors.surfaceLightGrey),
                    ),
                    focusedBorder: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(4),
                      borderSide:
                          const BorderSide(color: AppColors.primaryBlue),
                    ),
                    contentPadding: const EdgeInsets.symmetric(
                        horizontal: 12, vertical: 8),
                  ),
                  onChanged: (value) {
                    final amount = double.tryParse(value) ?? 0.0;
                    onAllocationChanged(billId, amount);
                  },
                ),
              ),
            ],
          ),
        ],
      ),
    );
  }

  String _getProgressBar(double allocated, double outstanding) {
    if (outstanding == 0) return '100%';
    final percentage = ((allocated / outstanding) * 100).clamp(0.0, 100.0);
    return '${percentage.toStringAsFixed(0)}%';
  }
}

// ==========================================
// FILE: ./transactions/universal_entry_dialog.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../core/constants/app_colors.dart';

// --- DIRECT IMPORTS OF YOUR EXISTING DIALOGS ---
// We use them exactly as they are. No changes needed to them.
import '../dashboard/payment_dialog.dart';
import '../dashboard/expense_dialog.dart';
import '../dashboard/student_dialog.dart';
import '../dashboard/campaign_dialog.dart';

/// Global flag to track if the active form has unsaved data.
/// You will wire this up inside your individual dialogs later.
final formDirtyProvider = StateProvider<bool>((ref) => false);

enum TransactionType {
  // Current Modules
  payment,
  expense,
  student,
  campaign,
  // Future / Professional Modules
  payroll,
  assets,
  bulkImport,
  auditLog
}

class UniversalTransactionDialog extends ConsumerStatefulWidget {
  final String schoolId;
  final TransactionType initialType;

  const UniversalTransactionDialog({
    super.key, 
    required this.schoolId, 
    this.initialType = TransactionType.payment
  });

  @override
  ConsumerState<UniversalTransactionDialog> createState() => _UniversalTransactionDialogState();
}

class _UniversalTransactionDialogState extends ConsumerState<UniversalTransactionDialog> {
  late TransactionType _selectedType;

  @override
  void initState() {
    super.initState();
    _selectedType = widget.initialType;
  }

  /// -----------------------------------------------------------------------
  /// SWITCHING LOGIC (The "Safety Lock")
  /// -----------------------------------------------------------------------
  void _handleTypeSwitch(TransactionType newType) {
    if (_selectedType == newType) return;

    // 1. Future Feature Guard
    if (_isFutureFeature(newType)) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text("This Professional Module is coming in v2.0"),
          backgroundColor: AppColors.surfaceLightGrey,
          behavior: SnackBarBehavior.floating,
          width: 400,
        ),
      );
      return;
    }

    // 2. Dirty Check (Prevents accidental data loss)
    final isDirty = ref.read(formDirtyProvider);
    if (isDirty) {
      _showDiscardConfirmation(newType);
    } else {
      _performSwitch(newType);
    }
  }

  bool _isFutureFeature(TransactionType type) {
    return type == TransactionType.payroll || 
           type == TransactionType.assets || 
           type == TransactionType.bulkImport || 
           type == TransactionType.auditLog;
  }

  void _performSwitch(TransactionType newType) {
    setState(() {
      _selectedType = newType;
    });
    // Reset the dirty flag so the new screen starts clean
    ref.read(formDirtyProvider.notifier).state = false;
  }

  void _showDiscardConfirmation(TransactionType newType) {
    showDialog(
      context: context,
      builder: (ctx) => AlertDialog(
        backgroundColor: AppColors.surfaceGrey,
        title: const Text("Unsaved Changes", style: TextStyle(color: AppColors.textWhite)),
        content: const Text(
          "You have entered data in the current form.\nSwitching will discard it.", 
          style: TextStyle(color: AppColors.textWhite70)
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(ctx), // Stay
            child: const Text("Stay Here", style: TextStyle(color: AppColors.textWhite54)),
          ),
          ElevatedButton(
            onPressed: () {
              Navigator.pop(ctx); // Close alert
              _performSwitch(newType); // Proceed with switch
            },
            style: ElevatedButton.styleFrom(backgroundColor: AppColors.errorRed),
            child: const Text("Discard & Switch", style: TextStyle(color: Colors.white)),
          ),
        ],
      ),
    );
  }

  /// -----------------------------------------------------------------------
  /// UI BUILD
  /// -----------------------------------------------------------------------
  @override
  Widget build(BuildContext context) {
    return Dialog(
      backgroundColor: Colors.transparent,
      insetPadding: const EdgeInsets.all(24),
      // The Master Container
      child: Container(
        width: 1300, // Wide enough to fit sidebar + your 700px dialogs
        height: 850,
        decoration: BoxDecoration(
          color: AppColors.backgroundBlack, // The "Hub" background
          borderRadius: BorderRadius.circular(16),
          border: Border.all(color: AppColors.divider),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withValues(alpha: 0.5),
              blurRadius: 40,
              offset: const Offset(0, 20),
            )
          ],
        ),
        child: Row(
          children: [
            // --- LEFT: NAVIGATION SIDEBAR ---
            Container(
              width: 260,
              decoration: const BoxDecoration(
                color: Color(0xFF0F1115), // Darker sidebar
                borderRadius: BorderRadius.horizontal(left: Radius.circular(16)),
                border: Border(right: BorderSide(color: AppColors.divider)),
              ),
              child: Column(
                children: [
                  _buildSidebarHeader(),
                  const Divider(color: AppColors.divider),
                  const SizedBox(height: 16),
                  
                  // Active Modules
                  _buildSectionTitle("QUICK ENTRY"),
                  _buildNavItem(TransactionType.payment, "Record Payment", Icons.attach_money, AppColors.successGreen),
                  _buildNavItem(TransactionType.expense, "Add Expense", Icons.receipt_long, AppColors.errorRed),
                  
                  const SizedBox(height: 16),
                  _buildSectionTitle("MANAGEMENT"),
                  _buildNavItem(TransactionType.student, "New Student", Icons.school, AppColors.primaryBlue),
                  _buildNavItem(TransactionType.campaign, "Campaigns", Icons.campaign, AppColors.accentPurple),

                  const SizedBox(height: 16),
                  // Future Modules (Visual Placeholders)
                  _buildSectionTitle("PROFESSIONAL SUITE"),
                  _buildNavItem(TransactionType.payroll, "Run Payroll", Icons.payments_outlined, AppColors.textWhite38),
                  _buildNavItem(TransactionType.assets, "Asset Registry", Icons.inventory_2_outlined, AppColors.textWhite38),
                  _buildNavItem(TransactionType.bulkImport, "Bulk Import", Icons.upload_file, AppColors.textWhite38),
                  _buildNavItem(TransactionType.auditLog, "Audit Logs", Icons.history_edu, AppColors.textWhite38),

                  const Spacer(),
                  _buildCloseButton(),
                ],
              ),
            ),

            // --- RIGHT: CONTENT AREA (Your Dialogs Load Here) ---
            Expanded(
              child: Container(
                color: Colors.black.withValues(alpha: 0.2), // Slight dim for contrast
                child: Center(
                  // We use KeyedSubtree to ensure the old widget is fully disposed ("shut down")
                  // when switching types.
                  child: KeyedSubtree(
                    key: ValueKey(_selectedType),
                    child: _buildSelectedLayout(),
                  ),
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }

  /// -----------------------------------------------------------------------
  /// THE SWITCHER
  /// Loads your existing dialog widgets directly.
  /// -----------------------------------------------------------------------
  Widget _buildSelectedLayout() {
    // Note: Since your widgets return 'Dialog', they will render with their 
    // own internal shadows/borders. This is fine; they will look like 
    // "Cards" floating inside the Hub.
    switch (_selectedType) {
      case TransactionType.payment:
        return PaymentDialog(schoolId: widget.schoolId);
      case TransactionType.expense:
        return ExpenseDialog(schoolId: widget.schoolId);
      case TransactionType.student:
        return StudentDialog(schoolId: widget.schoolId);
      case TransactionType.campaign:
        return CampaignDialog(schoolId: widget.schoolId);
      default:
        return const SizedBox();
    }
  }

  // --- WIDGET HELPERS ---

  Widget _buildSidebarHeader() {
    return Padding(
      padding: const EdgeInsets.all(24),
      child: Row(
        children: [
          Container(
            padding: const EdgeInsets.all(8),
            decoration: BoxDecoration(
              color: AppColors.surfaceGrey, 
              borderRadius: BorderRadius.circular(8)
            ),
            child: const Icon(Icons.hub, color: AppColors.textWhite, size: 20),
          ),
          const SizedBox(width: 12),
          const Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text("Transaction Hub", style: TextStyle(color: AppColors.textWhite, fontWeight: FontWeight.bold, fontSize: 14)),
              Text("Central Entry Point", style: TextStyle(color: AppColors.textWhite54, fontSize: 12)),
            ],
          ),
        ],
      ),
    );
  }

  Widget _buildSectionTitle(String title) {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 8),
      child: Align(
        alignment: Alignment.centerLeft,
        child: Text(
          title, 
          style: const TextStyle(
            color: AppColors.textWhite38, 
            fontSize: 10, 
            fontWeight: FontWeight.bold, 
            letterSpacing: 1.0
          )
        ),
      ),
    );
  }

  Widget _buildNavItem(TransactionType type, String label, IconData icon, Color color) {
    final isSelected = _selectedType == type;
    final isFuture = _isFutureFeature(type);
    
    return GestureDetector(
      onTap: () => _handleTypeSwitch(type),
      child: Container(
        margin: const EdgeInsets.symmetric(horizontal: 16, vertical: 2),
        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
        decoration: BoxDecoration(
          color: isSelected ? AppColors.surfaceGrey : Colors.transparent,
          borderRadius: BorderRadius.circular(8),
          border: isSelected ? Border.all(color: AppColors.divider) : null,
        ),
        child: Row(
          children: [
            Icon(
              icon, 
              size: 18, 
              color: isFuture ? AppColors.textWhite38 : (isSelected ? color : AppColors.textWhite54)
            ),
            const SizedBox(width: 12),
            Text(
              label,
              style: TextStyle(
                color: isFuture ? AppColors.textWhite38 : (isSelected ? AppColors.textWhite : AppColors.textWhite54),
                fontWeight: isSelected ? FontWeight.w600 : FontWeight.normal,
                fontSize: 13,
              ),
            ),
            if (isFuture) ...[
              const Spacer(),
              const Icon(Icons.lock_outline, size: 14, color: AppColors.textWhite38),
            ]
          ],
        ),
      ),
    );
  }

  Widget _buildCloseButton() {
    return Padding(
      padding: const EdgeInsets.all(16),
      child: TextButton.icon(
        onPressed: () => Navigator.of(context).pop(),
        icon: const Icon(Icons.close, color: AppColors.textWhite54),
        label: const Text("Close Hub", style: TextStyle(color: AppColors.textWhite54)),
      ),
    );
  }
}
// ==========================================
// FILE: ./transactions/transactions_header.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../../core/constants/app_colors.dart';
import '../../../../data/providers/dashboard_provider.dart';
import '../../../../data/services/database_service.dart'; // Import for connectivity check

class TransactionsHeader extends ConsumerWidget {
  const TransactionsHeader({super.key});

  String _getInitials(String name) {
    if (name.isEmpty) return "U";
    final parts = name.trim().split(' ');
    if (parts.length > 1) {
      return "${parts[0][0]}${parts[1][0]}".toUpperCase();
    }
    return name[0].toUpperCase();
  }

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final dashboardAsync = ref.watch(dashboardDataProvider);
    
    // Check connectivity status directly for UI feedback
    final bool isConnected = DatabaseService().db.currentStatus.connected;

    return Container(
      height: 70,
      padding: const EdgeInsets.symmetric(horizontal: 24),
      color: AppColors.backgroundBlack,
      child: Row(
        children: [
          const Text(
            "Transactions Log",
            style: TextStyle(
              color: AppColors.textWhite,
              fontSize: 18,
              fontWeight: FontWeight.bold,
            ),
          ),
          const Spacer(),
          
          // --- Search Bar ---
          SizedBox(
            width: 300,
            height: 40,
            child: TextField(
              textAlignVertical: TextAlignVertical.center,
              style: const TextStyle(color: AppColors.textWhite, fontSize: 13),
              decoration: InputDecoration(
                isDense: true,
                filled: true,
                fillColor: AppColors.surfaceGrey,
                hintText: "Search by ID, student, or category...",
                hintStyle: const TextStyle(color: AppColors.textWhite38),
                prefixIcon: const Icon(Icons.search, size: 18, color: AppColors.textWhite54),
                
                // Content Padding zero to center text vertically
                contentPadding: EdgeInsets.zero, 

                // Default Border
                enabledBorder: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(8),
                  borderSide: const BorderSide(color: AppColors.divider),
                ),
                
                // Focused Border
                focusedBorder: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(8),
                  borderSide: const BorderSide(color: AppColors.primaryBlue),
                ),
                
                // Fallback Border
                border: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(8),
                  borderSide: const BorderSide(color: AppColors.divider),
                ),
              ),
            ),
          ),
          const SizedBox(width: 24),
          
          // --- Notification Icon ---
          IconButton(
            onPressed: () {},
            icon: const Icon(Icons.notifications_none, color: AppColors.textWhite70),
            tooltip: "Notifications",
          ),
          const SizedBox(width: 16),
          
          // --- Profile with Connectivity Logic ---
          dashboardAsync.when(
            loading: () => _buildProfileLoading(),
            error: (err, _) => _buildProfileError(isConnected),
            data: (data) {
              final initials = _getInitials(data.userName);
              
              // Determine subtitle based on data state AND connectivity
              String subtitle = data.schoolName;
              if (data.schoolName == 'Loading...') {
                subtitle = isConnected ? "Syncing Data..." : "Offline Mode";
              }

              return Row(
                children: [
                  Column(
                    mainAxisAlignment: MainAxisAlignment.center,
                    crossAxisAlignment: CrossAxisAlignment.end,
                    children: [
                      Text(
                        data.userName.isEmpty ? "User" : data.userName, 
                        style: const TextStyle(color: AppColors.textWhite, fontWeight: FontWeight.bold, fontSize: 13)
                      ),
                      Text(
                        subtitle, 
                        style: TextStyle(
                          color: (subtitle == "Offline Mode") ? AppColors.warningOrange : AppColors.textWhite38, 
                          fontSize: 11
                        )
                      ),
                    ],
                  ),
                  const SizedBox(width: 12),
                  CircleAvatar(
                    backgroundColor: AppColors.primaryBlue.withValues(alpha: 0.2),
                    child: Text(
                      initials, 
                      style: const TextStyle(color: AppColors.primaryBlue, fontWeight: FontWeight.bold, fontSize: 12)
                    ),
                  ),
                ],
              );
            },
          ),
        ],
      ),
    );
  }

  // --- Loading/Error States ---

  Widget _buildProfileLoading() {
    return Row(
      children: [
        Column(
          mainAxisAlignment: MainAxisAlignment.center,
          crossAxisAlignment: CrossAxisAlignment.end,
          children: [
            Container(width: 80, height: 12, color: AppColors.surfaceGrey),
            const SizedBox(height: 4),
            Container(width: 50, height: 10, color: AppColors.surfaceGrey),
          ],
        ),
        const SizedBox(width: 12),
        const CircleAvatar(
          backgroundColor: AppColors.surfaceGrey,
          radius: 16,
        ),
      ],
    );
  }

  Widget _buildProfileError(bool isConnected) {
    return Row(
      children: [
        Text(
          isConnected ? "Sync Error" : "Offline", 
          style: TextStyle(color: isConnected ? AppColors.errorRed : AppColors.warningOrange, fontSize: 12)
        ),
        const SizedBox(width: 12),
        CircleAvatar(
          backgroundColor: AppColors.surfaceGrey,
          child: Icon(
            isConnected ? Icons.error_outline : Icons.wifi_off, 
            size: 16, 
            color: isConnected ? AppColors.errorRed : AppColors.warningOrange
          ),
        ),
      ],
    );
  }
}
// ==========================================
// FILE: ./transactions/transactions_kpi_cards.dart
// ==========================================

import 'package:fees_up/data/models/transaction_stats.dart';
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:intl/intl.dart';
import '../../../core/constants/app_colors.dart';
import '../../../data/providers/dashboard_provider.dart';
import '../../../data/providers/transactions_provider.dart';

class TransactionsKpiCards extends ConsumerWidget {
  const TransactionsKpiCards({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final dashboardAsync = ref.watch(dashboardDataProvider);

    return dashboardAsync.when(
      data: (dashboard) {
        final statsAsync =
            ref.watch(transactionStatsProvider(dashboard.schoolId));

        return statsAsync.when(
          data: (stats) => _buildCards(stats),
          loading: () => _buildLoadingCards(),
          error: (err, stack) =>
              _buildErrorCards(ref, dashboard.schoolId, err.toString()),
        );
      },
      loading: () => _buildLoadingCards(),
      error: (err, stack) => _buildSimpleErrorCards(err.toString()),
    );
  }

  Widget _buildCards(TransactionStats stats) {
    final formatter = NumberFormat.simpleCurrency();

    return Row(
      children: [
        _buildCard(
          title: "TOTAL INCOME",
          value: formatter.format(stats.totalIncome),
          icon: Icons.trending_up,
          color: AppColors.successGreen,
        ),
        const SizedBox(width: 24),
        _buildCard(
          title: "TOTAL EXPENSES",
          value: formatter.format(stats.totalExpenses),
          icon: Icons.trending_down,
          color: AppColors.errorRed,
        ),
        const SizedBox(width: 24),
        _buildCard(
          title: "PENDING",
          value: formatter.format(stats.pendingAmount),
          icon: Icons.pending_actions,
          color: AppColors.primaryBlue,
        ),
        const SizedBox(width: 24),
        _buildCard(
          title: "DONATIONS",
          value: formatter.format(stats.totalDonations),
          icon: Icons.volunteer_activism,
          color: AppColors.accentPurple,
        ),
      ],
    );
  }

  Widget _buildLoadingCards() {
    return Row(
      children: List.generate(
          4,
          (index) => Expanded(
                child: Container(
                  margin: EdgeInsets.only(right: index < 3 ? 24 : 0),
                  height: 100,
                  decoration: BoxDecoration(
                    color: AppColors.surfaceGrey,
                    borderRadius: BorderRadius.circular(12),
                    border: Border.all(color: AppColors.divider),
                  ),
                  child: const Center(
                    child: CircularProgressIndicator(
                      color: AppColors.primaryBlue,
                      strokeWidth: 2,
                    ),
                  ),
                ),
              )),
    );
  }

  Widget _buildErrorCards(WidgetRef ref, String schoolId, String error) {
    return Container(
      height: 100,
      decoration: BoxDecoration(
        color: AppColors.errorRed.withValues(alpha: 0.1),
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: AppColors.errorRed.withValues(alpha: 0.3)),
      ),
      child: Center(
        child: Row(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            const Icon(Icons.error_outline,
                color: AppColors.errorRed, size: 24),
            const SizedBox(width: 12),
            const Text('Failed to load stats',
                style: TextStyle(color: AppColors.textWhite)),
            const SizedBox(width: 16),
            ElevatedButton.icon(
              onPressed: () =>
                  ref.invalidate(transactionStatsProvider(schoolId)),
              icon: const Icon(Icons.refresh, size: 16),
              label: const Text('Retry'),
              style: ElevatedButton.styleFrom(
                backgroundColor: AppColors.primaryBlue,
                foregroundColor: Colors.white,
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildSimpleErrorCards(String error) {
    return Container(
      height: 100,
      decoration: BoxDecoration(
        color: AppColors.errorRed.withValues(alpha: 0.1),
        borderRadius: BorderRadius.circular(12),
      ),
      child: const Center(
        child: Text('Error loading data',
            style: TextStyle(color: AppColors.errorRed)),
      ),
    );
  }

  Widget _buildCard({
    required String title,
    required String value,
    required IconData icon,
    required Color color,
  }) {
    return Expanded(
      child: Container(
        padding: const EdgeInsets.all(20),
        decoration: BoxDecoration(
          color: AppColors.surfaceGrey,
          borderRadius: BorderRadius.circular(12),
          border: Border.all(color: AppColors.divider),
        ),
        child: Row(
          children: [
            Container(
              padding: const EdgeInsets.all(12),
              decoration: BoxDecoration(
                color: color.withValues(alpha: 0.1),
                borderRadius: BorderRadius.circular(8),
              ),
              child: Icon(icon, color: color, size: 24),
            ),
            const SizedBox(width: 16),
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    title,
                    style: const TextStyle(
                      color: AppColors.textWhite54,
                      fontSize: 11,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                  const SizedBox(height: 4),
                  FittedBox(
                    fit: BoxFit.scaleDown,
                    alignment: Alignment.centerLeft,
                    child: Text(
                      value,
                      style: const TextStyle(
                        color: AppColors.textWhite,
                        fontSize: 22,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                  ),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }
}

// ==========================================
// FILE: ./dashboard/stat_cards.dart
// ==========================================

import 'package:flutter/material.dart';
import '../../../core/constants/app_colors.dart';

class StatCard extends StatelessWidget {
  final String title;
  final String value;
  final IconData icon;
  final Color iconColor;
  final Color? iconBgColor;
  final Widget? footer;
  final bool isAlert;

  const StatCard({
    super.key,
    required this.title,
    required this.value,
    required this.icon,
    this.iconColor = AppColors.textWhite,
    this.iconBgColor,
    this.footer,
    this.isAlert = false,
  });

  @override
  Widget build(BuildContext context) {
    // ‚ö†Ô∏è CRITICAL FIX: Do NOT wrap this in Expanded. 
    // The parent widget (Home Screen) controls the size.
    return Container(
      padding: const EdgeInsets.all(16), 
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(16),
        border: isAlert 
            ? const Border(left: BorderSide(color: AppColors.errorRed, width: 4))
            : Border.all(color: AppColors.divider),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          // Header
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Flexible(
                child: Text(
                  title.toUpperCase(),
                  overflow: TextOverflow.ellipsis,
                  style: const TextStyle(
                    color: AppColors.textWhite54,
                    fontSize: 11,
                    fontWeight: FontWeight.bold,
                    letterSpacing: 0.5,
                  ),
                ),
              ),
              Container(
                padding: const EdgeInsets.all(8),
                decoration: BoxDecoration(
                  color: iconBgColor ?? AppColors.textWhite.withValues(alpha: 0.12),
                  borderRadius: BorderRadius.circular(8),
                ),
                child: Icon(icon, size: 18, color: iconColor),
              ),
            ],
          ),
          
          const SizedBox(height: 8),
          
          // Value
          Flexible(
            child: FittedBox(
              fit: BoxFit.scaleDown,
              alignment: Alignment.centerLeft,
              child: Text(
                value,
                style: const TextStyle(
                  color: AppColors.textWhite,
                  fontSize: 28,
                  fontWeight: FontWeight.bold,
                ),
              ),
            ),
          ),
          
          const SizedBox(height: 8),
          
          // Footer
          if (footer != null) 
            SizedBox(
              height: 24, 
              child: footer!,
            ),
        ],
      ),
    );
  }
}

class AlertBadge extends StatelessWidget {
  final String text;
  final String subText;

  const AlertBadge({super.key, required this.text, required this.subText});

  @override
  Widget build(BuildContext context) {
    return Row(
      mainAxisSize: MainAxisSize.min,
      children: [
        Container(
          padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
          decoration: BoxDecoration(
            color: AppColors.errorRed.withValues(alpha: 0.1),
            borderRadius: BorderRadius.circular(4),
          ),
          child: Row(
            mainAxisSize: MainAxisSize.min,
            children: [
              const Icon(Icons.warning_amber_rounded, size: 14, color: AppColors.errorRed),
              const SizedBox(width: 4),
              Text(
                text,
                style: const TextStyle(color: AppColors.errorRed, fontSize: 11, fontWeight: FontWeight.bold),
              ),
            ],
          ),
        ),
        const SizedBox(width: 8),
        Flexible(
          child: Text(
            subText,
            overflow: TextOverflow.ellipsis,
            style: const TextStyle(color: AppColors.textWhite38, fontSize: 11),
          ),
        ),
      ],
    );
  }
}
// ==========================================
// FILE: ./dashboard/recent_payments_section.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:intl/intl.dart';
import '../../../../core/constants/app_colors.dart';

/// Recent Payments Section Fragment - Displays list of recent payments
/// Complies with Law of Fragments: Self-contained payment display logic
class RecentPaymentsSection extends StatelessWidget {
  final List<dynamic> payments;

  const RecentPaymentsSection({
    super.key,
    required this.payments,
  });

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.all(24),
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: AppColors.divider),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          const Text(
            "Recent Payments",
            style: TextStyle(
              color: AppColors.textWhite,
              fontSize: 18,
              fontWeight: FontWeight.bold,
            ),
          ),
          const SizedBox(height: 16),
          if (payments.isEmpty)
            const Padding(
              padding: EdgeInsets.all(20.0),
              child: Text(
                "No recent payments found.",
                style: TextStyle(color: AppColors.textWhite54),
              ),
            )
          else
            ...payments.map((payment) {
              return Column(
                children: [
                  _PaymentRow(
                    name: payment['payer_name'] ?? 'Unknown',
                    date: payment['date_paid'] != null
                        ? DateFormat('MMM d, yyyy')
                            .format(DateTime.parse(payment['date_paid']))
                        : 'Unknown Date',
                    description: payment['category'] ?? 'Fee',
                    amount:
                        NumberFormat.simpleCurrency().format(payment['amount']),
                    isPaid: true,
                  ),
                  const Divider(color: AppColors.divider),
                ],
              );
            }),
        ],
      ),
    );
  }
}

/// Payment Row Widget - Individual payment display item
class _PaymentRow extends StatelessWidget {
  final String name;
  final String date;
  final String description;
  final String amount;
  final bool isPaid;

  const _PaymentRow({
    required this.name,
    required this.date,
    required this.description,
    required this.amount,
    required this.isPaid,
  });

  @override
  Widget build(BuildContext context) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 12),
      child: Row(
        children: [
          const CircleAvatar(
            radius: 16,
            backgroundColor: AppColors.divider,
            child: Icon(
              Icons.person,
              size: 16,
              color: AppColors.textWhite54,
            ),
          ),
          const SizedBox(width: 12),
          Expanded(
            flex: 2,
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  name,
                  style: const TextStyle(color: AppColors.textWhite),
                ),
                Text(
                  date,
                  style: const TextStyle(
                    color: AppColors.textWhite38,
                    fontSize: 12,
                  ),
                ),
              ],
            ),
          ),
          Expanded(
            flex: 3,
            child: Text(
              description,
              style: const TextStyle(color: AppColors.textWhite70),
            ),
          ),
          Expanded(
            flex: 1,
            child: Text(
              amount,
              style: const TextStyle(
                color: AppColors.textWhite,
                fontWeight: FontWeight.bold,
              ),
            ),
          ),
          Container(
            padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
            decoration: BoxDecoration(
              color: isPaid
                  ? AppColors.successGreen.withValues(alpha: 0.2)
                  : AppColors.warningOrange.withValues(alpha: 0.2),
              borderRadius: BorderRadius.circular(4),
            ),
            child: Text(
              isPaid ? "Paid" : "Pending",
              style: TextStyle(
                color:
                    isPaid ? AppColors.successGreen : AppColors.warningOrange,
                fontSize: 11,
                fontWeight: FontWeight.bold,
              ),
            ),
          ),
        ],
      ),
    );
  }
}

// ==========================================
// FILE: ./dashboard/expense_dialog.dart
// ==========================================

import 'dart:ui';
// ignore: unused_import
import 'dart:math' as math;

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:intl/intl.dart';

import '../../../../core/constants/app_colors.dart';
import '../../../../data/models/finance_models.dart';
import '../../../../data/providers/expense_provider.dart';

class ExpenseDialog extends ConsumerStatefulWidget {
  final String schoolId;
  const ExpenseDialog({super.key, required this.schoolId});

  @override
  ConsumerState<ExpenseDialog> createState() => _ExpenseDialogState();
}

class _ExpenseDialogState extends ConsumerState<ExpenseDialog> {
  final _formKey = GlobalKey<FormState>();
  
  // Controllers
  final _titleController = TextEditingController();
  final _amountController = TextEditingController();
  final _dateController = TextEditingController();
  final _recipientController = TextEditingController();
  final _notesController = TextEditingController();

  DateTime _selectedDate = DateTime.now();
  String? _selectedCategory;
  String? _selectedPaymentMethod;

  @override
  void initState() {
    super.initState();
    _dateController.text = DateFormat('yyyy-MM-dd').format(_selectedDate);
  }

  @override
  void dispose() {
    _titleController.dispose();
    _amountController.dispose();
    _dateController.dispose();
    _recipientController.dispose();
    _notesController.dispose();
    super.dispose();
  }

  Future<void> _pickDate() async {
    final picked = await showDatePicker(
      context: context,
      initialDate: _selectedDate,
      firstDate: DateTime(2020),
      lastDate: DateTime(2030),
      builder: (context, child) {
        return Theme(
          data: ThemeData.dark().copyWith(
            colorScheme: const ColorScheme.dark(
              primary: AppColors.primaryBlue,
              onPrimary: AppColors.textWhite,
              surface: AppColors.surfaceGrey,
              onSurface: AppColors.textWhite,
            ),
            dialogTheme: const DialogThemeData(backgroundColor: AppColors.backgroundBlack),
          ),
          child: child!,
        );
      },
    );
    if (picked != null) {
      setState(() {
        _selectedDate = picked;
        _dateController.text = DateFormat('yyyy-MM-dd').format(picked);
      });
    }
  }

  Future<void> _submit() async {
    if (widget.schoolId.isEmpty) return; // Security check
    if (!_formKey.currentState!.validate()) return;

    final success = await ref.read(expenseControllerProvider.notifier).saveExpense(
      title: _titleController.text.trim(),
      amount: double.tryParse(_amountController.text.trim()) ?? 0.0,
      date: _selectedDate,
      category: _selectedCategory,
      recipient: _recipientController.text.trim(),
      notes: _notesController.text.trim(),
      paymentMethod: _selectedPaymentMethod,
    );

    if (success && mounted) {
      Navigator.of(context).pop();
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text("Expense Saved"), backgroundColor: AppColors.successGreen),
      );
    }
  }

  @override
  Widget build(BuildContext context) {
    // 1. Check if school ID is valid
    final hasSchool = widget.schoolId.isNotEmpty;

    final expensesAsync = ref.watch(recentExpensesProvider);
    final saveState = ref.watch(expenseControllerProvider);

    // Listen for errors
    ref.listen(expenseControllerProvider, (prev, next) {
      if (next.hasError && !next.isLoading) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text("Error: ${next.error}"), backgroundColor: AppColors.errorRed),
        );
      }
    });

    return Dialog(
      backgroundColor: Colors.transparent,
      insetPadding: const EdgeInsets.all(24),
      child: Container(
        width: 1100,
        height: 800,
        decoration: BoxDecoration(
          color: AppColors.backgroundBlack,
          borderRadius: BorderRadius.circular(16),
          border: Border.all(color: AppColors.surfaceLightGrey),
          boxShadow: [
            BoxShadow(color: Colors.black.withValues(alpha: 0.5), blurRadius: 20, offset: const Offset(0, 10))
          ],
        ),
        child: Column(
          children: [
            // HEADER
            _buildHeader(),
            const Divider(height: 1, color: AppColors.divider),

            // MAIN CONTENT
            Expanded(
              child: !hasSchool 
                ? _buildNoSchoolState()
                : _buildFormAndList(expensesAsync),
            ),

            const Divider(height: 1, color: AppColors.divider),
            
            // FOOTER (Disabled if no school)
            Padding(
              padding: const EdgeInsets.all(24),
              child: Row(
                mainAxisAlignment: MainAxisAlignment.end,
                children: [
                  TextButton(
                    onPressed: () => Navigator.of(context).pop(),
                    child: const Text("Cancel", style: TextStyle(color: AppColors.textWhite70)),
                  ),
                  const SizedBox(width: 16),
                  if (hasSchool)
                    ElevatedButton.icon(
                      onPressed: saveState.isLoading ? null : _submit,
                      style: ElevatedButton.styleFrom(
                        backgroundColor: AppColors.primaryBlue,
                        foregroundColor: AppColors.textWhite,
                        padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 16),
                        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
                      ),
                      icon: saveState.isLoading 
                        ? const SizedBox(width: 16, height: 16, child: CircularProgressIndicator(strokeWidth: 2, color: Colors.white)) 
                        : const Icon(Icons.check, size: 18),
                      label: Text(saveState.isLoading ? "Saving..." : "Save Expense", style: const TextStyle(fontWeight: FontWeight.bold)),
                    )
                  else
                    ElevatedButton(
                      onPressed: null,
                      style: ElevatedButton.styleFrom(
                        backgroundColor: AppColors.disabledGrey.withValues(alpha: 0.2),
                        padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 16),
                      ),
                      child: const Text("Action Disabled", style: TextStyle(color: AppColors.textWhite38)),
                    ),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }

  // --- CONTENT STATES ---

  Widget _buildNoSchoolState() {
    return Center(
      child: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          Icon(Icons.school_outlined, size: 64, color: AppColors.textGrey.withValues(alpha: 0.5)),
          const SizedBox(height: 24),
          const Text(
            "School Configuration Required",
            style: TextStyle(color: AppColors.textWhite, fontSize: 20, fontWeight: FontWeight.bold),
          ),
          const SizedBox(height: 8),
          const Text(
            "Please set up a school to start creating any student data\nor sync the school to the database.",
            textAlign: TextAlign.center,
            style: TextStyle(color: AppColors.textGrey, fontSize: 14),
          ),
        ],
      ),
    );
  }

  Widget _buildFormAndList(AsyncValue<List<Expense>> expensesAsync) {
    return Row(
      children: [
        // --- LEFT COLUMN: FORM ---
        Expanded(
          flex: 5,
          child: Padding(
            padding: const EdgeInsets.all(32),
            child: Form(
              key: _formKey,
              child: SingleChildScrollView(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    const Text("NEW EXPENSE ENTRY", style: TextStyle(color: AppColors.textGrey, fontSize: 12, fontWeight: FontWeight.bold, letterSpacing: 1.2)),
                    const SizedBox(height: 24),

                    _buildLabel("Expense Title"),
                    _buildTextField(
                      controller: _titleController,
                      hint: "e.g. Science Lab Equipment",
                      validator: (v) => v!.isEmpty ? "Required" : null,
                    ),
                    const SizedBox(height: 16),

                    Row(
                      children: [
                        Expanded(
                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              _buildLabel("Amount"),
                              _buildTextField(
                                controller: _amountController,
                                hint: "0.00",
                                prefix: "\$ ",
                                inputType: const TextInputType.numberWithOptions(decimal: true),
                                validator: (v) {
                                  if (v == null || v.isEmpty) return "Required";
                                  if (double.tryParse(v) == null) return "Invalid";
                                  return null;
                                },
                              ),
                            ],
                          ),
                        ),
                        const SizedBox(width: 16),
                        Expanded(
                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              _buildLabel("Incurred Date"),
                              GestureDetector(
                                onTap: _pickDate,
                                child: AbsorbPointer(
                                  child: _buildTextField(
                                    controller: _dateController,
                                    hint: "yyyy-mm-dd",
                                    suffixIcon: Icons.calendar_today_outlined,
                                  ),
                                ),
                              ),
                            ],
                          ),
                        ),
                      ],
                    ),
                    const SizedBox(height: 16),

                    Row(
                      children: [
                        Expanded(
                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              _buildLabel("Category"),
                              _buildDropdown(
                                hint: "Select category",
                                value: _selectedCategory,
                                items: ["Supplies", "Utilities", "Transport", "Events", "Maintenance", "Salaries"],
                                onChanged: (val) => setState(() => _selectedCategory = val),
                              ),
                            ],
                          ),
                        ),
                        const SizedBox(width: 16),
                        Expanded(
                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              _buildLabel("Payment Method"),
                              _buildDropdown(
                                hint: "Select method",
                                value: _selectedPaymentMethod,
                                items: ["Bank Transfer", "Credit Card", "Cash", "Petty Cash", "EcoCash"],
                                onChanged: (val) => setState(() => _selectedPaymentMethod = val),
                              ),
                            ],
                          ),
                        ),
                      ],
                    ),
                    const SizedBox(height: 16),

                    _buildLabel("Recipient / Vendor"),
                    _buildTextField(
                      controller: _recipientController,
                      hint: "e.g. Office Depot",
                      prefixIcon: Icons.storefront_outlined,
                    ),
                    const SizedBox(height: 16),

                    _buildLabel("Notes / Description"),
                    _buildTextField(
                      controller: _notesController,
                      hint: "Additional details...",
                      maxLines: 3,
                    ),
                    
                    const SizedBox(height: 24),
                    
                    // Visual Placeholder for Attachments (Custom Dashed Border)
                    Opacity(
                      opacity: 0.5,
                      child: _buildAttachmentArea(),
                    ),
                  ],
                ),
              ),
            ),
          ),
        ),

        const VerticalDivider(width: 1, color: AppColors.divider),

        // --- RIGHT COLUMN: RECENT LIST (Streamed from DB) ---
        Expanded(
          flex: 4,
          child: Container(
            color: AppColors.surfaceDarkGrey,
            padding: const EdgeInsets.all(24),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const Text("RECENT EXPENSES", style: TextStyle(color: AppColors.textGrey, fontSize: 12, fontWeight: FontWeight.bold, letterSpacing: 1.2)),
                const SizedBox(height: 24),
                Expanded(
                  child: expensesAsync.when(
                    data: (expenses) {
                      if (expenses.isEmpty) {
                        return const Center(child: Text("No expenses recorded yet.", style: TextStyle(color: AppColors.textGrey)));
                      }
                      return ListView.separated(
                        itemCount: expenses.length,
                        separatorBuilder: (_, __) => const SizedBox(height: 12),
                        itemBuilder: (context, index) {
                          return _buildExpenseItem(expenses[index]);
                        },
                      );
                    },
                    loading: () => const Center(child: CircularProgressIndicator(color: AppColors.primaryBlue)),
                    error: (e, stack) => const Center(child: Text("Error loading data", style: TextStyle(color: AppColors.errorRed))),
                  ),
                ),
              ],
            ),
          ),
        ),
      ],
    );
  }

  // --- WIDGET BUILDERS ---

  Widget _buildHeader() {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 32, vertical: 24),
      child: Row(
        children: [
          Container(
            padding: const EdgeInsets.all(8),
            decoration: BoxDecoration(
              color: AppColors.primaryBlue.withValues(alpha: 0.2), 
              borderRadius: BorderRadius.circular(8)
            ),
            child: const Icon(Icons.account_balance_wallet, color: AppColors.primaryBlue),
          ),
          const SizedBox(width: 16),
          const Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text("Manage Expenses", style: TextStyle(color: AppColors.textWhite, fontSize: 18, fontWeight: FontWeight.bold)),
              Text("Production Mode", style: TextStyle(color: AppColors.textGrey, fontSize: 13)),
            ],
          ),
          const Spacer(),
          IconButton(
            onPressed: () => Navigator.of(context).pop(),
            icon: const Icon(Icons.close, color: AppColors.textGrey),
          ),
        ],
      ),
    );
  }

  Widget _buildLabel(String text) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 8.0),
      child: Text(text, style: TextStyle(color: AppColors.textWhite.withValues(alpha: 0.9), fontSize: 14, fontWeight: FontWeight.w500)),
    );
  }

  Widget _buildTextField({
    required TextEditingController controller,
    required String hint,
    String? prefix, IconData? prefixIcon, IconData? suffixIcon,
    int maxLines = 1, TextInputType inputType = TextInputType.text,
    String? Function(String?)? validator,
  }) {
    return TextFormField(
      controller: controller, maxLines: maxLines, keyboardType: inputType,
      validator: validator,
      style: const TextStyle(color: AppColors.textWhite),
      decoration: InputDecoration(
        filled: true, 
        fillColor: AppColors.surfaceGrey, 
        hintText: hint,
        hintStyle: TextStyle(color: AppColors.textWhite.withValues(alpha: 0.3)),
        prefixText: prefix, prefixStyle: const TextStyle(color: AppColors.textWhite, fontWeight: FontWeight.bold),
        prefixIcon: prefixIcon != null ? Icon(prefixIcon, color: AppColors.textWhite54, size: 20) : null,
        suffixIcon: suffixIcon != null ? Icon(suffixIcon, color: AppColors.textWhite54, size: 20) : null,
        border: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.surfaceLightGrey)),
        enabledBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.surfaceLightGrey)),
        focusedBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.primaryBlue)),
        contentPadding: const EdgeInsets.symmetric(horizontal: 16, vertical: 16),
      ),
    );
  }

  Widget _buildDropdown({
    required String hint, required String? value, required List<String> items,
    required Function(String?) onChanged,
  }) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 16),
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey, borderRadius: BorderRadius.circular(8),
        border: Border.all(color: AppColors.surfaceLightGrey),
      ),
      child: DropdownButtonHideUnderline(
        child: DropdownButton<String>(
          value: value, 
          hint: Text(hint, style: TextStyle(color: AppColors.textWhite.withValues(alpha: 0.3))),
          dropdownColor: AppColors.surfaceGrey, 
          icon: const Icon(Icons.keyboard_arrow_down, color: AppColors.textWhite54),
          isExpanded: true, 
          style: const TextStyle(color: AppColors.textWhite),
          items: items.map((e) => DropdownMenuItem(value: e, child: Text(e))).toList(),
          onChanged: onChanged,
        ),
      ),
    );
  }

  Widget _buildAttachmentArea() {
    return _DashedBorder(
      color: AppColors.divider,
      strokeWidth: 2,
      gap: 6,
      radius: 12,
      child: Container(
        width: double.infinity, height: 80,
        alignment: Alignment.center,
        color: AppColors.surfaceGrey.withValues(alpha: 0.5),
        child: const Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Icon(Icons.cloud_off, color: AppColors.textWhite38, size: 28),
            SizedBox(height: 8),
            Text("Attachments not supported in offline schema", style: TextStyle(color: AppColors.textGrey, fontSize: 12)),
          ],
        ),
      ),
    );
  }

  Widget _buildExpenseItem(Expense item) {
    IconData icon = Icons.attach_money;
    Color color = AppColors.primaryBlue;
    
    final cat = (item.category ?? '').toLowerCase();
    if (cat.contains('utility')) { icon = Icons.bolt; color = AppColors.warningOrange; }
    else if (cat.contains('transport')) { icon = Icons.directions_bus; color = AppColors.accentPurple; }
    else if (cat.contains('supplies')) { icon = Icons.science; color = AppColors.successGreen; }
    else if (cat.contains('maint')) { icon = Icons.build; color = AppColors.errorRed; }

    final dateStr = DateFormat('MMM d').format(item.incurredAt);

    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey, 
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: AppColors.divider),
      ),
      child: Row(
        children: [
          Container(
            width: 48, height: 48,
            decoration: BoxDecoration(color: color.withValues(alpha: 0.1), borderRadius: BorderRadius.circular(10)),
            child: Icon(icon, color: color, size: 24),
          ),
          const SizedBox(width: 16),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(item.title, style: const TextStyle(color: AppColors.textWhite, fontWeight: FontWeight.bold)),
                Text("${item.category ?? 'General'} ‚Ä¢ $dateStr", 
                  style: const TextStyle(color: AppColors.textWhite54, fontSize: 12)),
              ],
            ),
          ),
          Column(
            crossAxisAlignment: CrossAxisAlignment.end,
            children: [
              Text("-\$${item.amount.toStringAsFixed(2)}", style: const TextStyle(color: AppColors.textWhite, fontWeight: FontWeight.bold)),
            ],
          ),
        ],
      ),
    );
  }
}

// --- CUSTOM DASHED BORDER WIDGET (Unchanged) ---
class _DashedBorder extends StatelessWidget {
  final Widget child;
  final Color color;
  final double strokeWidth;
  final double gap;
  final double radius;

  const _DashedBorder({
    required this.child,
    this.color = Colors.white,
    this.strokeWidth = 1.0,
    this.gap = 5.0,
    this.radius = 0.0,
  });

  @override
  Widget build(BuildContext context) {
    return CustomPaint(
      painter: _DashedBorderPainter(
        color: color,
        strokeWidth: strokeWidth,
        gap: gap,
        radius: radius,
      ),
      child: child,
    );
  }
}

class _DashedBorderPainter extends CustomPainter {
  final Color color;
  final double strokeWidth;
  final double gap;
  final double radius;

  _DashedBorderPainter({
    required this.color,
    required this.strokeWidth,
    required this.gap,
    required this.radius,
  });

  @override
  void paint(Canvas canvas, Size size) {
    final Paint paint = Paint()
      ..color = color
      ..strokeWidth = strokeWidth
      ..style = PaintingStyle.stroke;

    final Path path = Path()
      ..addRRect(RRect.fromRectAndRadius(
        Rect.fromLTWH(0, 0, size.width, size.height),
        Radius.circular(radius),
      ));

    final Path dashedPath = _dashPath(path, width: 6, space: gap);
    canvas.drawPath(dashedPath, paint);
  }

  Path _dashPath(Path source, {required double width, required double space}) {
    final Path path = Path();
    for (final PathMetric metric in source.computeMetrics()) {
      double distance = 0.0;
      while (distance < metric.length) {
        path.addPath(
          metric.extractPath(distance, distance + width),
          Offset.zero,
        );
        distance += width + space;
      }
    }
    return path;
  }

  @override
  bool shouldRepaint(_DashedBorderPainter oldDelegate) {
    return oldDelegate.color != color ||
        oldDelegate.strokeWidth != strokeWidth ||
        oldDelegate.gap != gap ||
        oldDelegate.radius != radius;
  }
}
// ==========================================
// FILE: ./dashboard/screen_size_error.dart
// ==========================================

import 'package:flutter/material.dart';
import '../../../../core/constants/app_colors.dart';

/// Screen Size Error Fragment - Displays when screen is too small for PC view
/// Complies with Law of Fragments: Reusable error state widget
class ScreenSizeError extends StatelessWidget {
  const ScreenSizeError({super.key});

  @override
  Widget build(BuildContext context) {
    return Container(
      color: Colors.black,
      width: double.infinity,
      height: double.infinity,
      child: const Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Icon(
            Icons.desktop_windows,
            size: 64,
            color: AppColors.errorRed,
          ),
          SizedBox(height: 24),
          Text(
            "Window Size Too Small",
            style: TextStyle(
              color: AppColors.textWhite,
              fontSize: 24,
              fontWeight: FontWeight.bold,
            ),
          ),
          SizedBox(height: 12),
          Text(
            "This application requires a minimum resolution of 1024px width.",
            textAlign: TextAlign.center,
            style: TextStyle(
              color: AppColors.textWhite70,
              fontSize: 16,
            ),
          ),
        ],
      ),
    );
  }
}

// ==========================================
// FILE: ./dashboard/revenue_chart.dart
// ==========================================

import 'package:fl_chart/fl_chart.dart';
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:intl/intl.dart';
import '../../../core/constants/app_colors.dart';
import '../../../data/providers/revenue_provider.dart';

class RevenueChart extends ConsumerWidget {
  const RevenueChart({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final revenueAsync = ref.watch(weeklyRevenueProvider);
    final currentFilter = ref.watch(revenueFilterProvider);

    return Container(
      padding: const EdgeInsets.all(24),
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: Colors.white10),
      ),
      child: revenueAsync.when(
        loading: () => const Center(child: CircularProgressIndicator()),
        error: (err, stack) => Center(child: Text('Error: $err', style: const TextStyle(color: Colors.red, fontSize: 12))),
        data: (data) {
          // Dynamic Y-Axis Scale
          double maxY = 100;
          for (var val in data.dailyTotals.values) {
            if (val > maxY) maxY = val;
          }
          maxY = maxY * 1.2; // Add breathing room

          return Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              // --- HEADER ---
              Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      const Text("Revenue & Collections", style: TextStyle(color: Colors.white, fontSize: 16, fontWeight: FontWeight.bold)),
                      const SizedBox(height: 4),
                      Text(
                        "Total: ${NumberFormat.simpleCurrency().format(data.totalWeekRevenue)}", 
                        style: const TextStyle(color: Colors.white54, fontSize: 13)
                      ),
                    ],
                  ),
                  
                  // --- FUNCTIONAL DROPDOWN ---
                  Container(
                    padding: const EdgeInsets.symmetric(horizontal: 12),
                    decoration: BoxDecoration(color: Colors.white10, borderRadius: BorderRadius.circular(6)),
                    child: DropdownButtonHideUnderline(
                      child: DropdownButton<RevenueFilter>(
                        value: currentFilter,
                        dropdownColor: const Color(0xFF2C2F36),
                        icon: const Icon(Icons.keyboard_arrow_down, size: 16, color: Colors.white),
                        style: const TextStyle(color: Colors.white, fontSize: 12),
                        onChanged: (RevenueFilter? newValue) {
                          if (newValue != null) {
                            // This triggers the provider to refresh
                            ref.read(revenueFilterProvider.notifier).state = newValue;
                          }
                        },
                        items: const [
                          DropdownMenuItem(value: RevenueFilter.thisWeek, child: Text("This Week")),
                          DropdownMenuItem(value: RevenueFilter.lastWeek, child: Text("Last Week")),
                        ],
                      ),
                    ),
                  )
                ],
              ),
              const SizedBox(height: 24),
              
              // --- CHART ---
              Expanded(
                child: LineChart(
                  LineChartData(
                    gridData: FlGridData(
                      show: true,
                      drawVerticalLine: false,
                      getDrawingHorizontalLine: (value) => const FlLine(color: Colors.white10, strokeWidth: 1),
                    ),
                    titlesData: FlTitlesData(
                      show: true,
                      rightTitles: const AxisTitles(sideTitles: SideTitles(showTitles: false)),
                      topTitles: const AxisTitles(sideTitles: SideTitles(showTitles: false)),
                      bottomTitles: AxisTitles(
                        sideTitles: SideTitles(
                          showTitles: true,
                          reservedSize: 30,
                          interval: 1, 
                          getTitlesWidget: (value, meta) {
                            const style = TextStyle(color: Colors.white38, fontSize: 12);
                            // Visual Map: 0=Mon, 2=Tue, 4=Wed, 6=Thu, 8=Fri
                            switch (value.toInt()) {
                              case 0: return const Text('Mon', style: style);
                              case 2: return const Text('Tue', style: style);
                              case 4: return const Text('Wed', style: style);
                              case 6: return const Text('Thu', style: style);
                              case 8: return const Text('Fri', style: style);
                            }
                            return const Text('');
                          },
                        ),
                      ),
                      leftTitles: AxisTitles(
                        sideTitles: SideTitles(
                          showTitles: true,
                          reservedSize: 40,
                          getTitlesWidget: (value, meta) {
                            if (value == 0) return const SizedBox.shrink();
                            return Text(
                              NumberFormat.compact().format(value),
                              style: const TextStyle(color: Colors.white38, fontSize: 10),
                            );
                          },
                        ),
                      ),
                    ),
                    borderData: FlBorderData(show: false),
                    minX: 0,
                    maxX: 8,
                    minY: 0,
                    maxY: maxY,
                    lineBarsData: [
                      LineChartBarData(
                        spots: [
                          // Mapping Real Data to Visual X Coordinates
                          FlSpot(0, data.dailyTotals[1] ?? 0),
                          FlSpot(2, data.dailyTotals[2] ?? 0),
                          FlSpot(4, data.dailyTotals[3] ?? 0),
                          FlSpot(6, data.dailyTotals[4] ?? 0),
                          FlSpot(8, data.dailyTotals[5] ?? 0),
                        ],
                        isCurved: true,
                        color: AppColors.primaryBlue,
                        barWidth: 3,
                        isStrokeCapRound: true,
                        dotData: const FlDotData(show: false),
                        belowBarData: BarAreaData(
                          show: true,
                          color: AppColors.primaryBlue.withAlpha(25),
                        ),
                      ),
                    ],
                    lineTouchData: LineTouchData(
                      touchTooltipData: LineTouchTooltipData(
                        getTooltipColor: (spot) => Colors.black87,
                        getTooltipItems: (touchedSpots) {
                          return touchedSpots.map((spot) {
                            return LineTooltipItem(
                              "\$${spot.y.toStringAsFixed(2)}",
                              const TextStyle(color: Colors.white, fontWeight: FontWeight.bold),
                            );
                          }).toList();
                        },
                      ),
                    ),
                  ),
                ),
              ),
            ],
          );
        },
      ),
    );
  }
}
// ==========================================
// FILE: ./dashboard/dashboard_top_bar.dart
// ==========================================

import 'package:flutter/material.dart';
import '../../../../core/constants/app_colors.dart';

/// Top Bar Fragment - Displays user info, school status, and connectivity
/// Complies with Law of Fragments: Reusable, self-contained widget
class DashboardTopBar extends StatelessWidget {
  final String userName;
  final String schoolName;
  final bool hasSchool;
  final bool isConnected;
  final VoidCallback onAvatarTap;

  const DashboardTopBar({
    super.key,
    required this.userName,
    required this.schoolName,
    required this.hasSchool,
    required this.isConnected,
    required this.onAvatarTap,
  });

  String _getInitials(String name) {
    if (name.isEmpty) return "U";
    final parts = name.trim().split(' ');
    if (parts.length > 1) {
      return "${parts[0][0]}${parts[1][0]}".toUpperCase();
    }
    return name[0].toUpperCase();
  }

  @override
  Widget build(BuildContext context) {
    // Determine subtitle status (Offline / Syncing / School Name)
    String subtitle = schoolName;
    Color subtitleColor = AppColors.textWhite54;

    if (!hasSchool) {
      subtitle = isConnected ? "Tap avatar to setup" : "Waiting for Sync...";
      subtitleColor = AppColors.warningOrange;
    } else if (!isConnected) {
      subtitle = "Offline Mode";
      subtitleColor = AppColors.errorRed;
    } else if (schoolName == 'Loading...') {
      subtitle = "Syncing Data...";
      subtitleColor = AppColors.primaryBlueLight;
    }

    final initials = _getInitials(userName);

    return Container(
      height: 70,
      padding: const EdgeInsets.symmetric(horizontal: 24),
      decoration: const BoxDecoration(
        border: Border(bottom: BorderSide(color: AppColors.divider)),
      ),
      child: Row(
        children: [
          const Text(
            "Financial Dashboard",
            style: TextStyle(
              color: AppColors.textWhite,
              fontSize: 18,
              fontWeight: FontWeight.bold,
            ),
          ),
          const Spacer(),

          // User Info Column
          Column(
            mainAxisAlignment: MainAxisAlignment.center,
            crossAxisAlignment: CrossAxisAlignment.end,
            children: [
              Text(
                userName.isEmpty ? "User" : userName,
                style: const TextStyle(
                  color: AppColors.textWhite,
                  fontWeight: FontWeight.bold,
                  fontSize: 13,
                ),
              ),
              Row(
                children: [
                  if (!isConnected) ...[
                    const Icon(
                      Icons.wifi_off,
                      size: 10,
                      color: AppColors.errorRed,
                    ),
                    const SizedBox(width: 4),
                  ],
                  Text(
                    subtitle,
                    style: TextStyle(color: subtitleColor, fontSize: 11),
                  ),
                ],
              ),
            ],
          ),
          const SizedBox(width: 12),

          // Profile Avatar
          InkWell(
            onTap: onAvatarTap,
            borderRadius: BorderRadius.circular(50),
            child: CircleAvatar(
              backgroundColor: hasSchool
                  ? AppColors.primaryBlue.withValues(alpha: 0.2)
                  : AppColors.warningOrange.withValues(alpha: 0.2),
              child: hasSchool
                  ? Text(
                      initials,
                      style: const TextStyle(
                        color: AppColors.primaryBlue,
                        fontWeight: FontWeight.bold,
                        fontSize: 12,
                      ),
                    )
                  : const Icon(
                      Icons.priority_high,
                      color: AppColors.warningOrange,
                      size: 18,
                    ),
            ),
          ),
        ],
      ),
    );
  }
}

// ==========================================
// FILE: ./dashboard/kpi_section.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:intl/intl.dart';
import '../../../../core/constants/app_colors.dart';
import 'stat_cards.dart';

/// KPI Section Fragment - Displays key performance indicators
/// Complies with Law of Fragments: Encapsulates KPI logic and display
class KpiSection extends ConsumerWidget {
  final double outstandingBalance;
  final int studentCount;
  final AsyncValue fundraisingAsync;

  const KpiSection({
    super.key,
    required this.outstandingBalance,
    required this.studentCount,
    required this.fundraisingAsync,
  });

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    return Row(
      crossAxisAlignment: CrossAxisAlignment.stretch,
      children: [
        Expanded(
          child: StatCard(
            title: "Outstanding Bills",
            value: NumberFormat.simpleCurrency().format(outstandingBalance),
            icon: Icons.receipt_long,
            iconColor: AppColors.errorRed,
            iconBgColor: AppColors.errorRedBg,
            isAlert: outstandingBalance > 0,
            footer: const AlertBadge(text: "Updated", subText: "Just now"),
          ),
        ),
        const SizedBox(width: 24),
        Expanded(
          child: fundraisingAsync.when(
            loading: () => const Center(child: CircularProgressIndicator()),
            error: (_, __) => const SizedBox(),
            data: (fundData) {
              if (fundData == null) {
                return const StatCard(
                  title: "No Active Campaign",
                  value: "-",
                  icon: Icons.volunteer_activism,
                  iconColor: AppColors.iconGrey,
                  iconBgColor: AppColors.divider,
                );
              }
              return StatCard(
                title: fundData.campaignName,
                value: "${fundData.percentage.toStringAsFixed(1)}%",
                icon: Icons.volunteer_activism,
                iconColor: AppColors.accentPurple,
                iconBgColor: AppColors.purpleBg,
                footer: Text(
                  "Raised \$${fundData.raisedAmount.toInt()} of \$${fundData.goalAmount.toInt()}",
                  style: const TextStyle(
                    color: AppColors.textWhite38,
                    fontSize: 11,
                  ),
                ),
              );
            },
          ),
        ),
        const SizedBox(width: 24),
        Expanded(
          child: StatCard(
            title: "Active Students",
            value: studentCount.toString(),
            icon: Icons.school,
            iconColor: AppColors.primaryBlue,
            iconBgColor: AppColors.primaryBlueBg,
            footer: const Text(
              "Enrolled",
              style: TextStyle(color: AppColors.textWhite38, fontSize: 11),
            ),
          ),
        ),
      ],
    );
  }
}

// ==========================================
// FILE: ./dashboard/quick_actions_grid.dart
// ==========================================

import 'package:flutter/material.dart';
import '../../../core/constants/app_colors.dart';

enum QuickActionType {
  recordPayment,
  addExpense,
  registerStudent,
  createCampaign,
}

class QuickActionItem {
  final String label;
  final IconData icon;
  final Color color;
  final QuickActionType type;

  const QuickActionItem({
    required this.label,
    required this.icon,
    required this.color,
    required this.type,
  });
}

class QuickActionsGrid extends StatelessWidget {
  final Function(QuickActionType) onActionSelected;

  const QuickActionsGrid({
    super.key,
    required this.onActionSelected,
  });

  // --- CONFIGURATION ---
  final List<QuickActionItem> _actions = const [
    QuickActionItem(
      label: "Record Payment",
      icon: Icons.attach_money,
      color: AppColors.successGreen,
      type: QuickActionType.recordPayment,
    ),
    QuickActionItem(
      label: "Add Expense",
      icon: Icons.receipt_long,
      color: AppColors.errorRed,
      type: QuickActionType.addExpense,
    ),
    QuickActionItem(
      label: "New Student",
      icon: Icons.person_add,
      color: AppColors.primaryBlueLight,
      type: QuickActionType.registerStudent,
    ),
    QuickActionItem(
      label: "New Campaign",
      icon: Icons.campaign,
      color: AppColors.accentPurple,
      type: QuickActionType.createCampaign,
    ),
  ];

  @override
  Widget build(BuildContext context) {
    // This Container fills the Zone (400px height)
    return Container(
      padding: const EdgeInsets.all(24), 
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: AppColors.divider),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          const Text(
            "Quick Actions",
            style: TextStyle(
              color: AppColors.textWhite,
              fontSize: 18,
              fontWeight: FontWeight.bold,
            ),
          ),
          const SizedBox(height: 24),
          
          // Use Spacers to distribute buttons evenly within the 400px fixed height
          // This avoids stretching the buttons themselves.
          Expanded(
            child: Row(
              children: [
                Expanded(child: _buildActionCard(_actions[0])),
                const SizedBox(width: 16),
                Expanded(child: _buildActionCard(_actions[1])),
              ],
            ),
          ),
          const SizedBox(height: 16),
          Expanded(
            child: Row(
              children: [
                Expanded(child: _buildActionCard(_actions[2])),
                const SizedBox(width: 16),
                Expanded(child: _buildActionCard(_actions[3])),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildActionCard(QuickActionItem action) {
    // Material wraps the InkWell for the ripple effect
    return Material(
      color: Colors.transparent,
      child: InkWell(
        onTap: () => onActionSelected(action.type),
        borderRadius: BorderRadius.circular(12),
        hoverColor: AppColors.textWhite.withValues(alpha: 0.04),
        child: Container(
          width: double.infinity, // Fill width of the grid cell
          // Note: No fixed height here; the 'Expanded' in the parent layout handles height allocation
          // but because there are only 2 rows in 400px (minus text/padding), 
          // they will naturally be about 130px tall, which is a good aspect ratio.
          decoration: BoxDecoration(
            borderRadius: BorderRadius.circular(12),
            border: Border.all(color: AppColors.textWhite.withValues(alpha: 0.06)),
            color: AppColors.textWhite.withValues(alpha: 0.02),
          ),
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              Container(
                padding: const EdgeInsets.all(12),
                decoration: BoxDecoration(
                  color: action.color.withValues(alpha: 0.12),
                  shape: BoxShape.circle,
                ),
                child: Icon(action.icon, color: action.color, size: 24),
              ),
              const SizedBox(height: 12),
              Padding(
                padding: const EdgeInsets.symmetric(horizontal: 4.0),
                child: Text(
                  action.label,
                  maxLines: 1,
                  overflow: TextOverflow.ellipsis,
                  style: const TextStyle(
                    color: AppColors.textWhite70,
                    fontSize: 13,
                    fontWeight: FontWeight.w600,
                  ),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}
// ==========================================
// FILE: ./dashboard/student_dialog.dart
// ==========================================

import 'dart:math';
// ignore: unnecessary_import
import 'dart:ui';

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:intl/intl.dart';
import 'package:uuid/uuid.dart';

import '../../../../core/constants/app_colors.dart';
import '../../../../core/utils/safe_data.dart';
import '../../../../data/models/subjects.dart';
import '../../../../data/services/database_service.dart';

class StudentDialog extends ConsumerStatefulWidget {
  final String schoolId;

  const StudentDialog({
    super.key,
    required this.schoolId,
  });

  @override
  ConsumerState<StudentDialog> createState() => _StudentDialogState();
}

class _StudentDialogState extends ConsumerState<StudentDialog> {
  final _formKey = GlobalKey<FormState>();
  final DatabaseService _dbService = DatabaseService();

  // -- Controllers --
  final _fullNameController = TextEditingController();
  final _studentIdController = TextEditingController();
  final _parentContactController = TextEditingController();
  final _addressController = TextEditingController();
  final _feeController = TextEditingController();
  final _initialPayController = TextEditingController();

  // -- State --
  DateTime _dob = DateTime(2010, 1, 1);
  final DateTime _registrationDate = DateTime.now();
  String _selectedGender = 'Male';
  String _selectedGrade = 'FORM 1';
  String _billingType = 'monthly';
  List<String> _selectedSubjects = [];
  bool _isLoading = false;

  // -- Constants --
  final List<String> _genders = ['Male', 'Female'];
  final List<String> _grades = [
    'ECD A',
    'ECD B',
    'GRADE 1',
    'GRADE 2',
    'GRADE 3',
    'GRADE 4',
    'GRADE 5',
    'GRADE 6',
    'GRADE 7',
    'FORM 1',
    'FORM 2',
    'FORM 3',
    'FORM 4',
    'LOWER 6',
    'UPPER 6'
  ];

  @override
  void initState() {
    super.initState();
    _generateNewId();
  }

  void _generateNewId() {
    final random = Random();
    final idNumber = 100000000 + random.nextInt(900000000);
    _studentIdController.text = "STU-$idNumber";
  }

  @override
  void dispose() {
    _fullNameController.dispose();
    _studentIdController.dispose();
    _parentContactController.dispose();
    _addressController.dispose();
    _feeController.dispose();
    _initialPayController.dispose();
    super.dispose();
  }

  // --- LOGIC (Preserved Exactly) ---

  Future<void> _saveStudent() async {
    if (!_formKey.currentState!.validate()) return;

    setState(() => _isLoading = true);

    try {
      final db = _dbService;
      final newStudentUuid = const Uuid().v4();

      // 1. Prepare ID
      String displayId = _studentIdController.text.trim();
      if (displayId.isEmpty) {
        _generateNewId();
        displayId = _studentIdController.text;
      }

      final defaultFee =
          SafeData.parseDouble(_feeController.text.replaceAll(',', ''), 0.0);
      final initialPay = SafeData.parseDouble(
          _initialPayController.text.replaceAll(',', ''), 0.0);

      // üõ°Ô∏è Issue #3: Check for duplicate student ID
      final existingStudent = await db.db.getAll(
        'SELECT id FROM students WHERE student_id = ? AND school_id = ?',
        [displayId, widget.schoolId],
      );

      if (existingStudent.isNotEmpty) {
        if (mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(
              content: Text(
                  'Student ID "$displayId" already exists. Please use a different ID.'),
              backgroundColor: AppColors.errorRed,
              duration: const Duration(seconds: 4),
            ),
          );
        }
        setState(() => _isLoading = false);
        return;
      }

      // 2. Billing Date Logic
      String? billingDateStr;
      if (_billingType == 'monthly') {
        billingDateStr = DateFormat('yyyy-MM-dd').format(_registrationDate);
      }

      // 3. Insert Student (üõ°Ô∏è Issue #12: Sanitize all inputs)
      final studentData = {
        'id': newStudentUuid,
        'school_id': widget.schoolId,
        'student_id': SafeData.sanitize(displayId),
        'full_name': SafeData.sanitize(_fullNameController.text),
        'grade': _selectedGrade,
        'parent_contact': SafeData.sanitize(_parentContactController.text),
        'address': SafeData.sanitize(_addressController.text),
        'date_of_birth': DateFormat('yyyy-MM-dd').format(_dob),
        'gender': _selectedGender,
        'billing_type': _billingType,
        'default_fee': defaultFee,
        'subjects': _selectedSubjects.join(','),
        'registration_date': DateTime.now().toIso8601String(),
        'billing_date': billingDateStr,
        'enrollment_date': DateTime.now().toIso8601String(),
        'created_at': DateTime.now().toIso8601String(),
        'updated_at': DateTime.now().toIso8601String(),
        'is_active': 1,
        'owed_total': 0.0,
        'paid_total': initialPay,
        'photo_consent': 0,
      };

      await db.insert('students', studentData);
      debugPrint('‚úÖ Student created: $newStudentUuid');

      // 4. Auto-Billing (üõ°Ô∏è Issue #4 & #11: Track partial failures)
      String? generatedBillId;
      bool billingFailed = false;
      String? billingError;

      if (_billingType == 'monthly' && defaultFee > 0) {
        try {
          generatedBillId =
              await _attemptAutoBilling(newStudentUuid, defaultFee);
          debugPrint('‚úÖ Bill created: $generatedBillId');
        } catch (e) {
          billingFailed = true;
          billingError = e.toString();
          debugPrint('‚ö†Ô∏è Auto-billing error: $e');
        }
      }

      // 5. Initial Payment
      if (initialPay > 0) {
        await db.insert('payments', {
          'id': const Uuid().v4(),
          'school_id': widget.schoolId,
          'student_id': newStudentUuid,
          'bill_id': generatedBillId,
          'amount': initialPay,
          'date_paid': DateFormat('yyyy-MM-dd').format(DateTime.now()),
          'category': 'Tuition',
          'method': 'Cash',
          'payer_name': SafeData.sanitize(_fullNameController.text),
          'created_at': DateTime.now().toIso8601String(),
        });
      }

      if (mounted) {
        // üõ°Ô∏è Issue #11: Differentiate between full success and partial failure
        if (billingFailed) {
          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(
              content: Text(
                'Student registered successfully!\n'
                '‚ö†Ô∏è Auto-billing failed: $billingError\n'
                'You can manually create bills later.',
              ),
              backgroundColor: Colors.orange,
              duration: const Duration(seconds: 5),
            ),
          );
        } else {
          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(
              content: Text('Student registered successfully!'),
              backgroundColor: AppColors.successGreen,
            ),
          );
        }
        Navigator.of(context).pop();
      }
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
              content: Text('Error: $e'), backgroundColor: AppColors.errorRed),
        );
      }
    } finally {
      if (mounted) setState(() => _isLoading = false);
    }
  }

  Future<String> _attemptAutoBilling(String studentId, double amount) async {
    final allYears = await _dbService.db.getAll(
        'SELECT * FROM school_years WHERE school_id = ?', [widget.schoolId]);
    Map<String, dynamic>? activeYear;

    for (var y in allYears) {
      final start =
          SafeData.parseDate(y['start_date'], fallback: DateTime(2000));
      final end = SafeData.parseDate(y['end_date'], fallback: DateTime(2099));
      if (_registrationDate.isAfter(start.subtract(const Duration(days: 1))) &&
          _registrationDate.isBefore(end.add(const Duration(days: 1)))) {
        activeYear = y;
        break;
      }
    }

    if (activeYear == null) {
      throw Exception('No school year covers the registration date');
    }

    final months = await _dbService.db.getAll(
        'SELECT * FROM school_year_months WHERE school_year_id = ?',
        [activeYear['id']]);
    Map<String, dynamic>? activeMonth;

    for (var m in months) {
      final start =
          SafeData.parseDate(m['start_date'], fallback: DateTime(2000));
      final end = SafeData.parseDate(m['end_date'], fallback: DateTime(2099));
      if (_registrationDate.isAfter(start.subtract(const Duration(days: 1))) &&
          _registrationDate.isBefore(end.add(const Duration(days: 1)))) {
        activeMonth = m;
        break;
      }
    }

    if (activeMonth == null) {
      throw Exception('No billable month covers the registration date');
    }

    final billId = const Uuid().v4();
    await _dbService.insert('bills', {
      'id': billId,
      'school_id': widget.schoolId,
      'student_id': studentId,
      'title': 'Tuition - ${activeMonth['name']}',
      'total_amount': amount,
      'is_paid': 0,
      'bill_type': 'monthly',
      'billing_cycle_start': activeMonth['start_date'],
      'billing_cycle_end': activeMonth['end_date'],
      'month_year': activeMonth['name'],
      'school_year_id': activeYear['id'],
      'month_index': activeMonth['month_index'],
      'created_at': DateTime.now().toIso8601String(),
      'updated_at': DateTime.now().toIso8601String(),
    });

    return billId;
  }

  // --- SUB-DIALOGS ---

  void _openSubjectSelector() {
    showDialog(
      context: context,
      builder: (context) {
        final allSubjects = ZimsecSubject.allNames;
        List<String> tempSelected = List.from(_selectedSubjects);
        String searchQuery = "";

        return StatefulBuilder(builder: (context, setState) {
          final filteredSubjects = allSubjects
              .where((s) => s.toLowerCase().contains(searchQuery.toLowerCase()))
              .toList();

          return AlertDialog(
            backgroundColor: AppColors.surfaceGrey,
            title: const Text("Select Subjects",
                style: TextStyle(color: AppColors.textWhite)),
            content: SizedBox(
              width: 400,
              height: 500,
              child: Column(
                children: [
                  TextField(
                    onChanged: (val) => setState(() => searchQuery = val),
                    style: const TextStyle(color: AppColors.textWhite),
                    decoration: InputDecoration(
                      hintText: "Search subjects...",
                      hintStyle: const TextStyle(color: AppColors.textWhite38),
                      prefixIcon: const Icon(Icons.search,
                          color: AppColors.textWhite54),
                      filled: true,
                      fillColor: Colors.black12,
                      border: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(8),
                          borderSide: BorderSide.none),
                    ),
                  ),
                  const SizedBox(height: 12),
                  Expanded(
                    child: ListView.builder(
                      itemCount: filteredSubjects.length,
                      itemBuilder: (context, index) {
                        final subject = filteredSubjects[index];
                        final isSelected = tempSelected.contains(subject);
                        return CheckboxListTile(
                          title: Text(subject,
                              style: const TextStyle(
                                  color: AppColors.textWhite70)),
                          value: isSelected,
                          activeColor: AppColors.primaryBlue,
                          checkColor: AppColors.textWhite,
                          contentPadding: EdgeInsets.zero,
                          onChanged: (val) {
                            setState(() {
                              if (val == true) {
                                tempSelected.add(subject);
                              } else {
                                tempSelected.remove(subject);
                              }
                            });
                          },
                        );
                      },
                    ),
                  ),
                ],
              ),
            ),
            actions: [
              TextButton(
                onPressed: () => Navigator.pop(context),
                child: const Text("Cancel",
                    style: TextStyle(color: AppColors.textGrey)),
              ),
              ElevatedButton(
                onPressed: () {
                  this.setState(() => _selectedSubjects = tempSelected);
                  Navigator.pop(context);
                },
                style: ElevatedButton.styleFrom(
                    backgroundColor: AppColors.primaryBlue),
                child: const Text("Confirm",
                    style: TextStyle(color: AppColors.textWhite)),
              ),
            ],
          );
        });
      },
    );
  }

  // --- UI BUILD ---

  @override
  Widget build(BuildContext context) {
    return Dialog(
      backgroundColor: Colors.transparent,
      insetPadding: const EdgeInsets.all(24),
      child: Container(
        width: 1100,
        height: 800,
        decoration: BoxDecoration(
          color: AppColors.backgroundBlack,
          borderRadius: BorderRadius.circular(16),
          border: Border.all(color: AppColors.surfaceLightGrey),
          boxShadow: [
            BoxShadow(
                color: Colors.black.withValues(alpha: 0.5),
                blurRadius: 20,
                offset: const Offset(0, 10))
          ],
        ),
        child: Column(
          children: [
            // --- HEADER ---
            Padding(
              padding: const EdgeInsets.symmetric(horizontal: 32, vertical: 24),
              child: Row(
                children: [
                  Container(
                    padding: const EdgeInsets.all(8),
                    decoration: BoxDecoration(
                        color: AppColors.primaryBlue.withValues(alpha: 0.2),
                        borderRadius: BorderRadius.circular(8)),
                    child: const Icon(Icons.person_add,
                        color: AppColors.primaryBlue),
                  ),
                  const SizedBox(width: 16),
                  const Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text("Register Student",
                          style: TextStyle(
                              color: AppColors.textWhite,
                              fontSize: 18,
                              fontWeight: FontWeight.bold)),
                      Text("Add new student details to the database",
                          style: TextStyle(
                              color: AppColors.textGrey, fontSize: 13)),
                    ],
                  ),
                  const Spacer(),
                  IconButton(
                    onPressed: () => Navigator.pop(context),
                    icon: const Icon(Icons.close, color: AppColors.textGrey),
                  ),
                ],
              ),
            ),
            const Divider(height: 1, color: AppColors.divider),

            // --- MAIN CONTENT ---
            Expanded(
              child: Row(
                children: [
                  // --- LEFT: FORM (Flex 5) ---
                  Expanded(
                    flex: 5,
                    child: Padding(
                      padding: const EdgeInsets.all(32),
                      child: Form(
                        key: _formKey,
                        child: SingleChildScrollView(
                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              const Text("STUDENT DETAILS",
                                  style: TextStyle(
                                      color: AppColors.textGrey,
                                      fontSize: 12,
                                      fontWeight: FontWeight.bold,
                                      letterSpacing: 1.2)),
                              const SizedBox(height: 24),
                              _buildLabel("Full Name", AppColors.textWhite),
                              _buildTextField(
                                controller: _fullNameController,
                                hint: "e.g. Gabriel",
                                prefixIcon: Icons.person_outline,
                              ),
                              const SizedBox(height: 16),
                              Row(
                                children: [
                                  Expanded(
                                    child: Column(
                                      crossAxisAlignment:
                                          CrossAxisAlignment.start,
                                      children: [
                                        _buildLabel(
                                            "Student ID", AppColors.textWhite),
                                        _buildTextField(
                                          controller: _studentIdController,
                                          hint: "STU-...",
                                          suffixIcon: Icons.refresh,
                                          onSuffixTap: _generateNewId,
                                        ),
                                      ],
                                    ),
                                  ),
                                  const SizedBox(width: 16),
                                  Expanded(
                                    child: Column(
                                      crossAxisAlignment:
                                          CrossAxisAlignment.start,
                                      children: [
                                        _buildLabel(
                                            "Grade", AppColors.textWhite),
                                        _buildDropdown(
                                          value: _selectedGrade,
                                          items: _grades,
                                          onChanged: (v) => setState(
                                              () => _selectedGrade = v!),
                                        ),
                                      ],
                                    ),
                                  ),
                                ],
                              ),
                              const SizedBox(height: 16),
                              Row(
                                children: [
                                  Expanded(
                                    child: Column(
                                      crossAxisAlignment:
                                          CrossAxisAlignment.start,
                                      children: [
                                        _buildLabel("Date of Birth",
                                            AppColors.textWhite),
                                        _buildDatePicker(context, _dob,
                                            (d) => setState(() => _dob = d)),
                                      ],
                                    ),
                                  ),
                                  const SizedBox(width: 16),
                                  Expanded(
                                    child: Column(
                                      crossAxisAlignment:
                                          CrossAxisAlignment.start,
                                      children: [
                                        _buildLabel(
                                            "Gender", AppColors.textWhite),
                                        _buildDropdown(
                                          value: _selectedGender,
                                          items: _genders,
                                          onChanged: (v) => setState(
                                              () => _selectedGender = v!),
                                        ),
                                      ],
                                    ),
                                  ),
                                ],
                              ),
                              const SizedBox(height: 24),
                              const Text("CONTACT & FINANCIAL",
                                  style: TextStyle(
                                      color: AppColors.textGrey,
                                      fontSize: 12,
                                      fontWeight: FontWeight.bold,
                                      letterSpacing: 1.2)),
                              const SizedBox(height: 24),
                              Row(
                                children: [
                                  Expanded(
                                    child: Column(
                                      crossAxisAlignment:
                                          CrossAxisAlignment.start,
                                      children: [
                                        _buildLabel("Parent Contact",
                                            AppColors.textWhite),
                                        _buildTextField(
                                          controller: _parentContactController,
                                          hint: "+263 7...",
                                          prefixIcon: Icons.phone_outlined,
                                        ),
                                      ],
                                    ),
                                  ),
                                  const SizedBox(width: 16),
                                  Expanded(
                                    child: Column(
                                      crossAxisAlignment:
                                          CrossAxisAlignment.start,
                                      children: [
                                        _buildLabel("Billing Type",
                                            AppColors.textWhite),
                                        Container(
                                          height: 52, // Match input height
                                          decoration: BoxDecoration(
                                            color: AppColors.surfaceGrey,
                                            borderRadius:
                                                BorderRadius.circular(8),
                                            border: Border.all(
                                                color:
                                                    AppColors.surfaceLightGrey),
                                          ),
                                          padding: const EdgeInsets.all(4),
                                          child: Row(
                                            children: ['monthly', 'termly']
                                                .map((type) {
                                              final isSelected =
                                                  _billingType == type;
                                              return Expanded(
                                                child: GestureDetector(
                                                  onTap: () => setState(() =>
                                                      _billingType = type),
                                                  child: Container(
                                                    decoration: BoxDecoration(
                                                      color: isSelected
                                                          ? AppColors
                                                              .primaryBlue
                                                          : Colors.transparent,
                                                      borderRadius:
                                                          BorderRadius.circular(
                                                              6),
                                                    ),
                                                    alignment: Alignment.center,
                                                    child: Text(
                                                      type.toUpperCase(),
                                                      style: TextStyle(
                                                          fontSize: 12,
                                                          fontWeight:
                                                              FontWeight.bold,
                                                          color: isSelected
                                                              ? AppColors
                                                                  .textWhite
                                                              : AppColors
                                                                  .textGrey),
                                                    ),
                                                  ),
                                                ),
                                              );
                                            }).toList(),
                                          ),
                                        ),
                                      ],
                                    ),
                                  ),
                                ],
                              ),
                              const SizedBox(height: 16),
                              _buildLabel("Address", AppColors.textWhite),
                              _buildTextField(
                                controller: _addressController,
                                hint: "Street address...",
                                prefixIcon: Icons.location_on_outlined,
                              ),
                              const SizedBox(height: 16),
                              Row(
                                children: [
                                  Expanded(
                                    child: Column(
                                      crossAxisAlignment:
                                          CrossAxisAlignment.start,
                                      children: [
                                        _buildLabel(
                                            "Tuition Fee", AppColors.textWhite),
                                        _buildTextField(
                                          controller: _feeController,
                                          hint: "0.00",
                                          prefix: "\$ ",
                                          isNumber: true,
                                        ),
                                      ],
                                    ),
                                  ),
                                  const SizedBox(width: 16),
                                  Expanded(
                                    child: Column(
                                      crossAxisAlignment:
                                          CrossAxisAlignment.start,
                                      children: [
                                        _buildLabel("Initial Payment",
                                            AppColors.textWhite),
                                        _buildTextField(
                                          controller: _initialPayController,
                                          hint: "0.00",
                                          prefix: "\$ ",
                                          isNumber: true,
                                        ),
                                      ],
                                    ),
                                  ),
                                ],
                              ),
                              const SizedBox(height: 16),
                              _buildLabel("Subjects", AppColors.textWhite),
                              InkWell(
                                onTap: _openSubjectSelector,
                                child: Container(
                                  padding: const EdgeInsets.symmetric(
                                      horizontal: 16, vertical: 14),
                                  decoration: BoxDecoration(
                                    color: AppColors.surfaceGrey,
                                    borderRadius: BorderRadius.circular(8),
                                    border: Border.all(
                                        color: AppColors.surfaceLightGrey),
                                  ),
                                  child: Row(
                                    mainAxisAlignment:
                                        MainAxisAlignment.spaceBetween,
                                    children: [
                                      Text(
                                        _selectedSubjects.isEmpty
                                            ? "Select Subjects..."
                                            : "${_selectedSubjects.length} subjects selected",
                                        style: TextStyle(
                                            color: _selectedSubjects.isEmpty
                                                ? AppColors.textWhite54
                                                : AppColors.textWhite),
                                      ),
                                      const Icon(Icons.arrow_drop_down,
                                          color: AppColors.textWhite54),
                                    ],
                                  ),
                                ),
                              ),
                              if (_selectedSubjects.isNotEmpty) ...[
                                const SizedBox(height: 8),
                                Wrap(
                                  spacing: 8,
                                  runSpacing: 8,
                                  children: _selectedSubjects
                                      .take(5)
                                      .map((s) => Chip(
                                            label: Text(s,
                                                style: const TextStyle(
                                                    fontSize: 10,
                                                    color:
                                                        AppColors.textWhite)),
                                            backgroundColor: AppColors
                                                .primaryBlue
                                                .withValues(alpha: 0.2),
                                            padding: EdgeInsets.zero,
                                            side: BorderSide.none,
                                          ))
                                      .toList(),
                                ),
                              ],
                            ],
                          ),
                        ),
                      ),
                    ),
                  ),

                  const VerticalDivider(width: 1, color: AppColors.divider),

                  // --- RIGHT: LIST (Flex 4) ---
                  Expanded(
                    flex: 4,
                    child: Container(
                      color: AppColors.surfaceDarkGrey,
                      padding: const EdgeInsets.all(24),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Row(
                            mainAxisAlignment: MainAxisAlignment.spaceBetween,
                            children: [
                              const Text("RECENTLY ADDED",
                                  style: TextStyle(
                                      color: AppColors.textGrey,
                                      fontSize: 12,
                                      fontWeight: FontWeight.bold,
                                      letterSpacing: 1.2)),
                              StreamBuilder<List<Map<String, dynamic>>>(
                                  stream:
                                      _dbService.watchStudents(widget.schoolId),
                                  builder: (context, snapshot) {
                                    final count = snapshot.data?.length ?? 0;
                                    return Text("$count Total",
                                        style: const TextStyle(
                                            color: AppColors.textWhite,
                                            fontWeight: FontWeight.bold));
                                  }),
                            ],
                          ),
                          const SizedBox(height: 24),
                          Expanded(
                            child: StreamBuilder<List<Map<String, dynamic>>>(
                              stream: _dbService.db.watch(
                                  'SELECT * FROM students WHERE school_id = ? ORDER BY created_at DESC',
                                  parameters: [widget.schoolId]),
                              builder: (context, snapshot) {
                                if (!snapshot.hasData) {
                                  return const Center(
                                      child: CircularProgressIndicator());
                                }
                                final students = snapshot.data ?? [];
                                if (students.isEmpty) {
                                  return const Center(
                                      child: Text("No students yet.",
                                          style: TextStyle(
                                              color: AppColors.textGrey)));
                                }

                                return ListView.separated(
                                  itemCount: students.length,
                                  separatorBuilder: (_, __) =>
                                      const SizedBox(height: 12),
                                  itemBuilder: (context, index) {
                                    final s = students[index];
                                    final name = s['full_name'] ?? 'Unknown';
                                    final id = s['student_id'] ?? 'N/A';
                                    final grade = s['grade'] ?? 'N/A';

                                    return Container(
                                      padding: const EdgeInsets.all(16),
                                      decoration: BoxDecoration(
                                        color: AppColors.surfaceGrey,
                                        borderRadius: BorderRadius.circular(12),
                                        border: Border.all(
                                            color: Colors.white
                                                .withValues(alpha: 0.05)),
                                      ),
                                      child: Row(
                                        children: [
                                          CircleAvatar(
                                            backgroundColor: AppColors
                                                .primaryBlue
                                                .withValues(alpha: 0.1),
                                            child: Text(
                                                name.isNotEmpty
                                                    ? name[0].toUpperCase()
                                                    : '?',
                                                style: const TextStyle(
                                                    color:
                                                        AppColors.primaryBlue,
                                                    fontWeight:
                                                        FontWeight.bold)),
                                          ),
                                          const SizedBox(width: 16),
                                          Expanded(
                                            child: Column(
                                              crossAxisAlignment:
                                                  CrossAxisAlignment.start,
                                              children: [
                                                Text(name,
                                                    style: const TextStyle(
                                                        color:
                                                            AppColors.textWhite,
                                                        fontWeight:
                                                            FontWeight.bold)),
                                                const SizedBox(height: 2),
                                                Text("$id ‚Ä¢ $grade",
                                                    style: const TextStyle(
                                                        color:
                                                            AppColors.textGrey,
                                                        fontSize: 12)),
                                              ],
                                            ),
                                          ),
                                        ],
                                      ),
                                    );
                                  },
                                );
                              },
                            ),
                          ),
                        ],
                      ),
                    ),
                  ),
                ],
              ),
            ),

            const Divider(height: 1, color: AppColors.divider),

            // --- FOOTER ---
            Padding(
              padding: const EdgeInsets.all(24),
              child: Row(
                mainAxisAlignment: MainAxisAlignment.end,
                children: [
                  TextButton(
                    onPressed: () => Navigator.of(context).pop(),
                    child: const Text("Cancel",
                        style: TextStyle(color: AppColors.textWhite70)),
                  ),
                  const SizedBox(width: 16),
                  ElevatedButton.icon(
                    onPressed: _isLoading ? null : _saveStudent,
                    style: ElevatedButton.styleFrom(
                      backgroundColor: AppColors.primaryBlue,
                      padding: const EdgeInsets.symmetric(
                          horizontal: 24, vertical: 16),
                      shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(8)),
                      foregroundColor: AppColors.textWhite,
                    ),
                    icon: _isLoading
                        ? const SizedBox(
                            width: 16,
                            height: 16,
                            child: CircularProgressIndicator(
                                strokeWidth: 2, color: AppColors.textWhite))
                        : const Icon(Icons.check, size: 18),
                    label: Text(_isLoading ? "Saving..." : "Save Student",
                        style: const TextStyle(fontWeight: FontWeight.bold)),
                  ),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }

  // --- WIDGET HELPERS ---

  Widget _buildLabel(String text, Color color) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 8.0),
      child: Text(text,
          style: TextStyle(
              color: color.withValues(alpha: 0.9),
              fontSize: 14,
              fontWeight: FontWeight.w500)),
    );
  }

  Widget _buildTextField({
    required TextEditingController controller,
    required String hint,
    String? prefix,
    IconData? prefixIcon,
    IconData? suffixIcon,
    VoidCallback? onSuffixTap,
    bool isNumber = false,
  }) {
    return TextFormField(
      controller: controller,
      keyboardType: isNumber
          ? const TextInputType.numberWithOptions(decimal: true)
          : TextInputType.text,
      validator: (val) => val == null || val.isEmpty ? 'Required' : null,
      style: const TextStyle(color: AppColors.textWhite),
      decoration: InputDecoration(
        filled: true,
        fillColor: AppColors.surfaceGrey,
        hintText: hint,
        hintStyle: TextStyle(color: AppColors.textWhite.withValues(alpha: 0.3)),
        prefixText: prefix,
        prefixStyle: const TextStyle(
            color: AppColors.textWhite, fontWeight: FontWeight.bold),
        prefixIcon: prefixIcon != null
            ? Icon(prefixIcon, color: AppColors.textWhite54, size: 20)
            : null,
        suffixIcon: suffixIcon != null
            ? GestureDetector(
                onTap: onSuffixTap,
                child: Icon(suffixIcon, color: AppColors.textWhite54, size: 20))
            : null,
        border: OutlineInputBorder(
            borderRadius: BorderRadius.circular(8),
            borderSide: const BorderSide(color: AppColors.surfaceLightGrey)),
        enabledBorder: OutlineInputBorder(
            borderRadius: BorderRadius.circular(8),
            borderSide: const BorderSide(color: AppColors.surfaceLightGrey)),
        contentPadding:
            const EdgeInsets.symmetric(horizontal: 16, vertical: 16),
      ),
    );
  }

  Widget _buildDropdown({
    required String value,
    required List<String> items,
    required Function(String?) onChanged,
  }) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 16),
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(8),
        border: Border.all(color: AppColors.surfaceLightGrey),
      ),
      child: DropdownButtonHideUnderline(
        child: DropdownButton<String>(
          value: value,
          dropdownColor: AppColors.surfaceGrey,
          icon: const Icon(Icons.keyboard_arrow_down,
              color: AppColors.textWhite54),
          isExpanded: true,
          style: const TextStyle(color: AppColors.textWhite),
          items: items
              .map((e) => DropdownMenuItem(value: e, child: Text(e)))
              .toList(),
          onChanged: onChanged,
        ),
      ),
    );
  }

  Widget _buildDatePicker(
      BuildContext context, DateTime initial, Function(DateTime) onPicked) {
    return GestureDetector(
      onTap: () async {
        final picked = await showDatePicker(
          context: context,
          initialDate: initial,
          firstDate: DateTime(1990),
          lastDate: DateTime(2030),
          builder: (context, child) => Theme(
            data: ThemeData.dark().copyWith(
              colorScheme: const ColorScheme.dark(
                  primary: AppColors.primaryBlue,
                  onPrimary: AppColors.textWhite,
                  surface: AppColors.surfaceGrey),
            ),
            child: child!,
          ),
        );
        if (picked != null) onPicked(picked);
      },
      child: Container(
        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 14),
        decoration: BoxDecoration(
          color: AppColors.surfaceGrey,
          borderRadius: BorderRadius.circular(8),
          border: Border.all(color: AppColors.surfaceLightGrey),
        ),
        child: Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            Text(DateFormat('MMM dd, yyyy').format(initial),
                style: const TextStyle(color: AppColors.textWhite)),
            const Icon(Icons.calendar_today_outlined,
                size: 18, color: AppColors.textWhite54),
          ],
        ),
      ),
    );
  }
}

// ==========================================
// FILE: ./dashboard/no_school_overlay.dart
// ==========================================

import 'package:flutter/material.dart';
import '../../../../core/constants/app_colors.dart';

/// No School Overlay Fragment - Displays when school setup is incomplete
/// Complies with Law of Fragments: Isolated overlay logic
class NoSchoolOverlay extends StatelessWidget {
  final bool isConnected;
  final VoidCallback onCreateSchool;

  const NoSchoolOverlay({
    super.key,
    required this.isConnected,
    required this.onCreateSchool,
  });

  @override
  Widget build(BuildContext context) {
    return Positioned.fill(
      child: Container(
        color: AppColors.overlayDark,
        child: Center(
          child: Container(
            width: 500,
            margin: const EdgeInsets.all(24),
            padding: const EdgeInsets.all(32),
            decoration: BoxDecoration(
              color: AppColors.surfaceGrey,
              borderRadius: BorderRadius.circular(16),
              border: Border.all(color: AppColors.divider),
              boxShadow: [
                BoxShadow(
                  color: Colors.black.withValues(alpha: 0.5),
                  blurRadius: 30,
                  offset: const Offset(0, 10),
                ),
              ],
            ),
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                Icon(
                  isConnected ? Icons.domain_add : Icons.cloud_off,
                  size: 64,
                  color:
                      isConnected ? AppColors.primaryBlue : AppColors.iconGrey,
                ),
                const SizedBox(height: 24),
                Text(
                  isConnected ? "Welcome to Fees Up!" : "Syncing Data...",
                  style: const TextStyle(
                    color: AppColors.textWhite,
                    fontSize: 24,
                    fontWeight: FontWeight.bold,
                  ),
                  textAlign: TextAlign.center,
                ),
                const SizedBox(height: 12),
                Text(
                  isConnected
                      ? "It looks like you haven't set up a school yet. Create one now to access the dashboard."
                      : "We are waiting for your school data to download. Please check your internet connection.",
                  style: const TextStyle(
                    color: AppColors.textWhite70,
                    fontSize: 16,
                  ),
                  textAlign: TextAlign.center,
                ),
                const SizedBox(height: 32),
                if (isConnected)
                  ElevatedButton(
                    onPressed: onCreateSchool,
                    style: ElevatedButton.styleFrom(
                      backgroundColor: AppColors.primaryBlue,
                      foregroundColor: AppColors.textWhite,
                      padding: const EdgeInsets.symmetric(
                        horizontal: 40,
                        vertical: 20,
                      ),
                      textStyle: const TextStyle(
                        fontSize: 16,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                    child: const Text("Create School Profile"),
                  )
                else
                  const Column(
                    children: [
                      CircularProgressIndicator(color: AppColors.textWhite),
                      SizedBox(height: 16),
                      Text(
                        "Waiting for sync...",
                        style: TextStyle(color: AppColors.textWhite38),
                      ),
                    ],
                  ),
              ],
            ),
          ),
        ),
      ),
    );
  }
}

// ==========================================
// FILE: ./dashboard/dashboard_header.dart
// ==========================================

import 'package:flutter/material.dart';
import '../../../../core/constants/app_colors.dart';

/// Dashboard Header Fragment - Shows overview title and school name
/// Complies with Law of Fragments: Small, reusable header widget
class DashboardHeader extends StatelessWidget {
  final String schoolName;

  const DashboardHeader({
    super.key,
    required this.schoolName,
  });

  @override
  Widget build(BuildContext context) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        const Text(
          "Overview",
          style: TextStyle(
            fontSize: 28,
            fontWeight: FontWeight.bold,
            color: AppColors.textWhite,
          ),
        ),
        Text(
          "Status for $schoolName",
          style: const TextStyle(color: AppColors.textWhite54),
        ),
      ],
    );
  }
}

// ==========================================
// FILE: ./dashboard/campaign_dialog.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:intl/intl.dart';

import '../../../core/constants/app_colors.dart';
import '../../../data/providers/campaign_provider.dart';
import '../../../data/models/fundraiser_models.dart';

class CampaignDialog extends ConsumerStatefulWidget {
  final String schoolId;
  const CampaignDialog({super.key, required this.schoolId});

  @override
  ConsumerState<CampaignDialog> createState() => _CampaignDialogState();
}

class _CampaignDialogState extends ConsumerState<CampaignDialog> {
  final _formKey = GlobalKey<FormState>();
  
  // Controllers
  final _nameController = TextEditingController();
  final _goalController = TextEditingController();
  final _descController = TextEditingController();

  String _selectedType = 'Infrastructure';
  bool _forceCreateMode = false; // Toggle to override the "Active Campaign" warning

  @override
  void dispose() {
    _nameController.dispose();
    _goalController.dispose();
    _descController.dispose();
    super.dispose();
  }

  // --- ACTIONS ---

  Future<void> _submitCreate() async {
    if (!_formKey.currentState!.validate()) return;

    // Trigger the provider to create the campaign
    final success = await ref.read(campaignControllerProvider.notifier).createCampaign(
      schoolId: widget.schoolId,
      name: _nameController.text.trim(),
      goal: double.tryParse(_goalController.text.trim()) ?? 0.0,
      description: _descController.text.trim(),
      type: _selectedType,
    );

    if (success && mounted) {
      Navigator.of(context).pop();
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text("Campaign Launched Successfully"), 
          backgroundColor: AppColors.successGreen
        ),
      );
    }
  }

  Future<void> _closeExisting(String id) async {
    final success = await ref.read(campaignControllerProvider.notifier).closeCampaign(id);
    if (success && mounted) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text("Campaign Closed."), 
          backgroundColor: AppColors.primaryBlue
        ),
      );
      // Logic: The provider stream will update automatically, 
      // removing the active campaign and showing the form.
    }
  }

  // --- MAIN BUILD ---

  @override
  Widget build(BuildContext context) {
    final activeCampaignAsync = ref.watch(activeCampaignProvider(widget.schoolId));
    final controllerState = ref.watch(campaignControllerProvider);

    return Dialog(
      backgroundColor: Colors.transparent,
      insetPadding: const EdgeInsets.all(24),
      child: Container(
        width: 700,
        height: 800,
        decoration: BoxDecoration(
          color: AppColors.backgroundBlack,
          borderRadius: BorderRadius.circular(16),
          border: Border.all(color: AppColors.divider),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withValues(alpha: 0.5), 
              blurRadius: 20, 
              offset: const Offset(0, 10)
            )
          ],
        ),
        child: Column(
          children: [
            _buildHeader(),
            const Divider(height: 1, color: AppColors.divider),

            Expanded(
              child: activeCampaignAsync.when(
                loading: () => const Center(child: CircularProgressIndicator(color: AppColors.primaryBlue)),
                error: (e, _) => Center(child: Text("Error: $e", style: const TextStyle(color: AppColors.errorRed))),
                data: (existingCampaign) {
                  // If we have an active campaign AND we haven't forced "Create Mode"
                  if (existingCampaign != null && !_forceCreateMode) {
                    return _buildActiveCampaignWarning(existingCampaign, controllerState.isLoading);
                  }
                  // Otherwise show the form
                  return _buildCreateForm(controllerState.isLoading, existingCampaign != null);
                },
              ),
            ),
          ],
        ),
      ),
    );
  }

  // --- UI COMPONENTS ---

  Widget _buildHeader() {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 32, vertical: 24),
      child: Row(
        children: [
          Container(
            padding: const EdgeInsets.all(8),
            decoration: BoxDecoration(
              color: AppColors.accentPurple.withValues(alpha: 0.2), 
              borderRadius: BorderRadius.circular(8)
            ),
            child: const Icon(Icons.campaign, color: AppColors.accentPurple),
          ),
          const SizedBox(width: 16),
          const Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text("Campaign Manager", 
                style: TextStyle(color: AppColors.textWhite, fontSize: 18, fontWeight: FontWeight.bold)),
              Text("Fundraising & Projects", 
                style: TextStyle(color: AppColors.textWhite54, fontSize: 13)),
            ],
          ),
          const Spacer(),
          IconButton(
            onPressed: () => Navigator.of(context).pop(),
            icon: const Icon(Icons.close, color: AppColors.textGrey),
          ),
        ],
      ),
    );
  }

  Widget _buildActiveCampaignWarning(Campaign campaign, bool isLoading) {
    return Padding(
      padding: const EdgeInsets.all(32),
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Container(
            padding: const EdgeInsets.all(24),
            decoration: BoxDecoration(
              color: AppColors.warningOrange.withValues(alpha: 0.1),
              borderRadius: BorderRadius.circular(16),
              border: Border.all(color: AppColors.warningOrange.withValues(alpha: 0.3)),
            ),
            child: const Column(
              children: [
                Icon(Icons.warning_amber_rounded, size: 48, color: AppColors.warningOrange),
                SizedBox(height: 16),
                Text(
                  "Active Campaign Detected",
                  style: TextStyle(color: AppColors.warningOrange, fontSize: 20, fontWeight: FontWeight.bold),
                ),
                SizedBox(height: 8),
                Text(
                  "We recommend closing the current campaign before starting a new one to prevent data distortion.",
                  textAlign: TextAlign.center,
                  style: TextStyle(color: AppColors.textWhite70, height: 1.5),
                ),
              ],
            ),
          ),
          const SizedBox(height: 32),
          
          // Current Campaign Card
          Container(
            width: double.infinity,
            padding: const EdgeInsets.all(24),
            decoration: BoxDecoration(
              color: AppColors.surfaceGrey,
              borderRadius: BorderRadius.circular(12),
              border: Border.all(color: AppColors.divider),
            ),
            child: Row(
              children: [
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      const Text("RUNNING NOW", style: TextStyle(color: AppColors.textWhite54, fontSize: 11, fontWeight: FontWeight.bold)),
                      const SizedBox(height: 8),
                      Text(campaign.name, style: const TextStyle(color: AppColors.textWhite, fontSize: 22, fontWeight: FontWeight.bold)),
                      const SizedBox(height: 4),
                      Text("Goal: \$${NumberFormat().format(campaign.goalAmount)} ‚Ä¢ Type: ${campaign.type}", 
                        style: const TextStyle(color: AppColors.primaryBlueLight)),
                    ],
                  ),
                ),
                if (!isLoading)
                  ElevatedButton.icon(
                    onPressed: () => _closeExisting(campaign.id),
                    style: ElevatedButton.styleFrom(
                      backgroundColor: AppColors.errorRed,
                      foregroundColor: Colors.white,
                      padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 16),
                    ),
                    icon: const Icon(Icons.archive, size: 18),
                    label: const Text("Close This Campaign"),
                  ),
              ],
            ),
          ),

          const Spacer(),

          // Buttons
          Row(
            mainAxisAlignment: MainAxisAlignment.end,
            children: [
              TextButton(
                onPressed: () => Navigator.pop(context),
                child: const Text("Back", style: TextStyle(color: AppColors.textWhite70)),
              ),
              const SizedBox(width: 16),
              // THE "SCHOOL'S CONCERN" OPTION
              TextButton.icon(
                onPressed: () {
                  setState(() {
                    _forceCreateMode = true;
                  });
                },
                icon: const Icon(Icons.add_circle_outline, color: AppColors.warningOrange, size: 18),
                label: const Text("Start Concurrent Campaign (Advanced)", style: TextStyle(color: AppColors.warningOrange)),
              ),
            ],
          ),
        ],
      ),
    );
  }

  Widget _buildCreateForm(bool isLoading, bool isConcurrent) {
    return Padding(
      padding: const EdgeInsets.all(32),
      child: Form(
        key: _formKey,
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                const Text("START NEW CAMPAIGN", style: TextStyle(color: AppColors.textGrey, fontSize: 12, fontWeight: FontWeight.bold, letterSpacing: 1.2)),
                if (isConcurrent)
                  Container(
                    padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                    decoration: BoxDecoration(color: AppColors.warningOrange.withValues(alpha: 0.2), borderRadius: BorderRadius.circular(4)),
                    child: const Text("CONCURRENT MODE", style: TextStyle(color: AppColors.warningOrange, fontSize: 10, fontWeight: FontWeight.bold)),
                  )
              ],
            ),
            const SizedBox(height: 24),

            _buildLabel("Campaign Name"),
            _buildTextField(
              controller: _nameController,
              hint: "e.g. New Science Block 2025",
              validator: (v) => v!.isEmpty ? "Required" : null,
            ),
            const SizedBox(height: 16),

            Row(
              children: [
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      _buildLabel("Goal Amount"),
                      _buildTextField(
                        controller: _goalController,
                        hint: "0.00",
                        prefix: "\$ ",
                        inputType: const TextInputType.numberWithOptions(decimal: true),
                        validator: (v) {
                          if (v == null || v.isEmpty) return "Required";
                          if (double.tryParse(v) == null) return "Invalid";
                          return null;
                        },
                      ),
                    ],
                  ),
                ),
                const SizedBox(width: 16),
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      _buildLabel("Type"),
                      _buildDropdown(
                        value: _selectedType,
                        items: ["Infrastructure", "Event", "Charity", "Sports", "General"],
                        onChanged: (val) => setState(() => _selectedType = val!),
                      ),
                    ],
                  ),
                ),
              ],
            ),
            const SizedBox(height: 16),

            _buildLabel("Description / Purpose"),
            _buildTextField(
              controller: _descController,
              hint: "Describe the purpose of this fundraising...",
              maxLines: 4,
            ),

            const Spacer(),

            // Footer
            Row(
              mainAxisAlignment: MainAxisAlignment.end,
              children: [
                TextButton(
                  onPressed: () {
                    if (_forceCreateMode) {
                      setState(() => _forceCreateMode = false); // Go back to warning
                    } else {
                      Navigator.of(context).pop();
                    }
                  },
                  child: const Text("Cancel", style: TextStyle(color: AppColors.textWhite70)),
                ),
                const SizedBox(width: 16),
                ElevatedButton.icon(
                  onPressed: isLoading ? null : _submitCreate,
                  style: ElevatedButton.styleFrom(
                    backgroundColor: AppColors.primaryBlue,
                    foregroundColor: Colors.white,
                    padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 16),
                    shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
                  ),
                  icon: isLoading 
                    ? const SizedBox(width: 16, height: 16, child: CircularProgressIndicator(strokeWidth: 2, color: Colors.white)) 
                    : const Icon(Icons.rocket_launch, size: 18),
                  label: Text(isLoading ? "Launching..." : "Launch Campaign", style: const TextStyle(fontWeight: FontWeight.bold)),
                ),
              ],
            ),
          ],
        ),
      ),
    );
  }

  // --- UI HELPERS ---
  
  Widget _buildLabel(String text) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 8.0),
      child: Text(text, style: TextStyle(color: AppColors.textWhite.withValues(alpha: 0.9), fontSize: 14, fontWeight: FontWeight.w500)),
    );
  }

  Widget _buildTextField({
    required TextEditingController controller,
    required String hint,
    String? prefix,
    int maxLines = 1,
    TextInputType inputType = TextInputType.text,
    String? Function(String?)? validator,
  }) {
    return TextFormField(
      controller: controller, maxLines: maxLines, keyboardType: inputType,
      validator: validator,
      style: const TextStyle(color: AppColors.textWhite),
      decoration: InputDecoration(
        filled: true, fillColor: AppColors.surfaceGrey, hintText: hint,
        hintStyle: TextStyle(color: AppColors.textWhite.withValues(alpha: 0.3)),
        prefixText: prefix, prefixStyle: const TextStyle(color: AppColors.textWhite, fontWeight: FontWeight.bold),
        border: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.divider)),
        enabledBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.divider)),
        focusedBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.primaryBlue)),
      ),
    );
  }

  Widget _buildDropdown({
    required String value, required List<String> items,
    required Function(String?) onChanged,
  }) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 16),
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey, borderRadius: BorderRadius.circular(8),
        border: Border.all(color: AppColors.divider),
      ),
      child: DropdownButtonHideUnderline(
        child: DropdownButton<String>(
          value: value,
          dropdownColor: AppColors.surfaceGrey,
          icon: const Icon(Icons.keyboard_arrow_down, color: AppColors.textWhite54),
          isExpanded: true, style: const TextStyle(color: AppColors.textWhite),
          items: items.map((e) => DropdownMenuItem(value: e, child: Text(e))).toList(),
          onChanged: onChanged,
        ),
      ),
    );
  }
}
// ==========================================
// FILE: ./dashboard/payment_dialog.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:intl/intl.dart';
import 'package:uuid/uuid.dart';

import '../../../../core/constants/app_colors.dart';
import '../../../../data/services/database_service.dart';

class PaymentDialog extends ConsumerStatefulWidget {
  final String schoolId;
  
  const PaymentDialog({
    super.key, 
    required this.schoolId,
  });

  @override
  ConsumerState<PaymentDialog> createState() => _PaymentDialogState();
}

class _PaymentDialogState extends ConsumerState<PaymentDialog> {
  final _formKey = GlobalKey<FormState>();
  final DatabaseService _dbService = DatabaseService();

  // Controllers
  final TextEditingController _amountController = TextEditingController();
  final TextEditingController _payerController = TextEditingController();
  
  // State Variables
  String? _selectedStudentId; // Stores the valid UUID
  DateTime _selectedDate = DateTime.now();
  String _selectedMethod = 'Cash';
  String _selectedCategory = 'Tuition';
  bool _isLoading = false;

  // Constants
  final List<String> _methods = ['Cash', 'Bank Transfer', 'Mobile Money', 'Cheque'];
  final List<String> _categories = ['Tuition', 'Uniform', 'Levy', 'Transport', 'Donation'];

  @override
  void dispose() {
    _amountController.dispose();
    _payerController.dispose();
    super.dispose();
  }

  // --- LOGIC ---

  Future<void> _savePayment() async {
    if (!_formKey.currentState!.validate()) return;
    
    // Validation: Ensure a student was actually selected from the list
    if (_selectedStudentId == null) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text('Please search and select a valid student from the list'), 
          backgroundColor: AppColors.errorRed
        ),
      );
      return;
    }

    setState(() => _isLoading = true);

    try {
      final newId = const Uuid().v4();
      final amount = double.tryParse(_amountController.text) ?? 0.0;

      final paymentData = {
        'id': newId,
        'school_id': widget.schoolId,
        'student_id': _selectedStudentId, // Valid UUID from autocomplete
        'amount': amount,
        'date_paid': DateFormat('yyyy-MM-dd').format(_selectedDate),
        'category': _selectedCategory,
        'payer_name': _payerController.text.trim(),
        'method': _selectedMethod,
        'created_at': DateTime.now().toIso8601String(),
      };

      await _dbService.insert('payments', paymentData);

      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
            content: Text('Payment recorded successfully!'),
            backgroundColor: AppColors.successGreen,
          ),
        );
        Navigator.of(context).pop(); 
      }
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text('Error: $e'), backgroundColor: AppColors.errorRed),
        );
      }
    } finally {
      if (mounted) setState(() => _isLoading = false);
    }
  }

  // --- UI BUILD ---

  @override
  Widget build(BuildContext context) {
    return Dialog(
      backgroundColor: Colors.transparent,
      insetPadding: const EdgeInsets.all(24),
      child: Container(
        width: 1100,
        height: 700,
        decoration: BoxDecoration(
          color: AppColors.backgroundBlack,
          borderRadius: BorderRadius.circular(16),
          border: Border.all(color: AppColors.surfaceLightGrey),
          boxShadow: [
            BoxShadow(color: Colors.black.withValues(alpha: 0.5), blurRadius: 20, offset: const Offset(0, 10))
          ],
        ),
        child: Column(
          children: [
            // --- HEADER ---
            Padding(
              padding: const EdgeInsets.symmetric(horizontal: 32, vertical: 24),
              child: Row(
                children: [
                  Container(
                    padding: const EdgeInsets.all(8),
                    decoration: BoxDecoration(
                      color: AppColors.primaryBlue.withValues(alpha: 0.2),
                      borderRadius: BorderRadius.circular(8),
                    ),
                    child: const Icon(Icons.account_balance_wallet, color: AppColors.primaryBlue),
                  ),
                  const SizedBox(width: 16),
                  const Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text("Manage Payments", style: TextStyle(color: AppColors.textWhite, fontSize: 18, fontWeight: FontWeight.bold)),
                      Text("Record incoming fees and track recent transactions", style: TextStyle(color: AppColors.textGrey, fontSize: 13)),
                    ],
                  ),
                  const Spacer(),
                  IconButton(
                    onPressed: () => Navigator.pop(context),
                    icon: const Icon(Icons.close, color: AppColors.textGrey),
                  ),
                ],
              ),
            ),
            const Divider(height: 1, color: AppColors.divider),
            
            // --- BODY (Split View) ---
            Expanded(
              child: Row(
                children: [
                  // --- LEFT: FORM SECTION (Flex 4) ---
                  Expanded(
                    flex: 4,
                    child: Padding(
                      padding: const EdgeInsets.all(32),
                      child: Form(
                        key: _formKey,
                        child: SingleChildScrollView(
                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              const Text("NEW PAYMENT ENTRY", style: TextStyle(color: AppColors.textGrey, fontSize: 12, fontWeight: FontWeight.bold, letterSpacing: 1.2)),
                              const SizedBox(height: 24),

                              // --- SEARCHABLE STUDENT FIELD ---
                              _buildLabel("Student (Search Name or ID)", AppColors.textWhite),
                              StreamBuilder<List<Map<String, dynamic>>>(
                                stream: _dbService.watchStudents(widget.schoolId),
                                builder: (context, snapshot) {
                                  if (!snapshot.hasData) {
                                    return const LinearProgressIndicator(color: AppColors.primaryBlue, backgroundColor: AppColors.surfaceGrey);
                                  }
                                  
                                  final students = snapshot.data!;
                                  
                                  return LayoutBuilder(
                                    builder: (context, constraints) {
                                      return Autocomplete<Map<String, dynamic>>(
                                        optionsBuilder: (TextEditingValue textEditingValue) {
                                          if (textEditingValue.text.isEmpty) {
                                            return students;
                                          }
                                          return students.where((student) {
                                            final name = student['full_name'].toString().toLowerCase();
                                            final id = (student['student_id'] ?? '').toString().toLowerCase();
                                            final query = textEditingValue.text.toLowerCase();
                                            return name.contains(query) || id.contains(query);
                                          });
                                        },
                                        displayStringForOption: (Map<String, dynamic> option) => 
                                            "${option['full_name']} (${option['student_id'] ?? 'N/A'})",
                                        
                                        onSelected: (Map<String, dynamic> selection) {
                                          setState(() {
                                            _selectedStudentId = selection['id'];
                                          });
                                        },

                                        // The Input Field
                                        fieldViewBuilder: (context, textEditingController, focusNode, onFieldSubmitted) {
                                          return TextFormField(
                                            controller: textEditingController,
                                            focusNode: focusNode,
                                            style: const TextStyle(color: AppColors.textWhite),
                                            decoration: InputDecoration(
                                              filled: true,
                                              fillColor: AppColors.surfaceGrey,
                                              hintText: "Type to search...",
                                              hintStyle: TextStyle(color: AppColors.textWhite.withValues(alpha: 0.3)),
                                              prefixIcon: const Icon(Icons.search, color: AppColors.textWhite54, size: 20),
                                              border: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.surfaceLightGrey)),
                                              enabledBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.surfaceLightGrey)),
                                              focusedBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.primaryBlue, width: 2)),
                                              contentPadding: const EdgeInsets.symmetric(horizontal: 16, vertical: 16),
                                            ),
                                            onChanged: (text) {
                                              if (_selectedStudentId != null) {
                                                // logic to clear if needed
                                              }
                                            },
                                          );
                                        },

                                        // The Dropdown List Styling
                                        optionsViewBuilder: (context, onSelected, options) {
                                          return Align(
                                            alignment: Alignment.topLeft,
                                            child: Material(
                                              color: AppColors.surfaceGrey,
                                              elevation: 4.0,
                                              borderRadius: const BorderRadius.vertical(bottom: Radius.circular(8)),
                                              child: Container(
                                                width: constraints.maxWidth,
                                                constraints: const BoxConstraints(maxHeight: 250),
                                                decoration: BoxDecoration(
                                                  border: Border.all(color: AppColors.surfaceLightGrey),
                                                  borderRadius: const BorderRadius.vertical(bottom: Radius.circular(8)),
                                                ),
                                                child: ListView.builder(
                                                  padding: EdgeInsets.zero,
                                                  itemCount: options.length,
                                                  itemBuilder: (BuildContext context, int index) {
                                                    final Map<String, dynamic> option = options.elementAt(index);
                                                    return ListTile(
                                                      title: Text(option['full_name'], style: const TextStyle(color: AppColors.textWhite)),
                                                      subtitle: Text(option['student_id'] ?? 'No ID', style: const TextStyle(color: AppColors.textGrey, fontSize: 12)),
                                                      onTap: () => onSelected(option),
                                                      hoverColor: AppColors.textWhite.withValues(alpha: 0.1),
                                                    );
                                                  },
                                                ),
                                              ),
                                            ),
                                          );
                                        },
                                      );
                                    }
                                  );
                                },
                              ),
                              const SizedBox(height: 16),

                              // Amount & Date Row
                              Row(
                                children: [
                                  Expanded(
                                    child: Column(
                                      crossAxisAlignment: CrossAxisAlignment.start,
                                      children: [
                                        _buildLabel("Amount", AppColors.textWhite),
                                        _buildTextInput(
                                          controller: _amountController, 
                                          hint: "0.00", 
                                          isNumber: true,
                                          prefix: "\$ "
                                        ),
                                      ],
                                    ),
                                  ),
                                  const SizedBox(width: 16),
                                  Expanded(
                                    child: Column(
                                      crossAxisAlignment: CrossAxisAlignment.start,
                                      children: [
                                        _buildLabel("Payment Date", AppColors.textWhite),
                                        _buildDatePicker(context, _selectedDate, (d) => setState(() => _selectedDate = d)),
                                      ],
                                    ),
                                  ),
                                ],
                              ),
                              const SizedBox(height: 16),

                              // Category & Method Row
                              Row(
                                children: [
                                  Expanded(
                                    child: Column(
                                      crossAxisAlignment: CrossAxisAlignment.start,
                                      children: [
                                        _buildLabel("Category", AppColors.textWhite),
                                        _buildDropdown(
                                          value: _selectedCategory,
                                          items: _categories,
                                          onChanged: (v) => setState(() => _selectedCategory = v!),
                                        ),
                                      ],
                                    ),
                                  ),
                                  const SizedBox(width: 16),
                                  Expanded(
                                    child: Column(
                                      crossAxisAlignment: CrossAxisAlignment.start,
                                      children: [
                                        _buildLabel("Payment Method", AppColors.textWhite),
                                        _buildDropdown(
                                          value: _selectedMethod,
                                          items: _methods,
                                          onChanged: (v) => setState(() => _selectedMethod = v!),
                                        ),
                                      ],
                                    ),
                                  ),
                                ],
                              ),
                              const SizedBox(height: 16),

                              // Payer Name
                              _buildLabel("Payer Name (Parent/Guardian)", AppColors.textWhite),
                              _buildTextInput(
                                controller: _payerController, 
                                hint: "e.g. Mr. Smith", 
                                prefixIcon: Icons.person_outline
                              ),
                              
                              const SizedBox(height: 40),
                            ],
                          ),
                        ),
                      ),
                    ),
                  ),

                  const VerticalDivider(width: 1, color: AppColors.divider),

                  // --- RIGHT: LIST SECTION (Flex 3) ---
                  Expanded(
                    flex: 3,
                    child: Container(
                      color: AppColors.surfaceDarkGrey,
                      padding: const EdgeInsets.all(24),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Row(
                            mainAxisAlignment: MainAxisAlignment.spaceBetween,
                            children: [
                              const Text("RECENT PAYMENTS", style: TextStyle(color: AppColors.textGrey, fontSize: 12, fontWeight: FontWeight.bold, letterSpacing: 1.2)),
                              StreamBuilder<List<Map<String, dynamic>>>(
                                stream: _dbService.watchAll('payments'), 
                                builder: (context, snapshot) {
                                  if (!snapshot.hasData) return const Text("\$0.00", style: TextStyle(color: AppColors.textWhite, fontWeight: FontWeight.bold));
                                  double total = 0;
                                  for(var p in snapshot.data!) {
                                    total += (p['amount'] as num?)?.toDouble() ?? 0.0;
                                  }
                                  return Text("Total: \$${total.toStringAsFixed(2)}", style: const TextStyle(color: AppColors.textWhite, fontWeight: FontWeight.bold));
                                }
                              ),
                            ],
                          ),
                          const SizedBox(height: 24),

                          // List of Payments
                          Expanded(
                            child: StreamBuilder<List<Map<String, dynamic>>>(
                              stream: _dbService.watchAll('payments'),
                              builder: (context, snapshot) {
                                if (snapshot.connectionState == ConnectionState.waiting) {
                                  return const Center(child: CircularProgressIndicator(color: AppColors.primaryBlue));
                                }
                                
                                final payments = snapshot.data ?? [];
                                
                                if (payments.isEmpty) {
                                  return Center(
                                    child: Column(
                                      mainAxisAlignment: MainAxisAlignment.center,
                                      children: [
                                        Icon(Icons.receipt_long, size: 48, color: AppColors.textGrey.withValues(alpha: 0.2)),
                                        const SizedBox(height: 12),
                                        const Text("No payments recorded yet", style: TextStyle(color: AppColors.textGrey)),
                                      ],
                                    ),
                                  );
                                }

                                return ListView.separated(
                                  itemCount: payments.length,
                                  separatorBuilder: (_, __) => const SizedBox(height: 12),
                                  itemBuilder: (context, index) {
                                    final payment = payments[index];
                                    final amount = (payment['amount'] as num?)?.toDouble() ?? 0.0;
                                    final dateStr = payment['date_paid'] ?? '';
                                    final payer = payment['payer_name'] ?? 'Unknown Payer';
                                    final method = payment['method'] ?? 'Cash';

                                    return Container(
                                      padding: const EdgeInsets.all(16),
                                      decoration: BoxDecoration(
                                        color: AppColors.surfaceGrey,
                                        borderRadius: BorderRadius.circular(12),
                                        border: Border.all(color: Colors.white.withValues(alpha: 0.05)),
                                      ),
                                      child: Row(
                                        children: [
                                          // Icon Box
                                          Container(
                                            width: 40, height: 40,
                                            decoration: BoxDecoration(
                                              color: _getMethodColor(method).withValues(alpha: 0.1),
                                              borderRadius: BorderRadius.circular(8),
                                            ),
                                            child: Icon(
                                              _getMethodIcon(method),
                                              color: _getMethodColor(method),
                                              size: 20,
                                            ),
                                          ),
                                          const SizedBox(width: 12),
                                          
                                          // Details
                                          Expanded(
                                            child: Column(
                                              crossAxisAlignment: CrossAxisAlignment.start,
                                              children: [
                                                Text(payer, style: const TextStyle(color: AppColors.textWhite, fontWeight: FontWeight.bold, fontSize: 14)),
                                                const SizedBox(height: 2),
                                                Text("$method ‚Ä¢ $dateStr", style: const TextStyle(color: AppColors.textGrey, fontSize: 12)),
                                              ],
                                            ),
                                          ),

                                          // Amount
                                          Text(
                                            "+\$${amount.toStringAsFixed(2)}",
                                            style: const TextStyle(color: AppColors.successGreen, fontWeight: FontWeight.bold, fontSize: 14),
                                          ),
                                        ],
                                      ),
                                    );
                                  },
                                );
                              },
                            ),
                          ),
                        ],
                      ),
                    ),
                  ),
                ],
              ),
            ),
            
            const Divider(height: 1, color: AppColors.divider),

            // --- FOOTER ---
            Padding(
              padding: const EdgeInsets.all(24),
              child: Row(
                mainAxisAlignment: MainAxisAlignment.end,
                children: [
                  TextButton(
                    onPressed: () => Navigator.pop(context),
                    child: const Text("Cancel", style: TextStyle(color: AppColors.textWhite70)),
                  ),
                  const SizedBox(width: 16),
                  ElevatedButton.icon(
                    onPressed: _isLoading ? null : _savePayment,
                    style: ElevatedButton.styleFrom(
                      backgroundColor: AppColors.primaryBlue,
                      padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 16),
                      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
                      foregroundColor: AppColors.textWhite,
                    ),
                    icon: _isLoading 
                      ? const SizedBox(width: 16, height: 16, child: CircularProgressIndicator(strokeWidth: 2, color: AppColors.textWhite)) 
                      : const Icon(Icons.check, size: 18),
                    label: Text(_isLoading ? "Saving..." : "Save Payment", style: const TextStyle(fontWeight: FontWeight.bold)),
                  ),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }

  // --- WIDGET BUILDERS (Uniform with StudentDialog) ---

  Widget _buildLabel(String text, Color color) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 8.0),
      child: Text(text, style: TextStyle(color: color.withValues(alpha: 0.9), fontSize: 14, fontWeight: FontWeight.w500)),
    );
  }

  Widget _buildTextInput({
    required TextEditingController controller, 
    required String hint, 
    bool isNumber = false,
    String? prefix,
    IconData? prefixIcon
  }) {
    return TextFormField(
      controller: controller,
      keyboardType: isNumber ? const TextInputType.numberWithOptions(decimal: true) : TextInputType.text,
      style: const TextStyle(color: AppColors.textWhite),
      validator: (val) => val == null || val.isEmpty ? 'Required' : null,
      decoration: InputDecoration(
        filled: true,
        fillColor: AppColors.surfaceGrey,
        hintText: hint,
        hintStyle: TextStyle(color: AppColors.textWhite.withValues(alpha: 0.3)),
        prefixText: prefix, prefixStyle: const TextStyle(color: AppColors.textWhite, fontWeight: FontWeight.bold),
        prefixIcon: prefixIcon != null ? Icon(prefixIcon, color: AppColors.textWhite54, size: 20) : null,
        border: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.surfaceLightGrey)),
        enabledBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.surfaceLightGrey)),
        focusedBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.primaryBlue, width: 2)),
        contentPadding: const EdgeInsets.symmetric(horizontal: 16, vertical: 16),
      ),
    );
  }

  Widget _buildDropdown({
    required String value,
    required List<String> items,
    required Function(String?) onChanged,
  }) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 16),
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(8),
        border: Border.all(color: AppColors.surfaceLightGrey),
      ),
      child: DropdownButtonHideUnderline(
        child: DropdownButton<String>(
          value: value,
          dropdownColor: AppColors.surfaceGrey,
          icon: const Icon(Icons.keyboard_arrow_down, color: AppColors.textWhite54),
          isExpanded: true,
          style: const TextStyle(color: AppColors.textWhite),
          items: items.map((String val) {
            return DropdownMenuItem<String>(
              value: val,
              child: Text(val),
            );
          }).toList(),
          onChanged: onChanged,
        ),
      ),
    );
  }

  Widget _buildDatePicker(BuildContext context, DateTime initial, Function(DateTime) onPicked) {
    return GestureDetector(
      onTap: () async {
        final picked = await showDatePicker(
          context: context,
          initialDate: initial,
          firstDate: DateTime(2020),
          lastDate: DateTime.now().add(const Duration(days: 30)),
          builder: (context, child) {
            return Theme(
              data: ThemeData.dark().copyWith(
                colorScheme: const ColorScheme.dark(
                  primary: AppColors.primaryBlue,
                  onPrimary: AppColors.textWhite,
                  surface: AppColors.surfaceGrey,
                  onSurface: AppColors.textWhite,
                ),
              ),
              child: child!,
            );
          },
        );
        if (picked != null) onPicked(picked);
      },
      child: Container(
        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 14),
        decoration: BoxDecoration(
          color: AppColors.surfaceGrey,
          borderRadius: BorderRadius.circular(8),
          border: Border.all(color: AppColors.surfaceLightGrey),
        ),
        child: Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            Text(DateFormat('MMM dd, yyyy').format(initial), style: const TextStyle(color: AppColors.textWhite)),
            const Icon(Icons.calendar_today_outlined, size: 18, color: AppColors.textWhite54),
          ],
        ),
      ),
    );
  }

  // --- HELPERS ---

  Color _getMethodColor(String method) {
    switch (method.toLowerCase()) {
      case 'cash': return AppColors.successGreen;
      case 'bank transfer': return AppColors.primaryBlue;
      case 'mobile money': return AppColors.warningOrange;
      default: return AppColors.accentPurple;
    }
  }

  IconData _getMethodIcon(String method) {
    switch (method.toLowerCase()) {
      case 'cash': return Icons.attach_money;
      case 'bank transfer': return Icons.account_balance;
      case 'mobile money': return Icons.phone_android;
      default: return Icons.credit_card;
    }
  }
}
// ==========================================
// FILE: ./notifications/notifications_kpi_cards.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../../core/constants/app_colors.dart';
import '../../../../data/models/announcement_model.dart';
import '../../../../data/providers/notifications_provider.dart';

class NotificationsKpiCards extends ConsumerWidget {
  const NotificationsKpiCards({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final notificationsAsync = ref.watch(notificationsProvider);

    return notificationsAsync.when(
      data: (notifications) {
        // Safe Calculation
        final urgentUnread = notifications
            .where((n) => n.category == AnnouncementCategory.urgent && !n.isRead)
            .length;
        
        final totalUnread = notifications
            .where((n) => !n.isRead)
            .length;

        final total = notifications.length;

        return Row(
          children: [
            _buildCard(
              "Urgent Alerts", 
              urgentUnread.toString(), 
              Icons.warning_amber_rounded, 
              AppColors.errorRed,
              AppColors.errorRed.withValues(alpha: 0.1)
            ),
            const SizedBox(width: 24),
            _buildCard(
              "New Messages", 
              totalUnread.toString(), 
              Icons.mark_email_unread_outlined, 
              AppColors.primaryBlue,
              AppColors.primaryBlue.withValues(alpha: 0.1)
            ),
            const SizedBox(width: 24),
            _buildCard(
              "Total History", 
              total.toString(), 
              Icons.history, 
              AppColors.successGreen,
              AppColors.successGreen.withValues(alpha: 0.1)
            ),
          ],
        );
      },
      // Shimmer / Skeleton Loading State
      loading: () => Row(
        children: List.generate(3, (index) => Expanded(
          child: Container(
            height: 100,
            margin: EdgeInsets.only(left: index == 0 ? 0 : 24),
            decoration: BoxDecoration(
              color: AppColors.surfaceGrey,
              borderRadius: BorderRadius.circular(12),
              border: Border.all(color: AppColors.divider),
            ),
            child: const Center(child: CircularProgressIndicator(strokeWidth: 2)),
          ),
        )),
      ),
      // Graceful Error State
      error: (e, s) => Container(
        padding: const EdgeInsets.all(20),
        decoration: BoxDecoration(
          border: Border.all(color: AppColors.errorRed.withValues(alpha: 0.3)),
          borderRadius: BorderRadius.circular(12),
        ),
        child: const Text("System Alerts unavailable at the moment.", style: TextStyle(color: AppColors.errorRed)),
      ),
    );
  }

  Widget _buildCard(String title, String count, IconData icon, Color color, Color bg) {
    return Expanded(
      child: Container(
        padding: const EdgeInsets.all(20),
        decoration: BoxDecoration(
          color: AppColors.surfaceGrey,
          borderRadius: BorderRadius.circular(12),
          border: Border.all(color: AppColors.divider),
        ),
        child: Row(
          children: [
            Container(
              padding: const EdgeInsets.all(12),
              decoration: BoxDecoration(
                color: bg,
                borderRadius: BorderRadius.circular(8),
              ),
              child: Icon(icon, color: color, size: 24),
            ),
            const SizedBox(width: 16),
            Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(title, style: const TextStyle(color: AppColors.textWhite70, fontSize: 13)),
                Text(count, style: const TextStyle(color: AppColors.textWhite, fontSize: 24, fontWeight: FontWeight.bold)),
              ],
            ),
          ],
        ),
      ),
    );
  }
}
// ==========================================
// FILE: ./notifications/notifications_list.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:intl/intl.dart';
import '../../../../core/constants/app_colors.dart';
import '../../../../data/models/announcement_model.dart';
import '../../../../data/providers/notifications_provider.dart';

class NotificationsList extends ConsumerStatefulWidget {
  const NotificationsList({super.key});

  @override
  ConsumerState<NotificationsList> createState() => _NotificationsListState();
}

class _NotificationsListState extends ConsumerState<NotificationsList> {
  AnnouncementCategory? _categoryFilter;
  bool _showUnreadOnly = false;

  @override
  Widget build(BuildContext context) {
    final notificationsAsync = ref.watch(notificationsProvider);

    return Container(
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: AppColors.divider),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // --- DESKTOP OPTIMIZED FILTER PANEL ---
          Padding(
            padding: const EdgeInsets.all(20),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(
                  children: [
                    const Text("Filters",
                        style: TextStyle(
                            color: AppColors.textWhite,
                            fontWeight: FontWeight.bold)),
                    const Spacer(),
                    TextButton.icon(
                      onPressed: () =>
                          ref.read(notificationLogicProvider).markAllRead(),
                      icon: const Icon(Icons.done_all, size: 16),
                      label: const Text("Mark All Read"),
                      style: TextButton.styleFrom(
                          foregroundColor: AppColors.textWhite70),
                    ),
                  ],
                ),
                const SizedBox(height: 16),
                Wrap(
                  spacing: 10,
                  runSpacing: 10,
                  children: [
                    _buildFilterChip("All", null, Icons.all_inclusive),
                    _buildUnreadToggle(),
                    const _VerticalDivider(),
                    _buildFilterChip(
                        "Urgent", AnnouncementCategory.urgent, Icons.priority_high),
                    _buildFilterChip("Security", AnnouncementCategory.security,
                        Icons.shield_outlined),
                    _buildFilterChip(
                        "Errors", AnnouncementCategory.failure, Icons.error_outline),
                    _buildFilterChip("Warning", AnnouncementCategory.warning,
                        Icons.warning_amber),
                    const _VerticalDivider(),
                    _buildFilterChip("Financial", AnnouncementCategory.financial,
                        Icons.payments_outlined),
                    _buildFilterChip("Success", AnnouncementCategory.success,
                        Icons.check_circle_outline),
                    _buildFilterChip("System", AnnouncementCategory.system,
                        Icons.settings_input_component),
                  ],
                ),
              ],
            ),
          ),
          const Divider(height: 1, color: AppColors.divider),

          // --- DATA LIST ---
          notificationsAsync.when(
            data: (list) {
              var filtered = list;
              if (_categoryFilter != null) {
                filtered =
                    filtered.where((n) => n.category == _categoryFilter).toList();
              }
              if (_showUnreadOnly) {
                filtered = filtered.where((n) => !n.isRead).toList();
              }

              if (filtered.isEmpty) return _buildEmptyState();

              return ListView.separated(
                shrinkWrap: true,
                physics: const NeverScrollableScrollPhysics(),
                itemCount: filtered.length,
                separatorBuilder: (context, i) =>
                    const Divider(height: 1, color: AppColors.divider),
                itemBuilder: (context, i) => _buildNotificationItem(filtered[i]),
              );
            },
            loading: () => const Center(
                child: Padding(
                    padding: EdgeInsets.all(40),
                    child: CircularProgressIndicator())),
            error: (e, s) => Center(
                child: Padding(
                    padding: const EdgeInsets.all(40),
                    child: Text("System connection error: $e",
                        style: const TextStyle(color: AppColors.errorRed)))),
          ),
        ],
      ),
    );
  }

  // --- ITEM BUILDER ---

  Widget _buildNotificationItem(Announcement item) {
    final isUnread = !item.isRead;

    return InkWell(
      onTap: () => _showDetailsDialog(item),
      child: Container(
        padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 16),
        color: isUnread ? AppColors.backgroundBlack.withValues(alpha: 0.3) : null,
        child: Row(
          children: [
            // Category Icon
            Container(
              padding: const EdgeInsets.all(10),
              decoration: BoxDecoration(
                color: item.color.withValues(alpha: 0.1),
                shape: BoxShape.circle,
              ),
              child: Icon(item.icon, color: item.color, size: 20),
            ),
            const SizedBox(width: 16),

            // Content
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Row(
                    children: [
                      Text(
                        item.title,
                        style: TextStyle(
                          color: AppColors.textWhite,
                          fontWeight: isUnread ? FontWeight.bold : FontWeight.normal,
                          fontSize: 14,
                        ),
                      ),
                      if (isUnread) ...[
                        const SizedBox(width: 8),
                        Container(
                          width: 6,
                          height: 6,
                          decoration: const BoxDecoration(
                            color: AppColors.primaryBlue,
                            shape: BoxShape.circle,
                          ),
                        ),
                      ]
                    ],
                  ),
                  const SizedBox(height: 4),
                  Text(
                    item.body,
                    maxLines: 1,
                    overflow: TextOverflow.ellipsis,
                    style: const TextStyle(color: AppColors.textWhite70, fontSize: 13),
                  ),
                ],
              ),
            ),

            // Time & Quick Action
            const SizedBox(width: 16),
            Text(
              DateFormat('MMM d, h:mm a').format(item.time),
              style: const TextStyle(color: AppColors.textWhite38, fontSize: 12),
            ),
            const SizedBox(width: 16),
            if (isUnread)
              IconButton(
                onPressed: () => ref.read(notificationLogicProvider).markAsRead(item.id),
                icon: const Icon(Icons.check_circle_outline, size: 20),
                color: AppColors.textWhite38,
                tooltip: "Mark as read",
              )
            else
              const SizedBox(width: 48), // Spacer to maintain alignment
          ],
        ),
      ),
    );
  }

  // --- VISUAL DETAILS DIALOG ---

  void _showDetailsDialog(Announcement item) {
    // Auto-mark as read when opened
    if (!item.isRead) {
      ref.read(notificationLogicProvider).markAsRead(item.id);
    }

    showDialog(
      context: context,
      builder: (context) => Dialog(
        backgroundColor: AppColors.surfaceGrey,
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
        child: Container(
          width: 450,
          padding: const EdgeInsets.all(24),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Row(
                children: [
                  Container(
                    padding: const EdgeInsets.all(12),
                    decoration: BoxDecoration(
                      color: item.color.withValues(alpha: 0.1),
                      borderRadius: BorderRadius.circular(12),
                    ),
                    child: Icon(item.icon, color: item.color, size: 24),
                  ),
                  const SizedBox(width: 16),
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(
                          item.badgeLabel,
                          style: TextStyle(
                            color: item.color,
                            fontSize: 11,
                            fontWeight: FontWeight.bold,
                            letterSpacing: 1.1,
                          ),
                        ),
                        Text(
                          item.title,
                          style: const TextStyle(
                            color: AppColors.textWhite,
                            fontSize: 18,
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                      ],
                    ),
                  ),
                  IconButton(
                    onPressed: () => Navigator.pop(context),
                    icon: const Icon(Icons.close, color: AppColors.textWhite38),
                  ),
                ],
              ),
              const SizedBox(height: 24),
              const Divider(color: AppColors.divider),
              const SizedBox(height: 16),
              Text(
                item.body,
                style: const TextStyle(
                  color: AppColors.textWhite70,
                  fontSize: 15,
                  height: 1.6,
                ),
              ),
              const SizedBox(height: 32),
              Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  Text(
                    DateFormat('EEEE, MMMM d, yyyy ‚Ä¢ h:mm a').format(item.time),
                    style: const TextStyle(color: AppColors.textWhite38, fontSize: 12),
                  ),
                  ElevatedButton(
                    onPressed: () => Navigator.pop(context),
                    style: ElevatedButton.styleFrom(
                      backgroundColor: AppColors.backgroundBlack,
                      foregroundColor: AppColors.textWhite,
                      side: const BorderSide(color: AppColors.divider),
                    ),
                    child: const Text("Close"),
                  ),
                ],
              ),
            ],
          ),
        ),
      ),
    );
  }

  // --- HELPERS (Previously defined) ---

  Widget _buildFilterChip(String label, AnnouncementCategory? category, IconData icon) {
    final isSelected = _categoryFilter == category;
    final Color activeColor = _getCategoryColor(category);

    return InkWell(
      onTap: () => setState(() => _categoryFilter = category),
      borderRadius: BorderRadius.circular(8),
      child: AnimatedContainer(
        duration: const Duration(milliseconds: 200),
        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),
        decoration: BoxDecoration(
          color: isSelected ? activeColor.withValues(alpha: 0.15) : AppColors.backgroundBlack,
          borderRadius: BorderRadius.circular(8),
          border: Border.all(color: isSelected ? activeColor : AppColors.divider, width: 1),
        ),
        child: Row(
          mainAxisSize: MainAxisSize.min,
          children: [
            Icon(icon, size: 16, color: isSelected ? activeColor : AppColors.textWhite38),
            const SizedBox(width: 8),
            Text(label,
                style: TextStyle(
                  color: isSelected ? AppColors.textWhite : AppColors.textWhite70,
                  fontSize: 13,
                  fontWeight: isSelected ? FontWeight.bold : FontWeight.normal,
                )),
          ],
        ),
      ),
    );
  }

  Widget _buildUnreadToggle() {
    return InkWell(
      onTap: () => setState(() => _showUnreadOnly = !_showUnreadOnly),
      borderRadius: BorderRadius.circular(8),
      child: AnimatedContainer(
        duration: const Duration(milliseconds: 200),
        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),
        decoration: BoxDecoration(
          color: _showUnreadOnly ? AppColors.primaryBlue : AppColors.backgroundBlack,
          borderRadius: BorderRadius.circular(8),
          border: Border.all(color: _showUnreadOnly ? AppColors.primaryBlue : AppColors.divider),
        ),
        child: Row(
          mainAxisSize: MainAxisSize.min,
          children: [
            Icon(Icons.mark_email_unread_outlined,
                size: 16,
                color: _showUnreadOnly ? Colors.white : AppColors.textWhite38),
            const SizedBox(width: 8),
            Text("Unread Only",
                style: TextStyle(
                  color: _showUnreadOnly ? Colors.white : AppColors.textWhite70,
                  fontSize: 13,
                  fontWeight: _showUnreadOnly ? FontWeight.bold : FontWeight.normal,
                )),
          ],
        ),
      ),
    );
  }

  Color _getCategoryColor(AnnouncementCategory? category) {
    if (category == null) return AppColors.primaryBlue;
    switch (category) {
      case AnnouncementCategory.urgent:
      case AnnouncementCategory.failure:
        return AppColors.errorRed;
      case AnnouncementCategory.warning:
        return Colors.amber;
      case AnnouncementCategory.success:
        return AppColors.successGreen;
      case AnnouncementCategory.security:
        return const Color(0xFF9333EA);
      default:
        return AppColors.primaryBlue;
    }
  }

  Widget _buildEmptyState() {
    return Container(
      width: double.infinity,
      padding: const EdgeInsets.all(60),
      child: const Column(
        children: [
          Icon(Icons.inbox_outlined, size: 48, color: AppColors.textWhite38),
          SizedBox(height: 16),
          Text("No results found for these filters.",
              style: TextStyle(color: AppColors.textWhite54)),
        ],
      ),
    );
  }
}

class _VerticalDivider extends StatelessWidget {
  const _VerticalDivider();
  @override
  Widget build(BuildContext context) => Padding(
        padding: const EdgeInsets.symmetric(horizontal: 8),
        child: Container(width: 1, height: 32, color: AppColors.divider),
      );
}
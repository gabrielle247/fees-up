import 'package:flutter/material.dart';
import '../constants/app_colors.dart';

class AppTheme {
  // Private constructor
  const AppTheme._();

  static ThemeData get darkTheme {
    return ThemeData(
      useMaterial3: true,
      brightness: Brightness.dark,
      primaryColor: AppColors.primaryBlue,
      scaffoldBackgroundColor: AppColors.backgroundBlack,
      
      // Color Scheme
      colorScheme: const ColorScheme.dark(
        primary: AppColors.primaryBlue,
        secondary: AppColors.primaryBlueLight,
        surface: AppColors.surfaceGrey,
        error: AppColors.errorRed,
        onPrimary: AppColors.textWhite,
        onSecondary: AppColors.backgroundBlack,
        onSurface: AppColors.textWhite,
        onError: AppColors.backgroundBlack,
      ),

      // AppBar Theme
      appBarTheme: const AppBarTheme(
        backgroundColor: AppColors.surfaceGrey,
        elevation: 0,
        centerTitle: false,
        iconTheme: IconThemeData(color: AppColors.textWhite),
        titleTextStyle: TextStyle(
          color: AppColors.textWhite,
          fontSize: 20,
          fontWeight: FontWeight.bold,
        ),
      ),

      // Card Theme
      cardTheme: CardThemeData(
        color: AppColors.surfaceGrey,
        elevation: 2,
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(12),
        ),
        margin: const EdgeInsets.symmetric(vertical: 8, horizontal: 16),
      ),

      // Button Themes
      elevatedButtonTheme: ElevatedButtonThemeData(
        style: ElevatedButton.styleFrom(
          backgroundColor: AppColors.primaryBlue,
          foregroundColor: AppColors.textWhite,
          padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 12),
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(8),
          ),
          elevation: 2,
        ),
      ),

      // Input Decoration Theme (TextFields)
      inputDecorationTheme: InputDecorationTheme(
        filled: true,
        fillColor: AppColors.surfaceLightGrey,
        border: OutlineInputBorder(
          borderRadius: BorderRadius.circular(8),
          borderSide: BorderSide.none,
        ),
        focusedBorder: OutlineInputBorder(
          borderRadius: BorderRadius.circular(8),
          borderSide: const BorderSide(
            color: AppColors.primaryBlue, 
            width: 2,
          ),
        ),
        errorBorder: OutlineInputBorder(
          borderRadius: BorderRadius.circular(8),
          borderSide: const BorderSide(
            color: AppColors.errorRed, 
            width: 1,
          ),
        ),
        labelStyle: const TextStyle(color: AppColors.textGrey),
        hintStyle: TextStyle(
          color: AppColors.textGrey.withAlpha(128), // Using withAlpha as requested
        ),
      ),
    );
  }
}import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';

// --- MOCK PROVIDER ---
// Toggle this to 'true' to simulate a paid account, 'false' for free tier.
// We keep it true for now so you can work without disturbance.
final isPremiumProvider = Provider<bool>((ref) => true); 

class PremiumGuard extends ConsumerWidget {
  final Widget child;
  final String featureName;

  const PremiumGuard({
    super.key, 
    required this.child,
    this.featureName = "This Feature",
  });

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final isPremium = ref.watch(isPremiumProvider);

    // If Premium, show the actual feature
    if (isPremium) {
      return child;
    }

    // If Limited, show the "Blank Canvas" / Upgrade Prompt
    return Stack(
      children: [
        // 1. Blurred/Disabled Child (Optional, or just hide it)
        Opacity(
          opacity: 0.1,
          child: AbsorbPointer(child: child),
        ),

        // 2. The Upgrade Overlay
        Center(
          child: Container(
            margin: const EdgeInsets.all(24),
            padding: const EdgeInsets.all(32),
            decoration: BoxDecoration(
              color: const Color(0xFF151718),
              borderRadius: BorderRadius.circular(24),
              border: Border.all(color: Colors.white10),
              boxShadow: [
                BoxShadow(
                  color: Colors.black.withAlpha((0.5*255) as int),
                  blurRadius: 30,
                  offset: const Offset(0, 10),
                )
              ],
            ),
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                const Icon(Icons.diamond_outlined, size: 48, color: Color(0xFFA855F7)), // Purple
                const SizedBox(height: 20),
                Text(
                  "Unlock $featureName",
                  style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.bold),
                ),
                const SizedBox(height: 12),
                const Text(
                  "This feature is available on the Unlimited Plan. \nUpgrade to remove limits.",
                  textAlign: TextAlign.center,
                  style: TextStyle(color: Colors.grey, height: 1.5),
                ),
                const SizedBox(height: 24),
                ElevatedButton(
                  onPressed: () {
                    // TODO: Navigate to Payment/Subscription Screen
                    ScaffoldMessenger.of(context).showSnackBar(
                      const SnackBar(content: Text("Subscription Flow Coming Soon")),
                    );
                  },
                  style: ElevatedButton.styleFrom(
                    backgroundColor: const Color(0xFFA855F7),
                    foregroundColor: Colors.white,
                    padding: const EdgeInsets.symmetric(horizontal: 32, vertical: 16),
                  ),
                  child: const Text("Get Unlimited Access"),
                ),
              ],
            ),
          ),
        ),
      ],
    );
  }
}import 'package:flutter/material.dart';

class AppColors {
  // Private constructor to prevent instantiation
  const AppColors._();

  // Greyway.Co Brand Colors
  // A distinct, professional "Tech Blue"
  static const Color primaryBlue = Color(0xFF2962FF); 
  static const Color primaryBlueLight = Color(0xFF768FFF);
  static const Color primaryBlueDark = Color(0xFF0039CB);

  // Dark Mode Backgrounds
  static const Color backgroundBlack = Color(0xff121b22); // Deep dark background
  static const Color surfaceGrey = Color(0xff1c2a35); // Cards and Sheets
  static const Color surfaceLightGrey = Color(0xff2c2c2c); // Hover states

  // Text Colors
  static const Color textWhite = Color(0xFFFFFFFF);
  static const Color textGrey = Color(0xFFB0B0B0);

  // Functional Colors
  static const Color errorRed = Color(0xFFCF6679);
  static const Color successGreen = Color(0xFF00C853);
  static const Color warningOrange = Color(0xFFFFAB00);
}import 'dart:async';

import 'package:fees_up/mobile/screens/auth/mobile_signup_screen.dart';
import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:supabase_flutter/supabase_flutter.dart';

import '../../pc/screens/pc_home_screen.dart';

final appRouterProvider = Provider<GoRouter>((ref) {
  return GoRouter(
    initialLocation: '/',
    debugLogDiagnostics: true, // Useful for debugging redirects
    
    // 1. LISTEN TO AUTH CHANGES
    // This triggers a refresh whenever Supabase auth state changes (login/logout)
    refreshListenable: GoRouterRefreshStream(Supabase.instance.client.auth.onAuthStateChange),
    
    // 2. REDIRECT LOGIC
    redirect: (context, state) {
      final session = Supabase.instance.client.auth.currentSession;
      
      // Are we currently on a login or signup page?
      final isAuthRoute = state.uri.toString() == '/login' || state.uri.toString() == '/signup';

      // CASE A: User is NOT logged in
      if (session == null) {
        // If they are not on an auth page, force them to login
        return isAuthRoute ? null : '/login';
      }

      // CASE B: User IS logged in
      if (isAuthRoute) {
        // If they are on an auth page, send them to home
        return '/';
      }

      // No redirect needed
      return null;
    },

    routes: [
      GoRoute(
        path: '/',
        builder: (context, state) => const PCHomeScreen(),
      ),
      GoRoute(
        path: '/login',
        builder: (context, state) => const MobileAuthScreen(initialIsLogin: true),
      ),
      GoRoute(
        path: '/signup',
        builder: (context, state) => const MobileAuthScreen(initialIsLogin: false),
      ),
    ],
  );
});

/// A Helper class that converts a Stream (like Supabase auth) into a Listenable 
/// that GoRouter can understand.
class GoRouterRefreshStream extends ChangeNotifier {
  late final StreamSubscription<dynamic> _subscription;

  GoRouterRefreshStream(Stream<dynamic> stream) {
    notifyListeners();
    _subscription = stream.asBroadcastStream().listen(
      (dynamic _) => notifyListeners(),
    );
  }

  @override
  void dispose() {
    _subscription.cancel();
    super.dispose();
  }
}import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:supabase_flutter/supabase_flutter.dart';
import 'package:logging/logging.dart'; // <--- ADD THIS IMPORT

import 'core/theme/app_theme.dart';
import 'core/routes/app_router.dart';
import 'data/services/database_service.dart';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();

  // 0. SILENCE LOGS (Production Setting)
  // This stops the infinite warning loop in the console
  Logger.root.level = Level.SEVERE; 

  // 1. Load Keys from Environment (Makefile)
  const supabaseUrl = String.fromEnvironment('SUPABASE_URL');
  const supabaseAnonKey = String.fromEnvironment('SUPABASE_ANON_KEY');

  if (supabaseUrl.isEmpty || supabaseAnonKey.isEmpty) {
    debugPrint("⚠️ WARNING: Supabase Keys missing. Run with 'make run'.");
  } else {
    // 2. Initialize Supabase
    await Supabase.initialize(
      url: supabaseUrl,
      anonKey: supabaseAnonKey,
    );
  }

  // 3. Initialize Database Engine (PowerSync)
  try {
    final dbService = DatabaseService();
    await dbService.initialize();
  } catch (e) {
    debugPrint("❌ Database Init Failed: $e");
  }

  // 4. Run App wrapped in ProviderScope
  runApp(
    const ProviderScope(
      child: GreywayApp(),
    ),
  );
}

class GreywayApp extends ConsumerWidget {
  const GreywayApp({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final router = ref.watch(appRouterProvider);

    return MaterialApp.router(
      debugShowCheckedModeBanner: false,
      title: 'Fees Up',
      theme: AppTheme.darkTheme,
      routerConfig: router,
    );
  }
}import '../services/database_service.dart';

class DashboardRepository {
  final DatabaseService _db;

  DashboardRepository(this._db);

  /// 1. Get the Current User's School ID and Name
  Future<Map<String, dynamic>?> getSchoolDetails(String userId) async {
    // First, find the user's profile to get the school_id
    final profile = await _db.getById('user_profiles', userId);
    if (profile == null || profile['school_id'] == null) return null;

    final schoolId = profile['school_id'];
    
    // Then get the school details
    final school = await _db.getById('schools', schoolId);
    
    return {
      'school_id': schoolId,
      'school_name': school?['name'] ?? 'My School',
      'user_role': profile['role'] ?? 'Admin',
      'user_name': profile['full_name'] ?? 'User',
    };
  }

  /// 2. Watch Key Stats (Real-time)
  /// We combine multiple streams into one or just watch specific tables.
  /// For performance, we usually watch tables and calculate sums in Dart for small datasets,
  /// or use SQL queries if PowerSync supports the aggregate subscription (it does via watch()).
  
  Stream<int> watchStudentCount(String schoolId) {
    return _db.db.watch(
      'SELECT count(*) as count FROM students WHERE school_id = ? AND is_active = 1',
      parameters: [schoolId]
    ).map((results) => results.first['count'] as int);
  }

  Stream<double> watchOutstandingBills(String schoolId) {
    return _db.db.watch(
      'SELECT sum(total_amount - paid_amount) as total FROM bills WHERE school_id = ? AND is_paid = 0',
      parameters: [schoolId]
    ).map((results) => (results.first['total'] as num?)?.toDouble() ?? 0.0);
  }

  Stream<double> watchDailyAttendance(String schoolId) {
    // Simple calculation: Present / Total Students today
    // This is a simplified logic for the dashboard view
    final today = DateTime.now().toIso8601String().split('T')[0];
    return _db.db.watch(
      "SELECT count(*) as count FROM attendance WHERE school_id = ? AND date = ? AND status = 'present'",
      parameters: [schoolId, today]
    ).map((results) => (results.first['count'] as num?)?.toDouble() ?? 0.0);
  }

  /// 3. Get Recent Transactions
  Stream<List<Map<String, dynamic>>> watchRecentPayments(String schoolId) {
    return _db.db.watch(
      'SELECT * FROM payments WHERE school_id = ? ORDER BY date_paid DESC LIMIT 5',
      parameters: [schoolId]
    );
  }
}import 'package:supabase_flutter/supabase_flutter.dart';
import 'package:uuid/uuid.dart';
import '../services/database_service.dart';

class AuthRepository {
  final GoTrueClient _auth;
  final DatabaseService _db;

  AuthRepository({GoTrueClient? auth, DatabaseService? db}) 
      : _auth = auth ?? Supabase.instance.client.auth,
        _db = db ?? DatabaseService();

  User? get currentUser => _auth.currentUser;
  
  Stream<AuthState> get authStateChanges => _auth.onAuthStateChange;

  /// Sign In with Friendly Errors
  Future<AuthResponse> signIn({required String email, required String password}) async {
    try {
      return await _auth.signInWithPassword(email: email, password: password);
    } on AuthException catch (e) {
      throw _getHumanReadableError(e.message);
    } on PostgrestException catch (e) {
      throw _getHumanReadableError(e.message);
    } catch (_) {
      throw 'Unable to login. Please check your internet connection.';
    }
  }

  /// Sign Out
  Future<void> signOut() async {
    try {
      await _auth.signOut();
    } catch (e) {
      // Fail silently on logout errors, just clear local state if needed
    }
  }

  /// Setup School with Friendly Errors
  Future<void> signUpWithSchool({
    required String fullName,
    required String email,
    required String password,
    required String schoolName,
  }) async {
    try {
      // 1. Create Auth User
      final response = await _auth.signUp(
        email: email,
        password: password,
        data: {'full_name': fullName},
      );

      final user = response.user;
      if (user == null) throw 'Sign up failed. Please try again.';

      // 2. Generate IDs
      final schoolId = const Uuid().v4();
      
      // 3. Write Data Locally (Offline First)
      // A. Create School
      await _db.insert('schools', {
        'id': schoolId,
        'name': schoolName,
        'subscription_tier': 'free',
        'max_students': 50,
        'is_suspended': 0,
        'created_at': DateTime.now().toIso8601String(),
      });

      // B. Create User Profile
      await _db.db.execute(
        'INSERT OR REPLACE INTO user_profiles (id, email, full_name, role, school_id, created_at) VALUES (?, ?, ?, ?, ?, ?)',
        [
          user.id,
          email,
          fullName,
          'school_admin',
          schoolId,
          DateTime.now().toIso8601String(),
        ]
      );

    } on AuthException catch (e) {
      throw _getHumanReadableError(e.message);
    } on PostgrestException catch (e) {
      throw _getHumanReadableError(e.message);
    } catch (e) {
      // Check for common connection errors
      if (e.toString().contains('SocketException') || e.toString().contains('Network')) {
        throw 'Connection failed. Please check your internet.';
      }
      throw 'Something went wrong. Please try again.';
    }
  }

  /// TRANSLATOR: Technical -> Human
  String _getHumanReadableError(String technicalMessage) {
    final msg = technicalMessage.toLowerCase();

    if (msg.contains('invalid login credentials')) {
      return 'Incorrect email or password.';
    }
    if (msg.contains('user already registered') || msg.contains('already exists')) {
      return 'An account with this email already exists.';
    }
    if (msg.contains('password should be at least')) {
      return 'Password is too short. It must be at least 6 characters.';
    }
    if (msg.contains('valid email')) {
      return 'Please enter a valid email address.';
    }
    if (msg.contains('network') || msg.contains('connection')) {
      return 'Network error. Please check your connection.';
    }
    
    // Fallback: If it's a server error we don't recognize, imply it's temporary
    return 'A server error occurred. Please try again later.';
  }
}import 'dart:io';
import 'package:flutter/foundation.dart';
import 'package:path/path.dart';
import 'package:path_provider/path_provider.dart';
import 'package:powersync/powersync.dart';
import 'package:supabase_flutter/supabase_flutter.dart';

import 'schema.dart';
import 'supabase_connector.dart';

class DatabaseService {
  static final DatabaseService _instance = DatabaseService._internal();
  factory DatabaseService() => _instance;
  DatabaseService._internal();

  late PowerSyncDatabase _db;
  bool _isInitialized = false;
  late String _dbPath; // Store path locally since PS doesn't expose it

  PowerSyncDatabase get db => _db;

  Future<void> initialize() async {
    if (_isInitialized) return;

    final dir = await getApplicationSupportDirectory();
    _dbPath = join(dir.path, 'greyway_feesup.db');

    _db = PowerSyncDatabase(
      schema: appSchema,
      path: _dbPath,
    );

    await _db.initialize();

    final connector = SupabaseConnector(Supabase.instance.client);
    _db.connect(connector: connector);

    _isInitialized = true;
    if (kDebugMode) {
      print("✅ Database Service Initialized & Connected");
    }
  }

  /// THE NUCLEAR OPTION
  /// Wipes local SQLite and disconnects.
  Future<void> factoryReset() async {
    try {
      await _db.close();
      final file = File(_dbPath);
      if (await file.exists()) {
        await file.delete();
      }
      _isInitialized = false;
      debugPrint("✅ Local database wiped completely.");
    } catch (e) {
      debugPrint("❌ Error during factory reset: $e");
    }
  }

  bool get isConnected => _db.currentStatus.connected;

  Stream<List<Map<String, dynamic>>> watchAll(String table) {
    return _db.watch('SELECT * FROM $table ORDER BY created_at DESC');
  }

  /// Required by Student and Payment Dialogs
  Stream<List<Map<String, dynamic>>> watchStudents(String schoolId) {
    return _db.watch(
      'SELECT * FROM students WHERE school_id = ? ORDER BY full_name ASC',
      parameters: [schoolId],
    );
  }

  Future<Map<String, dynamic>?> getById(String table, String id) async {
    final results = await _db.getAll('SELECT * FROM $table WHERE id = ?', [id]);
    return results.isNotEmpty ? results.first : null;
  }

  Future<Map<String, dynamic>?> tryGet(String sql, [List<Object?>? arguments]) async {
    final results = await _db.getAll(sql, arguments ?? []);
    return results.isNotEmpty ? results.first : null;
  }

  Future<void> insert(String table, Map<String, dynamic> data) async {
    final keys = data.keys.toList();
    final values = data.values.toList();
    final placeholders = List.filled(keys.length, '?').join(', ');
    final columns = keys.join(', ');
    final sql = 'INSERT INTO $table ($columns) VALUES ($placeholders)';
    await _db.execute(sql, values);
  }

  Future<void> update(String table, String id, Map<String, dynamic> data) async {
    if (data.isEmpty) return;
    final updates = <String>[];
    final values = <dynamic>[];
    data.forEach((key, value) {
      updates.add('$key = ?');
      values.add(value);
    });
    values.add(id);
    final sql = 'UPDATE $table SET ${updates.join(', ')} WHERE id = ?';
    await _db.execute(sql, values);
  }

  Future<void> delete(String table, String id) async {
    await _db.execute('DELETE FROM $table WHERE id = ?', [id]);
  }

  Future<Map<String, dynamic>?> getUserProfile(String userId) async {
    return await getById('user_profiles', userId);
  }
}import 'package:flutter/material.dart';
import 'package:powersync/powersync.dart';
import 'package:supabase_flutter/supabase_flutter.dart';

class SupabaseConnector extends PowerSyncBackendConnector {
  final SupabaseClient db;

  SupabaseConnector(this.db);

  @override
  Future<PowerSyncCredentials?> fetchCredentials() async {
    final session = db.auth.currentSession;
    if (session == null) return null;

    const endpoint = String.fromEnvironment('POWERSYNC_ENDPOINT_URL');
    if (endpoint.isEmpty) {
      throw Exception('POWERSYNC_ENDPOINT_URL not set in --dart-define');
    }

    return PowerSyncCredentials(
      endpoint: endpoint,
      token: session.accessToken,
      userId: session.user.id,
    );
  }

  @override
  Future<void> uploadData(PowerSyncDatabase database) async {
    final transaction = await database.getNextCrudTransaction();
    if (transaction == null) return;

    try {
      for (var op in transaction.crud) {
        final table = op.table;
        final id = op.id;
        final data = op.opData;

        // "Create or Update" Logic
        if (op.op == UpdateType.put) {
          // .upsert is the safest bet: it handles both new and existing records.
          // onConflict: 'id' ensures we don't get duplicate key errors.
          await db.from(table).upsert(
            {...data!, 'id': id},
            onConflict: 'id',
            ignoreDuplicates: false,
          );
        } else if (op.op == UpdateType.patch) {
          await db.from(table).update(data!).eq('id', id);
        } else if (op.op == UpdateType.delete) {
          await db.from(table).delete().eq('id', id);
        }
      }
      
      // Clear the queue once finished
      await transaction.complete();
      
    } on PostgrestException catch (e) {
      // 42501 = RLS Violation. 
      // If we don't .complete() here, this one row blocks the WHOLE app sync.
      if (e.code == '42501') {
        debugPrint('❌ RLS Error on $transaction: ${e.message}. Skipping to unblock queue.');
        await transaction.complete(); 
      } else {
        // For network or server 500 errors, we rethrow so PowerSync retries later.
        rethrow;
      }
    } catch (e) {
      debugPrint('Sync Upload Error: $e');
      rethrow;
    }
  }
}import 'package:powersync/powersync.dart';

/// The Local SQLite Schema matching the Supabase Postgres Schema
/// based on the Fees Up Rules.
const Schema appSchema = Schema([
  
  // ============================================================
  // CORE SCHOOL DATA
  // ============================================================
  Table('schools', [
    Column.text('name'),
    Column.text('subscription_tier'),
    Column.integer('max_students'),
    Column.integer('is_suspended'), 
    Column.text('created_at'),
  ]),

  Table('user_profiles', [
    Column.text('email'),
    Column.text('full_name'),
    Column.text('role'),
    Column.text('school_id'),
    Column.integer('is_banned'),
    Column.text('avatar_url'),
    Column.text('created_at'),
  ]),

  Table('notifications', [
    Column.text('user_id'),
    Column.text('school_id'),
    Column.text('title'),
    Column.text('body'),
    Column.text('type'),
    Column.integer('is_read'),
    Column.text('created_at'),
  ]),

  // ============================================================
  // PEOPLE (Students, Teachers, Access)
  // ============================================================
  Table('students', [
    Column.text('school_id'),
    Column.text('student_id'), 
    Column.text('full_name'),
    Column.text('grade'),
    Column.text('parent_contact'),
    Column.text('registration_date'),
    Column.text('billing_type'),
    Column.real('default_fee'),
    Column.integer('is_active'),
    Column.text('admin_uid'),
    Column.real('owed_total'),
    Column.real('paid_total'),
    Column.text('subjects'),
    Column.text('billing_date'),
    Column.text('last_synced_at'),
    Column.text('term_id'),
    Column.text('date_of_birth'),
    Column.text('gender'),
    Column.text('address'),
    Column.text('emergency_contact_name'),
    Column.text('medical_notes'),
    Column.text('enrollment_date'),
    Column.integer('photo_consent'),
    Column.text('updated_at'),
    Column.text('created_at'),
  ]),

  Table('teachers', [
    Column.text('school_id'),
    Column.text('full_name'),
    Column.text('admin_uid'),
    Column.text('created_at'),
    Column.text('updated_at'),
  ]),

  Table('teacher_access_tokens', [
    Column.text('school_id'),
    Column.text('teacher_id'),
    Column.text('granted_by_teacher_id'),
    Column.text('access_code'),
    Column.text('permission_type'),
    Column.integer('is_used'),
    Column.text('used_at'),
    Column.text('expires_at'),
    Column.text('created_at'),
  ]),

  // ============================================================
  // ACADEMICS (Classes, Enrollment, Terms)
  // ============================================================
  Table('classes', [
    Column.text('school_id'),
    Column.text('name'),
    Column.text('teacher_id'),
    Column.text('room_number'),
    Column.text('subject_code'),
    Column.text('admin_uid'),
    Column.text('created_at'),
  ]),

  Table('enrollments', [
    Column.text('school_id'),
    Column.text('student_id'),
    Column.text('class_id'),
    Column.text('enrolled_at'),
    Column.text('created_at'),
  ]),

  Table('school_years', [
    Column.text('school_id'),
    Column.text('year_label'),
    Column.text('start_date'),
    Column.text('end_date'),
    Column.text('description'),
    Column.integer('active'),
    Column.text('created_at'),
  ]),

  Table('school_year_months', [
    Column.text('school_year_id'),
    Column.text('school_id'),
    Column.text('name'),
    Column.integer('month_index'),
    Column.text('start_date'),
    Column.text('end_date'),
    Column.integer('is_billable'),
    Column.text('created_at'),
  ]),

  Table('school_terms', [
    Column.text('school_id'),
    Column.text('name'),
    Column.text('start_date'),
    Column.text('end_date'),
    Column.integer('academic_year'),
    Column.text('created_at'),
  ]),

  // ============================================================
  // ATTENDANCE
  // ============================================================
  Table('attendance', [
    Column.text('school_id'),
    Column.text('student_id'),
    Column.text('class_id'),
    Column.text('date'),
    Column.text('status'),
    Column.text('remarks'),
    Column.text('recorded_by'),
    Column.text('created_at'),
  ]),

  Table('attendance_sessions', [
    Column.text('school_id'),
    Column.text('class_id'),
    Column.text('teacher_id'),
    Column.text('student_admin_id'),
    Column.text('access_token_id'),
    Column.text('session_date'),
    Column.integer('is_confirmed_by_teacher'),
    Column.text('confirmed_at'),
    Column.text('created_at'),
  ]),

  // ============================================================
  // FINANCE (Billing, Payments, Expenses)
  // ============================================================
  Table('billing_configs', [
    Column.text('school_id'),
    Column.text('currency_code'),
    Column.real('late_fee_percentage'),
    Column.text('invoice_footer_note'),
    Column.integer('allow_partial_payments'),
    Column.real('default_fee'),
    Column.text('updated_at'),
  ]),

  Table('bills', [
    Column.text('school_id'),
    Column.text('student_id'),
    Column.text('title'),
    Column.real('total_amount'),
    Column.integer('is_paid'),
    Column.text('bill_type'),
    Column.text('billing_cycle_end'),
    Column.text('billing_cycle_start'),
    Column.real('paid_amount'),
    Column.text('term_id'),
    Column.text('month_year'),
    Column.text('due_date'),
    Column.text('cycle_interval'),
    Column.integer('is_closed'),
    Column.real('credited_amount'),
    Column.text('school_year_id'),
    Column.integer('month_index'),
    Column.text('updated_at'),
    Column.text('created_at'),
  ]),

  Table('bill_items', [
    Column.text('bill_id'),
    Column.text('school_id'),
    Column.text('description'),
    Column.real('amount'),
    Column.integer('quantity'),
    Column.text('created_at'),
  ]),

  Table('payments', [
    Column.text('school_id'),
    Column.text('student_id'),
    Column.real('amount'),
    Column.text('date_paid'),
    Column.text('category'),
    Column.text('payer_name'),
    Column.text('bill_id'),
    Column.text('method'),
    Column.text('admin_uid'),
    Column.text('created_at'),
  ]),

  Table('payment_allocations', [
    Column.text('payment_id'),
    Column.text('bill_id'),
    Column.text('school_id'),
    Column.real('amount'),
    Column.text('created_at'),
  ]),

  Table('credits', [
    Column.text('credit_id'),
    Column.text('school_id'),
    Column.text('student_id'),
    Column.text('bill_id'),
    Column.real('amount'),
    Column.text('reason'),
    Column.text('admin_uid'),
    Column.text('created_at'),
  ]),

  Table('expenses', [
    Column.text('school_id'),
    Column.text('title'),
    Column.real('amount'),
    Column.text('category'),
    Column.text('incurred_at'),
    Column.text('description'),
    Column.text('recipient'),
    Column.text('created_at'),
  ]),

  // ============================================================
  // FUNDRAISER & AUDIT
  // ============================================================
  Table('campaigns', [
    Column.text('school_id'),
    Column.text('class_id'),
    Column.text('created_by_id'),
    Column.text('teacher_id'),
    Column.text('name'),
    Column.text('description'),
    Column.text('campaign_type'),
    Column.text('status'),
    Column.real('goal_amount'),
    Column.text('created_at'),
  ]),

  Table('campaign_donations', [
    Column.text('campaign_id'),
    Column.text('school_id'),
    Column.text('donor_name'),
    Column.real('amount'),
    Column.text('payment_method'),
    Column.text('date_received'),
    Column.text('notes'),
    Column.text('student_id'),
    Column.text('collected_by'),
    Column.text('approved_by'),
    Column.real('expected_cash'),
    Column.real('actual_cash'),
    Column.real('variance'),
    Column.text('updated_at'),
    Column.text('created_at'),
  ]),

  Table('campaign_expenses', [
    Column.text('campaign_id'),
    Column.text('school_id'),
    Column.text('category'),
    Column.real('amount'),
    Column.text('incurred_by'),
    Column.text('approved_by'),
    Column.text('notes'),
    Column.text('created_at'),
  ]),

  Table('campaign_funds', [
    Column.text('campaign_id'),
    Column.text('school_id'),
    Column.text('fund_name'),
    Column.integer('restricted'),
    Column.real('balance'),
    Column.text('updated_at'),
  ]),

  Table('banking_register', [
    Column.text('campaign_id'),
    Column.text('student_id'),
    Column.real('amount'),
    Column.text('direction'), 
    Column.text('recorded_by'),
    Column.text('approved_by'),
    Column.text('reference'),
    Column.text('school_id'),
    Column.text('created_at'),
  ]),

  // ============================================================
  // ARCHIVES
  // ============================================================
  Table('student_archives', [
    Column.text('school_id'),
    Column.text('full_name'),
    Column.text('reason'),
    Column.text('archived_at'),
    Column.text('original_data'),
    Column.text('created_at'),
  ]),
]);import 'dart:async';
import 'package:flutter/material.dart';
import 'package:uuid/uuid.dart';
import 'database_service.dart';
import 'package:supabase_flutter/supabase_flutter.dart';

class SchoolService {
  final DatabaseService _db;
  final _supabase = Supabase.instance.client;

  SchoolService(this._db);

  /// -----------------------------------------------------------------------
  /// REFRESH HELPER (Required by school_provider.dart)
  /// -----------------------------------------------------------------------
  Future<Map<String, dynamic>?> getSchoolForUser(String userId, {bool waitForSync = true}) async {
    Future<Map<String, dynamic>?> fetch() async {
      final profile = await _db.tryGet('SELECT school_id FROM user_profiles WHERE id = ?', [userId]);
      if (profile == null || profile['school_id'] == null) return null;
      
      return await _db.tryGet('SELECT * FROM schools WHERE id = ?', [profile['school_id']]);
    }

    final result = await fetch();
    if (result != null) return result;
    if (!waitForSync) return null;

    for (int i = 0; i < 10; i++) {
      await Future.delayed(const Duration(seconds: 1));
      final retryResult = await fetch();
      if (retryResult != null) return retryResult;
    }
    return null;
  }

  /// -----------------------------------------------------------------------
  /// CREATION HELPER
  /// -----------------------------------------------------------------------
  Future<String?> createSchool({
    required String adminId,
    required String schoolName,
    String tier = 'free',
  }) async {
    final schoolId = const Uuid().v4();
    final now = DateTime.now().toIso8601String();

    try {
      await _db.db.writeTransaction((tx) async {
        await tx.execute('''
          INSERT INTO schools (id, name, subscription_tier, max_students, is_suspended, created_at)
          VALUES (?, ?, ?, ?, ?, ?)
        ''', [schoolId, schoolName, tier, 100, 0, now]);

        await tx.execute('''
          UPDATE user_profiles SET school_id = ?, role = 'admin' WHERE id = ?
        ''', [schoolId, adminId]);

        await tx.execute('''
          INSERT INTO billing_configs (id, school_id, currency_code, late_fee_percentage, updated_at)
          VALUES (?, ?, ?, ?, ?)
        ''', [const Uuid().v4(), schoolId, 'USD', 0.0, now]);
      });

      return schoolId;
    } catch (e) {
      rethrow; 
    }
  }

  Future<void> createSchoolWithDiagnostics(
    BuildContext context, {
    required String adminId,
    required String schoolName,
  }) async {
    try {
      await createSchool(adminId: adminId, schoolName: schoolName);
    } catch (e) {
      try {
        final response = await _supabase.rpc('debug_user_access', params: {
          'target_user_id': adminId,
        });

        final recommendation = response['recommendation'] ?? 'UNKNOWN_ERROR';
        
        if (context.mounted) {
          showProperChannelDialog(context, recommendation);
        }
      } catch (rpcError) {
        throw Exception("System is currently unreachable.");
      }
    }
  }

  /// -----------------------------------------------------------------------
  /// FORCE LOGOUT AND RE-AUTHENTICATE
  /// -----------------------------------------------------------------------
  Future<void> _forceLogoutAndReauth() async {
    await _db.factoryReset(); // Uses the new internal factoryReset
    await _supabase.auth.signOut();
  }

  void showProperChannelDialog(BuildContext context, String recommendation) {
    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (context) => AlertDialog(
        backgroundColor: const Color(0xFF121212),
        title: const Text("System Alignment Required", style: TextStyle(color: Colors.blue)),
        content: Text(
          "Diagnostic Result: $recommendation\n\nTo resolve this, the app must restart your session.",
          style: const TextStyle(color: Colors.white70),
        ),
        actions: [
          TextButton(
            onPressed: () async {
              Navigator.pop(context);
              await _forceLogoutAndReauth();
            },
            child: const Text("RESET & RE-AUTHENTICATE", style: TextStyle(color: Colors.blue)),
          ),
        ],
      ),
    );
  }
}class School {
  final String id;
  final String name;
  final String subscriptionTier; // 'free', 'basic', 'pro'
  final int maxStudents;
  final bool isSuspended;
  final DateTime createdAt;

  School({
    required this.id,
    required this.name,
    this.subscriptionTier = 'free',
    this.maxStudents = 50,
    this.isSuspended = false,
    required this.createdAt,
  });

  factory School.fromRow(Map<String, dynamic> row) {
    return School(
      id: row['id'] as String,
      name: row['name'] as String,
      subscriptionTier: row['subscription_tier'] ?? 'free',
      maxStudents: (row['max_students'] as num?)?.toInt() ?? 50,
      isSuspended: (row['is_suspended'] == 1),
      createdAt: DateTime.parse(row['created_at']),
    );
  }
}

class UserProfile {
  final String id;
  final String email;
  final String fullName;
  final String role; // 'super_admin', 'school_admin', 'teacher', 'student'
  final String? schoolId;
  final bool isBanned;
  final String? avatarUrl;

  UserProfile({
    required this.id,
    required this.email,
    required this.fullName,
    this.role = 'teacher',
    this.schoolId,
    this.isBanned = false,
    this.avatarUrl,
  });

  factory UserProfile.fromRow(Map<String, dynamic> row) {
    return UserProfile(
      id: row['id'] as String,
      email: row['email'] as String,
      fullName: row['full_name'] as String,
      role: row['role'] ?? 'teacher',
      schoolId: row['school_id'] as String?,
      isBanned: (row['is_banned'] == 1),
      avatarUrl: row['avatar_url'] as String?,
    );
  }
}

class BillingConfig {
  final String id;
  final String? schoolId;
  final String currencyCode;
  final double lateFeePercentage;
  final String? invoiceFooterNote;
  final bool allowPartialPayments;
  final double defaultFee;

  BillingConfig({
    required this.id,
    this.schoolId,
    this.currencyCode = 'USD',
    this.lateFeePercentage = 0.0,
    this.invoiceFooterNote,
    this.allowPartialPayments = true,
    this.defaultFee = 100.00,
  });

  factory BillingConfig.fromRow(Map<String, dynamic> row) {
    return BillingConfig(
      id: row['id'] as String,
      schoolId: row['school_id'] as String?,
      currencyCode: row['currency_code'] ?? 'USD',
      lateFeePercentage: (row['late_fee_percentage'] as num?)?.toDouble() ?? 0.0,
      invoiceFooterNote: row['invoice_footer_note'] as String?,
      allowPartialPayments: (row['allow_partial_payments'] == 1),
      defaultFee: (row['default_fee'] as num?)?.toDouble() ?? 100.00,
    );
  }
}

class NotificationModel {
  final String id;
  final String userId;
  final String? schoolId;
  final String title;
  final String body;
  final String type; // 'info', 'warning', etc.
  final bool isRead;
  final DateTime createdAt;

  NotificationModel({
    required this.id,
    required this.userId,
    this.schoolId,
    required this.title,
    required this.body,
    this.type = 'info',
    this.isRead = false,
    required this.createdAt,
  });

  factory NotificationModel.fromRow(Map<String, dynamic> row) {
    return NotificationModel(
      id: row['id'] as String,
      userId: row['user_id'] as String,
      schoolId: row['school_id'] as String?,
      title: row['title'] as String,
      body: row['body'] as String,
      type: row['type'] ?? 'info',
      isRead: (row['is_read'] == 1),
      createdAt: DateTime.parse(row['created_at']),
    );
  }
}class ClassModel {
  final String id;
  final String schoolId;
  final String name;
  final String? teacherId;
  final String? roomNumber;
  final String? subjectCode;

  ClassModel({
    required this.id,
    required this.schoolId,
    required this.name,
    this.teacherId,
    this.roomNumber,
    this.subjectCode,
  });

  factory ClassModel.fromRow(Map<String, dynamic> row) {
    return ClassModel(
      id: row['id'] as String,
      schoolId: row['school_id'] as String,
      name: row['name'] as String,
      teacherId: row['teacher_id'] as String?,
      roomNumber: row['room_number'] as String?,
      subjectCode: row['subject_code'] as String?,
    );
  }
}

class Enrollment {
  final String id;
  final String schoolId;
  final String studentId;
  final String classId;
  final DateTime enrolledAt;

  Enrollment({
    required this.id,
    required this.schoolId,
    required this.studentId,
    required this.classId,
    required this.enrolledAt,
  });

  factory Enrollment.fromRow(Map<String, dynamic> row) {
    return Enrollment(
      id: row['id'] as String,
      schoolId: row['school_id'] as String,
      studentId: row['student_id'] as String,
      classId: row['class_id'] as String,
      enrolledAt: DateTime.tryParse(row['enrolled_at'] ?? '') ?? DateTime.now(),
    );
  }
}

class SchoolYear {
  final String id;
  final String schoolId;
  final String yearLabel; // e.g., "2025"
  final DateTime startDate;
  final DateTime endDate;
  final bool active;

  SchoolYear({
    required this.id,
    required this.schoolId,
    required this.yearLabel,
    required this.startDate,
    required this.endDate,
    this.active = false,
  });

  factory SchoolYear.fromRow(Map<String, dynamic> row) {
    return SchoolYear(
      id: row['id'] as String,
      schoolId: row['school_id'] as String,
      yearLabel: row['year_label'] as String,
      startDate: DateTime.parse(row['start_date']),
      endDate: DateTime.parse(row['end_date']),
      active: (row['active'] == 1),
    );
  }
}

class SchoolYearMonth {
  final String id;
  final String schoolYearId;
  final String name; // "January"
  final int monthIndex; // 1
  final DateTime startDate;
  final DateTime endDate;
  final bool isBillable;

  SchoolYearMonth({
    required this.id,
    required this.schoolYearId,
    required this.name,
    required this.monthIndex,
    required this.startDate,
    required this.endDate,
    this.isBillable = true,
  });

  factory SchoolYearMonth.fromRow(Map<String, dynamic> row) {
    return SchoolYearMonth(
      id: row['id'] as String,
      schoolYearId: row['school_year_id'] as String,
      name: row['name'] as String,
      monthIndex: (row['month_index'] as num).toInt(),
      startDate: DateTime.parse(row['start_date']),
      endDate: DateTime.parse(row['end_date']),
      isBillable: (row['is_billable'] == 1),
    );
  }
}

class SchoolTerm {
  final String id;
  final String schoolId;
  final String name; // "Term 1"
  final DateTime startDate;
  final DateTime endDate;
  final int academicYear;

  SchoolTerm({
    required this.id,
    required this.schoolId,
    required this.name,
    required this.startDate,
    required this.endDate,
    required this.academicYear,
  });

  factory SchoolTerm.fromRow(Map<String, dynamic> row) {
    return SchoolTerm(
      id: row['id'] as String,
      schoolId: row['school_id'] as String,
      name: row['name'] as String,
      startDate: DateTime.parse(row['start_date']),
      endDate: DateTime.parse(row['end_date']),
      academicYear: (row['academic_year'] as num).toInt(),
    );
  }
}class Attendance {
  final String id;
  final String schoolId;
  final String studentId;
  final String? classId;
  final DateTime date;
  final String status; // 'present', 'absent', 'late', 'excused'
  final String? remarks;
  final String? recordedBy;

  Attendance({
    required this.id,
    required this.schoolId,
    required this.studentId,
    this.classId,
    required this.date,
    this.status = 'present',
    this.remarks,
    this.recordedBy,
  });

  factory Attendance.fromRow(Map<String, dynamic> row) {
    return Attendance(
      id: row['id'] as String,
      schoolId: row['school_id'] as String,
      studentId: row['student_id'] as String,
      classId: row['class_id'] as String?,
      date: DateTime.parse(row['date']),
      status: row['status'] ?? 'present',
      remarks: row['remarks'] as String?,
      recordedBy: row['recorded_by'] as String?,
    );
  }
}

class AttendanceSession {
  final String id;
  final String schoolId;
  final String classId;
  final String teacherId;
  final DateTime sessionDate;
  final bool isConfirmedByTeacher;
  final DateTime? confirmedAt;

  AttendanceSession({
    required this.id,
    required this.schoolId,
    required this.classId,
    required this.teacherId,
    required this.sessionDate,
    this.isConfirmedByTeacher = false,
    this.confirmedAt,
  });

  factory AttendanceSession.fromRow(Map<String, dynamic> row) {
    return AttendanceSession(
      id: row['id'] as String,
      schoolId: row['school_id'] as String,
      classId: row['class_id'] as String,
      teacherId: row['teacher_id'] as String,
      sessionDate: DateTime.parse(row['session_date']),
      isConfirmedByTeacher: (row['is_confirmed_by_teacher'] == 1),
      confirmedAt: row['confirmed_at'] != null 
          ? DateTime.tryParse(row['confirmed_at']) 
          : null,
    );
  }
}// ==========================================
// BILL MODEL
// ==========================================
class Bill {
  final String id;
  final String schoolId;
  final String studentId;
  final String title;
  final double totalAmount;
  final double paidAmount;
  final bool isPaid;
  final DateTime? dueDate;
  final String billType; // 'monthly', 'adhoc'
  final bool isClosed;
  final String? termId;

  Bill({
    required this.id,
    required this.schoolId,
    required this.studentId,
    required this.title,
    required this.totalAmount,
    this.paidAmount = 0.0,
    this.isPaid = false,
    this.dueDate,
    this.billType = 'monthly',
    this.isClosed = false,
    this.termId,
  });

  factory Bill.fromRow(Map<String, dynamic> row) {
    return Bill(
      id: row['id'] as String,
      schoolId: row['school_id'] as String,
      studentId: row['student_id'] as String,
      title: row['title'] as String,
      totalAmount: (row['total_amount'] as num?)?.toDouble() ?? 0.0,
      paidAmount: (row['paid_amount'] as num?)?.toDouble() ?? 0.0,
      isPaid: (row['is_paid'] == 1),
      dueDate: row['due_date'] != null ? DateTime.tryParse(row['due_date']) : null,
      billType: row['bill_type'] ?? 'monthly',
      isClosed: (row['is_closed'] == 1),
      termId: row['term_id'] as String?,
    );
  }

  Map<String, dynamic> toMap() {
    return {
      'id': id,
      'school_id': schoolId,
      'student_id': studentId,
      'title': title,
      'total_amount': totalAmount,
      'paid_amount': paidAmount,
      'is_paid': isPaid ? 1 : 0,
      'due_date': dueDate?.toIso8601String(),
      'bill_type': billType,
      'is_closed': isClosed ? 1 : 0,
      'term_id': termId,
    };
  }
}

// ==========================================
// PAYMENT MODEL
// ==========================================
class Payment {
  final String id;
  final String schoolId;
  final String studentId;
  final double amount;
  final DateTime datePaid;
  final String method; // 'cash', 'ecocash', etc.
  final String? payerName;
  final String? billId;

  Payment({
    required this.id,
    required this.schoolId,
    required this.studentId,
    required this.amount,
    required this.datePaid,
    this.method = 'cash',
    this.payerName,
    this.billId,
  });

  factory Payment.fromRow(Map<String, dynamic> row) {
    return Payment(
      id: row['id'] as String,
      schoolId: row['school_id'] as String,
      studentId: row['student_id'] as String,
      amount: (row['amount'] as num?)?.toDouble() ?? 0.0,
      datePaid: row['date_paid'] != null 
          ? DateTime.tryParse(row['date_paid']) ?? DateTime.now()
          : DateTime.now(),
      method: row['method'] ?? 'cash',
      payerName: row['payer_name'] as String?,
      billId: row['bill_id'] as String?,
    );
  }

  Map<String, dynamic> toMap() {
    return {
      'id': id,
      'school_id': schoolId,
      'student_id': studentId,
      'amount': amount,
      'date_paid': datePaid.toIso8601String(),
      'method': method,
      'payer_name': payerName,
      'bill_id': billId,
    };
  }
}// File: lib/models/subjects.dart

class ZimsecSubject {
  static const Map<int, String> _codeMap = {
    // --- FORM 1 - 4 (O-LEVEL) CORE ---
    // These are the "Must-Haves" for almost every student.
    4005: 'English Language',
    4004: 'Mathematics',
    4003: 'Combined Science', // Replaces Integrated Science
    4006: 'Heritage Studies',
    4007: 'Shona',
    4068: 'Ndebele',
    4001: 'Agriculture',

    // --- FORM 1 - 4 (O-LEVEL) POPULAR ELECTIVES ---
    // Commercials & Arts
    4049: 'Commerce',
    4037: 'Geography',
    4044: 'History',
    4047: 'Family & Religious Studies', // F.R.S (formerly Divinity/R.E)
    4048: 'Business Enterprise Skills',
    4051: 'Principles of Accounting',

    // Sciences & Tech
    4029: 'Computer Science',
    4025: 'Biology',
    4023: 'Physics',
    4024:
        'Chemistry', // Often listed as 5070/5071 in older systems, but 4024 in new curriculum maps
    4059: 'Wood Technology and Design',

    // --- FORM 5 - 6 (A-LEVEL) ---
    // Commercials
    6001: 'Accounting (A-Level)',
    6025: 'Business Studies',
    6073: 'Economics',

    // Arts / Humanities
    6022: 'Geography (A-Level)',
    6006: 'History (A-Level)',
    6003: 'Divinity',
    6009: 'Literature in English',
    6081: 'Heritage Studies (A-Level)',

    // Sciences
    6042: 'Pure Mathematics',
    6030: 'Biology (A-Level)',
    6031: 'Chemistry (A-Level)',
    6032: 'Physics (A-Level)',
    6046: 'Statistics',
    6008: 'Computer Science (A-Level)',
  };

  // This is the getter your Registration Page is looking for:
  static List<String> get allNames => _codeMap.values.toList();

  static String nameFromCode(int code) => _codeMap[code] ?? 'Unknown';
}

class EnrolledSubject {
  final String subjectName;
  final String studentId;

  EnrolledSubject({required this.subjectName, required this.studentId});

  Map<String, dynamic> toJson() => {
    'subjectName': subjectName,
    'studentId': studentId,
  };

  factory EnrolledSubject.fromJson(Map<String, dynamic> json) {
    return EnrolledSubject(
      subjectName: json['subjectName'],
      studentId: json['studentId'],
    );
  }
}class Student {
  final String id;
  final String schoolId;
  final String fullName;
  final String? studentId; // Manual ID (e.g., "STD-001")
  final String? grade;
  final String? parentContact;
  final DateTime? registrationDate;
  final String billingType; // 'monthly', 'termly'
  final double defaultFee;
  final bool isActive;
  final double owedTotal;
  final double paidTotal;
  final String? termId;
  final DateTime? dateOfBirth;
  final String? gender;
  final String? address;
  final String? emergencyContactName;
  final String? medicalNotes;
  final bool photoConsent;

  Student({
    required this.id,
    required this.schoolId,
    required this.fullName,
    this.studentId,
    this.grade,
    this.parentContact,
    this.registrationDate,
    this.billingType = 'monthly',
    this.defaultFee = 0.0,
    this.isActive = true,
    this.owedTotal = 0.0,
    this.paidTotal = 0.0,
    this.termId,
    this.dateOfBirth,
    this.gender,
    this.address,
    this.emergencyContactName,
    this.medicalNotes,
    this.photoConsent = false,
  });

  // Factory to create a Student from a PowerSync/SQLite Row
  factory Student.fromRow(Map<String, dynamic> row) {
    return Student(
      id: row['id'] as String,
      schoolId: row['school_id'] as String,
      fullName: row['full_name'] as String,
      studentId: row['student_id'] as String?,
      grade: row['grade'] as String?,
      parentContact: row['parent_contact'] as String?,
      registrationDate: row['registration_date'] != null 
          ? DateTime.tryParse(row['registration_date']) 
          : null,
      billingType: row['billing_type'] ?? 'monthly',
      defaultFee: (row['default_fee'] as num?)?.toDouble() ?? 0.0,
      isActive: (row['is_active'] == 1), // SQLite stores bools as 0/1
      owedTotal: (row['owed_total'] as num?)?.toDouble() ?? 0.0,
      paidTotal: (row['paid_total'] as num?)?.toDouble() ?? 0.0,
      termId: row['term_id'] as String?,
      dateOfBirth: row['date_of_birth'] != null 
          ? DateTime.tryParse(row['date_of_birth']) 
          : null,
      gender: row['gender'] as String?,
      address: row['address'] as String?,
      emergencyContactName: row['emergency_contact_name'] as String?,
      medicalNotes: row['medical_notes'] as String?,
      photoConsent: (row['photo_consent'] == 1),
    );
  }

  // Convert to Map for saving to Database
  Map<String, dynamic> toMap() {
    return {
      'id': id,
      'school_id': schoolId,
      'full_name': fullName,
      'student_id': studentId,
      'grade': grade,
      'parent_contact': parentContact,
      'registration_date': registrationDate?.toIso8601String(),
      'billing_type': billingType,
      'default_fee': defaultFee,
      'is_active': isActive ? 1 : 0,
      'owed_total': owedTotal,
      'paid_total': paidTotal,
      'term_id': termId,
      'date_of_birth': dateOfBirth?.toIso8601String(),
      'gender': gender,
      'address': address,
      'emergency_contact_name': emergencyContactName,
      'medical_notes': medicalNotes,
      'photo_consent': photoConsent ? 1 : 0,
    };
  }
}class Campaign {
  final String id;
  final String schoolId;
  final String createdById;
  final String name;
  final String? description;
  final String? status; // 'active'
  final double goalAmount;

  Campaign({
    required this.id,
    required this.schoolId,
    required this.createdById,
    required this.name,
    this.description,
    this.status = 'active',
    this.goalAmount = 0.0,
  });

  factory Campaign.fromRow(Map<String, dynamic> row) {
    return Campaign(
      id: row['id'] as String,
      schoolId: row['school_id'] as String,
      createdById: row['created_by_id'] as String,
      name: row['name'] as String,
      description: row['description'] as String?,
      status: row['status'] ?? 'active',
      goalAmount: (row['goal_amount'] as num?)?.toDouble() ?? 0.0,
    );
  }
}

class CampaignDonation {
  final String id;
  final String campaignId;
  final String? donorName;
  final double amount;
  final String? paymentMethod;
  final DateTime dateReceived;
  final double expectedCash;
  final double actualCash;
  final double variance;

  CampaignDonation({
    required this.id,
    required this.campaignId,
    this.donorName,
    this.amount = 0.0,
    this.paymentMethod,
    required this.dateReceived,
    this.expectedCash = 0.0,
    this.actualCash = 0.0,
    this.variance = 0.0,
  });

  factory CampaignDonation.fromRow(Map<String, dynamic> row) {
    return CampaignDonation(
      id: row['id'] as String,
      campaignId: row['campaign_id'] as String,
      donorName: row['donor_name'] as String?,
      amount: (row['amount'] as num?)?.toDouble() ?? 0.0,
      paymentMethod: row['payment_method'] as String?,
      dateReceived: DateTime.tryParse(row['date_received'] ?? '') ?? DateTime.now(),
      expectedCash: (row['expected_cash'] as num?)?.toDouble() ?? 0.0,
      actualCash: (row['actual_cash'] as num?)?.toDouble() ?? 0.0,
      variance: (row['variance'] as num?)?.toDouble() ?? 0.0,
    );
  }
}

class CampaignExpense {
  final String id;
  final String campaignId;
  final String? category;
  final double amount;
  final String? incurredBy;

  CampaignExpense({
    required this.id,
    required this.campaignId,
    this.category,
    required this.amount,
    this.incurredBy,
  });

  factory CampaignExpense.fromRow(Map<String, dynamic> row) {
    return CampaignExpense(
      id: row['id'] as String,
      campaignId: row['campaign_id'] as String,
      category: row['category'] as String?,
      amount: (row['amount'] as num?)?.toDouble() ?? 0.0,
      incurredBy: row['incurred_by'] as String?,
    );
  }
}

class BankingRegister {
  final String id;
  final String? campaignId;
  final double amount;
  final String direction; // 'in' or 'out'
  final String? reference;
  final String schoolId;

  BankingRegister({
    required this.id,
    this.campaignId,
    required this.amount,
    required this.direction,
    this.reference,
    required this.schoolId,
  });

  factory BankingRegister.fromRow(Map<String, dynamic> row) {
    return BankingRegister(
      id: row['id'] as String,
      campaignId: row['campaign_id'] as String?,
      amount: (row['amount'] as num?)?.toDouble() ?? 0.0,
      direction: row['direction'] as String,
      reference: row['reference'] as String?,
      schoolId: row['school_id'] as String,
    );
  }
}// ==========================================
// TEACHER MODEL
// ==========================================
class Teacher {
  final String id;
  final String schoolId;
  final String fullName;
  final String? adminUid; // Links to user_profiles if they have logged in
  final DateTime createdAt;

  Teacher({
    required this.id,
    required this.schoolId,
    required this.fullName,
    this.adminUid,
    required this.createdAt,
  });

  factory Teacher.fromRow(Map<String, dynamic> row) {
    return Teacher(
      id: row['id'] as String,
      schoolId: row['school_id'] as String,
      fullName: row['full_name'] as String,
      adminUid: row['admin_uid'] as String?,
      createdAt: row['created_at'] != null 
          ? DateTime.tryParse(row['created_at']) ?? DateTime.now() 
          : DateTime.now(),
    );
  }

  Map<String, dynamic> toMap() {
    return {
      'id': id,
      'school_id': schoolId,
      'full_name': fullName,
      'admin_uid': adminUid,
      'created_at': createdAt.toIso8601String(),
    };
  }
}

// ==========================================
// TEACHER ACCESS TOKEN MODEL
// ==========================================
class TeacherAccessToken {
  final String id;
  final String schoolId;
  final String teacherId;
  final String grantedByTeacherId;
  final String accessCode;
  final String permissionType; // 'attendance', 'campaigns', 'both'
  final bool isUsed;
  final DateTime? usedAt;
  final DateTime expiresAt;

  TeacherAccessToken({
    required this.id,
    required this.schoolId,
    required this.teacherId,
    required this.grantedByTeacherId,
    required this.accessCode,
    required this.permissionType,
    this.isUsed = false,
    this.usedAt,
    required this.expiresAt,
  });

  bool get isExpired => DateTime.now().isAfter(expiresAt);

  factory TeacherAccessToken.fromRow(Map<String, dynamic> row) {
    return TeacherAccessToken(
      id: row['id'] as String,
      schoolId: row['school_id'] as String,
      teacherId: row['teacher_id'] as String,
      grantedByTeacherId: row['granted_by_teacher_id'] as String,
      accessCode: row['access_code'] as String,
      permissionType: row['permission_type'] ?? 'attendance',
      isUsed: (row['is_used'] == 1), // SQLite boolean handling
      usedAt: row['used_at'] != null 
          ? DateTime.tryParse(row['used_at']) 
          : null,
      expiresAt: row['expires_at'] != null 
          ? DateTime.tryParse(row['expires_at']) ?? DateTime.now()
          : DateTime.now(),
    );
  }

  Map<String, dynamic> toMap() {
    return {
      'id': id,
      'school_id': schoolId,
      'teacher_id': teacherId,
      'granted_by_teacher_id': grantedByTeacherId,
      'access_code': accessCode,
      'permission_type': permissionType,
      'is_used': isUsed ? 1 : 0,
      'used_at': usedAt?.toIso8601String(),
      'expires_at': expiresAt.toIso8601String(),
    };
  }
}// ==========================================
// BILL ITEM MODEL (Line items inside a bill)
// ==========================================
class BillItem {
  final String id;
  final String billId;
  final String schoolId;
  final String description;
  final double amount;
  final int quantity;

  BillItem({
    required this.id,
    required this.billId,
    required this.schoolId,
    required this.description,
    required this.amount,
    this.quantity = 1,
  });

  // Calculate total for this line item
  double get total => amount * quantity;

  factory BillItem.fromRow(Map<String, dynamic> row) {
    return BillItem(
      id: row['id'] as String,
      billId: row['bill_id'] as String,
      schoolId: row['school_id'] as String,
      description: row['description'] as String,
      amount: (row['amount'] as num?)?.toDouble() ?? 0.0,
      quantity: (row['quantity'] as num?)?.toInt() ?? 1,
    );
  }

  Map<String, dynamic> toMap() {
    return {
      'id': id,
      'bill_id': billId,
      'school_id': schoolId,
      'description': description,
      'amount': amount,
      'quantity': quantity,
    };
  }
}

// ==========================================
// PAYMENT ALLOCATION MODEL (Splitting one payment across bills)
// ==========================================
class PaymentAllocation {
  final String id;
  final String paymentId;
  final String billId;
  final String schoolId;
  final double amount;

  PaymentAllocation({
    required this.id,
    required this.paymentId,
    required this.billId,
    required this.schoolId,
    required this.amount,
  });

  factory PaymentAllocation.fromRow(Map<String, dynamic> row) {
    return PaymentAllocation(
      id: row['id'] as String,
      paymentId: row['payment_id'] as String,
      billId: row['bill_id'] as String,
      schoolId: row['school_id'] as String,
      amount: (row['amount'] as num?)?.toDouble() ?? 0.0,
    );
  }

  Map<String, dynamic> toMap() {
    return {
      'id': id,
      'payment_id': paymentId,
      'bill_id': billId,
      'school_id': schoolId,
      'amount': amount,
    };
  }
}

// ==========================================
// CREDIT MODEL (Discounts or overpayments)
// ==========================================
class Credit {
  final String id;
  final String schoolId;
  final String studentId;
  final String? billId; // If applied to a specific bill
  final double amount;
  final String? reason;
  final String? creditId; // Manual reference ID

  Credit({
    required this.id,
    required this.schoolId,
    required this.studentId,
    required this.amount,
    this.billId,
    this.reason,
    this.creditId,
  });

  factory Credit.fromRow(Map<String, dynamic> row) {
    return Credit(
      id: row['id'] as String,
      schoolId: row['school_id'] as String,
      studentId: row['student_id'] as String,
      amount: (row['amount'] as num?)?.toDouble() ?? 0.0,
      billId: row['bill_id'] as String?,
      reason: row['reason'] as String?,
      creditId: row['credit_id'] as String?,
    );
  }

  Map<String, dynamic> toMap() {
    return {
      'id': id,
      'school_id': schoolId,
      'student_id': studentId,
      'amount': amount,
      'bill_id': billId,
      'reason': reason,
      'credit_id': creditId,
    };
  }
}import 'dart:convert'; // Required for JSON decoding

class StudentArchive {
  final String id;
  final String schoolId;
  final String? fullName;
  final String? reason;
  final DateTime archivedAt;
  final Map<String, dynamic>? originalData; // Stored as JSONB in SQL

  StudentArchive({
    required this.id,
    required this.schoolId,
    this.fullName,
    this.reason,
    required this.archivedAt,
    this.originalData,
  });

  factory StudentArchive.fromRow(Map<String, dynamic> row) {
    return StudentArchive(
      id: row['id'] as String,
      schoolId: row['school_id'] as String,
      fullName: row['full_name'] as String?,
      reason: row['reason'] as String?,
      archivedAt: DateTime.tryParse(row['archived_at'] ?? '') ?? DateTime.now(),
      // Handle potential JSON string from SQLite
      originalData: row['original_data'] != null
          ? (row['original_data'] is String 
              ? jsonDecode(row['original_data']) 
              : row['original_data'])
          : null,
    );
  }
}

class Expense {
  final String id;
  final String schoolId;
  final String title;
  final double amount;
  final String? category;
  final DateTime incurredAt;
  final String? recipient;

  Expense({
    required this.id,
    required this.schoolId,
    required this.title,
    required this.amount,
    this.category,
    required this.incurredAt,
    this.recipient,
  });

  factory Expense.fromRow(Map<String, dynamic> row) {
    return Expense(
      id: row['id'] as String,
      schoolId: row['school_id'] as String,
      title: row['title'] as String,
      amount: (row['amount'] as num?)?.toDouble() ?? 0.0,
      category: row['category'] as String?,
      incurredAt: DateTime.tryParse(row['incurred_at'] ?? '') ?? DateTime.now(),
      recipient: row['recipient'] as String?,
    );
  }
}import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../repositories/dashboard_repository.dart';
import '../services/database_service.dart';
import 'auth_provider.dart';
import 'school_provider.dart'; // ✅ Imported

final dashboardRepositoryProvider = Provider<DashboardRepository>((ref) {
  return DashboardRepository(DatabaseService());
});

// A simple class to hold our dashboard data snapshot
class DashboardData {
  final String schoolId;
  final String schoolName;
  final String userName;
  final int studentCount;
  final double outstandingBalance;
  final List<Map<String, dynamic>> recentPayments;

  DashboardData({
    required this.schoolId,
    required this.schoolName,
    required this.userName,
    required this.studentCount,
    required this.outstandingBalance,
    required this.recentPayments,
  });
}
final dashboardDataProvider = StreamProvider<DashboardData>((ref) async* {
  final user = ref.watch(currentUserProvider);
  if (user == null) throw 'User not logged in';

  // 1. Get the school data (caches after first successful fetch)
  final school = await ref.watch(currentSchoolProvider.future);
  
  if (school == null) {
    yield DashboardData(
      schoolId: '',
      schoolName: 'Loading...',
      userName: '',
      studentCount: 0,
      outstandingBalance: 0,
      recentPayments: [],
    );
    return;
  }

  final schoolId = school['id'];
  final schoolName = school['name'];
  final dbService = DatabaseService();

  // 2. Listen for ANY changes in the relevant tables
  // This keeps the Batch Tech dashboard live and reactive
  await for (final _ in dbService.db.onChange(['students', 'bills', 'payments', 'user_profiles'])) {
    
    // Fetch profile and stats in parallel for better performance
    final results = await Future.wait([
      dbService.getUserProfile(user.id),
      dbService.db.get('SELECT count(*) as c FROM students WHERE school_id = ?', [schoolId]),
      dbService.db.get('SELECT sum(total_amount - paid_amount) as t FROM bills WHERE school_id = ?', [schoolId]),
      dbService.db.getAll('SELECT * FROM payments WHERE school_id = ? ORDER BY date_paid DESC LIMIT 5', [schoolId]),
    ]);

    final profile = results[0] as Map<String, dynamic>?;
    final students = results[1] as Map<String, dynamic>;
    final bills = results[2] as Map<String, dynamic>;
    final payments = results[3] as List<Map<String, dynamic>>;

    yield DashboardData(
      schoolId: schoolId,
      schoolName: schoolName,
      userName: profile?['full_name'] ?? 'Admin',
      studentCount: (students['c'] as int),
      outstandingBalance: (bills['t'] as num?)?.toDouble() ?? 0.0,
      recentPayments: payments,
    );
  }
});import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../services/database_service.dart';
import 'dashboard_provider.dart';

class FundraisingData {
  final String campaignName;
  final double goalAmount;
  final double raisedAmount;
  final double percentage;

  FundraisingData({
    required this.campaignName,
    required this.goalAmount,
    required this.raisedAmount,
    required this.percentage,
  });
}

final fundraisingProvider = FutureProvider<FundraisingData?>((ref) async {
  final dashboardData = await ref.watch(dashboardDataProvider.future);
  final schoolId = dashboardData.schoolId;
  final db = DatabaseService().db;

  // 1. Get the ACTIVE campaign for this school
  // We explicitly look for status = 'active'
  final campaigns = await db.getAll(
    "SELECT * FROM campaigns WHERE school_id = ? AND status = 'active' ORDER BY created_at DESC LIMIT 1",
    [schoolId],
  );

  if (campaigns.isEmpty) return null; // No active campaign found

  final campaign = campaigns.first;
  final campaignId = campaign['id'];
  final goal = (campaign['goal_amount'] as num?)?.toDouble() ?? 100.0; 
  final name = campaign['name'] ?? 'Campaign';

  // 2. Sum donations for this specific campaign ID
  final donations = await db.getAll(
    "SELECT sum(amount) as total FROM campaign_donations WHERE campaign_id = ?",
    [campaignId],
  );

  final raised = (donations.first['total'] as num?)?.toDouble() ?? 0.0;

  // 3. Calculate Percentage (Safe division)
  double percent = 0.0;
  if (goal > 0) {
    percent = (raised / goal) * 100;
  }
  
  // Cap percentage visual at 100% (optional, but looks better on progress bars)
  // For the text value, we keep the real percentage.
  
  return FundraisingData(
    campaignName: name,
    goalAmount: goal,
    raisedAmount: raised,
    percentage: percent,
  );
});import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:intl/intl.dart';
import '../services/database_service.dart';
import 'dashboard_provider.dart';

// --- FILTER ENUM ---
enum RevenueFilter { thisWeek, lastWeek }

final revenueFilterProvider = StateProvider<RevenueFilter>((ref) => RevenueFilter.thisWeek);

class WeeklyRevenueData {
  final double totalWeekRevenue;
  final Map<int, double> dailyTotals; // Key: Weekday (1=Mon ... 7=Sun)

  WeeklyRevenueData({required this.totalWeekRevenue, required this.dailyTotals});
}

final weeklyRevenueProvider = FutureProvider<WeeklyRevenueData>((ref) async {
  final dashboardData = await ref.watch(dashboardDataProvider.future);
  final schoolId = dashboardData.schoolId;
  final filter = ref.watch(revenueFilterProvider);

  // 1. Calculate Date Range
  final now = DateTime.now();
  final currentWeekStart = now.subtract(Duration(days: now.weekday - 1)); // This Monday
  
  DateTime startOfWeek;
  DateTime endOfWeek;

  if (filter == RevenueFilter.thisWeek) {
    startOfWeek = DateTime(currentWeekStart.year, currentWeekStart.month, currentWeekStart.day);
    endOfWeek = startOfWeek.add(const Duration(days: 6, hours: 23, minutes: 59));
  } else {
    // Last Week
    startOfWeek = currentWeekStart.subtract(const Duration(days: 7));
    endOfWeek = startOfWeek.add(const Duration(days: 6, hours: 23, minutes: 59));
  }

  final startStr = DateFormat('yyyy-MM-dd').format(startOfWeek);
  final endStr = DateFormat('yyyy-MM-dd').format(endOfWeek);

  // 2. Query Database
  final db = DatabaseService().db;
  final results = await db.getAll(
    'SELECT amount, date_paid FROM payments WHERE school_id = ? AND date_paid >= ? AND date_paid <= ?',
    [schoolId, startStr, endStr],
  );

  // 3. Group by Day
  double total = 0.0;
  final Map<int, double> dailyMap = {1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0};

  for (var row in results) {
    final amount = (row['amount'] as num).toDouble();
    final dateStr = row['date_paid'] as String;
    final date = DateTime.parse(dateStr);
    
    // Ensure we map correctly even if the date parsing varies slightly
    dailyMap[date.weekday] = (dailyMap[date.weekday] ?? 0) + amount;
    total += amount;
  }

  return WeeklyRevenueData(totalWeekRevenue: total, dailyTotals: dailyMap);
});import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:supabase_flutter/supabase_flutter.dart';
import '../repositories/auth_repository.dart';

// 1. The Repository Provider (This is what was missing)
final authRepositoryProvider = Provider<AuthRepository>((ref) {
  return AuthRepository();
});

// 2. Auth State Stream (Listens to Login/Logout events)
final authStateProvider = StreamProvider<AuthState>((ref) {
  final repo = ref.watch(authRepositoryProvider);
  return repo.authStateChanges;
});

// 3. Current User Helper
final currentUserProvider = Provider<User?>((ref) {
  final authState = ref.watch(authStateProvider);
  return authState.value?.session?.user;
});import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../services/database_service.dart';
import '../services/school_service.dart';
import 'auth_provider.dart';

// The Service Provider
final schoolServiceProvider = Provider<SchoolService>((ref) {
  return SchoolService(DatabaseService());
});

// A Helper Provider to get the current school immediately
final currentSchoolProvider = FutureProvider<Map<String, dynamic>?>((ref) async {
  final user = ref.watch(currentUserProvider);
  if (user == null) return null;

  final service = ref.watch(schoolServiceProvider);
  // We enable waitForSync to prevent "Bad State" errors on login
  return await service.getSchoolForUser(user.id, waitForSync: true);
});import 'package:flutter/material.dart';
import 'package:supabase_flutter/supabase_flutter.dart';
import 'package:go_router/go_router.dart';

class LogoutDialog extends StatefulWidget {
  const LogoutDialog({super.key});

  @override
  State<LogoutDialog> createState() => _LogoutDialogState();
}

class _LogoutDialogState extends State<LogoutDialog> {
  bool _isLoading = false;

  Future<void> _handleLogout() async {
    setState(() => _isLoading = true);
    try {
      // 1. Sign out from Supabase
      await Supabase.instance.client.auth.signOut();
      
      if (mounted) {
        // 2. Close dialog
        Navigator.of(context).pop(); 
        
        // 3. The Router (GoRouter) should detect the auth state change 
        // and redirect to /login automatically. 
        // But for safety, we can explicitly go there if the listener lags.
        context.go('/login');
      }
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text("Logout failed: $e"), backgroundColor: Colors.red),
        );
        setState(() => _isLoading = false);
      }
    }
  }

  @override
  Widget build(BuildContext context) {
    // ignore: unused_local_variable
    const bgColor = Color(0xFF151718);
    const surfaceColor = Color(0xFF1F2227); // Slightly lighter for dialog
    const textWhite = Colors.white;
    const textGrey = Color(0xFF9CA3AF);
    const dangerRed = Color(0xFFEF4444);

    return Dialog(
      backgroundColor: surfaceColor,
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
      child: Container(
        width: 400,
        padding: const EdgeInsets.all(24),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          crossAxisAlignment: CrossAxisAlignment.start, // Align left as per design
          children: [
            Row(
              children: [
                Container(
                  padding: const EdgeInsets.all(10),
                  decoration: BoxDecoration(
                    color: dangerRed.withAlpha(30),
                    shape: BoxShape.circle,
                  ),
                  child: const Icon(Icons.logout, color: dangerRed, size: 24),
                ),
                const SizedBox(width: 16),
                const Text(
                  "Confirm Logout",
                  style: TextStyle(
                    color: textWhite,
                    fontSize: 18,
                    fontWeight: FontWeight.bold,
                  ),
                ),
              ],
            ),
            const SizedBox(height: 16),
            const Text(
              "Are you sure you want to log out of the Financial Portal? Any unsaved changes on the current page will be preserved locally.",
              style: TextStyle(color: textGrey, fontSize: 14, height: 1.5),
            ),
            const SizedBox(height: 32),
            Row(
              mainAxisAlignment: MainAxisAlignment.end,
              children: [
                TextButton(
                  onPressed: () => Navigator.pop(context),
                  child: const Text("Cancel", style: TextStyle(color: textGrey)),
                ),
                const SizedBox(width: 12),
                ElevatedButton(
                  onPressed: _isLoading ? null : _handleLogout,
                  style: ElevatedButton.styleFrom(
                    backgroundColor: dangerRed,
                    foregroundColor: Colors.white,
                    shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
                    padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 12),
                  ),
                  child: _isLoading 
                    ? const SizedBox(width: 16, height: 16, child: CircularProgressIndicator(color: Colors.white, strokeWidth: 2))
                    : const Text("Log Out", style: TextStyle(fontWeight: FontWeight.bold)),
                ),
              ],
            ),
          ],
        ),
      ),
    );
  }
}import 'package:flutter/material.dart';
import '../../../core/constants/app_colors.dart';

class StatCard extends StatelessWidget {
  final String title;
  final String value;
  final IconData icon;
  final Color iconColor;
  final Color? iconBgColor;
  final Widget? footer;
  final bool isAlert;

  const StatCard({
    super.key,
    required this.title,
    required this.value,
    required this.icon,
    this.iconColor = Colors.white,
    this.iconBgColor,
    this.footer,
    this.isAlert = false,
  });

  @override
  Widget build(BuildContext context) {
    return Expanded(
      child: Container(
        margin: const EdgeInsets.only(right: 16),
        // FIX: Reduced padding from 20 to 16 to save vertical space (4px saved top + 4px bottom = 8px total)
        padding: const EdgeInsets.all(16), 
        decoration: BoxDecoration(
          color: AppColors.surfaceGrey,
          borderRadius: BorderRadius.circular(16),
          border: isAlert 
              ? const Border(left: BorderSide(color: AppColors.errorRed, width: 4))
              : Border.all(color: Colors.white10),
        ),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            // Header
            Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                Flexible(
                  child: Text(
                    title.toUpperCase(),
                    overflow: TextOverflow.ellipsis,
                    style: const TextStyle(
                      color: Colors.white54,
                      fontSize: 11,
                      fontWeight: FontWeight.bold,
                      letterSpacing: 0.5,
                    ),
                  ),
                ),
                Container(
                  padding: const EdgeInsets.all(8),
                  decoration: BoxDecoration(
                    color: iconBgColor ?? Colors.white.withAlpha(12),
                    borderRadius: BorderRadius.circular(8),
                  ),
                  child: Icon(icon, size: 18, color: iconColor),
                ),
              ],
            ),
            
            const SizedBox(height: 8), // Reduced gap slightly
            
            // Value
            FittedBox(
              fit: BoxFit.scaleDown,
              alignment: Alignment.centerLeft,
              child: Text(
                value,
                style: const TextStyle(
                  color: Colors.white,
                  fontSize: 28, // Kept large font
                  fontWeight: FontWeight.bold,
                ),
              ),
            ),
            
            const SizedBox(height: 8), // Reduced gap slightly
            
            // Footer
            if (footer != null) 
              SizedBox(
                height: 24, 
                child: footer!,
              ),
          ],
        ),
      ),
    );
  }
}

class AlertBadge extends StatelessWidget {
  final String text;
  final String subText;

  const AlertBadge({super.key, required this.text, required this.subText});

  @override
  Widget build(BuildContext context) {
    return Row(
      mainAxisSize: MainAxisSize.min,
      children: [
        Container(
          padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
          decoration: BoxDecoration(
            color: AppColors.errorRed.withAlpha(25),
            borderRadius: BorderRadius.circular(4),
          ),
          child: Row(
            mainAxisSize: MainAxisSize.min,
            children: [
              const Icon(Icons.warning_amber_rounded, size: 14, color: AppColors.errorRed),
              const SizedBox(width: 4),
              Text(
                text,
                style: const TextStyle(color: AppColors.errorRed, fontSize: 11, fontWeight: FontWeight.bold),
              ),
            ],
          ),
        ),
        const SizedBox(width: 8),
        Flexible(
          child: Text(
            subText,
            overflow: TextOverflow.ellipsis,
            style: const TextStyle(color: Colors.white38, fontSize: 11),
          ),
        ),
      ],
    );
  }
}import 'package:fl_chart/fl_chart.dart';
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:intl/intl.dart';
import '../../../core/constants/app_colors.dart';
import '../../../data/providers/revenue_provider.dart';

class RevenueChart extends ConsumerWidget {
  const RevenueChart({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final revenueAsync = ref.watch(weeklyRevenueProvider);
    final currentFilter = ref.watch(revenueFilterProvider);

    return Container(
      padding: const EdgeInsets.all(24),
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: Colors.white10),
      ),
      child: revenueAsync.when(
        loading: () => const Center(child: CircularProgressIndicator()),
        error: (err, stack) => Center(child: Text('Error: $err', style: const TextStyle(color: Colors.red, fontSize: 12))),
        data: (data) {
          // Dynamic Y-Axis Scale
          double maxY = 100;
          for (var val in data.dailyTotals.values) {
            if (val > maxY) maxY = val;
          }
          maxY = maxY * 1.2; // Add breathing room

          return Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              // --- HEADER ---
              Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      const Text("Revenue & Collections", style: TextStyle(color: Colors.white, fontSize: 16, fontWeight: FontWeight.bold)),
                      const SizedBox(height: 4),
                      Text(
                        "Total: ${NumberFormat.simpleCurrency().format(data.totalWeekRevenue)}", 
                        style: const TextStyle(color: Colors.white54, fontSize: 13)
                      ),
                    ],
                  ),
                  
                  // --- FUNCTIONAL DROPDOWN ---
                  Container(
                    padding: const EdgeInsets.symmetric(horizontal: 12),
                    decoration: BoxDecoration(color: Colors.white10, borderRadius: BorderRadius.circular(6)),
                    child: DropdownButtonHideUnderline(
                      child: DropdownButton<RevenueFilter>(
                        value: currentFilter,
                        dropdownColor: const Color(0xFF2C2F36),
                        icon: const Icon(Icons.keyboard_arrow_down, size: 16, color: Colors.white),
                        style: const TextStyle(color: Colors.white, fontSize: 12),
                        onChanged: (RevenueFilter? newValue) {
                          if (newValue != null) {
                            // This triggers the provider to refresh
                            ref.read(revenueFilterProvider.notifier).state = newValue;
                          }
                        },
                        items: const [
                          DropdownMenuItem(value: RevenueFilter.thisWeek, child: Text("This Week")),
                          DropdownMenuItem(value: RevenueFilter.lastWeek, child: Text("Last Week")),
                        ],
                      ),
                    ),
                  )
                ],
              ),
              const SizedBox(height: 24),
              
              // --- CHART ---
              Expanded(
                child: LineChart(
                  LineChartData(
                    gridData: FlGridData(
                      show: true,
                      drawVerticalLine: false,
                      getDrawingHorizontalLine: (value) => const FlLine(color: Colors.white10, strokeWidth: 1),
                    ),
                    titlesData: FlTitlesData(
                      show: true,
                      rightTitles: const AxisTitles(sideTitles: SideTitles(showTitles: false)),
                      topTitles: const AxisTitles(sideTitles: SideTitles(showTitles: false)),
                      bottomTitles: AxisTitles(
                        sideTitles: SideTitles(
                          showTitles: true,
                          reservedSize: 30,
                          interval: 1, 
                          getTitlesWidget: (value, meta) {
                            const style = TextStyle(color: Colors.white38, fontSize: 12);
                            // Visual Map: 0=Mon, 2=Tue, 4=Wed, 6=Thu, 8=Fri
                            switch (value.toInt()) {
                              case 0: return const Text('Mon', style: style);
                              case 2: return const Text('Tue', style: style);
                              case 4: return const Text('Wed', style: style);
                              case 6: return const Text('Thu', style: style);
                              case 8: return const Text('Fri', style: style);
                            }
                            return const Text('');
                          },
                        ),
                      ),
                      leftTitles: AxisTitles(
                        sideTitles: SideTitles(
                          showTitles: true,
                          reservedSize: 40,
                          getTitlesWidget: (value, meta) {
                            if (value == 0) return const SizedBox.shrink();
                            return Text(
                              NumberFormat.compact().format(value),
                              style: const TextStyle(color: Colors.white38, fontSize: 10),
                            );
                          },
                        ),
                      ),
                    ),
                    borderData: FlBorderData(show: false),
                    minX: 0,
                    maxX: 8,
                    minY: 0,
                    maxY: maxY,
                    lineBarsData: [
                      LineChartBarData(
                        spots: [
                          // Mapping Real Data to Visual X Coordinates
                          FlSpot(0, data.dailyTotals[1] ?? 0),
                          FlSpot(2, data.dailyTotals[2] ?? 0),
                          FlSpot(4, data.dailyTotals[3] ?? 0),
                          FlSpot(6, data.dailyTotals[4] ?? 0),
                          FlSpot(8, data.dailyTotals[5] ?? 0),
                        ],
                        isCurved: true,
                        color: AppColors.primaryBlue,
                        barWidth: 3,
                        isStrokeCapRound: true,
                        dotData: const FlDotData(show: false),
                        belowBarData: BarAreaData(
                          show: true,
                          color: AppColors.primaryBlue.withAlpha(25),
                        ),
                      ),
                    ],
                    lineTouchData: LineTouchData(
                      touchTooltipData: LineTouchTooltipData(
                        getTooltipColor: (spot) => Colors.black87,
                        getTooltipItems: (touchedSpots) {
                          return touchedSpots.map((spot) {
                            return LineTooltipItem(
                              "\$${spot.y.toStringAsFixed(2)}",
                              const TextStyle(color: Colors.white, fontWeight: FontWeight.bold),
                            );
                          }).toList();
                        },
                      ),
                    ),
                  ),
                ),
              ),
            ],
          );
        },
      ),
    );
  }
}import 'package:fees_up/pc/widgets/logout_dialog.dart';
import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import '../../../core/constants/app_colors.dart';

class DashboardSidebar extends StatefulWidget {
  const DashboardSidebar({super.key});

  @override
  State<DashboardSidebar> createState() => _DashboardSidebarState();
}

class _DashboardSidebarState extends State<DashboardSidebar> {
  // We use the current path to determine the active index
  int _calculateSelectedIndex(BuildContext context) {
    final String location = GoRouterState.of(context).uri.toString();
    if (location.startsWith('/transactions')) return 1;
    if (location.startsWith('/invoices')) return 2;
    if (location.startsWith('/students')) return 3;
    if (location.startsWith('/reports')) return 4;
    if (location.startsWith('/announcements')) return 5;
    return 0; // Default to Overview
  }

  final List<Map<String, dynamic>> _menuItems = [
    {'icon': Icons.grid_view_rounded, 'label': 'Overview', 'route': '/'},
    {
      'icon': Icons.receipt_long_rounded,
      'label': 'Transactions',
      'route': '/transactions'
    },
    {
      'icon': Icons.description_outlined,
      'label': 'Invoices',
      'route': '/invoices'
    },
    {'icon': Icons.school_outlined, 'label': 'Students', 'route': '/students'},
    {'icon': Icons.bar_chart_rounded, 'label': 'Reports', 'route': '/reports'},
    {
      'icon': Icons.campaign_outlined,
      'label': 'Announcements',
      'route': '/announcements'
    },
  ];

  @override
  Widget build(BuildContext context) {
    final int selectedIndex = _calculateSelectedIndex(context);

    return Container(
      width: 260,
      color: const Color(0xFF0F1115),
      child: Column(
        children: [
          // 1. BRAND HEADER
          Padding(
            padding: const EdgeInsets.all(24.0),
            child: Row(
              children: [
                Container(
                  padding: const EdgeInsets.all(8),
                  decoration: BoxDecoration(
                    color: AppColors.surfaceGrey,
                    borderRadius: BorderRadius.circular(8),
                    border: Border.all(color: Colors.white12),
                  ),
                  child: const Icon(Icons.shield_outlined,
                      color: AppColors.primaryBlue, size: 20),
                ),
                const SizedBox(width: 12),
                Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    const Text(
                      "School Admin",
                      style: TextStyle(
                          color: Colors.white,
                          fontWeight: FontWeight.bold,
                          fontSize: 14),
                    ),
                    Text(
                      "Financial Portal",
                      style: TextStyle(
                          color: Colors.white.withAlpha(127), fontSize: 12),
                    ),
                  ],
                )
              ],
            ),
          ),

          const SizedBox(height: 10),

          // 2. NAVIGATION ITEMS
          Expanded(
            child: ListView.builder(
              padding: const EdgeInsets.symmetric(horizontal: 16),
              itemCount: _menuItems.length,
              itemBuilder: (context, index) {
                final item = _menuItems[index];

                return _SidebarItem(
                  icon: item['icon'],
                  label: item['label'],
                  isSelected: selectedIndex == index,
                  onTap: () {
                    // Navigate to the route defined in the list
                    context.go(item['route']);
                  },
                );
              },
            ),
          ),

          // 3. BOTTOM ACTIONS
          const Divider(color: Colors.white10, indent: 20, endIndent: 20),
          Padding(
            padding: const EdgeInsets.all(16.0),
            child: Column(
              children: [
                _SidebarItem(
                  icon: Icons.settings_outlined,
                  label: "Settings",
                  isSelected: false,
                  onTap: () => context.go('/settings'),
                ),
                const SizedBox(height: 8),
                _SidebarItem(
                  icon: Icons.logout_rounded,
                  label: "Log Out",
                  isDestructive: true, // If you have this property
                  onTap: () {
                    showDialog(
                      context: context,
                      barrierColor: Colors.black
                          .withAlpha((0.7*255).toInt()), // Darken background heavily
                      builder: (context) => const LogoutDialog(),
                    );
                  }, isSelected: false,
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }
}

class _SidebarItem extends StatefulWidget {
  final IconData icon;
  final String label;
  final bool isSelected;
  final bool isDestructive;
  final VoidCallback onTap;

  const _SidebarItem({
    required this.icon,
    required this.label,
    required this.isSelected,
    this.isDestructive = false,
    required this.onTap,
  });

  @override
  State<_SidebarItem> createState() => _SidebarItemState();
}

class _SidebarItemState extends State<_SidebarItem> {
  bool _isHovered = false;

  @override
  Widget build(BuildContext context) {
    final Color bgColor = widget.isSelected
        ? AppColors.primaryBlue
        : (_isHovered ? Colors.white.withAlpha(12) : Colors.transparent);

    final Color textColor = widget.isDestructive
        ? AppColors.errorRed
        : (widget.isSelected ? Colors.white : Colors.white70);

    final Color iconColor = widget.isDestructive
        ? AppColors.errorRed
        : (widget.isSelected ? Colors.white : Colors.white54);

    return MouseRegion(
      onEnter: (_) => setState(() => _isHovered = true),
      onExit: (_) => setState(() => _isHovered = false),
      cursor: SystemMouseCursors.click,
      child: GestureDetector(
        onTap: widget.onTap,
        child: AnimatedContainer(
          duration: const Duration(milliseconds: 200),
          curve: Curves.easeInOut,
          margin: const EdgeInsets.only(bottom: 8),
          padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
          decoration: BoxDecoration(
            color: bgColor,
            borderRadius: BorderRadius.circular(12),
          ),
          child: Row(
            children: [
              Icon(widget.icon, size: 20, color: iconColor),
              const SizedBox(width: 12),
              Text(
                widget.label,
                style: TextStyle(
                  color: textColor,
                  fontWeight:
                      widget.isSelected ? FontWeight.bold : FontWeight.w500,
                  fontSize: 14,
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}
import 'package:flutter/material.dart';

/// Define your action types here to make it easy to switch between them
enum QuickActionType {
  recordPayment,
  addExpense,
  registerStudent,
  createCampaign,
}

class QuickActionItem {
  final String label;
  final IconData icon;
  final Color color;
  final QuickActionType type;

  const QuickActionItem({
    required this.label,
    required this.icon,
    required this.color,
    required this.type,
  });
}

class QuickActionsGrid extends StatelessWidget {
  /// The parent widget will provide the logic for what happens on tap
  final Function(QuickActionType) onActionSelected;

  const QuickActionsGrid({
    super.key,
    required this.onActionSelected,
  });

  // -----------------------------------------------------------
  // CONFIGURATION: Add new buttons here
  // -----------------------------------------------------------
  final List<QuickActionItem> _actions = const [
    QuickActionItem(
      label: "Record Payment",
      icon: Icons.attach_money,
      color: Color(0xFF4ADE80), // Green
      type: QuickActionType.recordPayment,
    ),
    QuickActionItem(
      label: "Add Expense",
      icon: Icons.receipt_long,
      color: Color(0xFFF87171), // Red
      type: QuickActionType.addExpense,
    ),
    QuickActionItem(
      label: "New Student",
      icon: Icons.person_add,
      color: Color(0xFF60A5FA), // Blue
      type: QuickActionType.registerStudent,
    ),
    QuickActionItem(
      label: "New Campaign",
      icon: Icons.campaign,
      color: Color(0xFFA78BFA), // Purple
      type: QuickActionType.createCampaign,
    ),
  ];

  @override
  Widget build(BuildContext context) {
    const surfaceColor = Color(0xFF1F2227); // Matching PaymentDialog
    const borderColor = Colors.white10;

    return Container(
      padding: const EdgeInsets.all(24),
      decoration: BoxDecoration(
        color: surfaceColor,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: borderColor),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          const Text(
            "Quick Actions",
            style: TextStyle(
              color: Colors.white,
              fontSize: 18,
              fontWeight: FontWeight.bold,
            ),
          ),
          const SizedBox(height: 16),
          Expanded(
            child: GridView.builder(
              physics: const NeverScrollableScrollPhysics(),
              gridDelegate: const SliverGridDelegateWithFixedCrossAxisCount(
                crossAxisCount: 2,
                crossAxisSpacing: 12,
                mainAxisSpacing: 12,
                childAspectRatio: 1.5, // Wider buttons
              ),
              itemCount: _actions.length,
              itemBuilder: (context, index) {
                return _buildActionCard(_actions[index]);
              },
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildActionCard(QuickActionItem action) {
    return Material(
      color: Colors.transparent,
      child: InkWell(
        onTap: () => onActionSelected(action.type),
        borderRadius: BorderRadius.circular(12),
        hoverColor: Colors.white.withAlpha(10),
        child: Container(
          decoration: BoxDecoration(
            borderRadius: BorderRadius.circular(12),
            border: Border.all(color: Colors.white.withAlpha(15)),
            color: Colors.white.withAlpha(5),
          ),
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              Container(
                padding: const EdgeInsets.all(10),
                decoration: BoxDecoration(
                  color: action.color.withAlpha(30),
                  shape: BoxShape.circle,
                ),
                child: Icon(action.icon, color: action.color, size: 22),
              ),
              const SizedBox(height: 10),
              Text(
                action.label,
                style: const TextStyle(
                  color: Colors.white70,
                  fontSize: 12,
                  fontWeight: FontWeight.w600,
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}import 'dart:math';
import 'package:fees_up/data/models/subjects.dart';
import 'package:flutter/material.dart';
import 'package:intl/intl.dart';
import 'package:uuid/uuid.dart';
import '../../../../data/services/database_service.dart';

class StudentDialog extends StatefulWidget {
  final String schoolId;
  
  const StudentDialog({
    super.key, 
    required this.schoolId,
  });

  @override
  State<StudentDialog> createState() => _StudentDialogState();
}

class _StudentDialogState extends State<StudentDialog> {
  final _formKey = GlobalKey<FormState>();
  final DatabaseService _dbService = DatabaseService();

  // -- Controllers --
  final _fullNameController = TextEditingController();
  final _studentIdController = TextEditingController();
  final _parentContactController = TextEditingController();
  final _addressController = TextEditingController();
  final _feeController = TextEditingController();
  final _initialPayController = TextEditingController();

  // -- State --
  DateTime _dob = DateTime(2010, 1, 1);
  DateTime _registrationDate = DateTime.now(); // Acts as Billing Start Date
  String _selectedGender = 'Male';
  String _selectedGrade = 'FORM 1';
  String _billingType = 'monthly';
  List<String> _selectedSubjects = [];
  bool _isLoading = false;

  // -- Constants --
  final List<String> _genders = ['Male', 'Female'];
  final List<String> _grades = [
    'ECD A', 'ECD B', 'GRADE 1', 'GRADE 2', 'GRADE 3', 'GRADE 4',
    'GRADE 5', 'GRADE 6', 'GRADE 7', 'FORM 1', 'FORM 2', 'FORM 3',
    'FORM 4', 'LOWER 6', 'UPPER 6'
  ];

  @override
  void initState() {
    super.initState();
    _generateNewId();
  }

  void _generateNewId() {
    final random = Random();
    final idNumber = 100000000 + random.nextInt(900000000); 
    _studentIdController.text = "STU-$idNumber";
  }

  @override
  void dispose() {
    _fullNameController.dispose();
    _studentIdController.dispose();
    _parentContactController.dispose();
    _addressController.dispose();
    _feeController.dispose();
    _initialPayController.dispose();
    super.dispose();
  }

  // --- SAVE LOGIC ---
  Future<void> _saveStudent() async {
    if (!_formKey.currentState!.validate()) return;

    setState(() => _isLoading = true);

    try {
      final db = _dbService;
      final newStudentUuid = const Uuid().v4();
      
      // 1. Prepare ID
      String displayId = _studentIdController.text.trim();
      if (displayId.isEmpty) {
        _generateNewId();
        displayId = _studentIdController.text;
      }

      final defaultFee = double.tryParse(_feeController.text.replaceAll(',', '')) ?? 0.0;
      final initialPay = double.tryParse(_initialPayController.text.replaceAll(',', '')) ?? 0.0;

      // 2. Logic for Billing Date
      // Only monthly students get a specific start date here. Termly relies on term IDs later.
      String? billingDateStr;
      if (_billingType == 'monthly') {
        billingDateStr = DateFormat('yyyy-MM-dd').format(_registrationDate);
      } else {
        billingDateStr = null; // Empty for term students
      }

      // 3. Insert Student Record
      final studentData = {
        'id': newStudentUuid,
        'school_id': widget.schoolId,
        'student_id': displayId,
        'full_name': _fullNameController.text.trim(),
        'grade': _selectedGrade, // Precise Grade
        'parent_contact': _parentContactController.text.trim(),
        'address': _addressController.text.trim(),
        'date_of_birth': DateFormat('yyyy-MM-dd').format(_dob),
        'gender': _selectedGender,
        'billing_type': _billingType,
        'default_fee': defaultFee,
        'subjects': _selectedSubjects.join(','),
        
        // Dates & Status
        'registration_date': DateTime.now().toIso8601String(),
        'billing_date': billingDateStr, // Crucial logic applied here
        'enrollment_date': DateTime.now().toIso8601String(),
        'created_at': DateTime.now().toIso8601String(),
        'updated_at': DateTime.now().toIso8601String(),
        'is_active': 1,
        'owed_total': 0.0, 
        'paid_total': initialPay,
        'photo_consent': 0,
      };

      await db.insert('students', studentData);

      // 4. Attempt Auto-Billing (If Monthy & Fee > 0)
      String? generatedBillId;
      if (_billingType == 'monthly' && defaultFee > 0) {
        generatedBillId = await _attemptAutoBilling(newStudentUuid, defaultFee);
      }

      // 5. Handle Initial Payment
      if (initialPay > 0) {
        await db.insert('payments', {
          'id': const Uuid().v4(),
          'school_id': widget.schoolId,
          'student_id': newStudentUuid,
          'bill_id': generatedBillId, // Link if we generated one
          'amount': initialPay,
          'date_paid': DateFormat('yyyy-MM-dd').format(DateTime.now()),
          'category': 'Tuition',
          'method': 'Cash', 
          'payer_name': _fullNameController.text.trim(), 
          'created_at': DateTime.now().toIso8601String(),
        });
      }

      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('${_fullNameController.text} registered successfully!'),
            backgroundColor: const Color(0xFF4ADE80),
          ),
        );
        Navigator.of(context).pop(); 
      }
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text('Error: $e'), backgroundColor: Colors.red),
        );
      }
    } finally {
      if (mounted) setState(() => _isLoading = false);
    }
  }

  /// Tries to find the active School Year & Month matching _registrationDate
  /// and creates a bill if found. Returns bill_id or null.
  Future<String?> _attemptAutoBilling(String studentId, double amount) async {
    try {
      // 1. Get Years
      // ignore: unused_local_variable
      final years = await _dbService.tryGet('SELECT * FROM school_years WHERE school_id = ?', [widget.schoolId]);
      // Note: tryGet returns one, we need list. Using getAll query pattern locally:
      final allYears = await _dbService.db.getAll('SELECT * FROM school_years WHERE school_id = ?', [widget.schoolId]);
      
      Map<String, dynamic>? activeYear;
      
      for (var y in allYears) {
        final start = DateTime.parse(y['start_date']);
        final end = DateTime.parse(y['end_date']);
        if (_registrationDate.isAfter(start.subtract(const Duration(days: 1))) && 
            _registrationDate.isBefore(end.add(const Duration(days: 1)))) {
          activeYear = y;
          break;
        }
      }

      if (activeYear == null) return null;

      // 2. Get Months
      final months = await _dbService.db.getAll('SELECT * FROM school_year_months WHERE school_year_id = ?', [activeYear['id']]);
      Map<String, dynamic>? activeMonth;

      for (var m in months) {
        final start = DateTime.parse(m['start_date']);
        final end = DateTime.parse(m['end_date']);
        if (_registrationDate.isAfter(start.subtract(const Duration(days: 1))) && 
            _registrationDate.isBefore(end.add(const Duration(days: 1)))) {
          activeMonth = m;
          break;
        }
      }

      if (activeMonth == null) return null;

      // 3. Create Bill
      final billId = const Uuid().v4();
      await _dbService.insert('bills', {
        'id': billId,
        'school_id': widget.schoolId,
        'student_id': studentId,
        'title': 'Tuition - ${activeMonth['name']}',
        'total_amount': amount,
        'is_paid': 0,
        'bill_type': 'monthly',
        'billing_cycle_start': activeMonth['start_date'],
        'billing_cycle_end': activeMonth['end_date'],
        'month_year': activeMonth['name'],
        'school_year_id': activeYear['id'],
        'month_index': activeMonth['month_index'],
        'created_at': DateTime.now().toIso8601String(),
        'updated_at': DateTime.now().toIso8601String(),
      });

      return billId;

    } catch (e) {
      debugPrint("Auto-billing failed (silent): $e");
      return null;
    }
  }

  // --- HELPER DIALOGS ---

  void _openSubjectSelector() {
    showDialog(
      context: context,
      builder: (context) {
        final allSubjects = ZimsecSubject.allNames;
        List<String> tempSelected = List.from(_selectedSubjects);
        String searchQuery = "";
        
        return StatefulBuilder(
          builder: (context, setState) {
            final filteredSubjects = allSubjects.where((s) => s.toLowerCase().contains(searchQuery.toLowerCase())).toList();

            return AlertDialog(
              backgroundColor: const Color(0xFF1F2227),
              title: const Text("Select Subjects", style: TextStyle(color: Colors.white)),
              content: SizedBox(
                width: 400,
                height: 500,
                child: Column(
                  children: [
                    // Search Bar
                    TextField(
                      onChanged: (val) => setState(() => searchQuery = val),
                      style: const TextStyle(color: Colors.white),
                      decoration: InputDecoration(
                        hintText: "Search subjects...",
                        hintStyle: const TextStyle(color: Colors.white24),
                        prefixIcon: const Icon(Icons.search, color: Colors.white54),
                        filled: true,
                        fillColor: Colors.white.withAlpha(10),
                        border: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: BorderSide.none),
                        contentPadding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
                      ),
                    ),
                    const SizedBox(height: 12),
                    // List
                    Expanded(
                      child: ListView.builder(
                        itemCount: filteredSubjects.length,
                        itemBuilder: (context, index) {
                          final subject = filteredSubjects[index];
                          final isSelected = tempSelected.contains(subject);
                          return CheckboxListTile(
                            title: Text(subject, style: const TextStyle(color: Colors.white70)),
                            value: isSelected,
                            activeColor: const Color(0xFF3B82F6),
                            checkColor: Colors.white,
                            contentPadding: EdgeInsets.zero,
                            onChanged: (val) {
                              setState(() {
                                if (val == true) {
                                  tempSelected.add(subject);
                                } else {
                                  tempSelected.remove(subject);
                                }
                              });
                            },
                          );
                        },
                      ),
                    ),
                  ],
                ),
              ),
              actions: [
                TextButton(
                  onPressed: () => Navigator.pop(context),
                  child: const Text("Cancel", style: TextStyle(color: Colors.grey)),
                ),
                ElevatedButton(
                  onPressed: () {
                    this.setState(() => _selectedSubjects = tempSelected);
                    Navigator.pop(context);
                  },
                  style: ElevatedButton.styleFrom(backgroundColor: const Color(0xFF3B82F6)),
                  child: const Text("Confirm", style: TextStyle(color: Colors.white)),
                ),
              ],
            );
          }
        );
      },
    );
  }

  @override
  Widget build(BuildContext context) {
    const bgColor = Color(0xFF151718);
    const surfaceColor = Color(0xFF1F2227);
    const inputColor = Color(0xFF2A2D35);
    const primaryBlue = Color(0xFF3B82F6);
    const textWhite = Colors.white;
    const textGrey = Color(0xFF9CA3AF);

    final inputDecoration = BoxDecoration(
      color: inputColor,
      borderRadius: BorderRadius.circular(8),
      border: Border.all(color: Colors.white.withAlpha(20)),
    );

    return Dialog(
      backgroundColor: bgColor,
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
      child: Container(
        width: 1100,
        height: 750,
        padding: const EdgeInsets.all(24),
        child: Column(
          children: [
            // --- HEADER ---
            Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                Row(
                  children: [
                    Container(
                      padding: const EdgeInsets.all(10),
                      decoration: BoxDecoration(color: primaryBlue, borderRadius: BorderRadius.circular(8)),
                      child: const Icon(Icons.person_add, color: Colors.white, size: 20),
                    ),
                    const SizedBox(width: 16),
                    const Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text("Register Student", style: TextStyle(color: textWhite, fontSize: 18, fontWeight: FontWeight.bold)),
                        Text("Add new student details to the school database", style: TextStyle(color: textGrey, fontSize: 12)),
                      ],
                    ),
                  ],
                ),
                IconButton(
                  onPressed: () => Navigator.pop(context),
                  icon: const Icon(Icons.close, color: textGrey),
                ),
              ],
            ),
            const Divider(color: Color(0xFF2E323A), height: 40),
            
            // --- BODY (Split View) ---
            Expanded(
              child: Row(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  // --- LEFT: FORM SECTION ---
                  Expanded(
                    flex: 4,
                    child: Form(
                      key: _formKey,
                      child: SingleChildScrollView(
                        padding: const EdgeInsets.only(right: 24),
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            const _SectionLabel("STUDENT DETAILS"),
                            
                            _buildLabel("Full Name"),
                            _buildTextInput(controller: _fullNameController, hint: "e.g. Gabriel", icon: Icons.person, decoration: inputDecoration),
                            const SizedBox(height: 16),

                            Row(
                              children: [
                                Expanded(
                                  child: Column(
                                    crossAxisAlignment: CrossAxisAlignment.start,
                                    children: [
                                      _buildLabel("Student ID (Optional)"),
                                      _buildTextInput(
                                        controller: _studentIdController, 
                                        hint: "STU-...", 
                                        icon: Icons.badge,
                                        decoration: inputDecoration,
                                        suffix: IconButton(
                                          icon: const Icon(Icons.refresh, color: textGrey, size: 16),
                                          onPressed: _generateNewId,
                                          tooltip: "Generate New ID",
                                        )
                                      ),
                                    ],
                                  ),
                                ),
                                const SizedBox(width: 16),
                                Expanded(
                                  child: Column(
                                    crossAxisAlignment: CrossAxisAlignment.start,
                                    children: [
                                      _buildLabel("Grade"), // Precise label
                                      _buildDropdown(_selectedGrade, _grades, (v) => setState(() => _selectedGrade = v!), inputDecoration),
                                    ],
                                  ),
                                ),
                              ],
                            ),
                            const SizedBox(height: 16),

                            Row(
                              children: [
                                Expanded(
                                  child: Column(
                                    crossAxisAlignment: CrossAxisAlignment.start,
                                    children: [
                                      _buildLabel("Date of Birth"),
                                      _buildDatePicker(context, _dob, (d) => setState(() => _dob = d), inputDecoration),
                                    ],
                                  ),
                                ),
                                const SizedBox(width: 16),
                                Expanded(
                                  child: Column(
                                    crossAxisAlignment: CrossAxisAlignment.start,
                                    children: [
                                      _buildLabel("Gender"),
                                      _buildDropdown(_selectedGender, _genders, (v) => setState(() => _selectedGender = v!), inputDecoration),
                                    ],
                                  ),
                                ),
                              ],
                            ),
                            const SizedBox(height: 16),

                            _buildLabel("Parent Contact"),
                            _buildTextInput(controller: _parentContactController, hint: "+263 7...", icon: Icons.phone, decoration: inputDecoration),
                            const SizedBox(height: 16),
                            _buildLabel("Address"),
                            _buildTextInput(controller: _addressController, hint: "123 Main St...", icon: Icons.location_on, decoration: inputDecoration),
                            
                            const SizedBox(height: 32),
                            const _SectionLabel("FINANCIAL SETUP"),

                            // Billing Type Toggle
                            Container(
                              decoration: inputDecoration,
                              padding: const EdgeInsets.all(4),
                              child: Row(
                                children: ['monthly', 'termly'].map((type) {
                                  final isSelected = _billingType == type;
                                  return Expanded(
                                    child: GestureDetector(
                                      onTap: () => setState(() => _billingType = type),
                                      child: Container(
                                        padding: const EdgeInsets.symmetric(vertical: 10),
                                        decoration: BoxDecoration(
                                          color: isSelected ? primaryBlue : Colors.transparent,
                                          borderRadius: BorderRadius.circular(6),
                                        ),
                                        alignment: Alignment.center,
                                        child: Text(
                                          type.toUpperCase(),
                                          style: TextStyle(fontSize: 12, fontWeight: FontWeight.bold, color: isSelected ? Colors.white : textGrey),
                                        ),
                                      ),
                                    ),
                                  );
                                }).toList(),
                              ),
                            ),
                            const SizedBox(height: 16),

                            // Fee & Initial Payment & Date
                            Row(
                              children: [
                                Expanded(
                                  flex: 2,
                                  child: Column(
                                    crossAxisAlignment: CrossAxisAlignment.start,
                                    children: [
                                      _buildLabel("Tuition Fee"),
                                      _buildTextInput(controller: _feeController, hint: "0.00", prefix: "\$ ", isNumber: true, decoration: inputDecoration),
                                    ],
                                  ),
                                ),
                                const SizedBox(width: 16),
                                // Only show Start Date for MONTHLY students
                                if (_billingType == 'monthly') ...[
                                  Expanded(
                                    flex: 2,
                                    child: Column(
                                      crossAxisAlignment: CrossAxisAlignment.start,
                                      children: [
                                        _buildLabel("Billing Start Date"),
                                        _buildDatePicker(context, _registrationDate, (d) => setState(() => _registrationDate = d), inputDecoration),
                                      ],
                                    ),
                                  ),
                                  const SizedBox(width: 16),
                                ],
                                Expanded(
                                  flex: 2,
                                  child: Column(
                                    crossAxisAlignment: CrossAxisAlignment.start,
                                    children: [
                                      _buildLabel("Initial Payment"),
                                      _buildTextInput(controller: _initialPayController, hint: "0.00", prefix: "\$ ", isNumber: true, decoration: inputDecoration),
                                    ],
                                  ),
                                ),
                              ],
                            ),
                            const SizedBox(height: 16),

                            // Subject Selection
                            _buildLabel("Enrolled Subjects"),
                            InkWell(
                              onTap: _openSubjectSelector,
                              child: Container(
                                width: double.infinity,
                                padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 14),
                                decoration: inputDecoration,
                                child: Row(
                                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                                  children: [
                                    Expanded(
                                      child: Text(
                                        _selectedSubjects.isEmpty ? "Select Subjects..." : "${_selectedSubjects.length} subjects selected",
                                        style: TextStyle(color: _selectedSubjects.isEmpty ? Colors.white24 : Colors.white),
                                        overflow: TextOverflow.ellipsis,
                                      ),
                                    ),
                                    const Icon(Icons.arrow_drop_down, color: textGrey),
                                  ],
                                ),
                              ),
                            ),
                            if (_selectedSubjects.isNotEmpty) ...[
                              const SizedBox(height: 8),
                              Wrap(
                                spacing: 8,
                                runSpacing: 8,
                                children: _selectedSubjects.take(5).map((s) => Chip(
                                  label: Text(s, style: const TextStyle(fontSize: 10, color: Colors.white)),
                                  backgroundColor: primaryBlue.withAlpha(50),
                                  padding: EdgeInsets.zero,
                                  side: BorderSide.none,
                                )).toList(),
                              ),
                            ],

                            const SizedBox(height: 40),
                            
                            // Action Buttons
                            Row(
                              mainAxisAlignment: MainAxisAlignment.end,
                              children: [
                                TextButton(
                                  onPressed: () => Navigator.pop(context),
                                  child: const Text("Cancel", style: TextStyle(color: textGrey)),
                                ),
                                const SizedBox(width: 12),
                                ElevatedButton.icon(
                                  onPressed: _isLoading ? null : _saveStudent,
                                  icon: _isLoading 
                                    ? const SizedBox(width: 16, height: 16, child: CircularProgressIndicator(strokeWidth: 2, color: Colors.white)) 
                                    : const Icon(Icons.check, size: 18),
                                  label: const Text("Save Student"),
                                  style: ElevatedButton.styleFrom(
                                    backgroundColor: primaryBlue,
                                    foregroundColor: Colors.white,
                                    padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 16),
                                    shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
                                  ),
                                ),
                              ],
                            )
                          ],
                        ),
                      ),
                    ),
                  ),

                  Container(width: 1, color: const Color(0xFF2E323A), margin: const EdgeInsets.symmetric(horizontal: 32)),

                  // --- RIGHT: LIST SECTION ---
                  Expanded(
                    flex: 3,
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Row(
                          mainAxisAlignment: MainAxisAlignment.spaceBetween,
                          children: [
                            const Text("RECENTLY ADDED", style: TextStyle(color: textGrey, fontSize: 11, fontWeight: FontWeight.bold, letterSpacing: 1.0)),
                            StreamBuilder<List<Map<String, dynamic>>>(
                              stream: _dbService.watchStudents(widget.schoolId), 
                              builder: (context, snapshot) {
                                final count = snapshot.data?.length ?? 0;
                                return Text("$count Students", style: const TextStyle(color: Colors.white, fontWeight: FontWeight.bold));
                              }
                            ),
                          ],
                        ),
                        const SizedBox(height: 20),
                        Expanded(
                          child: StreamBuilder<List<Map<String, dynamic>>>(
                            stream: _dbService.db.watch('SELECT * FROM students WHERE school_id = ? ORDER BY created_at DESC', parameters: [widget.schoolId]),
                            builder: (context, snapshot) {
                              if (!snapshot.hasData) return const Center(child: CircularProgressIndicator());
                              final students = snapshot.data ?? [];
                              if (students.isEmpty) return const Center(child: Text("No students added yet", style: TextStyle(color: textGrey)));

                              return ListView.separated(
                                itemCount: students.length,
                                separatorBuilder: (_, __) => const SizedBox(height: 12),
                                itemBuilder: (context, index) {
                                  final s = students[index];
                                  final name = s['full_name'] ?? 'Unknown';
                                  final id = s['student_id'] ?? 'N/A';
                                  final grade = s['grade'] ?? 'N/A';

                                  return Container(
                                    padding: const EdgeInsets.all(12),
                                    decoration: BoxDecoration(
                                      color: surfaceColor,
                                      borderRadius: BorderRadius.circular(12),
                                      border: Border.all(color: Colors.white.withAlpha(10)),
                                    ),
                                    child: Row(
                                      children: [
                                        CircleAvatar(
                                          backgroundColor: primaryBlue.withAlpha(30),
                                          child: Text(name.isNotEmpty ? name[0].toUpperCase() : '?', style: const TextStyle(color: primaryBlue, fontWeight: FontWeight.bold)),
                                        ),
                                        const SizedBox(width: 12),
                                        Expanded(
                                          child: Column(
                                            crossAxisAlignment: CrossAxisAlignment.start,
                                            children: [
                                              Text(name, style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600, fontSize: 14)),
                                              const SizedBox(height: 2),
                                              Text("$id • $grade", style: const TextStyle(color: textGrey, fontSize: 12)),
                                            ],
                                          ),
                                        ),
                                      ],
                                    ),
                                  );
                                },
                              );
                            },
                          ),
                        ),
                      ],
                    ),
                  ),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }

  // --- WIDGET BUILDERS ---

  Widget _buildLabel(String text) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 8.0),
      child: Text(text, style: const TextStyle(color: Color(0xFF9CA3AF), fontSize: 12)),
    );
  }

  Widget _buildTextInput({
    required TextEditingController controller, 
    required BoxDecoration decoration,
    String? hint, 
    Widget? suffix,
    IconData? icon,
    String? prefix,
    bool isNumber = false,
  }) {
    return Container(
      decoration: decoration,
      child: TextFormField(
        controller: controller,
        style: const TextStyle(color: Colors.white),
        keyboardType: isNumber ? const TextInputType.numberWithOptions(decimal: true) : TextInputType.text,
        validator: (val) => val == null || val.isEmpty ? 'Required' : null,
        decoration: InputDecoration(
          hintText: hint,
          hintStyle: const TextStyle(color: Colors.white24),
          prefixText: prefix,
          prefixStyle: const TextStyle(color: Colors.white70),
          prefixIcon: icon != null ? Icon(icon, color: Colors.white24, size: 20) : null,
          suffixIcon: suffix,
          border: InputBorder.none,
          contentPadding: const EdgeInsets.symmetric(horizontal: 16, vertical: 14),
        ),
      ),
    );
  }

  Widget _buildDropdown(String value, List<String> items, Function(String?) onChanged, BoxDecoration decoration) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 12),
      decoration: decoration,
      child: DropdownButtonHideUnderline(
        child: DropdownButton<String>(
          value: value,
          dropdownColor: const Color(0xFF1F2227),
          icon: const Icon(Icons.keyboard_arrow_down, color: Colors.white54),
          isExpanded: true,
          style: const TextStyle(color: Colors.white),
          items: items.map((val) => DropdownMenuItem(value: val, child: Text(val))).toList(),
          onChanged: onChanged,
        ),
      ),
    );
  }

  Widget _buildDatePicker(BuildContext context, DateTime initial, Function(DateTime) onPicked, BoxDecoration decoration) {
    return GestureDetector(
      onTap: () async {
        final picked = await showDatePicker(
          context: context,
          initialDate: initial,
          firstDate: DateTime(1990),
          lastDate: DateTime(2030),
          builder: (context, child) => Theme(
            data: ThemeData.dark().copyWith(
              colorScheme: const ColorScheme.dark(primary: Color(0xFF3B82F6), onPrimary: Colors.white, surface: Color(0xFF1F2227)),
            ),
            child: child!,
          ),
        );
        if (picked != null) onPicked(picked);
      },
      child: Container(
        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 14),
        decoration: decoration,
        child: Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            Text(DateFormat('MMM dd, yyyy').format(initial), style: const TextStyle(color: Colors.white)),
            const Icon(Icons.calendar_today, size: 16, color: Color(0xFF9CA3AF)),
          ],
        ),
      ),
    );
  }
}

class _SectionLabel extends StatelessWidget {
  final String title;
  const _SectionLabel(this.title);
  @override
  Widget build(BuildContext context) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 16.0, left: 2),
      child: Text(
        title,
        style: const TextStyle(color: Color(0xFF3B82F6), fontWeight: FontWeight.bold, letterSpacing: 1.2, fontSize: 11),
      ),
    );
  }
}import 'package:flutter/material.dart';
import 'package:intl/intl.dart';
import 'package:uuid/uuid.dart';
import '../../../data/services/database_service.dart';

class PaymentDialog extends StatefulWidget {
  final String schoolId;
  
  const PaymentDialog({
    super.key, 
    required this.schoolId,
  });

  @override
  State<PaymentDialog> createState() => _PaymentDialogState();
}

class _PaymentDialogState extends State<PaymentDialog> {
  final _formKey = GlobalKey<FormState>();
  final DatabaseService _dbService = DatabaseService();

  // Controllers
  final TextEditingController _amountController = TextEditingController();
  final TextEditingController _payerController = TextEditingController();
  
  // State Variables
  String? _selectedStudentId; // Stores the valid UUID
  DateTime _selectedDate = DateTime.now();
  String _selectedMethod = 'Cash';
  String _selectedCategory = 'Tuition';
  bool _isLoading = false;

  // Constants
  final List<String> _methods = ['Cash', 'Bank Transfer', 'Mobile Money', 'Cheque'];
  final List<String> _categories = ['Tuition', 'Uniform', 'Levy', 'Transport', 'Donation'];

  @override
  void dispose() {
    _amountController.dispose();
    _payerController.dispose();
    super.dispose();
  }

  Future<void> _savePayment() async {
    if (!_formKey.currentState!.validate()) return;
    
    // Validation: Ensure a student was actually selected from the list
    if (_selectedStudentId == null) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text('Please search and select a valid student from the list'), 
          backgroundColor: Colors.red
        ),
      );
      return;
    }

    setState(() => _isLoading = true);

    try {
      final newId = const Uuid().v4();
      final amount = double.tryParse(_amountController.text) ?? 0.0;

      final paymentData = {
        'id': newId,
        'school_id': widget.schoolId,
        'student_id': _selectedStudentId, // Valid UUID from autocomplete
        'amount': amount,
        'date_paid': DateFormat('yyyy-MM-dd').format(_selectedDate),
        'category': _selectedCategory,
        'payer_name': _payerController.text.trim(),
        'method': _selectedMethod,
        'created_at': DateTime.now().toIso8601String(),
      };

      await _dbService.insert('payments', paymentData);

      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
            content: Text('Payment recorded successfully!'),
            backgroundColor: Colors.green,
          ),
        );
        Navigator.of(context).pop(); 
      }
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text('Error: $e'), backgroundColor: Colors.red),
        );
      }
    } finally {
      if (mounted) setState(() => _isLoading = false);
    }
  }

  @override
  Widget build(BuildContext context) {
    const bgColor = Color(0xFF151718);
    const surfaceColor = Color(0xFF1F2227);
    const inputColor = Color(0xFF2A2D35);
    const primaryBlue = Color(0xFF3B82F6);
    const textWhite = Colors.white;
    const textGrey = Color(0xFF9CA3AF);

    return Dialog(
      backgroundColor: bgColor,
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
      child: Container(
        width: 1100,
        height: 700,
        padding: const EdgeInsets.all(24),
        child: Column(
          children: [
            // --- HEADER ---
            Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                Row(
                  children: [
                    Container(
                      padding: const EdgeInsets.all(8),
                      decoration: BoxDecoration(
                        color: primaryBlue.withAlpha(51),
                        borderRadius: BorderRadius.circular(8),
                      ),
                      child: const Icon(Icons.account_balance_wallet, color: primaryBlue),
                    ),
                    const SizedBox(width: 12),
                    const Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text("Manage Payments", style: TextStyle(color: textWhite, fontSize: 18, fontWeight: FontWeight.bold)),
                        Text("Record incoming fees and track recent transactions", style: TextStyle(color: textGrey, fontSize: 12)),
                      ],
                    ),
                  ],
                ),
                IconButton(
                  onPressed: () => Navigator.pop(context),
                  icon: const Icon(Icons.close, color: textGrey),
                ),
              ],
            ),
            const Divider(color: Color(0xFF2E323A), height: 40),
            
            // --- BODY (Split View) ---
            Expanded(
              child: Row(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  // --- LEFT: FORM SECTION ---
                  Expanded(
                    flex: 4,
                    child: Form(
                      key: _formKey,
                      child: SingleChildScrollView(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            const Text("NEW PAYMENT ENTRY", style: TextStyle(color: textGrey, fontSize: 11, fontWeight: FontWeight.bold, letterSpacing: 1.0)),
                            const SizedBox(height: 20),

                            // --- SEARCHABLE STUDENT FIELD ---
                            _buildLabel("Student (Search Name or ID)"),
                            StreamBuilder<List<Map<String, dynamic>>>(
                              stream: _dbService.watchStudents(widget.schoolId),
                              builder: (context, snapshot) {
                                if (!snapshot.hasData) {
                                  return const LinearProgressIndicator(color: primaryBlue, backgroundColor: inputColor);
                                }
                                
                                final students = snapshot.data!;
                                
                                return LayoutBuilder(
                                  builder: (context, constraints) {
                                    return Autocomplete<Map<String, dynamic>>(
                                      optionsBuilder: (TextEditingValue textEditingValue) {
                                        // Filter logic
                                        if (textEditingValue.text.isEmpty) {
                                          return students; // Return all if empty
                                        }
                                        return students.where((student) {
                                          final name = student['full_name'].toString().toLowerCase();
                                          final id = (student['student_id'] ?? '').toString().toLowerCase();
                                          final query = textEditingValue.text.toLowerCase();
                                          return name.contains(query) || id.contains(query);
                                        });
                                      },
                                      displayStringForOption: (Map<String, dynamic> option) => 
                                          "${option['full_name']} (${option['student_id'] ?? 'N/A'})",
                                      
                                      onSelected: (Map<String, dynamic> selection) {
                                        setState(() {
                                          _selectedStudentId = selection['id']; // Store UUID
                                        });
                                      },

                                      // The Input Field
                                      fieldViewBuilder: (context, textEditingController, focusNode, onFieldSubmitted) {
                                        return TextFormField(
                                          controller: textEditingController,
                                          focusNode: focusNode,
                                          style: const TextStyle(color: Colors.white),
                                          decoration: InputDecoration(
                                            filled: true,
                                            fillColor: inputColor,
                                            hintText: "Type to search...",
                                            hintStyle: const TextStyle(color: Colors.white24),
                                            prefixIcon: const Icon(Icons.search, color: Colors.white24, size: 20),
                                            border: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: BorderSide.none),
                                            enabledBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: BorderSide(color: Colors.white.withAlpha(10))),
                                            focusedBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: primaryBlue)),
                                          ),
                                          // Clear ID if user types something new without selecting
                                          onChanged: (text) {
                                            if (_selectedStudentId != null) {
                                              // Optional: clear selection if they start typing again
                                              // setState(() => _selectedStudentId = null);
                                            }
                                          },
                                        );
                                      },

                                      // The Dropdown List Styling
                                      optionsViewBuilder: (context, onSelected, options) {
                                        return Align(
                                          alignment: Alignment.topLeft,
                                          child: Material(
                                            color: surfaceColor,
                                            elevation: 4.0,
                                            borderRadius: const BorderRadius.vertical(bottom: Radius.circular(8)),
                                            child: Container(
                                              width: constraints.maxWidth, // Match field width
                                              constraints: const BoxConstraints(maxHeight: 250),
                                              child: ListView.builder(
                                                padding: EdgeInsets.zero,
                                                itemCount: options.length,
                                                itemBuilder: (BuildContext context, int index) {
                                                  final Map<String, dynamic> option = options.elementAt(index);
                                                  return ListTile(
                                                    title: Text(option['full_name'], style: const TextStyle(color: Colors.white)),
                                                    subtitle: Text(option['student_id'] ?? 'No ID', style: const TextStyle(color: textGrey, fontSize: 12)),
                                                    onTap: () => onSelected(option),
                                                    hoverColor: Colors.white.withAlpha(10),
                                                    tileColor: Colors.transparent,
                                                  );
                                                },
                                              ),
                                            ),
                                          ),
                                        );
                                      },
                                    );
                                  }
                                );
                              },
                            ),
                            const SizedBox(height: 16),

                            // Amount & Date Row
                            Row(
                              children: [
                                Expanded(
                                  child: Column(
                                    crossAxisAlignment: CrossAxisAlignment.start,
                                    children: [
                                      _buildLabel("Amount"),
                                      _buildTextInput(
                                        controller: _amountController, 
                                        hint: "0.00", 
                                        color: inputColor,
                                        isNumber: true,
                                        prefix: const Padding(
                                          padding: EdgeInsets.all(12.0),
                                          child: Text("\$", style: TextStyle(color: Colors.white70)),
                                        )
                                      ),
                                    ],
                                  ),
                                ),
                                const SizedBox(width: 16),
                                Expanded(
                                  child: Column(
                                    crossAxisAlignment: CrossAxisAlignment.start,
                                    children: [
                                      _buildLabel("Payment Date"),
                                      GestureDetector(
                                        onTap: () async {
                                          final picked = await showDatePicker(
                                            context: context,
                                            initialDate: _selectedDate,
                                            firstDate: DateTime(2020),
                                            lastDate: DateTime.now().add(const Duration(days: 30)),
                                            builder: (context, child) {
                                              return Theme(
                                                data: ThemeData.dark().copyWith(
                                                  colorScheme: const ColorScheme.dark(
                                                    primary: primaryBlue,
                                                    onPrimary: Colors.white,
                                                    surface: surfaceColor,
                                                    onSurface: Colors.white,
                                                  ),
                                                ),
                                                child: child!,
                                              );
                                            },
                                          );
                                          if (picked != null) setState(() => _selectedDate = picked);
                                        },
                                        child: Container(
                                          padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 14),
                                          decoration: BoxDecoration(
                                            color: inputColor,
                                            borderRadius: BorderRadius.circular(8),
                                            border: Border.all(color: Colors.white10),
                                          ),
                                          child: Row(
                                            mainAxisAlignment: MainAxisAlignment.spaceBetween,
                                            children: [
                                              Text(DateFormat('MMM dd, yyyy').format(_selectedDate), style: const TextStyle(color: Colors.white)),
                                              const Icon(Icons.calendar_today, size: 16, color: textGrey),
                                            ],
                                          ),
                                        ),
                                      ),
                                    ],
                                  ),
                                ),
                              ],
                            ),
                            const SizedBox(height: 16),

                            // Category & Method Row
                            Row(
                              children: [
                                Expanded(
                                  child: Column(
                                    crossAxisAlignment: CrossAxisAlignment.start,
                                    children: [
                                      _buildLabel("Category"),
                                      _buildDropdown(
                                        value: _selectedCategory,
                                        items: _categories,
                                        onChanged: (v) => setState(() => _selectedCategory = v!),
                                        color: inputColor,
                                      ),
                                    ],
                                  ),
                                ),
                                const SizedBox(width: 16),
                                Expanded(
                                  child: Column(
                                    crossAxisAlignment: CrossAxisAlignment.start,
                                    children: [
                                      _buildLabel("Payment Method"),
                                      _buildDropdown(
                                        value: _selectedMethod,
                                        items: _methods,
                                        onChanged: (v) => setState(() => _selectedMethod = v!),
                                        color: inputColor,
                                      ),
                                    ],
                                  ),
                                ),
                              ],
                            ),
                            const SizedBox(height: 16),

                            // Payer Name
                            _buildLabel("Payer Name (Parent/Guardian)"),
                            _buildTextInput(
                              controller: _payerController, 
                              hint: "e.g. Mr. Smith", 
                              color: inputColor,
                              icon: Icons.person_outline
                            ),
                            
                            const SizedBox(height: 40),
                            
                            // Action Buttons
                            Row(
                              mainAxisAlignment: MainAxisAlignment.end,
                              children: [
                                TextButton(
                                  onPressed: () => Navigator.pop(context),
                                  child: const Text("Cancel", style: TextStyle(color: textGrey)),
                                ),
                                const SizedBox(width: 12),
                                ElevatedButton.icon(
                                  onPressed: _isLoading ? null : _savePayment,
                                  icon: _isLoading 
                                    ? const SizedBox(width: 16, height: 16, child: CircularProgressIndicator(strokeWidth: 2, color: Colors.white)) 
                                    : const Icon(Icons.check, size: 18),
                                  label: const Text("Save Payment"),
                                  style: ElevatedButton.styleFrom(
                                    backgroundColor: primaryBlue,
                                    foregroundColor: Colors.white,
                                    padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 16),
                                    shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
                                  ),
                                ),
                              ],
                            )
                          ],
                        ),
                      ),
                    ),
                  ),

                  // Separator
                  Container(width: 1, color: const Color(0xFF2E323A), margin: const EdgeInsets.symmetric(horizontal: 32)),

                  // --- RIGHT: LIST SECTION ---
                  Expanded(
                    flex: 3,
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Row(
                          mainAxisAlignment: MainAxisAlignment.spaceBetween,
                          children: [
                            const Text("RECENT PAYMENTS", style: TextStyle(color: textGrey, fontSize: 11, fontWeight: FontWeight.bold, letterSpacing: 1.0)),
                            // Total Calculator
                            StreamBuilder<List<Map<String, dynamic>>>(
                              stream: _dbService.watchAll('payments'), 
                              builder: (context, snapshot) {
                                if (!snapshot.hasData) return const Text("\$0.00", style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold));
                                double total = 0;
                                for(var p in snapshot.data!) {
                                  total += (p['amount'] as num?)?.toDouble() ?? 0.0;
                                }
                                return Text("Total: \$${total.toStringAsFixed(2)}", style: const TextStyle(color: Colors.white, fontWeight: FontWeight.bold));
                              }
                            ),
                          ],
                        ),
                        const SizedBox(height: 20),

                        // List of Payments
                        Expanded(
                          child: StreamBuilder<List<Map<String, dynamic>>>(
                            stream: _dbService.watchAll('payments'),
                            builder: (context, snapshot) {
                              if (snapshot.connectionState == ConnectionState.waiting) {
                                return const Center(child: CircularProgressIndicator());
                              }
                              
                              final payments = snapshot.data ?? [];
                              
                              if (payments.isEmpty) {
                                return Center(
                                  child: Column(
                                    mainAxisAlignment: MainAxisAlignment.center,
                                    children: [
                                      Icon(Icons.receipt_long, size: 48, color: textGrey.withAlpha(51)),
                                      const SizedBox(height: 12),
                                      const Text("No payments recorded yet", style: TextStyle(color: textGrey)),
                                    ],
                                  ),
                                );
                              }

                              return ListView.separated(
                                itemCount: payments.length,
                                separatorBuilder: (_, __) => const SizedBox(height: 12),
                                itemBuilder: (context, index) {
                                  final payment = payments[index];
                                  final amount = (payment['amount'] as num?)?.toDouble() ?? 0.0;
                                  final dateStr = payment['date_paid'] ?? '';
                                  final payer = payment['payer_name'] ?? 'Unknown Payer';
                                  final method = payment['method'] ?? 'Cash';

                                  return Container(
                                    padding: const EdgeInsets.all(12),
                                    decoration: BoxDecoration(
                                      color: surfaceColor,
                                      borderRadius: BorderRadius.circular(12),
                                      border: Border.all(color: Colors.white.withAlpha(10)),
                                    ),
                                    child: Row(
                                      children: [
                                        // Icon Box
                                        Container(
                                          width: 40, height: 40,
                                          decoration: BoxDecoration(
                                            color: _getMethodColor(method).withAlpha(30),
                                            borderRadius: BorderRadius.circular(8),
                                          ),
                                          child: Icon(
                                            _getMethodIcon(method),
                                            color: _getMethodColor(method),
                                            size: 20,
                                          ),
                                        ),
                                        const SizedBox(width: 12),
                                        
                                        // Details
                                        Expanded(
                                          child: Column(
                                            crossAxisAlignment: CrossAxisAlignment.start,
                                            children: [
                                              Text(payer, style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600, fontSize: 14)),
                                              const SizedBox(height: 2),
                                              Text("$method • $dateStr", style: const TextStyle(color: textGrey, fontSize: 12)),
                                            ],
                                          ),
                                        ),

                                        // Amount
                                        Text(
                                          "+\$${amount.toStringAsFixed(2)}",
                                          style: const TextStyle(color: Color(0xFF4ADE80), fontWeight: FontWeight.bold, fontSize: 14),
                                        ),
                                      ],
                                    ),
                                  );
                                },
                              );
                            },
                          ),
                        ),
                      ],
                    ),
                  ),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }

  // --- WIDGET BUILDERS ---

  Widget _buildLabel(String text) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 8.0),
      child: Text(text, style: const TextStyle(color: Color(0xFF9CA3AF), fontSize: 12)),
    );
  }

  Widget _buildTextInput({
    required TextEditingController controller, 
    required String hint, 
    required Color color,
    bool isNumber = false,
    Widget? prefix,
    IconData? icon
  }) {
    return TextFormField(
      controller: controller,
      keyboardType: isNumber ? const TextInputType.numberWithOptions(decimal: true) : TextInputType.text,
      style: const TextStyle(color: Colors.white),
      validator: (val) => val == null || val.isEmpty ? 'Required' : null,
      decoration: InputDecoration(
        filled: true,
        fillColor: color,
        hintText: hint,
        hintStyle: const TextStyle(color: Colors.white24),
        prefixIcon: icon != null ? Icon(icon, color: Colors.white24, size: 20) : prefix,
        border: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: BorderSide.none),
        enabledBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: BorderSide(color: Colors.white.withAlpha(10))),
        focusedBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: Color(0xFF3B82F6))),
      ),
    );
  }

  Widget _buildDropdown({
    required String value,
    required List<String> items,
    required Function(String?) onChanged,
    required Color color,
  }) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 12),
      decoration: BoxDecoration(
        color: color,
        borderRadius: BorderRadius.circular(8),
        border: Border.all(color: Colors.white.withAlpha(10)),
      ),
      child: DropdownButtonHideUnderline(
        child: DropdownButton<String>(
          value: value,
          dropdownColor: const Color(0xFF1F2227),
          icon: const Icon(Icons.keyboard_arrow_down, color: Colors.white54),
          isExpanded: true,
          style: const TextStyle(color: Colors.white),
          items: items.map((String val) {
            return DropdownMenuItem<String>(
              value: val,
              child: Text(val),
            );
          }).toList(),
          onChanged: onChanged,
        ),
      ),
    );
  }

  // --- HELPERS ---

  Color _getMethodColor(String method) {
    switch (method.toLowerCase()) {
      case 'cash': return const Color(0xFF4ADE80);
      case 'bank transfer': return const Color(0xFF3B82F6);
      case 'mobile money': return const Color(0xFFF59E0B);
      default: return Colors.purple;
    }
  }

  IconData _getMethodIcon(String method) {
    switch (method.toLowerCase()) {
      case 'cash': return Icons.attach_money;
      case 'bank transfer': return Icons.account_balance;
      case 'mobile money': return Icons.phone_android;
      default: return Icons.credit_card;
    }
  }
}import 'package:fees_up/mobile/screens/auth/mobile_signup_screen.dart';
import 'package:flutter/material.dart';
// For PC, we usually want a split screen: Branding on Left, Form on Right.
// Since the user asked for "Setup School" specifically based on the image:
// I will wrap the Mobile Form in a Center Card for PC to match the uploaded image style exactly but centered.

class PCSignupScreen extends StatelessWidget {
  const PCSignupScreen({super.key});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Container(
        decoration: const BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topLeft,
            end: Alignment.bottomRight,
            colors: [Color(0xFF0F172A), Color(0xFF020617)],
          ),
        ),
        child: Center(
          child: ConstrainedBox(
            constraints: const BoxConstraints(maxWidth: 500, maxHeight: 900),
            child: const Card(
              color: Colors.transparent, 
              elevation: 0,
              // We reuse the MobileSignupScreen logic/UI because the "Setup School" 
              // image provided is vertical and works perfectly inside a PC center card.
              child: ClipRRect(
                borderRadius: BorderRadius.all(Radius.circular(20)),
                child: MobileAuthScreen(), 
              ),
            ),
          ),
        ),
      ),
    );
  }
}import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:intl/intl.dart';
import '../../core/constants/app_colors.dart';
import '../../data/providers/dashboard_provider.dart';
import '../../data/providers/fundraising_provider.dart';
import '../widgets/dashboard/sidebar.dart';
import '../widgets/dashboard/stat_cards.dart';
import '../widgets/dashboard/revenue_chart.dart';
import '../widgets/dashboard/quick_actions_grid.dart';
import '../widgets/dashboard/payment_dialog.dart'; 
import '../widgets/dashboard/student_dialog.dart';

class PCHomeScreen extends ConsumerWidget {
  const PCHomeScreen({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final dashboardAsync = ref.watch(dashboardDataProvider);
    final fundraisingAsync = ref.watch(fundraisingProvider);

    return Scaffold(
      backgroundColor: AppColors.backgroundBlack,
      body: Row(
        children: [
          const DashboardSidebar(),
          Expanded(
            child: dashboardAsync.when(
              loading: () => const Center(child: CircularProgressIndicator()),
              error: (err, stack) => Center(child: Text("Error: $err", style: const TextStyle(color: Colors.white))),
              data: (data) => Column(
                children: [
                  _buildTopBar(data.userName, data.schoolName),

                  Expanded(
                    child: SingleChildScrollView(
                      padding: const EdgeInsets.all(24),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          // --- HEADER ---
                          Row(
                            mainAxisAlignment: MainAxisAlignment.spaceBetween,
                            children: [
                              Column(
                                crossAxisAlignment: CrossAxisAlignment.start,
                                children: [
                                  const Text("Overview", style: TextStyle(fontSize: 28, fontWeight: FontWeight.bold, color: Colors.white)),
                                  Text("Status for ${data.schoolName}", style: const TextStyle(color: Colors.white54)),
                                ],
                              ),
                            ],
                          ),

                          const SizedBox(height: 24),

                          // --- KPI CARDS ROW ---
                          SizedBox(
                            height: 160, 
                            child: Row(
                              crossAxisAlignment: CrossAxisAlignment.stretch, 
                              children: [
                                StatCard(
                                  title: "Outstanding Bills",
                                  value: NumberFormat.simpleCurrency().format(data.outstandingBalance),
                                  icon: Icons.receipt_long,
                                  iconColor: AppColors.errorRed,
                                  iconBgColor: const Color(0x22CF6679),
                                  isAlert: data.outstandingBalance > 0,
                                  footer: const AlertBadge(text: "Updated", subText: "Just now"),
                                ),
                                const SizedBox(width: 24),
                                
                                // Dynamic Fundraising Card
                                fundraisingAsync.when(
                                  loading: () => const Expanded(child: Center(child: CircularProgressIndicator())),
                                  error: (_,__) => const Expanded(child: SizedBox()), 
                                  data: (fundData) {
                                    if (fundData == null) {
                                      return const StatCard(
                                        title: "No Active Campaign",
                                        value: "-",
                                        icon: Icons.volunteer_activism,
                                        iconColor: Colors.grey,
                                        iconBgColor: Colors.white10,
                                      );
                                    }
                                    return StatCard(
                                      title: fundData.campaignName, 
                                      value: "${fundData.percentage.toStringAsFixed(1)}%", 
                                      icon: Icons.volunteer_activism,
                                      iconColor: const Color(0xFFA855F7),
                                      iconBgColor: const Color(0x22A855F7),
                                      footer: Text(
                                        "Raised \$${fundData.raisedAmount.toInt()} of \$${fundData.goalAmount.toInt()}",
                                        style: const TextStyle(color: Colors.white38, fontSize: 11)
                                      ),
                                    );
                                  }
                                ),
                                
                                const SizedBox(width: 24),
                                StatCard(
                                  title: "Active Students",
                                  value: data.studentCount.toString(),
                                  icon: Icons.school,
                                  iconColor: AppColors.primaryBlue,
                                  iconBgColor: const Color(0x222962FF),
                                  footer: const Text("Enrolled", style: TextStyle(color: Colors.white38, fontSize: 11)),
                                ),
                              ],
                            ),
                          ),

                          const SizedBox(height: 24),

                          // --- CHART & ACTIONS ROW ---
                          SizedBox(
                            height: 340,
                            child: Row(
                              crossAxisAlignment: CrossAxisAlignment.stretch,
                              children: [
                                const Expanded(flex: 2, child: RevenueChart()),
                                const SizedBox(width: 24),
                                Expanded(
                                  flex: 1, 
                                  child: QuickActionsGrid(
                                    onActionSelected: (type) => _handleQuickAction(context, type, data.schoolId),
                                  ),
                                ),
                              ],
                            ),
                          ),

                          const SizedBox(height: 24),

                          // --- RECENT PAYMENTS LIST (Restored) ---
                          Container(
                            padding: const EdgeInsets.all(24),
                            decoration: BoxDecoration(
                              color: AppColors.surfaceGrey,
                              borderRadius: BorderRadius.circular(16),
                              border: Border.all(color: Colors.white10),
                            ),
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                const Text("Recent Payments", style: TextStyle(color: Colors.white, fontSize: 18, fontWeight: FontWeight.bold)),
                                const SizedBox(height: 16),
                                
                                if (data.recentPayments.isEmpty)
                                  const Padding(
                                    padding: EdgeInsets.all(20.0),
                                    child: Text("No recent payments found.", style: TextStyle(color: Colors.white54)),
                                  )
                                else
                                  ...data.recentPayments.map((payment) {
                                    return Column(
                                      children: [
                                        _buildPaymentRow(
                                          payment['payer_name'] ?? 'Unknown',
                                          payment['date_paid'] != null 
                                              ? DateFormat('MMM d, yyyy').format(DateTime.parse(payment['date_paid'])) 
                                              : 'Unknown Date',
                                          payment['category'] ?? 'Fee',
                                          NumberFormat.simpleCurrency().format(payment['amount']),
                                          true,
                                        ),
                                        const Divider(color: Colors.white10),
                                      ],
                                    );
                                  }),
                              ],
                            ),
                          ),
                        ],
                      ),
                    ),
                  ),
                ],
              ),
            ),
          ),
        ],
      ),
    );
  }

  void _handleQuickAction(BuildContext context, QuickActionType type, String schoolId) {
    switch (type) {
      case QuickActionType.recordPayment:
        showDialog(
          context: context,
          barrierDismissible: false,
          barrierColor: Colors.black54,
          builder: (context) => PaymentDialog(schoolId: schoolId),
        );
        break;
      case QuickActionType.addExpense:
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(content: Text("Expense Dialog coming soon!"), backgroundColor: AppColors.surfaceGrey),
        );
        break;
      case QuickActionType.registerStudent:
         showDialog(
          context: context,
          barrierDismissible: false,
          barrierColor: Colors.black54,
          builder: (context) => StudentDialog(schoolId: schoolId),
        );
         break;
      case QuickActionType.createCampaign:
         break;
    }
  }

  Widget _buildTopBar(String userName, String schoolName) {
    return Container(
      height: 70,
      padding: const EdgeInsets.symmetric(horizontal: 24),
      decoration: const BoxDecoration(border: Border(bottom: BorderSide(color: Colors.white10))),
      child: Row(
        children: [
          const Text("Financial Dashboard", style: TextStyle(color: Colors.white, fontSize: 18, fontWeight: FontWeight.bold)),
          const Spacer(),
          Column(
            mainAxisAlignment: MainAxisAlignment.center,
            crossAxisAlignment: CrossAxisAlignment.end,
            children: [
              Text(userName, style: const TextStyle(color: Colors.white, fontWeight: FontWeight.bold, fontSize: 13)),
              Text(schoolName, style: const TextStyle(color: Colors.white54, fontSize: 11)),
            ],
          ),
          const SizedBox(width: 12),
          CircleAvatar(
            backgroundColor: Colors.white24, 
            child: Text(userName.isNotEmpty ? userName[0] : "U", style: const TextStyle(color: Colors.white, fontSize: 12))
          ),
        ],
      ),
    );
  }
  
  Widget _buildPaymentRow(String name, String date, String desc, String amount, bool isPaid) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 12),
      child: Row(
        children: [
          const CircleAvatar(radius: 16, backgroundColor: Colors.white10, child: Icon(Icons.person, size: 16, color: Colors.white54)),
          const SizedBox(width: 12),
          Expanded(flex: 2, child: Column(crossAxisAlignment: CrossAxisAlignment.start, children: [Text(name, style: const TextStyle(color: Colors.white)), Text(date, style: const TextStyle(color: Colors.white38, fontSize: 12))])),
          Expanded(flex: 3, child: Text(desc, style: const TextStyle(color: Colors.white70))),
          Expanded(flex: 1, child: Text(amount, style: const TextStyle(color: Colors.white, fontWeight: FontWeight.bold))),
          Container(
            padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
            decoration: BoxDecoration(
              color: isPaid ? AppColors.successGreen.withAlpha(51) : Colors.orange.withAlpha(51),
              borderRadius: BorderRadius.circular(4),
            ),
            child: Text(
              isPaid ? "Paid" : "Pending",
              style: TextStyle(color: isPaid ? AppColors.successGreen : Colors.orange, fontSize: 11, fontWeight: FontWeight.bold),
            ),
          ),
        ],
      ),
    );
  }
}import 'package:flutter/material.dart';

class ResponsiveLayout extends StatelessWidget {
  final Widget mobileScaffold;
  final Widget pcScaffold;

  // Standard breakpoint: Tablets usually go up to 768px or 1024px.
  // We will treat anything above 850px as PC to accommodate larger tablets/landscape.
  static const double pcBreakpoint = 850.0;

  const ResponsiveLayout({
    super.key,
    required this.mobileScaffold,
    required this.pcScaffold,
  });

  @override
  Widget build(BuildContext context) {
    return LayoutBuilder(
      builder: (context, constraints) {
        if (constraints.maxWidth < pcBreakpoint) {
          return mobileScaffold;
        } else {
          return pcScaffold;
        }
      },
    );
  }
}import 'package:flutter/material.dart';
import '../../../core/constants/app_colors.dart';

// 1. CAROUSEL CARD (Fixed width for horizontal scrolling)
class MobileStatCard extends StatelessWidget {
  final String title;
  final String value;
  final IconData icon;
  final Color iconColor;
  final Color iconBgColor;
  final bool isAlert;
  final Widget? footer;

  const MobileStatCard({
    super.key,
    required this.title,
    required this.value,
    required this.icon,
    required this.iconColor,
    required this.iconBgColor,
    this.isAlert = false,
    this.footer,
  });

  @override
  Widget build(BuildContext context) {
    return Container(
      width: 280, // Fixed width for mobile carousel
      margin: const EdgeInsets.only(right: 12),
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(16),
        border: isAlert 
            ? const Border(left: BorderSide(color: AppColors.errorRed, width: 4))
            : Border.all(color: Colors.white10),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Text(
                title.toUpperCase(),
                style: const TextStyle(color: Colors.white54, fontSize: 11, fontWeight: FontWeight.bold),
              ),
              Container(
                padding: const EdgeInsets.all(8),
                decoration: BoxDecoration(color: iconBgColor, borderRadius: BorderRadius.circular(8)),
                child: Icon(icon, size: 16, color: iconColor),
              ),
            ],
          ),
          const SizedBox(height: 12),
          Text(
            value,
            style: const TextStyle(color: Colors.white, fontSize: 26, fontWeight: FontWeight.bold),
          ),
          const SizedBox(height: 12),
          if (footer != null) footer!,
        ],
      ),
    );
  }
}

// 2. QUICK ACTION BUTTON (Mobile Grid Style)
class MobileQuickAction extends StatelessWidget {
  final IconData icon;
  final String label;
  final VoidCallback onTap;
  final bool isPrimary;

  const MobileQuickAction({
    super.key, 
    required this.icon, 
    required this.label, 
    required this.onTap,
    this.isPrimary = false,
  });

  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onTap: onTap,
      child: Container(
        decoration: BoxDecoration(
          color: isPrimary ? AppColors.primaryBlue : AppColors.surfaceGrey,
          borderRadius: BorderRadius.circular(16),
          border: Border.all(color: Colors.white10),
        ),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Icon(
              icon, 
              size: 28, 
              color: isPrimary ? Colors.white : AppColors.primaryBlueLight
            ),
            const SizedBox(height: 8),
            Text(
              label,
              textAlign: TextAlign.center,
              style: TextStyle(
                color: isPrimary ? Colors.white : Colors.white70,
                fontSize: 12,
                fontWeight: FontWeight.bold,
              ),
            ),
          ],
        ),
      ),
    );
  }
}

// 3. TRANSACTION TILE (Compact List Item)
class MobileTransactionTile extends StatelessWidget {
  final String name;
  final String date;
  final String amount;
  final bool isPaid;

  const MobileTransactionTile({
    super.key,
    required this.name,
    required this.date,
    required this.amount,
    required this.isPaid,
  });

  @override
  Widget build(BuildContext context) {
    return Container(
      margin: const EdgeInsets.only(bottom: 12),
      padding: const EdgeInsets.all(12),
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: Colors.white.withAlpha(12)),
      ),
      child: Row(
        children: [
          CircleAvatar(
            backgroundColor: Colors.white10,
            radius: 20,
            child: Text(name[0], style: const TextStyle(color: Colors.white, fontWeight: FontWeight.bold)),
          ),
          const SizedBox(width: 12),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(name, style: const TextStyle(color: Colors.white, fontWeight: FontWeight.bold)),
                Text(date, style: const TextStyle(color: Colors.white38, fontSize: 12)),
              ],
            ),
          ),
          Column(
            crossAxisAlignment: CrossAxisAlignment.end,
            children: [
              Text(amount, style: const TextStyle(color: Colors.white, fontWeight: FontWeight.bold)),
              const SizedBox(height: 4),
              Container(
                padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                decoration: BoxDecoration(
                  color: isPaid ? AppColors.successGreen.withAlpha(51) : AppColors.errorRed.withAlpha(51),
                  borderRadius: BorderRadius.circular(4),
                ),
                child: Text(
                  isPaid ? "PAID" : "OWED",
                  style: TextStyle(
                    color: isPaid ? AppColors.successGreen : AppColors.errorRed,
                    fontSize: 10,
                    fontWeight: FontWeight.bold,
                  ),
                ),
              ),
            ],
          ),
        ],
      ),
    );
  }
}import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:go_router/go_router.dart';
import 'package:intl/intl.dart';
import '../../../core/constants/app_colors.dart';
import '../../data/providers/dashboard_provider.dart';
import '../widgets/dashboard/mobile_dashboard_widgets.dart';
import '../../pc/widgets/dashboard/stat_cards.dart'; 
// Removed unused import: revenue_chart.dart

class MobileHomeScreen extends ConsumerStatefulWidget {
  const MobileHomeScreen({super.key});

  @override
  ConsumerState<MobileHomeScreen> createState() => _MobileHomeScreenState();
}

class _MobileHomeScreenState extends ConsumerState<MobileHomeScreen> {
  
  // Calculate index based on current route for visual state
  int _calculateSelectedIndex(BuildContext context) {
    final String location = GoRouterState.of(context).uri.toString();
    if (location.startsWith('/transactions')) return 1;
    if (location.startsWith('/students')) return 2;
    if (location.startsWith('/profile')) return 3;
    return 0;
  }

  void _onItemTapped(int index) {
    switch (index) {
      case 0:
        context.go('/');
        break;
      case 1:
        context.go('/transactions');
        break;
      case 2:
        context.go('/students');
        break;
      case 3:
        context.go('/profile'); // We will add this mock route
        break;
    }
  }

  @override
  Widget build(BuildContext context) {
    final dashboardAsync = ref.watch(dashboardDataProvider);
    final int navIndex = _calculateSelectedIndex(context);

    return Scaffold(
      backgroundColor: AppColors.backgroundBlack,
      
      body: dashboardAsync.when(
        loading: () => const Center(child: CircularProgressIndicator()),
        error: (err, stack) => Center(child: Text("Error: $err", style: const TextStyle(color: Colors.white))),
        data: (data) => Scaffold( 
          backgroundColor: AppColors.backgroundBlack,
          
          appBar: AppBar(
            backgroundColor: AppColors.backgroundBlack,
            elevation: 0,
            title: Row(
              children: [
                CircleAvatar(
                  backgroundColor: AppColors.surfaceGrey,
                  radius: 18,
                  child: Text(data.userName.isNotEmpty ? data.userName[0] : "U", style: const TextStyle(fontSize: 12, color: Colors.white, fontWeight: FontWeight.bold)),
                ),
                const SizedBox(width: 12),
                Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text("Hello, ${data.userName.split(' ')[0]}", style: const TextStyle(fontSize: 14, fontWeight: FontWeight.bold, color: Colors.white)),
                    Text(data.schoolName, style: TextStyle(fontSize: 10, color: Colors.white.withAlpha(127))),
                  ],
                ),
              ],
            ),
            actions: [
              IconButton(onPressed: () {}, icon: const Icon(Icons.notifications_none, color: Colors.white)),
            ],
          ),

          body: SingleChildScrollView(
            padding: const EdgeInsets.all(16),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const Text("Dashboard", style: TextStyle(color: Colors.white, fontSize: 24, fontWeight: FontWeight.bold)),
                const SizedBox(height: 16),

                // KPI CARDS CAROUSEL
                SizedBox(
                  height: 170,
                  child: ListView(
                    scrollDirection: Axis.horizontal,
                    children: [
                      MobileStatCard(
                        title: "Outstanding",
                        value: NumberFormat.simpleCurrency().format(data.outstandingBalance),
                        icon: Icons.receipt_long,
                        iconColor: AppColors.errorRed,
                        iconBgColor: const Color(0x22CF6679),
                        isAlert: data.outstandingBalance > 0,
                        footer: const AlertBadge(text: "Live", subText: "Updated via Sync"),
                      ),
                      MobileStatCard(
                        title: "Students",
                        value: data.studentCount.toString(),
                        icon: Icons.school,
                        iconColor: AppColors.primaryBlue,
                        iconBgColor: const Color(0x222962FF),
                      ),
                    ],
                  ),
                ),

                const SizedBox(height: 24),

                // RECENT PAYMENTS LIST (Real Data)
                Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: [
                    const Text("Recent Transactions", style: TextStyle(color: Colors.white, fontSize: 16, fontWeight: FontWeight.bold)),
                    TextButton(onPressed: () {}, child: const Text("View All", style: TextStyle(fontSize: 12))),
                  ],
                ),
                
                if (data.recentPayments.isEmpty)
                  const Padding(
                    padding: EdgeInsets.only(top: 10),
                    child: Text("No transactions yet.", style: TextStyle(color: Colors.grey)),
                  ),

                ...data.recentPayments.map((payment) => MobileTransactionTile(
                  name: payment['payer_name'] ?? 'Unknown',
                  date: payment['date_paid'] != null 
                        ? DateFormat('MMM d, h:mm a').format(DateTime.parse(payment['date_paid'])) 
                        : '',
                  amount: NumberFormat.simpleCurrency().format(payment['amount']),
                  isPaid: true,
                )),
                
                const SizedBox(height: 80),
              ],
            ),
          ),
          
          // BOTTOM NAV
          bottomNavigationBar: Container(
            decoration: const BoxDecoration(border: Border(top: BorderSide(color: Colors.white10))),
            child: BottomNavigationBar(
              backgroundColor: AppColors.surfaceGrey,
              currentIndex: navIndex,
              onTap: _onItemTapped, // Triggers navigation
              selectedItemColor: AppColors.primaryBlue,
              unselectedItemColor: Colors.white38,
              type: BottomNavigationBarType.fixed,
              showUnselectedLabels: true,
              items: const [
                BottomNavigationBarItem(icon: Icon(Icons.grid_view_rounded), label: "Home"),
                BottomNavigationBarItem(icon: Icon(Icons.receipt_long_rounded), label: "Transact"),
                BottomNavigationBarItem(icon: Icon(Icons.school_outlined), label: "Students"),
                BottomNavigationBarItem(icon: Icon(Icons.person_outline), label: "Profile"),
              ],
            ),
          ),
        ),
      ),
    );
  }
}import 'package:fees_up/data/providers/auth_provider.dart';
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:supabase_flutter/supabase_flutter.dart';
import '../../../core/constants/app_colors.dart';

class MobileAuthScreen extends ConsumerStatefulWidget {
  final bool initialIsLogin; // Allows routing to start in specific mode
  const MobileAuthScreen({super.key, this.initialIsLogin = true});

  @override
  ConsumerState<MobileAuthScreen> createState() => _MobileAuthScreenState();
}

class _MobileAuthScreenState extends ConsumerState<MobileAuthScreen> {
  final _formKey = GlobalKey<FormState>();
  
  // Controllers
  final _emailController = TextEditingController();
  final _passwordController = TextEditingController();
  final _nameController = TextEditingController(); // Signup only
  final _schoolNameController = TextEditingController(); // Signup only

  late bool _isLogin;
  bool _isLoading = false;
  bool _isObscure = true;

  @override
  void initState() {
    super.initState();
    _isLogin = widget.initialIsLogin;
  }

  Future<void> _handleAuth() async {
    if (!_formKey.currentState!.validate()) return;

    setState(() => _isLoading = true);
    try {
      final authRepo = ref.read(authRepositoryProvider);

      if (_isLogin) {
        // --- LOG IN LOGIC ---
        await Supabase.instance.client.auth.signInWithPassword(
          email: _emailController.text.trim(),
          password: _passwordController.text.trim(),
        );
      } else {
        // --- SIGN UP LOGIC ---
        await authRepo.signUpWithSchool(
          fullName: _nameController.text.trim(),
          email: _emailController.text.trim(),
          password: _passwordController.text.trim(),
          schoolName: _schoolNameController.text.trim(),
        );
      }
      
      // Router listener in app_router.dart will handle the redirect
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text(e.toString()), backgroundColor: AppColors.errorRed),
        );
      }
    } finally {
      if (mounted) setState(() => _isLoading = false);
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Container(
        decoration: const BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
            colors: [Color(0xFF0F172A), Color(0xFF020617)],
          ),
        ),
        child: SafeArea(
          child: Center(
            child: SingleChildScrollView(
              padding: const EdgeInsets.symmetric(horizontal: 24.0, vertical: 16),
              child: Form(
                key: _formKey,
                child: Column(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    // --- HEADER ---
                    Container(
                      padding: const EdgeInsets.all(16),
                      decoration: BoxDecoration(
                        color: const Color(0xFF0F3946),
                        borderRadius: BorderRadius.circular(20),
                        border: Border.all(color: Colors.white10),
                      ),
                      child: Icon(
                        _isLogin ? Icons.lock_open : Icons.security, 
                        size: 32, 
                        color: AppColors.successGreen
                      ),
                    ),
                    const SizedBox(height: 24),
                    Text(
                      _isLogin ? "Welcome Back" : "Setup School",
                      style: Theme.of(context).textTheme.headlineMedium?.copyWith(
                        color: Colors.white, fontWeight: FontWeight.bold
                      ),
                    ),
                    const SizedBox(height: 8),
                    Text(
                      _isLogin 
                        ? "Login to access your financial dashboard" 
                        : "Create admin account & school profile",
                      style: const TextStyle(color: Colors.grey),
                      textAlign: TextAlign.center,
                    ),
                    const SizedBox(height: 40),

                    // --- FORM FIELDS ---
                    
                    // Fields only for Sign Up
                    if (!_isLogin) ...[
                      _buildSectionLabel("ADMINISTRATOR"),
                      _buildTextField(
                        controller: _nameController,
                        icon: Icons.badge_outlined,
                        hint: "Admin Full Name",
                      ),
                      const SizedBox(height: 16),
                    ],

                    // Common Fields
                    _buildTextField(
                      controller: _emailController,
                      icon: Icons.email_outlined,
                      hint: "admin@school.edu",
                      inputType: TextInputType.emailAddress,
                    ),
                    const SizedBox(height: 16),
                    _buildTextField(
                      controller: _passwordController,
                      icon: Icons.lock_outline,
                      hint: "Password",
                      isPassword: true,
                      isObscure: _isObscure,
                      onToggleObscure: () => setState(() => _isObscure = !_isObscure),
                    ),

                    // School Name only for Sign Up
                    if (!_isLogin) ...[
                      const SizedBox(height: 32),
                      _buildSectionLabel("SCHOOL DETAILS"),
                      _buildTextField(
                        controller: _schoolNameController,
                        icon: Icons.school_outlined,
                        hint: "School Name",
                      ),
                    ],

                    const SizedBox(height: 40),

                    // --- SUBMIT BUTTON ---
                    SizedBox(
                      width: double.infinity,
                      height: 56,
                      child: ElevatedButton(
                        onPressed: _isLoading ? null : _handleAuth,
                        style: ElevatedButton.styleFrom(
                          backgroundColor: const Color(0xFF3B82F6),
                          shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                          elevation: 4,
                        ),
                        child: _isLoading 
                          ? const SizedBox(width: 24, height: 24, child: CircularProgressIndicator(color: Colors.white, strokeWidth: 2))
                          : Row(
                              mainAxisAlignment: MainAxisAlignment.center,
                              children: [
                                Text(
                                  _isLogin ? "Log In" : "Create School", 
                                  style: const TextStyle(fontSize: 16, fontWeight: FontWeight.bold, color: Colors.white)
                                ),
                                const SizedBox(width: 8),
                                const Icon(Icons.arrow_forward, color: Colors.white),
                              ],
                            ),
                      ),
                    ),

                    const SizedBox(height: 24),
                    
                    // --- TOGGLE MODE ---
                    Row(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        Text(
                          _isLogin ? "Don't have an account? " : "Already have an admin account? ", 
                          style: const TextStyle(color: Colors.grey)
                        ),
                        GestureDetector(
                          onTap: () {
                            setState(() {
                              _isLogin = !_isLogin;
                              _formKey.currentState?.reset(); // Clear errors
                            });
                          },
                          child: Text(
                            _isLogin ? "Create School" : "Log In", 
                            style: const TextStyle(color: Colors.white, fontWeight: FontWeight.bold, decoration: TextDecoration.underline)
                          ),
                        ),
                      ],
                    ),
                    const SizedBox(height: 40),
                  ],
                ),
              ),
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildSectionLabel(String label) {
    return Align(
      alignment: Alignment.centerLeft,
      child: Padding(
        padding: const EdgeInsets.only(bottom: 12.0),
        child: Text(
          label,
          style: const TextStyle(color: Color(0xFF3B82F6), fontWeight: FontWeight.bold, letterSpacing: 1.0, fontSize: 12),
        ),
      ),
    );
  }

  Widget _buildTextField({
    required TextEditingController controller,
    required IconData icon,
    required String hint,
    bool isPassword = false,
    bool isObscure = false,
    VoidCallback? onToggleObscure,
    TextInputType inputType = TextInputType.text,
  }) {
    return TextFormField(
      controller: controller,
      obscureText: isObscure,
      keyboardType: inputType,
      style: const TextStyle(color: Colors.white),
      decoration: InputDecoration(
        filled: true,
        fillColor: const Color(0xFF1E293B),
        hintText: hint,
        hintStyle: const TextStyle(color: Colors.white38),
        prefixIcon: Icon(icon, color: Colors.white54),
        suffixIcon: isPassword
            ? IconButton(
                icon: Icon(isObscure ? Icons.visibility_off : Icons.visibility, color: Colors.white54),
                onPressed: onToggleObscure,
              )
            : null,
        border: OutlineInputBorder(borderRadius: BorderRadius.circular(12), borderSide: BorderSide.none),
        focusedBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(12), borderSide: const BorderSide(color: Color(0xFF3B82F6), width: 1.5)),
      ),
      validator: (val) {
        if (val == null || val.isEmpty) return 'Required';
        if (isPassword && val.length < 6) return 'Min 6 chars';
        return null;
      },
    );
  }
}

// ==========================================
// FILE: ./core/theme/app_theme.dart
// ==========================================

import 'package:flutter/material.dart';
import '../constants/app_colors.dart';

class AppTheme {
  // Private constructor
  const AppTheme._();

  static ThemeData get darkTheme {
    return ThemeData(
      useMaterial3: true,
      brightness: Brightness.dark,
      primaryColor: AppColors.primaryBlue,
      scaffoldBackgroundColor: AppColors.backgroundBlack,
      
      // Color Scheme
      colorScheme: const ColorScheme.dark(
        primary: AppColors.primaryBlue,
        secondary: AppColors.primaryBlueLight,
        surface: AppColors.surfaceGrey,
        error: AppColors.errorRed,
        onPrimary: AppColors.textWhite,
        onSecondary: AppColors.backgroundBlack,
        onSurface: AppColors.textWhite,
        onError: AppColors.backgroundBlack,
      ),

      // AppBar Theme
      appBarTheme: const AppBarTheme(
        backgroundColor: AppColors.surfaceGrey,
        elevation: 0,
        centerTitle: false,
        iconTheme: IconThemeData(color: AppColors.textWhite),
        titleTextStyle: TextStyle(
          color: AppColors.textWhite,
          fontSize: 20,
          fontWeight: FontWeight.bold,
        ),
      ),

      // Card Theme
      cardTheme: CardThemeData(
        color: AppColors.surfaceGrey,
        elevation: 2,
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(12),
        ),
        margin: const EdgeInsets.symmetric(vertical: 8, horizontal: 16),
      ),

      // Button Themes
      elevatedButtonTheme: ElevatedButtonThemeData(
        style: ElevatedButton.styleFrom(
          backgroundColor: AppColors.primaryBlue,
          foregroundColor: AppColors.textWhite,
          padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 12),
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(8),
          ),
          elevation: 2,
        ),
      ),

      // Input Decoration Theme (TextFields)
      inputDecorationTheme: InputDecorationTheme(
        filled: true,
        fillColor: AppColors.surfaceLightGrey,
        border: OutlineInputBorder(
          borderRadius: BorderRadius.circular(8),
          borderSide: BorderSide.none,
        ),
        focusedBorder: OutlineInputBorder(
          borderRadius: BorderRadius.circular(8),
          borderSide: const BorderSide(
            color: AppColors.primaryBlue, 
            width: 2,
          ),
        ),
        errorBorder: OutlineInputBorder(
          borderRadius: BorderRadius.circular(8),
          borderSide: const BorderSide(
            color: AppColors.errorRed, 
            width: 1,
          ),
        ),
        labelStyle: const TextStyle(color: AppColors.textGrey),
        hintStyle: TextStyle(
          color: AppColors.textGrey.withAlpha(128), // Using withAlpha as requested
        ),
      ),
    );
  }
}
// ==========================================
// FILE: ./core/widgets/premium_guard.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';

// --- MOCK PROVIDER ---
// Toggle this to 'true' to simulate a paid account, 'false' for free tier.
// We keep it true for now so you can work without disturbance.
final isPremiumProvider = Provider<bool>((ref) => true); 

class PremiumGuard extends ConsumerWidget {
  final Widget child;
  final String featureName;

  const PremiumGuard({
    super.key, 
    required this.child,
    this.featureName = "This Feature",
  });

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final isPremium = ref.watch(isPremiumProvider);

    // If Premium, show the actual feature
    if (isPremium) {
      return child;
    }

    // If Limited, show the "Blank Canvas" / Upgrade Prompt
    return Stack(
      children: [
        // 1. Blurred/Disabled Child (Optional, or just hide it)
        Opacity(
          opacity: 0.1,
          child: AbsorbPointer(child: child),
        ),

        // 2. The Upgrade Overlay
        Center(
          child: Container(
            margin: const EdgeInsets.all(24),
            padding: const EdgeInsets.all(32),
            decoration: BoxDecoration(
              color: const Color(0xFF151718),
              borderRadius: BorderRadius.circular(24),
              border: Border.all(color: Colors.white10),
              boxShadow: [
                BoxShadow(
                  color: Colors.black.withAlpha((0.5*255) as int),
                  blurRadius: 30,
                  offset: const Offset(0, 10),
                )
              ],
            ),
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                const Icon(Icons.diamond_outlined, size: 48, color: Color(0xFFA855F7)), // Purple
                const SizedBox(height: 20),
                Text(
                  "Unlock $featureName",
                  style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.bold),
                ),
                const SizedBox(height: 12),
                const Text(
                  "This feature is available on the Unlimited Plan. \nUpgrade to remove limits.",
                  textAlign: TextAlign.center,
                  style: TextStyle(color: Colors.grey, height: 1.5),
                ),
                const SizedBox(height: 24),
                ElevatedButton(
                  onPressed: () {
                    // TODO: Navigate to Payment/Subscription Screen
                    ScaffoldMessenger.of(context).showSnackBar(
                      const SnackBar(content: Text("Subscription Flow Coming Soon")),
                    );
                  },
                  style: ElevatedButton.styleFrom(
                    backgroundColor: const Color(0xFFA855F7),
                    foregroundColor: Colors.white,
                    padding: const EdgeInsets.symmetric(horizontal: 32, vertical: 16),
                  ),
                  child: const Text("Get Unlimited Access"),
                ),
              ],
            ),
          ),
        ),
      ],
    );
  }
}
// ==========================================
// FILE: ./core/constants/app_constants.dart
// ==========================================

String appName = "Fees Up";
String appVersion = "1.0.0";
String defaultLanguage = "en";

// ==========================================
// FILE: ./core/constants/app_colors.dart
// ==========================================

import 'package:flutter/material.dart';

class AppColors {
  const AppColors._();

  // --- BRAND COLORS ---
  // A vivid, electric blue that pops against the slate background
  static const Color primaryBlue = Color(0xFF2962FF); 
  static const Color primaryBlueLight = Color(0xFF768FFF);
  static const Color primaryBlueDark = Color(0xFF0039CB);
  
  // A vibrant purple for secondary actions
  static const Color accentPurple = Color(0xFFA855F7); 
  static const Color accentPurpleLight = Color(0xFFD180FF);
  static const Color accentPurpleDark = Color(0xFFAA00FF);

  // --- BACKGROUNDS (The "Lively Slate" Theme) ---
  // Replaced muddy teal-blacks with deep, rich Slate Blue-Greys
  static const Color backgroundBlack = Color(0xFF0F172A); // Deepest Slate (Main BG)
  static const Color surfaceGrey = Color(0xFF1E293B);     // Card/Dialog Surface
  static const Color surfaceLightGrey = Color(0xFF334155); // Borders / Input Fills
  static const Color surfaceDarkGrey = Color(0xFF020617);  // Sidebar / Contrast Areas
  
  // --- TEXT COLORS ---
  static const Color textWhite = Color(0xFFF8FAFC); // Slightly off-white for less eye strain
  static const Color textWhite70 = Color(0xB3F8FAFC);
  static const Color textWhite54 = Color(0x8AF8FAFC);
  static const Color textWhite38 = Color(0x61F8FAFC);
  static const Color textGrey = Color(0xFF94A3B8); // Slate-tinted grey text

  // --- UI ELEMENTS ---
  static const Color divider = Color(0xFF334155); // Matching the surface light
  static const Color iconGrey = Color(0xFF64748B);
  static const Color overlayDark = Color(0xD9020617);

  // --- FUNCTIONAL COLORS ---
  // Adjusted to be slightly more vibrant to match the lively theme
  static const Color errorRed = Color(0xFFEF4444);
  static const Color successGreen = Color(0xFF10B981); // Emerald green
  static const Color warningOrange = Color(0xFFF59E0B); // Amber
  static const Color disabledGrey = Color(0xFF475569);

  // --- TRANSPARENT BACKGROUNDS ---
  // Perfect for chips and subtle highlights
  static const Color errorRedBg = Color(0x22EF4444);
  static const Color purpleBg = Color(0x22A855F7);
  static const Color primaryBlueBg = Color(0x222962FF);
  static const Color successGreenBg = Color(0x2210B981);
}
// ==========================================
// FILE: ./core/routes/app_router.dart
// ==========================================

import 'dart:async';

import 'package:fees_up/pc/screens/announcements_screen.dart';
import 'package:fees_up/pc/screens/invoices_screen.dart';
import 'package:fees_up/pc/screens/notifications_screen.dart'; // <--- WIRED
import 'package:fees_up/pc/screens/profile_screen.dart';
import 'package:fees_up/pc/screens/reports_screen.dart';
import 'package:fees_up/pc/screens/settings_screen.dart';
import 'package:fees_up/pc/screens/students_screen.dart';
import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:supabase_flutter/supabase_flutter.dart';

// --- LAYOUT & SHARED ---
import '../../../shared/layout/responsive_layout.dart';

// --- MOBILE SCREENS ---
import '../../mobile/screens/mobile_home_screen.dart';
import '../../mobile/screens/auth/mobile_signup_screen.dart';

// --- PC SCREENS ---
import '../../pc/screens/pc_home_screen.dart';
import '../../pc/screens/auth/pc_signup_screen.dart';
import '../../pc/screens/transactions_screen.dart';

final appRouterProvider = Provider<GoRouter>((ref) {
  return GoRouter(
    initialLocation: '/',
    debugLogDiagnostics: true,
    
    // 1. LISTEN TO AUTH CHANGES
    refreshListenable: GoRouterRefreshStream(Supabase.instance.client.auth.onAuthStateChange),
    
    // 2. REDIRECT LOGIC
    redirect: (context, state) {
      final session = Supabase.instance.client.auth.currentSession;
      final isAuthRoute = state.uri.toString() == '/login' || state.uri.toString() == '/signup';

      if (session == null) {
        return isAuthRoute ? null : '/login';
      }

      if (isAuthRoute) {
        return '/';
      }

      return null;
    },

    routes: [
      // -----------------------------------------------------------------------
      // CORE ROUTES
      // -----------------------------------------------------------------------
      
      // 1. HOME / OVERVIEW
      GoRoute(
        path: '/',
        builder: (context, state) => const ResponsiveLayout(
          mobileScaffold: MobileHomeScreen(),
          pcScaffold: PCHomeScreen(),
        ),
      ),

      // 2. TRANSACTIONS
      GoRoute(
        path: '/transactions',
        builder: (context, state) => const ResponsiveLayout(
          mobileScaffold: Scaffold(body: Center(child: Text("Mobile Transactions"))), 
          pcScaffold: TransactionsScreen(), 
        ),
      ),

      // -----------------------------------------------------------------------
      // FEATURE ROUTES
      // -----------------------------------------------------------------------
      
      // 3. INVOICES
      GoRoute(
        path: '/invoices',
        builder: (context, state) => const InvoicesScreen(),
      ),

      // 4. STUDENTS
      GoRoute(
        path: '/students',
        builder: (context, state) => const StudentsScreen(),
      ),

      // 5. REPORTS
      GoRoute(
        path: '/reports',
        builder: (context, state) => const ReportsScreen(),
      ),

      // -----------------------------------------------------------------------
      // MESSAGING ROUTES (Broadcasts & Notifications)
      // -----------------------------------------------------------------------
      
      // 6. ANNOUNCEMENTS (Broadcasts)
      GoRoute(
        path: '/announcements',
        builder: (context, state) => const AnnouncementsScreen(),
      ),

      // 7. NOTIFICATIONS (Personal Inbox) - NEW
      GoRoute(
        path: '/notifications',
        builder: (context, state) => const NotificationsScreen(),
      ),

      // -----------------------------------------------------------------------
      // PREFERENCES
      // -----------------------------------------------------------------------

      // 8. SETTINGS
      GoRoute(
        path: '/settings',
        builder: (context, state) => const SettingsScreen(),
      ),

      // 9. PROFILE
      GoRoute(
        path: '/profile',
        builder: (context, state) => const ProfileScreen(),
      ),

      // -----------------------------------------------------------------------
      // AUTH ROUTES
      // -----------------------------------------------------------------------
      GoRoute(
        path: '/login',
        builder: (context, state) => const ResponsiveLayout(
          mobileScaffold: MobileAuthScreen(initialIsLogin: true),
          pcScaffold: PCSignupScreen(initialIsLogin: true),
        ),
      ),

      GoRoute(
        path: '/signup',
        builder: (context, state) => const ResponsiveLayout(
          mobileScaffold: MobileAuthScreen(initialIsLogin: false),
          pcScaffold: PCSignupScreen(initialIsLogin: false),
        ),
      ),
    ],
  );
});

// --- HELPER CLASSES ---

class GoRouterRefreshStream extends ChangeNotifier {
  late final StreamSubscription<dynamic> _subscription;

  GoRouterRefreshStream(Stream<dynamic> stream) {
    notifyListeners();
    _subscription = stream.asBroadcastStream().listen(
      (dynamic _) => notifyListeners(),
    );
  }

  @override
  void dispose() {
    _subscription.cancel();
    super.dispose();
  }
}
// ==========================================
// FILE: ./main.dart
// ==========================================

// ------------------------------------------
// NOTE: Refactor this logic later
// ------------------------------------------

import 'dart:io'; // Needed for Platform
import 'package:flutter/foundation.dart'; // Needed for kIsWeb
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:supabase_flutter/supabase_flutter.dart';
import 'package:logging/logging.dart';
import 'package:window_manager/window_manager.dart'; // Make sure this is in pubspec.yaml

import 'core/theme/app_theme.dart';
import 'core/routes/app_router.dart';
import 'data/services/database_service.dart';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();

  // 0. SILENCE LOGS
  Logger.root.level = Level.SEVERE; 

  // --- DESKTOP WINDOW SETUP ---
  // Only run this on Desktop platforms
  if (!kIsWeb && (Platform.isWindows || Platform.isLinux || Platform.isMacOS)) {
    await windowManager.ensureInitialized();

    WindowOptions windowOptions = const WindowOptions(
      size: Size(1280, 720), // Default start size
      minimumSize: Size(1024, 768), // ‚õî REJECT small windows
      center: true,
      backgroundColor: Colors.transparent,
      skipTaskbar: false,
      titleBarStyle: TitleBarStyle.normal,
    );

    await windowManager.waitUntilReadyToShow(windowOptions, () async {
      await windowManager.show();
      await windowManager.focus();
      await windowManager.maximize(); // üöÄ Force Full Screen launch
    });
  }
  // ----------------------------

  // 1. Load Keys
  const supabaseUrl = String.fromEnvironment('SUPABASE_URL');
  const supabaseAnonKey = String.fromEnvironment('SUPABASE_ANON_KEY');

  if (supabaseUrl.isEmpty || supabaseAnonKey.isEmpty) {
    debugPrint("‚ö†Ô∏è WARNING: Supabase Keys missing. Run with 'make run'.");
  } else {
    await Supabase.initialize(
      url: supabaseUrl,
      anonKey: supabaseAnonKey,
    );
  }

  // 2. Initialize Database
  try {
    final dbService = DatabaseService();
    await dbService.initialize();
  } catch (e) {
    debugPrint("‚ùå Database Init Failed: $e");
  }

  runApp(const ProviderScope(child: GreywayApp()));
}

class GreywayApp extends ConsumerWidget {
  const GreywayApp({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final router = ref.watch(appRouterProvider);
    return MaterialApp.router(
      debugShowCheckedModeBanner: false,
      title: 'Fees Up',
      theme: AppTheme.darkTheme,
      routerConfig: router,
    );
  }
}
// ==========================================
// FILE: ./data/repositories/dashboard_repository.dart
// ==========================================

import '../services/database_service.dart';

class DashboardRepository {
  final DatabaseService _db;

  DashboardRepository(this._db);

  /// 1. Get the Current User's School ID and Name
  Future<Map<String, dynamic>?> getSchoolDetails(String userId) async {
    // First, find the user's profile to get the school_id
    final profile = await _db.getById('user_profiles', userId);
    if (profile == null || profile['school_id'] == null) return null;

    final schoolId = profile['school_id'];
    
    // Then get the school details
    final school = await _db.getById('schools', schoolId);
    
    return {
      'school_id': schoolId,
      'school_name': school?['name'] ?? 'My School',
      'user_role': profile['role'] ?? 'Admin',
      'user_name': profile['full_name'] ?? 'User',
    };
  }

  /// 2. Watch Key Stats (Real-time)
  /// We combine multiple streams into one or just watch specific tables.
  /// For performance, we usually watch tables and calculate sums in Dart for small datasets,
  /// or use SQL queries if PowerSync supports the aggregate subscription (it does via watch()).
  
  Stream<int> watchStudentCount(String schoolId) {
    return _db.db.watch(
      'SELECT count(*) as count FROM students WHERE school_id = ? AND is_active = 1',
      parameters: [schoolId]
    ).map((results) => results.first['count'] as int);
  }

  Stream<double> watchOutstandingBills(String schoolId) {
    return _db.db.watch(
      'SELECT sum(total_amount - paid_amount) as total FROM bills WHERE school_id = ? AND is_paid = 0',
      parameters: [schoolId]
    ).map((results) => (results.first['total'] as num?)?.toDouble() ?? 0.0);
  }

  Stream<double> watchDailyAttendance(String schoolId) {
    // Simple calculation: Present / Total Students today
    // This is a simplified logic for the dashboard view
    final today = DateTime.now().toIso8601String().split('T')[0];
    return _db.db.watch(
      "SELECT count(*) as count FROM attendance WHERE school_id = ? AND date = ? AND status = 'present'",
      parameters: [schoolId, today]
    ).map((results) => (results.first['count'] as num?)?.toDouble() ?? 0.0);
  }

  /// 3. Get Recent Transactions
  Stream<List<Map<String, dynamic>>> watchRecentPayments(String schoolId) {
    return _db.db.watch(
      'SELECT * FROM payments WHERE school_id = ? ORDER BY date_paid DESC LIMIT 5',
      parameters: [schoolId]
    );
  }
}
// ==========================================
// FILE: ./data/repositories/broadcast_repository.dart
// ==========================================

import 'package:supabase_flutter/supabase_flutter.dart';
import '../models/broadcast_model.dart';

class BroadcastRepository {
  final SupabaseClient _supabase = Supabase.instance.client;

  /// STREAM 1: Real-time School Broadcasts (Online-Only)
  /// Note: Supabase stream filters are limited to 'eq'. 
  /// Exclusion logic for 'hq_internal' is handled in the map.
  Stream<List<Broadcast>> watchSchoolBroadcasts(String schoolId) {
    return _supabase
        .from('broadcasts')
        .stream(primaryKey: ['id'])
        .eq('school_id', schoolId)
        .order('created_at')
        .map((rows) => rows
            .map((row) => Broadcast.fromRow(row))
            .where((b) => b.targetRole != 'hq_internal')
            .toList());
  }

  /// STREAM 2: Real-time Internal HQ Broadcasts (Online-Only)
  Stream<List<Broadcast>> watchInternalHQBroadcasts() {
    return _supabase
        .from('broadcasts')
        .stream(primaryKey: ['id'])
        .eq('target_role', 'hq_internal')
        .order('created_at')
        .map((rows) => rows.map((row) => Broadcast.fromRow(row)).toList());
  }

  /// Post Update (Direct to Supabase)
  Future<void> postBroadcast({
    required Map<String, dynamic> data,
  }) async {
    try {
      await _supabase.from('broadcasts').insert(data);
    } catch (e) {
      throw Exception('Greyway.Co Realtime Failure: $e');
    }
  }
}
// ==========================================
// FILE: ./data/repositories/announcements_repository.dart
// ==========================================

import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:uuid/uuid.dart';
import '../services/database_service.dart';
import '../models/announcement_model.dart';

final announcementsRepositoryProvider = Provider((ref) => AnnouncementsRepository());

class AnnouncementsRepository {
  final _db = DatabaseService();

  /// Watch local notifications - The heartbeat of the Rainbow UI
  /// Listens for real-time changes in the 'notifications' table.
  Stream<List<Announcement>> watchAnnouncements(String schoolId) {
    return _db.db.watch(
      'SELECT * FROM notifications WHERE school_id = ? ORDER BY created_at DESC',
      parameters: [schoolId],
    ).map((rows) => rows.map((row) => Announcement.fromRow(row)).toList());
  }

  /// Create Announcement with CEO-Grade Security (Explicit user_id)
  /// Ensures RLS is satisfied by injecting both school_id and user_id.
  Future<void> createAnnouncement({
    required String schoolId,
    required String userId, 
    required String title,
    required String body,
    required AnnouncementCategory category,
  }) async {
    try {
      final newAnnouncement = Announcement(
        id: const Uuid().v4(),
        schoolId: schoolId,
        title: title,
        body: body,
        time: DateTime.now(),
        category: category,
        isRead: false,
      );

      final data = newAnnouncement.toMap();

      // --- THE FORTRESS FIX ---
      // Manually injecting the User ID and School ID to satisfy Postgres RLS Constraints
      data['user_id'] = userId;
      data['school_id'] = schoolId;

      await _db.insert('notifications', data);
    } catch (e) {
      throw Exception('Fees Up Security: Failed to create announcement. Details: $e');
    }
  }

  /// Mark all as read - Clean up the Rainbow UI state
  /// Updates all unread notifications for a specific school.
  Future<void> markAllAsRead(String schoolId) async {
    try {
      await _db.db.execute(
        'UPDATE notifications SET is_read = 1 WHERE school_id = ? AND is_read = 0',
        [schoolId],
      );
    } catch (e) {
      throw Exception('Fees Up Logic Error: Failed to mark all notifications as read: $e');
    }
  }

  /// Single Action: Mark specific notification as read
  /// Explicitly added to handle individual item toggles in the UI.
  Future<void> markOneAsRead(String id) async {
    try {
      await _db.db.execute(
        'UPDATE notifications SET is_read = 1 WHERE id = ?',
        [id],
      );
    } catch (e) {
      throw Exception('Fees Up Logic Error: Failed to mark notification $id as read: $e');
    }
  }

  /// Delete specific notification (Utility)
  /// Permanently removes a notification from the local and remote Fortress.
  Future<void> deleteNotification(String id) async {
    try {
      await _db.db.execute('DELETE FROM notifications WHERE id = ?', [id]);
    } catch (e) {
      throw Exception('Fees Up Security: Unauthorized or failed deletion of $id: $e');
    }
  }
}
// ==========================================
// FILE: ./data/repositories/billing_repository.dart
// ==========================================

/// ============================================================================
/// BILLING REPOSITORY - DATABASE & API OPERATIONS
/// ============================================================================
library billing_repository;

import 'package:supabase_flutter/supabase_flutter.dart';
import 'package:flutter/foundation.dart';
import '../services/billing_engine.dart';

/// Helper function for debug logging
void debugPrintError(String message) {
  if (kDebugMode) {
    debugPrint('[ERROR] $message');
  }
}

class BillingRepository {
  final SupabaseClient supabase;

  BillingRepository({required this.supabase});

  /// Fetch all billing configurations for a school
  Future<List<BillingConfiguration>> fetchBillingConfigurations(
      String schoolId) async {
    try {
      final response = await supabase
          .from('billing_configurations')
          .select()
          .eq('school_id', schoolId)
          .eq('is_active', true)
          .order('effective_from', ascending: false);

      return (response as List<dynamic>)
          .map((config) =>
              BillingConfiguration.fromMap(config as Map<String, dynamic>))
          .toList();
    } catch (e) {
      // TODO: Replace with proper logging framework
      debugPrintError('Error fetching billing configurations: $e');
      return [];
    }
  }

  /// Save a new billing configuration
  Future<BillingConfiguration?> saveBillingConfiguration(
      BillingConfiguration config) async {
    try {
      final response = await supabase
          .from('billing_configurations')
          .insert(config.toMap())
          .select()
          .single();

      return BillingConfiguration.fromMap(response);
    } catch (e) {
      debugPrintError('Error saving billing configuration: $e');
      return null;
    }
  }

  /// Update a billing configuration
  Future<bool> updateBillingConfiguration(
      BillingConfiguration config) async {
    try {
      await supabase
          .from('billing_configurations')
          .update(config.toMap())
          .eq('id', config.id);
      return true;
    } catch (e) {
      debugPrintError('Error updating billing configuration: $e');
      return false;
    }
  }

  /// Deactivate a billing configuration
  Future<bool> deactivateBillingConfiguration(String configId) async {
    try {
      await supabase
          .from('billing_configurations')
          .update({'is_active': false})
          .eq('id', configId);
      return true;
    } catch (e) {
      debugPrintError('Error deactivating configuration: $e');
      return false;
    }
  }

  /// Record a billing switch
  Future<bool> recordBillingSwitch(BillingSwitch billSwitch) async {
    try {
      await supabase.from('billing_switches').insert(billSwitch.toMap());
      return true;
    } catch (e) {
      debugPrintError('Error recording billing switch: $e');
      return false;
    }
  }

  /// Save generated bills to database
  Future<bool> saveBills(List<GeneratedBill> bills) async {
    try {
      final billMaps = bills.map((b) => {
            'id': b.id,
            'school_id': b.schoolId,
            'student_id': b.studentId,
            'student_name': b.studentName,
            'grade_level': b.gradeLevel,
            'billing_date': b.billingDate.toIso8601String(),
            'due_date': b.dueDate.toIso8601String(),
            'subtotal': b.subtotal,
            'late_fee': b.lateFee,
            'discount': b.discount,
            'total': b.total,
            'frequency': b.frequency,
            'is_switch_bill': b.isSwitchBill,
            'created_at': DateTime.now().toIso8601String(),
          }).toList();

      await supabase.from('bills').insert(billMaps);

      // Save line items
      final lineItemMaps = <Map<String, dynamic>>[];
      for (final bill in bills) {
        for (final item in bill.lineItems) {
          lineItemMaps.add({
            'id': item.id,
            'bill_id': bill.id,
            'type': item.type.code,
            'description': item.description,
            'unit_price': item.unitPrice,
            'quantity': item.quantity,
            'total': item.total,
            'notes': item.notes,
          });
        }
      }

      if (lineItemMaps.isNotEmpty) {
        await supabase.from('bill_line_items').insert(lineItemMaps);
      }

      return true;
    } catch (e) {
      debugPrintError('Error saving bills: $e');
      return false;
    }
  }

  /// Fetch bills for a student
  Future<List<GeneratedBill>> fetchStudentBills(String studentId) async {
    try {
      final response = await supabase
          .from('bills')
          .select()
          .eq('student_id', studentId)
          .order('billing_date', ascending: false);

      return (response as List<dynamic>)
          .map((bill) => _billFromMap(bill as Map<String, dynamic>))
          .toList();
    } catch (e) {
      debugPrintError('Error fetching student bills: $e');
      return [];
    }
  }

  /// Fetch billing switches for a student
  Future<List<BillingSwitch>> fetchBillingSwitches(String studentId) async {
    try {
      final response = await supabase
          .from('billing_switches')
          .select()
          .eq('student_id', studentId)
          .order('effective_date', ascending: false);

      return (response as List<dynamic>)
          .map((switch_) => _billingSwitchFromMap(
              switch_ as Map<String, dynamic>))
          .toList();
    } catch (e) {
      debugPrintError('Error fetching billing switches: $e');
      return [];
    }
  }

  /// Generate bills in bulk
  Future<Map<String, dynamic>> generateBillsInBulk({
    required String schoolId,
    required String configId,
    required DateTime periodStart,
    required DateTime periodEnd,
    required List<Map<String, dynamic>> students,
  }) async {
    try {
      // Call Edge Function to handle bulk billing
      final response = await supabase.functions.invoke(
        'generate_bills_bulk',
        body: {
          'school_id': schoolId,
          'config_id': configId,
          'period_start': periodStart.toIso8601String(),
          'period_end': periodEnd.toIso8601String(),
          'students': students,
        },
      );

      return response as Map<String, dynamic>;
    } catch (e) {
      debugPrintError('Error generating bills in bulk: $e');
      return {'success': false, 'error': e.toString()};
    }
  }

  /// Mark bills as processed
  Future<bool> markBillsAsProcessed(List<String> billIds) async {
    try {
      await supabase
          .from('bills')
          .update({'is_processed': true})
          .inFilter('id', billIds);
      return true;
    } catch (e) {
      debugPrintError('Error marking bills as processed: $e');
      return false;
    }
  }

  /// Get billing statistics for school
  Future<Map<String, dynamic>> getBillingStatistics(String schoolId) async {
    try {
      final billsResponse = await supabase
          .from('bills')
          .select('total, is_paid')
          .eq('school_id', schoolId);

      final bills = billsResponse as List<dynamic>;
      final totalBilled = bills.fold<double>(
        0.0,
        (sum, bill) => sum + ((bill['total'] as num?) ?? 0.0).toDouble(),
      );
      final totalCollected = bills
          .where((bill) => bill['is_paid'] == true)
          .fold<double>(
        0.0,
        (sum, bill) => sum + ((bill['total'] as num?) ?? 0.0).toDouble(),
      );

      return {
        'total_billed': totalBilled,
        'total_collected': totalCollected,
        'outstanding': totalBilled - totalCollected,
        'collection_rate': totalBilled > 0
            ? ((totalCollected / totalBilled) * 100).toStringAsFixed(2)
            : '0',
        'total_bills': bills.length,
        'paid_bills': bills.where((b) => b['is_paid'] == true).length,
      };
    } catch (e) {
      debugPrintError('Error fetching billing statistics: $e');
      return {};
    }
  }

  /// Helper: Convert map to GeneratedBill
  GeneratedBill _billFromMap(Map<String, dynamic> map) {
    return GeneratedBill(
      id: map['id'] as String,
      schoolId: map['school_id'] as String,
      studentId: map['student_id'] as String,
      studentName: map['student_name'] as String,
      gradeLevel: map['grade_level'] as String,
      billingDate: DateTime.parse(map['billing_date'] as String),
      dueDate: DateTime.parse(map['due_date'] as String),
      lineItems: [], // Would need separate query to populate
      lateFee: (map['late_fee'] as num?)?.toDouble() ?? 0.0,
      discount: (map['discount'] as num?)?.toDouble() ?? 0.0,
      frequency: map['frequency'] as String,
      isSwitchBill: map['is_switch_bill'] as bool? ?? false,
    );
  }

  /// Helper: Convert map to BillingSwitch
  BillingSwitch _billingSwitchFromMap(Map<String, dynamic> map) {
    return BillingSwitch(
      id: map['id'] as String,
      schoolId: map['school_id'] as String,
      studentId: map['student_id'] as String,
      oldConfig: BillingConfiguration.fromMap(
          map['old_config'] as Map<String, dynamic>),
      newConfig: BillingConfiguration.fromMap(
          map['new_config'] as Map<String, dynamic>),
      effectiveDate: DateTime.parse(map['effective_date'] as String),
      prorationType: ProrationType.values.firstWhere(
        (e) => e.code == map['proration_type'],
        orElse: () => ProrationType.prorated,
      ),
      notes: map['notes'] as String?,
      isProcessed: map['is_processed'] as bool? ?? false,
    );
  }
}

// ==========================================
// FILE: ./data/repositories/users_repository.dart
// ==========================================

import 'package:supabase_flutter/supabase_flutter.dart';

class UsersRepository {
  final SupabaseClient _client = Supabase.instance.client;

  Future<List<Map<String, dynamic>>> getSchoolUsers(String schoolId) async {
    final response = await _client.rpc('get_school_users', params: {
      'target_school_id': schoolId,
    });
    return List<Map<String, dynamic>>.from(response as List);
  }

  Future<void> addUserByEmail({
    required String email,
    required String schoolId,
    required String role,
  }) async {
    final result = await _client.rpc('link_user_to_school', params: {
      'target_email': email,
      'target_school_id': schoolId,
      'assign_role': role,
    });

    if (result != 'success') {
      throw result; // Throw the specific error message from SQL (e.g. "User not found")
    }
  }

  Future<void> toggleStatus({
    required String userId,
    required String schoolId,
    required bool ban,
  }) async {
    await _client.rpc('toggle_user_access', params: {
      'target_user_id': userId,
      'target_school_id': schoolId,
      'should_ban': ban,
    });
  }
}
// ==========================================
// FILE: ./data/repositories/auth_repository.dart
// ==========================================

import 'package:supabase_flutter/supabase_flutter.dart';
import 'package:uuid/uuid.dart';
import '../services/database_service.dart';

class AuthRepository {
  final GoTrueClient _auth;
  final DatabaseService _db;

  AuthRepository({GoTrueClient? auth, DatabaseService? db}) 
      : _auth = auth ?? Supabase.instance.client.auth,
        _db = db ?? DatabaseService();

  User? get currentUser => _auth.currentUser;
  
  Stream<AuthState> get authStateChanges => _auth.onAuthStateChange;

  /// Sign In with Friendly Errors
  Future<AuthResponse> signIn({required String email, required String password}) async {
    try {
      return await _auth.signInWithPassword(email: email, password: password);
    } on AuthException catch (e) {
      throw _getHumanReadableError(e.message);
    } on PostgrestException catch (e) {
      throw _getHumanReadableError(e.message);
    } catch (_) {
      throw 'Unable to login. Please check your internet connection.';
    }
  }

  /// Sign Out
  Future<void> signOut() async {
    try {
      await _auth.signOut();
    } catch (e) {
      // Fail silently on logout errors, just clear local state if needed
    }
  }

  /// Setup School with Friendly Errors
  Future<void> signUpWithSchool({
    required String fullName,
    required String email,
    required String password,
    required String schoolName,
  }) async {
    try {
      // 1. Create Auth User
      final response = await _auth.signUp(
        email: email,
        password: password,
        data: {'full_name': fullName},
      );

      final user = response.user;
      if (user == null) throw 'Sign up failed. Please try again.';

      // 2. Generate IDs
      final schoolId = const Uuid().v4();
      final now = DateTime.now().toIso8601String();
      
      // 3. Write Data Locally (Atomic Transaction)
      // We wrap this in writeTransaction to ensure PowerSync uploads both 
      // the school and the profile in the SAME batch. This prevents the 
      // "Foreign Key Violation" error on the backend.
      await _db.db.writeTransaction((tx) async {
        // A. Create School
        await tx.execute(
          'INSERT INTO schools (id, name, subscription_tier, max_students, is_suspended, created_at) VALUES (?, ?, ?, ?, ?, ?)',
          [schoolId, schoolName, 'free', 5, 0, now]
        );

        // B. Create User Profile
        await tx.execute(
          'INSERT OR REPLACE INTO user_profiles (id, email, full_name, role, school_id, created_at) VALUES (?, ?, ?, ?, ?, ?)',
          [
            user.id,
            email,
            fullName,
            'school_admin',
            schoolId,
            now,
          ]
        );
      });

    } on AuthException catch (e) {
      throw _getHumanReadableError(e.message);
    } on PostgrestException catch (e) {
      throw _getHumanReadableError(e.message);
    } catch (e) {
      // Check for common connection errors
      if (e.toString().contains('SocketException') || e.toString().contains('Network')) {
        throw 'Connection failed. Please check your internet.';
      }
      throw 'Something went wrong. Please try again.';
    }
  }

  /// TRANSLATOR: Technical -> Human
  String _getHumanReadableError(String technicalMessage) {
    final msg = technicalMessage.toLowerCase();

    if (msg.contains('invalid login credentials')) {
      return 'Incorrect email or password.';
    }
    if (msg.contains('user already registered') || msg.contains('already exists')) {
      return 'An account with this email already exists.';
    }
    if (msg.contains('password should be at least')) {
      return 'Password is too short. It must be at least 6 characters.';
    }
    if (msg.contains('valid email')) {
      return 'Please enter a valid email address.';
    }
    if (msg.contains('network') || msg.contains('connection')) {
      return 'Network error. Please check your connection.';
    }
    
    // Fallback: If it's a server error we don't recognize, imply it's temporary
    return 'A server error occurred. Please try again later.';
  }
}
// ==========================================
// FILE: ./data/repositories/reports_repository.dart
// ==========================================

import 'package:supabase_flutter/supabase_flutter.dart';

class ReportsRepository {
  final SupabaseClient _client = Supabase.instance.client;

  // 1. Fetch Financial Data
  Future<Map<String, dynamic>> fetchFinancialSummary({
    required String schoolId,
    required DateTime start,
    required DateTime end,
  }) async {
    final response = await _client.rpc('get_financial_summary', params: {
      'target_school_id': schoolId,
      'start_date': start.toIso8601String(),
      'end_date': end.toIso8601String(),
    });
    return response as Map<String, dynamic>;
  }

  // 2. Fetch Outstanding Balances
  Future<List<Map<String, dynamic>>> fetchOutstandingBalances({
    required String schoolId,
    String grade = 'All Grades',
  }) async {
    final response = await _client.rpc('get_outstanding_balances', params: {
      'target_school_id': schoolId,
      'grade_filter': grade,
    });
    return List<Map<String, dynamic>>.from(response);
  }

  // 3. Fetch Enrollment Stats
  Future<Map<String, dynamic>> fetchEnrollmentTrends({
    required String schoolId,
  }) async {
    final response = await _client.rpc('get_enrollment_trends', params: {
      'target_school_id': schoolId,
    });
    return response as Map<String, dynamic>;
  }
}
// ==========================================
// FILE: ./data/repositories/expense_repository.dart
// ==========================================

import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:uuid/uuid.dart';
import 'package:fees_up/data/services/database_service.dart'; // Adjust path
import 'package:fees_up/data/models/finance_models.dart'; // Adjust path

final expenseRepositoryProvider = Provider((ref) => ExpenseRepository());

class ExpenseRepository {
  final _db = DatabaseService();

  /// Watch expenses for the specific school (Live Stream)
  Stream<List<Expense>> watchRecentExpenses(String schoolId) {
    return _db.db.watch(
      'SELECT * FROM expenses WHERE school_id = ? ORDER BY incurred_at DESC LIMIT 20',
      parameters: [schoolId],
    ).map((rows) => rows.map((row) => Expense.fromRow(row)).toList());
  }

  /// Insert a new expense locally (PowerSync syncs it up)
  Future<void> createExpense({
    required String schoolId,
    required String title,
    required double amount,
    required DateTime incurredAt,
    String? category,
    String? recipient,
    String? notes,
    String? paymentMethod,
  }) async {
    // Since schema lacks 'payment_method', we append it to description
    String finalDescription = notes ?? "";
    if (paymentMethod != null && paymentMethod.isNotEmpty) {
      finalDescription += "\n[Method: $paymentMethod]";
    }

    final newExpense = Expense(
      id: const Uuid().v4(), // Generate ID client-side
      schoolId: schoolId,
      title: title,
      amount: amount,
      incurredAt: incurredAt,
      category: category,
      recipient: recipient,
      description: finalDescription.trim().isEmpty ? null : finalDescription.trim(),
    );

    await _db.insert('expenses', newExpense.toMap());
  }
}
// ==========================================
// FILE: ./data/services/database_service.dart
// ==========================================

import 'dart:io';
import 'package:flutter/foundation.dart';
import 'package:path/path.dart';
import 'package:path_provider/path_provider.dart';
import 'package:powersync/powersync.dart';
import 'package:supabase_flutter/supabase_flutter.dart';

import 'schema.dart';
import 'supabase_connector.dart';

class DatabaseService {
  static final DatabaseService _instance = DatabaseService._internal();
  factory DatabaseService() => _instance;
  DatabaseService._internal();

  late PowerSyncDatabase _db;
  bool _isInitialized = false;
  late String _dbPath; // Store path locally since PS doesn't expose it

  PowerSyncDatabase get db => _db;

  Future<void> initialize() async {
    if (_isInitialized) return;

    final dir = await getApplicationSupportDirectory();
    _dbPath = join(dir.path, 'greyway_feesup.db');

    _db = PowerSyncDatabase(
      schema: appSchema,
      path: _dbPath,
    );

    await _db.initialize();

    final connector = SupabaseConnector(Supabase.instance.client);
    _db.connect(connector: connector);

    _isInitialized = true;
    if (kDebugMode) {
      print("‚úÖ Database Service Initialized & Connected");
    }
  }

  /// THE NUCLEAR OPTION
  /// Wipes local SQLite and disconnects.
  Future<void> factoryReset() async {
    try {
      await _db.close();
      final file = File(_dbPath);
      if (await file.exists()) {
        await file.delete();
      }
      _isInitialized = false;
      debugPrint("‚úÖ Local database wiped completely.");
    } catch (e) {
      debugPrint("‚ùå Error during factory reset: $e");
    }
  }

  bool get isConnected => _db.currentStatus.connected;

  Stream<List<Map<String, dynamic>>> watchAll(String table) {
    return _db.watch('SELECT * FROM $table ORDER BY created_at DESC');
  }

  /// Required by Student and Payment Dialogs
  Stream<List<Map<String, dynamic>>> watchStudents(String schoolId) {
    return _db.watch(
      'SELECT * FROM students WHERE school_id = ? ORDER BY full_name ASC',
      parameters: [schoolId],
    );
  }

  /// Runs a raw SQL SELECT query and returns the list of results once.
  /// Useful for one-off fetches like getting the last invoice number.
  Future<List<Map<String, dynamic>>> select(String sql, [List<Object?>? arguments]) async {
    return await _db.getAll(sql, arguments ?? []);
  }

  Future<Map<String, dynamic>?> getById(String table, String id) async {
    final results = await _db.getAll('SELECT * FROM $table WHERE id = ?', [id]);
    return results.isNotEmpty ? results.first : null;
  }

  Future<Map<String, dynamic>?> tryGet(String sql, [List<Object?>? arguments]) async {
    final results = await _db.getAll(sql, arguments ?? []);
    return results.isNotEmpty ? results.first : null;
  }

  Future<void> insert(String table, Map<String, dynamic> data) async {
    final keys = data.keys.toList();
    final values = data.values.toList();
    final placeholders = List.filled(keys.length, '?').join(', ');
    final columns = keys.join(', ');
    final sql = 'INSERT INTO $table ($columns) VALUES ($placeholders)';
    await _db.execute(sql, values);
  }

  Future<void> update(String table, String id, Map<String, dynamic> data) async {
    if (data.isEmpty) return;
    final updates = <String>[];
    final values = <dynamic>[];
    data.forEach((key, value) {
      updates.add('$key = ?');
      values.add(value);
    });
    values.add(id);
    final sql = 'UPDATE $table SET ${updates.join(', ')} WHERE id = ?';
    await _db.execute(sql, values);
  }

  Future<void> delete(String table, String id) async {
    await _db.execute('DELETE FROM $table WHERE id = ?', [id]);
  }

  Future<Map<String, dynamic>?> getUserProfile(String userId) async {
    return await getById('user_profiles', userId);
  }
}
// ==========================================
// FILE: ./data/services/billing_engine.dart
// ==========================================

/// ============================================================================
/// BILLING ENGINE - ADVANCED FEES UP BILLING SYSTEM
/// ============================================================================
/// 
/// This module provides a comprehensive billing engine that handles:
/// - Multiple billing types (tuition, transport, meals, custom)
/// - Mid-cycle billing switches with prorating
/// - Billing suspensions and resumptions
/// - Complex fee structures and adjustments
/// - Bulk billing operations
/// - Financial reconciliation
///
/// Author: Nyasha Gabriel / Batch Tech
/// Date: January 3, 2026
/// Status: Production-Ready
library billing_engine;

import 'package:uuid/uuid.dart';
import 'dart:math';

// ============================================================================
// ENUMS & CONSTANTS
// ============================================================================

enum BillingFrequency {
  daily('daily', 'Daily'),
  weekly('weekly', 'Weekly'),
  monthly('monthly', 'Monthly'),
  termly('termly', 'Termly'),
  annually('annually', 'Annually'),
  custom('custom', 'Custom');

  final String code;
  final String display;
  const BillingFrequency(this.code, this.display);

  static BillingFrequency fromCode(String code) =>
      BillingFrequency.values.firstWhere(
        (e) => e.code == code,
        orElse: () => BillingFrequency.monthly,
      );
}

enum BillingType {
  tuition('tuition', 'Tuition'),
  transport('transport', 'Transport'),
  meals('meals', 'Meals'),
  activities('activities', 'Activities'),
  uniform('uniform', 'Uniform'),
  library('library', 'Library'),
  technology('technology', 'Technology'),
  custom('custom', 'Custom');

  final String code;
  final String display;
  const BillingType(this.code, this.display);

  static BillingType fromCode(String code) =>
      BillingType.values.firstWhere(
        (e) => e.code == code,
        orElse: () => BillingType.tuition,
      );
}

enum ProrationType {
  prorated('prorated', 'Prorated'),
  fullMonth('fullMonth', 'Full Month'),
  dailyRate('dailyRate', 'Daily Rate');

  final String code;
  final String display;
  const ProrationType(this.code, this.display);
}

// ============================================================================
// FEE STRUCTURE MODELS
// ============================================================================

class FeeComponent {
  final String id;
  final String name;
  final BillingType type;
  final double amount;
  final bool isOptional;
  final bool isApplicable; // Used for conditional fees

  FeeComponent({
    String? id,
    required this.name,
    required this.type,
    required this.amount,
    this.isOptional = false,
    this.isApplicable = true,
  }) : id = id ?? const Uuid().v4();

  Map<String, dynamic> toMap() => {
        'id': id,
        'name': name,
        'type': type.code,
        'amount': amount,
        'is_optional': isOptional,
        'is_applicable': isApplicable,
      };

  factory FeeComponent.fromMap(Map<String, dynamic> map) => FeeComponent(
        id: map['id'] as String?,
        name: map['name'] as String,
        type: BillingType.fromCode(map['type'] as String),
        amount: (map['amount'] as num).toDouble(),
        isOptional: map['is_optional'] as bool? ?? false,
        isApplicable: map['is_applicable'] as bool? ?? true,
      );
}

class BillingConfiguration {
  final String id;
  final String schoolId;
  final String gradeLevel; // e.g., "Grade 1", "Grade 2", null for all
  final BillingFrequency frequency;
  final int billingDay; // Day of month when billing occurs
  final int dueDay; // Due day (usually billingDay + 7-30)
  final List<FeeComponent> feeComponents;
  final double? lateFeePercentage; // e.g., 5% = 5.0
  final double? minLateFee;
  final double? maxLateFee;
  final bool isActive;
  final DateTime effectiveFrom;
  final DateTime? effectiveUntil;

  BillingConfiguration({
    String? id,
    required this.schoolId,
    required this.gradeLevel,
    required this.frequency,
    required this.billingDay,
    required this.dueDay,
    required this.feeComponents,
    this.lateFeePercentage,
    this.minLateFee,
    this.maxLateFee,
    this.isActive = true,
    required this.effectiveFrom,
    this.effectiveUntil,
  }) : id = id ?? const Uuid().v4();

  double calculateTotalFee([List<String>? includeTypes]) {
    return feeComponents
        .where((fc) =>
            fc.isApplicable &&
            (includeTypes == null ||
                includeTypes.contains(fc.type.code)))
        .fold(0.0, (sum, fc) => sum + fc.amount);
  }

  Map<String, dynamic> toMap() => {
        'id': id,
        'school_id': schoolId,
        'grade_level': gradeLevel,
        'frequency': frequency.code,
        'billing_day': billingDay,
        'due_day': dueDay,
        'fee_components': feeComponents.map((fc) => fc.toMap()).toList(),
        'late_fee_percentage': lateFeePercentage,
        'min_late_fee': minLateFee,
        'max_late_fee': maxLateFee,
        'is_active': isActive,
        'effective_from': effectiveFrom.toIso8601String(),
        'effective_until': effectiveUntil?.toIso8601String(),
      };

  factory BillingConfiguration.fromMap(Map<String, dynamic> map) =>
      BillingConfiguration(
        id: map['id'] as String?,
        schoolId: map['school_id'] as String,
        gradeLevel: map['grade_level'] as String? ?? 'General',
        frequency: BillingFrequency.fromCode(map['frequency'] as String),
        billingDay: map['billing_day'] as int,
        dueDay: map['due_day'] as int,
        feeComponents: (map['fee_components'] as List<dynamic>?)
                ?.map((fc) =>
                    FeeComponent.fromMap(fc as Map<String, dynamic>))
                .toList() ??
            [],
        lateFeePercentage:
            (map['late_fee_percentage'] as num?)?.toDouble(),
        minLateFee: (map['min_late_fee'] as num?)?.toDouble(),
        maxLateFee: (map['max_late_fee'] as num?)?.toDouble(),
        isActive: map['is_active'] as bool? ?? true,
        effectiveFrom:
            DateTime.parse(map['effective_from'] as String),
        effectiveUntil: map['effective_until'] != null
            ? DateTime.parse(map['effective_until'] as String)
            : null,
      );
}

// ============================================================================
// BILLING SWITCH MODELS
// ============================================================================

class BillingSwitch {
  final String id;
  final String schoolId;
  final String studentId;
  final BillingConfiguration oldConfig;
  final BillingConfiguration newConfig;
  final DateTime effectiveDate;
  final ProrationType prorationType;
  final String? notes;
  final bool isProcessed;

  BillingSwitch({
    String? id,
    required this.schoolId,
    required this.studentId,
    required this.oldConfig,
    required this.newConfig,
    required this.effectiveDate,
    this.prorationType = ProrationType.prorated,
    this.notes,
    this.isProcessed = false,
  }) : id = id ?? const Uuid().v4();

  Map<String, dynamic> toMap() => {
        'id': id,
        'school_id': schoolId,
        'student_id': studentId,
        'old_config': oldConfig.toMap(),
        'new_config': newConfig.toMap(),
        'effective_date': effectiveDate.toIso8601String(),
        'proration_type': prorationType.code,
        'notes': notes,
        'is_processed': isProcessed,
      };
}

// ============================================================================
// PRORATION CALCULATOR
// ============================================================================

class ProratingCalculator {
  /// Calculate prorated amount for partial billing period
  static double calculateProration({
    required double fullAmount,
    required DateTime periodStart,
    required DateTime periodEnd,
    required DateTime actualStart,
    required DateTime actualEnd,
  }) {
    final totalDays = periodEnd.difference(periodStart).inDays + 1;
    final applicableDays = actualEnd.difference(actualStart).inDays + 1;

    if (applicableDays <= 0) return 0.0;

    final rate = fullAmount / totalDays;
    return rate * applicableDays;
  }

  /// Calculate daily rate for a fee
  static double calculateDailyRate({
    required double monthlyAmount,
    int daysInMonth = 30,
  }) =>
      monthlyAmount / daysInMonth;

  /// Calculate late fee
  static double calculateLateFee({
    required double outstandingAmount,
    double? percentageRate,
    double? minFee,
    double? maxFee,
  }) {
    if (percentageRate == null) return 0.0;

    var fee = outstandingAmount * (percentageRate / 100.0);

    if (minFee != null && fee < minFee) fee = minFee;
    if (maxFee != null && fee > maxFee) fee = maxFee;

    return fee;
  }

  /// Calculate next billing date based on frequency
  static DateTime calculateNextBillingDate({
    required DateTime lastBillingDate,
    required BillingFrequency frequency,
    required int billingDay,
  }) {
    switch (frequency) {
      case BillingFrequency.daily:
        return lastBillingDate.add(const Duration(days: 1));
      case BillingFrequency.weekly:
        return lastBillingDate.add(const Duration(days: 7));
      case BillingFrequency.monthly:
        var nextDate = DateTime(
          lastBillingDate.year,
          lastBillingDate.month + 1,
          min(billingDay, _getDaysInMonth(lastBillingDate.year, lastBillingDate.month + 1)),
        );
        return nextDate;
      case BillingFrequency.termly:
        return lastBillingDate.add(const Duration(days: 90));
      case BillingFrequency.annually:
        return DateTime(lastBillingDate.year + 1, lastBillingDate.month, billingDay);
      case BillingFrequency.custom:
        return lastBillingDate.add(const Duration(days: 30));
    }
  }

  static int _getDaysInMonth(int year, int month) {
    if (month > 12) {
      year += 1;
      month -= 12;
    }
    if ([1, 3, 5, 7, 8, 10, 12].contains(month)) return 31;
    if ([4, 6, 9, 11].contains(month)) return 30;
    return (year % 4 == 0 && (year % 100 != 0 || year % 400 == 0)) ? 29 : 28;
  }
}

// ============================================================================
// BILL GENERATION MODELS
// ============================================================================

class GeneratedBill {
  final String id;
  final String schoolId;
  final String studentId;
  final String studentName;
  final String gradeLevel;
  final DateTime billingDate;
  final DateTime dueDate;
  final List<BillLineItem> lineItems;
  final double subtotal;
  final double lateFee;
  final double discount;
  final double total;
  final String frequency;
  final bool isSwitchBill; // Bill due to billing switch

  GeneratedBill({
    String? id,
    required this.schoolId,
    required this.studentId,
    required this.studentName,
    required this.gradeLevel,
    required this.billingDate,
    required this.dueDate,
    required this.lineItems,
    double? lateFee,
    double? discount,
    required this.frequency,
    this.isSwitchBill = false,
  })  : id = id ?? const Uuid().v4(),
        lateFee = lateFee ?? 0.0,
        discount = discount ?? 0.0,
        subtotal = lineItems.fold(0.0, (sum, item) => sum + item.total),
        total = (lineItems.fold(0.0, (sum, item) => sum + item.total) +
                (lateFee ?? 0.0) -
                (discount ?? 0.0))
            .clamp(0.0, double.infinity);

  Map<String, dynamic> toMap() => {
        'id': id,
        'school_id': schoolId,
        'student_id': studentId,
        'student_name': studentName,
        'grade_level': gradeLevel,
        'billing_date': billingDate.toIso8601String(),
        'due_date': dueDate.toIso8601String(),
        'line_items': lineItems.map((li) => li.toMap()).toList(),
        'subtotal': subtotal,
        'late_fee': lateFee,
        'discount': discount,
        'total': total,
        'frequency': frequency,
        'is_switch_bill': isSwitchBill,
      };
}

class BillLineItem {
  final String id;
  final BillingType type;
  final String description;
  final double unitPrice;
  final int quantity;
  final double total;
  final String? notes;

  BillLineItem({
    String? id,
    required this.type,
    required this.description,
    required this.unitPrice,
    this.quantity = 1,
    this.notes,
  })  : id = id ?? const Uuid().v4(),
        total = unitPrice * quantity;

  Map<String, dynamic> toMap() => {
        'id': id,
        'type': type.code,
        'description': description,
        'unit_price': unitPrice,
        'quantity': quantity,
        'total': total,
        'notes': notes,
      };
}

// ============================================================================
// MAIN BILLING ENGINE
// ============================================================================

class BillingEngine {
  final String schoolId;
  final Map<String, BillingConfiguration> _configCache = {};
  final Map<String, List<BillingSwitch>> _switchHistory = {};

  BillingEngine({required this.schoolId});

  /// Register a billing configuration
  void registerBillingConfig(BillingConfiguration config) {
    _configCache[config.id] = config;
  }

  /// Get applicable billing configuration for a student
  BillingConfiguration? getApplicableConfig({
    required String gradeLevel,
    required DateTime asOfDate,
  }) {
    final configs = _configCache.values.where((config) {
      final isGradeMatch =
          config.gradeLevel == gradeLevel;
      final isEffective = config.effectiveFrom.isBefore(asOfDate) &&
          (config.effectiveUntil == null ||
              config.effectiveUntil!.isAfter(asOfDate));
      return isGradeMatch && isEffective && config.isActive;
    }).toList();

    if (configs.isEmpty) return null;

    // Return most specific (grade-level specific) config
    return configs.firstWhere(
      (c) => c.gradeLevel.isNotEmpty,
      orElse: () => configs.first,
    );
  }

  /// Generate bills for a student for a given period
  List<GeneratedBill> generateBillsForPeriod({
    required String studentId,
    required String studentName,
    required String gradeLevel,
    required DateTime periodStart,
    required DateTime periodEnd,
    required BillingConfiguration config,
  }) {
    final bills = <GeneratedBill>[];
    var currentDate = DateTime(periodStart.year, periodStart.month, config.billingDay);

    // Adjust if start date is after calculated billing date
    if (currentDate.isBefore(periodStart)) {
      currentDate = ProratingCalculator.calculateNextBillingDate(
        lastBillingDate: currentDate,
        frequency: config.frequency,
        billingDay: config.billingDay,
      );
    }

    while (currentDate.isBefore(periodEnd)) {
      final dueDate = DateTime(
        currentDate.year,
        currentDate.month,
        min(config.dueDay, _getDaysInMonth(currentDate.year, currentDate.month)),
      );

      final lineItems = config.feeComponents
          .where((fc) => fc.isApplicable && !fc.isOptional)
          .map((fc) => BillLineItem(
                type: fc.type,
                description: fc.name,
                unitPrice: fc.amount,
              ))
          .toList();

      if (lineItems.isNotEmpty) {
        bills.add(GeneratedBill(
          schoolId: schoolId,
          studentId: studentId,
          studentName: studentName,
          gradeLevel: gradeLevel,
          billingDate: currentDate,
          dueDate: dueDate,
          lineItems: lineItems,
          frequency: config.frequency.code,
        ));
      }

      currentDate = ProratingCalculator.calculateNextBillingDate(
        lastBillingDate: currentDate,
        frequency: config.frequency,
        billingDay: config.billingDay,
      );
    }

    return bills;
  }

  /// Handle mid-cycle billing switch
  List<GeneratedBill> processBillingSwitch({
    required String studentId,
    required String studentName,
    required String gradeLevel,
    required BillingSwitch billSwitch,
    required DateTime lastBillingDate,
  }) {
    final bills = <GeneratedBill>[];

    // Generate prorated bill for remainder of old config
    if (billSwitch.effectiveDate.isAfter(lastBillingDate)) {
      final nextBillingDate = ProratingCalculator.calculateNextBillingDate(
        lastBillingDate: lastBillingDate,
        frequency: billSwitch.oldConfig.frequency,
        billingDay: billSwitch.oldConfig.billingDay,
      );

      if (nextBillingDate.isAfter(billSwitch.effectiveDate)) {
        final proratedAmount = ProratingCalculator.calculateProration(
          fullAmount: billSwitch.oldConfig.calculateTotalFee(),
          periodStart: lastBillingDate,
          periodEnd: nextBillingDate,
          actualStart: lastBillingDate,
          actualEnd: billSwitch.effectiveDate.subtract(const Duration(days: 1)),
        );

        final lineItems = billSwitch.oldConfig.feeComponents
            .where((fc) => fc.isApplicable && !fc.isOptional)
            .map((fc) {
              final proratedFee = (fc.amount / billSwitch.oldConfig.calculateTotalFee()) *
                  proratedAmount;
              return BillLineItem(
                type: fc.type,
                description: '${fc.name} (Prorated to ${billSwitch.effectiveDate.day}-${lastBillingDate.add(Duration(days: (nextBillingDate.difference(lastBillingDate).inDays))).day})',
                unitPrice: proratedFee,
              );
            })
            .toList();

        if (lineItems.isNotEmpty) {
          bills.add(GeneratedBill(
            schoolId: schoolId,
            studentId: studentId,
            studentName: studentName,
            gradeLevel: gradeLevel,
            billingDate: lastBillingDate,
            dueDate: DateTime(
              billSwitch.effectiveDate.year,
              billSwitch.effectiveDate.month,
              min(billSwitch.oldConfig.dueDay,
                  _getDaysInMonth(billSwitch.effectiveDate.year, billSwitch.effectiveDate.month)),
            ),
            lineItems: lineItems,
            frequency: billSwitch.oldConfig.frequency.code,
            isSwitchBill: true,
          ));
        }
      }
    }

    // Generate first bill with new config
    final newConfigBills = generateBillsForPeriod(
      studentId: studentId,
      studentName: studentName,
      gradeLevel: gradeLevel,
      periodStart: billSwitch.effectiveDate,
      periodEnd: billSwitch.effectiveDate.add(const Duration(days: 90)),
      config: billSwitch.newConfig,
    );

    bills.addAll(newConfigBills);
    _switchHistory.putIfAbsent(studentId, () => []).add(billSwitch);

    return bills;
  }

  /// Calculate all outstanding charges for a student
  double calculateOutstandingBalance({
    required double unpaidBillsTotal,
    required double lateFees,
    required double adjustments,
  }) =>
      unpaidBillsTotal + lateFees - adjustments.abs();

  /// Get billing history for a student
  List<BillingSwitch> getBillingHistory(String studentId) =>
      _switchHistory[studentId] ?? [];

  static int _getDaysInMonth(int year, int month) {
    if ([1, 3, 5, 7, 8, 10, 12].contains(month)) return 31;
    if ([4, 6, 9, 11].contains(month)) return 30;
    return (year % 4 == 0 && (year % 100 != 0 || year % 400 == 0)) ? 29 : 28;
  }
}

// ============================================================================
// UTILITY: BATCH BILLING OPERATIONS
// ============================================================================

class BatchBillingProcessor {
  final BillingEngine engine;
  final List<GeneratedBill> generatedBills = [];
  final List<String> processingErrors = [];

  BatchBillingProcessor({required this.engine});

  /// Process billing for multiple students
  Future<void> processBulkBilling({
    required List<Map<String, dynamic>> students, // {id, name, gradeLevel, ...}
    required BillingConfiguration config,
    required DateTime periodStart,
    required DateTime periodEnd,
  }) async {
    for (final student in students) {
      try {
        final bills = engine.generateBillsForPeriod(
          studentId: student['id'] as String,
          studentName: student['name'] as String,
          gradeLevel: student['gradeLevel'] as String,
          periodStart: periodStart,
          periodEnd: periodEnd,
          config: config,
        );
        generatedBills.addAll(bills);
      } catch (e) {
        processingErrors.add(
          'Failed to generate bill for ${student['name']}: $e',
        );
      }
    }
  }

  /// Get summary of batch processing
  Map<String, dynamic> getSummary() => {
        'totalBillsGenerated': generatedBills.length,
        'totalAmount': generatedBills.fold(0.0, (sum, bill) => sum + bill.total),
        'processedStudents': generatedBills.map((b) => b.studentId).toSet().length,
        'errors': processingErrors,
        'errorCount': processingErrors.length,
      };
}

// ==========================================
// FILE: ./data/services/supabase_connector.dart
// ==========================================

/// -----------------------------------------------------------------
/// GREYWAY.CO / BATCH TECH - CONFIDENTIAL
/// -----------------------------------------------------------------
/// Author:  Nyasha Gabriel
/// Date:    2025-12-31
/// Ref:     https://supabase.com/docs
/// 
/// This file defines a SupabaseConnector class that integrates
/// Supabase with PowerSync for data synchronization.
/// 
/// It implements methods to fetch authentication credentials
/// and upload data changes to the Supabase backend.
/// 
/// -----------------------------------------------------------------
library supabase_connector;
import 'package:flutter/material.dart';
import 'package:powersync/powersync.dart';
import 'package:supabase_flutter/supabase_flutter.dart';

class SupabaseConnector extends PowerSyncBackendConnector {
  final SupabaseClient db;

  SupabaseConnector(this.db);

  @override
  Future<PowerSyncCredentials?> fetchCredentials() async {
    final session = db.auth.currentSession;
    if (session == null) return null;

    const endpoint = String.fromEnvironment('POWERSYNC_ENDPOINT_URL');
    if (endpoint.isEmpty) {
      throw Exception('POWERSYNC_ENDPOINT_URL not set in --dart-define');
    }

    return PowerSyncCredentials(
      endpoint: endpoint,
      token: session.accessToken,
      userId: session.user.id,
    );
  }

  @override
  Future<void> uploadData(PowerSyncDatabase database) async {
    final transaction = await database.getNextCrudTransaction();
    if (transaction == null) return;

    try {
      for (var op in transaction.crud) {
        final table = op.table;
        final id = op.id;
        final data = op.opData;

        // "Create or Update" Logic
        if (op.op == UpdateType.put) {
          // .upsert is the safest bet: it handles both new and existing records.
          // onConflict: 'id' ensures we don't get duplicate key errors.
          await db.from(table).upsert(
            {...data!, 'id': id},
            onConflict: 'id',
            ignoreDuplicates: false,
          );
        } else if (op.op == UpdateType.patch) {
          await db.from(table).update(data!).eq('id', id);
        } else if (op.op == UpdateType.delete) {
          await db.from(table).delete().eq('id', id);
        }
      }
      
      // Clear the queue once finished
      await transaction.complete();
      
    } on PostgrestException catch (e) {
      // 42501 = RLS Violation.
      // 23503 = Foreign Key Violation (Key is not present in table).
      // If we don't .complete() here, this one row blocks the WHOLE app sync loop.
      if (e.code == '42501' || e.code == '23503') {
        debugPrint('‚ùå Sync Error ${e.code} on $transaction: ${e.message}. Skipping to unblock queue.');
        await transaction.complete(); 
      } else {
        // For network or server 500 errors, we rethrow so PowerSync retries later.
        rethrow;
      }
    } catch (e) {
      debugPrint('Sync Upload Error: $e');
      rethrow;
    }
  }
}
// ==========================================
// FILE: ./data/services/encryption_service.dart
// ==========================================

import 'package:encrypt/encrypt.dart' as enc;

class EncryptionService {
  // 1. Fetch from Environment (passed via Makefile)
  // Fallback provided just in case dev env is missing keys.
  static const _envPassword = String.fromEnvironment(
    'UFT_PASSWORD', 
    defaultValue: 'FeesUpDefaultDevKey32CharsLong!!' 
  );

  // 2. Ensure Key is exactly 32 chars for AES-256
  static final _keyString = _envPassword.padRight(32, '#').substring(0, 32);

  static final _key = enc.Key.fromUtf8(_keyString);
  static final _iv = enc.IV.fromLength(16);
  static final _encrypter = enc.Encrypter(enc.AES(_key));

  static String encrypt(String plainText) {
    return _encrypter.encrypt(plainText, iv: _iv).base64;
  }

  static String decrypt(String encryptedBase64) {
    try {
      return _encrypter.decrypt(enc.Encrypted.fromBase64(encryptedBase64), iv: _iv);
    } catch (e) {
      return "[]";
    }
  }
}
// ==========================================
// FILE: ./data/services/financial_reports_service.dart
// ==========================================

import 'package:intl/intl.dart';
import 'package:supabase_flutter/supabase_flutter.dart';

/// üîí SECURE Financial Reports Service
/// Generates comprehensive financial reports with export capabilities
/// Respects billing suspension status in all calculations
class FinancialReportsService {
  final SupabaseClient supabase;

  FinancialReportsService({required this.supabase});

  // ========== REPORT BUILDING ==========

  /// ‚úÖ SECURE: Generate custom financial report
  /// Supports multiple report types with filtering
  Future<Map<String, dynamic>> generateCustomReport({
    required String schoolId,
    required ReportCategory category,
    required DateTimeRange dateRange,
    String? gradeLevel,
    String? studentId,
  }) async {
    try {
      switch (category) {
        case ReportCategory.tuitionCollection:
          return await _generateTuitionCollectionReport(
            schoolId: schoolId,
            dateRange: dateRange,
            gradeLevel: gradeLevel,
          );

        case ReportCategory.outstandingBalances:
          return await _generateOutstandingBalancesReport(
            schoolId: schoolId,
            gradeLevel: gradeLevel,
          );

        case ReportCategory.expenseAnalysis:
          return await _generateExpenseAnalysisReport(
            schoolId: schoolId,
            dateRange: dateRange,
          );

        case ReportCategory.paymentMethodBreakdown:
          return await _generatePaymentMethodReport(
            schoolId: schoolId,
            dateRange: dateRange,
          );

        case ReportCategory.studentLedger:
          return await _generateStudentLedgerReport(
            studentId: studentId ?? '',
            dateRange: dateRange,
          );

        case ReportCategory.cashFlow:
          return await _generateCashFlowReport(
            schoolId: schoolId,
            dateRange: dateRange,
          );
      }
    } catch (e) {
      rethrow;
    }
  }

  /// Tuition Collection Report
  /// Shows collected vs outstanding amounts with trend analysis
  Future<Map<String, dynamic>> _generateTuitionCollectionReport({
    required String schoolId,
    required DateTimeRange dateRange,
    String? gradeLevel,
  }) async {
    try {
      final response = await supabase.rpc('get_tuition_collection_report',
          params: {
            'p_school_id': schoolId,
            'p_start_date': dateRange.start.toIso8601String(),
            'p_end_date': dateRange.end.toIso8601String(),
            'p_grade_level': gradeLevel,
          });

      return response as Map<String, dynamic>;
    } catch (e) {
      rethrow;
    }
  }

  /// Outstanding Balances Report
  /// Lists students with balances owed, sorted by amount
  Future<Map<String, dynamic>> _generateOutstandingBalancesReport({
    required String schoolId,
    String? gradeLevel,
  }) async {
    try {
      final response = await supabase.rpc('get_outstanding_balances_report',
          params: {
            'p_school_id': schoolId,
            'p_grade_level': gradeLevel,
          });

      return response as Map<String, dynamic>;
    } catch (e) {
      rethrow;
    }
  }

  /// Expense Analysis Report
  /// Breaks down expenses by category with variance analysis
  Future<Map<String, dynamic>> _generateExpenseAnalysisReport({
    required String schoolId,
    required DateTimeRange dateRange,
  }) async {
    try {
      final response = await supabase.rpc('get_expense_analysis_report',
          params: {
            'p_school_id': schoolId,
            'p_start_date': dateRange.start.toIso8601String(),
            'p_end_date': dateRange.end.toIso8601String(),
          });

      return response as Map<String, dynamic>;
    } catch (e) {
      rethrow;
    }
  }

  /// Payment Method Breakdown Report
  /// Shows payment volumes by method (Cash, Bank Transfer, etc.)
  Future<Map<String, dynamic>> _generatePaymentMethodReport({
    required String schoolId,
    required DateTimeRange dateRange,
  }) async {
    try {
      final response = await supabase.rpc('get_payment_method_report',
          params: {
            'p_school_id': schoolId,
            'p_start_date': dateRange.start.toIso8601String(),
            'p_end_date': dateRange.end.toIso8601String(),
          });

      return response as Map<String, dynamic>;
    } catch (e) {
      rethrow;
    }
  }

  /// Student Ledger Report
  /// Complete transaction history for a single student
  Future<Map<String, dynamic>> _generateStudentLedgerReport({
    required String studentId,
    required DateTimeRange dateRange,
  }) async {
    try {
      final response = await supabase.rpc('get_student_ledger_report', params: {
        'p_student_id': studentId,
        'p_start_date': dateRange.start.toIso8601String(),
        'p_end_date': dateRange.end.toIso8601String(),
      });

      return response as Map<String, dynamic>;
    } catch (e) {
      rethrow;
    }
  }

  /// Cash Flow Report
  /// Shows daily/weekly/monthly cash movements
  Future<Map<String, dynamic>> _generateCashFlowReport({
    required String schoolId,
    required DateTimeRange dateRange,
  }) async {
    try {
      final response = await supabase.rpc('get_cash_flow_report', params: {
        'p_school_id': schoolId,
        'p_start_date': dateRange.start.toIso8601String(),
        'p_end_date': dateRange.end.toIso8601String(),
      });

      return response as Map<String, dynamic>;
    } catch (e) {
      rethrow;
    }
  }

  // ========== FINANCIAL SUMMARY (Dashboard) ==========

  /// Get financial dashboard summary
  /// KPIs: Total collected, Outstanding, Collection rate, Expenses, Net position
  Future<Map<String, dynamic>> getFinancialSummary(String schoolId) async {
    try {
      final response = await supabase.rpc('get_financial_summary', params: {
        'target_school_id': schoolId,
      });

      return response as Map<String, dynamic>;
    } catch (e) {
      rethrow;
    }
  }

  /// Get enrollment trends
  /// Shows student count trends over time (for projection calculations)
  Future<Map<String, dynamic>> getEnrollmentTrends(String schoolId) async {
    try {
      final response = await supabase.rpc('get_enrollment_trends', params: {
        'target_school_id': schoolId,
      });

      return response as Map<String, dynamic>;
    } catch (e) {
      rethrow;
    }
  }

  // ========== COMPARATIVE ANALYSIS ==========

  /// Compare financial performance across periods
  /// Useful for period-over-period analysis (YoY, QoQ, MoM)
  Future<Map<String, dynamic>> comparePerformancePeriods({
    required String schoolId,
    required DateTimeRange period1,
    required DateTimeRange period2,
  }) async {
    try {
      final response = await supabase.rpc('compare_periods', params: {
        'p_school_id': schoolId,
        'p_period1_start': period1.start.toIso8601String(),
        'p_period1_end': period1.end.toIso8601String(),
        'p_period2_start': period2.start.toIso8601String(),
        'p_period2_end': period2.end.toIso8601String(),
      });

      return response as Map<String, dynamic>;
    } catch (e) {
      rethrow;
    }
  }

  /// Forecast future cash position based on historical data
  Future<Map<String, dynamic>> forecastCashFlow({
    required String schoolId,
    required int forecastDays,
  }) async {
    try {
      final response = await supabase.rpc('forecast_cash_flow', params: {
        'p_school_id': schoolId,
        'p_forecast_days': forecastDays,
      });

      return response as Map<String, dynamic>;
    } catch (e) {
      rethrow;
    }
  }

  // ========== EXPORT FUNCTIONALITY ==========

  /// ‚úÖ NEW: Export report to CSV format
  /// Returns CSV string ready for file download
  String exportReportToCSV({
    required String reportName,
    required List<Map<String, dynamic>> data,
    List<String>? columnOrder,
  }) {
    if (data.isEmpty) {
      return 'No data available';
    }

    // Determine columns from first row or use specified order
    final columns = columnOrder ?? data.first.keys.toList();

    // Build CSV header
    final csv = StringBuffer();
    csv.writeln(columns.join(','));

    // Build CSV rows
    for (final row in data) {
      final values = columns.map((col) {
        final value = row[col];
        if (value == null) return '';

        // Escape quotes and wrap in quotes if contains comma
        final strValue = value.toString();
        if (strValue.contains(',') || strValue.contains('"')) {
          return '"${strValue.replaceAll('"', '""')}"';
        }
        return strValue;
      });

      csv.writeln(values.join(','));
    }

    return csv.toString();
  }

  /// ‚úÖ NEW: Export report to JSON format
  /// Returns JSON string with metadata
  String exportReportToJSON({
    required String reportName,
    required Map<String, dynamic> reportData,
    String? description,
  }) {
    final export = {
      'metadata': {
        'reportName': reportName,
        'generatedAt': DateTime.now().toIso8601String(),
        'description': description,
      },
      'data': reportData,
    };

    // Simple JSON serialization
    return _jsonEncode(export);
  }

  /// Helper: Simple JSON encoding (Dart's jsonEncode alternative)
  String _jsonEncode(dynamic value) {
    if (value == null) return 'null';
    if (value is bool) return value.toString();
    if (value is num) return value.toString();
    if (value is String) return '"${value.replaceAll('"', '\\"')}"';
    if (value is List) {
      return '[${value.map(_jsonEncode).join(', ')}]';
    }
    if (value is Map) {
      final pairs = value.entries
          .map((e) => '"${e.key}": ${_jsonEncode(e.value)}')
          .join(', ');
      return '{$pairs}';
    }
    return value.toString();
  }

  // ========== AUDIT & COMPLIANCE ==========

  /// Get audit log for financial transactions
  /// Admin-only access to track all financial changes
  Future<List<Map<String, dynamic>>> getFinancialAuditLog({
    required String schoolId,
    DateTime? startDate,
    DateTime? endDate,
    String? actionType, // 'invoice_created', 'payment_recorded', 'refund_processed'
  }) async {
    try {
      final query = supabase
          .from('financial_audit_log')
          .select(
              'id, action_type, user_id, amount, reference_id, created_at, details');

      var filtered = query.eq('school_id', schoolId);

      // Apply all optional filters inline without reassignment
      final response = await (startDate != null && endDate != null && actionType != null
          ? filtered
              .gte('created_at', startDate.toIso8601String())
              .lte('created_at', endDate.toIso8601String())
              .eq('action_type', actionType)
              .order('created_at', ascending: false)
          : startDate != null && endDate != null
              ? filtered
                  .gte('created_at', startDate.toIso8601String())
                  .lte('created_at', endDate.toIso8601String())
                  .order('created_at', ascending: false)
          : startDate != null && actionType != null
              ? filtered
                  .gte('created_at', startDate.toIso8601String())
                  .eq('action_type', actionType)
                  .order('created_at', ascending: false)
              : endDate != null && actionType != null
                  ? filtered
                      .lte('created_at', endDate.toIso8601String())
                      .eq('action_type', actionType)
                      .order('created_at', ascending: false)
              : startDate != null
                  ? filtered
                      .gte('created_at', startDate.toIso8601String())
                      .order('created_at', ascending: false)
                  : endDate != null
                      ? filtered
                          .lte('created_at', endDate.toIso8601String())
                          .order('created_at', ascending: false)
                      : actionType != null
                          ? filtered
                              .eq('action_type', actionType)
                              .order('created_at', ascending: false)
                          : filtered.order('created_at', ascending: false));

      return List<Map<String, dynamic>>.from(response);
    } catch (e) {
      rethrow;
    }
  }

  /// Validate financial consistency across all records
  /// Checks for discrepancies in bill vs payment totals
  Future<Map<String, dynamic>> validateFinancialConsistency(
      String schoolId) async {
    try {
      final response =
          await supabase.rpc('validate_financial_consistency', params: {
        'p_school_id': schoolId,
      });

      return response as Map<String, dynamic>;
    } catch (e) {
      rethrow;
    }
  }
}

// ========== ENUMS & TYPES ==========

enum ReportCategory {
  tuitionCollection,
  outstandingBalances,
  expenseAnalysis,
  paymentMethodBreakdown,
  studentLedger,
  cashFlow,
}

enum ReportFormat {
  pdf,
  csv,
  json,
  xlsx, // Excel format (if library available)
}

extension ReportCategoryDisplay on ReportCategory {
  String get displayName {
    switch (this) {
      case ReportCategory.tuitionCollection:
        return 'Tuition Collection Report';
      case ReportCategory.outstandingBalances:
        return 'Outstanding Balances Report';
      case ReportCategory.expenseAnalysis:
        return 'Expense Analysis Report';
      case ReportCategory.paymentMethodBreakdown:
        return 'Payment Method Breakdown';
      case ReportCategory.studentLedger:
        return 'Student Ledger';
      case ReportCategory.cashFlow:
        return 'Cash Flow Report';
    }
  }
}

/// Date range helper for reports
class DateTimeRange {
  final DateTime start;
  final DateTime end;

  DateTimeRange({
    required this.start,
    required this.end,
  });

  factory DateTimeRange.thisMonth() {
    final now = DateTime.now();
    return DateTimeRange(
      start: DateTime(now.year, now.month, 1),
      end: DateTime(now.year, now.month + 1, 1).subtract(const Duration(days: 1)),
    );
  }

  factory DateTimeRange.lastMonth() {
    final now = DateTime.now();
    final previousMonth = now.month == 1 ? 12 : now.month - 1;
    final previousYear = now.month == 1 ? now.year - 1 : now.year;
    return DateTimeRange(
      start: DateTime(previousYear, previousMonth, 1),
      end: DateTime(previousYear, previousMonth + 1, 1)
          .subtract(const Duration(days: 1)),
    );
  }

  factory DateTimeRange.thisYear() {
    final now = DateTime.now();
    return DateTimeRange(
      start: DateTime(now.year, 1, 1),
      end: DateTime(now.year, 12, 31),
    );
  }

  factory DateTimeRange.custom({
    required DateTime start,
    required DateTime end,
  }) {
    return DateTimeRange(start: start, end: end);
  }

  String get displayName {
    if (start.year == end.year && start.month == end.month) {
      return DateFormat('MMMM yyyy').format(start);
    }
    return '${DateFormat('MMM yyyy').format(start)} - ${DateFormat('MMM yyyy').format(end)}';
  }
}

// ==========================================
// FILE: ./data/services/invoice_service.dart
// ==========================================

import 'package:intl/intl.dart';
import 'package:supabase_flutter/supabase_flutter.dart';
import 'package:uuid/uuid.dart';

/// üîí SECURE Invoice Service with RPC-only access pattern
/// All invoice operations must respect billing suspension status
class InvoiceService {
  final SupabaseClient supabase;

  InvoiceService({required this.supabase});

  /// Generate next invoice number sequentially
  /// Format: INV-XXXXX (e.g., INV-00001)
  Future<String> getNextInvoiceNumber(String schoolId) async {
    try {
      final response = await supabase
          .from('bills')
          .select('invoice_number')
          .eq('school_id', schoolId)
          .order('invoice_number', ascending: false)
          .limit(1);

      if (response.isEmpty) {
        return 'INV-00001';
      }

      final lastInvoice = response.first['invoice_number'] as String?;
      if (lastInvoice != null && lastInvoice.startsWith('INV-')) {
        final numericPart = int.tryParse(lastInvoice.split('-')[1]);
        if (numericPart != null) {
          final nextNum = numericPart + 1;
          return 'INV-${nextNum.toString().padLeft(5, '0')}';
        }
      }

      return 'INV-00001';
    } catch (e) {
      rethrow;
    }
  }

  /// ‚úÖ SECURE: Create adhoc invoice (manual billing)
  /// - No schema hacks (no 'term_id': 'adhoc-manual')
  /// - Supports draft status before sending
  /// - Properly tracks invoice with all metadata
  Future<Map<String, dynamic>> createAdhocInvoice({
    required String schoolId,
    required String studentId,
    required String title,
    required double amount,
    required DateTime dueDate,
    required String status, // 'draft', 'sent', 'paid', 'overdue'
  }) async {
    try {
      final invoiceId = const Uuid().v4();
      final invoiceNumber = await getNextInvoiceNumber(schoolId);
      final now = DateTime.now();

      // ‚úÖ CORRECT: No artificial term_id hack
      // Bill_type 'adhoc' is sufficient - database schema supports null values
      // for school_year_id, month_index, and term_id
      final billData = {
        'id': invoiceId,
        'school_id': schoolId,
        'student_id': studentId,
        'invoice_number': invoiceNumber,
        'title': title,
        'total_amount': amount,
        'paid_amount': 0.0,
        'is_paid': 0,
        'is_closed': 0,
        'bill_type': 'adhoc',
        'status': status, // 'draft', 'sent', 'paid', 'overdue'
        'due_date': DateFormat('yyyy-MM-dd').format(dueDate),
        'created_at': now.toIso8601String(),
        'updated_at': now.toIso8601String(),
        'month_year': DateFormat('yyyy-MM').format(now),
        // ‚úÖ CORRECT: No term_id, school_year_id, month_index required for adhoc
        // Database schema allows nulls for these fields
      };

      await supabase.from('bills').insert(billData);

      return {
        'id': invoiceId,
        'invoiceNumber': invoiceNumber,
        'status': 'success',
      };
    } catch (e) {
      rethrow;
    }
  }

  /// Update invoice status (draft ‚Üí sent, sent ‚Üí paid, etc.)
  Future<void> updateInvoiceStatus({
    required String invoiceId,
    required String newStatus, // 'draft', 'sent', 'paid', 'overdue'
  }) async {
    try {
      await supabase
          .from('bills')
          .update({
            'status': newStatus,
            'updated_at': DateTime.now().toIso8601String(),
          })
          .eq('id', invoiceId);
    } catch (e) {
      rethrow;
    }
  }

  /// Get invoice by ID with full details
  Future<Map<String, dynamic>?> getInvoiceById(String invoiceId) async {
    try {
      final response = await supabase
          .from('bills')
          .select(
              'id, school_id, student_id, invoice_number, title, total_amount, paid_amount, is_paid, status, due_date, bill_type, created_at, updated_at')
          .eq('id', invoiceId)
          .single();

      return response;
    } catch (e) {
      return null;
    }
  }

  /// Get all invoices for a school (with optional filtering)
  Future<List<Map<String, dynamic>>> getInvoicesForSchool({
    required String schoolId,
    String? status, // Optional filter: 'draft', 'sent', 'paid', 'overdue'
    String? studentId, // Optional filter by student
  }) async {
    try {
      // Build query without conditional reassignment
      final query = supabase
          .from('bills')
          .select(
              'id, school_id, student_id, invoice_number, title, total_amount, paid_amount, is_paid, status, due_date, bill_type, created_at');

      // Apply filters in chain
      var filtered = query.eq('school_id', schoolId).eq('bill_type', 'adhoc');

      // Apply optional filters inline without reassignment
      final response = await (status != null && studentId != null
          ? filtered.eq('status', status).eq('student_id', studentId).order('created_at', ascending: false)
          : status != null
              ? filtered.eq('status', status).order('created_at', ascending: false)
              : studentId != null
                  ? filtered.eq('student_id', studentId).order('created_at', ascending: false)
                  : filtered.order('created_at', ascending: false));

      return List<Map<String, dynamic>>.from(response);
    } catch (e) {
      rethrow;
    }
  }

  /// Get outstanding (unpaid) invoices for a student
  Future<List<Map<String, dynamic>>> getOutstandingInvoices(
      String studentId) async {
    try {
      final response = await supabase
          .from('bills')
          .select(
              'id, invoice_number, title, total_amount, paid_amount, due_date, status')
          .eq('student_id', studentId)
          .eq('is_paid', 0)
          .neq('status', 'draft') // Exclude drafts from outstanding
          .order('due_date', ascending: true);

      return List<Map<String, dynamic>>.from(response);
    } catch (e) {
      rethrow;
    }
  }

  /// Calculate invoice aging (how overdue)
  /// Returns number of days overdue (negative if not yet due)
  int calculateInvoiceAge(DateTime dueDate) {
    final now = DateTime.now();
    return now.difference(dueDate).inDays;
  }

  /// Get invoices by date range
  Future<List<Map<String, dynamic>>> getInvoicesByDateRange({
    required String schoolId,
    required DateTime startDate,
    required DateTime endDate,
  }) async {
    try {
      final response = await supabase
          .from('bills')
          .select(
              'id, invoice_number, title, total_amount, paid_amount, status, created_at')
          .eq('school_id', schoolId)
          .gte('created_at', startDate.toIso8601String())
          .lte('created_at', endDate.toIso8601String())
          .order('created_at', ascending: false);

      return List<Map<String, dynamic>>.from(response);
    } catch (e) {
      rethrow;
    }
  }

  /// Archive/close an invoice (mark as closed)
  Future<void> closeInvoice(String invoiceId) async {
    try {
      await supabase
          .from('bills')
          .update({
            'is_closed': 1,
            'updated_at': DateTime.now().toIso8601String(),
          })
          .eq('id', invoiceId);
    } catch (e) {
      rethrow;
    }
  }

  /// Get invoice statistics for school dashboard
  Future<Map<String, dynamic>> getInvoiceStatistics(String schoolId) async {
    try {
      final response = await supabase.rpc('get_invoice_statistics', params: {
        'p_school_id': schoolId,
      });

      return response as Map<String, dynamic>;
    } catch (e) {
      rethrow;
    }
  }
}

// ==========================================
// FILE: ./data/services/broadcast_service.dart
// ==========================================

import 'dart:async';
import 'dart:convert';
import 'package:fees_up/data/services/encryption_service.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:supabase_flutter/supabase_flutter.dart';
import 'package:shared_preferences/shared_preferences.dart';
import '../models/broadcast_model.dart';

final broadcastServiceProvider = Provider((ref) => BroadcastService());

class BroadcastService {
  final _supabase = Supabase.instance.client;
  static const _storageKey = 'cached_broadcasts_encrypted';

  /// 1. ONLINE STREAM (Supabase Realtime)
  /// Listens to the live Websocket feed.
  Stream<List<Broadcast>> streamBroadcasts(String schoolId) {
    return _supabase
        .from('broadcasts')
        .stream(primaryKey: ['id'])
        .order('created_at', ascending: false)
        .map((maps) {
          final list = maps.map((e) => Broadcast.fromRow(e)).toList();
          
          // SIDE EFFECT: Encrypt & Cache immediately
          _cacheBroadcasts(list);
          
          return list;
        });
  }

  /// 2. OFFLINE LOAD (Encrypted Local Storage)
  Future<List<Broadcast>> loadCachedBroadcasts() async {
    final prefs = await SharedPreferences.getInstance();
    final encryptedData = prefs.getString(_storageKey);

    if (encryptedData == null) return [];

    try {
      // Decrypt
      final jsonStr = EncryptionService.decrypt(encryptedData);
      final List<dynamic> decoded = jsonDecode(jsonStr);
      
      final broadcasts = decoded.map((e) => Broadcast.fromRow(e)).toList();

      // Filter: Auto-expire messages older than 7 days
      return broadcasts.where((b) {
        return DateTime.now().difference(b.createdAt).inDays < 7;
      }).toList();

    } catch (e) {
      // If data is corrupt, clear it
      await prefs.remove(_storageKey);
      return [];
    }
  }

  /// Helper: Encrypt -> Save
  Future<void> _cacheBroadcasts(List<Broadcast> list) async {
    final prefs = await SharedPreferences.getInstance();
    
    // Only cache the newest 50 to keep it fast
    final subset = list.take(50).toList();
    
    // Convert to JSON
    final jsonStr = jsonEncode(subset.map((b) => b.toMap()).toList());
    
    // Encrypt
    final encryptedStr = EncryptionService.encrypt(jsonStr);
    
    // Save
    await prefs.setString(_storageKey, encryptedStr);
  }

  /// 3. SENDING (Admin Only)
  /// Sends directly via REST API (bypassing PowerSync)
  Future<void> sendBroadcast({
    required String schoolId,
    required String authorId,
    required String title,
    required String body,
    String priority = 'normal',
    String targetRole = 'all',
  }) async {
    await _supabase.from('broadcasts').insert({
      'school_id': schoolId,
      'author_id': authorId,
      'title': title,
      'body': body,
      'priority': priority,
      'target_role': targetRole,
      'is_system_message': false,
    });
  }
}
// ==========================================
// FILE: ./data/services/billing_suspension_service.dart
// ==========================================

/// ============================================================================
/// BILLING SUSPENSION SERVICE - CORE SUSPENSION LOGIC
/// ============================================================================
///
/// This service handles all billing suspension operations including:
/// - Suspending billing (globally or scoped)
/// - Resuming billing with backbill calculations
/// - Checking suspension status
/// - Audit logging
/// - Scope filtering (students, grades, fee types)
///
/// Author: Nyasha Gabriel / Batch Tech
/// Date: January 3, 2026
/// Status: Production-Ready
library billing_suspension_service;

import 'package:supabase_flutter/supabase_flutter.dart';
import 'package:flutter/foundation.dart';

// ============================================================================
// ENUMS & TYPES
// ============================================================================

enum SuspensionStatus {
  active('active', 'Active'),
  completed('completed', 'Completed'),
  cancelled('cancelled', 'Cancelled');

  final String code;
  final String display;
  const SuspensionStatus(this.code, this.display);

  static SuspensionStatus fromCode(String code) =>
      SuspensionStatus.values.firstWhere(
        (e) => e.code == code,
        orElse: () => SuspensionStatus.active,
      );
}

enum SuspensionScopeType {
  global('global', 'All Students'),
  students('students', 'Specific Students'),
  grades('grades', 'Grade Levels'),
  feeTypes('fee_types', 'Fee Types');

  final String code;
  final String display;
  const SuspensionScopeType(this.code, this.display);

  static SuspensionScopeType fromCode(String code) =>
      SuspensionScopeType.values.firstWhere(
        (e) => e.code == code,
        orElse: () => SuspensionScopeType.global,
      );
}

enum AuditAction {
  suspend('suspend', 'Billing Suspended'),
  resume('resume', 'Billing Resumed'),
  backbill('backbill', 'Backbilling Applied'),
  configChange('config_change', 'Configuration Changed'),
  switchProcessing('switch_processing', 'Plan Switch Processed'),
  adjustment('adjustment', 'Manual Adjustment'),
  correction('manual_correction', 'Manual Correction');

  final String code;
  final String display;
  const AuditAction(this.code, this.display);

  static AuditAction fromCode(String code) =>
      AuditAction.values.firstWhere(
        (e) => e.code == code,
        orElse: () => AuditAction.suspend,
      );
}

// ============================================================================
// DATA MODELS
// ============================================================================

class BillingSuppressionScope {
  final SuspensionScopeType type;
  final List<String> values; // student IDs, grade names, or fee type codes

  BillingSuppressionScope({
    required this.type,
    this.values = const [],
  });

  bool appliesTo({
    String? studentId,
    String? gradeLevel,
    String? feeType,
  }) {
    switch (type) {
      case SuspensionScopeType.global:
        return true; // Applies to everything
      case SuspensionScopeType.students:
        return studentId != null && values.contains(studentId);
      case SuspensionScopeType.grades:
        return gradeLevel != null && values.contains(gradeLevel);
      case SuspensionScopeType.feeTypes:
        return feeType != null && values.contains(feeType);
    }
  }

  Map<String, dynamic> toJson() => {
        'type': type.code,
        'values': values,
      };

  factory BillingSuppressionScope.fromJson(Map<String, dynamic> json) =>
      BillingSuppressionScope(
        type: SuspensionScopeType.fromCode(json['type'] as String),
        values: List<String>.from(json['values'] as List? ?? []),
      );
}

// ============================================================================
// NOTE ON CLIENT-SIDE MODELS
// ============================================================================
// 
// SuspensionPeriod and BillingAuditEntry models are INTENTIONALLY EXCLUDED
// from this file per SECURE_BILLING_ENGINE_ARCHITECTURE.md
// 
// These tables contain critical financial state and must NEVER be:
// - Synced via PowerSync
// - Accessed directly from client code
// - Stored in local model classes
// 
// Access these tables ONLY via:
// 1. RPC functions (server-side validation)
// 2. Realtime subscriptions (online-only)
// 3. Read-only REST queries (admin portal)
// 
// All client-side business logic must work with suspension STATUS (boolean),
// not suspension PERIODS (full data). See BillingSuppressionStatusData class
// below for UI-safe data structures.
// ============================================================================

/// UI-safe representation of billing suspension status
/// 
/// This class contains ONLY the information needed for billing logic:
/// - Whether billing is suspended (boolean)
/// - When it was suspended (timestamp)
/// - The reason (for UI display)
/// 
/// It does NOT contain the full suspension period record, which stays
/// server-side only per the security architecture.
class BillingSuppressionStatusData {
  final bool isSuspended;
  final DateTime? suspendedSince;
  final String? reason;
  final DateTime? resumesOn;

  const BillingSuppressionStatusData({
    required this.isSuspended,
    this.suspendedSince,
    this.reason,
    this.resumesOn,
  });

  factory BillingSuppressionStatusData.fromMap(Map<String, dynamic> map) =>
      BillingSuppressionStatusData(
        isSuspended: (map['is_suspended'] as bool?) ?? false,
        suspendedSince: map['suspended_since'] != null
            ? DateTime.parse(map['suspended_since'] as String)
            : null,
        reason: map['reason'] as String?,
        resumesOn: map['resumes_on'] != null
            ? DateTime.parse(map['resumes_on'] as String)
            : null,
      );

  factory BillingSuppressionStatusData.notSuspended() =>
      const BillingSuppressionStatusData(isSuspended: false);
}

// ============================================================================
// MAIN BILLING SUSPENSION SERVICE
// ============================================================================

class BillingSuppressionService {
  final SupabaseClient supabase;
  final String schoolId;
  final String userId;

  BillingSuppressionService({
    required this.supabase,
    required this.schoolId,
    required this.userId,
  });

  /// Suspend billing for the school
  /// 
  /// ‚úÖ SECURE: Uses RPC function for server-side validation
  /// ‚úÖ Prevents direct table access
  /// ‚úÖ Enforces engine assignment requirement
  /// 
  /// Parameters:
  /// - [reason]: Required reason for suspension
  /// - [scope]: Who suspension applies to (default: global/everyone)
  /// - [customNote]: Optional additional details
  /// 
  /// Returns: true if suspension successful
  Future<bool> suspendBilling({
    required String reason,
    BillingSuppressionScope? scope,
    String? customNote,
  }) async {
    try {
      final actualScope = scope ?? _globalScope();

      // ‚úÖ CORRECT: All mutations via RPC (server-side validation)
      final response = await supabase.rpc(
        'suspend_billing',
        params: {
          'p_school_id': schoolId,
          'p_user_id': userId,
          'p_reason': reason,
          'p_custom_note': customNote,
          'p_scope': actualScope.toJson(),
        },
      );

      return response != null;
    } on PostgrestException catch (e) {
      if (e.code == 'NOENG') {
        debugPrintError('No active billing engine assigned to school');
      } else if (e.code == 'PERMS') {
        debugPrintError('User lacks permission to suspend billing');
      }
      return false;
    } catch (e) {
      debugPrintError('Error suspending billing: $e');
      return false;
    }
  }

  /// Resume billing for the school
  /// 
  /// ‚úÖ SECURE: Uses RPC function for server-side validation
  /// ‚úÖ Only billing engine can resume
  /// ‚úÖ Automatic audit logging on server
  /// 
  /// Returns: true if resume successful
  Future<bool> resumeBilling() async {
    try {
      // ‚úÖ CORRECT: RPC call with engine validation
      final response = await supabase.rpc(
        'resume_billing',
        params: {
          'p_school_id': schoolId,
          'p_user_id': userId,
        },
      );

      return response != null;
    } on PostgrestException catch (e) {
      if (e.code == 'NOENG') {
        debugPrintError('No active billing engine assigned to school');
      } else if (e.code == 'NSUSP') {
        debugPrintError('No active suspension to resume');
      }
      return false;
    } catch (e) {
      debugPrintError('Error resuming billing: $e');
      return false;
    }
  }

  /// Check if billing is currently suspended
  /// 
  /// Returns: true if active suspension exists, false otherwise
  Future<bool> isBillingSuspended() async {
    try {
      final response = await supabase.rpc(
        'is_billing_suspended',
        params: {'p_school_id': schoolId},
      );

      return response as bool;
    } catch (e) {
      debugPrintError('Error checking billing suspension: $e');
      return false;
    }
  }

  /// Check if billing is currently suspended for this school
  /// 
  /// ‚úÖ SECURE: Uses RPC function for server-side check
  /// ‚úÖ Does not expose suspension period details
  /// ‚úÖ Returns status only, not sensitive period data
  /// 
  /// Returns: true if active suspension exists
  Future<bool> getActiveSuspensions() async {
    try {
      final response = await supabase.rpc(
        'is_billing_suspended',
        params: {'p_school_id': schoolId},
      );

      return (response as bool?) ?? false;
    } catch (e) {
      debugPrintError('Error checking active suspensions: $e');
      return false;
    }
  }

  /// Check if billing applies to a specific student
  /// 
  /// ‚úÖ SECURE: Uses RPC function with scope checking
  /// ‚úÖ Server performs all filtering logic
  /// 
  /// Parameters:
  /// - [studentId]: Student to check
  /// - [gradeLevel]: Grade level of student (optional)
  /// - [feeType]: Fee type being billed (optional)
  /// 
  /// Returns: false if billing is suspended for this student, true otherwise
  Future<bool> isBillingAppliedToStudent({
    required String studentId,
    String? gradeLevel,
    String? feeType,
  }) async {
    try {
      // Use RPC to check if billing applies to this specific student
      final response = await supabase.rpc(
        'is_billing_applied_to_student',
        params: {
          'p_school_id': schoolId,
          'p_student_id': studentId,
          'p_grade_level': gradeLevel,
          'p_fee_type': feeType,
        },
      );

      return (response as bool?) ?? true; // Default to billing enabled on error
    } catch (e) {
      debugPrintError('Error checking student billing status: $e');
      return true; // Default to billing enabled on error
    }
  }

  /// Get suspension summary for UI display
  /// 
  /// ‚úÖ SECURE: Returns status only, via RPC
  /// ‚úÖ Does not expose detailed suspension period data
  /// 
  /// Returns: Formatted map with suspension status
  Future<Map<String, dynamic>> getSuspensionSummary() async {
    try {
      final isSuspended = await getActiveSuspensions();

      return {
        'is_suspended': isSuspended,
        'status_text': isSuspended ? 'Billing is suspended' : 'Billing is active',
      };
    } catch (e) {
      debugPrintError('Error getting suspension summary: $e');
      return {'is_suspended': false};
    }
  }

  /// Calculate days suspended for backbilling purposes
  /// 
  /// ‚úÖ SECURE: Uses RPC function for calculation
  /// ‚úÖ Server maintains accuracy of calculations
  /// 
  /// Returns: Number of days suspended
  Future<int> calculateSuspensionDays() async {
    try {
      final response = await supabase.rpc(
        'calculate_suspension_days',
        params: {'p_school_id': schoolId},
      );

      return (response as int?) ?? 0;
    } catch (e) {
      debugPrintError('Error calculating suspension days: $e');
      return 0;
    }
  }

  /// Get audit log for school (admin/read-only access)
  /// 
  /// ‚úÖ SECURE: Uses RPC function for audit log retrieval
  /// ‚úÖ Server enforces admin-only access via RLS
  /// ‚úÖ Returns raw maps - no client-side models for sensitive data
  /// 
  /// Returns: List of audit entries as maps
  Future<List<Map<String, dynamic>>> getAuditLog({
    int limit = 50,
    String? filterAction,
  }) async {
    try {
      final response = await supabase.rpc(
        'get_billing_audit_log',
        params: {
          'p_school_id': schoolId,
          'p_limit': limit,
          'p_action_filter': filterAction,
        },
      );

      return List<Map<String, dynamic>>.from(response as List? ?? []);
    } catch (e) {
      debugPrintError('Error fetching audit log: $e');
      return [];
    }
  }

  // ========================================================================
  // PRIVATE HELPERS
  // ========================================================================

  BillingSuppressionScope _globalScope() => BillingSuppressionScope(
        type: SuspensionScopeType.global,
        values: [],
      );

  // NOTE: Audit logging is handled automatically by server-side triggers
  // All suspension operations are logged automatically when RPC functions
  // are executed. No client-side logging action is needed.
}

// ============================================================================
// DEBUG HELPER FUNCTION
// ============================================================================

void debugPrintError(String message) {
  if (kDebugMode) {
    debugPrint('[BILLING ERROR] $message');
  }
}

// ==========================================
// FILE: ./data/services/schema.dart
// ==========================================

import 'package:powersync/powersync.dart';

/// The Local SQLite Schema matching the Supabase Postgres Schema
/// based on the Fees Up Rules.
const Schema appSchema = Schema([
  
  // ============================================================
  // CORE SCHOOL DATA
  // ============================================================
  Table('schools', [
    Column.text('name'),
    Column.text('subscription_tier'),
    Column.integer('max_students'),
    Column.integer('is_suspended'), 
    Column.text('created_at'),
  ]),

  Table('user_profiles', [
    Column.text('email'),
    Column.text('full_name'),
    Column.text('role'),
    Column.text('school_id'),
    Column.integer('is_banned'),
    Column.text('avatar_url'),
    Column.text('created_at'),
  ]),

  Table('notifications', [
    Column.text('user_id'),
    Column.text('school_id'),
    Column.text('title'),
    Column.text('body'),
    Column.text('type'),
    Column.integer('is_read'),
    Column.text('created_at'),
  ]),

  // ============================================================
  // PEOPLE (Students, Teachers, Access)
  // ============================================================
  Table('students', [
    Column.text('school_id'),
    Column.text('student_id'), 
    Column.text('full_name'),
    Column.text('grade'),
    Column.text('parent_contact'),
    Column.text('registration_date'),
    Column.text('billing_type'),
    Column.real('default_fee'),
    Column.integer('is_active'),
    Column.text('admin_uid'),
    Column.real('owed_total'),
    Column.real('paid_total'),
    Column.text('subjects'),
    Column.text('billing_date'),
    Column.text('last_synced_at'),
    Column.text('term_id'),
    Column.text('date_of_birth'),
    Column.text('gender'),
    Column.text('address'),
    Column.text('emergency_contact_name'),
    Column.text('medical_notes'),
    Column.text('enrollment_date'),
    Column.integer('photo_consent'),
    Column.text('updated_at'),
    Column.text('created_at'),
  ]),

  Table('teachers', [
    Column.text('school_id'),
    Column.text('full_name'),
    Column.text('admin_uid'),
    Column.text('created_at'),
    Column.text('updated_at'),
  ]),

  Table('teacher_access_tokens', [
    Column.text('school_id'),
    Column.text('teacher_id'),
    Column.text('granted_by_teacher_id'),
    Column.text('access_code'),
    Column.text('permission_type'),
    Column.integer('is_used'),
    Column.text('used_at'),
    Column.text('expires_at'),
    Column.text('created_at'),
  ]),

  // ============================================================
  // ACADEMICS (Classes, Enrollment, Terms)
  // ============================================================
  Table('classes', [
    Column.text('school_id'),
    Column.text('name'),
    Column.text('teacher_id'),
    Column.text('room_number'),
    Column.text('subject_code'),
    Column.text('admin_uid'),
    Column.text('created_at'),
  ]),

  Table('enrollments', [
    Column.text('school_id'),
    Column.text('student_id'),
    Column.text('class_id'),
    Column.text('enrolled_at'),
    Column.text('created_at'),
  ]),

  Table('school_years', [
    Column.text('school_id'),
    Column.text('year_label'),
    Column.text('start_date'),
    Column.text('end_date'),
    Column.text('description'),
    Column.integer('active'),
    Column.text('created_at'),
  ]),

  Table('school_year_months', [
    Column.text('school_year_id'),
    Column.text('school_id'),
    Column.text('name'),
    Column.integer('month_index'),
    Column.text('start_date'),
    Column.text('end_date'),
    Column.integer('is_billable'),
    Column.text('created_at'),
  ]),

  Table('school_terms', [
    Column.text('school_id'),
    Column.text('name'),
    Column.text('start_date'),
    Column.text('end_date'),
    Column.integer('academic_year'),
    Column.text('created_at'),
  ]),

  // ============================================================
  // ATTENDANCE
  // ============================================================
  Table('attendance', [
    Column.text('school_id'),
    Column.text('student_id'),
    Column.text('class_id'),
    Column.text('date'),
    Column.text('status'),
    Column.text('remarks'),
    Column.text('recorded_by'),
    Column.text('created_at'),
  ]),

  Table('attendance_sessions', [
    Column.text('school_id'),
    Column.text('class_id'),
    Column.text('teacher_id'),
    Column.text('student_admin_id'),
    Column.text('access_token_id'),
    Column.text('session_date'),
    Column.integer('is_confirmed_by_teacher'),
    Column.text('confirmed_at'),
    Column.text('created_at'),
  ]),

  // ============================================================
  // FINANCE (Billing, Payments, Expenses)
  // ============================================================
  Table('billing_configs', [
    Column.text('school_id'),
    Column.text('currency_code'),
    Column.real('late_fee_percentage'),
    Column.text('invoice_footer_note'),
    Column.integer('allow_partial_payments'),
    Column.real('default_fee'),
    Column.text('updated_at'),
  ]),

  Table('bills', [
    Column.text('school_id'),
    Column.text('student_id'),
    Column.text('title'),
    
    // --- NEW COLUMNS FOR INVOICING ---
    Column.text('invoice_number'), // e.g. "INV-00231"
    Column.text('status'),         // e.g. "draft", "sent", "paid", "overdue"
    Column.text('pdf_url'),        // Link to Supabase Storage bucket
    // ---------------------------------

    Column.real('total_amount'),
    Column.integer('is_paid'), // Keep for backward compatibility/quick checks
    Column.text('bill_type'),
    Column.text('billing_cycle_end'),
    Column.text('billing_cycle_start'),
    Column.real('paid_amount'), // Cache for performance
    Column.text('term_id'),
    Column.text('month_year'),
    Column.text('due_date'),
    Column.text('cycle_interval'),
    Column.integer('is_closed'),
    Column.real('credited_amount'),
    Column.text('school_year_id'),
    Column.integer('month_index'),
    Column.text('updated_at'),
    Column.text('created_at'),
  ]),

  Table('bill_items', [
    Column.text('bill_id'),
    Column.text('school_id'),
    Column.text('description'),
    Column.real('amount'),
    Column.integer('quantity'),
    Column.text('created_at'),
  ]),

  Table('payments', [
    Column.text('school_id'),
    Column.text('student_id'),
    Column.real('amount'),
    Column.text('date_paid'),
    Column.text('category'),
    Column.text('payer_name'),
    Column.text('bill_id'),
    Column.text('method'),
    Column.text('admin_uid'),
    Column.text('created_at'),
  ]),

  Table('payment_allocations', [
    Column.text('payment_id'),
    Column.text('bill_id'),
    Column.text('school_id'),
    Column.real('amount'),
    Column.text('created_at'),
  ]),

  Table('credits', [
    Column.text('credit_id'),
    Column.text('school_id'),
    Column.text('student_id'),
    Column.text('bill_id'),
    Column.real('amount'),
    Column.text('reason'),
    Column.text('admin_uid'),
    Column.text('created_at'),
  ]),

  Table('expenses', [
    Column.text('school_id'),
    Column.text('title'),
    Column.real('amount'),
    Column.text('category'),
    Column.text('incurred_at'),
    Column.text('description'),
    Column.text('recipient'),
    Column.text('created_at'),
  ]),

  // ============================================================
  // FUNDRAISER & AUDIT
  // ============================================================
  // NOTE: billing_suspension_periods, billing_audit_log, and
  // billing_extensions are INTENTIONALLY EXCLUDED from PowerSync schema.
  // These tables contain critical financial state that must remain
  // server-side only with single-source-of-truth enforcement.
  // Access via Supabase Realtime (online-only) or RPC functions only.
  // See: SECURE_BILLING_ENGINE_ARCHITECTURE.md
  // ============================================================
  Table('campaigns', [
    Column.text('school_id'),
    Column.text('class_id'),
    Column.text('created_by_id'),
    Column.text('teacher_id'),
    Column.text('name'),
    Column.text('description'),
    Column.text('campaign_type'),
    Column.text('status'),
    Column.real('goal_amount'),
    Column.text('created_at'),
  ]),

  Table('campaign_donations', [
    Column.text('campaign_id'),
    Column.text('school_id'),
    Column.text('donor_name'),
    Column.real('amount'),
    Column.text('payment_method'),
    Column.text('date_received'),
    Column.text('notes'),
    Column.text('student_id'),
    Column.text('collected_by'),
    Column.text('approved_by'),
    Column.real('expected_cash'),
    Column.real('actual_cash'),
    Column.real('variance'),
    Column.text('updated_at'),
    Column.text('created_at'),
  ]),

  Table('campaign_expenses', [
    Column.text('campaign_id'),
    Column.text('school_id'),
    Column.text('category'),
    Column.real('amount'),
    Column.text('incurred_by'),
    Column.text('approved_by'),
    Column.text('notes'),
    Column.text('created_at'),
  ]),

  Table('campaign_funds', [
    Column.text('campaign_id'),
    Column.text('school_id'),
    Column.text('fund_name'),
    Column.integer('restricted'),
    Column.real('balance'),
    Column.text('updated_at'),
  ]),

  Table('banking_register', [
    Column.text('campaign_id'),
    Column.text('student_id'),
    Column.real('amount'),
    Column.text('direction'), 
    Column.text('recorded_by'),
    Column.text('approved_by'),
    Column.text('reference'),
    Column.text('school_id'),
    Column.text('created_at'),
  ]),

  // ============================================================
  // ARCHIVES
  // ============================================================
  Table('student_archives', [
    Column.text('school_id'),
    Column.text('full_name'),
    Column.text('reason'),
    Column.text('archived_at'),
    Column.text('original_data'),
    Column.text('created_at'),
  ]),
]);
// ==========================================
// FILE: ./data/services/transaction_service.dart
// ==========================================

import 'package:intl/intl.dart';
import 'package:supabase_flutter/supabase_flutter.dart';
import 'package:uuid/uuid.dart';

/// üîí SECURE Transaction Processing Engine
/// Handles payment allocation, partial payments, and refunds
/// All operations support offline-first via PowerSync
class TransactionService {
  final SupabaseClient supabase;

  TransactionService({required this.supabase});

  // ========== PAYMENT PROCESSING ==========

  /// ‚úÖ SECURE: Record payment with optional bill allocation
  /// Supports:
  /// - Full payment to single bill
  /// - Partial payment to single bill
  /// - Payment allocated across multiple bills
  Future<String> recordPayment({
    required String schoolId,
    required String studentId,
    required double amount,
    required String method, // 'Cash', 'Bank Transfer', 'Mobile Money', 'Cheque'
    required String category, // 'Tuition', 'Uniform', 'Levy', 'Transport', 'Donation'
    required DateTime datePaid,
    String? payerName,
    String? description,
  }) async {
    try {
      final paymentId = const Uuid().v4();
      final now = DateTime.now();

      // Create payment record
      final paymentData = {
        'id': paymentId,
        'school_id': schoolId,
        'student_id': studentId,
        'amount': amount,
        'method': method,
        'category': category,
        'date_paid': DateFormat('yyyy-MM-dd').format(datePaid),
        'payer_name': payerName,
        'description': description,
        'created_at': now.toIso8601String(),
        'updated_at': now.toIso8601String(),
      };

      await supabase.from('payments').insert(paymentData);

      // Trigger audit logging via server-side function (similar to billing suspension)
      try {
        await supabase.rpc('log_payment_action', params: {
          'p_payment_id': paymentId,
          'p_school_id': schoolId,
          'p_action': 'payment_recorded',
          'p_amount': amount,
        });
      } catch (e) {
        // Log call is non-critical
        debugPrintError('Payment audit log failed: $e');
      }

      return paymentId;
    } catch (e) {
      rethrow;
    }
  }

  // ========== PAYMENT ALLOCATION ==========

  /// ‚úÖ NEW: Allocate payment to specific bills
  /// Enables partial payment tracking and bill-level payment status
  Future<void> allocatePaymentToBill({
    required String paymentId,
    required String billId,
    required double allocatedAmount,
  }) async {
    try {
      final allocationId = const Uuid().v4();

      // Create payment allocation record
      final allocationData = {
        'id': allocationId,
        'payment_id': paymentId,
        'bill_id': billId,
        'amount': allocatedAmount,
        'created_at': DateTime.now().toIso8601String(),
      };

      await supabase.from('payment_allocations').insert(allocationData);

      // Update bill paid_amount
      await _updateBillPaidAmount(billId, allocatedAmount);
    } catch (e) {
      rethrow;
    }
  }

  /// Allocate a payment across multiple bills (partial payment support)
  Future<void> allocatePaymentToMultipleBills({
    required String paymentId,
    required List<MapEntry<String, double>> billAllocations,
    // billAllocations: List of MapEntry<billId, allocatedAmount>
  }) async {
    try {
      for (final allocation in billAllocations) {
        await allocatePaymentToBill(
          paymentId: paymentId,
          billId: allocation.key,
          allocatedAmount: allocation.value,
        );
      }
    } catch (e) {
      rethrow;
    }
  }

  /// Get all allocations for a payment
  Future<List<Map<String, dynamic>>> getPaymentAllocations(
      String paymentId) async {
    try {
      final response = await supabase
          .from('payment_allocations')
          .select('id, bill_id, amount, created_at')
          .eq('payment_id', paymentId);

      return List<Map<String, dynamic>>.from(response);
    } catch (e) {
      rethrow;
    }
  }

  /// Get bills with outstanding balance for a student
  /// Shows how much is still owed per bill
  Future<List<Map<String, dynamic>>> getOutstandingBillsWithBalance(
      String studentId) async {
    try {
      final response = await supabase.rpc('get_outstanding_bills_with_balance',
          params: {
            'p_student_id': studentId,
          });

      return List<Map<String, dynamic>>.from(response);
    } catch (e) {
      rethrow;
    }
  }

  // ========== PARTIAL PAYMENT SUPPORT ==========

  /// ‚úÖ NEW: Update bill paid amount and calculate remaining balance
  /// Automatically tracks if bill is fully paid
  Future<void> _updateBillPaidAmount(String billId, double addedAmount) async {
    try {
      // Get current bill state
      final response = await supabase
          .from('bills')
          .select('paid_amount, total_amount, id')
          .eq('id', billId)
          .single();

      final currentPaid = (response['paid_amount'] as num).toDouble();
      final totalAmount = (response['total_amount'] as num).toDouble();
      final newPaidAmount = currentPaid + addedAmount;
      final isFullyPaid = newPaidAmount >= totalAmount;

      // Update bill with new paid amount and status
      await supabase
          .from('bills')
          .update({
            'paid_amount': newPaidAmount,
            'is_paid': isFullyPaid ? 1 : 0,
            'status': isFullyPaid ? 'paid' : 'partial',
            'updated_at': DateTime.now().toIso8601String(),
          })
          .eq('id', billId);
    } catch (e) {
      rethrow;
    }
  }

  /// Calculate remaining balance for a bill
  Future<double> calculateBillBalance(String billId) async {
    try {
      final response = await supabase
          .from('bills')
          .select('paid_amount, total_amount')
          .eq('id', billId)
          .single();

      final paidAmount = (response['paid_amount'] as num).toDouble();
      final totalAmount = (response['total_amount'] as num).toDouble();

      return (totalAmount - paidAmount).clamp(0.0, totalAmount);
    } catch (e) {
      rethrow;
    }
  }

  /// Get payment allocation summary for a bill
  /// Shows total allocated, remaining, and allocation history
  Future<Map<String, dynamic>> getBillPaymentSummary(String billId) async {
    try {
      final response = await supabase.rpc('get_bill_payment_summary', params: {
        'p_bill_id': billId,
      });

      return response as Map<String, dynamic>;
    } catch (e) {
      rethrow;
    }
  }

  // ========== REFUND PROCESSING ==========

  /// ‚úÖ NEW: Process refund for overpayment
  /// Creates reverse payment entry and adjusts bill status
  Future<String> processRefund({
    required String originalPaymentId,
    required String studentId,
    required String schoolId,
    required double refundAmount,
    required String reason,
    required String refundMethod, // 'Cash', 'Bank Transfer', etc.
    String? approvedBy,
  }) async {
    try {
      final refundId = const Uuid().v4();
      final now = DateTime.now();

      // Create refund record (negative payment)
      final refundData = {
        'id': refundId,
        'school_id': schoolId,
        'student_id': studentId,
        'amount': -refundAmount, // Negative to indicate refund
        'method': refundMethod,
        'category': 'Refund',
        'date_paid': DateFormat('yyyy-MM-dd').format(now),
        'payer_name': 'School Refund',
        'description': 'Refund for payment: $originalPaymentId. Reason: $reason',
        'original_payment_id': originalPaymentId,
        'refund_reason': reason,
        'approved_by': approvedBy,
        'created_at': now.toIso8601String(),
        'updated_at': now.toIso8601String(),
      };

      await supabase.from('payments').insert(refundData);

      // Log refund action
      try {
        await supabase.rpc('log_refund_action', params: {
          'p_refund_id': refundId,
          'p_school_id': schoolId,
          'p_original_payment_id': originalPaymentId,
          'p_amount': refundAmount,
          'p_reason': reason,
          'p_approved_by': approvedBy,
        });
      } catch (e) {
        debugPrintError('Refund audit log failed: $e');
      }

      return refundId;
    } catch (e) {
      rethrow;
    }
  }

  /// Reverse payment allocation (for refunded payments)
  Future<void> reversePaymentAllocation({
    required String allocationId,
    required String billId,
    required double allocationAmount,
  }) async {
    try {
      // Delete allocation
      await supabase
          .from('payment_allocations')
          .delete()
          .eq('id', allocationId);

      // Reduce bill paid amount
      await _reduceBillPaidAmount(billId, allocationAmount);
    } catch (e) {
      rethrow;
    }
  }

  /// Internal: Reduce paid amount (for refunds)
  Future<void> _reduceBillPaidAmount(String billId, double deductAmount) async {
    try {
      final response = await supabase
          .from('bills')
          .select('paid_amount, total_amount')
          .eq('id', billId)
          .single();

      final currentPaid = (response['paid_amount'] as num).toDouble();
      final newPaidAmount = (currentPaid - deductAmount).clamp(0.0, double.infinity);
      final totalAmount = (response['total_amount'] as num).toDouble();
      final isFullyPaid = newPaidAmount >= totalAmount;

      await supabase
          .from('bills')
          .update({
            'paid_amount': newPaidAmount,
            'is_paid': isFullyPaid ? 1 : 0,
            'status': isFullyPaid ? 'paid' : (newPaidAmount > 0 ? 'partial' : 'sent'),
            'updated_at': DateTime.now().toIso8601String(),
          })
          .eq('id', billId);
    } catch (e) {
      rethrow;
    }
  }

  /// Get refund history for a student
  Future<List<Map<String, dynamic>>> getRefundHistory(
      String studentId) async {
    try {
      final response = await supabase
          .from('payments')
          .select(
              'id, amount, date_paid, refund_reason, approved_by, original_payment_id')
          .eq('student_id', studentId)
          .lt('amount', 0) // Negative amounts are refunds
          .order('date_paid', ascending: false);

      return List<Map<String, dynamic>>.from(response);
    } catch (e) {
      rethrow;
    }
  }

  // ========== TRANSACTION HISTORY & REPORTING ==========

  /// Get all payments for a student with date range filtering
  Future<List<Map<String, dynamic>>> getPaymentHistory({
    required String studentId,
    DateTime? startDate,
    DateTime? endDate,
  }) async {
    try {
      final query = supabase
          .from('payments')
          .select(
              'id, amount, method, category, date_paid, payer_name, created_at');

      var filtered = query.eq('student_id', studentId).gt('amount', 0);

      // Apply optional date filters inline
      final response = await (startDate != null && endDate != null
          ? filtered
              .gte('date_paid', DateFormat('yyyy-MM-dd').format(startDate))
              .lte('date_paid', DateFormat('yyyy-MM-dd').format(endDate))
              .order('date_paid', ascending: false)
          : startDate != null
              ? filtered
                  .gte('date_paid', DateFormat('yyyy-MM-dd').format(startDate))
                  .order('date_paid', ascending: false)
              : endDate != null
                  ? filtered
                      .lte('date_paid', DateFormat('yyyy-MM-dd').format(endDate))
                      .order('date_paid', ascending: false)
                  : filtered.order('date_paid', ascending: false));

      return List<Map<String, dynamic>>.from(response);
    } catch (e) {
      rethrow;
    }
  }

  /// Get transaction summary for school (dashboard)
  Future<Map<String, dynamic>> getTransactionSummary(String schoolId) async {
    try {
      final response = await supabase.rpc('get_transaction_summary', params: {
        'p_school_id': schoolId,
      });

      return response as Map<String, dynamic>;
    } catch (e) {
      rethrow;
    }
  }

  /// Reconcile payments with allocations (for auditing)
  Future<Map<String, dynamic>> reconcilePayments({
    required String schoolId,
    required DateTime startDate,
    required DateTime endDate,
  }) async {
    try {
      final response = await supabase.rpc('reconcile_payments', params: {
        'p_school_id': schoolId,
        'p_start_date': startDate.toIso8601String(),
        'p_end_date': endDate.toIso8601String(),
      });

      return response as Map<String, dynamic>;
    } catch (e) {
      rethrow;
    }
  }
}

void debugPrintError(String message) {
  // TODO: Replace with proper logging service
  // ignore: avoid_print
  print('‚ùå ERROR: $message');
}

// ==========================================
// FILE: ./data/services/school_service.dart
// ==========================================

import 'dart:async';
import 'package:flutter/material.dart';
import 'package:uuid/uuid.dart';
import 'database_service.dart';
import 'package:supabase_flutter/supabase_flutter.dart';

class SchoolService {
  final DatabaseService _db;
  final _supabase = Supabase.instance.client;

  SchoolService(this._db);

  /// -----------------------------------------------------------------------
  /// REFRESH HELPER (Required by school_provider.dart)
  /// -----------------------------------------------------------------------
  Future<Map<String, dynamic>?> getSchoolForUser(String userId, {bool waitForSync = true}) async {
    Future<Map<String, dynamic>?> fetch() async {
      final profile = await _db.tryGet('SELECT school_id FROM user_profiles WHERE id = ?', [userId]);
      if (profile == null || profile['school_id'] == null) return null;
      
      return await _db.tryGet('SELECT * FROM schools WHERE id = ?', [profile['school_id']]);
    }

    final result = await fetch();
    if (result != null) return result;
    if (!waitForSync) return null;

    for (int i = 0; i < 10; i++) {
      await Future.delayed(const Duration(seconds: 1));
      final retryResult = await fetch();
      if (retryResult != null) return retryResult;
    }
    return null;
  }

  /// -----------------------------------------------------------------------
  /// CREATION HELPER
  /// -----------------------------------------------------------------------
  Future<String?> createSchool({
    required String adminId,
    required String schoolName,
    String tier = 'free',
  }) async {
    final schoolId = const Uuid().v4();
    final now = DateTime.now().toIso8601String();

    try {
      await _db.db.writeTransaction((tx) async {
        await tx.execute('''
          INSERT INTO schools (id, name, subscription_tier, max_students, is_suspended, created_at)
          VALUES (?, ?, ?, ?, ?, ?)
        ''', [schoolId, schoolName, tier, 100, 0, now]);

        await tx.execute('''
          UPDATE user_profiles SET school_id = ?, role = 'admin' WHERE id = ?
        ''', [schoolId, adminId]);

        await tx.execute('''
          INSERT INTO billing_configs (id, school_id, currency_code, late_fee_percentage, updated_at)
          VALUES (?, ?, ?, ?, ?)
        ''', [const Uuid().v4(), schoolId, 'USD', 0.0, now]);
      });

      return schoolId;
    } catch (e) {
      rethrow; 
    }
  }

  Future<void> createSchoolWithDiagnostics(
    BuildContext context, {
    required String adminId,
    required String schoolName,
  }) async {
    try {
      await createSchool(adminId: adminId, schoolName: schoolName);
    } catch (e) {
      try {
        final response = await _supabase.rpc('debug_user_access', params: {
          'target_user_id': adminId,
        });

        final recommendation = response['recommendation'] ?? 'UNKNOWN_ERROR';
        
        if (context.mounted) {
          showProperChannelDialog(context, recommendation);
        }
      } catch (rpcError) {
        throw Exception("System is currently unreachable.");
      }
    }
  }

  /// -----------------------------------------------------------------------
  /// FORCE LOGOUT AND RE-AUTHENTICATE
  /// -----------------------------------------------------------------------
  Future<void> _forceLogoutAndReauth() async {
    await _db.factoryReset(); // Uses the new internal factoryReset
    await _supabase.auth.signOut();
  }

  void showProperChannelDialog(BuildContext context, String recommendation) {
    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (context) => AlertDialog(
        backgroundColor: const Color(0xFF121212),
        title: const Text("System Alignment Required", style: TextStyle(color: Colors.blue)),
        content: Text(
          "Diagnostic Result: $recommendation\n\nTo resolve this, the app must restart your session.",
          style: const TextStyle(color: Colors.white70),
        ),
        actions: [
          TextButton(
            onPressed: () async {
              Navigator.pop(context);
              await _forceLogoutAndReauth();
            },
            child: const Text("RESET & RE-AUTHENTICATE", style: TextStyle(color: Colors.blue)),
          ),
        ],
      ),
    );
  }
}
// ==========================================
// FILE: ./data/models/core_models.dart
// ==========================================

class School {
  final String id;
  final String name;
  final String subscriptionTier; // 'free', 'basic', 'pro'
  final int maxStudents;
  final bool isSuspended;
  final DateTime createdAt;

  School({
    required this.id,
    required this.name,
    this.subscriptionTier = 'free',
    this.maxStudents = 50,
    this.isSuspended = false,
    required this.createdAt,
  });

  factory School.fromRow(Map<String, dynamic> row) {
    return School(
      id: row['id'] as String,
      name: row['name'] as String,
      subscriptionTier: row['subscription_tier'] ?? 'free',
      maxStudents: (row['max_students'] as num?)?.toInt() ?? 50,
      isSuspended: (row['is_suspended'] == 1),
      createdAt: DateTime.parse(row['created_at']),
    );
  }
}

class UserProfile {
  final String id;
  final String email;
  final String fullName;
  final String role; // 'super_admin', 'school_admin', 'teacher', 'student'
  final String? schoolId;
  final bool isBanned;
  final String? avatarUrl;

  UserProfile({
    required this.id,
    required this.email,
    required this.fullName,
    this.role = 'teacher',
    this.schoolId,
    this.isBanned = false,
    this.avatarUrl,
  });

  factory UserProfile.fromRow(Map<String, dynamic> row) {
    return UserProfile(
      id: row['id'] as String,
      email: row['email'] as String,
      fullName: row['full_name'] as String,
      role: row['role'] ?? 'teacher',
      schoolId: row['school_id'] as String?,
      isBanned: (row['is_banned'] == 1),
      avatarUrl: row['avatar_url'] as String?,
    );
  }
}

class BillingConfig {
  final String id;
  final String? schoolId;
  final String currencyCode;
  final double lateFeePercentage;
  final String? invoiceFooterNote;
  final bool allowPartialPayments;
  final double defaultFee;

  BillingConfig({
    required this.id,
    this.schoolId,
    this.currencyCode = 'USD',
    this.lateFeePercentage = 0.0,
    this.invoiceFooterNote,
    this.allowPartialPayments = true,
    this.defaultFee = 100.00,
  });

  factory BillingConfig.fromRow(Map<String, dynamic> row) {
    return BillingConfig(
      id: row['id'] as String,
      schoolId: row['school_id'] as String?,
      currencyCode: row['currency_code'] ?? 'USD',
      lateFeePercentage: (row['late_fee_percentage'] as num?)?.toDouble() ?? 0.0,
      invoiceFooterNote: row['invoice_footer_note'] as String?,
      allowPartialPayments: (row['allow_partial_payments'] == 1),
      defaultFee: (row['default_fee'] as num?)?.toDouble() ?? 100.00,
    );
  }
}

class NotificationModel {
  final String id;
  final String userId;
  final String? schoolId;
  final String title;
  final String body;
  final String type; // 'info', 'warning', etc.
  final bool isRead;
  final DateTime createdAt;

  NotificationModel({
    required this.id,
    required this.userId,
    this.schoolId,
    required this.title,
    required this.body,
    this.type = 'info',
    this.isRead = false,
    required this.createdAt,
  });

  factory NotificationModel.fromRow(Map<String, dynamic> row) {
    return NotificationModel(
      id: row['id'] as String,
      userId: row['user_id'] as String,
      schoolId: row['school_id'] as String?,
      title: row['title'] as String,
      body: row['body'] as String,
      type: row['type'] ?? 'info',
      isRead: (row['is_read'] == 1),
      createdAt: DateTime.parse(row['created_at']),
    );
  }
}
// ==========================================
// FILE: ./data/models/academic_models.dart
// ==========================================

class ClassModel {
  final String id;
  final String schoolId;
  final String name;
  final String? teacherId;
  final String? roomNumber;
  final String? subjectCode;

  ClassModel({
    required this.id,
    required this.schoolId,
    required this.name,
    this.teacherId,
    this.roomNumber,
    this.subjectCode,
  });

  factory ClassModel.fromRow(Map<String, dynamic> row) {
    return ClassModel(
      id: row['id'] as String,
      schoolId: row['school_id'] as String,
      name: row['name'] as String,
      teacherId: row['teacher_id'] as String?,
      roomNumber: row['room_number'] as String?,
      subjectCode: row['subject_code'] as String?,
    );
  }
}

class Enrollment {
  final String id;
  final String schoolId;
  final String studentId;
  final String classId;
  final DateTime enrolledAt;

  Enrollment({
    required this.id,
    required this.schoolId,
    required this.studentId,
    required this.classId,
    required this.enrolledAt,
  });

  factory Enrollment.fromRow(Map<String, dynamic> row) {
    return Enrollment(
      id: row['id'] as String,
      schoolId: row['school_id'] as String,
      studentId: row['student_id'] as String,
      classId: row['class_id'] as String,
      enrolledAt: DateTime.tryParse(row['enrolled_at'] ?? '') ?? DateTime.now(),
    );
  }
}

class SchoolYear {
  final String id;
  final String schoolId;
  final String yearLabel; // e.g., "2025"
  final DateTime startDate;
  final DateTime endDate;
  final bool active;

  SchoolYear({
    required this.id,
    required this.schoolId,
    required this.yearLabel,
    required this.startDate,
    required this.endDate,
    this.active = false,
  });

  factory SchoolYear.fromRow(Map<String, dynamic> row) {
    return SchoolYear(
      id: row['id'] as String,
      schoolId: row['school_id'] as String,
      yearLabel: row['year_label'] as String,
      startDate: DateTime.parse(row['start_date']),
      endDate: DateTime.parse(row['end_date']),
      active: (row['active'] == 1),
    );
  }
}

class SchoolYearMonth {
  final String id;
  final String schoolYearId;
  final String name; // "January"
  final int monthIndex; // 1
  final DateTime startDate;
  final DateTime endDate;
  final bool isBillable;

  SchoolYearMonth({
    required this.id,
    required this.schoolYearId,
    required this.name,
    required this.monthIndex,
    required this.startDate,
    required this.endDate,
    this.isBillable = true,
  });

  factory SchoolYearMonth.fromRow(Map<String, dynamic> row) {
    return SchoolYearMonth(
      id: row['id'] as String,
      schoolYearId: row['school_year_id'] as String,
      name: row['name'] as String,
      monthIndex: (row['month_index'] as num).toInt(),
      startDate: DateTime.parse(row['start_date']),
      endDate: DateTime.parse(row['end_date']),
      isBillable: (row['is_billable'] == 1),
    );
  }
}

class SchoolTerm {
  final String id;
  final String schoolId;
  final String name; // "Term 1"
  final DateTime startDate;
  final DateTime endDate;
  final int academicYear;

  SchoolTerm({
    required this.id,
    required this.schoolId,
    required this.name,
    required this.startDate,
    required this.endDate,
    required this.academicYear,
  });

  factory SchoolTerm.fromRow(Map<String, dynamic> row) {
    return SchoolTerm(
      id: row['id'] as String,
      schoolId: row['school_id'] as String,
      name: row['name'] as String,
      startDate: DateTime.parse(row['start_date']),
      endDate: DateTime.parse(row['end_date']),
      academicYear: (row['academic_year'] as num).toInt(),
    );
  }
}
// ==========================================
// FILE: ./data/models/all_models.dart
// ==========================================

/// Greyway.Co - Batch Tech 
/// Master Models Export - "The Fortress Architecture"
library;

export 'academic_models.dart';
export 'announcement_model.dart';
export 'attendance_models.dart';
export 'broadcast_model.dart';
export 'core_models.dart';
export 'finance_details_model.dart';
export 'finance_models.dart';
export 'fundraiser_models.dart';
export 'staff_model.dart';
export 'student_model.dart';
export 'subjects.dart';
export 'system_models.dart' hide Expense;
// ==========================================
// FILE: ./data/models/announcement_model.dart
// ==========================================

import 'package:flutter/material.dart';
import '../../core/constants/app_colors.dart';

enum AnnouncementCategory {
  // Original
  financial,
  academic,
  urgent,
  system,
  
  // The "Rainbow" Types
  success,        // Green
  failure,        // Red
  warning,        // Amber
  info,           // Blue
  security,       // Purple
}

class Announcement {
  final String id;
  final String schoolId;
  final String title;
  final String body;
  final DateTime time;
  final AnnouncementCategory category;
  final bool isRead;
  final String? userId; // For personal notifications

  Announcement({
    required this.id,
    required this.schoolId,
    required this.title,
    required this.body,
    required this.time,
    required this.category,
    required this.isRead,
    this.userId,
  });

  // --- FACTORY: THE CRASH FIX ---
  factory Announcement.fromRow(Map<String, dynamic> row) {
    // 1. Safe Boolean Parsing (Handles 1, 0, true, false, and null)
    final rawRead = row['is_read'];
    bool isReadSafe = false;
    if (rawRead is bool) {
      isReadSafe = rawRead;
    } else if (rawRead is int) {
      isReadSafe = rawRead == 1;
    }

    // 2. Safe Date Parsing
    DateTime parsedTime = DateTime.now();
    if (row['created_at'] != null) {
      parsedTime = DateTime.tryParse(row['created_at'].toString())?.toLocal() ?? DateTime.now();
    }

    return Announcement(
      id: row['id']?.toString() ?? '',
      schoolId: row['school_id']?.toString() ?? '',
      userId: row['user_id']?.toString(),
      title: row['title']?.toString() ?? 'No Title',
      body: row['body']?.toString() ?? '',
      time: parsedTime,
      isRead: isReadSafe,
      category: _parseCategory(row['type']?.toString() ?? 'info'),
    );
  }

  static AnnouncementCategory _parseCategory(String type) {
    switch (type.toLowerCase()) {
      case 'financial': return AnnouncementCategory.financial;
      case 'academic': return AnnouncementCategory.academic;
      case 'urgent': return AnnouncementCategory.urgent;
      case 'system': return AnnouncementCategory.system;
      case 'success': return AnnouncementCategory.success;
      case 'failure': 
      case 'error': return AnnouncementCategory.failure;
      case 'warning': return AnnouncementCategory.warning;
      case 'security': return AnnouncementCategory.security;
      default: return AnnouncementCategory.info;
    }
  }

  Map<String, dynamic> toMap() {
    return {
      'id': id,
      'school_id': schoolId,
      'user_id': userId,
      'title': title,
      'body': body,
      'type': category.name, 
      'is_read': isRead ? 1 : 0, // Store as Int for SQLite compatibility
      'created_at': time.toIso8601String(),
    };
  }

  // --- VISUAL GETTERS ---

  Color get color {
    switch (category) {
      case AnnouncementCategory.urgent:
      case AnnouncementCategory.failure:
        return AppColors.errorRed;
      
      case AnnouncementCategory.warning:
        return Colors.amber;
      
      case AnnouncementCategory.success:
        return AppColors.successGreen;
      
      case AnnouncementCategory.financial:
        return const Color(0xFF00BFA5); // Teal
      
      case AnnouncementCategory.security:
        return const Color(0xFF9333EA); // Purple
        
      case AnnouncementCategory.system:
      case AnnouncementCategory.info:
      default:
        return AppColors.primaryBlue;
    }
  }

  IconData get icon {
    switch (category) {
      case AnnouncementCategory.urgent: return Icons.notification_important_rounded;
      case AnnouncementCategory.failure: return Icons.error_outline_rounded;
      case AnnouncementCategory.warning: return Icons.warning_amber_rounded;
      case AnnouncementCategory.success: return Icons.check_circle_outline_rounded;
      case AnnouncementCategory.financial: return Icons.attach_money_rounded;
      case AnnouncementCategory.security: return Icons.security_rounded;
      case AnnouncementCategory.academic: return Icons.school_outlined;
      case AnnouncementCategory.system: return Icons.dns_outlined;
      default: return Icons.info_outline_rounded;
    }
  }

  String get badgeLabel {
    return category.name.toUpperCase();
  }
}
// ==========================================
// FILE: ./data/models/attendance_models.dart
// ==========================================

class Attendance {
  final String id;
  final String schoolId;
  final String studentId;
  final String? classId;
  final DateTime date;
  final String status; // 'present', 'absent', 'late', 'excused'
  final String? remarks;
  final String? recordedBy;

  Attendance({
    required this.id,
    required this.schoolId,
    required this.studentId,
    this.classId,
    required this.date,
    this.status = 'present',
    this.remarks,
    this.recordedBy,
  });

  factory Attendance.fromRow(Map<String, dynamic> row) {
    return Attendance(
      id: row['id'] as String,
      schoolId: row['school_id'] as String,
      studentId: row['student_id'] as String,
      classId: row['class_id'] as String?,
      date: DateTime.parse(row['date']),
      status: row['status'] ?? 'present',
      remarks: row['remarks'] as String?,
      recordedBy: row['recorded_by'] as String?,
    );
  }
}

class AttendanceSession {
  final String id;
  final String schoolId;
  final String classId;
  final String teacherId;
  final DateTime sessionDate;
  final bool isConfirmedByTeacher;
  final DateTime? confirmedAt;

  AttendanceSession({
    required this.id,
    required this.schoolId,
    required this.classId,
    required this.teacherId,
    required this.sessionDate,
    this.isConfirmedByTeacher = false,
    this.confirmedAt,
  });

  factory AttendanceSession.fromRow(Map<String, dynamic> row) {
    return AttendanceSession(
      id: row['id'] as String,
      schoolId: row['school_id'] as String,
      classId: row['class_id'] as String,
      teacherId: row['teacher_id'] as String,
      sessionDate: DateTime.parse(row['session_date']),
      isConfirmedByTeacher: (row['is_confirmed_by_teacher'] == 1),
      confirmedAt: row['confirmed_at'] != null 
          ? DateTime.tryParse(row['confirmed_at']) 
          : null,
    );
  }
}
// ==========================================
// FILE: ./data/models/finance_models.dart
// ==========================================

// ==========================================
// BILL MODEL
// ==========================================
class Bill {
  final String id;
  final String schoolId;
  final String studentId;
  final String title;
  final double totalAmount;
  final double paidAmount;
  final bool isPaid;
  final DateTime? dueDate;
  final String billType; // 'monthly', 'adhoc'
  final bool isClosed;
  final String? termId;

  Bill({
    required this.id,
    required this.schoolId,
    required this.studentId,
    required this.title,
    required this.totalAmount,
    this.paidAmount = 0.0,
    this.isPaid = false,
    this.dueDate,
    this.billType = 'monthly',
    this.isClosed = false,
    this.termId,
  });

  factory Bill.fromRow(Map<String, dynamic> row) {
    return Bill(
      id: row['id'] as String,
      schoolId: row['school_id'] as String,
      studentId: row['student_id'] as String,
      title: row['title'] as String,
      totalAmount: (row['total_amount'] as num?)?.toDouble() ?? 0.0,
      paidAmount: (row['paid_amount'] as num?)?.toDouble() ?? 0.0,
      isPaid: (row['is_paid'] == 1),
      dueDate: row['due_date'] != null ? DateTime.tryParse(row['due_date']) : null,
      billType: row['bill_type'] ?? 'monthly',
      isClosed: (row['is_closed'] == 1),
      termId: row['term_id'] as String?,
    );
  }

  Map<String, dynamic> toMap() {
    return {
      'id': id,
      'school_id': schoolId,
      'student_id': studentId,
      'title': title,
      'total_amount': totalAmount,
      'paid_amount': paidAmount,
      'is_paid': isPaid ? 1 : 0,
      'due_date': dueDate?.toIso8601String(),
      'bill_type': billType,
      'is_closed': isClosed ? 1 : 0,
      'term_id': termId,
    };
  }
}

// ==========================================
// PAYMENT MODEL
// ==========================================
class Payment {
  final String id;
  final String schoolId;
  final String studentId;
  final double amount;
  final DateTime datePaid;
  final String method; // 'cash', 'ecocash', etc.
  final String? payerName;
  final String? billId;

  Payment({
    required this.id,
    required this.schoolId,
    required this.studentId,
    required this.amount,
    required this.datePaid,
    this.method = 'cash',
    this.payerName,
    this.billId,
  });

  factory Payment.fromRow(Map<String, dynamic> row) {
    return Payment(
      id: row['id'] as String,
      schoolId: row['school_id'] as String,
      studentId: row['student_id'] as String,
      amount: (row['amount'] as num?)?.toDouble() ?? 0.0,
      datePaid: row['date_paid'] != null 
          ? DateTime.tryParse(row['date_paid']) ?? DateTime.now()
          : DateTime.now(),
      method: row['method'] ?? 'cash',
      payerName: row['payer_name'] as String?,
      billId: row['bill_id'] as String?,
    );
  }

  Map<String, dynamic> toMap() {
    return {
      'id': id,
      'school_id': schoolId,
      'student_id': studentId,
      'amount': amount,
      'date_paid': datePaid.toIso8601String(),
      'method': method,
      'payer_name': payerName,
      'bill_id': billId,
    };
  }
}

class Expense {
  final String id;
  final String schoolId;
  final String title;
  final double amount;
  final String? category;
  final DateTime incurredAt;
  final String? description; // Maps to 'description' column
  final String? recipient;

  Expense({
    required this.id,
    required this.schoolId,
    required this.title,
    required this.amount,
    this.category,
    required this.incurredAt,
    this.description,
    this.recipient,
  });

  factory Expense.fromRow(Map<String, dynamic> row) {
    return Expense(
      id: row['id'] as String,
      schoolId: row['school_id'] as String,
      title: row['title'] as String,
      amount: (row['amount'] as num).toDouble(),
      category: row['category'] as String?,
      incurredAt: DateTime.tryParse(row['incurred_at'] ?? '') ?? DateTime.now(),
      description: row['description'] as String?,
      recipient: row['recipient'] as String?,
    );
  }

  Map<String, dynamic> toMap() {
    return {
      'id': id,
      'school_id': schoolId,
      'title': title,
      'amount': amount,
      'category': category,
      'incurred_at': incurredAt.toIso8601String(),
      'description': description,
      'recipient': recipient,
      // 'created_at' is usually handled by Supabase defaults, 
      // but for PowerSync offline-first, we often include it.
      'created_at': DateTime.now().toIso8601String(), 
    };
  }
}
// ==========================================
// FILE: ./data/models/subjects.dart
// ==========================================

// File: lib/models/subjects.dart

class ZimsecSubject {
  static const Map<int, String> _codeMap = {
    // --- FORM 1 - 4 (O-LEVEL) CORE ---
    // These are the "Must-Haves" for almost every student.
    4005: 'English Language',
    4004: 'Mathematics',
    4003: 'Combined Science', // Replaces Integrated Science
    4006: 'Heritage Studies',
    4007: 'Shona',
    4068: 'Ndebele',
    4001: 'Agriculture',

    // --- FORM 1 - 4 (O-LEVEL) POPULAR ELECTIVES ---
    // Commercials & Arts
    4049: 'Commerce',
    4037: 'Geography',
    4044: 'History',
    4047: 'Family & Religious Studies', // F.R.S (formerly Divinity/R.E)
    4048: 'Business Enterprise Skills',
    4051: 'Principles of Accounting',

    // Sciences & Tech
    4029: 'Computer Science',
    4025: 'Biology',
    4023: 'Physics',
    4024:
        'Chemistry', // Often listed as 5070/5071 in older systems, but 4024 in new curriculum maps
    4059: 'Wood Technology and Design',

    // --- FORM 5 - 6 (A-LEVEL) ---
    // Commercials
    6001: 'Accounting (A-Level)',
    6025: 'Business Studies',
    6073: 'Economics',

    // Arts / Humanities
    6022: 'Geography (A-Level)',
    6006: 'History (A-Level)',
    6003: 'Divinity',
    6009: 'Literature in English',
    6081: 'Heritage Studies (A-Level)',

    // Sciences
    6042: 'Pure Mathematics',
    6030: 'Biology (A-Level)',
    6031: 'Chemistry (A-Level)',
    6032: 'Physics (A-Level)',
    6046: 'Statistics',
    6008: 'Computer Science (A-Level)',
  };

  // This is the getter your Registration Page is looking for:
  static List<String> get allNames => _codeMap.values.toList();

  static String nameFromCode(int code) => _codeMap[code] ?? 'Unknown';
}

class EnrolledSubject {
  final String subjectName;
  final String studentId;

  EnrolledSubject({required this.subjectName, required this.studentId});

  Map<String, dynamic> toJson() => {
    'subjectName': subjectName,
    'studentId': studentId,
  };

  factory EnrolledSubject.fromJson(Map<String, dynamic> json) {
    return EnrolledSubject(
      subjectName: json['subjectName'],
      studentId: json['studentId'],
    );
  }
}
// ==========================================
// FILE: ./data/models/student_model.dart
// ==========================================

class Student {
  final String id;
  final String schoolId;
  final String fullName;
  final String? studentId; // Manual ID (e.g., "STD-001")
  final String? grade;
  final String? parentContact;
  final DateTime? registrationDate;
  final String billingType; // 'monthly', 'termly'
  final double defaultFee;
  final bool isActive;
  final double owedTotal;
  final double paidTotal;
  final String? termId;
  final DateTime? dateOfBirth;
  final String? gender;
  final String? address;
  final String? emergencyContactName;
  final String? medicalNotes;
  final bool photoConsent;

  Student({
    required this.id,
    required this.schoolId,
    required this.fullName,
    this.studentId,
    this.grade,
    this.parentContact,
    this.registrationDate,
    this.billingType = 'monthly',
    this.defaultFee = 0.0,
    this.isActive = true,
    this.owedTotal = 0.0,
    this.paidTotal = 0.0,
    this.termId,
    this.dateOfBirth,
    this.gender,
    this.address,
    this.emergencyContactName,
    this.medicalNotes,
    this.photoConsent = false,
  });

  // Factory to create a Student from a PowerSync/SQLite Row
  factory Student.fromRow(Map<String, dynamic> row) {
    return Student(
      id: row['id'] as String,
      schoolId: row['school_id'] as String,
      fullName: row['full_name'] as String,
      studentId: row['student_id'] as String?,
      grade: row['grade'] as String?,
      parentContact: row['parent_contact'] as String?,
      registrationDate: row['registration_date'] != null 
          ? DateTime.tryParse(row['registration_date']) 
          : null,
      billingType: row['billing_type'] ?? 'monthly',
      defaultFee: (row['default_fee'] as num?)?.toDouble() ?? 0.0,
      isActive: (row['is_active'] == 1), // SQLite stores bools as 0/1
      owedTotal: (row['owed_total'] as num?)?.toDouble() ?? 0.0,
      paidTotal: (row['paid_total'] as num?)?.toDouble() ?? 0.0,
      termId: row['term_id'] as String?,
      dateOfBirth: row['date_of_birth'] != null 
          ? DateTime.tryParse(row['date_of_birth']) 
          : null,
      gender: row['gender'] as String?,
      address: row['address'] as String?,
      emergencyContactName: row['emergency_contact_name'] as String?,
      medicalNotes: row['medical_notes'] as String?,
      photoConsent: (row['photo_consent'] == 1),
    );
  }

  // Convert to Map for saving to Database
  Map<String, dynamic> toMap() {
    return {
      'id': id,
      'school_id': schoolId,
      'full_name': fullName,
      'student_id': studentId,
      'grade': grade,
      'parent_contact': parentContact,
      'registration_date': registrationDate?.toIso8601String(),
      'billing_type': billingType,
      'default_fee': defaultFee,
      'is_active': isActive ? 1 : 0,
      'owed_total': owedTotal,
      'paid_total': paidTotal,
      'term_id': termId,
      'date_of_birth': dateOfBirth?.toIso8601String(),
      'gender': gender,
      'address': address,
      'emergency_contact_name': emergencyContactName,
      'medical_notes': medicalNotes,
      'photo_consent': photoConsent ? 1 : 0,
    };
  }
}
// ==========================================
// FILE: ./data/models/fundraiser_models.dart
// ==========================================

class Campaign {
  final String id;
  final String schoolId;
  final String createdById;
  final String name;
  final String? description;
  final String type; // Added to match Schema 'campaign_type'
  final String status; 
  final double goalAmount;
  final DateTime createdAt; // Useful for sorting

  Campaign({
    required this.id,
    required this.schoolId,
    required this.createdById,
    required this.name,
    this.description,
    this.type = 'General',
    this.status = 'active',
    this.goalAmount = 0.0,
    required this.createdAt,
  });

  factory Campaign.fromRow(Map<String, dynamic> row) {
    return Campaign(
      id: row['id'] as String,
      schoolId: row['school_id'] as String,
      createdById: row['created_by_id'] ?? '',
      name: row['name'] as String,
      description: row['description'] as String?,
      type: row['campaign_type'] ?? 'General',
      status: row['status'] ?? 'active',
      goalAmount: (row['goal_amount'] as num?)?.toDouble() ?? 0.0,
      createdAt: DateTime.tryParse(row['created_at'] ?? '') ?? DateTime.now(),
    );
  }

  Map<String, dynamic> toMap() {
    return {
      'id': id,
      'school_id': schoolId,
      'created_by_id': createdById,
      'name': name,
      'description': description,
      'campaign_type': type,
      'status': status,
      'goal_amount': goalAmount,
      'created_at': createdAt.toIso8601String(),
    };
  }
}

class CampaignDonation {
  final String id;
  final String campaignId;
  final String? donorName;
  final double amount;
  final String? paymentMethod;
  final DateTime dateReceived;
  final double expectedCash;
  final double actualCash;
  final double variance;

  CampaignDonation({
    required this.id,
    required this.campaignId,
    this.donorName,
    this.amount = 0.0,
    this.paymentMethod,
    required this.dateReceived,
    this.expectedCash = 0.0,
    this.actualCash = 0.0,
    this.variance = 0.0,
  });

  factory CampaignDonation.fromRow(Map<String, dynamic> row) {
    return CampaignDonation(
      id: row['id'] as String,
      campaignId: row['campaign_id'] as String,
      donorName: row['donor_name'] as String?,
      amount: (row['amount'] as num?)?.toDouble() ?? 0.0,
      paymentMethod: row['payment_method'] as String?,
      dateReceived: DateTime.tryParse(row['date_received'] ?? '') ?? DateTime.now(),
      expectedCash: (row['expected_cash'] as num?)?.toDouble() ?? 0.0,
      actualCash: (row['actual_cash'] as num?)?.toDouble() ?? 0.0,
      variance: (row['variance'] as num?)?.toDouble() ?? 0.0,
    );
  }
}

class CampaignExpense {
  final String id;
  final String campaignId;
  final String? category;
  final double amount;
  final String? incurredBy;

  CampaignExpense({
    required this.id,
    required this.campaignId,
    this.category,
    required this.amount,
    this.incurredBy,
  });

  factory CampaignExpense.fromRow(Map<String, dynamic> row) {
    return CampaignExpense(
      id: row['id'] as String,
      campaignId: row['campaign_id'] as String,
      category: row['category'] as String?,
      amount: (row['amount'] as num?)?.toDouble() ?? 0.0,
      incurredBy: row['incurred_by'] as String?,
    );
  }
}

class BankingRegister {
  final String id;
  final String? campaignId;
  final double amount;
  final String direction; // 'in' or 'out'
  final String? reference;
  final String schoolId;

  BankingRegister({
    required this.id,
    this.campaignId,
    required this.amount,
    required this.direction,
    this.reference,
    required this.schoolId,
  });

  factory BankingRegister.fromRow(Map<String, dynamic> row) {
    return BankingRegister(
      id: row['id'] as String,
      campaignId: row['campaign_id'] as String?,
      amount: (row['amount'] as num?)?.toDouble() ?? 0.0,
      direction: row['direction'] as String,
      reference: row['reference'] as String?,
      schoolId: row['school_id'] as String,
    );
  }
}
// ==========================================
// FILE: ./data/models/staff_model.dart
// ==========================================

// ==========================================
// TEACHER MODEL
// ==========================================
class Teacher {
  final String id;
  final String schoolId;
  final String fullName;
  final String? adminUid; // Links to user_profiles if they have logged in
  final DateTime createdAt;

  Teacher({
    required this.id,
    required this.schoolId,
    required this.fullName,
    this.adminUid,
    required this.createdAt,
  });

  factory Teacher.fromRow(Map<String, dynamic> row) {
    return Teacher(
      id: row['id'] as String,
      schoolId: row['school_id'] as String,
      fullName: row['full_name'] as String,
      adminUid: row['admin_uid'] as String?,
      createdAt: row['created_at'] != null 
          ? DateTime.tryParse(row['created_at']) ?? DateTime.now() 
          : DateTime.now(),
    );
  }

  Map<String, dynamic> toMap() {
    return {
      'id': id,
      'school_id': schoolId,
      'full_name': fullName,
      'admin_uid': adminUid,
      'created_at': createdAt.toIso8601String(),
    };
  }
}

// ==========================================
// TEACHER ACCESS TOKEN MODEL
// ==========================================
class TeacherAccessToken {
  final String id;
  final String schoolId;
  final String teacherId;
  final String grantedByTeacherId;
  final String accessCode;
  final String permissionType; // 'attendance', 'campaigns', 'both'
  final bool isUsed;
  final DateTime? usedAt;
  final DateTime expiresAt;

  TeacherAccessToken({
    required this.id,
    required this.schoolId,
    required this.teacherId,
    required this.grantedByTeacherId,
    required this.accessCode,
    required this.permissionType,
    this.isUsed = false,
    this.usedAt,
    required this.expiresAt,
  });

  bool get isExpired => DateTime.now().isAfter(expiresAt);

  factory TeacherAccessToken.fromRow(Map<String, dynamic> row) {
    return TeacherAccessToken(
      id: row['id'] as String,
      schoolId: row['school_id'] as String,
      teacherId: row['teacher_id'] as String,
      grantedByTeacherId: row['granted_by_teacher_id'] as String,
      accessCode: row['access_code'] as String,
      permissionType: row['permission_type'] ?? 'attendance',
      isUsed: (row['is_used'] == 1), // SQLite boolean handling
      usedAt: row['used_at'] != null 
          ? DateTime.tryParse(row['used_at']) 
          : null,
      expiresAt: row['expires_at'] != null 
          ? DateTime.tryParse(row['expires_at']) ?? DateTime.now()
          : DateTime.now(),
    );
  }

  Map<String, dynamic> toMap() {
    return {
      'id': id,
      'school_id': schoolId,
      'teacher_id': teacherId,
      'granted_by_teacher_id': grantedByTeacherId,
      'access_code': accessCode,
      'permission_type': permissionType,
      'is_used': isUsed ? 1 : 0,
      'used_at': usedAt?.toIso8601String(),
      'expires_at': expiresAt.toIso8601String(),
    };
  }
}
// ==========================================
// FILE: ./data/models/broadcast_model.dart
// ==========================================

import 'package:fees_up/core/constants/app_colors.dart';
import 'package:flutter/material.dart';

class Broadcast {
  final String id;
  final String? schoolId; // Null = Global Greyway.Co Broadcast
  final String authorId;
  final bool isSystemMessage;
  final String targetRole; // 'all', 'teacher', 'hq_internal'
  final String title;
  final String body;
  final String priority;
  final DateTime createdAt;

  Broadcast({
    required this.id,
    this.schoolId,
    required this.authorId,
    this.isSystemMessage = false,
    required this.targetRole,
    required this.title,
    required this.body,
    required this.priority,
    required this.createdAt,
  });

  factory Broadcast.fromRow(Map<String, dynamic> row) {
    return Broadcast(
      id: row['id'] as String,
      schoolId: row['school_id'] as String?,
      authorId: row['author_id'] as String,
      isSystemMessage: (row['is_system_message'] == 1),
      targetRole: row['target_role'] ?? 'all',
      title: row['title'] as String,
      body: row['body'] as String,
      priority: row['priority'] ?? 'normal',
      createdAt: DateTime.tryParse(row['created_at'] ?? '') ?? DateTime.now(),
    );
  }

  Map<String, dynamic> toMap() {
    return {
      'id': id,
      'school_id': schoolId,
      'author_id': authorId,
      'is_system_message': isSystemMessage ? 1 : 0,
      'target_role': targetRole,
      'title': title,
      'body': body,
      'priority': priority,
      'created_at': createdAt.toIso8601String(),
    };
  }

  // --- CE0 UI HELPERS ---
  
  bool get isInternalHQ => targetRole == 'hq_internal';

  Color get badgeColor {
    if (isInternalHQ) return AppColors.accentPurpleDark; // Security Purple
    if (isSystemMessage) return  AppColors.primaryBlue; // System Blue
    if (priority == 'critical') return AppColors.errorRed; // Failure Red
    return AppColors.successGreen; // General Green
  }

  String get authorLabel {
    if (isInternalHQ) return "Greyway HQ";
    if (isSystemMessage) return "Fees Up System";
    return "School Admin";
  }

  IconData get icon {
    if (isInternalHQ) return Icons.security;
    if (isSystemMessage) return Icons.settings_suggest;
    if (priority == 'critical') return Icons.report_problem;
    return Icons.campaign;
  }
}
// ==========================================
// FILE: ./data/models/finance_details_model.dart
// ==========================================

// ==========================================
// BILL ITEM MODEL (Line items inside a bill)
// ==========================================
class BillItem {
  final String id;
  final String billId;
  final String schoolId;
  final String description;
  final double amount;
  final int quantity;

  BillItem({
    required this.id,
    required this.billId,
    required this.schoolId,
    required this.description,
    required this.amount,
    this.quantity = 1,
  });

  // Calculate total for this line item
  double get total => amount * quantity;

  factory BillItem.fromRow(Map<String, dynamic> row) {
    return BillItem(
      id: row['id'] as String,
      billId: row['bill_id'] as String,
      schoolId: row['school_id'] as String,
      description: row['description'] as String,
      amount: (row['amount'] as num?)?.toDouble() ?? 0.0,
      quantity: (row['quantity'] as num?)?.toInt() ?? 1,
    );
  }

  Map<String, dynamic> toMap() {
    return {
      'id': id,
      'bill_id': billId,
      'school_id': schoolId,
      'description': description,
      'amount': amount,
      'quantity': quantity,
    };
  }
}

// ==========================================
// PAYMENT ALLOCATION MODEL (Splitting one payment across bills)
// ==========================================
class PaymentAllocation {
  final String id;
  final String paymentId;
  final String billId;
  final String schoolId;
  final double amount;

  PaymentAllocation({
    required this.id,
    required this.paymentId,
    required this.billId,
    required this.schoolId,
    required this.amount,
  });

  factory PaymentAllocation.fromRow(Map<String, dynamic> row) {
    return PaymentAllocation(
      id: row['id'] as String,
      paymentId: row['payment_id'] as String,
      billId: row['bill_id'] as String,
      schoolId: row['school_id'] as String,
      amount: (row['amount'] as num?)?.toDouble() ?? 0.0,
    );
  }

  Map<String, dynamic> toMap() {
    return {
      'id': id,
      'payment_id': paymentId,
      'bill_id': billId,
      'school_id': schoolId,
      'amount': amount,
    };
  }
}

// ==========================================
// CREDIT MODEL (Discounts or overpayments)
// ==========================================
class Credit {
  final String id;
  final String schoolId;
  final String studentId;
  final String? billId; // If applied to a specific bill
  final double amount;
  final String? reason;
  final String? creditId; // Manual reference ID

  Credit({
    required this.id,
    required this.schoolId,
    required this.studentId,
    required this.amount,
    this.billId,
    this.reason,
    this.creditId,
  });

  factory Credit.fromRow(Map<String, dynamic> row) {
    return Credit(
      id: row['id'] as String,
      schoolId: row['school_id'] as String,
      studentId: row['student_id'] as String,
      amount: (row['amount'] as num?)?.toDouble() ?? 0.0,
      billId: row['bill_id'] as String?,
      reason: row['reason'] as String?,
      creditId: row['credit_id'] as String?,
    );
  }

  Map<String, dynamic> toMap() {
    return {
      'id': id,
      'school_id': schoolId,
      'student_id': studentId,
      'amount': amount,
      'bill_id': billId,
      'reason': reason,
      'credit_id': creditId,
    };
  }
}
// ==========================================
// FILE: ./data/models/system_models.dart
// ==========================================

import 'dart:convert'; // Required for JSON decoding

class StudentArchive {
  final String id;
  final String schoolId;
  final String? fullName;
  final String? reason;
  final DateTime archivedAt;
  final Map<String, dynamic>? originalData; // Stored as JSONB in SQL

  StudentArchive({
    required this.id,
    required this.schoolId,
    this.fullName,
    this.reason,
    required this.archivedAt,
    this.originalData,
  });

  factory StudentArchive.fromRow(Map<String, dynamic> row) {
    return StudentArchive(
      id: row['id'] as String,
      schoolId: row['school_id'] as String,
      fullName: row['full_name'] as String?,
      reason: row['reason'] as String?,
      archivedAt: DateTime.tryParse(row['archived_at'] ?? '') ?? DateTime.now(),
      // Handle potential JSON string from SQLite
      originalData: row['original_data'] != null
          ? (row['original_data'] is String 
              ? jsonDecode(row['original_data']) 
              : row['original_data'])
          : null,
    );
  }
}

class Expense {
  final String id;
  final String schoolId;
  final String title;
  final double amount;
  final String? category;
  final DateTime incurredAt;
  final String? description;
  final String? recipient;
  final String? paymentMethod;

  Expense({
    required this.id,
    required this.schoolId,
    required this.title,
    required this.amount,
    this.category,
    required this.incurredAt,
    this.description,
    this.recipient,
    this.paymentMethod,
  });

  factory Expense.fromRow(Map<String, dynamic> row) {
    return Expense(
      id: row['id'] as String,
      schoolId: row['school_id'] as String,
      title: row['title'] as String,
      amount: (row['amount'] as num).toDouble(),
      category: row['category'] as String?,
      incurredAt: DateTime.tryParse(row['incurred_at'] ?? '') ?? DateTime.now(),
      description: row['description'] as String?,
      recipient: row['recipient'] as String?,
      paymentMethod: row['payment_method'] as String?,
    );
  }

  Map<String, dynamic> toMap() {
    return {
      'id': id,
      'school_id': schoolId,
      'title': title,
      'amount': amount,
      'category': category,
      'incurred_at': incurredAt.toIso8601String(),
      'description': description,
      'recipient': recipient,
      'payment_method': paymentMethod,
    };
  }
}
// ==========================================
// FILE: ./data/providers/billing_engine_provider.dart
// ==========================================

/// ============================================================================
/// BILLING ENGINE PROVIDER - RIVERPOD STATE MANAGEMENT
/// ============================================================================
library billing_engine_provider;

import 'package:fees_up/data/services/billing_engine.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';

// Create instance provider for BillingEngine
final billingEngineProvider = Provider.family<BillingEngine, String>((ref, schoolId) {
  return BillingEngine(schoolId: schoolId);
});

// Provider for batch billing processor
final batchBillingProcessorProvider =
    Provider.family<BatchBillingProcessor, String>((ref, schoolId) {
  final engine = ref.watch(billingEngineProvider(schoolId));
  return BatchBillingProcessor(engine: engine);
});

// Provider for tracking generated bills
final generatedBillsProvider = StateNotifierProvider.family<
    GeneratedBillsNotifier,
    List<GeneratedBill>,
    String>((ref, schoolId) {
  return GeneratedBillsNotifier(schoolId);
});

// StateNotifier for managing generated bills
class GeneratedBillsNotifier extends StateNotifier<List<GeneratedBill>> {
  final String schoolId;

  GeneratedBillsNotifier(this.schoolId) : super([]);

  void addBill(GeneratedBill bill) {
    state = [...state, bill];
  }

  void addBills(List<GeneratedBill> bills) {
    state = [...state, ...bills];
  }

  void clearBills() {
    state = [];
  }

  void removeBill(String billId) {
    state = state.where((bill) => bill.id != billId).toList();
  }

  int get totalBills => state.length;
  double get totalAmount => state.fold(0.0, (sum, bill) => sum + bill.total);
}

// Provider for billing configurations cache
final billingConfigCacheProvider = StateNotifierProvider.family<
    BillingConfigCacheNotifier,
    Map<String, BillingConfiguration>,
    String>((ref, schoolId) {
  return BillingConfigCacheNotifier(schoolId);
});

class BillingConfigCacheNotifier
    extends StateNotifier<Map<String, BillingConfiguration>> {
  final String schoolId;

  BillingConfigCacheNotifier(this.schoolId) : super({});

  void registerConfig(BillingConfiguration config) {
    state = {...state, config.id: config};
  }

  void registerConfigs(List<BillingConfiguration> configs) {
    final newState = {...state};
    for (final config in configs) {
      newState[config.id] = config;
    }
    state = newState;
  }

  BillingConfiguration? getConfig(String configId) => state[configId];

  List<BillingConfiguration> getActiveConfigs() =>
      state.values.where((config) => config.isActive).toList();
}

// Provider for billing switch history
final billingSwitchHistoryProvider = StateNotifierProvider.family<
    BillingSwitchHistoryNotifier,
    Map<String, List<BillingSwitch>>,
    String>((ref, schoolId) {
  return BillingSwitchHistoryNotifier(schoolId);
});

class BillingSwitchHistoryNotifier
    extends StateNotifier<Map<String, List<BillingSwitch>>> {
  final String schoolId;

  BillingSwitchHistoryNotifier(this.schoolId) : super({});

  void recordSwitch(String studentId, BillingSwitch billSwitch) {
    state = {
      ...state,
      studentId: [...(state[studentId] ?? []), billSwitch],
    };
  }

  List<BillingSwitch> getSwitchHistory(String studentId) =>
      state[studentId] ?? [];

  int getTotalSwitches(String studentId) => state[studentId]?.length ?? 0;
}

// ==========================================
// FILE: ./data/providers/report_builder_provider.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:intl/intl.dart';

// --- STATE MODEL ---
class ReportBuilderState {
  final String category;
  final DateTimeRange dateRange;
  final String gradeFilter;
  final String exportFormat; // 'PDF' or 'Excel/CSV'

  ReportBuilderState({
    required this.category,
    required this.dateRange,
    required this.gradeFilter,
    required this.exportFormat,
  });

  ReportBuilderState copyWith({
    String? category,
    DateTimeRange? dateRange,
    String? gradeFilter,
    String? exportFormat,
  }) {
    return ReportBuilderState(
      category: category ?? this.category,
      dateRange: dateRange ?? this.dateRange,
      gradeFilter: gradeFilter ?? this.gradeFilter,
      exportFormat: exportFormat ?? this.exportFormat,
    );
  }
}

// --- NOTIFIER ---
class ReportBuilderNotifier extends StateNotifier<ReportBuilderState> {
  ReportBuilderNotifier() : super(ReportBuilderState(
    category: 'Tuition & Fee Collection',
    dateRange: DateTimeRange(
      start: DateTime.now().subtract(const Duration(days: 30)), 
      end: DateTime.now()
    ),
    gradeFilter: 'All Grades',
    exportFormat: 'PDF',
  ));

  void setCategory(String value) => state = state.copyWith(category: value);
  void setDateRange(DateTimeRange value) => state = state.copyWith(dateRange: value);
  void setGradeFilter(String value) => state = state.copyWith(gradeFilter: value);
  void setExportFormat(String value) => state = state.copyWith(exportFormat: value);
}

// --- PROVIDER ---
final reportBuilderProvider = StateNotifierProvider<ReportBuilderNotifier, ReportBuilderState>((ref) {
  return ReportBuilderNotifier();
});

// --- HELPER TO GET SUMMARY TEXT ---
// Used in the right-side summary panel of your UI
final reportSummaryProvider = Provider.autoDispose<Map<String, String>>((ref) {
  final state = ref.watch(reportBuilderProvider);
  final dateFormat = DateFormat('MMM d, yyyy');

  return {
    'Type': state.category,
    'Period': "${dateFormat.format(state.dateRange.start)} - ${dateFormat.format(state.dateRange.end)}",
    'Scope': state.gradeFilter,
    'Format': state.exportFormat == 'PDF' ? 'PDF Document' : 'Excel / CSV',
  };
});
// ==========================================
// FILE: ./data/providers/campaign_provider.dart
// ==========================================

import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:uuid/uuid.dart';
import '../services/database_service.dart';
import '../models/fundraiser_models.dart';
import 'auth_provider.dart'; 

// 1. WATCH: Listen for ANY active campaign for this school
final activeCampaignProvider = StreamProvider.family<Campaign?, String>((ref, schoolId) {
  final db = DatabaseService();
  // We limit to 1 because the UI logic assumes sequential campaigns for safety
  return db.db.watch(
    "SELECT * FROM campaigns WHERE school_id = ? AND status = 'active' ORDER BY created_at DESC LIMIT 1",
    parameters: [schoolId],
  ).map((rows) {
    if (rows.isEmpty) return null;
    return Campaign.fromRow(rows.first);
  });
});

// 2. CONTROLLER: Handle Create & Close actions
final campaignControllerProvider = StateNotifierProvider<CampaignController, AsyncValue<void>>((ref) {
  return CampaignController(ref);
});

class CampaignController extends StateNotifier<AsyncValue<void>> {
  final Ref _ref;
  CampaignController(this._ref) : super(const AsyncData(null));

  Future<bool> createCampaign({
    required String schoolId,
    required String name,
    required String type,
    required double goal,
    required String description,
  }) async {
    state = const AsyncLoading();
    try {
      final user = _ref.read(currentUserProvider);
      final id = const Uuid().v4();
      
      final newCampaign = Campaign(
        id: id,
        schoolId: schoolId,
        createdById: user?.id ?? 'unknown',
        name: name,
        type: type,
        goalAmount: goal,
        description: description,
        status: 'active',
        createdAt: DateTime.now(),
      );

      await DatabaseService().insert('campaigns', newCampaign.toMap());

      state = const AsyncData(null);
      return true;
    } catch (e, st) {
      state = AsyncError(e, st);
      return false;
    }
  }

  Future<bool> closeCampaign(String campaignId) async {
    state = const AsyncLoading();
    try {
      await DatabaseService().update('campaigns', campaignId, {
        'status': 'closed',
      });
      state = const AsyncData(null);
      return true;
    } catch (e, st) {
      state = AsyncError(e, st);
      return false;
    }
  }
}
// ==========================================
// FILE: ./data/providers/notifications_provider.dart
// ==========================================

import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../models/announcement_model.dart';
import '../repositories/announcements_repository.dart';
import 'school_provider.dart';

/// 1. DATA STREAM
/// The "Single Source of Truth" for the Rainbow Notification system.
/// Listens to PowerSync for any changes in the notifications table.
final notificationsProvider = StreamProvider<List<Announcement>>((ref) {
  final schoolId = ref.watch(activeSchoolIdProvider);
  if (schoolId == null) return const Stream.empty();

  final repository = ref.watch(announcementsRepositoryProvider);
  return repository.watchAnnouncements(schoolId);
});

/// 2. LOGIC CONTROLLER
/// Handles user interactions for the notification system.
final notificationLogicProvider = Provider((ref) => NotificationLogic(ref));

class NotificationLogic {
  final Ref _ref;
  NotificationLogic(this._ref);

  /// Bulk Action: Clears the "Unread" status for everything in the school.
  Future<void> markAllRead() async {
    final schoolId = _ref.read(activeSchoolIdProvider);
    if (schoolId != null) {
      await _ref.read(announcementsRepositoryProvider).markAllAsRead(schoolId);
    }
  }

  /// Single Action: Mark one specific item as read.
  /// Seals the logic gap by calling the explicit repository method.
  Future<void> markAsRead(String notificationId) async {
    final repository = _ref.read(announcementsRepositoryProvider);
    await repository.markOneAsRead(notificationId);
  }

  /// Single Action: Delete a notification (Cleanup rights).
  /// Ensures the "Fortress" table stays clean of old logs.
  Future<void> delete(String notificationId) async {
    final repository = _ref.read(announcementsRepositoryProvider);
    await repository.deleteNotification(notificationId);
  }
}
// ==========================================
// FILE: ./data/providers/dashboard_provider.dart
// ==========================================

import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../repositories/dashboard_repository.dart';
import '../services/database_service.dart';
import 'auth_provider.dart';
import 'school_provider.dart'; // ‚úÖ Imported

final dashboardRepositoryProvider = Provider<DashboardRepository>((ref) {
  return DashboardRepository(DatabaseService());
});

// A simple class to hold our dashboard data snapshot
class DashboardData {
  final String schoolId;
  final String schoolName;
  final String userName;
  final int studentCount;
  final double outstandingBalance;
  final List<Map<String, dynamic>> recentPayments;

  DashboardData({
    required this.schoolId,
    required this.schoolName,
    required this.userName,
    required this.studentCount,
    required this.outstandingBalance,
    required this.recentPayments,
  });
}
final dashboardDataProvider = StreamProvider<DashboardData>((ref) async* {
  final user = ref.watch(currentUserProvider);
  if (user == null) throw 'User not logged in';

  // 1. Get the school data (caches after first successful fetch)
  final school = await ref.watch(currentSchoolProvider.future);
  
  if (school == null) {
    yield DashboardData(
      schoolId: '',
      schoolName: 'Loading...',
      userName: '',
      studentCount: 0,
      outstandingBalance: 0,
      recentPayments: [],
    );
    return;
  }

  final schoolId = school['id'];
  final schoolName = school['name'];
  final dbService = DatabaseService();

  // 2. Listen for ANY changes in the relevant tables
  // This keeps the Batch Tech dashboard live and reactive
  await for (final _ in dbService.db.onChange(['students', 'bills', 'payments', 'user_profiles'])) {
    
    // Fetch profile and stats in parallel for better performance
    final results = await Future.wait([
      dbService.getUserProfile(user.id),
      dbService.db.get('SELECT count(*) as c FROM students WHERE school_id = ?', [schoolId]),
      dbService.db.get('SELECT sum(total_amount - paid_amount) as t FROM bills WHERE school_id = ?', [schoolId]),
      dbService.db.getAll('SELECT * FROM payments WHERE school_id = ? ORDER BY date_paid DESC LIMIT 5', [schoolId]),
    ]);

    final profile = results[0] as Map<String, dynamic>?;
    final students = results[1] as Map<String, dynamic>;
    final bills = results[2] as Map<String, dynamic>;
    final payments = results[3] as List<Map<String, dynamic>>;

    yield DashboardData(
      schoolId: schoolId,
      schoolName: schoolName,
      userName: profile?['full_name'] ?? 'Admin',
      studentCount: (students['c'] as int),
      outstandingBalance: (bills['t'] as num?)?.toDouble() ?? 0.0,
      recentPayments: payments,
    );
  }
});
// ==========================================
// FILE: ./data/providers/expense_provider.dart
// ==========================================

import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:fees_up/data/models/finance_models.dart';
import 'package:fees_up/data/repositories/expense_repository.dart';
import 'package:fees_up/data/providers/school_provider.dart'; // Assuming you have this for currentSchoolId

// 1. STREAM: Live list of expenses
final recentExpensesProvider = StreamProvider.autoDispose<List<Expense>>((ref) {
  // Replace with your actual provider for getting the active school ID
  // e.g. ref.watch(currentSchoolIdProvider);
  // For safety, I'll return an empty stream if ID is missing.
  final schoolId = ref.watch(activeSchoolIdProvider); 
  
  if (schoolId == null) return const Stream.empty();

  final repo = ref.read(expenseRepositoryProvider);
  return repo.watchRecentExpenses(schoolId);
});

// 2. CONTROLLER: Handles the Save Action
class ExpenseController extends StateNotifier<AsyncValue<void>> {
  final Ref ref;

  ExpenseController(this.ref) : super(const AsyncData(null));

  Future<bool> saveExpense({
    required String title,
    required double amount,
    required DateTime date,
    String? category,
    String? recipient,
    String? notes,
    String? paymentMethod,
  }) async {
    state = const AsyncLoading();
    try {
      final schoolId = ref.read(activeSchoolIdProvider);
      if (schoolId == null) throw Exception("No active school found.");

      final repo = ref.read(expenseRepositoryProvider);
      
      await repo.createExpense(
        schoolId: schoolId,
        title: title,
        amount: amount,
        incurredAt: date,
        category: category,
        recipient: recipient,
        notes: notes,
        paymentMethod: paymentMethod,
      );

      state = const AsyncData(null);
      return true;
    } catch (e, stack) {
      state = AsyncError(e, stack);
      return false;
    }
  }
}

final expenseControllerProvider = StateNotifierProvider<ExpenseController, AsyncValue<void>>((ref) {
  return ExpenseController(ref);
});
// ==========================================
// FILE: ./data/providers/fundraising_provider.dart
// ==========================================

import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../services/database_service.dart';
import 'dashboard_provider.dart';

class FundraisingData {
  final String campaignName;
  final double goalAmount;
  final double raisedAmount;
  final double percentage;

  FundraisingData({
    required this.campaignName,
    required this.goalAmount,
    required this.raisedAmount,
    required this.percentage,
  });
}

final fundraisingProvider = FutureProvider<FundraisingData?>((ref) async {
  final dashboardData = await ref.watch(dashboardDataProvider.future);
  final schoolId = dashboardData.schoolId;
  final db = DatabaseService().db;

  // 1. Get the ACTIVE campaign for this school
  // We explicitly look for status = 'active'
  final campaigns = await db.getAll(
    "SELECT * FROM campaigns WHERE school_id = ? AND status = 'active' ORDER BY created_at DESC LIMIT 1",
    [schoolId],
  );

  if (campaigns.isEmpty) return null; // No active campaign found

  final campaign = campaigns.first;
  final campaignId = campaign['id'];
  final goal = (campaign['goal_amount'] as num?)?.toDouble() ?? 100.0; 
  final name = campaign['name'] ?? 'Campaign';

  // 2. Sum donations for this specific campaign ID
  final donations = await db.getAll(
    "SELECT sum(amount) as total FROM campaign_donations WHERE campaign_id = ?",
    [campaignId],
  );

  final raised = (donations.first['total'] as num?)?.toDouble() ?? 0.0;

  // 3. Calculate Percentage (Safe division)
  double percent = 0.0;
  if (goal > 0) {
    percent = (raised / goal) * 100;
  }
  
  // Cap percentage visual at 100% (optional, but looks better on progress bars)
  // For the text value, we keep the real percentage.
  
  return FundraisingData(
    campaignName: name,
    goalAmount: goal,
    raisedAmount: raised,
    percentage: percent,
  );
});
// ==========================================
// FILE: ./data/providers/billing_suspension_provider.dart
// ==========================================

/// ============================================================================
/// BILLING SUSPENSION PROVIDER - RIVERPOD STATE MANAGEMENT
/// ============================================================================
/// 
/// Provides reactive state management for billing suspension operations
/// using Riverpod. Enables real-time updates to suspension status across
/// the application.
///
/// Author: Nyasha Gabriel / Batch Tech
/// Date: January 3, 2026
library billing_suspension_provider;

// ‚úÖ CORRECT: Only export non-sensitive utility classes and enums
// ‚ùå DO NOT export: SuspensionPeriod, BillingAuditEntry, BillingExtension
// These tables are server-side only and must never be synced to client
export '../services/billing_suspension_service.dart'
    show
        BillingSuppressionStatusData,
        BillingSuppressionScope,
        SuspensionStatus,
        SuspensionScopeType,
        AuditAction;

import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:supabase_flutter/supabase_flutter.dart';
import '../services/billing_suspension_service.dart';

// ============================================================================
// PROVIDERS
// ============================================================================

/// Provides instance of BillingSuppressionService scoped by school ID
final billingSuppressionServiceProvider =
    Provider.family<BillingSuppressionService, String>((ref, schoolId) {
  final supabase = Supabase.instance.client;
  final userId = supabase.auth.currentUser?.id ?? '';

  return BillingSuppressionService(
    supabase: supabase,
    schoolId: schoolId,
    userId: userId,
  );
});

/// Provides current billing suspension status (is any suspension active?)
final billingSuppressionStatusProvider =
    FutureProvider.family<bool, String>((ref, schoolId) async {
  final service = ref.watch(billingSuppressionServiceProvider(schoolId));
  return await service.isBillingSuspended();
});

/// Provides all active suspension periods for a school
/// 
/// ‚úÖ SECURE: Returns boolean status only, not full period data
/// ‚úÖ Server validates all suspension logic
final activeSuspensionsProvider = FutureProvider.family<bool, String>(
    (ref, schoolId) async {
  final service = ref.watch(billingSuppressionServiceProvider(schoolId));
  return await service.getActiveSuspensions();
});

/// Provides suspension summary for UI display
final suspensionSummaryProvider =
    FutureProvider.family<Map<String, dynamic>, String>((ref, schoolId) async {
  final service = ref.watch(billingSuppressionServiceProvider(schoolId));
  return await service.getSuspensionSummary();
});

/// Provides audit log entries (admin/read-only)
/// 
/// ‚úÖ SECURE: Returns raw maps, no client-side models
/// ‚úÖ Server enforces admin-only access via RLS
final billingAuditLogProvider =
    FutureProvider.family<List<Map<String, dynamic>>, String>(
        (ref, schoolId) async {
  final service = ref.watch(billingSuppressionServiceProvider(schoolId));
  return await service.getAuditLog(limit: 100);
});

/// StateNotifier for managing suspension UI state
class SuspensionStateNotifier extends StateNotifier<SuspensionUIState> {
  final BillingSuppressionService _service;

  SuspensionStateNotifier({required BillingSuppressionService service})
      : _service = service,
        super(const SuspensionUIState());

  /// Trigger suspension
  /// 
  /// ‚úÖ SECURE: Uses RPC call via service
  /// ‚úÖ No direct table access
  Future<bool> suspendBilling({
    required String reason,
    BillingSuppressionScope? scope,
    String? customNote,
  }) async {
    state = state.copyWith(isLoading: true, error: null);
    try {
      final result = await _service.suspendBilling(
        reason: reason,
        scope: scope,
        customNote: customNote,
      );

      state = state.copyWith(
        isLoading: false,
        isSuspended: result,
      );
      return result;
    } catch (e) {
      state = state.copyWith(
        isLoading: false,
        error: e.toString(),
      );
      return false;
    }
  }

  /// Trigger resumption
  /// 
  /// ‚úÖ SECURE: Uses RPC call via service
  /// ‚úÖ Server validates engine assignment
  Future<bool> resumeBilling() async {
    state = state.copyWith(isLoading: true, error: null);
    try {
      final result = await _service.resumeBilling();

      state = state.copyWith(
        isLoading: false,
        isSuspended: !result, // false when resume succeeds
      );
      return result;
    } catch (e) {
      state = state.copyWith(
        isLoading: false,
        error: e.toString(),
      );
      return false;
    }
  }

  /// Refresh suspension status
  /// 
  /// ‚úÖ SECURE: Queries current status from server via RPC
  Future<void> refreshStatus() async {
    state = state.copyWith(isLoading: true, error: null);
    try {
      final isSuspended = await _service.isBillingSuspended();

      state = state.copyWith(
        isLoading: false,
        isSuspended: isSuspended,
      );
    } catch (e) {
      state = state.copyWith(
        isLoading: false,
        error: e.toString(),
      );
    }
  }

  /// Clear error state
  void clearError() {
    state = state.copyWith(error: null);
  }
}

/// UI State for suspension operations
/// 
/// ‚úÖ SECURE: Only contains suspension status, not sensitive period data
/// Sensitive data (periods, audit log) is server-side only
class SuspensionUIState {
  final bool isSuspended;
  final bool isLoading;
  final String? error;

  const SuspensionUIState({
    this.isSuspended = false,
    this.isLoading = false,
    this.error,
  });

  SuspensionUIState copyWith({
    bool? isSuspended,
    bool? isLoading,
    String? error,
  }) {
    return SuspensionUIState(
      isSuspended: isSuspended ?? this.isSuspended,
      isLoading: isLoading ?? this.isLoading,
      error: error,
    );
  }
}

/// StateNotifier provider for suspension state
final suspensionStateProvider =
    StateNotifierProvider.family<SuspensionStateNotifier, SuspensionUIState,
        String>((ref, schoolId) {
  final service = ref.watch(billingSuppressionServiceProvider(schoolId));
  return SuspensionStateNotifier(service: service);
});

// ==========================================
// FILE: ./data/providers/revenue_provider.dart
// ==========================================

import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:intl/intl.dart';
import '../services/database_service.dart';
import 'dashboard_provider.dart';

// --- FILTER ENUM ---
enum RevenueFilter { thisWeek, lastWeek }

final revenueFilterProvider = StateProvider<RevenueFilter>((ref) => RevenueFilter.thisWeek);

class WeeklyRevenueData {
  final double totalWeekRevenue;
  final Map<int, double> dailyTotals; // Key: Weekday (1=Mon ... 7=Sun)

  WeeklyRevenueData({required this.totalWeekRevenue, required this.dailyTotals});
}

final weeklyRevenueProvider = FutureProvider<WeeklyRevenueData>((ref) async {
  final dashboardData = await ref.watch(dashboardDataProvider.future);
  final schoolId = dashboardData.schoolId;
  final filter = ref.watch(revenueFilterProvider);

  // 1. Calculate Date Range
  final now = DateTime.now();
  final currentWeekStart = now.subtract(Duration(days: now.weekday - 1)); // This Monday
  
  DateTime startOfWeek;
  DateTime endOfWeek;

  if (filter == RevenueFilter.thisWeek) {
    startOfWeek = DateTime(currentWeekStart.year, currentWeekStart.month, currentWeekStart.day);
    endOfWeek = startOfWeek.add(const Duration(days: 6, hours: 23, minutes: 59));
  } else {
    // Last Week
    startOfWeek = currentWeekStart.subtract(const Duration(days: 7));
    endOfWeek = startOfWeek.add(const Duration(days: 6, hours: 23, minutes: 59));
  }

  final startStr = DateFormat('yyyy-MM-dd').format(startOfWeek);
  final endStr = DateFormat('yyyy-MM-dd').format(endOfWeek);

  // 2. Query Database
  final db = DatabaseService().db;
  final results = await db.getAll(
    'SELECT amount, date_paid FROM payments WHERE school_id = ? AND date_paid >= ? AND date_paid <= ?',
    [schoolId, startStr, endStr],
  );

  // 3. Group by Day
  double total = 0.0;
  final Map<int, double> dailyMap = {1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0};

  for (var row in results) {
    final amount = (row['amount'] as num).toDouble();
    final dateStr = row['date_paid'] as String;
    final date = DateTime.parse(dateStr);
    
    // Ensure we map correctly even if the date parsing varies slightly
    dailyMap[date.weekday] = (dailyMap[date.weekday] ?? 0) + amount;
    total += amount;
  }

  return WeeklyRevenueData(totalWeekRevenue: total, dailyTotals: dailyMap);
});
// ==========================================
// FILE: ./data/providers/auth_provider.dart
// ==========================================

import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:supabase_flutter/supabase_flutter.dart';
import '../repositories/auth_repository.dart';

// 1. The Repository Provider (This is what was missing)
final authRepositoryProvider = Provider<AuthRepository>((ref) {
  return AuthRepository();
});

// 2. Auth State Stream (Listens to Login/Logout events)
final authStateProvider = StreamProvider<AuthState>((ref) {
  final repo = ref.watch(authRepositoryProvider);
  return repo.authStateChanges;
});

// 3. Current User Helper
final currentUserProvider = Provider<User?>((ref) {
  final authState = ref.watch(authStateProvider);
  return authState.value?.session?.user;
});
// ==========================================
// FILE: ./data/providers/school_provider.dart
// ==========================================

import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:fees_up/data/services/database_service.dart';
import 'package:fees_up/data/services/school_service.dart';
import 'package:fees_up/data/providers/auth_provider.dart';

// 1. The Service Provider
final schoolServiceProvider = Provider<SchoolService>((ref) {
  return SchoolService(DatabaseService());
});

// 2. A Helper Provider to get the current school Map immediately
//    CRITICAL LOGIC: This uses 'getSchoolForUser' which performs the lookup:
//    Auth ID -> User Profile -> School ID -> School Record
final currentSchoolProvider = FutureProvider<Map<String, dynamic>?>((ref) async {
  final user = ref.watch(currentUserProvider);
  if (user == null) return null;

  final service = ref.watch(schoolServiceProvider);
  
  // We pass the USER ID (Auth ID) here. 
  // The service internally finds the profile linked to this user, 
  // extracts the 'school_id', and returns the School row.
  return await service.getSchoolForUser(user.id, waitForSync: true);
});

// 3. The ID Selector (REQUIRED by Expense, Student, and Billing features)
//    This extracts the actual 'school_id' from the school record we just fetched.
final activeSchoolIdProvider = Provider<String?>((ref) {
  final schoolAsync = ref.watch(currentSchoolProvider);
  
  // The 'id' inside this map is the SCHOOL ID (from the schools table), 
  // NOT the User ID.
  return schoolAsync.value?['id'] as String?;
});
// ==========================================
// FILE: ./data/providers/broadcast_provider.dart
// ==========================================

import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:uuid/uuid.dart';
import '../models/broadcast_model.dart';
import '../repositories/broadcast_repository.dart';
import 'school_provider.dart';
import 'auth_provider.dart';

final broadcastRepositoryProvider = Provider((ref) => BroadcastRepository());

/// Unified Provider Names for UI Integration
final schoolBroadcastProvider = StreamProvider.autoDispose<List<Broadcast>>((ref) {
  final schoolId = ref.watch(activeSchoolIdProvider);
  if (schoolId == null) return Stream.value([]);
  return ref.watch(broadcastRepositoryProvider).watchSchoolBroadcasts(schoolId);
});

final internalHQBroadcastProvider = StreamProvider.autoDispose<List<Broadcast>>((ref) {
  return ref.watch(broadcastRepositoryProvider).watchInternalHQBroadcasts();
});

final broadcastLogicProvider = Provider((ref) => BroadcastLogic(ref));

class BroadcastLogic {
  final Ref _ref;
  BroadcastLogic(this._ref);

  Future<void> post({
    required String title,
    required String body,
    String priority = 'normal',
    bool isInternalHQ = false,
  }) async {
    final user = _ref.read(currentUserProvider);
    final schoolId = _ref.read(activeSchoolIdProvider);

    if (user == null) throw Exception("Auth Required");

    final Map<String, dynamic> data = {
      'id': const Uuid().v4(),
      'school_id': isInternalHQ ? null : schoolId,
      'author_id': user.id,
      'is_system_message': isInternalHQ ? 1 : 0,
      'target_role': isInternalHQ ? 'hq_internal' : 'all',
      'title': title,
      'body': body,
      'priority': priority,
      'created_at': DateTime.now().toIso8601String(),
    };

    await _ref.read(broadcastRepositoryProvider).postBroadcast(data: data);
  }
}
// ==========================================
// FILE: ./data/providers/financial_providers.dart
// ==========================================

import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:intl/intl.dart';
import 'package:supabase_flutter/supabase_flutter.dart';

import '../services/invoice_service.dart';
import '../services/transaction_service.dart';
import '../services/financial_reports_service.dart';

// ========== SERVICE PROVIDERS ==========

/// Invoice Service provider
final invoiceServiceProvider = Provider<InvoiceService>((ref) {
  final supabase = Supabase.instance.client;
  return InvoiceService(supabase: supabase);
});

/// Transaction Service provider
final transactionServiceProvider = Provider<TransactionService>((ref) {
  final supabase = Supabase.instance.client;
  return TransactionService(supabase: supabase);
});

/// Financial Reports Service provider
final financialReportsServiceProvider = Provider<FinancialReportsService>((ref) {
  final supabase = Supabase.instance.client;
  return FinancialReportsService(supabase: supabase);
});

// ========== INVOICE PROVIDERS ==========

/// Get next invoice number for a school
final nextInvoiceNumberProvider =
    FutureProvider.family<String, String>((ref, schoolId) async {
  final invoiceService = ref.watch(invoiceServiceProvider);
  return invoiceService.getNextInvoiceNumber(schoolId);
});

/// Get all invoices for a school
final schoolInvoicesProvider =
    FutureProvider.family<List<Map<String, dynamic>>, String>((ref, schoolId) async {
  final invoiceService = ref.watch(invoiceServiceProvider);
  return invoiceService.getInvoicesForSchool(schoolId: schoolId);
});

/// Get outstanding invoices for a student
final studentOutstandingInvoicesProvider = FutureProvider.family<
    List<Map<String, dynamic>>,
    String>((ref, studentId) async {
  final invoiceService = ref.watch(invoiceServiceProvider);
  return invoiceService.getOutstandingInvoices(studentId);
});

/// Get invoice statistics for school dashboard
final invoiceStatisticsProvider =
    FutureProvider.family<Map<String, dynamic>, String>((ref, schoolId) async {
  final invoiceService = ref.watch(invoiceServiceProvider);
  return invoiceService.getInvoiceStatistics(schoolId);
});

/// Get invoices by date range
final invoicesByDateRangeProvider = FutureProvider.family<
    List<Map<String, dynamic>>,
    ({String schoolId, DateTime startDate, DateTime endDate})>(
  (ref, params) async {
    final invoiceService = ref.watch(invoiceServiceProvider);
    return invoiceService.getInvoicesByDateRange(
      schoolId: params.schoolId,
      startDate: params.startDate,
      endDate: params.endDate,
    );
  },
);

// ========== PAYMENT & ALLOCATION PROVIDERS ==========

/// Get outstanding bills with balance for a student
final outstandingBillsProvider = FutureProvider.family<
    List<Map<String, dynamic>>,
    String>((ref, studentId) async {
  final transactionService = ref.watch(transactionServiceProvider);
  return transactionService.getOutstandingBillsWithBalance(studentId);
});

/// Get payment allocations for a payment
final paymentAllocationsProvider = FutureProvider.family<
    List<Map<String, dynamic>>,
    String>((ref, paymentId) async {
  final transactionService = ref.watch(transactionServiceProvider);
  return transactionService.getPaymentAllocations(paymentId);
});

/// Get bill payment summary
final billPaymentSummaryProvider = FutureProvider.family<
    Map<String, dynamic>,
    String>((ref, billId) async {
  final transactionService = ref.watch(transactionServiceProvider);
  return transactionService.getBillPaymentSummary(billId);
});

/// Get payment history for a student
final paymentHistoryProvider = FutureProvider.family<
    List<Map<String, dynamic>>,
    ({String studentId, DateTime? startDate, DateTime? endDate})>(
  (ref, params) async {
    final transactionService = ref.watch(transactionServiceProvider);
    return transactionService.getPaymentHistory(
      studentId: params.studentId,
      startDate: params.startDate,
      endDate: params.endDate,
    );
  },
);

/// Get refund history for a student
final refundHistoryProvider = FutureProvider.family<
    List<Map<String, dynamic>>,
    String>((ref, studentId) async {
  final transactionService = ref.watch(transactionServiceProvider);
  return transactionService.getRefundHistory(studentId);
});

/// Get transaction summary for school
final transactionSummaryProvider =
    FutureProvider.family<Map<String, dynamic>, String>((ref, schoolId) async {
  final transactionService = ref.watch(transactionServiceProvider);
  return transactionService.getTransactionSummary(schoolId);
});

// ========== FINANCIAL REPORTS PROVIDERS ==========

/// Get financial summary (dashboard)
final financialSummaryProvider =
    FutureProvider.family<Map<String, dynamic>, String>((ref, schoolId) async {
  final reportsService = ref.watch(financialReportsServiceProvider);
  return reportsService.getFinancialSummary(schoolId);
});

/// Get enrollment trends
final enrollmentTrendsProvider =
    FutureProvider.family<Map<String, dynamic>, String>((ref, schoolId) async {
  final reportsService = ref.watch(financialReportsServiceProvider);
  return reportsService.getEnrollmentTrends(schoolId);
});

/// Get custom report
final customReportProvider = FutureProvider.family<
    Map<String, dynamic>,
    ({
      String schoolId,
      ReportCategory category,
      DateTimeRange dateRange,
      String? gradeLevel,
      String? studentId,
    })>(
  (ref, params) async {
    final reportsService = ref.watch(financialReportsServiceProvider);
    return reportsService.generateCustomReport(
      schoolId: params.schoolId,
      category: params.category,
      dateRange: params.dateRange,
      gradeLevel: params.gradeLevel,
      studentId: params.studentId,
    );
  },
);

/// Get financial audit log
final financialAuditLogProvider = FutureProvider.family<
    List<Map<String, dynamic>>,
    ({
      String schoolId,
      DateTime? startDate,
      DateTime? endDate,
      String? actionType,
    })>(
  (ref, params) async {
    final reportsService = ref.watch(financialReportsServiceProvider);
    return reportsService.getFinancialAuditLog(
      schoolId: params.schoolId,
      startDate: params.startDate,
      endDate: params.endDate,
      actionType: params.actionType,
    );
  },
);

/// Compare financial performance between periods
final comparePeriodsProvider = FutureProvider.family<
    Map<String, dynamic>,
    ({
      String schoolId,
      DateTimeRange period1,
      DateTimeRange period2,
    })>(
  (ref, params) async {
    final reportsService = ref.watch(financialReportsServiceProvider);
    return reportsService.comparePerformancePeriods(
      schoolId: params.schoolId,
      period1: params.period1,
      period2: params.period2,
    );
  },
);

/// Forecast cash flow
final cashFlowForecastProvider = FutureProvider.family<
    Map<String, dynamic>,
    ({String schoolId, int forecastDays})>(
  (ref, params) async {
    final reportsService = ref.watch(financialReportsServiceProvider);
    return reportsService.forecastCashFlow(
      schoolId: params.schoolId,
      forecastDays: params.forecastDays,
    );
  },
);

// ========== STATE NOTIFIERS ==========

/// State for invoice creation dialog
class InvoiceCreationState {
  final String studentId;
  final String title;
  final double amount;
  final DateTime dueDate;
  final String invoiceStatus; // 'draft', 'sent'
  final bool isLoading;
  final String? error;

  InvoiceCreationState({
    required this.studentId,
    required this.title,
    required this.amount,
    required this.dueDate,
    this.invoiceStatus = 'draft',
    this.isLoading = false,
    this.error,
  });

  InvoiceCreationState copyWith({
    String? studentId,
    String? title,
    double? amount,
    DateTime? dueDate,
    String? invoiceStatus,
    bool? isLoading,
    String? error,
  }) {
    return InvoiceCreationState(
      studentId: studentId ?? this.studentId,
      title: title ?? this.title,
      amount: amount ?? this.amount,
      dueDate: dueDate ?? this.dueDate,
      invoiceStatus: invoiceStatus ?? this.invoiceStatus,
      isLoading: isLoading ?? this.isLoading,
      error: error ?? this.error,
    );
  }
}

/// Notifier for invoice creation
class InvoiceCreationNotifier extends StateNotifier<InvoiceCreationState> {
  final InvoiceService invoiceService;

  InvoiceCreationNotifier({required this.invoiceService})
      : super(
          InvoiceCreationState(
            studentId: '',
            title: '',
            amount: 0.0,
            dueDate: DateTime.now().add(const Duration(days: 7)),
          ),
        );

  void updateStudentId(String studentId) {
    state = state.copyWith(studentId: studentId);
  }

  void updateTitle(String title) {
    state = state.copyWith(title: title);
  }

  void updateAmount(double amount) {
    state = state.copyWith(amount: amount);
  }

  void updateDueDate(DateTime date) {
    state = state.copyWith(dueDate: date);
  }

  void updateStatus(String status) {
    state = state.copyWith(invoiceStatus: status);
  }

  Future<void> submitInvoice(String schoolId) async {
    state = state.copyWith(isLoading: true, error: null);

    try {
      if (state.studentId.isEmpty ||
          state.title.isEmpty ||
          state.amount <= 0) {
        throw Exception('Please fill all required fields');
      }

      await invoiceService.createAdhocInvoice(
        schoolId: schoolId,
        studentId: state.studentId,
        title: state.title,
        amount: state.amount,
        dueDate: state.dueDate,
        status: state.invoiceStatus,
      );

      state = state.copyWith(isLoading: false);
    } catch (e) {
      state = state.copyWith(isLoading: false, error: e.toString());
      rethrow;
    }
  }

  void reset() {
    state = InvoiceCreationState(
      studentId: '',
      title: '',
      amount: 0.0,
      dueDate: DateTime.now().add(const Duration(days: 7)),
    );
  }
}

/// Invoice creation state notifier provider
final invoiceCreationProvider =
    StateNotifierProvider<InvoiceCreationNotifier, InvoiceCreationState>(
  (ref) {
    final invoiceService = ref.watch(invoiceServiceProvider);
    return InvoiceCreationNotifier(invoiceService: invoiceService);
  },
);

// ========== REPORT STATE PROVIDERS ==========

/// Selected date range for reports
final reportDateRangeProvider =
    StateProvider<DateTimeRange>((ref) {
  return DateTimeRange.thisMonth();
});

/// Selected report category
final reportCategoryProvider =
    StateProvider<ReportCategory>((ref) {
  return ReportCategory.tuitionCollection;
});

/// Selected grade filter for reports
final reportGradeFilterProvider = StateProvider<String?>((ref) {
  return null;
});

/// Currently displayed report data
final currentReportProvider = FutureProvider<Map<String, dynamic>>((ref) {
  final schoolId = ref.watch(selectedSchoolIdProvider);
  final category = ref.watch(reportCategoryProvider);
  final dateRange = ref.watch(reportDateRangeProvider);
  final gradeFilter = ref.watch(reportGradeFilterProvider);
  final reportsService = ref.watch(financialReportsServiceProvider);

  if (schoolId == null) {
    return Future.error('No school selected');
  }

  return reportsService.generateCustomReport(
    schoolId: schoolId,
    category: category,
    dateRange: dateRange,
    gradeLevel: gradeFilter,
  );
});

// ========== UTILITY PROVIDERS ==========

/// Selected school ID (from app state)
final selectedSchoolIdProvider = StateProvider<String?>((ref) {
  // TODO: Connect to auth/school selection provider
  return null;
});

/// Format currency for display
final currencyFormatterProvider = Provider<String Function(double)>((ref) {
  return (amount) {
    return NumberFormat.currency(symbol: '\$', decimalDigits: 2)
        .format(amount);
  };
});

/// Format date for display
final dateFormatterProvider = Provider<String Function(DateTime)>((ref) {
  return (date) {
    return DateFormat('MMM dd, yyyy').format(date);
  };
});

// ==========================================
// FILE: ./data/providers/users_provider.dart
// ==========================================

import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'dashboard_provider.dart';
import '../repositories/users_repository.dart';

final usersRepositoryProvider = Provider((ref) => UsersRepository());

// Live list of users for the current school
final schoolUsersProvider = FutureProvider.autoDispose<List<Map<String, dynamic>>>((ref) async {
  final dashboard = await ref.watch(dashboardDataProvider.future);
  final repo = ref.watch(usersRepositoryProvider);
  
  if (dashboard.schoolId.isEmpty) return [];
  
  return repo.getSchoolUsers(dashboard.schoolId);
});
// ==========================================
// FILE: ./data/providers/settings_provider.dart
// ==========================================

import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../services/database_service.dart';
import 'dashboard_provider.dart';

// --- MODELS ---
class GlobalSettings {
  final String themeMode;
  final bool twoFactor;
  final int sessionTimeout;
  // ... add others
  GlobalSettings({required this.themeMode, required this.twoFactor, required this.sessionTimeout});
}

class SchoolPreferences {
  final bool notifyPayment;
  final bool notifyOverdue;
  final String landingPage;
  // ... add others
  SchoolPreferences({required this.notifyPayment, required this.notifyOverdue, required this.landingPage});
}

// --- PROVIDERS ---

// 1. Fetch Global Settings (User-centric)
final globalSettingsProvider = FutureProvider<GlobalSettings>((ref) async {
  // ignore: unused_local_variable
  final db = DatabaseService();
  // In production, fetch from Supabase. For UI demo, returning mock default.
  return GlobalSettings(themeMode: 'dark', twoFactor: true, sessionTimeout: 15);
});

// 2. Fetch School Context Settings (School-centric)
final schoolPreferencesProvider = FutureProvider<SchoolPreferences>((ref) async {
  final dashboard = await ref.watch(dashboardDataProvider.future);
  if (dashboard.schoolId.isEmpty) {
    return SchoolPreferences(notifyPayment: true, notifyOverdue: true, landingPage: 'overview');
  }
  
  // Logic: Fetch FROM user_school_preferences WHERE school_id = dashboard.schoolId
  return SchoolPreferences(notifyPayment: true, notifyOverdue: false, landingPage: 'transactions');
});
// ==========================================
// FILE: ./pc/widgets/announcements/compose_broadcast_dialog.dart
// ==========================================

import 'package:fees_up/data/providers/broadcast_provider.dart';
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../../core/constants/app_colors.dart';

class ComposeBroadcastDialog extends ConsumerStatefulWidget {
  const ComposeBroadcastDialog({super.key});

  @override
  ConsumerState<ComposeBroadcastDialog> createState() => _ComposeBroadcastDialogState();
}

class _ComposeBroadcastDialogState extends ConsumerState<ComposeBroadcastDialog> {
  final _formKey = GlobalKey<FormState>();
  final _titleCtrl = TextEditingController();
  final _bodyCtrl = TextEditingController();
  String _priority = 'normal';
  bool _isLoading = false;

  Future<void> _submit() async {
    if (!_formKey.currentState!.validate()) return;

    setState(() => _isLoading = true);

    try {
      await ref.read(broadcastLogicProvider).post(
        title: _titleCtrl.text.trim(),
        body: _bodyCtrl.text.trim(),
        priority: _priority,
      );
      if (mounted) Navigator.pop(context);
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text("Error: $e"), backgroundColor: AppColors.errorRed),
        );
      }
    } finally {
      if (mounted) setState(() => _isLoading = false);
    }
  }

  @override
  Widget build(BuildContext context) {
    return Dialog(
      backgroundColor: AppColors.surfaceGrey,
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
      child: Container(
        width: 500,
        padding: const EdgeInsets.all(24),
        child: Form(
          key: _formKey,
          child: Column(
            mainAxisSize: MainAxisSize.min,
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              const Text("Post Broadcast", style: TextStyle(color: AppColors.textWhite, fontSize: 18, fontWeight: FontWeight.bold)),
              const SizedBox(height: 24),
              TextFormField(
                controller: _titleCtrl,
                style: const TextStyle(color: AppColors.textWhite),
                validator: (v) => v!.isEmpty ? "Required" : null,
                decoration: _inputDecoration("Title"),
              ),
              const SizedBox(height: 16),
              TextFormField(
                controller: _bodyCtrl,
                style: const TextStyle(color: AppColors.textWhite),
                validator: (v) => v!.isEmpty ? "Required" : null,
                maxLines: 4,
                decoration: _inputDecoration("Body"),
              ),
              const SizedBox(height: 16),
              DropdownButtonFormField<String>(
                initialValue: _priority, // Controlled value
                dropdownColor: AppColors.surfaceGrey,
                style: const TextStyle(color: AppColors.textWhite),
                decoration: _inputDecoration("Priority"),
                items: const [
                  DropdownMenuItem(value: 'normal', child: Text("Normal")),
                  DropdownMenuItem(value: 'high', child: Text("High")),
                  DropdownMenuItem(value: 'critical', child: Text("Critical")),
                ],
                onChanged: (v) => setState(() => _priority = v!),
              ),
              const SizedBox(height: 32),
              Row(
                mainAxisAlignment: MainAxisAlignment.end,
                children: [
                  TextButton(
                    onPressed: _isLoading ? null : () => Navigator.pop(context),
                    child: const Text("Cancel", style: TextStyle(color: AppColors.textWhite70)),
                  ),
                  const SizedBox(width: 12),
                  ElevatedButton.icon(
                    onPressed: _isLoading ? null : _submit,
                    icon: _isLoading 
                        ? const SizedBox(width: 16, height: 16, child: CircularProgressIndicator(strokeWidth: 2, color: Colors.white))
                        : const Icon(Icons.send, size: 16),
                    label: Text(_isLoading ? "Posting..." : "Post"),
                    style: ElevatedButton.styleFrom(backgroundColor: AppColors.primaryBlue, foregroundColor: Colors.white),
                  ),
                ],
              ),
            ],
          ),
        ),
      ),
    );
  }

  InputDecoration _inputDecoration(String label) {
    return InputDecoration(
      labelText: label,
      labelStyle: const TextStyle(color: AppColors.textWhite54),
      filled: true,
      fillColor: AppColors.backgroundBlack,
      border: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.divider)),
    );
  }
}
// ==========================================
// FILE: ./pc/widgets/announcements/broadcast_kpi_cards.dart
// ==========================================

import 'package:fees_up/data/providers/broadcast_provider.dart';
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../../core/constants/app_colors.dart';

class BroadcastKpiCards extends ConsumerWidget {
  const BroadcastKpiCards({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    // --- THE FIX: AGGREGATED CONTEXT ---
    // We watch both streams to provide a holistic view for the Super Admin
    final schoolFeedAsync = ref.watch(schoolBroadcastProvider);
    final hqFeedAsync = ref.watch(internalHQBroadcastProvider);

    return Row(
      children: [
        // 1. Critical Alerts (From School Feed)
        _buildAsyncCard(
          schoolFeedAsync,
          title: "Critical Alerts",
          icon: Icons.warning_amber_rounded,
          color: AppColors.errorRed,
          bgColor: AppColors.errorRedBg,
          countLogic: (list) => list.where((b) => b.priority == 'critical').length,
        ),
        const SizedBox(width: 24),

        // 2. System Notices (From Greyway HQ Feed)
        // Loophole Closed: This now tracks Global HQ alerts specifically [cite: 2025-12-30]
        _buildAsyncCard(
          hqFeedAsync,
          title: "HQ Internal",
          icon: Icons.security_outlined,
          color: AppColors.accentPurple,
          bgColor: AppColors.accentPurple.withAlpha(25),
          countLogic: (list) => list.length,
        ),
        const SizedBox(width: 24),

        // 3. Active Broadcasts (Total Local School messages)
        _buildAsyncCard(
          schoolFeedAsync,
          title: "Active Broadcasts",
          icon: Icons.campaign_outlined,
          color: AppColors.successGreen,
          bgColor: AppColors.successGreenBg,
          countLogic: (list) => list.length,
        ),
      ],
    );
  }

  /// Helper to build cards that handle their own loading/error states per stream [cite: 2025-12-30]
  Widget _buildAsyncCard(
    AsyncValue<List<dynamic>> asyncValue, {
    required String title,
    required IconData icon,
    required Color color,
    required Color bgColor,
    required int Function(List<dynamic>) countLogic,
  }) {
    return Expanded(
      child: Container(
        padding: const EdgeInsets.all(20),
        decoration: BoxDecoration(
          color: AppColors.surfaceGrey,
          borderRadius: BorderRadius.circular(12),
          border: Border.all(color: AppColors.divider),
        ),
        child: asyncValue.when(
          data: (list) => Row(
            children: [
              Container(
                padding: const EdgeInsets.all(12),
                decoration: BoxDecoration(color: bgColor, borderRadius: BorderRadius.circular(8)),
                child: Icon(icon, color: color, size: 24),
              ),
              const SizedBox(width: 16),
              Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(title, style: const TextStyle(color: AppColors.textWhite70, fontSize: 13)),
                  Text(
                    countLogic(list).toString(),
                    style: const TextStyle(color: AppColors.textWhite, fontSize: 24, fontWeight: FontWeight.bold),
                  ),
                ],
              ),
            ],
          ),
          loading: () => const Center(child: SizedBox(width: 20, height: 20, child: CircularProgressIndicator(strokeWidth: 2))),
          error: (_, __) => const Icon(Icons.error_outline, color: AppColors.errorRed, size: 20),
        ),
      ),
    );
  }
}
// ==========================================
// FILE: ./pc/widgets/announcements/broadcast_list.dart
// ==========================================

import 'package:fees_up/data/providers/broadcast_provider.dart';
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:intl/intl.dart';
import '../../../../core/constants/app_colors.dart';
import '../../../../data/models/broadcast_model.dart';
import 'compose_broadcast_dialog.dart';

class BroadcastList extends ConsumerStatefulWidget {
  const BroadcastList({super.key});

  @override
  ConsumerState<BroadcastList> createState() => _BroadcastListState();
}

class _BroadcastListState extends ConsumerState<BroadcastList> {
  String _filter = 'All'; // 'All', 'System', 'Internal'

  @override
  Widget build(BuildContext context) {
    // SWITCHER LOGIC: Select the correct Fortress Stream [cite: 2025-12-30]
    final AsyncValue<List<Broadcast>> feedAsync = (_filter == 'Internal')
        ? ref.watch(internalHQBroadcastProvider)
        : ref.watch(schoolBroadcastProvider);

    return Container(
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: AppColors.divider),
      ),
      child: Column(
        children: [
          Padding(
            padding: const EdgeInsets.all(16),
            child: Row(
              children: [
                _buildFilterTab("All"),
                _buildFilterTab("System"),
                _buildFilterTab("Internal"),
                const Spacer(),
                OutlinedButton.icon(
                  onPressed: () => _filter == 'Internal' 
                      ? ref.refresh(internalHQBroadcastProvider) 
                      : ref.refresh(schoolBroadcastProvider),
                  icon: const Icon(Icons.refresh, size: 16),
                  label: const Text("Refresh Feed"),
                  style: OutlinedButton.styleFrom(
                    foregroundColor: AppColors.textWhite,
                    side: const BorderSide(color: AppColors.divider),
                  ),
                ),
                const SizedBox(width: 12),
                ElevatedButton.icon(
                  onPressed: () => _showComposeDialog(context),
                  icon: const Icon(Icons.edit, size: 16),
                  label: const Text("Post Update"),
                  style: ElevatedButton.styleFrom(backgroundColor: AppColors.primaryBlue, foregroundColor: Colors.white),
                ),
              ],
            ),
          ),
          const Divider(height: 1, color: AppColors.divider),
          feedAsync.when(
            data: (broadcasts) {
              final filtered = _filter == 'System' 
                  ? broadcasts.where((b) => b.isSystemMessage).toList() 
                  : broadcasts;
              
              if (filtered.isEmpty) {
                return _buildEmptyState();
              }

              return ListView.separated(
                shrinkWrap: true,
                physics: const NeverScrollableScrollPhysics(),
                itemCount: filtered.length,
                separatorBuilder: (context, index) => const Divider(height: 1, color: AppColors.divider),
                itemBuilder: (context, index) => _buildBroadcastItem(filtered[index]),
              );
            },
            loading: () => const Padding(padding: EdgeInsets.all(40), child: Center(child: CircularProgressIndicator())),
            error: (e, s) => Padding(padding: const EdgeInsets.all(20), child: Text("Error: $e", style: const TextStyle(color: AppColors.errorRed))),
          ),
        ],
      ),
    );
  }

  Widget _buildBroadcastItem(Broadcast item) {
    final timeStr = DateFormat('MMM d, h:mm a').format(item.createdAt);
    return Container(
      padding: const EdgeInsets.all(20),
      color: item.isInternalHQ ? AppColors.purpleBg : (item.isSystemMessage ? AppColors.primaryBlueBg : null),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          CircleAvatar(
            backgroundColor: item.badgeColor.withAlpha(40),
            child: Icon(item.icon, color: item.badgeColor, size: 20),
          ),
          const SizedBox(width: 16),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(
                  children: [
                    Container(
                      padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                      decoration: BoxDecoration(color: item.badgeColor.withAlpha(50), borderRadius: BorderRadius.circular(4)),
                      child: Text(item.authorLabel.toUpperCase(), style: TextStyle(color: item.badgeColor, fontSize: 10, fontWeight: FontWeight.bold)),
                    ),
                    const SizedBox(width: 8),
                    Text(item.title, style: const TextStyle(color: AppColors.textWhite, fontWeight: FontWeight.bold, fontSize: 14)),
                  ],
                ),
                const SizedBox(height: 8),
                Text(item.body, style: const TextStyle(color: AppColors.textWhite70, fontSize: 13, height: 1.4)),
              ],
            ),
          ),
          Column(
            crossAxisAlignment: CrossAxisAlignment.end,
            children: [
              Text(timeStr, style: const TextStyle(color: AppColors.textWhite38, fontSize: 12)),
              const SizedBox(height: 8),
              if (item.priority == 'critical') const Icon(Icons.report, color: AppColors.errorRed, size: 16),
            ],
          ),
        ],
      ),
    );
  }

  Widget _buildFilterTab(String label) {
    final isActive = _filter == label;
    return GestureDetector(
      onTap: () => setState(() => _filter = label),
      child: Container(
        margin: const EdgeInsets.only(right: 8),
        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
        decoration: BoxDecoration(
          color: isActive ? AppColors.backgroundBlack : Colors.transparent,
          borderRadius: BorderRadius.circular(6),
          border: isActive ? Border.all(color: AppColors.divider) : null,
        ),
        child: Text(label, style: TextStyle(color: isActive ? AppColors.textWhite : AppColors.textWhite70, fontSize: 13)),
      ),
    );
  }

  Widget _buildEmptyState() {
    return const Padding(
      padding: EdgeInsets.all(48.0),
      child: Center(child: Text("No broadcasts in this category", style: TextStyle(color: AppColors.textWhite38))),
    );
  }

  void _showComposeDialog(BuildContext context) {
    showDialog(
      context: context,
      barrierColor: AppColors.overlayDark,
      builder: (context) => const ComposeBroadcastDialog(),
    );
  }
}
// ==========================================
// FILE: ./pc/widgets/students/students_table.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:intl/intl.dart';
import '../../../../core/constants/app_colors.dart';
import '../../../../data/services/database_service.dart';

class StudentsTable extends StatefulWidget {
  final String schoolId;
  const StudentsTable({super.key, required this.schoolId});

  @override
  State<StudentsTable> createState() => _StudentsTableState();
}

class _StudentsTableState extends State<StudentsTable> {
  // We can add local filter state here later (e.g. selectedGrade)
  
  @override
  Widget build(BuildContext context) {
    return Container(
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: AppColors.divider),
      ),
      child: Column(
        children: [
          // --- 1. Filter Bar ---
          _buildFilterBar(),
          const Divider(height: 1, color: AppColors.divider),

          // --- 2. Table Headers ---
          _buildTableHeader(),
          const Divider(height: 1, color: AppColors.divider),

          // --- 3. Real Data List ---
          StreamBuilder<List<Map<String, dynamic>>>(
            stream: DatabaseService().watchStudents(widget.schoolId),
            builder: (context, snapshot) {
              if (snapshot.connectionState == ConnectionState.waiting) {
                return const Padding(
                  padding: EdgeInsets.all(40.0),
                  child: Center(child: CircularProgressIndicator(color: AppColors.primaryBlue)),
                );
              }
              
              final students = snapshot.data ?? [];

              if (students.isEmpty) {
                return const Padding(
                  padding: EdgeInsets.all(40.0),
                  child: Center(child: Text("No students found. Add one to get started.", style: TextStyle(color: AppColors.textGrey))),
                );
              }

              return ListView.separated(
                shrinkWrap: true,
                physics: const NeverScrollableScrollPhysics(), // Scroll handled by parent
                itemCount: students.length,
                separatorBuilder: (_, __) => const Divider(height: 1, color: AppColors.divider),
                itemBuilder: (context, index) {
                  final s = students[index];
                  return _buildStudentRow(s);
                },
              );
            },
          ),

          // --- 4. Pagination Footer ---
          _buildFooter(),
        ],
      ),
    );
  }

  Widget _buildFilterBar() {
    return Padding(
      padding: const EdgeInsets.all(16),
      child: Row(
        children: [
          _buildDropdown("All Grades"),
          const SizedBox(width: 12),
          _buildDropdown("All Classes"),
          const SizedBox(width: 12),
          _buildDropdown("Status: Active"),
          const SizedBox(width: 12),
          _buildDropdown("Financial: All"),
          
          const Spacer(),
          TextButton(
            onPressed: () {},
            child: const Text("Clear Filters", style: TextStyle(color: AppColors.primaryBlue, fontSize: 13)),
          )
        ],
      ),
    );
  }

  Widget _buildDropdown(String label) {
    return Container(
      height: 36,
      padding: const EdgeInsets.symmetric(horizontal: 12),
      decoration: BoxDecoration(
        color: AppColors.backgroundBlack,
        borderRadius: BorderRadius.circular(6),
        border: Border.all(color: AppColors.divider),
      ),
      child: Row(
        children: [
          Text(label, style: const TextStyle(color: AppColors.textWhite, fontSize: 13)),
          const SizedBox(width: 8),
          const Icon(Icons.keyboard_arrow_down, color: AppColors.textWhite54, size: 16),
        ],
      ),
    );
  }

  Widget _buildTableHeader() {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 16),
      child: Row(
        children: [
          _col("STUDENT NAME", 3),
          _col("ID / GRADE", 2),
          _col("PARENT CONTACT", 3),
          _col("STATUS", 2),
          _col("OWED AMOUNT", 2, alignRight: true),
          _col("ACTIONS", 1, alignRight: true),
        ],
      ),
    );
  }

  Widget _col(String text, int flex, {bool alignRight = false}) {
    return Expanded(
      flex: flex,
      child: Text(
        text,
        textAlign: alignRight ? TextAlign.right : TextAlign.left,
        style: const TextStyle(color: AppColors.textWhite38, fontSize: 11, fontWeight: FontWeight.bold, letterSpacing: 0.8),
      ),
    );
  }

  Widget _buildStudentRow(Map<String, dynamic> s) {
    final name = s['full_name'] ?? 'Unknown';
    final id = s['student_id'] ?? '---';
    final grade = s['grade'] ?? 'N/A';
    final parentName = s['emergency_contact_name'] ?? 'No Contact';
    final contact = s['parent_contact'] ?? '';
    final isActive = (s['is_active'] as int?) == 1;
    final owed = (s['owed_total'] as num?)?.toDouble() ?? 0.0;
    
    // Initials for Avatar
    final initials = name.isNotEmpty ? name.substring(0, 1).toUpperCase() : "?";

    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 16),
      child: Row(
        children: [
          // 1. Name & Avatar
          Expanded(
            flex: 3,
            child: Row(
              children: [
                CircleAvatar(
                  radius: 16,
                  backgroundColor: AppColors.primaryBlue.withValues(alpha: 0.2),
                  child: Text(initials, style: const TextStyle(color: AppColors.primaryBlue, fontWeight: FontWeight.bold, fontSize: 12)),
                ),
                const SizedBox(width: 12),
                Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(name, style: const TextStyle(color: AppColors.textWhite, fontWeight: FontWeight.w500, fontSize: 13)),
                    Text("Class $grade", style: const TextStyle(color: AppColors.textWhite38, fontSize: 11)),
                  ],
                ),
              ],
            ),
          ),
          
          // 2. ID / Grade
          Expanded(
            flex: 2,
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text("#$id", style: const TextStyle(color: AppColors.textWhite, fontSize: 13)),
                Container(
                  margin: const EdgeInsets.only(top: 4),
                  padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                  decoration: BoxDecoration(color: AppColors.surfaceLightGrey, borderRadius: BorderRadius.circular(4)),
                  child: Text("Grade $grade", style: const TextStyle(color: AppColors.textWhite70, fontSize: 10)),
                ),
              ],
            ),
          ),

          // 3. Parent Contact
          Expanded(
            flex: 3,
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(parentName, style: const TextStyle(color: AppColors.textWhite, fontSize: 13)),
                Text(contact, style: const TextStyle(color: AppColors.textWhite38, fontSize: 11)),
              ],
            ),
          ),

          // 4. Status
          Expanded(
            flex: 2,
            child: Row(
              children: [
                Container(
                  padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                  decoration: BoxDecoration(
                    color: isActive ? AppColors.successGreen.withValues(alpha: 0.15) : AppColors.surfaceLightGrey,
                    borderRadius: BorderRadius.circular(4),
                  ),
                  child: Text(
                    isActive ? "Active" : "Inactive",
                    style: TextStyle(color: isActive ? AppColors.successGreen : AppColors.textGrey, fontSize: 11, fontWeight: FontWeight.bold),
                  ),
                ),
              ],
            ),
          ),

          // 5. Owed Amount
          Expanded(
            flex: 2,
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.end,
              children: [
                Text(
                  NumberFormat.simpleCurrency().format(owed), 
                  style: const TextStyle(color: AppColors.textWhite, fontWeight: FontWeight.bold, fontSize: 13)
                ),
                Text(
                  owed > 0 ? "Overdue" : "Paid",
                  style: TextStyle(color: owed > 0 ? AppColors.errorRed : AppColors.successGreen, fontSize: 11),
                ),
              ],
            ),
          ),

          // 6. Actions
          Expanded(
            flex: 1,
            child: Row(
              mainAxisAlignment: MainAxisAlignment.end,
              children: [
                IconButton(icon: const Icon(Icons.edit, size: 16, color: AppColors.textWhite54), onPressed: (){}),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildFooter() {
    return Padding(
      padding: const EdgeInsets.all(16.0),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.end,
        children: [
          const Text("Showing all results", style: TextStyle(color: AppColors.textWhite54, fontSize: 13)),
          const SizedBox(width: 24),
          _paginationBtn("Previous", false),
          const SizedBox(width: 8),
          _paginationBtn("Next", false), // Logic can be added later
        ],
      ),
    );
  }

  Widget _paginationBtn(String label, bool active) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
      decoration: BoxDecoration(
        color: active ? AppColors.primaryBlue : AppColors.backgroundBlack,
        borderRadius: BorderRadius.circular(4),
        border: Border.all(color: AppColors.divider),
      ),
      child: Text(label, style: TextStyle(color: active ? Colors.white : AppColors.textWhite70, fontSize: 12)),
    );
  }
}
// ==========================================
// FILE: ./pc/widgets/students/students_header.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../../core/constants/app_colors.dart';
import '../../../../data/providers/dashboard_provider.dart';
import '../../../../data/services/database_service.dart';

class StudentsHeader extends ConsumerWidget {
  const StudentsHeader({super.key});

  String _getInitials(String name) {
    if (name.isEmpty) return "U";
    final parts = name.trim().split(' ');
    if (parts.length > 1) {
      return "${parts[0][0]}${parts[1][0]}".toUpperCase();
    }
    return name[0].toUpperCase();
  }

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final dashboardAsync = ref.watch(dashboardDataProvider);
    final bool isConnected = DatabaseService().db.currentStatus.connected;

    return Container(
      height: 70,
      padding: const EdgeInsets.symmetric(horizontal: 24),
      color: AppColors.backgroundBlack,
      child: Row(
        children: [
          const Icon(Icons.school, color: AppColors.primaryBlue, size: 28),
          const SizedBox(width: 12),
          const Text(
            "Students",
            style: TextStyle(
              color: AppColors.textWhite,
              fontSize: 20,
              fontWeight: FontWeight.bold,
              letterSpacing: 0.5,
            ),
          ),
          
          const Spacer(),

          // --- Search Bar (Fixed Style) ---
          SizedBox(
            width: 300,
            height: 40,
            child: TextField(
              textAlignVertical: TextAlignVertical.center,
              style: const TextStyle(color: AppColors.textWhite, fontSize: 13),
              decoration: InputDecoration(
                isDense: true,
                filled: true,
                fillColor: AppColors.surfaceGrey,
                hintText: "Search students, IDs, or parents...",
                hintStyle: const TextStyle(color: AppColors.textWhite38),
                prefixIcon: const Icon(Icons.search, size: 18, color: AppColors.textWhite54),
                contentPadding: EdgeInsets.zero, 
                enabledBorder: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(8),
                  borderSide: const BorderSide(color: AppColors.divider),
                ),
                focusedBorder: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(8),
                  borderSide: const BorderSide(color: AppColors.primaryBlue),
                ),
                border: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(8),
                  borderSide: const BorderSide(color: AppColors.divider),
                ),
              ),
            ),
          ),
          const SizedBox(width: 24),
          
          // --- Notification ---
          IconButton(
            onPressed: () {},
            icon: const Icon(Icons.notifications_none, color: AppColors.textWhite70),
          ),
          const SizedBox(width: 16),
          
          // --- Profile & Connectivity ---
          dashboardAsync.when(
            loading: () => _buildProfileLoading(),
            error: (err, _) => _buildProfileError(isConnected),
            data: (data) {
              final initials = _getInitials(data.userName);
              String subtitle = data.schoolName;
              if (data.schoolName == 'Loading...') {
                subtitle = isConnected ? "Syncing Data..." : "Offline Mode";
              }

              return Row(
                children: [
                  Column(
                    mainAxisAlignment: MainAxisAlignment.center,
                    crossAxisAlignment: CrossAxisAlignment.end,
                    children: [
                      Text(
                        data.userName.isEmpty ? "User" : data.userName, 
                        style: const TextStyle(color: AppColors.textWhite, fontWeight: FontWeight.bold, fontSize: 13)
                      ),
                      Text(
                        subtitle, 
                        style: TextStyle(
                          color: (subtitle == "Offline Mode") ? AppColors.warningOrange : AppColors.textWhite38, 
                          fontSize: 11
                        )
                      ),
                    ],
                  ),
                  const SizedBox(width: 12),
                  CircleAvatar(
                    backgroundColor: AppColors.primaryBlue.withValues(alpha: 0.2),
                    child: Text(
                      initials, 
                      style: const TextStyle(color: AppColors.primaryBlue, fontWeight: FontWeight.bold, fontSize: 12)
                    ),
                  ),
                ],
              );
            },
          ),
        ],
      ),
    );
  }

  Widget _buildProfileLoading() {
    return const CircleAvatar(backgroundColor: AppColors.surfaceGrey, radius: 16);
  }

  Widget _buildProfileError(bool isConnected) {
    return Icon(isConnected ? Icons.error_outline : Icons.wifi_off, color: AppColors.errorRed);
  }
}
// ==========================================
// FILE: ./pc/widgets/students/students_stats.dart
// ==========================================

import 'package:flutter/material.dart';
import '../../../../core/constants/app_colors.dart';
import '../../../../data/services/database_service.dart';

class StudentsStats extends StatelessWidget {
  final String schoolId;
  const StudentsStats({super.key, required this.schoolId});

  @override
  Widget build(BuildContext context) {
    // We reuse the watchStudents stream to calculate stats client-side
    // This ensures consistency: if you add a student, the count updates instantly.
    return StreamBuilder<List<Map<String, dynamic>>>(
      stream: DatabaseService().watchStudents(schoolId),
      builder: (context, snapshot) {
        final students = snapshot.data ?? [];
        
        // 1. Calculate Stats
        final total = students.length;
        final active = students.where((s) => (s['is_active'] as int?) == 1).length;
        
        // Example logic: "New Enrollments" = students created this month
        final now = DateTime.now();
        final newEnrollments = students.where((s) {
          if (s['created_at'] == null) return false;
          final created = DateTime.tryParse(s['created_at'].toString()) ?? DateTime(2000);
          return created.month == now.month && created.year == now.year;
        }).length;

        // Example logic: "Unpaid" = owed_total > 0
        final unpaidCount = students.where((s) {
          final owed = (s['owed_total'] as num?)?.toDouble() ?? 0.0;
          return owed > 0;
        }).length;

        return SizedBox(
          height: 140,
          child: Row(
            children: [
              // 1. Total Students
              Expanded(
                child: _StatCard(
                  title: "Total Students",
                  value: total.toString(),
                  subtext: "$active Active Users",
                  icon: Icons.people,
                  iconColor: AppColors.primaryBlue,
                  showProgress: true,
                  progressVal: total > 0 ? (active / total) : 0,
                ),
              ),
              const SizedBox(width: 16),

              // 2. New Enrollments
              Expanded(
                child: _StatCard(
                  title: "New Enrollments",
                  value: newEnrollments.toString(),
                  subtext: "+$newEnrollments this month",
                  subtextColor: AppColors.successGreen,
                  icon: Icons.person_add,
                  iconColor: AppColors.successGreen,
                ),
              ),
              const SizedBox(width: 16),

              // 3. Attendance Rate (Mocked for now as we don't have attendance stream here)
              const Expanded(
                child: _StatCard(
                  title: "Attendance Rate",
                  value: "94%",
                  subtext: "Avg. daily attendance",
                  icon: Icons.event_available,
                  iconColor: AppColors.accentPurple,
                ),
              ),
              const SizedBox(width: 16),

              // 4. Unpaid Fees (Red Alert Style)
              Expanded(
                child: Container(
                  padding: const EdgeInsets.all(20),
                  decoration: BoxDecoration(
                    color: AppColors.surfaceGrey,
                    borderRadius: BorderRadius.circular(12),
                    border: Border.all(color: AppColors.errorRed.withValues(alpha: 0.5)),
                    gradient: LinearGradient(
                      colors: [AppColors.surfaceGrey, AppColors.errorRed.withValues(alpha: 0.05)],
                      begin: Alignment.centerLeft,
                      end: Alignment.centerRight,
                    )
                  ),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    mainAxisAlignment: MainAxisAlignment.spaceBetween,
                    children: [
                      const Row(
                        mainAxisAlignment: MainAxisAlignment.spaceBetween,
                        children: [
                          Text("UNPAID FEES", style: TextStyle(color: AppColors.textGrey, fontSize: 11, fontWeight: FontWeight.bold)),
                          Icon(Icons.warning_amber_rounded, color: AppColors.errorRed, size: 20),
                        ],
                      ),
                      Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text(unpaidCount.toString(), style: const TextStyle(color: AppColors.textWhite, fontSize: 28, fontWeight: FontWeight.bold)),
                          const SizedBox(height: 4),
                          const Text("Action required", style: TextStyle(color: AppColors.errorRed, fontSize: 12, fontWeight: FontWeight.bold)),
                        ],
                      ),
                    ],
                  ),
                ),
              ),
            ],
          ),
        );
      },
    );
  }
}

class _StatCard extends StatelessWidget {
  final String title;
  final String value;
  final String subtext;
  final Color? subtextColor;
  final IconData icon;
  final Color iconColor;
  final bool showProgress;
  final double progressVal;

  const _StatCard({
    required this.title,
    required this.value,
    required this.subtext,
    this.subtextColor,
    required this.icon,
    required this.iconColor,
    this.showProgress = false,
    this.progressVal = 0,
  });

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: AppColors.divider),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Text(title.toUpperCase(), style: const TextStyle(color: AppColors.textGrey, fontSize: 11, fontWeight: FontWeight.bold)),
              Container(
                padding: const EdgeInsets.all(6),
                decoration: BoxDecoration(
                  color: iconColor.withValues(alpha: 0.15),
                  borderRadius: BorderRadius.circular(6),
                ),
                child: Icon(icon, color: iconColor, size: 18),
              ),
            ],
          ),
          Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text(value, style: const TextStyle(color: AppColors.textWhite, fontSize: 24, fontWeight: FontWeight.bold)),
              const SizedBox(height: 8),
              if (showProgress)
                Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    ClipRRect(
                      borderRadius: BorderRadius.circular(2),
                      child: LinearProgressIndicator(
                        value: progressVal,
                        backgroundColor: AppColors.backgroundBlack,
                        color: iconColor,
                        minHeight: 4,
                      ),
                    ),
                    const SizedBox(height: 6),
                  ],
                ),
              Text(subtext, style: TextStyle(color: subtextColor ?? AppColors.textWhite38, fontSize: 11)),
            ],
          ),
        ],
      ),
    );
  }
}
// ==========================================
// FILE: ./pc/widgets/reports/reports_header.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../../core/constants/app_colors.dart';
import '../../../../data/providers/dashboard_provider.dart';
import '../../../../data/services/database_service.dart';

class ReportsHeader extends ConsumerWidget {
  const ReportsHeader({super.key});

  String _getInitials(String name) {
    if (name.isEmpty) return "U";
    final parts = name.trim().split(' ');
    if (parts.length > 1) {
      return "${parts[0][0]}${parts[1][0]}".toUpperCase();
    }
    return name[0].toUpperCase();
  }

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final dashboardAsync = ref.watch(dashboardDataProvider);
    final bool isConnected = DatabaseService().db.currentStatus.connected;

    return Container(
      height: 70,
      padding: const EdgeInsets.symmetric(horizontal: 24),
      color: AppColors.backgroundBlack,
      child: Row(
        children: [
          const Icon(Icons.analytics, color: AppColors.primaryBlue, size: 28),
          const SizedBox(width: 12),
          const Text(
            "Reports Center",
            style: TextStyle(
              color: AppColors.textWhite,
              fontSize: 20,
              fontWeight: FontWeight.bold,
              letterSpacing: 0.5,
            ),
          ),
          
          const Spacer(),

          // Search Bar
          SizedBox(
            width: 300,
            height: 40,
            child: TextField(
              textAlignVertical: TextAlignVertical.center,
              style: const TextStyle(color: AppColors.textWhite, fontSize: 13),
              decoration: InputDecoration(
                isDense: true,
                filled: true,
                fillColor: AppColors.surfaceGrey,
                hintText: "Search saved reports...",
                hintStyle: const TextStyle(color: AppColors.textWhite38),
                prefixIcon: const Icon(Icons.search, size: 18, color: AppColors.textWhite54),
                contentPadding: EdgeInsets.zero, 
                enabledBorder: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(8),
                  borderSide: const BorderSide(color: AppColors.divider),
                ),
                focusedBorder: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(8),
                  borderSide: const BorderSide(color: AppColors.primaryBlue),
                ),
                border: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(8),
                  borderSide: const BorderSide(color: AppColors.divider),
                ),
              ),
            ),
          ),
          const SizedBox(width: 24),
          
          IconButton(
            onPressed: () {},
            icon: const Icon(Icons.notifications_none, color: AppColors.textWhite70),
          ),
          const SizedBox(width: 16),
          
          // Profile & Connectivity
          dashboardAsync.when(
            loading: () => const CircleAvatar(backgroundColor: AppColors.surfaceGrey, radius: 16),
            error: (_, __) => Icon(isConnected ? Icons.error_outline : Icons.wifi_off, color: AppColors.errorRed),
            data: (data) {
              final initials = _getInitials(data.userName);
              String subtitle = data.schoolName;
              if (data.schoolName == 'Loading...') {
                subtitle = isConnected ? "Syncing Data..." : "Offline Mode";
              }

              return Row(
                children: [
                  Column(
                    mainAxisAlignment: MainAxisAlignment.center,
                    crossAxisAlignment: CrossAxisAlignment.end,
                    children: [
                      Text(
                        data.userName.isEmpty ? "User" : data.userName, 
                        style: const TextStyle(color: AppColors.textWhite, fontWeight: FontWeight.bold, fontSize: 13)
                      ),
                      Text(
                        subtitle, 
                        style: TextStyle(
                          color: (subtitle == "Offline Mode") ? AppColors.warningOrange : AppColors.textWhite38, 
                          fontSize: 11
                        )
                      ),
                    ],
                  ),
                  const SizedBox(width: 12),
                  CircleAvatar(
                    backgroundColor: AppColors.primaryBlue.withValues(alpha: 0.2),
                    child: Text(
                      initials, 
                      style: const TextStyle(color: AppColors.primaryBlue, fontWeight: FontWeight.bold, fontSize: 12)
                    ),
                  ),
                ],
              );
            },
          ),
        ],
      ),
    );
  }
}
// ==========================================
// FILE: ./pc/widgets/reports/report_card.dart
// ==========================================

import 'package:flutter/material.dart';
import '../../../../core/constants/app_colors.dart';

class ReportCard extends StatelessWidget {
  final String title;
  final String desc;
  final IconData icon;
  final Color color;
  final List<String> tags;
  final bool isPopular;
  final VoidCallback onTap;

  const ReportCard({
    super.key,
    required this.title,
    required this.desc,
    required this.icon,
    required this.color,
    required this.tags,
    required this.onTap,
    this.isPopular = false,
  });

  @override
  Widget build(BuildContext context) {
    return InkWell(
      onTap: onTap,
      borderRadius: BorderRadius.circular(16),
      hoverColor: AppColors.textWhite.withValues(alpha: 0.02),
      child: Container(
        padding: const EdgeInsets.all(24),
        decoration: BoxDecoration(
          color: AppColors.surfaceGrey,
          borderRadius: BorderRadius.circular(16),
          border: Border.all(
            color: isPopular ? AppColors.primaryBlue.withValues(alpha: 0.5) : AppColors.divider,
            width: isPopular ? 1.5 : 1
          ),
        ),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                Container(
                  padding: const EdgeInsets.all(10),
                  decoration: BoxDecoration(
                    color: color.withValues(alpha: 0.15),
                    borderRadius: BorderRadius.circular(8),
                  ),
                  child: Icon(icon, color: color, size: 20),
                ),
                if (isPopular)
                  Container(
                    padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                    decoration: BoxDecoration(
                      color: AppColors.primaryBlue,
                      borderRadius: BorderRadius.circular(20),
                    ),
                    child: const Text("Most Popular", style: TextStyle(color: Colors.white, fontSize: 10, fontWeight: FontWeight.bold)),
                  ),
              ],
            ),
            const SizedBox(height: 16),
            Text(title, style: const TextStyle(color: AppColors.textWhite, fontSize: 16, fontWeight: FontWeight.bold)),
            const SizedBox(height: 8),
            Text(desc, style: const TextStyle(color: AppColors.textWhite54, fontSize: 12, height: 1.5), maxLines: 3, overflow: TextOverflow.ellipsis),
            const Spacer(),
            const Divider(color: AppColors.divider),
            const SizedBox(height: 8),
            Row(
              children: [
                ...tags.map((t) => Padding(
                  padding: const EdgeInsets.only(right: 8.0),
                  child: Text(t, style: const TextStyle(color: AppColors.textWhite38, fontSize: 10, fontWeight: FontWeight.w500)),
                )),
                const Spacer(),
                const Icon(Icons.arrow_forward, color: AppColors.textWhite38, size: 16),
              ],
            )
          ],
        ),
      ),
    );
  }
}
// ==========================================
// FILE: ./pc/widgets/logout_dialog.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:supabase_flutter/supabase_flutter.dart';
import 'package:go_router/go_router.dart';

class LogoutDialog extends StatefulWidget {
  const LogoutDialog({super.key});

  @override
  State<LogoutDialog> createState() => _LogoutDialogState();
}

class _LogoutDialogState extends State<LogoutDialog> {
  bool _isLoading = false;

  Future<void> _handleLogout() async {
    setState(() => _isLoading = true);
    try {
      // 1. Sign out from Supabase
      await Supabase.instance.client.auth.signOut();
      
      if (mounted) {
        // 2. Close dialog
        Navigator.of(context).pop(); 
        
        // 3. The Router (GoRouter) should detect the auth state change 
        // and redirect to /login automatically. 
        // But for safety, we can explicitly go there if the listener lags.
        context.go('/login');
      }
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text("Logout failed: $e"), backgroundColor: Colors.red),
        );
        setState(() => _isLoading = false);
      }
    }
  }

  @override
  Widget build(BuildContext context) {
    // ignore: unused_local_variable
    const bgColor = Color(0xFF151718);
    const surfaceColor = Color(0xFF1F2227); // Slightly lighter for dialog
    const textWhite = Colors.white;
    const textGrey = Color(0xFF9CA3AF);
    const dangerRed = Color(0xFFEF4444);

    return Dialog(
      backgroundColor: surfaceColor,
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
      child: Container(
        width: 400,
        padding: const EdgeInsets.all(24),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          crossAxisAlignment: CrossAxisAlignment.start, // Align left as per design
          children: [
            Row(
              children: [
                Container(
                  padding: const EdgeInsets.all(10),
                  decoration: BoxDecoration(
                    color: dangerRed.withAlpha(30),
                    shape: BoxShape.circle,
                  ),
                  child: const Icon(Icons.logout, color: dangerRed, size: 24),
                ),
                const SizedBox(width: 16),
                const Text(
                  "Confirm Logout",
                  style: TextStyle(
                    color: textWhite,
                    fontSize: 18,
                    fontWeight: FontWeight.bold,
                  ),
                ),
              ],
            ),
            const SizedBox(height: 16),
            const Text(
              "Are you sure you want to log out of the Financial Portal? Any unsaved changes on the current page will be preserved locally.",
              style: TextStyle(color: textGrey, fontSize: 14, height: 1.5),
            ),
            const SizedBox(height: 32),
            Row(
              mainAxisAlignment: MainAxisAlignment.end,
              children: [
                TextButton(
                  onPressed: () => Navigator.pop(context),
                  child: const Text("Cancel", style: TextStyle(color: textGrey)),
                ),
                const SizedBox(width: 12),
                ElevatedButton(
                  onPressed: _isLoading ? null : _handleLogout,
                  style: ElevatedButton.styleFrom(
                    backgroundColor: dangerRed,
                    foregroundColor: Colors.white,
                    shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
                    padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 12),
                  ),
                  child: _isLoading 
                    ? const SizedBox(width: 16, height: 16, child: CircularProgressIndicator(color: Colors.white, strokeWidth: 2))
                    : const Text("Log Out", style: TextStyle(fontWeight: FontWeight.bold)),
                ),
              ],
            ),
          ],
        ),
      ),
    );
  }
}
// ==========================================
// FILE: ./pc/widgets/profile/two_factor_dialog.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import '../../../../core/constants/app_colors.dart';

class EnableTwoFactorDialog extends StatefulWidget {
  const EnableTwoFactorDialog({super.key});

  @override
  State<EnableTwoFactorDialog> createState() => _EnableTwoFactorDialogState();
}

class _EnableTwoFactorDialogState extends State<EnableTwoFactorDialog> {
  final TextEditingController _codeController = TextEditingController();
  final String _manualCode = "J7X9 2K4M P5Q8 R3V1";

  @override
  void dispose() {
    _codeController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Dialog(
      backgroundColor: AppColors.surfaceGrey,
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
      child: Container(
        width: 480, // Fixed width for the dialog
        padding: const EdgeInsets.all(24),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // 1. HEADER
            Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                const Row(
                  children: [
                    Icon(Icons.shield_outlined, color: AppColors.primaryBlue, size: 20),
                    SizedBox(width: 12),
                    Text("Enable 2FA", style: TextStyle(color: AppColors.textWhite, fontSize: 18, fontWeight: FontWeight.bold)),
                  ],
                ),
                IconButton(
                  onPressed: () => Navigator.of(context).pop(),
                  icon: const Icon(Icons.close, color: AppColors.textWhite54),
                  padding: EdgeInsets.zero,
                  constraints: const BoxConstraints(),
                ),
              ],
            ),
            const SizedBox(height: 24),

            // 2. QR CODE SECTION
            const Text(
              "Scan this QR code with your authenticator app (like Google Authenticator or Authy) to generate your verification code.",
              style: TextStyle(color: AppColors.textWhite70, fontSize: 14, height: 1.5),
            ),
            const SizedBox(height: 24),
            Center(
              child: Container(
                width: 160,
                height: 160,
                padding: const EdgeInsets.all(12),
                decoration: BoxDecoration(
                  color: Colors.white,
                  borderRadius: BorderRadius.circular(12),
                ),
                // Replace with your actual QR code image asset or generator
                child: const Center(
                  child: Icon(Icons.qr_code_2, size: 100, color: AppColors.backgroundBlack),
                ),
              ),
            ),
            const SizedBox(height: 24),

            // 3. MANUAL ENTRY SECTION
            const Row(
              children: [
                Expanded(child: Divider(color: AppColors.divider)),
                Padding(
                  padding: EdgeInsets.symmetric(horizontal: 16),
                  child: Text("OR ENTER CODE MANUALLY", style: TextStyle(color: AppColors.textWhite38, fontSize: 12, fontWeight: FontWeight.bold)),
                ),
                Expanded(child: Divider(color: AppColors.divider)),
              ],
            ),
            const SizedBox(height: 24),
            Container(
              padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
              decoration: BoxDecoration(
                color: AppColors.backgroundBlack,
                borderRadius: BorderRadius.circular(8),
                border: Border.all(color: AppColors.divider),
              ),
              child: Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  Text(
                    _manualCode,
                    style: const TextStyle(color: AppColors.primaryBlue, fontSize: 14, fontWeight: FontWeight.bold, letterSpacing: 1.2),
                  ),
                  IconButton(
                    onPressed: () {
                      Clipboard.setData(ClipboardData(text: _manualCode));
                      ScaffoldMessenger.of(context).showSnackBar(
                        const SnackBar(content: Text("Code copied to clipboard")),
                      );
                    },
                    icon: const Icon(Icons.copy, color: AppColors.textWhite54, size: 18),
                    padding: EdgeInsets.zero,
                    constraints: const BoxConstraints(),
                  ),
                ],
              ),
            ),
            const SizedBox(height: 24),

            // 4. VERIFICATION SECTION
            const Text("Enter 6-digit verification code", style: TextStyle(color: AppColors.textWhite70, fontSize: 14)),
            const SizedBox(height: 12),
            TextFormField(
              controller: _codeController,
              style: const TextStyle(color: AppColors.textWhite, letterSpacing: 2),
              keyboardType: TextInputType.number,
              maxLength: 6,
              decoration: InputDecoration(
                filled: true,
                fillColor: AppColors.backgroundBlack,
                hintText: "000 000",
                hintStyle: const TextStyle(color: AppColors.textWhite38),
                prefixIcon: const Icon(Icons.lock_clock_outlined, color: AppColors.textWhite38, size: 18),
                counterText: "", // Hide max length counter
                contentPadding: const EdgeInsets.all(16),
                border: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.divider)),
                enabledBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.divider)),
                focusedBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.primaryBlue)),
              ),
            ),
            const SizedBox(height: 32),

            // 5. ACTIONS
            Row(
              mainAxisAlignment: MainAxisAlignment.end,
              children: [
                TextButton(
                  onPressed: () => Navigator.of(context).pop(),
                  style: TextButton.styleFrom(
                    foregroundColor: AppColors.textWhite70,
                    padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 16),
                  ),
                  child: const Text("Cancel"),
                ),
                const SizedBox(width: 12),
                ElevatedButton(
                  onPressed: () {
                    // TODO: Implement verification logic
                    Navigator.of(context).pop();
                    ScaffoldMessenger.of(context).showSnackBar(
                      const SnackBar(content: Text("2FA Enabled Successfully!")),
                    );
                  },
                  style: ElevatedButton.styleFrom(
                    backgroundColor: AppColors.primaryBlue,
                    foregroundColor: Colors.white,
                    padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 16),
                    shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
                  ),
                  child: const Text("Verify & Enable"),
                ),
              ],
            ),
          ],
        ),
      ),
    );
  }
}
// ==========================================
// FILE: ./pc/widgets/profile/activity_log_view.dart
// ==========================================

import 'package:flutter/material.dart';
import '../../../../../core/constants/app_colors.dart';

class ActivityLogView extends StatelessWidget {
  const ActivityLogView({super.key});

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.all(24),
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: AppColors.divider),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              const Text("Recent Activity", style: TextStyle(color: AppColors.textWhite, fontSize: 16, fontWeight: FontWeight.bold)),
              OutlinedButton.icon(
                onPressed: (){}, 
                icon: const Icon(Icons.download, size: 14),
                label: const Text("Export Log", style: TextStyle(fontSize: 12)),
                style: OutlinedButton.styleFrom(
                  foregroundColor: AppColors.textWhite,
                  side: const BorderSide(color: AppColors.divider),
                  padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
                ),
              ),
            ],
          ),
          const SizedBox(height: 8),
          const Text("Audit log of actions performed by your account.", style: TextStyle(color: AppColors.textWhite54, fontSize: 13)),
          const SizedBox(height: 32),

          // Log Items
          _buildLogItem(
            action: "Updated Billing Settings",
            detail: "Changed late fee percentage from 1.2% to 1.5%",
            time: "2 hours ago",
            icon: Icons.edit_note,
            iconColor: AppColors.primaryBlue,
          ),
          _buildTimelineConnector(),
          
          _buildLogItem(
            action: "User Login",
            detail: "Successful login from Chrome on Windows 11 (IP: 192.168.1.42)",
            time: "Today, 09:41 AM",
            icon: Icons.login,
            iconColor: AppColors.successGreen,
          ),
          _buildTimelineConnector(),

          _buildLogItem(
            action: "Exported Data",
            detail: "Downloaded 'Student_List_Oct.csv'",
            time: "Yesterday, 4:20 PM",
            icon: Icons.cloud_download,
            iconColor: Colors.orange,
          ),
          _buildTimelineConnector(),

          _buildLogItem(
            action: "Password Changed",
            detail: "Security update via Profile Settings",
            time: "Oct 28, 2023",
            icon: Icons.lock_reset,
            iconColor: AppColors.textWhite,
          ),
        ],
      ),
    );
  }

  Widget _buildTimelineConnector() {
    return Container(
      width: 1,
      height: 24,
      margin: const EdgeInsets.only(left: 20), // Align with circle center (12 padding + 8 radius)
      color: AppColors.divider,
    );
  }

  Widget _buildLogItem({
    required String action, 
    required String detail, 
    required String time, 
    required IconData icon, 
    required Color iconColor
  }) {
    return Row(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Container(
          padding: const EdgeInsets.all(8),
          decoration: BoxDecoration(
            color: AppColors.backgroundBlack,
            shape: BoxShape.circle,
            border: Border.all(color: AppColors.divider),
          ),
          child: Icon(icon, color: iconColor, size: 16),
        ),
        const SizedBox(width: 16),
        Expanded(
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  Text(action, style: const TextStyle(color: AppColors.textWhite, fontSize: 14, fontWeight: FontWeight.w600)),
                  Text(time, style: const TextStyle(color: AppColors.textWhite38, fontSize: 12)),
                ],
              ),
              const SizedBox(height: 4),
              Text(detail, style: const TextStyle(color: AppColors.textWhite54, fontSize: 13, height: 1.4)),
            ],
          ),
        ),
      ],
    );
  }
}
// ==========================================
// FILE: ./pc/widgets/profile/role_permissions_view.dart
// ==========================================

import 'package:flutter/material.dart';
import '../../../../../core/constants/app_colors.dart';

class RolePermissionsView extends StatelessWidget {
  const RolePermissionsView({super.key});

  @override
  Widget build(BuildContext context) {
    return Column(
      children: [
        // --- ROLE HIGHLIGHT CARD ---
        Container(
          width: double.infinity,
          padding: const EdgeInsets.all(32),
          decoration: BoxDecoration(
            // Special gradient for Admin Highlight
            gradient: LinearGradient(
              colors: [
                AppColors.primaryBlue.withValues(alpha: 0.15), 
                AppColors.surfaceGrey
              ],
              begin: Alignment.topLeft,
              end: Alignment.bottomRight,
            ),
            borderRadius: BorderRadius.circular(16),
            border: Border.all(color: AppColors.primaryBlue.withValues(alpha: 0.4)),
          ),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Row(
                children: [
                  Container(
                    padding: const EdgeInsets.all(8),
                    decoration: BoxDecoration(
                      color: AppColors.primaryBlue,
                      shape: BoxShape.circle,
                      boxShadow: [
                        BoxShadow(color: AppColors.primaryBlue.withValues(alpha: 0.4), blurRadius: 12, offset: const Offset(0, 4))
                      ]
                    ),
                    child: const Icon(Icons.verified_user, color: Colors.white, size: 24),
                  ),
                  const SizedBox(width: 16),
                  Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      const Text("Current Role Assignment", style: TextStyle(color: AppColors.textWhite54, fontSize: 12, letterSpacing: 1)),
                      const SizedBox(height: 4),
                      Row(
                        children: [
                          const Text("School Administrator", style: TextStyle(color: AppColors.textWhite, fontSize: 20, fontWeight: FontWeight.bold)),
                          const SizedBox(width: 12),
                          Container(
                            padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 4),
                            decoration: BoxDecoration(
                              color: AppColors.primaryBlue,
                              borderRadius: BorderRadius.circular(20),
                            ),
                            child: const Text("SUPER USER", style: TextStyle(color: Colors.white, fontSize: 10, fontWeight: FontWeight.bold, letterSpacing: 1)),
                          ),
                        ],
                      ),
                    ],
                  ),
                ],
              ),
              const SizedBox(height: 24),
              const Text(
                "You have full access to all modules within this school organization. You can manage users, billing configurations, and academic records.",
                style: TextStyle(color: AppColors.textWhite70, fontSize: 14, height: 1.6),
              ),
            ],
          ),
        ),
        
        const SizedBox(height: 24),

        // --- PERMISSIONS LIST ---
        Container(
          padding: const EdgeInsets.all(24),
          decoration: BoxDecoration(
            color: AppColors.surfaceGrey,
            borderRadius: BorderRadius.circular(16),
            border: Border.all(color: AppColors.divider),
          ),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              const Text("Active Permissions", style: TextStyle(color: AppColors.textWhite, fontSize: 16, fontWeight: FontWeight.bold)),
              const SizedBox(height: 24),
              
              _buildPermItem(
                Icons.account_balance_wallet, 
                "Financial Access", 
                "Full read/write access to invoices, payments, and ledgers."
              ),
              const Divider(color: AppColors.divider, height: 32),
              
              _buildPermItem(
                Icons.people_alt, 
                "User Management", 
                "Can invite teachers, students, and modify roles."
              ),
              const Divider(color: AppColors.divider, height: 32),
              
              _buildPermItem(
                Icons.settings, 
                "System Configuration", 
                "Can modify school year, billing cycles, and global settings."
              ),
            ],
          ),
        ),
      ],
    );
  }

  Widget _buildPermItem(IconData icon, String title, String desc) {
    return Row(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Icon(icon, color: AppColors.textWhite54, size: 22),
        const SizedBox(width: 16),
        Expanded(
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text(title, style: const TextStyle(color: AppColors.textWhite, fontSize: 14, fontWeight: FontWeight.bold)),
              const SizedBox(height: 4),
              Text(desc, style: const TextStyle(color: AppColors.textWhite54, fontSize: 13)),
            ],
          ),
        ),
        const Icon(Icons.check_circle, color: AppColors.successGreen, size: 20),
      ],
    );
  }
}
// ==========================================
// FILE: ./pc/widgets/profile/personal_info_form.dart
// ==========================================

import 'package:flutter/material.dart';
import '../../../../../core/constants/app_colors.dart';

class PersonalInfoForm extends StatelessWidget {
  const PersonalInfoForm({super.key});

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.all(24),
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: AppColors.divider),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              const Text("Personal Information", style: TextStyle(color: AppColors.textWhite, fontSize: 16, fontWeight: FontWeight.bold)),
              Icon(Icons.badge, color: AppColors.textWhite.withValues(alpha: 0.2), size: 20),
            ],
          ),
          const SizedBox(height: 4),
          const Text("Update your personal details and contact info here.", style: TextStyle(color: AppColors.textWhite54, fontSize: 13)),
          const SizedBox(height: 24),

          Row(
            children: [
              Expanded(child: _buildInput("First Name", "Jane", Icons.person_outline)),
              const SizedBox(width: 24),
              Expanded(child: _buildInput("Last Name", "Doe", Icons.person_outline)),
            ],
          ),
          const SizedBox(height: 24),
          
          _buildInput("Email Address", "jane.doe@schooladmin.edu", Icons.email_outlined),
          const SizedBox(height: 24),
          
          _buildInput("Phone Number", "+1 (555) 123-4567", Icons.phone_outlined),
          const SizedBox(height: 24),

          const Text("Bio / Role Description", style: TextStyle(color: AppColors.textWhite70, fontSize: 13)),
          const SizedBox(height: 8),
          TextFormField(
            initialValue: "Responsible for overseeing all financial operations, including student billing, expense tracking, and ledger reconciliation.",
            maxLines: 4,
            style: const TextStyle(color: AppColors.textWhite),
            decoration: InputDecoration(
              filled: true,
              fillColor: AppColors.backgroundBlack,
              border: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.divider)),
              enabledBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.divider)),
              focusedBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.primaryBlue)),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildInput(String label, String value, IconData icon) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(label, style: const TextStyle(color: AppColors.textWhite70, fontSize: 13)),
        const SizedBox(height: 8),
        TextFormField(
          initialValue: value,
          style: const TextStyle(color: AppColors.textWhite),
          decoration: InputDecoration(
            filled: true,
            fillColor: AppColors.backgroundBlack,
            prefixIcon: Icon(icon, color: AppColors.textWhite38, size: 18),
            border: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.divider)),
            enabledBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.divider)),
            focusedBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.primaryBlue)),
          ),
        ),
      ],
    );
  }
}
// ==========================================
// FILE: ./pc/widgets/profile/account_security_card.dart
// ==========================================

import 'package:flutter/material.dart';
import '../../../../../core/constants/app_colors.dart';
import 'package:fees_up/pc/widgets/profile/two_factor_dialog.dart'; // Absolute import for safety

class AccountSecurityCard extends StatelessWidget {
  const AccountSecurityCard({super.key});

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: AppColors.backgroundBlack,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: AppColors.divider),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          const Text("Account Security", style: TextStyle(color: AppColors.textWhite, fontSize: 14, fontWeight: FontWeight.bold)),
          const SizedBox(height: 16),
          
          // Password Status
          Container(
            padding: const EdgeInsets.all(12),
            decoration: BoxDecoration(
              color: AppColors.successGreen.withValues(alpha: 0.1),
              borderRadius: BorderRadius.circular(8),
              border: Border.all(color: AppColors.successGreen.withValues(alpha: 0.3)),
            ),
            child: const Row(
              children: [
                Icon(Icons.shield, color: AppColors.successGreen, size: 20),
                SizedBox(width: 12),
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text("Strong Password", style: TextStyle(color: AppColors.successGreen, fontWeight: FontWeight.bold, fontSize: 12)),
                      Text("Last changed 30 days ago", style: TextStyle(color: AppColors.textWhite54, fontSize: 10)),
                    ],
                  ),
                ),
                Icon(Icons.check_circle, color: AppColors.successGreen, size: 16),
              ],
            ),
          ),
          const SizedBox(height: 12),

          // 2FA Status
          Container(
            padding: const EdgeInsets.all(12),
            decoration: BoxDecoration(
              color: Colors.orange.withValues(alpha: 0.1),
              borderRadius: BorderRadius.circular(8),
              border: Border.all(color: Colors.orange.withValues(alpha: 0.3)),
            ),
            child: Row(
              children: [
                const Icon(Icons.phonelink_lock, color: Colors.orange, size: 20),
                const SizedBox(width: 12),
                const Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text("2FA Inactive", style: TextStyle(color: Colors.orange, fontWeight: FontWeight.bold, fontSize: 12)),
                      Text("Recommended for admins", style: TextStyle(color: AppColors.textWhite54, fontSize: 10)),
                    ],
                  ),
                ),
                TextButton(
                  onPressed: () {
                    showDialog(
                      context: context,
                      barrierColor: Colors.black.withValues(alpha: 0.7),
                      builder: (context) => const EnableTwoFactorDialog(),
                    );
                  },
                  style: TextButton.styleFrom(
                    backgroundColor: Colors.orange,
                    foregroundColor: Colors.black,
                    // Use VisualDensity for compact layout without killing the hit target
                    visualDensity: VisualDensity.compact, 
                    padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
                    shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(6)),
                  ),
                  child: const Text("Enable", style: TextStyle(fontSize: 11, fontWeight: FontWeight.bold)),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }
}
// ==========================================
// FILE: ./pc/widgets/profile/profile_header_card.dart
// ==========================================

import 'package:flutter/material.dart';
import '../../../../../core/constants/app_colors.dart';

class ProfileHeaderCard extends StatelessWidget {
  const ProfileHeaderCard({super.key});

  @override
  Widget build(BuildContext context) {
    return Container(
      height: 200,
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: AppColors.divider),
      ),
      child: Stack(
        children: [
          // Blue Gradient Banner
          Container(
            height: 100,
            decoration: BoxDecoration(
              borderRadius: const BorderRadius.vertical(top: Radius.circular(15)),
              gradient: LinearGradient(
                colors: [const Color(0xFF1E3A8A), AppColors.primaryBlue.withValues(alpha: 0.6)],
                begin: Alignment.topLeft,
                end: Alignment.bottomRight,
              ),
            ),
          ),
          
          // Profile Details Layer
          Positioned(
            left: 32,
            bottom: 24,
            right: 32,
            child: Row(
              crossAxisAlignment: CrossAxisAlignment.end,
              children: [
                // Avatar Group
                Stack(
                  children: [
                    Container(
                      padding: const EdgeInsets.all(4),
                      decoration: const BoxDecoration(color: AppColors.surfaceGrey, shape: BoxShape.circle),
                      child: const CircleAvatar(
                        radius: 42,
                        backgroundColor: AppColors.textWhite,
                        // backgroundImage: NetworkImage(...) 
                        child: Text("JD", style: TextStyle(fontSize: 24, fontWeight: FontWeight.bold, color: Colors.black)),
                      ),
                    ),
                    Positioned(
                      bottom: 4, right: 4,
                      child: Container(
                        padding: const EdgeInsets.all(6),
                        decoration: const BoxDecoration(color: AppColors.primaryBlue, shape: BoxShape.circle),
                        child: const Icon(Icons.camera_alt, size: 14, color: Colors.white),
                      ),
                    )
                  ],
                ),
                const SizedBox(width: 20),
                
                // Info Text
                const Expanded(
                  child: Padding(
                    padding: EdgeInsets.only(bottom: 8.0),
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text("Jane Doe", style: TextStyle(color: AppColors.textWhite, fontSize: 24, fontWeight: FontWeight.bold)),
                        SizedBox(height: 6),
                        Row(
                          children: [
                            Icon(Icons.verified, size: 16, color: AppColors.primaryBlue),
                            SizedBox(width: 6),
                            Text("Finance Administrator  ‚Ä¢  School Admin Portal", style: TextStyle(color: AppColors.textWhite70, fontSize: 13)),
                          ],
                        ),
                      ],
                    ),
                  ),
                ),

                // Action Buttons
                Padding(
                  padding: const EdgeInsets.only(bottom: 12.0),
                  child: Row(
                    children: [
                      OutlinedButton(
                        onPressed: () {},
                        style: OutlinedButton.styleFrom(
                          foregroundColor: AppColors.textWhite,
                          side: const BorderSide(color: AppColors.divider),
                          padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 16),
                        ),
                        child: const Text("View Public Profile"),
                      ),
                      const SizedBox(width: 12),
                      ElevatedButton(
                        onPressed: () {}, // Save Logic
                        style: ElevatedButton.styleFrom(
                          backgroundColor: AppColors.primaryBlue,
                          foregroundColor: Colors.white,
                          padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 16),
                        ),
                        child: const Text("Save Changes"),
                      ),
                    ],
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }
}
// ==========================================
// FILE: ./pc/widgets/profile/security_password_view.dart
// ==========================================

import 'package:flutter/material.dart';
import '../../../../../core/constants/app_colors.dart';

class SecurityPasswordView extends StatelessWidget {
  const SecurityPasswordView({super.key});

  @override
  Widget build(BuildContext context) {
    return Column(
      children: [
        // Password Card
        Container(
          padding: const EdgeInsets.all(24),
          decoration: BoxDecoration(
            color: AppColors.surfaceGrey,
            borderRadius: BorderRadius.circular(12),
            border: Border.all(color: AppColors.divider),
          ),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              const Text("Change Password", style: TextStyle(color: AppColors.textWhite, fontSize: 16, fontWeight: FontWeight.bold)),
              const SizedBox(height: 4),
              const Text("Ensure your account is using a long, random password to stay secure.", style: TextStyle(color: AppColors.textWhite54, fontSize: 13)),
              const SizedBox(height: 24),

              _buildLabel("Current Password"),
              _buildInput("‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢", isPassword: true),
              const SizedBox(height: 24),

              Row(
                children: [
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        _buildLabel("New Password"),
                        _buildInput("‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢", isPassword: true, isNew: true),
                      ],
                    ),
                  ),
                  const SizedBox(width: 24),
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        _buildLabel("Confirm New Password"),
                        _buildInput("‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢", isPassword: true),
                      ],
                    ),
                  ),
                ],
              ),
              const SizedBox(height: 16),

              // Strength Meter
              Container(
                padding: const EdgeInsets.all(16),
                decoration: BoxDecoration(
                  color: AppColors.backgroundBlack,
                  borderRadius: BorderRadius.circular(8),
                  border: Border.all(color: AppColors.divider),
                ),
                child: Column(
                  children: [
                    const Row(
                      mainAxisAlignment: MainAxisAlignment.spaceBetween,
                      children: [
                        Text("Password Strength", style: TextStyle(color: AppColors.textWhite70, fontSize: 11)),
                        Text("Strong", style: TextStyle(color: AppColors.successGreen, fontSize: 11, fontWeight: FontWeight.bold)),
                      ],
                    ),
                    const SizedBox(height: 8),
                    ClipRRect(
                      borderRadius: BorderRadius.circular(2),
                      child: const LinearProgressIndicator(
                        value: 0.85,
                        minHeight: 4,
                        backgroundColor: AppColors.divider,
                        color: AppColors.successGreen,
                      ),
                    ),
                    const SizedBox(height: 8),
                    const Row(
                      children: [
                        Icon(Icons.check, size: 12, color: AppColors.successGreen),
                        SizedBox(width: 6),
                        Text("Contains at least 8 characters, one number, and one symbol.", style: TextStyle(color: AppColors.textWhite54, fontSize: 11)),
                      ],
                    ),
                  ],
                ),
              ),

              const SizedBox(height: 24),
              Row(
                mainAxisAlignment: MainAxisAlignment.end,
                children: [
                  TextButton(onPressed: (){}, child: const Text("Forgot Password?", style: TextStyle(color: AppColors.textWhite70))),
                  const SizedBox(width: 12),
                  ElevatedButton(
                    onPressed: (){}, 
                    style: ElevatedButton.styleFrom(backgroundColor: AppColors.primaryBlue, foregroundColor: Colors.white),
                    child: const Text("Update Password"),
                  ),
                ],
              ),
            ],
          ),
        ),
        
        const SizedBox(height: 24),

        // 2FA Card
        Container(
          padding: const EdgeInsets.all(24),
          decoration: BoxDecoration(
            color: AppColors.surfaceGrey,
            borderRadius: BorderRadius.circular(12),
            border: Border.all(color: AppColors.divider),
          ),
          child: const Row(
            children: [
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text("Two-Factor Authentication", style: TextStyle(color: AppColors.textWhite, fontSize: 16, fontWeight: FontWeight.bold)),
                    SizedBox(height: 4),
                    Text("Add an extra layer of security by requiring a code from your phone.", style: TextStyle(color: AppColors.textWhite54, fontSize: 13)),
                  ],
                ),
              ),
              Icon(Icons.phonelink_lock, size: 32, color: AppColors.textWhite38),
            ],
          ),
        ),
      ],
    );
  }

  Widget _buildLabel(String text) => Padding(padding: const EdgeInsets.only(bottom: 8), child: Text(text, style: const TextStyle(color: AppColors.textWhite70, fontSize: 13)));

  Widget _buildInput(String hint, {bool isPassword = false, bool isNew = false}) {
    return TextFormField(
      obscureText: isPassword,
      style: const TextStyle(color: AppColors.textWhite),
      decoration: InputDecoration(
        filled: true,
        fillColor: AppColors.backgroundBlack,
        hintText: hint,
        hintStyle: const TextStyle(color: AppColors.textWhite38, letterSpacing: 2),
        prefixIcon: const Icon(Icons.key, color: AppColors.textWhite38, size: 18),
        suffixIcon: isNew ? const Icon(Icons.visibility_off, color: AppColors.textWhite38, size: 18) : null,
        border: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.divider)),
        enabledBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.divider)),
        focusedBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.primaryBlue)),
      ),
    );
  }
}
// ==========================================
// FILE: ./pc/widgets/invoices/invoices_stats.dart
// ==========================================

import 'package:flutter/material.dart';
import '../../../../core/constants/app_colors.dart';

class InvoicesStats extends StatelessWidget {
  final VoidCallback onCreateInvoice;

  const InvoicesStats({
    super.key, 
    required this.onCreateInvoice,
  });

  @override
  Widget build(BuildContext context) {
    return SizedBox(
      height: 140, // Fixed height for uniformity
      child: Row(
        children: [
          // 1. Total Invoiced
          const Expanded(
            child: _StatCard(
              title: "Total Invoiced",
              value: "\$45,231.00",
              subtext: "+12.5% from last month",
              subtextColor: AppColors.successGreen,
              icon: Icons.bar_chart,
              iconColor: AppColors.primaryBlue,
            ),
          ),
          const SizedBox(width: 16),

          // 2. Pending Payment
          const Expanded(
            child: _StatCard(
              title: "Pending Payment",
              value: "\$12,450.00",
              subtext: "45 active invoices",
              subtextColor: AppColors.warningOrange,
              icon: Icons.pending_actions,
              iconColor: AppColors.warningOrange,
            ),
          ),
          const SizedBox(width: 16),

          // 3. Overdue
          const Expanded(
            child: _StatCard(
              title: "Overdue",
              value: "\$2,840.00",
              subtext: "Needs attention (8 students)",
              subtextColor: AppColors.errorRed,
              icon: Icons.warning_amber_rounded,
              iconColor: AppColors.errorRed,
            ),
          ),
          const SizedBox(width: 16),

          // 4. Create New Action Card
          Expanded(
            child: _CreateInvoiceCard(onTap: onCreateInvoice),
          ),
        ],
      ),
    );
  }
}

class _StatCard extends StatelessWidget {
  final String title;
  final String value;
  final String subtext;
  final Color subtextColor;
  final IconData icon;
  final Color iconColor;

  const _StatCard({
    required this.title,
    required this.value,
    required this.subtext,
    required this.subtextColor,
    required this.icon,
    required this.iconColor,
  });

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: AppColors.divider),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Text(title, style: const TextStyle(color: AppColors.textGrey, fontSize: 13)),
              Container(
                padding: const EdgeInsets.all(6),
                decoration: BoxDecoration(
                  color: iconColor.withAlpha(38),
                  borderRadius: BorderRadius.circular(6),
                ),
                child: Icon(icon, color: iconColor, size: 18),
              ),
            ],
          ),
          Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text(value, style: const TextStyle(color: AppColors.textWhite, fontSize: 24, fontWeight: FontWeight.bold)),
              const SizedBox(height: 4),
              Text(subtext, style: TextStyle(color: subtextColor, fontSize: 12, fontWeight: FontWeight.w500)),
            ],
          ),
        ],
      ),
    );
  }
}

class _CreateInvoiceCard extends StatelessWidget {
  final VoidCallback onTap;
  const _CreateInvoiceCard({required this.onTap});

  @override
  Widget build(BuildContext context) {
    return InkWell(
      onTap: onTap,
      borderRadius: BorderRadius.circular(12),
      child: Container(
        decoration: BoxDecoration(
          color: AppColors.surfaceDarkGrey,
          borderRadius: BorderRadius.circular(12),
          border: Border.all(color: AppColors.divider, style: BorderStyle.solid), // Dashed effect requires custom painter, using solid for now to stay clean
        ),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Container(
              width: 48, height: 48,
              decoration: BoxDecoration(
                color: AppColors.primaryBlue.withAlpha(26),
                shape: BoxShape.circle,
              ),
              child: const Icon(Icons.add, color: AppColors.primaryBlue, size: 24),
            ),
            const SizedBox(height: 12),
            const Text(
              "Create New Invoice",
              style: TextStyle(color: AppColors.textWhite, fontWeight: FontWeight.w600),
            ),
          ],
        ),
      ),
    );
  }
}
// ==========================================
// FILE: ./pc/widgets/invoices/invoices_table.dart
// ==========================================

import 'package:flutter/material.dart';
import '../../../../core/constants/app_colors.dart';

class InvoicesTable extends StatelessWidget {
  const InvoicesTable({super.key});

  @override
  Widget build(BuildContext context) {
    return Column(
      children: [
        // --- FILTER BAR ---
        _buildFilterBar(),
        const SizedBox(height: 16),

        // --- DATA TABLE ---
        Container(
          decoration: BoxDecoration(
            color: AppColors.surfaceGrey,
            borderRadius: BorderRadius.circular(12),
            border: Border.all(color: AppColors.divider),
          ),
          child: Column(
            children: [
              // Header Row
              _buildTableHeader(),
              const Divider(height: 1, color: AppColors.divider),
              
              // Data Rows (Mock Data)
              _buildInvoiceRow(
                id: "INV-2023-001", title: "Tuition Fee - Term 1",
                student: "Alice Johnson", date: "Oct 24, 2023", due: "Nov 24, 2023",
                amount: "\$1,200.00", status: "Paid", avatarColor: Colors.blue,
              ),
              const Divider(height: 1, color: AppColors.divider),
              
              _buildInvoiceRow(
                id: "INV-2023-042", title: "Library Fine",
                student: "Mark Smith", date: "Sep 10, 2023", due: "Oct 10, 2023",
                amount: "\$45.00", status: "Overdue", avatarColor: Colors.purple,
              ),
              const Divider(height: 1, color: AppColors.divider),

              _buildInvoiceRow(
                id: "INV-2023-055", title: "Bus Transport - Q3",
                student: "Emma Davis", date: "Oct 28, 2023", due: "Nov 28, 2023",
                amount: "\$350.00", status: "Unpaid", avatarColor: Colors.orange,
              ),
            ],
          ),
        ),
      ],
    );
  }

  Widget _buildFilterBar() {
    return Row(
      children: [
        // --- Fixed Search Bar ---
        Expanded(
          child: SizedBox(
            height: 44,
            child: TextField(
              textAlignVertical: TextAlignVertical.center,
              style: const TextStyle(color: AppColors.textWhite),
              decoration: InputDecoration(
                isDense: true,
                filled: true,
                fillColor: AppColors.surfaceGrey,
                hintText: "Filter by invoice # or student",
                hintStyle: const TextStyle(color: AppColors.textWhite38, fontSize: 13),
                prefixIcon: const Icon(Icons.search, color: AppColors.textWhite38, size: 18),
                
                // Borders moved inside for perfect alignment
                border: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(8),
                  borderSide: const BorderSide(color: AppColors.divider),
                ),
                enabledBorder: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(8),
                  borderSide: const BorderSide(color: AppColors.divider),
                ),
                focusedBorder: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(8),
                  borderSide: const BorderSide(color: AppColors.primaryBlue),
                ),
                contentPadding: EdgeInsets.zero,
              ),
            ),
          ),
        ),
        const SizedBox(width: 12),

        // Status Dropdown
        _buildFilterButton(label: "Status: All", icon: Icons.keyboard_arrow_down),
        const SizedBox(width: 12),

        // Date Picker
        _buildFilterButton(label: "Select Date Range", icon: Icons.calendar_today),
        const SizedBox(width: 12),

        // More Filters
        Container(
          height: 44,
          padding: const EdgeInsets.symmetric(horizontal: 16),
          decoration: BoxDecoration(
            color: AppColors.surfaceGrey,
            borderRadius: BorderRadius.circular(8),
            border: Border.all(color: AppColors.divider),
          ),
          child: const Row(
            children: [
              Icon(Icons.filter_list, color: AppColors.textWhite70, size: 16),
              SizedBox(width: 8),
              Text("More Filters", style: TextStyle(color: AppColors.textWhite, fontSize: 13)),
            ],
          ),
        ),
        const SizedBox(width: 12),

        // Export Button
        Container(
          height: 44,
          padding: const EdgeInsets.symmetric(horizontal: 20),
          decoration: BoxDecoration(
            color: AppColors.primaryBlue,
            borderRadius: BorderRadius.circular(8),
          ),
          child: const Row(
            children: [
              Icon(Icons.download, color: Colors.white, size: 16),
              SizedBox(width: 8),
              Text("Export CSV", style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold, fontSize: 13)),
            ],
          ),
        ),
      ],
    );
  }

  Widget _buildFilterButton({required String label, required IconData icon}) {
    return Container(
      height: 44,
      padding: const EdgeInsets.symmetric(horizontal: 16),
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(8),
        border: Border.all(color: AppColors.divider),
      ),
      child: Row(
        children: [
          if (icon == Icons.calendar_today) ...[
             Icon(icon, color: AppColors.textWhite54, size: 16),
             const SizedBox(width: 8),
          ],
          Text(label, style: const TextStyle(color: AppColors.textWhite, fontSize: 13)),
          if (icon == Icons.keyboard_arrow_down) ...[
             const SizedBox(width: 8),
             Icon(icon, color: AppColors.textWhite54, size: 16),
          ],
        ],
      ),
    );
  }

  Widget _buildTableHeader() {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 16),
      child: Row(
        children: [
          _col("INVOICE DETAILS", 3),
          _col("STUDENT", 3),
          _col("ISSUE DATE", 2),
          _col("DUE DATE", 2),
          _col("AMOUNT", 2),
          _col("STATUS", 2),
          _col("ACTIONS", 1, align: TextAlign.end),
        ],
      ),
    );
  }

  Widget _col(String text, int flex, {TextAlign align = TextAlign.start}) {
    return Expanded(
      flex: flex,
      child: Text(
        text,
        textAlign: align,
        style: const TextStyle(color: AppColors.textWhite38, fontSize: 11, fontWeight: FontWeight.bold, letterSpacing: 0.8),
      ),
    );
  }

  Widget _buildInvoiceRow({
    required String id, required String title, required String student, 
    required String date, required String due, required String amount, 
    required String status, required Color avatarColor
  }) {
    Color statusColor;
    Color statusBg;
    
    switch (status) {
      case "Paid": statusColor = AppColors.successGreen; statusBg = AppColors.successGreenBg; break;
      case "Overdue": statusColor = AppColors.errorRed; statusBg = AppColors.errorRedBg; break;
      default: statusColor = AppColors.warningOrange; statusBg = AppColors.warningOrange.withAlpha(51);
    }
    
    // Highlight overdue dates in red
    final isOverdue = status == "Overdue";

    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 16),
      child: Row(
        children: [
          // Invoice Details
          Expanded(
            flex: 3,
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(id, style: const TextStyle(color: AppColors.textWhite, fontWeight: FontWeight.bold, fontFamily: 'monospace')),
                const SizedBox(height: 2),
                Text(title, style: const TextStyle(color: AppColors.textWhite54, fontSize: 12)),
              ],
            ),
          ),
          // Student
          Expanded(
            flex: 3,
            child: Row(
              children: [
                CircleAvatar(
                  radius: 14,
                  backgroundColor: avatarColor.withAlpha(51),
                  child: Text(student.substring(0,2).toUpperCase(), style: TextStyle(color: avatarColor, fontSize: 10, fontWeight: FontWeight.bold)),
                ),
                const SizedBox(width: 12),
                Text(student, style: const TextStyle(color: AppColors.textWhite)),
              ],
            ),
          ),
          // Dates
          Expanded(flex: 2, child: Text(date, style: const TextStyle(color: AppColors.textWhite70))),
          Expanded(flex: 2, child: Text(due, style: TextStyle(color: isOverdue ? AppColors.errorRed : AppColors.textWhite70))),
          // Amount
          Expanded(flex: 2, child: Text(amount, style: const TextStyle(color: AppColors.textWhite, fontWeight: FontWeight.bold))),
          // Status
          Expanded(
            flex: 2,
            child: Row(
              children: [
                Container(
                  padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 4),
                  decoration: BoxDecoration(color: statusBg, borderRadius: BorderRadius.circular(4)),
                  child: Text(status, style: TextStyle(color: statusColor, fontSize: 11, fontWeight: FontWeight.bold)),
                ),
              ],
            ),
          ),
          // Actions
          Expanded(
            flex: 1,
            child: Row(
              mainAxisAlignment: MainAxisAlignment.end,
              children: [
                IconButton(icon: const Icon(Icons.visibility, size: 18, color: AppColors.textWhite54), onPressed: (){}),
                IconButton(icon: const Icon(Icons.more_vert, size: 18, color: AppColors.textWhite54), onPressed: (){}),
              ],
            ),
          ),
        ],
      ),
    );
  }
}
// ==========================================
// FILE: ./pc/widgets/invoices/invoices_header.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../../core/constants/app_colors.dart';
import '../../../../data/providers/dashboard_provider.dart';
import '../../../../data/services/database_service.dart'; // Import DatabaseService

class InvoicesHeader extends ConsumerWidget {
  const InvoicesHeader({super.key});

  String _getInitials(String name) {
    if (name.isEmpty) return "U";
    final parts = name.trim().split(' ');
    if (parts.length > 1) {
      return "${parts[0][0]}${parts[1][0]}".toUpperCase();
    }
    return name[0].toUpperCase();
  }

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final dashboardAsync = ref.watch(dashboardDataProvider);
    
    // Check connectivity status directly for UI feedback
    final bool isConnected = DatabaseService().db.currentStatus.connected;

    return Container(
      height: 70,
      padding: const EdgeInsets.symmetric(horizontal: 24),
      color: AppColors.backgroundBlack,
      child: Row(
        children: [
          // --- Page Title ---
          const Icon(Icons.description, color: AppColors.primaryBlue, size: 28),
          const SizedBox(width: 12),
          const Text(
            "Invoices",
            style: TextStyle(
              color: AppColors.textWhite,
              fontSize: 20,
              fontWeight: FontWeight.bold,
              letterSpacing: 0.5,
            ),
          ),
          
          const Spacer(),

          // --- Global Search Bar (Fixed) ---
          SizedBox(
            width: 300,
            height: 40,
            child: TextField(
              textAlignVertical: TextAlignVertical.center,
              style: const TextStyle(color: AppColors.textWhite, fontSize: 13),
              decoration: InputDecoration(
                isDense: true,
                filled: true,
                fillColor: AppColors.surfaceGrey,
                hintText: "Search payments, invoices...",
                hintStyle: const TextStyle(color: AppColors.textWhite38),
                prefixIcon: const Icon(Icons.search, size: 18, color: AppColors.textWhite54),
                
                // Content Padding zero to center text vertically
                contentPadding: EdgeInsets.zero, 

                // Default Border
                enabledBorder: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(8),
                  borderSide: const BorderSide(color: AppColors.divider),
                ),
                
                // Focused Border
                focusedBorder: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(8),
                  borderSide: const BorderSide(color: AppColors.primaryBlue),
                ),
                
                // Fallback Border
                border: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(8),
                  borderSide: const BorderSide(color: AppColors.divider),
                ),
              ),
            ),
          ),
          
          const SizedBox(width: 24),

          // --- Notification Bell ---
          Stack(
            children: [
              IconButton(
                onPressed: () {},
                icon: const Icon(Icons.notifications_none, color: AppColors.textWhite70),
                tooltip: "Notifications",
              ),
              Positioned(
                right: 10,
                top: 10,
                child: Container(
                  width: 8, height: 8,
                  decoration: const BoxDecoration(color: AppColors.errorRed, shape: BoxShape.circle),
                ),
              )
            ],
          ),
          
          const SizedBox(width: 16),

          // --- Profile with Connectivity Logic ---
          dashboardAsync.when(
            loading: () => _buildProfileLoading(),
            error: (err, _) => _buildProfileError(isConnected),
            data: (data) {
              final initials = _getInitials(data.userName);
              
              // Determine subtitle based on data state AND connectivity
              String subtitle = data.schoolName;
              if (data.schoolName == 'Loading...') {
                subtitle = isConnected ? "Syncing Data..." : "Offline Mode";
              }

              return Row(
                children: [
                  Column(
                    mainAxisAlignment: MainAxisAlignment.center,
                    crossAxisAlignment: CrossAxisAlignment.end,
                    children: [
                      Text(
                        data.userName.isEmpty ? "User" : data.userName, 
                        style: const TextStyle(color: AppColors.textWhite, fontWeight: FontWeight.bold, fontSize: 13)
                      ),
                      Text(
                        subtitle, 
                        style: TextStyle(
                          color: (subtitle == "Offline Mode") ? AppColors.warningOrange : AppColors.textWhite38, 
                          fontSize: 11
                        )
                      ),
                    ],
                  ),
                  const SizedBox(width: 12),
                  CircleAvatar(
                    backgroundColor: AppColors.primaryBlue.withValues(alpha: 0.2),
                    child: Text(
                      initials, 
                      style: const TextStyle(color: AppColors.primaryBlue, fontWeight: FontWeight.bold, fontSize: 12)
                    ),
                  ),
                ],
              );
            },
          ),
        ],
      ),
    );
  }

  // --- Loading/Error States ---

  Widget _buildProfileLoading() {
    return Row(
      children: [
        Column(
          mainAxisAlignment: MainAxisAlignment.center,
          crossAxisAlignment: CrossAxisAlignment.end,
          children: [
            Container(width: 80, height: 12, color: AppColors.surfaceGrey),
            const SizedBox(height: 4),
            Container(width: 50, height: 10, color: AppColors.surfaceGrey),
          ],
        ),
        const SizedBox(width: 12),
        const CircleAvatar(
          backgroundColor: AppColors.surfaceGrey,
          radius: 20,
        ),
      ],
    );
  }

  Widget _buildProfileError(bool isConnected) {
    return Row(
      children: [
        Text(
          isConnected ? "Sync Error" : "Offline", 
          style: TextStyle(color: isConnected ? AppColors.errorRed : AppColors.warningOrange, fontSize: 12)
        ),
        const SizedBox(width: 12),
        CircleAvatar(
          backgroundColor: AppColors.surfaceGrey,
          child: Icon(
            isConnected ? Icons.error_outline : Icons.wifi_off, 
            size: 16, 
            color: isConnected ? AppColors.errorRed : AppColors.warningOrange
          ),
        ),
      ],
    );
  }
}
// ==========================================
// FILE: ./pc/widgets/invoices/invoice_dialog.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:intl/intl.dart';
import 'package:uuid/uuid.dart';

import '../../../../core/constants/app_colors.dart';
import '../../../../data/services/database_service.dart';
// Use your provider for access
// ignore: unused_import
import '../../../../data/providers/school_provider.dart'; 

class InvoiceDialog extends ConsumerStatefulWidget {
  final String schoolId;
  const InvoiceDialog({super.key, required this.schoolId});

  @override
  ConsumerState<InvoiceDialog> createState() => _InvoiceDialogState();
}

class _InvoiceDialogState extends ConsumerState<InvoiceDialog> {
  final _formKey = GlobalKey<FormState>();
  
  // Use the Singleton directly as per your architecture
  final DatabaseService _dbService = DatabaseService();

  // Controllers
  final _titleController = TextEditingController();
  final _amountController = TextEditingController();
  final _descController = TextEditingController();

  // State
  String? _selectedStudentId;
  DateTime _dueDate = DateTime.now().add(const Duration(days: 7));
  String _generatedInvoiceNum = "Loading...";
  String _invoiceStatus = 'draft'; // ‚úÖ NEW: Draft status support
  bool _isLoading = false;

  @override
  void initState() {
    super.initState();
    _fetchNextInvoiceNumber();
  }

  @override
  void dispose() {
    _titleController.dispose();
    _amountController.dispose();
    _descController.dispose();
    super.dispose();
  }

  // --- LOGIC (Production Ready) ---

  Future<void> _fetchNextInvoiceNumber() async {
    try {
      // 1. Use the new .select() method you added to DatabaseService
      final result = await _dbService.select(
        'SELECT invoice_number FROM bills WHERE school_id = ? ORDER BY invoice_number DESC LIMIT 1',
        [widget.schoolId],
      );

      int nextNum = 1;
      if (result.isNotEmpty) {
        final lastInv = result.first['invoice_number'] as String?;
        if (lastInv != null && lastInv.startsWith('INV-')) {
          final numericPart = int.tryParse(lastInv.split('-')[1]);
          if (numericPart != null) {
            nextNum = numericPart + 1;
          }
        }
      }

      if (mounted) {
        setState(() {
          _generatedInvoiceNum = 'INV-${nextNum.toString().padLeft(5, '0')}';
        });
      }
    } catch (e) {
      if (mounted) setState(() => _generatedInvoiceNum = "INV-ERROR");
    }
  }

  Future<void> _submitInvoice() async {
    if (!_formKey.currentState!.validate()) return;
    if (_selectedStudentId == null) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text("Please select a student"), backgroundColor: AppColors.errorRed),
      );
      return;
    }

    setState(() => _isLoading = true);

    try {
      final newId = const Uuid().v4();
      final amount = double.tryParse(_amountController.text.trim()) ?? 0.0;
      final now = DateTime.now();

      // ‚úÖ CORRECT: No schema hacks - database supports null values for adhoc bills
      final billData = {
        'id': newId,
        'school_id': widget.schoolId,
        'student_id': _selectedStudentId,
        'title': _titleController.text.trim(),
        'invoice_number': _generatedInvoiceNum, 
        'status': _invoiceStatus, // ‚úÖ NEW: Respects draft/sent status
        'total_amount': amount,
        'paid_amount': 0.0,
        'is_paid': 0, 
        'is_closed': 0,
        'bill_type': 'adhoc', // Manual entry
        'due_date': DateFormat('yyyy-MM-dd').format(_dueDate),
        'created_at': now.toIso8601String(),
        'updated_at': now.toIso8601String(),
        'month_year': DateFormat('yyyy-MM').format(now),
        // ‚úÖ FIXED: Removed artificial 'term_id': 'adhoc-manual' hack
        // Database schema properly handles null values for school_year_id, month_index, term_id
        // These fields are intentionally left null for adhoc bills
      };

      await _dbService.insert('bills', billData);

      if (mounted) {
        Navigator.of(context).pop();
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text("Invoice $_generatedInvoiceNum generated successfully"), 
            backgroundColor: AppColors.successGreen
          ),
        );
      }
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text("Error: $e"), backgroundColor: AppColors.errorRed),
        );
      }
    } finally {
      if (mounted) setState(() => _isLoading = false);
    }
  }

  // --- UI BUILD (Same visual, real logic) ---

  @override
  Widget build(BuildContext context) {
    return Dialog(
      backgroundColor: Colors.transparent,
      insetPadding: const EdgeInsets.all(24),
      child: Container(
        width: 1100,
        height: 750,
        decoration: BoxDecoration(
          color: AppColors.backgroundBlack,
          borderRadius: BorderRadius.circular(16),
          border: Border.all(color: AppColors.surfaceLightGrey),
          boxShadow: [
            BoxShadow(color: Colors.black.withValues(alpha: 0.5), blurRadius: 20, offset: const Offset(0, 10))
          ],
        ),
        child: Column(
          children: [
            _buildHeader(),
            const Divider(height: 1, color: AppColors.divider),
            
            // MAIN CONTENT (Split View)
            Expanded(
              child: Row(
                children: [
                  // LEFT: FORM
                  Expanded(
                    flex: 5,
                    child: Padding(
                      padding: const EdgeInsets.all(32),
                      child: Form(
                        key: _formKey,
                        child: SingleChildScrollView(
                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              Row(
                                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                                children: [
                                  const Text("INVOICE DETAILS", style: TextStyle(color: AppColors.textGrey, fontSize: 12, fontWeight: FontWeight.bold, letterSpacing: 1.2)),
                                  Container(
                                    padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
                                    decoration: BoxDecoration(
                                      color: AppColors.surfaceGrey,
                                      borderRadius: BorderRadius.circular(4),
                                      border: Border.all(color: AppColors.surfaceLightGrey),
                                    ),
                                    child: Text(
                                      _generatedInvoiceNum, 
                                      style: const TextStyle(color: AppColors.primaryBlueLight, fontWeight: FontWeight.bold, fontFamily: 'monospace')
                                    ),
                                  ),
                                ],
                              ),
                              const SizedBox(height: 24),

                              _buildLabel("Select Student"),
                              // Uses DatabaseService.watchStudents (Real Data)
                              _buildStudentAutocomplete(),
                              const SizedBox(height: 16),

                              _buildLabel("Title / Reason"),
                              _buildTextField(
                                controller: _titleController,
                                hint: "e.g. Broken Science Equipment",
                                validator: (v) => v!.isEmpty ? "Required" : null,
                              ),
                              const SizedBox(height: 16),

                              Row(
                                children: [
                                  Expanded(
                                    child: Column(
                                      crossAxisAlignment: CrossAxisAlignment.start,
                                      children: [
                                        _buildLabel("Amount Due"),
                                        _buildTextField(
                                          controller: _amountController,
                                          hint: "0.00",
                                          prefix: "\$ ",
                                          isNumber: true,
                                          validator: (v) {
                                            if (v == null || v.isEmpty) return "Required";
                                            if (double.tryParse(v) == null) return "Invalid";
                                            return null;
                                          },
                                        ),
                                      ],
                                    ),
                                  ),
                                  const SizedBox(width: 16),
                                  Expanded(
                                    child: Column(
                                      crossAxisAlignment: CrossAxisAlignment.start,
                                      children: [
                                        _buildLabel("Due Date"),
                                        _buildDatePicker(context),
                                      ],
                                    ),
                                  ),
                                  const SizedBox(width: 16),
                                  Expanded(
                                    child: Column(
                                      crossAxisAlignment: CrossAxisAlignment.start,
                                      children: [
                                        _buildLabel("Invoice Status"),
                                        _buildStatusDropdown(),
                                      ],
                                    ),
                                  ),
                                ],
                              ),
                              const SizedBox(height: 16),

                              _buildLabel("Notes (Internal Only)"),
                              _buildTextField(
                                controller: _descController,
                                hint: "Additional context about this charge...",
                                maxLines: 3,
                              ),
                            ],
                          ),
                        ),
                      ),
                    ),
                  ),

                  const VerticalDivider(width: 1, color: AppColors.divider),

                  // RIGHT: RECENT INVOICES LIST (Real Data Stream)
                  Expanded(
                    flex: 4,
                    child: Container(
                      color: AppColors.surfaceDarkGrey,
                      padding: const EdgeInsets.all(24),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          const Text("RECENT INVOICES", style: TextStyle(color: AppColors.textGrey, fontSize: 12, fontWeight: FontWeight.bold, letterSpacing: 1.2)),
                          const SizedBox(height: 24),
                          Expanded(
                            child: StreamBuilder<List<Map<String, dynamic>>>(
                              // Uses DatabaseService.db.watch directly
                              stream: _dbService.db.watch(
                                'SELECT * FROM bills WHERE school_id = ? AND invoice_number IS NOT NULL ORDER BY created_at DESC LIMIT 20', 
                                parameters: [widget.schoolId]
                              ),
                              builder: (context, snapshot) {
                                if (!snapshot.hasData) return const Center(child: CircularProgressIndicator(color: AppColors.primaryBlue));
                                final bills = snapshot.data ?? [];
                                
                                if (bills.isEmpty) {
                                  return const Center(child: Text("No invoices generated yet.", style: TextStyle(color: AppColors.textGrey)));
                                }

                                return ListView.separated(
                                  itemCount: bills.length,
                                  separatorBuilder: (_, __) => const SizedBox(height: 12),
                                  itemBuilder: (context, index) {
                                    final bill = bills[index];
                                    final invNum = bill['invoice_number'] ?? '---';
                                    final amount = (bill['total_amount'] as num?)?.toDouble() ?? 0.0;
                                    final title = bill['title'] ?? 'Unknown Charge';
                                    final status = bill['status'] ?? 'pending';

                                    return Container(
                                      padding: const EdgeInsets.all(16),
                                      decoration: BoxDecoration(
                                        color: AppColors.surfaceGrey,
                                        borderRadius: BorderRadius.circular(12),
                                        border: Border.all(color: Colors.white.withValues(alpha: 0.05)),
                                      ),
                                      child: Row(
                                        children: [
                                          Container(
                                            width: 40, height: 40,
                                            decoration: BoxDecoration(
                                              color: AppColors.primaryBlue.withValues(alpha: 0.1),
                                              borderRadius: BorderRadius.circular(8),
                                            ),
                                            child: const Icon(Icons.receipt, color: AppColors.primaryBlue, size: 20),
                                          ),
                                          const SizedBox(width: 12),
                                          Expanded(
                                            child: Column(
                                              crossAxisAlignment: CrossAxisAlignment.start,
                                              children: [
                                                Text(invNum, style: const TextStyle(color: AppColors.primaryBlueLight, fontSize: 12, fontWeight: FontWeight.bold, fontFamily: 'monospace')),
                                                const SizedBox(height: 2),
                                                Text(title, style: const TextStyle(color: AppColors.textWhite, fontWeight: FontWeight.w500), maxLines: 1, overflow: TextOverflow.ellipsis),
                                              ],
                                            ),
                                          ),
                                          Column(
                                            crossAxisAlignment: CrossAxisAlignment.end,
                                            children: [
                                              Text("\$${amount.toStringAsFixed(2)}", style: const TextStyle(color: AppColors.textWhite, fontWeight: FontWeight.bold)),
                                              Text(status.toString().toUpperCase(), style: TextStyle(color: _getStatusColor(status), fontSize: 10, fontWeight: FontWeight.bold)),
                                            ],
                                          ),
                                        ],
                                      ),
                                    );
                                  },
                                );
                              },
                            ),
                          ),
                        ],
                      ),
                    ),
                  ),
                ],
              ),
            ),

            const Divider(height: 1, color: AppColors.divider),

            // FOOTER
            Padding(
              padding: const EdgeInsets.all(24),
              child: Row(
                mainAxisAlignment: MainAxisAlignment.end,
                children: [
                  TextButton(
                    onPressed: () => Navigator.of(context).pop(),
                    child: const Text("Cancel", style: TextStyle(color: AppColors.textWhite70)),
                  ),
                  const SizedBox(width: 16),
                  ElevatedButton.icon(
                    onPressed: _isLoading ? null : _submitInvoice,
                    style: ElevatedButton.styleFrom(
                      backgroundColor: AppColors.primaryBlue,
                      padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 16),
                      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
                      foregroundColor: AppColors.textWhite,
                    ),
                    icon: _isLoading 
                      ? const SizedBox(width: 16, height: 16, child: CircularProgressIndicator(strokeWidth: 2, color: AppColors.textWhite)) 
                      : const Icon(Icons.print, size: 18),
                    label: Text(_isLoading ? "Processing..." : "Generate Invoice", style: const TextStyle(fontWeight: FontWeight.bold)),
                  ),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }

  // --- UI HELPERS ---

  Widget _buildHeader() {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 32, vertical: 24),
      child: Row(
        children: [
          Container(
            padding: const EdgeInsets.all(8),
            decoration: BoxDecoration(
              color: AppColors.primaryBlue.withValues(alpha: 0.2), 
              borderRadius: BorderRadius.circular(8)
            ),
            child: const Icon(Icons.description, color: AppColors.primaryBlue),
          ),
          const SizedBox(width: 16),
          const Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text("Create Invoice", style: TextStyle(color: AppColors.textWhite, fontSize: 18, fontWeight: FontWeight.bold)),
              Text("Manually generate a bill for a student", style: TextStyle(color: AppColors.textGrey, fontSize: 13)),
            ],
          ),
          const Spacer(),
          IconButton(
            onPressed: () => Navigator.of(context).pop(),
            icon: const Icon(Icons.close, color: AppColors.textGrey),
          ),
        ],
      ),
    );
  }

  Widget _buildStudentAutocomplete() {
    return StreamBuilder<List<Map<String, dynamic>>>(
      stream: _dbService.watchStudents(widget.schoolId),
      builder: (context, snapshot) {
        if (!snapshot.hasData) return const LinearProgressIndicator(color: AppColors.primaryBlue, backgroundColor: AppColors.surfaceGrey);
        
        final students = snapshot.data!;
        
        return LayoutBuilder(
          builder: (context, constraints) {
            return Autocomplete<Map<String, dynamic>>(
              optionsBuilder: (TextEditingValue val) {
                if (val.text.isEmpty) return students;
                return students.where((s) {
                  return s['full_name'].toString().toLowerCase().contains(val.text.toLowerCase()) || 
                         (s['student_id'] ?? '').toString().toLowerCase().contains(val.text.toLowerCase());
                });
              },
              displayStringForOption: (option) => "${option['full_name']} (${option['student_id'] ?? 'N/A'})",
              onSelected: (selection) => setState(() => _selectedStudentId = selection['id']),
              
              fieldViewBuilder: (context, controller, focusNode, onFieldSubmitted) {
                return TextFormField(
                  controller: controller,
                  focusNode: focusNode,
                  style: const TextStyle(color: AppColors.textWhite),
                  decoration: InputDecoration(
                    filled: true,
                    fillColor: AppColors.surfaceGrey,
                    hintText: "Search student...",
                    hintStyle: TextStyle(color: AppColors.textWhite.withValues(alpha: 0.3)),
                    prefixIcon: const Icon(Icons.search, color: AppColors.textWhite54),
                    border: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.surfaceLightGrey)),
                    enabledBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.surfaceLightGrey)),
                    focusedBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.primaryBlue)),
                  ),
                );
              },
              optionsViewBuilder: (context, onSelected, options) {
                return Align(
                  alignment: Alignment.topLeft,
                  child: Material(
                    color: AppColors.surfaceGrey,
                    elevation: 4,
                    borderRadius: const BorderRadius.vertical(bottom: Radius.circular(8)),
                    child: Container(
                      width: constraints.maxWidth,
                      constraints: const BoxConstraints(maxHeight: 250),
                      decoration: BoxDecoration(border: Border.all(color: AppColors.surfaceLightGrey)),
                      child: ListView.builder(
                        padding: EdgeInsets.zero,
                        itemCount: options.length,
                        itemBuilder: (context, index) {
                          final option = options.elementAt(index);
                          return ListTile(
                            title: Text(option['full_name'], style: const TextStyle(color: AppColors.textWhite)),
                            subtitle: Text(option['student_id'] ?? 'No ID', style: const TextStyle(color: AppColors.textGrey, fontSize: 12)),
                            onTap: () => onSelected(option),
                            hoverColor: AppColors.textWhite.withValues(alpha: 0.1),
                          );
                        },
                      ),
                    ),
                  ),
                );
              },
            );
          }
        );
      },
    );
  }

  Widget _buildLabel(String text) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 8.0),
      child: Text(text, style: TextStyle(color: AppColors.textWhite.withValues(alpha: 0.9), fontSize: 14, fontWeight: FontWeight.w500)),
    );
  }

  Widget _buildTextField({
    required TextEditingController controller,
    required String hint,
    String? prefix,
    bool isNumber = false,
    int maxLines = 1,
    String? Function(String?)? validator,
  }) {
    return TextFormField(
      controller: controller,
      keyboardType: isNumber ? const TextInputType.numberWithOptions(decimal: true) : TextInputType.text,
      maxLines: maxLines,
      validator: validator,
      style: const TextStyle(color: AppColors.textWhite),
      decoration: InputDecoration(
        filled: true,
        fillColor: AppColors.surfaceGrey,
        hintText: hint,
        hintStyle: TextStyle(color: AppColors.textWhite.withValues(alpha: 0.3)),
        prefixText: prefix, prefixStyle: const TextStyle(color: AppColors.textWhite, fontWeight: FontWeight.bold),
        border: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.surfaceLightGrey)),
        enabledBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.surfaceLightGrey)),
        focusedBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.primaryBlue, width: 2)),
      ),
    );
  }

  Widget _buildDatePicker(BuildContext context) {
    return GestureDetector(
      onTap: () async {
        final picked = await showDatePicker(
          context: context,
          initialDate: _dueDate,
          firstDate: DateTime.now().subtract(const Duration(days: 365)),
          lastDate: DateTime.now().add(const Duration(days: 365)),
          builder: (context, child) => Theme(
            data: ThemeData.dark().copyWith(
              colorScheme: const ColorScheme.dark(
                primary: AppColors.primaryBlue,
                onPrimary: AppColors.textWhite,
                surface: AppColors.surfaceGrey,
                onSurface: AppColors.textWhite,
              ),
            ),
            child: child!,
          ),
        );
        if (picked != null) setState(() => _dueDate = picked);
      },
      child: Container(
        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 16), // Match input height
        decoration: BoxDecoration(
          color: AppColors.surfaceGrey,
          borderRadius: BorderRadius.circular(8),
          border: Border.all(color: AppColors.surfaceLightGrey),
        ),
        child: Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            Text(DateFormat('MMM dd, yyyy').format(_dueDate), style: const TextStyle(color: AppColors.textWhite)),
            const Icon(Icons.calendar_today_outlined, size: 18, color: AppColors.textWhite54),
          ],
        ),
      ),
    );
  }

  Color _getStatusColor(String status) {
    switch(status.toLowerCase()) {
      case 'paid': return AppColors.successGreen;
      case 'draft': return AppColors.textGrey;
      case 'overdue': return AppColors.errorRed;
      case 'sent': return AppColors.primaryBlueLight;
      default: return AppColors.textGrey;
    }
  }

  /// ‚úÖ NEW: Status dropdown for draft/sent selection
  Widget _buildStatusDropdown() {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 12),
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(8),
        border: Border.all(color: AppColors.surfaceLightGrey),
      ),
      child: DropdownButton<String>(
        value: _invoiceStatus,
        isExpanded: true,
        underline: const SizedBox(),
        dropdownColor: AppColors.surfaceGrey,
        style: const TextStyle(color: AppColors.textWhite),
        items: [
          DropdownMenuItem(
            value: 'draft',
            child: Row(
              children: [
                Container(
                  width: 8,
                  height: 8,
                  decoration: const BoxDecoration(
                    color: AppColors.textGrey,
                    shape: BoxShape.circle,
                  ),
                ),
                const SizedBox(width: 8),
                const Text('Draft', style: TextStyle(color: AppColors.textWhite)),
              ],
            ),
          ),
          DropdownMenuItem(
            value: 'sent',
            child: Row(
              children: [
                Container(
                  width: 8,
                  height: 8,
                  decoration: const BoxDecoration(
                    color: AppColors.primaryBlueLight,
                    shape: BoxShape.circle,
                  ),
                ),
                const SizedBox(width: 8),
                const Text('Sent', style: TextStyle(color: AppColors.textWhite)),
              ],
            ),
          ),
        ],
        onChanged: (value) {
          if (value != null) {
            setState(() => _invoiceStatus = value);
          }
        },
      ),
    );
  }
}
// ==========================================
// FILE: ./pc/widgets/settings/users_permissions_view.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../../core/constants/app_colors.dart';
import '../../../../data/providers/dashboard_provider.dart';
import '../../../../data/providers/users_provider.dart';
import 'add_user_dialog.dart';

class UsersPermissionsView extends ConsumerStatefulWidget {
  const UsersPermissionsView({super.key});

  @override
  ConsumerState<UsersPermissionsView> createState() => _UsersPermissionsViewState();
}

class _UsersPermissionsViewState extends ConsumerState<UsersPermissionsView> {
  // --- Local State for Filters ---
  String _searchQuery = "";
  String _selectedRole = "All Roles";
  String _selectedStatus = "All Status";

  @override
  Widget build(BuildContext context) {
    final usersAsync = ref.watch(schoolUsersProvider);
    final dashboardAsync = ref.watch(dashboardDataProvider);

    return Column(
      children: [
        // 1. FILTER & ACTION BAR
        Row(
          children: [
            // Search Field
            Expanded(
              child: _buildSearchField(),
            ),
            const SizedBox(width: 16),
            
            // Role Dropdown
            _buildDropdown(
              value: _selectedRole,
              items: ["All Roles", "School Admin", "Teacher", "Student"],
              onChanged: (val) => setState(() => _selectedRole = val!),
            ),
            const SizedBox(width: 16),
            
            // Status Dropdown
            _buildDropdown(
              value: _selectedStatus,
              items: ["All Status", "Active", "Banned"],
              onChanged: (val) => setState(() => _selectedStatus = val!),
            ),
            const SizedBox(width: 16),
            
            // Export Button
            OutlinedButton.icon(
              onPressed: () {},
              icon: const Icon(Icons.download, size: 16),
              label: const Text("Export"),
              style: OutlinedButton.styleFrom(
                foregroundColor: AppColors.textWhite,
                side: const BorderSide(color: AppColors.divider),
                padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 18),
              ),
            ),
            const SizedBox(width: 16),
            
            // Add User Button
            ElevatedButton.icon(
              onPressed: () {
                dashboardAsync.whenData((data) {
                  showDialog(
                    context: context,
                    builder: (_) => AddUserDialog(schoolId: data.schoolId),
                  );
                });
              },
              icon: const Icon(Icons.person_add, size: 16),
              label: const Text("Add User"),
              style: ElevatedButton.styleFrom(
                backgroundColor: AppColors.primaryBlue,
                foregroundColor: Colors.white,
                padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 18),
              ),
            ),
          ],
        ),
        const SizedBox(height: 24),

        // 2. USERS TABLE
        Container(
          decoration: BoxDecoration(
            color: AppColors.surfaceGrey,
            borderRadius: BorderRadius.circular(12),
            border: Border.all(color: AppColors.divider),
          ),
          child: Column(
            children: [
              _buildTableHeader(),
              const Divider(height: 1, color: AppColors.divider),
              
              usersAsync.when(
                loading: () => const Padding(
                  padding: EdgeInsets.all(40), 
                  child: CircularProgressIndicator(color: AppColors.primaryBlue),
                ),
                error: (e, _) => Padding(
                  padding: const EdgeInsets.all(40), 
                  child: Text("Error: $e", style: const TextStyle(color: AppColors.errorRed)),
                ),
                data: (allUsers) {
                  // --- FILTER LOGIC ---
                  final filteredUsers = allUsers.where((user) {
                    final name = (user['full_name'] ?? '').toString().toLowerCase();
                    final email = (user['email'] ?? '').toString().toLowerCase();
                    final role = (user['role'] ?? '').toString().toLowerCase();
                    final isBanned = user['status'] == true; // SQL maps is_banned -> status

                    // 1. Search Filter
                    if (_searchQuery.isNotEmpty) {
                      if (!name.contains(_searchQuery.toLowerCase()) && 
                          !email.contains(_searchQuery.toLowerCase())) {
                        return false;
                      }
                    }

                    // 2. Role Filter
                    if (_selectedRole != "All Roles") {
                      // Map UI string to DB value
                      String requiredRole = _selectedRole.toLowerCase().replaceAll(" ", "_");
                      if (role != requiredRole) return false;
                    }

                    // 3. Status Filter
                    if (_selectedStatus != "All Status") {
                      if (_selectedStatus == "Active" && isBanned) return false;
                      if (_selectedStatus == "Banned" && !isBanned) return false;
                    }

                    return true;
                  }).toList();

                  if (filteredUsers.isEmpty) {
                    return const Padding(
                      padding: EdgeInsets.all(40), 
                      child: Text("No users found matching filters.", style: TextStyle(color: AppColors.textWhite54)),
                    );
                  }

                  return ListView.separated(
                    shrinkWrap: true,
                    physics: const NeverScrollableScrollPhysics(),
                    itemCount: filteredUsers.length,
                    separatorBuilder: (_, __) => const Divider(height: 1, color: AppColors.divider),
                    itemBuilder: (ctx, index) => _UserRow(user: filteredUsers[index]),
                  );
                },
              ),
            ],
          ),
        ),
      ],
    );
  }

  // --- WIDGET HELPERS ---

  Widget _buildSearchField() {
    return SizedBox(
      height: 44,
      child: TextField(
        textAlignVertical: TextAlignVertical.center,
        style: const TextStyle(color: AppColors.textWhite),
        onChanged: (val) => setState(() => _searchQuery = val), // Updates State
        decoration: InputDecoration(
          isDense: true,
          filled: true,
          fillColor: AppColors.backgroundBlack,
          hintText: "Search by name, email...",
          hintStyle: const TextStyle(color: AppColors.textWhite38, fontSize: 13),
          prefixIcon: const Icon(Icons.search, color: AppColors.textWhite38, size: 18),
          contentPadding: EdgeInsets.zero,
          border: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.divider)),
          enabledBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.divider)),
          focusedBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.primaryBlue)),
        ),
      ),
    );
  }

  Widget _buildDropdown({
    required String value, 
    required List<String> items, 
    required Function(String?) onChanged
  }) {
    return Container(
      height: 44,
      padding: const EdgeInsets.symmetric(horizontal: 16),
      decoration: BoxDecoration(
        color: AppColors.backgroundBlack,
        borderRadius: BorderRadius.circular(8),
        border: Border.all(color: AppColors.divider),
      ),
      child: DropdownButtonHideUnderline(
        child: DropdownButton<String>(
          value: items.contains(value) ? value : items.first,
          dropdownColor: AppColors.surfaceGrey,
          icon: const Icon(Icons.keyboard_arrow_down, color: AppColors.textWhite54, size: 16),
          style: const TextStyle(color: AppColors.textWhite, fontSize: 13),
          onChanged: onChanged,
          items: items.map((e) => DropdownMenuItem(value: e, child: Text(e))).toList(),
        ),
      ),
    );
  }

  Widget _buildTableHeader() {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 16),
      child: Row(
        children: [
          _col("USER PROFILE", 3),
          _col("ROLE", 2),
          _col("ASSOCIATIONS", 2),
          _col("PERMISSIONS", 2),
          _col("STATUS", 2),
          _col("", 1), // Actions
        ],
      ),
    );
  }

  Widget _col(String text, int flex) {
    return Expanded(
      flex: flex,
      child: Text(
        text,
        style: const TextStyle(color: AppColors.textWhite38, fontSize: 11, fontWeight: FontWeight.bold, letterSpacing: 0.8),
      ),
    );
  }
}

class _UserRow extends ConsumerWidget {
  final Map<String, dynamic> user;
  const _UserRow({required this.user});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final name = user['full_name'] ?? 'Unknown';
    final email = user['email'] ?? '';
    final role = user['role'] ?? 'student';
    final isBanned = user['status'] == true;
    final isActive = !isBanned;

    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 16),
      child: Row(
        children: [
          // 1. Profile
          Expanded(
            flex: 3,
            child: Row(
              children: [
                CircleAvatar(
                  radius: 18,
                  backgroundColor: _getRoleColor(role).withValues(alpha: 0.2),
                  child: Text(name.isNotEmpty ? name.substring(0, 1).toUpperCase() : "?", 
                    style: TextStyle(color: _getRoleColor(role), fontWeight: FontWeight.bold)),
                ),
                const SizedBox(width: 12),
                Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(name, style: const TextStyle(color: AppColors.textWhite, fontWeight: FontWeight.w500, fontSize: 13)),
                    Text(email, style: const TextStyle(color: AppColors.textWhite38, fontSize: 11)),
                  ],
                ),
              ],
            ),
          ),
          
          // 2. Role Badge
          Expanded(
            flex: 2,
            child: Row(
              children: [
                Container(
                  padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                  decoration: BoxDecoration(
                    color: _getRoleColor(role).withValues(alpha: 0.1),
                    borderRadius: BorderRadius.circular(4),
                    border: Border.all(color: _getRoleColor(role).withValues(alpha: 0.3)),
                  ),
                  child: Text(
                    _formatRole(role),
                    style: TextStyle(color: _getRoleColor(role), fontSize: 11, fontWeight: FontWeight.bold),
                  ),
                ),
              ],
            ),
          ),

          // 3. Associations
          const Expanded(
            flex: 2,
            child: Text("Global / 5 Classes", style: TextStyle(color: AppColors.textWhite70, fontSize: 12)),
          ),

          // 4. Permissions
          Expanded(
            flex: 2,
            child: Text(
              role == 'school_admin' ? "Full System Access" : "Limited (Academic)", 
              style: const TextStyle(color: AppColors.textWhite54, fontSize: 12)
            ),
          ),

          // 5. Status Toggle
          Expanded(
            flex: 2,
            child: Row(
              children: [
                Switch(
                  value: isActive,
                  activeThumbColor: AppColors.primaryBlue,
                  activeTrackColor: AppColors.primaryBlue.withValues(alpha: 0.3),
                  inactiveThumbColor: AppColors.surfaceLightGrey,
                  inactiveTrackColor: AppColors.surfaceDarkGrey,
                  onChanged: (val) async {
                    final dashboard = await ref.read(dashboardDataProvider.future);
                    await ref.read(usersRepositoryProvider).toggleStatus(
                      userId: user['id'],
                      schoolId: dashboard.schoolId,
                      ban: !val,
                    );
                    // ignore: unused_result
                    ref.refresh(schoolUsersProvider);
                  },
                ),
                const SizedBox(width: 8),
                Text(
                  isActive ? "Active" : "Banned",
                  style: TextStyle(color: isActive ? AppColors.successGreen : AppColors.errorRed, fontSize: 12, fontWeight: FontWeight.bold),
                ),
              ],
            ),
          ),

          // 6. Actions
          Expanded(
            flex: 1,
            child: Row(
              mainAxisAlignment: MainAxisAlignment.end,
              children: [
                TextButton(
                  onPressed: () {}, 
                  child: const Text("Edit", style: TextStyle(color: AppColors.primaryBlue, fontSize: 12))
                ),
                const Icon(Icons.more_vert, size: 16, color: AppColors.textWhite54),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Color _getRoleColor(String role) {
    switch (role) {
      case 'school_admin': return AppColors.errorRed; 
      case 'teacher': return AppColors.successGreen;
      case 'student': return AppColors.textGrey;
      default: return AppColors.primaryBlue;
    }
  }

  String _formatRole(String role) {
    return role.replaceAll('_', ' ').split(' ').map((str) => str.isNotEmpty ? str[0].toUpperCase() + str.substring(1) : str).join(' ');
  }
}
// ==========================================
// FILE: ./pc/widgets/settings/organization_card.dart
// ==========================================

import 'package:flutter/material.dart';
import '../../../../core/constants/app_colors.dart';

class OrganizationCard extends StatelessWidget {
  const OrganizationCard({super.key});

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.all(24),
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: AppColors.divider),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              const Text("Organization", style: TextStyle(color: AppColors.textWhite, fontSize: 16, fontWeight: FontWeight.bold)),
              Container(
                padding: const EdgeInsets.all(6),
                decoration: BoxDecoration(color: Colors.purple.withValues(alpha: 0.1), borderRadius: BorderRadius.circular(6)),
                child: const Icon(Icons.business, color: Colors.purple, size: 18),
              ),
            ],
          ),
          const SizedBox(height: 4),
          const Text("Public details.", style: TextStyle(color: AppColors.textWhite54, fontSize: 12)),
          
          const SizedBox(height: 24),
          
          _buildInput("School Name", "Springfield International Academy"),
          const SizedBox(height: 16),
          _buildInput("Address", "742 Evergreen Terrace\nSpringfield, IL 62704", maxLines: 3),
          const SizedBox(height: 16),
          _buildInput("Contact Email", "finance@springfield.edu"),
        ],
      ),
    );
  }

  Widget _buildInput(String label, String value, {int maxLines = 1}) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(label, style: const TextStyle(color: AppColors.textWhite70, fontSize: 13)),
        const SizedBox(height: 8),
        TextFormField(
          initialValue: value,
          maxLines: maxLines,
          style: const TextStyle(color: AppColors.textWhite),
          decoration: InputDecoration(
            filled: true,
            fillColor: AppColors.backgroundBlack,
            contentPadding: const EdgeInsets.all(16),
            border: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.divider)),
            enabledBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.divider)),
            focusedBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.primaryBlue)),
          ),
        ),
      ],
    );
  }
}
// ==========================================
// FILE: ./pc/widgets/settings/notifications_settings_view.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../../core/constants/app_colors.dart';

class NotificationsSettingsView extends ConsumerStatefulWidget {
  const NotificationsSettingsView({super.key});

  @override
  ConsumerState<NotificationsSettingsView> createState() => _NotificationsSettingsViewState();
}

class _NotificationsSettingsViewState extends ConsumerState<NotificationsSettingsView> {
  // --- MOCK STATE (Connect to Provider in Logic Phase) ---
  bool _billingInApp = true;
  bool _billingEmail = true;
  String _billingFreq = "Immediate";

  bool _campaignInApp = true;
  bool _campaignEmail = false;

  bool _attendanceInApp = true;
  bool _attendanceEmail = false;

  bool _announceInApp = true;
  bool _announceEmail = true;

  // Global Channels
  bool _channelEmail = true;
  bool _channelPush = true;
  bool _channelSMS = false;

  // DND
  bool _dndEnabled = false;
  final TimeOfDay _dndStart = const TimeOfDay(hour: 22, minute: 0);
  final TimeOfDay _dndEnd = const TimeOfDay(hour: 7, minute: 0);

  @override
  Widget build(BuildContext context) {
    return Row(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        // --- LEFT COLUMN: PREFERENCES ---
        Expanded(
          flex: 3,
          child: Container(
            padding: const EdgeInsets.all(24),
            decoration: BoxDecoration(
              color: AppColors.surfaceGrey,
              borderRadius: BorderRadius.circular(12),
              border: Border.all(color: AppColors.divider),
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: [
                    const Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text("Notification Preferences", style: TextStyle(color: AppColors.textWhite, fontSize: 16, fontWeight: FontWeight.bold)),
                        SizedBox(height: 4),
                        Text("Manage what alerts you receive and how.", style: TextStyle(color: AppColors.textWhite54, fontSize: 13)),
                      ],
                    ),
                    IconButton(
                      onPressed: () {},
                      icon: const Icon(Icons.tune, color: AppColors.primaryBlue),
                      tooltip: "Advanced Filters",
                    )
                  ],
                ),
                const SizedBox(height: 24),
                
                // 1. Billing & Finance
                _NotificationGroupTile(
                  title: "Billing & Finance",
                  subtitle: "Alerts for invoice payments, late fees, and daily totals.",
                  icon: Icons.payments,
                  iconColor: AppColors.successGreen,
                  inAppVal: _billingInApp,
                  emailVal: _billingEmail,
                  onInAppChanged: (v) => setState(() => _billingInApp = v),
                  onEmailChanged: (v) => setState(() => _billingEmail = v),
                  extraContent: _buildDropdownRow("EMAIL FREQUENCY", _billingFreq, ["Immediate", "Daily Digest", "Weekly Summary"]),
                ),
                const Divider(color: AppColors.divider, height: 1),

                // 2. Campaign Updates
                _NotificationGroupTile(
                  title: "Campaign Updates",
                  subtitle: "Status changes for fundraising and marketing campaigns.",
                  icon: Icons.campaign,
                  iconColor: AppColors.accentPurple,
                  inAppVal: _campaignInApp,
                  emailVal: _campaignEmail,
                  onInAppChanged: (v) => setState(() => _campaignInApp = v),
                  onEmailChanged: (v) => setState(() => _campaignEmail = v),
                ),
                const Divider(color: AppColors.divider, height: 1),

                // 3. Attendance Issues
                _NotificationGroupTile(
                  title: "Attendance Issues",
                  subtitle: "Critical absentee alerts and staff attendance logs.",
                  icon: Icons.warning_amber_rounded,
                  iconColor: AppColors.warningOrange,
                  inAppVal: _attendanceInApp,
                  emailVal: _attendanceEmail,
                  onInAppChanged: (v) => setState(() => _attendanceInApp = v),
                  onEmailChanged: (v) => setState(() => _attendanceEmail = v),
                ),
                const Divider(color: AppColors.divider, height: 1),

                // 4. General Announcements
                _NotificationGroupTile(
                  title: "General Announcements",
                  subtitle: "System-wide messages from administration.",
                  icon: Icons.campaign_outlined, // Using outlined to differentiate
                  iconColor: AppColors.primaryBlue,
                  inAppVal: _announceInApp,
                  emailVal: _announceEmail,
                  onInAppChanged: (v) => setState(() => _announceInApp = v),
                  onEmailChanged: (v) => setState(() => _announceEmail = v),
                ),
              ],
            ),
          ),
        ),
        
        const SizedBox(width: 24),

        // --- RIGHT COLUMN: GLOBAL & DND ---
        Expanded(
          flex: 2,
          child: Column(
            children: [
              // 1. Global Delivery Channels
              Container(
                padding: const EdgeInsets.all(24),
                decoration: BoxDecoration(
                  color: AppColors.surfaceGrey,
                  borderRadius: BorderRadius.circular(12),
                  border: Border.all(color: AppColors.divider),
                ),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    const Text("Global Delivery Channels", style: TextStyle(color: AppColors.textWhite, fontSize: 14, fontWeight: FontWeight.bold)),
                    const SizedBox(height: 24),
                    
                    _DeliveryChannelTile(
                      icon: Icons.email, 
                      title: "Email", 
                      subtitle: "Send to primary address", 
                      value: _channelEmail,
                      onChanged: (v) => setState(() => _channelEmail = v)
                    ),
                    const SizedBox(height: 20),
                    _DeliveryChannelTile(
                      icon: Icons.smartphone, 
                      title: "Push Notifications", 
                      subtitle: "Browser & mobile app", 
                      value: _channelPush,
                      onChanged: (v) => setState(() => _channelPush = v)
                    ),
                    const SizedBox(height: 20),
                    _DeliveryChannelTile(
                      icon: Icons.sms, 
                      title: "SMS Alerts", 
                      subtitle: "Premium plan only", 
                      value: _channelSMS,
                      onChanged: (v) => setState(() => _channelSMS = v),
                      isDisabled: true, // Visual cue for disabled
                    ),
                  ],
                ),
              ),
              
              const SizedBox(height: 24),

              // 2. Do Not Disturb
              Container(
                padding: const EdgeInsets.all(24),
                decoration: BoxDecoration(
                  color: AppColors.backgroundBlack,
                  borderRadius: BorderRadius.circular(12),
                  border: Border.all(color: AppColors.divider),
                ),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    const Row(
                      mainAxisAlignment: MainAxisAlignment.spaceBetween,
                      children: [
                        Text("Do Not Disturb", style: TextStyle(color: AppColors.textWhite, fontSize: 14, fontWeight: FontWeight.bold)),
                        Icon(Icons.dark_mode, color: Colors.amber, size: 18),
                      ],
                    ),
                    const SizedBox(height: 24),
                    
                    Row(
                      mainAxisAlignment: MainAxisAlignment.spaceBetween,
                      children: [
                        const Text("Pause all notifications", style: TextStyle(color: AppColors.textWhite, fontSize: 13)),
                        Switch(
                          value: _dndEnabled, 
                          onChanged: (v) => setState(() => _dndEnabled = v),
                          activeThumbColor: AppColors.primaryBlue,
                          activeTrackColor: AppColors.primaryBlue.withValues(alpha: 0.3),
                          inactiveThumbColor: AppColors.textWhite,
                          inactiveTrackColor: AppColors.surfaceGrey,
                        ),
                      ],
                    ),
                    const SizedBox(height: 16),
                    
                    Row(
                      children: [
                        Expanded(child: _buildTimePicker("From", _dndStart)),
                        const SizedBox(width: 16),
                        Expanded(child: _buildTimePicker("To", _dndEnd)),
                      ],
                    ),
                    const SizedBox(height: 16),
                    const Text(
                      "During this time, notifications will be muted and delivered quietly to your in-app inbox.",
                      style: TextStyle(color: AppColors.textWhite38, fontSize: 11, height: 1.4),
                    ),
                  ],
                ),
              ),

              const SizedBox(height: 24),

              // 3. Action Buttons
              Row(
                children: [
                  Expanded(
                    child: ElevatedButton(
                      onPressed: () {},
                      style: ElevatedButton.styleFrom(
                        backgroundColor: AppColors.primaryBlue,
                        padding: const EdgeInsets.symmetric(vertical: 16),
                        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
                      ),
                      child: const Text("Save Changes", style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold)),
                    ),
                  ),
                  const SizedBox(width: 16),
                  Expanded(
                    child: OutlinedButton(
                      onPressed: () {},
                      style: OutlinedButton.styleFrom(
                        side: const BorderSide(color: AppColors.divider),
                        padding: const EdgeInsets.symmetric(vertical: 16),
                        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
                      ),
                      child: const Text("Reset", style: TextStyle(color: AppColors.textWhite)),
                    ),
                  ),
                ],
              ),
            ],
          ),
        ),
      ],
    );
  }

  // --- HELPERS ---

  Widget _buildDropdownRow(String label, String value, List<String> items) {
    return Row(
      mainAxisAlignment: MainAxisAlignment.spaceBetween,
      children: [
        Text(label, style: const TextStyle(color: AppColors.textWhite38, fontSize: 11, fontWeight: FontWeight.bold, letterSpacing: 0.5)),
        Container(
          height: 32,
          padding: const EdgeInsets.symmetric(horizontal: 12),
          decoration: BoxDecoration(
            color: AppColors.backgroundBlack,
            borderRadius: BorderRadius.circular(6),
            border: Border.all(color: AppColors.divider),
          ),
          child: DropdownButtonHideUnderline(
            child: DropdownButton<String>(
              value: value,
              dropdownColor: AppColors.surfaceGrey,
              icon: const Icon(Icons.keyboard_arrow_down, size: 16, color: AppColors.textWhite54),
              style: const TextStyle(color: AppColors.textWhite, fontSize: 12),
              items: items.map((e) => DropdownMenuItem(value: e, child: Text(e))).toList(),
              onChanged: (v) => setState(() => _billingFreq = v!),
            ),
          ),
        ),
      ],
    );
  }

  Widget _buildTimePicker(String label, TimeOfDay time) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(label, style: const TextStyle(color: AppColors.textWhite54, fontSize: 11)),
        const SizedBox(height: 6),
        Container(
          padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 10),
          decoration: BoxDecoration(
            color: AppColors.backgroundBlack,
            borderRadius: BorderRadius.circular(6),
            border: Border.all(color: AppColors.divider),
          ),
          child: Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Text(time.format(context), style: const TextStyle(color: AppColors.textWhite, fontSize: 13)),
              const Icon(Icons.access_time, size: 14, color: AppColors.textWhite38),
            ],
          ),
        ),
      ],
    );
  }
}

// --- PRIVATE WIDGETS FOR FRAGMENTATION ---

class _NotificationGroupTile extends StatelessWidget {
  final String title;
  final String subtitle;
  final IconData icon;
  final Color iconColor;
  final bool inAppVal;
  final bool emailVal;
  final Function(bool) onInAppChanged;
  final Function(bool) onEmailChanged;
  final Widget? extraContent;

  const _NotificationGroupTile({
    required this.title,
    required this.subtitle,
    required this.icon,
    required this.iconColor,
    required this.inAppVal,
    required this.emailVal,
    required this.onInAppChanged,
    required this.onEmailChanged,
    this.extraContent,
  });

  @override
  Widget build(BuildContext context) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 24),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Container(
            padding: const EdgeInsets.all(10),
            decoration: BoxDecoration(
              color: iconColor.withValues(alpha: 0.1),
              borderRadius: BorderRadius.circular(8),
            ),
            child: Icon(icon, color: iconColor, size: 20),
          ),
          const SizedBox(width: 16),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(title, style: const TextStyle(color: AppColors.textWhite, fontSize: 14, fontWeight: FontWeight.bold)),
                const SizedBox(height: 4),
                Text(subtitle, style: const TextStyle(color: AppColors.textWhite54, fontSize: 12)),
                const SizedBox(height: 16),
                
                // Toggles Row
                _buildToggleRow("In-App Notifications", inAppVal, onInAppChanged),
                const SizedBox(height: 12),
                _buildToggleRow("Email Alerts", emailVal, onEmailChanged),
                
                if (extraContent != null) ...[
                  const SizedBox(height: 16),
                  const Divider(color: AppColors.divider),
                  const SizedBox(height: 16),
                  extraContent!,
                ],
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildToggleRow(String label, bool val, Function(bool) onChange) {
    return Row(
      mainAxisAlignment: MainAxisAlignment.spaceBetween,
      children: [
        Text(label, style: const TextStyle(color: AppColors.textWhite70, fontSize: 13)),
        SizedBox(
          height: 24,
          child: Switch(
            value: val,
            onChanged: onChange,
            activeThumbColor: Colors.white,
            activeTrackColor: AppColors.primaryBlue,
            inactiveThumbColor: AppColors.textWhite,
            inactiveTrackColor: AppColors.backgroundBlack,
          ),
        ),
      ],
    );
  }
}

class _DeliveryChannelTile extends StatelessWidget {
  final IconData icon;
  final String title;
  final String subtitle;
  final bool value;
  final Function(bool) onChanged;
  final bool isDisabled;

  const _DeliveryChannelTile({
    required this.icon,
    required this.title,
    required this.subtitle,
    required this.value,
    required this.onChanged,
    this.isDisabled = false,
  });

  @override
  Widget build(BuildContext context) {
    return Row(
      children: [
        Icon(icon, size: 20, color: isDisabled ? AppColors.textWhite38 : AppColors.textWhite54),
        const SizedBox(width: 12),
        Expanded(
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text(title, style: TextStyle(color: isDisabled ? AppColors.textWhite38 : AppColors.textWhite, fontSize: 13, fontWeight: FontWeight.w500)),
              Text(subtitle, style: const TextStyle(color: AppColors.textWhite38, fontSize: 11)),
            ],
          ),
        ),
        Switch(
          value: value,
          onChanged: isDisabled ? null : onChanged,
          activeThumbColor: Colors.white,
          activeTrackColor: AppColors.primaryBlue,
          inactiveThumbColor: AppColors.textWhite38,
          inactiveTrackColor: AppColors.backgroundBlack,
        ),
      ],
    );
  }
}
// ==========================================
// FILE: ./pc/widgets/settings/integrations/security_permissions_card.dart
// ==========================================

import 'package:flutter/material.dart';
import '../../../../../core/constants/app_colors.dart';

class SecurityPermissionsCard extends StatefulWidget {
  const SecurityPermissionsCard({super.key});

  @override
  State<SecurityPermissionsCard> createState() => _SecurityPermissionsCardState();
}

class _SecurityPermissionsCardState extends State<SecurityPermissionsCard> {
  bool _whitelist = false;
  bool _readAttend = false;
  bool _writeAttend = false;
  bool _readCamp = true;
  bool _readFin = false;

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.all(24),
      decoration: BoxDecoration(
        color: AppColors.backgroundBlack, // Darker contrast
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: AppColors.divider),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          const Text("Security & Permissions", style: TextStyle(color: AppColors.textWhite, fontSize: 16, fontWeight: FontWeight.bold)),
          const SizedBox(height: 4),
          const Text("Global settings for external access.", style: TextStyle(color: AppColors.textWhite54, fontSize: 13)),
          
          const SizedBox(height: 24),
          const Divider(color: AppColors.divider),
          const SizedBox(height: 24),

          // IP Whitelist
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              const Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text("Require IP Whitelisting", style: TextStyle(color: AppColors.textWhite, fontWeight: FontWeight.bold, fontSize: 13)),
                  Text("Only allow access tokens to be used from known school IP addresses.", style: TextStyle(color: AppColors.textWhite54, fontSize: 12)),
                ],
              ),
              Switch(
                value: _whitelist, 
                onChanged: (v) => setState(() => _whitelist = v),
                activeThumbColor: AppColors.primaryBlue,
              ),
            ],
          ),

          const SizedBox(height: 32),
          const Text("Default Token Permissions", style: TextStyle(color: AppColors.textWhite, fontSize: 13, fontWeight: FontWeight.bold)),
          const SizedBox(height: 16),

          // Permissions Grid
          Row(
            children: [
              Expanded(child: _permTile("Attendance Read", "Allow viewing student attendance.", _readAttend, (v) => setState(() => _readAttend = v!))),
              const SizedBox(width: 16),
              Expanded(child: _permTile("Attendance Write", "Allow marking attendance.", _writeAttend, (v) => setState(() => _writeAttend = v!))),
            ],
          ),
          const SizedBox(height: 16),
          Row(
            children: [
              Expanded(child: _permTile("Campaign Read", "Allow viewing campaign stats.", _readCamp, (v) => setState(() => _readCamp = v!))),
              const SizedBox(width: 16),
              Expanded(child: _permTile("Financial Read", "Allow viewing basic financial summaries.", _readFin, (v) => setState(() => _readFin = v!))),
            ],
          ),
        ],
      ),
    );
  }

  Widget _permTile(String label, String sub, bool value, Function(bool?) onChanged) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 12),
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(8),
        border: Border.all(color: value ? AppColors.primaryBlue : AppColors.divider),
      ),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          SizedBox(
            width: 20, height: 20,
            child: Checkbox(
              value: value, 
              onChanged: onChanged,
              activeColor: AppColors.primaryBlue,
              side: const BorderSide(color: AppColors.textWhite54),
              shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(4)),
            ),
          ),
          const SizedBox(width: 12),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(label, style: const TextStyle(color: AppColors.textWhite, fontSize: 13, fontWeight: FontWeight.w500)),
                Text(sub, style: const TextStyle(color: AppColors.textWhite54, fontSize: 11)),
              ],
            ),
          ),
        ],
      ),
    );
  }
}
// ==========================================
// FILE: ./pc/widgets/settings/integrations/teacher_tokens_card.dart
// ==========================================

import 'package:flutter/material.dart';
import '../../../../../core/constants/app_colors.dart';

class TeacherTokensCard extends StatelessWidget {
  const TeacherTokensCard({super.key});

  @override
  Widget build(BuildContext context) {
    return Container(
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: AppColors.divider),
      ),
      child: Column(
        children: [
          // Header
          Padding(
            padding: const EdgeInsets.all(24),
            child: Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                const Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text("Teacher Access Tokens", style: TextStyle(color: AppColors.textWhite, fontSize: 16, fontWeight: FontWeight.bold)),
                    SizedBox(height: 4),
                    Text("Manage temporary access for attendance and campaign tools.", style: TextStyle(color: AppColors.textWhite54, fontSize: 13)),
                  ],
                ),
                ElevatedButton.icon(
                  onPressed: () {}, // Open Generator Dialog
                  icon: const Icon(Icons.add, size: 16),
                  label: const Text("Generate Token"),
                  style: ElevatedButton.styleFrom(
                    backgroundColor: AppColors.primaryBlue,
                    foregroundColor: Colors.white,
                    padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 14),
                  ),
                ),
              ],
            ),
          ),
          const Divider(height: 1, color: AppColors.divider),

          // Table Header
          Padding(
            padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 16),
            child: Row(
              children: [
                _col("TOKEN ID / NAME", 4),
                _col("PERMISSION\nTYPE", 3),
                _col("EXPIRES AT", 3),
                _col("STATUS", 2),
              ],
            ),
          ),
          const Divider(height: 1, color: AppColors.divider),

          // Rows
          const _TokenRow(
            name: "Ms. Johnson - Fall",
            id: "tk_live_...4829",
            type: "Attendance",
            typeColor: Color(0xFF4F46E5), // Indigo
            expiry: "Dec 15, 2023",
            status: "Active",
            statusColor: AppColors.successGreen,
            icon: Icons.vpn_key,
          ),
          const Divider(height: 1, color: AppColors.divider),
          
          const _TokenRow(
            name: "Fundraiser Team",
            id: "tk_live_...9921",
            type: "Campaign Mgr",
            typeColor: Color(0xFF9333EA), // Purple
            expiry: "Nov 30, 2023",
            status: "Used (12)",
            statusColor: Colors.amber,
            icon: Icons.campaign,
          ),
          const Divider(height: 1, color: AppColors.divider),

          const _TokenRow(
            name: "Temp Staff",
            id: "tk_test_...1162",
            type: "Read Only",
            typeColor: AppColors.textWhite38,
            expiry: "Oct 01, 2023",
            status: "Expired",
            statusColor: AppColors.errorRed,
            icon: Icons.lock_clock,
          ),

          // Footer
          const Padding(
            padding: EdgeInsets.all(16.0),
            child: Row(
              mainAxisAlignment: MainAxisAlignment.end,
              children: [
                Text("Showing 3 of 15 tokens", style: TextStyle(color: AppColors.textWhite54, fontSize: 12)),
                SizedBox(width: 16),
                // Simple Pagination
                Icon(Icons.chevron_left, color: AppColors.textWhite38),
                SizedBox(width: 8),
                Icon(Icons.chevron_right, color: AppColors.textWhite),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _col(String text, int flex) {
    return Expanded(
      flex: flex,
      child: Text(
        text,
        style: const TextStyle(color: AppColors.textWhite38, fontSize: 10, fontWeight: FontWeight.bold, letterSpacing: 0.8),
      ),
    );
  }
}

class _TokenRow extends StatelessWidget {
  final String name;
  final String id;
  final String type;
  final Color typeColor;
  final String expiry;
  final String status;
  final Color statusColor;
  final IconData icon;

  const _TokenRow({
    required this.name, required this.id, required this.type, required this.typeColor,
    required this.expiry, required this.status, required this.statusColor, required this.icon
  });

  @override
  Widget build(BuildContext context) {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 16),
      child: Row(
        children: [
          // 1. Name & ID
          Expanded(
            flex: 4,
            child: Row(
              children: [
                Container(
                  padding: const EdgeInsets.all(8),
                  decoration: BoxDecoration(color: AppColors.backgroundBlack, borderRadius: BorderRadius.circular(8)),
                  child: Icon(icon, size: 16, color: typeColor),
                ),
                const SizedBox(width: 12),
                Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(name, style: const TextStyle(color: AppColors.textWhite, fontSize: 13, fontWeight: FontWeight.w600)),
                    Text(id, style: const TextStyle(color: AppColors.textWhite38, fontFamily: 'monospace', fontSize: 11)),
                  ],
                ),
              ],
            ),
          ),
          
          // 2. Type Badge
          Expanded(
            flex: 3,
            child: Row(
              children: [
                Container(
                  padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                  decoration: BoxDecoration(
                    color: typeColor.withAlpha(38),
                    borderRadius: BorderRadius.circular(4),
                    border: Border.all(color: typeColor.withAlpha(77)),
                  ),
                  child: Text(type, style: TextStyle(color: typeColor, fontSize: 10, fontWeight: FontWeight.bold)),
                ),
              ],
            ),
          ),

          // 3. Expiry
          Expanded(
            flex: 3,
            child: Text(expiry, style: const TextStyle(color: AppColors.textWhite70, fontSize: 13)),
          ),

          // 4. Status
          Expanded(
            flex: 2,
            child: Row(
              children: [
                Container(width: 6, height: 6, decoration: BoxDecoration(color: statusColor, shape: BoxShape.circle)),
                const SizedBox(width: 8),
                Text(status, style: const TextStyle(color: AppColors.textWhite, fontSize: 13)),
              ],
            ),
          ),
        ],
      ),
    );
  }
}
// ==========================================
// FILE: ./pc/widgets/settings/integrations/api_config_card.dart
// ==========================================

import 'package:flutter/material.dart';
import '../../../../../core/constants/app_colors.dart';

class ApiConfigCard extends StatelessWidget {
  const ApiConfigCard({super.key});

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.all(24),
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: AppColors.divider),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          const Text("API Configuration", style: TextStyle(color: AppColors.textWhite, fontSize: 14, fontWeight: FontWeight.bold)),
          const SizedBox(height: 24),

          const Text("Base URL", style: TextStyle(color: AppColors.textWhite54, fontSize: 12)),
          const SizedBox(height: 8),
          Row(
            children: [
              Container(
                padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 12),
                decoration: const BoxDecoration(
                  color: AppColors.divider,
                  borderRadius: BorderRadius.horizontal(left: Radius.circular(6)),
                ),
                child: const Text("GET", style: TextStyle(color: AppColors.textWhite70, fontSize: 12, fontFamily: 'monospace')),
              ),
              Expanded(
                child: Container(
                  padding: const EdgeInsets.all(12),
                  decoration: const BoxDecoration(
                    color: AppColors.backgroundBlack,
                    borderRadius: BorderRadius.horizontal(right: Radius.circular(6)),
                  ),
                  child: const Text("https://api.schooladmin.io/v1/", style: TextStyle(color: AppColors.textWhite, fontSize: 13, fontFamily: 'monospace')),
                ),
              ),
            ],
          ),

          const SizedBox(height: 16),
          const Text("Webhook Secret", style: TextStyle(color: AppColors.textWhite54, fontSize: 12)),
          const SizedBox(height: 8),
          Container(
            decoration: BoxDecoration(
              color: AppColors.backgroundBlack,
              borderRadius: BorderRadius.circular(6),
              border: Border.all(color: AppColors.divider),
            ),
            child: Row(
              children: [
                const Expanded(
                  child: Padding(
                    padding: EdgeInsets.all(12),
                    child: Text("‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢", style: TextStyle(color: AppColors.textWhite54, letterSpacing: 2)),
                  ),
                ),
                IconButton(
                  onPressed: () {},
                  icon: const Icon(Icons.visibility, size: 16, color: AppColors.textWhite54),
                )
              ],
            ),
          ),

          const SizedBox(height: 24),
          const Text(
            "View API Documentation ‚Üó", 
            style: TextStyle(color: AppColors.primaryBlue, fontSize: 12),
          ),
        ],
      ),
    );
  }
}
// ==========================================
// FILE: ./pc/widgets/settings/integrations/connected_services_card.dart
// ==========================================

import 'package:flutter/material.dart';
import '../../../../../core/constants/app_colors.dart';

class ConnectedServicesCard extends StatelessWidget {
  const ConnectedServicesCard({super.key});

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.all(24),
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: AppColors.divider),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              const Text("Connected Services", style: TextStyle(color: AppColors.textWhite, fontSize: 14, fontWeight: FontWeight.bold)),
              Icon(Icons.extension, color: Colors.orange[800], size: 18),
            ],
          ),
          const SizedBox(height: 24),

          const Text("ACCOUNTING SOFTWARE", style: TextStyle(color: AppColors.textWhite38, fontSize: 10, fontWeight: FontWeight.bold, letterSpacing: 1.0)),
          const SizedBox(height: 16),
          
          const _ServiceRow(
            name: "QuickBooks\nOnline",
            isConnected: true,
            icon: "QB",
            color: Color(0xFF2CA01C), // QB Green
          ),
          const SizedBox(height: 16),
          const _ServiceRow(
            name: "Xero",
            isConnected: false,
            icon: "X",
            color: Color(0xFF13B5EA), // Xero Blue
          ),

          const SizedBox(height: 24),
          const Divider(color: AppColors.divider),
          const SizedBox(height: 24),

          const Text("COMMUNICATION", style: TextStyle(color: AppColors.textWhite38, fontSize: 10, fontWeight: FontWeight.bold, letterSpacing: 1.0)),
          const SizedBox(height: 16),
          const _ServiceRow(
            name: "Mailgun",
            isConnected: true, // Special state "Configure"
            isConfigurable: true,
            desc: "Email delivery service",
            icon: "M",
            color: Color(0xFFFD5D5D), // Mailgun Red/Orange
          ),
        ],
      ),
    );
  }
}

class _ServiceRow extends StatelessWidget {
  final String name;
  final bool isConnected;
  final bool isConfigurable;
  final String icon;
  final Color color;
  final String? desc;

  const _ServiceRow({
    required this.name,
    required this.isConnected,
    this.isConfigurable = false,
    required this.icon,
    required this.color,
    this.desc,
  });

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: AppColors.backgroundBlack,
        borderRadius: BorderRadius.circular(8),
        border: Border.all(color: AppColors.divider),
      ),
      child: Row(
        children: [
          Container(
            width: 40, height: 40,
            alignment: Alignment.center,
            decoration: BoxDecoration(color: color, borderRadius: BorderRadius.circular(8)),
            child: Text(icon, style: const TextStyle(color: Colors.white, fontWeight: FontWeight.bold, fontSize: 16)),
          ),
          const SizedBox(width: 12),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(name, style: const TextStyle(color: AppColors.textWhite, fontSize: 13, fontWeight: FontWeight.bold, height: 1.1)),
                if (isConnected && !isConfigurable) 
                  const Text("‚óè Connected", style: TextStyle(color: AppColors.successGreen, fontSize: 11))
                else if (desc != null)
                  Text(desc!, style: const TextStyle(color: AppColors.textWhite38, fontSize: 11))
                else
                  const Text("Not connected", style: TextStyle(color: AppColors.textWhite38, fontSize: 11)),
              ],
            ),
          ),
          if (isConfigurable)
            TextButton(onPressed: (){}, child: const Text("Configure", style: TextStyle(fontSize: 12)))
          else if (isConnected)
            TextButton(onPressed: (){}, child: const Text("Disconnect", style: TextStyle(color: AppColors.textWhite54, fontSize: 12)))
          else
            TextButton(onPressed: (){}, child: const Text("Connect", style: TextStyle(color: AppColors.primaryBlue, fontSize: 12))),
        ],
      ),
    );
  }
}
// ==========================================
// FILE: ./pc/widgets/settings/billing_config_card.dart
// ==========================================

import 'package:flutter/material.dart';
import '../../../../core/constants/app_colors.dart';

class BillingConfigCard extends StatelessWidget {
  const BillingConfigCard({super.key});

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.all(24),
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: AppColors.divider),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              const Text("Billing Configuration", style: TextStyle(color: AppColors.textWhite, fontSize: 16, fontWeight: FontWeight.bold)),
              Container(
                padding: const EdgeInsets.all(6),
                decoration: BoxDecoration(color: AppColors.primaryBlue.withValues(alpha: 0.1), borderRadius: BorderRadius.circular(6)),
                child: const Icon(Icons.account_balance_wallet, color: AppColors.primaryBlue, size: 18),
              ),
            ],
          ),
          const SizedBox(height: 4),
          const Text("Manage currency, taxes, fees, and invoice defaults.", style: TextStyle(color: AppColors.textWhite54, fontSize: 12)),
          
          const SizedBox(height: 24),
          const Divider(color: AppColors.divider),
          const SizedBox(height: 24),

          // Currency & Tax Row
          Row(
            children: [
              Expanded(child: _buildInput("Base Currency", "USD - US Dollar (\$)", isDropdown: true)),
              const SizedBox(width: 24),
              Expanded(child: _buildInput("Default Tax Rate (%)", "0.0", suffix: "%", helper: "Not currently stored in schema")),
            ],
          ),
          const SizedBox(height: 32),

          // Fees Row (Matches default_fee in schema)
          const Text("Default Fee Settings", style: TextStyle(color: AppColors.textWhite, fontSize: 13, fontWeight: FontWeight.bold)),
          const SizedBox(height: 16),
          Row(
            children: [
              // Mapped to billing_configs.default_fee
              Expanded(child: _buildInput("Annual Tuition Fee", "100.00", prefix: "\$")), 
              const SizedBox(width: 24),
              Expanded(child: _buildInput("One-time Registration Fee", "50.00", prefix: "\$")),
            ],
          ),
          const SizedBox(height: 32),

          // Payment Policy (Matches allow_partial_payments)
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              const Text("Payment & Late Fee Policy", style: TextStyle(color: AppColors.textWhite, fontSize: 13, fontWeight: FontWeight.bold)),
              Row(
                children: [
                  const Text("Allow Partial Payments", style: TextStyle(color: AppColors.textWhite54, fontSize: 12)),
                  const SizedBox(width: 8),
                  Switch(
                    value: true, 
                    onChanged: (v) {},
                    activeThumbColor: AppColors.primaryBlue,
                  ),
                ],
              ),
            ],
          ),
          const SizedBox(height: 16),
          
          // Late Fee Details (Matches late_fee_percentage)
          Row(
            children: [
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    _buildInput("Late Fee Percentage", "0.0", suffix: "%"),
                    const SizedBox(height: 4),
                    const Text("Applied monthly to outstanding balance.", style: TextStyle(color: AppColors.textWhite38, fontSize: 10)),
                  ],
                ),
              ),
              const SizedBox(width: 24),
              Expanded(child: _buildInput("Grace Period (Days)", "7")),
            ],
          ),
          const SizedBox(height: 32),

          // Footer Note (Matches invoice_footer_note)
          _buildInput(
            "Invoice Footer Note", 
            "Please include the invoice number in your wire transfer...",
            maxLines: 4,
            helper: "This text will appear at the bottom of every invoice generated."
          ),
        ],
      ),
    );
  }

  Widget _buildInput(String label, String value, {bool isDropdown = false, String? suffix, String? prefix, int maxLines = 1, String? helper}) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(label, style: const TextStyle(color: AppColors.textWhite70, fontSize: 13)),
        const SizedBox(height: 8),
        TextFormField(
          initialValue: value,
          maxLines: maxLines,
          style: const TextStyle(color: AppColors.textWhite),
          decoration: InputDecoration(
            filled: true,
            fillColor: AppColors.backgroundBlack,
            contentPadding: const EdgeInsets.all(16),
            suffixText: suffix,
            prefixText: prefix,
            suffixStyle: const TextStyle(color: AppColors.textWhite54),
            prefixStyle: const TextStyle(color: AppColors.textWhite54),
            suffixIcon: isDropdown ? const Icon(Icons.keyboard_arrow_down, color: AppColors.textWhite54) : null,
            border: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.divider)),
            enabledBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.divider)),
            focusedBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.primaryBlue)),
          ),
        ),
        if (helper != null) ...[
          const SizedBox(height: 4),
          Text(helper, style: const TextStyle(color: AppColors.textWhite38, fontSize: 10)),
        ]
      ],
    );
  }
}
// ==========================================
// FILE: ./pc/widgets/settings/year_configuration_card.dart
// ==========================================

import 'package:flutter/material.dart';
import '../../../../core/constants/app_colors.dart';

class YearConfigurationCard extends StatelessWidget {
  final String yearId;
  const YearConfigurationCard({super.key, required this.yearId});

  @override
  Widget build(BuildContext context) {
    return Container(
      decoration: BoxDecoration(
        color: AppColors.backgroundBlack, // Darker background to pop
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: AppColors.primaryBlue, width: 1.5), // Active Blue Border
      ),
      child: Column(
        children: [
          // 1. Config Header
          Padding(
            padding: const EdgeInsets.all(24),
            child: Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text("Configure: $yearId", style: const TextStyle(color: AppColors.textWhite, fontSize: 16, fontWeight: FontWeight.bold)),
                    const SizedBox(height: 4),
                    const Text("Editing details, terms, and billing settings.", style: TextStyle(color: AppColors.textWhite54, fontSize: 13)),
                  ],
                ),
                Container(
                  padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
                  decoration: BoxDecoration(
                    color: AppColors.primaryBlue,
                    borderRadius: BorderRadius.circular(16),
                  ),
                  child: const Text("Draft", style: TextStyle(color: Colors.white, fontSize: 11, fontWeight: FontWeight.bold)),
                ),
              ],
            ),
          ),
          const Divider(height: 1, color: AppColors.divider),

          // 2. Form Body
          Padding(
            padding: const EdgeInsets.all(32),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                // Row 1: Label & Dates
                Row(
                  children: [
                    Expanded(child: _buildInput("Label", "2024 - 2025")),
                    const SizedBox(width: 24),
                    Expanded(child: _buildInput("Start Date", "09/01/2024", icon: Icons.calendar_today)),
                    const SizedBox(width: 24),
                    Expanded(child: _buildInput("End Date", "06/30/2025", icon: Icons.calendar_today)),
                  ],
                ),
                const SizedBox(height: 24),
                
                // Row 2: Description
                _buildInput("Description", "Standard academic year curriculum.", helper: "Brief description for administrative reference."),
                
                const SizedBox(height: 40),
                const Divider(color: AppColors.divider),
                const SizedBox(height: 32),

                // 3. Terms Management Section
                Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: [
                    const Row(
                      children: [
                        Icon(Icons.date_range, color: AppColors.textWhite70, size: 20),
                        SizedBox(width: 12),
                        Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text("Terms Management", style: TextStyle(color: AppColors.textWhite, fontSize: 14, fontWeight: FontWeight.bold)),
                            Text("Define academic terms (Semesters/Trimesters) for this year.", style: TextStyle(color: AppColors.textWhite54, fontSize: 12)),
                          ],
                        ),
                      ],
                    ),
                    OutlinedButton.icon(
                      onPressed: () {},
                      icon: const Icon(Icons.add, size: 14),
                      label: const Text("Add Term"),
                      style: OutlinedButton.styleFrom(
                        foregroundColor: AppColors.textWhite,
                        side: const BorderSide(color: AppColors.divider),
                      ),
                    ),
                  ],
                ),
                const SizedBox(height: 24),

                // Term 1
                _buildTermRow("Term Name", "Term 1", "09/01/2024", "12/20/2024"),
                const SizedBox(height: 16),
                
                // Term 2 (Empty for effect)
                _buildTermRow("Term Name", "Term 2", "", ""),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildInput(String label, String value, {IconData? icon, String? helper}) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(label, style: const TextStyle(color: AppColors.textWhite70, fontSize: 13)),
        const SizedBox(height: 8),
        TextFormField(
          initialValue: value,
          style: const TextStyle(color: AppColors.textWhite),
          decoration: InputDecoration(
            filled: true,
            fillColor: AppColors.surfaceGrey,
            contentPadding: const EdgeInsets.all(16),
            suffixIcon: icon != null ? Icon(icon, color: AppColors.textWhite54, size: 18) : null,
            border: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.divider)),
            enabledBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.divider)),
            focusedBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.primaryBlue)),
          ),
        ),
        if (helper != null) ...[
          const SizedBox(height: 6),
          Text(helper, style: const TextStyle(color: AppColors.textWhite38, fontSize: 11)),
        ]
      ],
    );
  }

  Widget _buildTermRow(String label, String val1, String val2, String val3) {
    return Container(
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey.withValues(alpha: 0.5),
        borderRadius: BorderRadius.circular(8),
        border: Border.all(color: AppColors.divider),
      ),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.end,
        children: [
          Expanded(flex: 4, child: _buildSubInput("Term Name", val1)),
          const SizedBox(width: 16),
          Expanded(flex: 3, child: _buildSubInput("Start Date", val2, icon: Icons.calendar_today)),
          const SizedBox(width: 16),
          Expanded(flex: 3, child: _buildSubInput("End Date", val3, icon: Icons.calendar_today)),
          const SizedBox(width: 16),
          Padding(
            padding: const EdgeInsets.only(bottom: 8),
            child: IconButton(
              onPressed: () {},
              icon: const Icon(Icons.delete_outline, color: AppColors.textWhite54),
              tooltip: "Remove Term",
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildSubInput(String label, String value, {IconData? icon}) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(label, style: const TextStyle(color: AppColors.textWhite38, fontSize: 11)),
        const SizedBox(height: 6),
        SizedBox(
          height: 40,
          child: TextFormField(
            initialValue: value,
            style: const TextStyle(color: AppColors.textWhite, fontSize: 13),
            decoration: InputDecoration(
              isDense: true,
              filled: true,
              fillColor: AppColors.backgroundBlack,
              contentPadding: const EdgeInsets.symmetric(horizontal: 12, vertical: 12),
              suffixIcon: icon != null ? Icon(icon, color: AppColors.textWhite38, size: 16) : null,
              border: OutlineInputBorder(borderRadius: BorderRadius.circular(6), borderSide: const BorderSide(color: AppColors.divider)),
              enabledBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(6), borderSide: const BorderSide(color: AppColors.divider)),
              focusedBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(6), borderSide: const BorderSide(color: AppColors.textWhite38)),
            ),
          ),
        ),
      ],
    );
  }
}
// ==========================================
// FILE: ./pc/widgets/settings/general_financial_view.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../../core/constants/app_colors.dart';
import 'billing_config_card.dart';
import 'organization_card.dart';

class GeneralFinancialView extends ConsumerWidget {
  const GeneralFinancialView({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    // We would typically watch a settingsProvider here to load initial data
    
    return Column(
      children: [
        // WARNING BANNER (Policy Requirement)
        Container(
          margin: const EdgeInsets.only(bottom: 24),
          padding: const EdgeInsets.all(12),
          decoration: BoxDecoration(
            color: AppColors.warningOrange.withValues(alpha: 0.1),
            borderRadius: BorderRadius.circular(8),
            border: Border.all(color: AppColors.warningOrange.withValues(alpha: 0.3)),
          ),
          child: const Row(
            children: [
              Icon(Icons.warning_amber_rounded, color: AppColors.warningOrange, size: 20),
              SizedBox(width: 12),
              Expanded(
                child: Text(
                  "Changes to Financial Settings are applied immediately to the server. There is no Undo functionality. Ensure you have authorization.",
                  style: TextStyle(color: AppColors.warningOrange, fontSize: 13),
                ),
              ),
            ],
          ),
        ),

        Row(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // LEFT: Billing Configuration
            const Expanded(
              flex: 3,
              child: BillingConfigCard(),
            ),
            const SizedBox(width: 24),
            
            // RIGHT: Organization & Integrations
            Expanded(
              flex: 2,
              child: Column(
                children: [
                  const OrganizationCard(),
                  const SizedBox(height: 24),
                  _buildSchoolLogoCard(),
                  const SizedBox(height: 24),
                  _buildIntegrationsCard(),
                ],
              ),
            ),
          ],
        ),
        
        // FOOTER TERMS (Policy Requirement)
        const Padding(
          padding: EdgeInsets.only(top: 32, bottom: 16),
          child: Text(
            "By saving, you agree to the Greyway.Co Data Integrity Policy. Fees Up is not responsible for data loss due to misconfiguration.",
            style: TextStyle(color: AppColors.textWhite38, fontSize: 11),
            textAlign: TextAlign.center,
          ),
        ),
      ],
    );
  }

  Widget _buildSchoolLogoCard() {
    return Container(
      padding: const EdgeInsets.all(24),
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: AppColors.divider),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          const Text("School Logo", style: TextStyle(color: AppColors.textWhite, fontWeight: FontWeight.bold)),
          const SizedBox(height: 24),
          Center(
            child: Column(
              children: [
                Container(
                  width: 100, height: 100,
                  decoration: BoxDecoration(
                    color: AppColors.backgroundBlack,
                    shape: BoxShape.circle,
                    border: Border.all(color: AppColors.textWhite54, style: BorderStyle.solid),
                  ),
                  child: const Icon(Icons.camera_alt, color: AppColors.textWhite54),
                ),
                const SizedBox(height: 12),
                const Text("Upload new logo", style: TextStyle(color: AppColors.primaryBlue, fontSize: 13, fontWeight: FontWeight.bold)),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildIntegrationsCard() {
    return Container(
      padding: const EdgeInsets.all(24),
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: AppColors.divider),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              const Text("Integrations", style: TextStyle(color: AppColors.textWhite, fontWeight: FontWeight.bold)),
              Icon(Icons.extension, color: Colors.orange[700], size: 20),
            ],
          ),
          const SizedBox(height: 16),
          const Text("TEACHER ACCESS TOKEN", style: TextStyle(color: AppColors.textWhite38, fontSize: 11, fontWeight: FontWeight.bold)),
          const SizedBox(height: 8),
          Row(
            children: [
              Expanded(
                child: Container(
                  height: 40,
                  padding: const EdgeInsets.symmetric(horizontal: 12),
                  decoration: BoxDecoration(
                    color: AppColors.backgroundBlack,
                    borderRadius: BorderRadius.circular(8),
                    border: Border.all(color: AppColors.divider),
                  ),
                  alignment: Alignment.centerLeft,
                  child: const Text("sk_live_8372...9283", style: TextStyle(color: AppColors.textWhite54, fontFamily: 'monospace')),
                ),
              ),
              const SizedBox(width: 8),
              Container(
                width: 40, height: 40,
                decoration: BoxDecoration(
                  color: AppColors.surfaceLightGrey,
                  borderRadius: BorderRadius.circular(8),
                ),
                child: const Icon(Icons.copy, size: 16, color: AppColors.textWhite70),
              ),
            ],
          ),
        ],
      ),
    );
  }
}
// ==========================================
// FILE: ./pc/widgets/settings/integrations_settings_view.dart
// ==========================================

import 'package:flutter/material.dart';
import 'integrations/teacher_tokens_card.dart';
import 'integrations/security_permissions_card.dart';
import 'integrations/connected_services_card.dart';
import 'integrations/api_config_card.dart';

class IntegrationsSettingsView extends StatelessWidget {
  const IntegrationsSettingsView({super.key});

  @override
  Widget build(BuildContext context) {
    return const Row(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        // --- LEFT COLUMN (Tokens & Security) ---
        Expanded(
          flex: 3,
          child: Column(
            children: [
              TeacherTokensCard(),
              SizedBox(height: 24),
              SecurityPermissionsCard(),
            ],
          ),
        ),
        
        SizedBox(width: 24),

        // --- RIGHT COLUMN (Services & API) ---
        Expanded(
          flex: 2,
          child: Column(
            children: [
              ConnectedServicesCard(),
              SizedBox(height: 24),
              ApiConfigCard(),
            ],
          ),
        ),
      ],
    );
  }
}
// ==========================================
// FILE: ./pc/widgets/settings/settings_header.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../../core/constants/app_colors.dart';
import '../../../../data/providers/dashboard_provider.dart';
import '../../../../data/services/database_service.dart';

// Search Data Model
class _SearchOption {
  final String label;
  final int tabIndex;
  const _SearchOption(this.label, this.tabIndex);
}

class SettingsHeader extends ConsumerWidget {
  final Function(int) onSearchNavigation;

  const SettingsHeader({super.key, required this.onSearchNavigation});

  // --- Search Registry ---
  static const List<_SearchOption> _searchOptions = [
    _SearchOption("General Settings", 0),
    _SearchOption("School Profile", 0),
    _SearchOption("Currency & Finance", 0),
    _SearchOption("Academic Years", 1),
    _SearchOption("Terms & Semesters", 1),
    _SearchOption("Users", 2),
    _SearchOption("Permissions & Roles", 2),
    _SearchOption("Teachers & Admins", 2),
    _SearchOption("Notifications", 3),
    _SearchOption("Email Alerts", 3),
    _SearchOption("Integrations", 4),
    _SearchOption("API Tokens", 4),
    _SearchOption("QuickBooks / Xero", 4),
  ];

  String _getInitials(String name) {
    if (name.isEmpty) return "U";
    final parts = name.trim().split(' ');
    if (parts.length > 1) {
      return "${parts[0][0]}${parts[1][0]}".toUpperCase();
    }
    return name[0].toUpperCase();
  }

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final dashboardAsync = ref.watch(dashboardDataProvider);
    final bool isConnected = DatabaseService().db.currentStatus.connected;

    return Container(
      height: 70,
      padding: const EdgeInsets.symmetric(horizontal: 24),
      color: AppColors.backgroundBlack,
      child: Row(
        children: [
          // --- Page Title ---
          Container(
            padding: const EdgeInsets.all(8),
            decoration: BoxDecoration(
              color: AppColors.primaryBlue.withAlpha(26),
              borderRadius: BorderRadius.circular(8),
            ),
            child: const Icon(Icons.settings, color: AppColors.primaryBlue, size: 20),
          ),
          const SizedBox(width: 12),
          const Text(
            "Settings",
            style: TextStyle(
              color: AppColors.textWhite,
              fontSize: 20,
              fontWeight: FontWeight.bold,
              letterSpacing: 0.5,
            ),
          ),
          
          const Spacer(),

          // --- Autocomplete Search Bar ---
          SizedBox(
            width: 300,
            child: Autocomplete<_SearchOption>(
              optionsBuilder: (TextEditingValue textEditingValue) {
                if (textEditingValue.text == '') {
                  return const Iterable<_SearchOption>.empty();
                }
                return _searchOptions.where((option) {
                  return option.label
                      .toLowerCase()
                      .contains(textEditingValue.text.toLowerCase());
                });
              },
              displayStringForOption: (_SearchOption option) => option.label,
              onSelected: (_SearchOption selection) {
                onSearchNavigation(selection.tabIndex);
              },
              
              // Custom Input Field Styling
              fieldViewBuilder: (context, controller, focusNode, onFieldSubmitted) {
                return SizedBox(
                  height: 40,
                  child: TextField(
                    controller: controller,
                    focusNode: focusNode,
                    textAlignVertical: TextAlignVertical.center,
                    style: const TextStyle(color: AppColors.textWhite, fontSize: 13),
                    decoration: InputDecoration(
                      isDense: true,
                      filled: true,
                      fillColor: AppColors.surfaceGrey,
                      hintText: "Search settings...",
                      hintStyle: const TextStyle(color: AppColors.textWhite38),
                      prefixIcon: const Icon(Icons.search, size: 18, color: AppColors.textWhite54),
                      contentPadding: EdgeInsets.zero,
                      enabledBorder: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(8),
                        borderSide: const BorderSide(color: AppColors.divider),
                      ),
                      focusedBorder: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(8),
                        borderSide: const BorderSide(color: AppColors.primaryBlue),
                      ),
                      border: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(8),
                        borderSide: const BorderSide(color: AppColors.divider),
                      ),
                    ),
                  ),
                );
              },

              // Custom Dropdown Styling for Dark Mode
              optionsViewBuilder: (context, onSelected, options) {
                return Align(
                  alignment: Alignment.topLeft,
                  child: Material(
                    color: Colors.transparent,
                    child: Container(
                      width: 300,
                      margin: const EdgeInsets.only(top: 10),
                      decoration: BoxDecoration(
                        color: AppColors.surfaceGrey,
                        borderRadius: BorderRadius.circular(8),
                        border: Border.all(color: AppColors.divider),
                        boxShadow: [
                          BoxShadow(
                            color: Colors.black.withAlpha(51),
                            blurRadius: 10,
                            offset: const Offset(0, 4),
                          )
                        ],
                      ),
                      child: ListView.builder(
                        padding: EdgeInsets.zero,
                        shrinkWrap: true,
                        itemCount: options.length,
                        itemBuilder: (BuildContext context, int index) {
                          final option = options.elementAt(index);
                          return InkWell(
                            onTap: () => onSelected(option),
                            child: Padding(
                              padding: const EdgeInsets.symmetric(vertical: 12, horizontal: 16),
                              child: Text(
                                option.label,
                                style: const TextStyle(color: AppColors.textWhite, fontSize: 13),
                              ),
                            ),
                          );
                        },
                      ),
                    ),
                  ),
                );
              },
            ),
          ),
          
          const SizedBox(width: 24),

          // --- Actions ---
          IconButton(
            onPressed: () {},
            icon: const Icon(Icons.notifications_none, color: AppColors.textWhite70),
            tooltip: "Notifications",
          ),
          IconButton(
            onPressed: () {},
            icon: const Icon(Icons.help_outline, color: AppColors.textWhite70),
            tooltip: "Help & Support",
          ),
          const SizedBox(width: 16),

          // --- Profile with Connectivity Logic ---
          dashboardAsync.when(
            loading: () => _buildProfileLoading(),
            error: (err, _) => _buildProfileError(isConnected),
            data: (data) {
              final initials = _getInitials(data.userName);
              String subtitle = "Administrator";
              Color subtitleColor = AppColors.textWhite38;

              if (data.schoolName == 'Loading...') {
                subtitle = isConnected ? "Syncing..." : "Offline Mode";
                subtitleColor = isConnected ? AppColors.primaryBlueLight : AppColors.errorRed;
              } else if (!isConnected) {
                subtitle = "Offline Mode";
                subtitleColor = AppColors.errorRed;
              }

              return Row(
                children: [
                  Column(
                    mainAxisAlignment: MainAxisAlignment.center,
                    crossAxisAlignment: CrossAxisAlignment.end,
                    children: [
                      Text(
                        data.userName.isEmpty ? "User" : data.userName, 
                        style: const TextStyle(color: AppColors.textWhite, fontWeight: FontWeight.bold, fontSize: 13)
                      ),
                      Text(
                        subtitle, 
                        style: TextStyle(color: subtitleColor, fontSize: 11)
                      ),
                    ],
                  ),
                  const SizedBox(width: 12),
                  CircleAvatar(
                    backgroundColor: AppColors.primaryBlue.withAlpha(51),
                    child: Text(
                      initials, 
                      style: const TextStyle(color: AppColors.primaryBlue, fontWeight: FontWeight.bold, fontSize: 12)
                    ),
                  ),
                ],
              );
            },
          ),
        ],
      ),
    );
  }

  // --- Loading/Error States ---
  Widget _buildProfileLoading() {
    return Row(
      children: [
        Column(
          mainAxisAlignment: MainAxisAlignment.center,
          crossAxisAlignment: CrossAxisAlignment.end,
          children: [
            Container(width: 80, height: 12, color: AppColors.surfaceGrey),
            const SizedBox(height: 4),
            Container(width: 50, height: 10, color: AppColors.surfaceGrey),
          ],
        ),
        const SizedBox(width: 12),
        const CircleAvatar(
          backgroundColor: AppColors.surfaceGrey,
          radius: 20,
        ),
      ],
    );
  }

  Widget _buildProfileError(bool isConnected) {
    return Row(
      children: [
        Text(
          isConnected ? "Sync Error" : "Offline", 
          style: TextStyle(color: isConnected ? AppColors.errorRed : AppColors.warningOrange, fontSize: 12)
        ),
        const SizedBox(width: 12),
        CircleAvatar(
          backgroundColor: AppColors.surfaceGrey,
          child: Icon(
            isConnected ? Icons.error_outline : Icons.wifi_off, 
            size: 16, 
            color: isConnected ? AppColors.errorRed : AppColors.warningOrange
          ),
        ),
      ],
    );
  }
}
// ==========================================
// FILE: ./pc/widgets/settings/add_user_dialog.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../../core/constants/app_colors.dart';
import '../../../../data/providers/users_provider.dart';

class AddUserDialog extends ConsumerStatefulWidget {
  final String schoolId;
  const AddUserDialog({super.key, required this.schoolId});

  @override
  ConsumerState<AddUserDialog> createState() => _AddUserDialogState();
}

class _AddUserDialogState extends ConsumerState<AddUserDialog> {
  final _emailController = TextEditingController();
  String _selectedRole = 'teacher';
  bool _isLoading = false;
  String? _error;

  Future<void> _submit() async {
    setState(() { _isLoading = true; _error = null; });
    try {
      await ref.read(usersRepositoryProvider).addUserByEmail(
        email: _emailController.text.trim(),
        schoolId: widget.schoolId,
        role: _selectedRole,
      );
      
      // Refresh list and close
      // ignore: unused_result
      ref.refresh(schoolUsersProvider);
      if (mounted) Navigator.of(context).pop();
      
    } catch (e) {
      setState(() => _error = e.toString());
    } finally {
      if (mounted) setState(() => _isLoading = false);
    }
  }

  @override
  Widget build(BuildContext context) {
    return Dialog(
      backgroundColor: AppColors.surfaceGrey,
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
      child: Container(
        width: 500,
        padding: const EdgeInsets.all(24),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            const Text("Add New User", style: TextStyle(color: AppColors.textWhite, fontSize: 20, fontWeight: FontWeight.bold)),
            const SizedBox(height: 8),
            const Text("Link an existing account to your school by email.", style: TextStyle(color: AppColors.textWhite54)),
            const SizedBox(height: 24),

            // Email Input
            const Text("User Email", style: TextStyle(color: AppColors.textWhite70, fontSize: 13)),
            const SizedBox(height: 8),
            TextField(
              controller: _emailController,
              style: const TextStyle(color: AppColors.textWhite),
              decoration: InputDecoration(
                filled: true,
                fillColor: AppColors.backgroundBlack,
                hintText: "e.g. sarah.jones@school.edu",
                hintStyle: const TextStyle(color: AppColors.textWhite38),
                border: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.divider)),
              ),
            ),
            const SizedBox(height: 24),

            // Role Selection
            const Text("Assign Role", style: TextStyle(color: AppColors.textWhite70, fontSize: 13)),
            const SizedBox(height: 8),
            Container(
              padding: const EdgeInsets.symmetric(horizontal: 12),
              decoration: BoxDecoration(
                color: AppColors.backgroundBlack,
                borderRadius: BorderRadius.circular(8),
                border: Border.all(color: AppColors.divider),
              ),
              child: DropdownButtonHideUnderline(
                child: DropdownButton<String>(
                  value: _selectedRole,
                  isExpanded: true,
                  dropdownColor: AppColors.surfaceGrey,
                  style: const TextStyle(color: AppColors.textWhite),
                  items: const [
                    DropdownMenuItem(value: 'teacher', child: Text("Teacher")),
                    DropdownMenuItem(value: 'school_admin', child: Text("School Admin")),
                    DropdownMenuItem(value: 'student', child: Text("Student")),
                  ],
                  onChanged: (v) => setState(() => _selectedRole = v!),
                ),
              ),
            ),

            if (_error != null) ...[
              const SizedBox(height: 16),
              Container(
                padding: const EdgeInsets.all(12),
                decoration: BoxDecoration(color: AppColors.errorRed.withAlpha(26), borderRadius: BorderRadius.circular(8)),
                child: Row(children: [
                  const Icon(Icons.error, color: AppColors.errorRed, size: 20),
                  const SizedBox(width: 8),
                  Expanded(child: Text(_error!, style: const TextStyle(color: AppColors.errorRed, fontSize: 12))),
                ]),
              )
            ],

            const SizedBox(height: 32),
            Row(
              mainAxisAlignment: MainAxisAlignment.end,
              children: [
                TextButton(
                  onPressed: () => Navigator.pop(context),
                  child: const Text("Cancel", style: TextStyle(color: AppColors.textWhite54)),
                ),
                const SizedBox(width: 16),
                ElevatedButton(
                  onPressed: _isLoading ? null : _submit,
                  style: ElevatedButton.styleFrom(backgroundColor: AppColors.primaryBlue),
                  child: Text(_isLoading ? "Linking..." : "Add User"),
                ),
              ],
            ),
          ],
        ),
      ),
    );
  }
}
// ==========================================
// FILE: ./pc/widgets/settings/school_year_registry_card.dart
// ==========================================

import 'package:flutter/material.dart';
import '../../../../core/constants/app_colors.dart';

class SchoolYearRegistryCard extends StatelessWidget {
  final Function(String) onEdit;
  final String? activeEditingId;

  const SchoolYearRegistryCard({
    super.key,
    required this.onEdit,
    this.activeEditingId,
  });

  @override
  Widget build(BuildContext context) {
    return Container(
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: AppColors.divider),
      ),
      child: Column(
        children: [
          // Header
          Padding(
            padding: const EdgeInsets.all(24),
            child: Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                const Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text("School Year Registry", style: TextStyle(color: AppColors.textWhite, fontSize: 18, fontWeight: FontWeight.bold)),
                    SizedBox(height: 4),
                    Text("Define academic years, active periods, and archives.", style: TextStyle(color: AppColors.textWhite54, fontSize: 13)),
                  ],
                ),
                ElevatedButton.icon(
                  onPressed: () {},
                  icon: const Icon(Icons.add, size: 16),
                  label: const Text("Add New Year"),
                  style: ElevatedButton.styleFrom(
                    backgroundColor: AppColors.primaryBlue,
                    foregroundColor: Colors.white,
                    padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 16),
                  ),
                ),
              ],
            ),
          ),
          const Divider(height: 1, color: AppColors.divider),

          // Column Headers
          Padding(
            padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 16),
            child: Row(
              children: [
                _headerCol("ACADEMIC YEAR", 3),
                _headerCol("DESCRIPTION", 4),
                _headerCol("DATE RANGE", 3),
                _headerCol("STATUS", 2),
                const Spacer(), // Actions space
              ],
            ),
          ),
          const Divider(height: 1, color: AppColors.divider),

          // Rows (Mock Data)
          _buildRow(
            id: "2023-2024",
            label: "2023 - 2024",
            desc: "Standard Curriculum",
            dates: "Sep 2023 - Jun 2024",
            status: "Active",
            statusColor: AppColors.successGreen,
          ),
          const Divider(height: 1, color: AppColors.divider),
          
          _buildRow(
            id: "2024-2025",
            label: "2024 - 2025",
            desc: "Standard Academic Year",
            dates: "Sep 2024 - Jun 2025",
            status: "Draft",
            statusColor: AppColors.textWhite54,
            isEditable: true, // Shows the pencil icon next to name
          ),
        ],
      ),
    );
  }

  Widget _headerCol(String text, int flex) {
    return Expanded(
      flex: flex,
      child: Text(
        text,
        style: const TextStyle(color: AppColors.textWhite38, fontSize: 11, fontWeight: FontWeight.bold, letterSpacing: 0.8),
      ),
    );
  }

  Widget _buildRow({
    required String id,
    required String label,
    required String desc,
    required String dates,
    required String status,
    required Color statusColor,
    bool isEditable = false,
  }) {
    final bool isEditing = activeEditingId == id;

    return Container(
      color: isEditing ? AppColors.primaryBlue.withValues(alpha: 0.05) : null,
      padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 18),
      child: Row(
        children: [
          // Year
          Expanded(
            flex: 3,
            child: Row(
              children: [
                Text(label, style: const TextStyle(color: AppColors.textWhite, fontWeight: FontWeight.w600, fontSize: 13)),
                if (isEditable) ...[
                  const SizedBox(width: 8),
                  const Icon(Icons.edit, size: 12, color: AppColors.primaryBlue),
                ]
              ],
            ),
          ),
          // Description
          Expanded(flex: 4, child: Text(desc, style: const TextStyle(color: AppColors.textWhite54, fontSize: 13))),
          // Dates
          Expanded(flex: 3, child: Text(dates, style: const TextStyle(color: AppColors.textWhite54, fontSize: 13))),
          // Status
          Expanded(
            flex: 2,
            child: Row(
              children: [
                Container(
                  padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                  decoration: BoxDecoration(
                    color: statusColor.withValues(alpha: 0.1),
                    borderRadius: BorderRadius.circular(4),
                  ),
                  child: Text(status, style: TextStyle(color: statusColor, fontSize: 11, fontWeight: FontWeight.bold)),
                ),
              ],
            ),
          ),
          // Action Button
          TextButton(
            onPressed: () => onEdit(id),
            child: Text(
              isEditing ? "Editing" : "Edit",
              style: TextStyle(
                color: isEditing ? AppColors.primaryBlue : AppColors.textWhite54,
                fontWeight: isEditing ? FontWeight.bold : FontWeight.normal
              ),
            ),
          ),
        ],
      ),
    );
  }
}
// ==========================================
// FILE: ./pc/widgets/settings/school_year_settings_view.dart
// ==========================================

import 'package:flutter/material.dart';
// ignore: unused_import
import '../../../../core/constants/app_colors.dart';
import 'school_year_registry_card.dart';
import 'year_configuration_card.dart';

class SchoolYearSettingsView extends StatefulWidget {
  const SchoolYearSettingsView({super.key});

  @override
  State<SchoolYearSettingsView> createState() => _SchoolYearSettingsViewState();
}

class _SchoolYearSettingsViewState extends State<SchoolYearSettingsView> {
  // State to track which year is currently being edited
  String? _editingYearId = "2024-2025"; 

  @override
  Widget build(BuildContext context) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        // 1. Registry Table (Top Card)
        SchoolYearRegistryCard(
          onEdit: (yearId) {
            setState(() => _editingYearId = yearId);
          },
          activeEditingId: _editingYearId,
        ),
        
        const SizedBox(height: 32),

        // 2. Active Configuration (Bottom Card)
        // Only shows if a year is selected for editing
        if (_editingYearId != null)
          YearConfigurationCard(yearId: _editingYearId!),
      ],
    );
  }
}
// ==========================================
// FILE: ./pc/widgets/sidebar.dart
// ==========================================

import 'package:fees_up/pc/widgets/logout_dialog.dart';
import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import '../../core/constants/app_colors.dart';

class DashboardSidebar extends StatefulWidget {
  const DashboardSidebar({super.key});

  @override
  State<DashboardSidebar> createState() => _DashboardSidebarState();
}

class _DashboardSidebarState extends State<DashboardSidebar> {
  
  /// Calculates the active index to highlight the correct item
  /// Returns a unique ID or index for logic if needed.
  String _getCurrentRoute(BuildContext context) {
    return GoRouterState.of(context).uri.toString();
  }

  bool _isActive(String currentRoute, String itemRoute) {
    if (itemRoute == '/' && currentRoute != '/') return false;
    return currentRoute.startsWith(itemRoute);
  }

  // GROUP 1: OPERATIONAL (Day-to-day Management)
  final List<Map<String, dynamic>> _operationalItems = [
    {'icon': Icons.grid_view_rounded, 'label': 'Overview', 'route': '/'},
    {'icon': Icons.receipt_long_rounded, 'label': 'Transactions', 'route': '/transactions'},
    {'icon': Icons.description_outlined, 'label': 'Invoices', 'route': '/invoices'},
    {'icon': Icons.school_outlined, 'label': 'Students', 'route': '/students'},
    {'icon': Icons.bar_chart_rounded, 'label': 'Reports', 'route': '/reports'},
  ];

  // GROUP 2: MESSAGING (Communication Hub)
  final List<Map<String, dynamic>> _messagingItems = [
    {'icon': Icons.campaign_outlined, 'label': 'Broadcasts', 'route': '/announcements'}, // System-wide
    {'icon': Icons.notifications_none_rounded, 'label': 'Notifications', 'route': '/notifications'}, // Personal
  ];

  @override
  Widget build(BuildContext context) {
    final currentRoute = _getCurrentRoute(context);

    return Container(
      width: 260,
      color: const Color(0xFF0F1115),
      child: Column(
        children: [
          // 1. BRAND HEADER
          Padding(
            padding: const EdgeInsets.all(24.0),
            child: Row(
              children: [
                Container(
                  padding: const EdgeInsets.all(8),
                  decoration: BoxDecoration(
                    color: AppColors.surfaceGrey,
                    borderRadius: BorderRadius.circular(8),
                    border: Border.all(color: Colors.white12),
                  ),
                  child: const Icon(Icons.shield_outlined, color: AppColors.primaryBlue, size: 20),
                ),
                const SizedBox(width: 12),
                Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    const Text(
                      "School Admin",
                      style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold, fontSize: 14),
                    ),
                    Text(
                      "Financial Portal",
                      style: TextStyle(color: Colors.white.withValues(alpha: 0.5), fontSize: 12),
                    ),
                  ],
                )
              ],
            ),
          ),

          // 2. SCROLLABLE MENU AREA
          Expanded(
            child: ListView(
              padding: const EdgeInsets.symmetric(horizontal: 16),
              children: [
                // --- SECTION: OPERATIONS ---
                ..._operationalItems.map((item) => _SidebarItem(
                  icon: item['icon'],
                  label: item['label'],
                  isSelected: _isActive(currentRoute, item['route']),
                  onTap: () => context.go(item['route']),
                )),

                const SizedBox(height: 24),
                
                // --- SECTION: MESSAGING ---
                _sectionLabel("MESSAGING"),
                ..._messagingItems.map((item) => _SidebarItem(
                  icon: item['icon'],
                  label: item['label'],
                  isSelected: _isActive(currentRoute, item['route']),
                  onTap: () => context.go(item['route']),
                )),
              ],
            ),
          ),

          // 3. BOTTOM PREFERENCES
          const Divider(color: Colors.white10, indent: 20, endIndent: 20),
          Padding(
            padding: const EdgeInsets.all(16.0),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                _sectionLabel("PREFERENCES"),
                
                _SidebarItem(
                  icon: Icons.person_outline_rounded,
                  label: "Profile",
                  isSelected: _isActive(currentRoute, '/profile'),
                  onTap: () => context.go('/profile'),
                ),
                const SizedBox(height: 4),

                _SidebarItem(
                  icon: Icons.settings_outlined,
                  label: "Settings",
                  isSelected: _isActive(currentRoute, '/settings'),
                  onTap: () => context.go('/settings'),
                ),
                const SizedBox(height: 4),

                _SidebarItem(
                  icon: Icons.logout_rounded,
                  label: "Log Out",
                  isSelected: false,
                  isDestructive: true,
                  onTap: () {
                    showDialog(
                      context: context,
                      barrierColor: Colors.black.withValues(alpha: 0.7),
                      builder: (context) => const LogoutDialog(),
                    );
                  },
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _sectionLabel(String text) {
    return Padding(
      padding: const EdgeInsets.only(left: 12, bottom: 8, top: 4),
      child: Text(
        text,
        style: TextStyle(
          color: Colors.white.withValues(alpha: 0.4),
          fontSize: 11,
          fontWeight: FontWeight.bold,
          letterSpacing: 1.2,
        ),
      ),
    );
  }
}

class _SidebarItem extends StatefulWidget {
  final IconData icon;
  final String label;
  final bool isSelected;
  final bool isDestructive;
  final VoidCallback onTap;

  const _SidebarItem({
    required this.icon,
    required this.label,
    required this.isSelected,
    this.isDestructive = false,
    required this.onTap,
  });

  @override
  State<_SidebarItem> createState() => _SidebarItemState();
}

class _SidebarItemState extends State<_SidebarItem> {
  bool _isHovered = false;

  @override
  Widget build(BuildContext context) {
    final Color bgColor = widget.isSelected
        ? AppColors.primaryBlue
        : (_isHovered ? Colors.white.withValues(alpha: 0.05) : Colors.transparent);

    final Color textColor = widget.isDestructive
        ? AppColors.errorRed
        : (widget.isSelected ? Colors.white : Colors.white70);

    final Color iconColor = widget.isDestructive
        ? AppColors.errorRed
        : (widget.isSelected ? Colors.white : Colors.white54);

    return MouseRegion(
      onEnter: (_) => setState(() => _isHovered = true),
      onExit: (_) => setState(() => _isHovered = false),
      cursor: SystemMouseCursors.click,
      child: GestureDetector(
        onTap: widget.onTap,
        child: AnimatedContainer(
          duration: const Duration(milliseconds: 200),
          curve: Curves.easeInOut,
          margin: const EdgeInsets.only(bottom: 8),
          padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
          decoration: BoxDecoration(
            color: bgColor,
            borderRadius: BorderRadius.circular(12),
          ),
          child: Row(
            children: [
              Icon(widget.icon, size: 20, color: iconColor),
              const SizedBox(width: 12),
              Text(
                widget.label,
                style: TextStyle(
                  color: textColor,
                  fontWeight: widget.isSelected ? FontWeight.bold : FontWeight.w500,
                  fontSize: 14,
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}
// ==========================================
// FILE: ./pc/widgets/transactions/transactions_table.dart
// ==========================================

import 'package:flutter/material.dart';
import '../../../../core/constants/app_colors.dart';

class TransactionsTable extends StatefulWidget {
  const TransactionsTable({super.key});

  @override
  State<TransactionsTable> createState() => _TransactionsTableState();
}

class _TransactionsTableState extends State<TransactionsTable> {
  int _selectedFilterIndex = 0;
  final List<String> _filters = ["All Transactions", "Income", "Expenses", "Pending"];

  @override
  Widget build(BuildContext context) {
    return Container(
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(12), // Matching Invoices Table Radius
        border: Border.all(color: AppColors.divider),
      ),
      child: Column(
        children: [
          // 1. TOOLBAR (Standardized to match Invoices Table)
          Padding(
            padding: const EdgeInsets.all(16), // Standard padding
            child: Row(
              children: [
                // Filter Tabs (Pills)
                ...List.generate(_filters.length, (index) {
                  return _buildFilterTab(
                    label: _filters[index],
                    isSelected: _selectedFilterIndex == index,
                    onTap: () => setState(() => _selectedFilterIndex = index),
                  );
                }),
                
                const Spacer(),

                // Date Filter (Standardized)
                Container(
                  height: 36, // Standard height for secondary actions
                  padding: const EdgeInsets.symmetric(horizontal: 12),
                  decoration: BoxDecoration(
                    color: AppColors.backgroundBlack, // Contrast background for dropdowns
                    borderRadius: BorderRadius.circular(8),
                    border: Border.all(color: AppColors.divider),
                  ),
                  child: const Row(
                    children: [
                      Text("This Month", style: TextStyle(color: AppColors.textWhite, fontSize: 13)),
                      SizedBox(width: 8),
                      Icon(Icons.keyboard_arrow_down, color: AppColors.textWhite54, size: 16),
                    ],
                  ),
                ),
                const SizedBox(width: 12),

                // More Actions Icon
                IconButton(
                  onPressed: () {},
                  icon: const Icon(Icons.filter_list, color: AppColors.textWhite70, size: 20),
                  tooltip: "Filter List",
                ),
              ],
            ),
          ),
          const Divider(height: 1, color: AppColors.divider),

          // 2. COLUMN HEADERS
          Padding(
            padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 16),
            child: Row(
              children: [
                _headerText("REFERENCE ID", flex: 2),
                _headerText("DATE", flex: 2),
                _headerText("ENTITY / STUDENT", flex: 3),
                _headerText("CATEGORY", flex: 3),
                _headerText("METHOD", flex: 2),
                _headerText("AMOUNT", flex: 2, alignRight: true),
              ],
            ),
          ),
          const Divider(height: 1, color: AppColors.divider),

          // 3. ROWS (Mock Data Loop)
          ListView.builder(
            shrinkWrap: true,
            physics: const NeverScrollableScrollPhysics(),
            itemCount: 7, 
            itemBuilder: (context, index) {
              return _TransactionRow(index: index);
            },
          ),

          // 4. FOOTER (Pagination)
          Padding(
            padding: const EdgeInsets.all(16.0),
            child: Row(
              mainAxisAlignment: MainAxisAlignment.end,
              children: [
                const Text("Showing 1 to 7 of 128 results", style: TextStyle(color: AppColors.textWhite54, fontSize: 13)),
                const SizedBox(width: 24),
                _paginationBtn(icon: Icons.chevron_left),
                const SizedBox(width: 8),
                _paginationBtn(label: "1", isActive: true),
                const SizedBox(width: 8),
                _paginationBtn(label: "2"),
                const SizedBox(width: 8),
                _paginationBtn(label: "..."),
                const SizedBox(width: 8),
                _paginationBtn(icon: Icons.chevron_right),
              ],
            ),
          ),
        ],
      ),
    );
  }

  // --- HELPERS ---

  Widget _buildFilterTab({required String label, required bool isSelected, required VoidCallback onTap}) {
    return GestureDetector(
      onTap: onTap,
      child: Container(
        margin: const EdgeInsets.only(right: 8),
        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
        decoration: BoxDecoration(
          color: isSelected ? AppColors.primaryBlue : Colors.transparent,
          borderRadius: BorderRadius.circular(6),
          // Add border for unselected state to define clickable area clearly
          border: isSelected ? null : Border.all(color: Colors.transparent), 
        ),
        child: Text(
          label,
          style: TextStyle(
            color: isSelected ? Colors.white : AppColors.textWhite70,
            fontWeight: isSelected ? FontWeight.bold : FontWeight.normal,
            fontSize: 13,
          ),
        ),
      ),
    );
  }

  Widget _headerText(String text, {int flex = 1, bool alignRight = false}) {
    return Expanded(
      flex: flex,
      child: Text(
        text,
        textAlign: alignRight ? TextAlign.right : TextAlign.left,
        style: const TextStyle(
          color: AppColors.textWhite38,
          fontSize: 11,
          fontWeight: FontWeight.bold,
          letterSpacing: 0.8, // Slightly increased spacing for legibility
        ),
      ),
    );
  }

  Widget _paginationBtn({String? label, IconData? icon, bool isActive = false}) {
    return Container(
      width: 32,
      height: 32,
      alignment: Alignment.center,
      decoration: BoxDecoration(
        color: isActive ? AppColors.primaryBlue : Colors.transparent,
        borderRadius: BorderRadius.circular(4),
        border: Border.all(color: isActive ? AppColors.primaryBlue : AppColors.divider),
      ),
      child: icon != null 
        ? Icon(icon, size: 16, color: AppColors.textWhite70)
        : Text(label!, style: TextStyle(color: isActive ? Colors.white : AppColors.textWhite70, fontSize: 12)),
    );
  }
}

// --- PRIVATE ROW WIDGET ---

class _TransactionRow extends StatelessWidget {
  final int index;
  const _TransactionRow({required this.index});

  @override
  Widget build(BuildContext context) {
    // Mock Data Logic for Visuals
    final isExpense = index == 1 || index == 4 || index == 5;
    final amount = isExpense ? "-\$450.00" : "+\$1,200.00";
    final amountColor = isExpense ? AppColors.textWhite : AppColors.successGreen;
    
    return Container(
      decoration: const BoxDecoration(
        border: Border(bottom: BorderSide(color: AppColors.divider)),
      ),
      child: Material(
        color: Colors.transparent,
        child: InkWell(
          hoverColor: AppColors.textWhite.withValues(alpha: 0.03),
          onTap: () {},
          child: Padding(
            padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 16),
            child: Row(
              children: [
                // 1. REF ID
                Expanded(
                  flex: 2,
                  child: Text(
                    "#TRX-0092$index",
                    style: const TextStyle(color: AppColors.textWhite, fontWeight: FontWeight.bold, fontFamily: 'monospace'),
                  ),
                ),
                // 2. DATE
                Expanded(
                  flex: 2,
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      const Text("Oct 24, 2023", style: TextStyle(color: AppColors.textWhite, fontSize: 13)),
                      Text("10:45 AM", style: TextStyle(color: AppColors.textWhite.withValues(alpha: 0.4), fontSize: 11)),
                    ],
                  ),
                ),
                // 3. ENTITY / STUDENT
                Expanded(
                  flex: 3,
                  child: Row(
                    children: [
                      CircleAvatar(
                        radius: 14,
                        backgroundColor: index.isEven 
                            ? AppColors.primaryBlue.withValues(alpha: 0.2) 
                            : AppColors.warningOrange.withValues(alpha: 0.2),
                        child: Text(
                          index.isEven ? "AM" : "OS",
                          style: TextStyle(
                            fontSize: 10, 
                            color: index.isEven ? AppColors.primaryBlue : AppColors.warningOrange,
                            fontWeight: FontWeight.bold
                          ),
                        ),
                      ),
                      const SizedBox(width: 12),
                      Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text(index.isEven ? "Alex Morgan" : "Office Supplies Inc.", 
                              style: const TextStyle(color: AppColors.textWhite, fontSize: 13, fontWeight: FontWeight.w500)),
                          Text(index.isEven ? "Grade 5" : "Vendor", 
                              style: TextStyle(color: AppColors.textWhite.withValues(alpha: 0.4), fontSize: 11)),
                        ],
                      ),
                    ],
                  ),
                ),
                // 4. CATEGORY
                const Expanded(
                  flex: 3,
                  child: Text("Tuition Fee - Term 2", style: TextStyle(color: AppColors.textWhite70, fontSize: 13)),
                ),
                // 5. METHOD
                Expanded(
                  flex: 2,
                  child: Row(
                    children: [
                      const Icon(Icons.credit_card, size: 16, color: AppColors.textWhite54),
                      const SizedBox(width: 8),
                      Text(index.isEven ? "Credit Card" : "Bank Transfer", 
                          style: const TextStyle(color: AppColors.textWhite70, fontSize: 13)),
                    ],
                  ),
                ),
                // 6. AMOUNT
                Expanded(
                  flex: 2,
                  child: Text(
                    amount,
                    textAlign: TextAlign.right,
                    style: TextStyle(
                      color: amountColor,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }
}
// ==========================================
// FILE: ./pc/widgets/transactions/payment_allocation_dialog.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:supabase_flutter/supabase_flutter.dart';

import '../../../../core/constants/app_colors.dart';
import '../../../../data/services/transaction_service.dart';

/// üîí SECURE Payment Allocation Dialog
/// Allows users to allocate a payment across one or more bills
/// Supports partial payments and multi-bill allocation
class PaymentAllocationDialog extends ConsumerStatefulWidget {
  final String paymentId;
  final double paymentAmount;
  final List<Map<String, dynamic>> outstandingBills;
  final String studentId;
  final String schoolId;
  final VoidCallback onAllocationComplete;

  const PaymentAllocationDialog({
    super.key,
    required this.paymentId,
    required this.paymentAmount,
    required this.outstandingBills,
    required this.studentId,
    required this.schoolId,
    required this.onAllocationComplete,
  });

  @override
  ConsumerState<PaymentAllocationDialog> createState() =>
      _PaymentAllocationDialogState();
}

class _PaymentAllocationDialogState
    extends ConsumerState<PaymentAllocationDialog> {
  late final TransactionService _transactionService;
  final Map<String, double> _allocations = {}; // billId -> allocatedAmount
  double _remainingAmount = 0.0;
  bool _isLoading = false;

  @override
  void initState() {
    super.initState();
    _transactionService = TransactionService(supabase: Supabase.instance.client);
    _remainingAmount = widget.paymentAmount;

    // Initialize allocations with zero for each bill
    for (final bill in widget.outstandingBills) {
      _allocations[bill['id'] as String] = 0.0;
    }
  }

  /// Update allocation for a bill
  void _updateAllocation(String billId, double amount) {
    setState(() {
      _allocations[billId] = amount.clamp(0.0, widget.paymentAmount);

      // Recalculate remaining
      _remainingAmount = widget.paymentAmount -
          _allocations.values.fold(0.0, (sum, val) => sum + val);
    });
  }

  /// Auto-allocate: Fill bills in order until payment is exhausted
  void _autoAllocate() {
    setState(() {
      double remaining = widget.paymentAmount;
      _allocations.clear();

      for (final bill in widget.outstandingBills) {
        final billId = bill['id'] as String;
        final outstanding = bill['outstanding_balance'] as double? ?? 0.0;

        if (remaining <= 0) {
          _allocations[billId] = 0.0;
        } else if (remaining >= outstanding) {
          _allocations[billId] = outstanding;
          remaining -= outstanding;
        } else {
          _allocations[billId] = remaining;
          remaining = 0.0;
        }
      }

      _remainingAmount = remaining;
    });
  }

  /// Split equally across all bills
  void _splitEqually() {
    final perBill = widget.paymentAmount / widget.outstandingBills.length;
    setState(() {
      for (final bill in widget.outstandingBills) {
        _allocations[bill['id'] as String] = perBill;
      }
      _remainingAmount = 0.0;
    });
  }

  /// Submit allocations
  Future<void> _submitAllocations() async {
    // Validate: at least one allocation
    final hasAllocations =
        _allocations.values.any((amount) => amount > 0);
    if (!hasAllocations) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text('Allocate payment to at least one bill'),
          backgroundColor: AppColors.errorRed,
        ),
      );
      return;
    }

    setState(() => _isLoading = true);

    try {
      // Get non-zero allocations
      final allocationsToProcess = _allocations.entries
          .where((e) => e.value > 0)
          .map((e) => MapEntry(e.key, e.value))
          .toList();

      // Allocate payment to bills
      await _transactionService.allocatePaymentToMultipleBills(
        paymentId: widget.paymentId,
        billAllocations: allocationsToProcess,
      );

      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
            content: Text('Payment allocated successfully'),
            backgroundColor: AppColors.successGreen,
          ),
        );

        widget.onAllocationComplete();
        Navigator.of(context).pop();
      }
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Error: $e'),
            backgroundColor: AppColors.errorRed,
          ),
        );
      }
    } finally {
      if (mounted) setState(() => _isLoading = false);
    }
  }

  @override
  Widget build(BuildContext context) {
    return Dialog(
      backgroundColor: Colors.transparent,
      insetPadding: const EdgeInsets.all(24),
      child: Container(
        width: 900,
        constraints: const BoxConstraints(maxHeight: 700),
        decoration: BoxDecoration(
          color: AppColors.backgroundBlack,
          borderRadius: BorderRadius.circular(16),
          border: Border.all(color: AppColors.surfaceLightGrey),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withValues(alpha: 0.5),
              blurRadius: 20,
              offset: const Offset(0, 10),
            )
          ],
        ),
        child: Column(
          children: [
            // HEADER
            Padding(
              padding: const EdgeInsets.symmetric(horizontal: 32, vertical: 24),
              child: Row(
                children: [
                  Container(
                    padding: const EdgeInsets.all(8),
                    decoration: BoxDecoration(
                      color: AppColors.primaryBlue.withValues(alpha: 0.2),
                      borderRadius: BorderRadius.circular(8),
                    ),
                    child: const Icon(Icons.attach_money,
                        color: AppColors.primaryBlue),
                  ),
                  const SizedBox(width: 16),
                  Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      const Text("Allocate Payment",
                          style: TextStyle(
                              color: AppColors.textWhite,
                              fontSize: 18,
                              fontWeight: FontWeight.bold)),
                      Text(
                          'Payment: \$${widget.paymentAmount.toStringAsFixed(2)}',
                          style: const TextStyle(
                              color: AppColors.textGrey, fontSize: 13)),
                    ],
                  ),
                  const Spacer(),
                  IconButton(
                    onPressed: () => Navigator.pop(context),
                    icon: const Icon(Icons.close, color: AppColors.textGrey),
                  ),
                ],
              ),
            ),
            const Divider(height: 1, color: AppColors.divider),

            // CONTENT
            Expanded(
              child: SingleChildScrollView(
                padding: const EdgeInsets.all(32),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    // Quick Actions
                    Row(
                      children: [
                        ElevatedButton.icon(
                          onPressed: _autoAllocate,
                          style: ElevatedButton.styleFrom(
                            backgroundColor:
                                AppColors.primaryBlue.withValues(alpha: 0.2),
                            foregroundColor: AppColors.primaryBlue,
                            shape: RoundedRectangleBorder(
                              borderRadius: BorderRadius.circular(8),
                            ),
                          ),
                          icon: const Icon(Icons.auto_awesome, size: 18),
                          label: const Text('Auto-Allocate'),
                        ),
                        const SizedBox(width: 12),
                        ElevatedButton.icon(
                          onPressed: _splitEqually,
                          style: ElevatedButton.styleFrom(
                            backgroundColor:
                                AppColors.primaryBlue.withValues(alpha: 0.2),
                            foregroundColor: AppColors.primaryBlue,
                            shape: RoundedRectangleBorder(
                              borderRadius: BorderRadius.circular(8),
                            ),
                          ),
                          icon: const Icon(Icons.rule_folder, size: 18),
                          label: const Text('Split Equally'),
                        ),
                      ],
                    ),
                    const SizedBox(height: 24),

                    // Bills List
                    Text('Outstanding Bills',
                        style: TextStyle(
                          color: AppColors.textWhite.withValues(alpha: 0.9),
                          fontSize: 14,
                          fontWeight: FontWeight.w500,
                        )),
                    const SizedBox(height: 16),

                    if (widget.outstandingBills.isEmpty)
                      Container(
                        padding: const EdgeInsets.all(24),
                        decoration: BoxDecoration(
                          color: AppColors.surfaceGrey,
                          borderRadius: BorderRadius.circular(8),
                        ),
                        child: const Center(
                          child: Text('No outstanding bills',
                              style: TextStyle(color: AppColors.textGrey)),
                        ),
                      )
                    else
                      ListView.separated(
                        shrinkWrap: true,
                        physics: const NeverScrollableScrollPhysics(),
                        itemCount: widget.outstandingBills.length,
                        separatorBuilder: (_, __) => const SizedBox(height: 12),
                        itemBuilder: (context, index) {
                          final bill = widget.outstandingBills[index];
                          final billId = bill['id'] as String;
                          final title = bill['title'] as String? ?? 'Unknown Bill';
                          final outstanding =
                              bill['outstanding_balance'] as double? ?? 0.0;
                          final allocated = _allocations[billId] ?? 0.0;

                          return _buildBillAllocationRow(
                            billId: billId,
                            title: title,
                            outstandingAmount: outstanding,
                            allocatedAmount: allocated,
                            onAllocationChanged: _updateAllocation,
                          );
                        },
                      ),

                    const SizedBox(height: 24),

                    // Summary
                    Container(
                      padding: const EdgeInsets.all(16),
                      decoration: BoxDecoration(
                        color: AppColors.surfaceDarkGrey,
                        borderRadius: BorderRadius.circular(8),
                        border: Border.all(color: AppColors.surfaceLightGrey),
                      ),
                      child: Row(
                        mainAxisAlignment: MainAxisAlignment.spaceBetween,
                        children: [
                          Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              Text('Total Allocated',
                                  style: TextStyle(
                                    color: AppColors.textWhite
                                        .withValues(alpha: 0.7),
                                    fontSize: 12,
                                  )),
                              Text(
                                '\$${(widget.paymentAmount - _remainingAmount).toStringAsFixed(2)}',
                                style: const TextStyle(
                                  color: AppColors.textWhite,
                                  fontSize: 20,
                                  fontWeight: FontWeight.bold,
                                ),
                              ),
                            ],
                          ),
                          Container(
                            width: 1,
                            height: 40,
                            color: AppColors.surfaceLightGrey,
                          ),
                          Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              Text('Remaining',
                                  style: TextStyle(
                                    color: AppColors.textWhite
                                        .withValues(alpha: 0.7),
                                    fontSize: 12,
                                  )),
                              Text(
                                '\$${_remainingAmount.toStringAsFixed(2)}',
                                style: TextStyle(
                                  color: _remainingAmount > 0.01
                                      ? AppColors.warningOrange
                                      : AppColors.successGreen,
                                  fontSize: 20,
                                  fontWeight: FontWeight.bold,
                                ),
                              ),
                            ],
                          ),
                        ],
                      ),
                    ),
                  ],
                ),
              ),
            ),

            const Divider(height: 1, color: AppColors.divider),

            // FOOTER
            Padding(
              padding: const EdgeInsets.all(24),
              child: Row(
                mainAxisAlignment: MainAxisAlignment.end,
                children: [
                  TextButton(
                    onPressed: () => Navigator.pop(context),
                    child: const Text('Cancel',
                        style: TextStyle(color: AppColors.textWhite70)),
                  ),
                  const SizedBox(width: 16),
                  ElevatedButton.icon(
                    onPressed: _isLoading ? null : _submitAllocations,
                    style: ElevatedButton.styleFrom(
                      backgroundColor: AppColors.primaryBlue,
                      padding: const EdgeInsets.symmetric(
                          horizontal: 24, vertical: 16),
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(8),
                      ),
                      foregroundColor: AppColors.textWhite,
                    ),
                    icon: _isLoading
                        ? const SizedBox(
                            width: 16,
                            height: 16,
                            child: CircularProgressIndicator(
                              strokeWidth: 2,
                              color: AppColors.textWhite,
                            ),
                          )
                        : const Icon(Icons.check, size: 18),
                    label: Text(
                      _isLoading ? 'Allocating...' : 'Confirm Allocation',
                      style: const TextStyle(fontWeight: FontWeight.bold),
                    ),
                  ),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildBillAllocationRow({
    required String billId,
    required String title,
    required double outstandingAmount,
    required double allocatedAmount,
    required Function(String, double) onAllocationChanged,
  }) {
    final controller = TextEditingController(
      text: allocatedAmount > 0 ? allocatedAmount.toStringAsFixed(2) : '',
    );

    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(8),
        border: Border.all(color: AppColors.surfaceLightGrey),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(title,
                      style: const TextStyle(
                          color: AppColors.textWhite,
                          fontWeight: FontWeight.w500)),
                  const SizedBox(height: 4),
                  Text(
                      'Outstanding: \$${outstandingAmount.toStringAsFixed(2)}',
                      style: const TextStyle(
                          color: AppColors.textGrey, fontSize: 12)),
                ],
              ),
              Text(
                _getProgressBar(allocatedAmount, outstandingAmount),
                style: const TextStyle(
                  color: AppColors.primaryBlueLight,
                  fontSize: 12,
                  fontWeight: FontWeight.bold,
                ),
              ),
            ],
          ),
          const SizedBox(height: 12),
          Row(
            children: [
              const Text('\$',
                  style: TextStyle(
                      color: AppColors.textWhite,
                      fontWeight: FontWeight.bold)),
              const SizedBox(width: 8),
              Expanded(
                child: TextField(
                  controller: controller,
                  keyboardType:
                      const TextInputType.numberWithOptions(decimal: true),
                  style: const TextStyle(color: AppColors.textWhite),
                  decoration: InputDecoration(
                    filled: true,
                    fillColor: AppColors.surfaceDarkGrey,
                    hintText: '0.00',
                    hintStyle: TextStyle(
                        color: AppColors.textWhite.withValues(alpha: 0.3)),
                    border: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(4),
                      borderSide: const BorderSide(
                          color: AppColors.surfaceLightGrey),
                    ),
                    enabledBorder: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(4),
                      borderSide: const BorderSide(
                          color: AppColors.surfaceLightGrey),
                    ),
                    focusedBorder: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(4),
                      borderSide:
                          const BorderSide(color: AppColors.primaryBlue),
                    ),
                    contentPadding: const EdgeInsets.symmetric(
                        horizontal: 12, vertical: 8),
                  ),
                  onChanged: (value) {
                    final amount = double.tryParse(value) ?? 0.0;
                    onAllocationChanged(billId, amount);
                  },
                ),
              ),
            ],
          ),
        ],
      ),
    );
  }

  String _getProgressBar(double allocated, double outstanding) {
    if (outstanding == 0) return '100%';
    final percentage = ((allocated / outstanding) * 100).clamp(0.0, 100.0);
    return '${percentage.toStringAsFixed(0)}%';
  }
}

// ==========================================
// FILE: ./pc/widgets/transactions/universal_entry_dialog.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../core/constants/app_colors.dart';

// --- DIRECT IMPORTS OF YOUR EXISTING DIALOGS ---
// We use them exactly as they are. No changes needed to them.
import '../dashboard/payment_dialog.dart';
import '../dashboard/expense_dialog.dart';
import '../dashboard/student_dialog.dart';
import '../dashboard/campaign_dialog.dart';

/// Global flag to track if the active form has unsaved data.
/// You will wire this up inside your individual dialogs later.
final formDirtyProvider = StateProvider<bool>((ref) => false);

enum TransactionType {
  // Current Modules
  payment,
  expense,
  student,
  campaign,
  // Future / Professional Modules
  payroll,
  assets,
  bulkImport,
  auditLog
}

class UniversalTransactionDialog extends ConsumerStatefulWidget {
  final String schoolId;
  final TransactionType initialType;

  const UniversalTransactionDialog({
    super.key, 
    required this.schoolId, 
    this.initialType = TransactionType.payment
  });

  @override
  ConsumerState<UniversalTransactionDialog> createState() => _UniversalTransactionDialogState();
}

class _UniversalTransactionDialogState extends ConsumerState<UniversalTransactionDialog> {
  late TransactionType _selectedType;

  @override
  void initState() {
    super.initState();
    _selectedType = widget.initialType;
  }

  /// -----------------------------------------------------------------------
  /// SWITCHING LOGIC (The "Safety Lock")
  /// -----------------------------------------------------------------------
  void _handleTypeSwitch(TransactionType newType) {
    if (_selectedType == newType) return;

    // 1. Future Feature Guard
    if (_isFutureFeature(newType)) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text("This Professional Module is coming in v2.0"),
          backgroundColor: AppColors.surfaceLightGrey,
          behavior: SnackBarBehavior.floating,
          width: 400,
        ),
      );
      return;
    }

    // 2. Dirty Check (Prevents accidental data loss)
    final isDirty = ref.read(formDirtyProvider);
    if (isDirty) {
      _showDiscardConfirmation(newType);
    } else {
      _performSwitch(newType);
    }
  }

  bool _isFutureFeature(TransactionType type) {
    return type == TransactionType.payroll || 
           type == TransactionType.assets || 
           type == TransactionType.bulkImport || 
           type == TransactionType.auditLog;
  }

  void _performSwitch(TransactionType newType) {
    setState(() {
      _selectedType = newType;
    });
    // Reset the dirty flag so the new screen starts clean
    ref.read(formDirtyProvider.notifier).state = false;
  }

  void _showDiscardConfirmation(TransactionType newType) {
    showDialog(
      context: context,
      builder: (ctx) => AlertDialog(
        backgroundColor: AppColors.surfaceGrey,
        title: const Text("Unsaved Changes", style: TextStyle(color: AppColors.textWhite)),
        content: const Text(
          "You have entered data in the current form.\nSwitching will discard it.", 
          style: TextStyle(color: AppColors.textWhite70)
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(ctx), // Stay
            child: const Text("Stay Here", style: TextStyle(color: AppColors.textWhite54)),
          ),
          ElevatedButton(
            onPressed: () {
              Navigator.pop(ctx); // Close alert
              _performSwitch(newType); // Proceed with switch
            },
            style: ElevatedButton.styleFrom(backgroundColor: AppColors.errorRed),
            child: const Text("Discard & Switch", style: TextStyle(color: Colors.white)),
          ),
        ],
      ),
    );
  }

  /// -----------------------------------------------------------------------
  /// UI BUILD
  /// -----------------------------------------------------------------------
  @override
  Widget build(BuildContext context) {
    return Dialog(
      backgroundColor: Colors.transparent,
      insetPadding: const EdgeInsets.all(24),
      // The Master Container
      child: Container(
        width: 1300, // Wide enough to fit sidebar + your 700px dialogs
        height: 850,
        decoration: BoxDecoration(
          color: AppColors.backgroundBlack, // The "Hub" background
          borderRadius: BorderRadius.circular(16),
          border: Border.all(color: AppColors.divider),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withValues(alpha: 0.5),
              blurRadius: 40,
              offset: const Offset(0, 20),
            )
          ],
        ),
        child: Row(
          children: [
            // --- LEFT: NAVIGATION SIDEBAR ---
            Container(
              width: 260,
              decoration: const BoxDecoration(
                color: Color(0xFF0F1115), // Darker sidebar
                borderRadius: BorderRadius.horizontal(left: Radius.circular(16)),
                border: Border(right: BorderSide(color: AppColors.divider)),
              ),
              child: Column(
                children: [
                  _buildSidebarHeader(),
                  const Divider(color: AppColors.divider),
                  const SizedBox(height: 16),
                  
                  // Active Modules
                  _buildSectionTitle("QUICK ENTRY"),
                  _buildNavItem(TransactionType.payment, "Record Payment", Icons.attach_money, AppColors.successGreen),
                  _buildNavItem(TransactionType.expense, "Add Expense", Icons.receipt_long, AppColors.errorRed),
                  
                  const SizedBox(height: 16),
                  _buildSectionTitle("MANAGEMENT"),
                  _buildNavItem(TransactionType.student, "New Student", Icons.school, AppColors.primaryBlue),
                  _buildNavItem(TransactionType.campaign, "Campaigns", Icons.campaign, AppColors.accentPurple),

                  const SizedBox(height: 16),
                  // Future Modules (Visual Placeholders)
                  _buildSectionTitle("PROFESSIONAL SUITE"),
                  _buildNavItem(TransactionType.payroll, "Run Payroll", Icons.payments_outlined, AppColors.textWhite38),
                  _buildNavItem(TransactionType.assets, "Asset Registry", Icons.inventory_2_outlined, AppColors.textWhite38),
                  _buildNavItem(TransactionType.bulkImport, "Bulk Import", Icons.upload_file, AppColors.textWhite38),
                  _buildNavItem(TransactionType.auditLog, "Audit Logs", Icons.history_edu, AppColors.textWhite38),

                  const Spacer(),
                  _buildCloseButton(),
                ],
              ),
            ),

            // --- RIGHT: CONTENT AREA (Your Dialogs Load Here) ---
            Expanded(
              child: Container(
                color: Colors.black.withValues(alpha: 0.2), // Slight dim for contrast
                child: Center(
                  // We use KeyedSubtree to ensure the old widget is fully disposed ("shut down")
                  // when switching types.
                  child: KeyedSubtree(
                    key: ValueKey(_selectedType),
                    child: _buildSelectedLayout(),
                  ),
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }

  /// -----------------------------------------------------------------------
  /// THE SWITCHER
  /// Loads your existing dialog widgets directly.
  /// -----------------------------------------------------------------------
  Widget _buildSelectedLayout() {
    // Note: Since your widgets return 'Dialog', they will render with their 
    // own internal shadows/borders. This is fine; they will look like 
    // "Cards" floating inside the Hub.
    switch (_selectedType) {
      case TransactionType.payment:
        return PaymentDialog(schoolId: widget.schoolId);
      case TransactionType.expense:
        return ExpenseDialog(schoolId: widget.schoolId);
      case TransactionType.student:
        return StudentDialog(schoolId: widget.schoolId);
      case TransactionType.campaign:
        return CampaignDialog(schoolId: widget.schoolId);
      default:
        return const SizedBox();
    }
  }

  // --- WIDGET HELPERS ---

  Widget _buildSidebarHeader() {
    return Padding(
      padding: const EdgeInsets.all(24),
      child: Row(
        children: [
          Container(
            padding: const EdgeInsets.all(8),
            decoration: BoxDecoration(
              color: AppColors.surfaceGrey, 
              borderRadius: BorderRadius.circular(8)
            ),
            child: const Icon(Icons.hub, color: AppColors.textWhite, size: 20),
          ),
          const SizedBox(width: 12),
          const Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text("Transaction Hub", style: TextStyle(color: AppColors.textWhite, fontWeight: FontWeight.bold, fontSize: 14)),
              Text("Central Entry Point", style: TextStyle(color: AppColors.textWhite54, fontSize: 12)),
            ],
          ),
        ],
      ),
    );
  }

  Widget _buildSectionTitle(String title) {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 8),
      child: Align(
        alignment: Alignment.centerLeft,
        child: Text(
          title, 
          style: const TextStyle(
            color: AppColors.textWhite38, 
            fontSize: 10, 
            fontWeight: FontWeight.bold, 
            letterSpacing: 1.0
          )
        ),
      ),
    );
  }

  Widget _buildNavItem(TransactionType type, String label, IconData icon, Color color) {
    final isSelected = _selectedType == type;
    final isFuture = _isFutureFeature(type);
    
    return GestureDetector(
      onTap: () => _handleTypeSwitch(type),
      child: Container(
        margin: const EdgeInsets.symmetric(horizontal: 16, vertical: 2),
        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
        decoration: BoxDecoration(
          color: isSelected ? AppColors.surfaceGrey : Colors.transparent,
          borderRadius: BorderRadius.circular(8),
          border: isSelected ? Border.all(color: AppColors.divider) : null,
        ),
        child: Row(
          children: [
            Icon(
              icon, 
              size: 18, 
              color: isFuture ? AppColors.textWhite38 : (isSelected ? color : AppColors.textWhite54)
            ),
            const SizedBox(width: 12),
            Text(
              label,
              style: TextStyle(
                color: isFuture ? AppColors.textWhite38 : (isSelected ? AppColors.textWhite : AppColors.textWhite54),
                fontWeight: isSelected ? FontWeight.w600 : FontWeight.normal,
                fontSize: 13,
              ),
            ),
            if (isFuture) ...[
              const Spacer(),
              const Icon(Icons.lock_outline, size: 14, color: AppColors.textWhite38),
            ]
          ],
        ),
      ),
    );
  }

  Widget _buildCloseButton() {
    return Padding(
      padding: const EdgeInsets.all(16),
      child: TextButton.icon(
        onPressed: () => Navigator.of(context).pop(),
        icon: const Icon(Icons.close, color: AppColors.textWhite54),
        label: const Text("Close Hub", style: TextStyle(color: AppColors.textWhite54)),
      ),
    );
  }
}
// ==========================================
// FILE: ./pc/widgets/transactions/transactions_header.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../../core/constants/app_colors.dart';
import '../../../../data/providers/dashboard_provider.dart';
import '../../../../data/services/database_service.dart'; // Import for connectivity check

class TransactionsHeader extends ConsumerWidget {
  const TransactionsHeader({super.key});

  String _getInitials(String name) {
    if (name.isEmpty) return "U";
    final parts = name.trim().split(' ');
    if (parts.length > 1) {
      return "${parts[0][0]}${parts[1][0]}".toUpperCase();
    }
    return name[0].toUpperCase();
  }

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final dashboardAsync = ref.watch(dashboardDataProvider);
    
    // Check connectivity status directly for UI feedback
    final bool isConnected = DatabaseService().db.currentStatus.connected;

    return Container(
      height: 70,
      padding: const EdgeInsets.symmetric(horizontal: 24),
      color: AppColors.backgroundBlack,
      child: Row(
        children: [
          const Text(
            "Transactions Log",
            style: TextStyle(
              color: AppColors.textWhite,
              fontSize: 18,
              fontWeight: FontWeight.bold,
            ),
          ),
          const Spacer(),
          
          // --- Search Bar ---
          SizedBox(
            width: 300,
            height: 40,
            child: TextField(
              textAlignVertical: TextAlignVertical.center,
              style: const TextStyle(color: AppColors.textWhite, fontSize: 13),
              decoration: InputDecoration(
                isDense: true,
                filled: true,
                fillColor: AppColors.surfaceGrey,
                hintText: "Search by ID, student, or category...",
                hintStyle: const TextStyle(color: AppColors.textWhite38),
                prefixIcon: const Icon(Icons.search, size: 18, color: AppColors.textWhite54),
                
                // Content Padding zero to center text vertically
                contentPadding: EdgeInsets.zero, 

                // Default Border
                enabledBorder: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(8),
                  borderSide: const BorderSide(color: AppColors.divider),
                ),
                
                // Focused Border
                focusedBorder: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(8),
                  borderSide: const BorderSide(color: AppColors.primaryBlue),
                ),
                
                // Fallback Border
                border: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(8),
                  borderSide: const BorderSide(color: AppColors.divider),
                ),
              ),
            ),
          ),
          const SizedBox(width: 24),
          
          // --- Notification Icon ---
          IconButton(
            onPressed: () {},
            icon: const Icon(Icons.notifications_none, color: AppColors.textWhite70),
            tooltip: "Notifications",
          ),
          const SizedBox(width: 16),
          
          // --- Profile with Connectivity Logic ---
          dashboardAsync.when(
            loading: () => _buildProfileLoading(),
            error: (err, _) => _buildProfileError(isConnected),
            data: (data) {
              final initials = _getInitials(data.userName);
              
              // Determine subtitle based on data state AND connectivity
              String subtitle = data.schoolName;
              if (data.schoolName == 'Loading...') {
                subtitle = isConnected ? "Syncing Data..." : "Offline Mode";
              }

              return Row(
                children: [
                  Column(
                    mainAxisAlignment: MainAxisAlignment.center,
                    crossAxisAlignment: CrossAxisAlignment.end,
                    children: [
                      Text(
                        data.userName.isEmpty ? "User" : data.userName, 
                        style: const TextStyle(color: AppColors.textWhite, fontWeight: FontWeight.bold, fontSize: 13)
                      ),
                      Text(
                        subtitle, 
                        style: TextStyle(
                          color: (subtitle == "Offline Mode") ? AppColors.warningOrange : AppColors.textWhite38, 
                          fontSize: 11
                        )
                      ),
                    ],
                  ),
                  const SizedBox(width: 12),
                  CircleAvatar(
                    backgroundColor: AppColors.primaryBlue.withValues(alpha: 0.2),
                    child: Text(
                      initials, 
                      style: const TextStyle(color: AppColors.primaryBlue, fontWeight: FontWeight.bold, fontSize: 12)
                    ),
                  ),
                ],
              );
            },
          ),
        ],
      ),
    );
  }

  // --- Loading/Error States ---

  Widget _buildProfileLoading() {
    return Row(
      children: [
        Column(
          mainAxisAlignment: MainAxisAlignment.center,
          crossAxisAlignment: CrossAxisAlignment.end,
          children: [
            Container(width: 80, height: 12, color: AppColors.surfaceGrey),
            const SizedBox(height: 4),
            Container(width: 50, height: 10, color: AppColors.surfaceGrey),
          ],
        ),
        const SizedBox(width: 12),
        const CircleAvatar(
          backgroundColor: AppColors.surfaceGrey,
          radius: 16,
        ),
      ],
    );
  }

  Widget _buildProfileError(bool isConnected) {
    return Row(
      children: [
        Text(
          isConnected ? "Sync Error" : "Offline", 
          style: TextStyle(color: isConnected ? AppColors.errorRed : AppColors.warningOrange, fontSize: 12)
        ),
        const SizedBox(width: 12),
        CircleAvatar(
          backgroundColor: AppColors.surfaceGrey,
          child: Icon(
            isConnected ? Icons.error_outline : Icons.wifi_off, 
            size: 16, 
            color: isConnected ? AppColors.errorRed : AppColors.warningOrange
          ),
        ),
      ],
    );
  }
}
// ==========================================
// FILE: ./pc/widgets/transactions/transactions_kpi_cards.dart
// ==========================================

import 'package:flutter/material.dart';
import '../../../core/constants/app_colors.dart';

class TransactionsKpiCards extends StatelessWidget {
  const TransactionsKpiCards({super.key});

  @override
  Widget build(BuildContext context) {
    return Row(
      children: [
        _buildCard(
          title: "TOTAL INCOME",
          value: "\$124,500",
          icon: Icons.trending_up,
          color: AppColors.successGreen,
        ),
        const SizedBox(width: 24),
        _buildCard(
          title: "TOTAL EXPENSES",
          value: "\$42,100",
          icon: Icons.trending_down,
          color: AppColors.errorRed,
        ),
        const SizedBox(width: 24),
        _buildCard(
          title: "PENDING",
          value: "\$8,350",
          icon: Icons.pending_actions,
          color: AppColors.primaryBlue,
        ),
        const SizedBox(width: 24),
        _buildCard(
          title: "DONATIONS",
          value: "\$15,200",
          icon: Icons.volunteer_activism,
          color: AppColors.accentPurple,
        ),
      ],
    );
  }

  Widget _buildCard({
    required String title,
    required String value,
    required IconData icon,
    required Color color,
  }) {
    return Expanded(
      child: Container(
        padding: const EdgeInsets.all(20),
        decoration: BoxDecoration(
          color: AppColors.surfaceGrey,
          borderRadius: BorderRadius.circular(12),
          border: Border.all(color: AppColors.divider),
        ),
        child: Row(
          children: [
            Container(
              padding: const EdgeInsets.all(12),
              decoration: BoxDecoration(
                color: color.withValues(alpha: 0.1),
                borderRadius: BorderRadius.circular(8),
              ),
              child: Icon(icon, color: color, size: 24),
            ),
            const SizedBox(width: 16),
            Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  title,
                  style: const TextStyle(
                    color: AppColors.textWhite54,
                    fontSize: 11,
                    fontWeight: FontWeight.bold,
                  ),
                ),
                const SizedBox(height: 4),
                Text(
                  value,
                  style: const TextStyle(
                    color: AppColors.textWhite,
                    fontSize: 22,
                    fontWeight: FontWeight.bold,
                  ),
                ),
              ],
            ),
          ],
        ),
      ),
    );
  }
}
// ==========================================
// FILE: ./pc/widgets/dashboard/stat_cards.dart
// ==========================================

import 'package:flutter/material.dart';
import '../../../core/constants/app_colors.dart';

class StatCard extends StatelessWidget {
  final String title;
  final String value;
  final IconData icon;
  final Color iconColor;
  final Color? iconBgColor;
  final Widget? footer;
  final bool isAlert;

  const StatCard({
    super.key,
    required this.title,
    required this.value,
    required this.icon,
    this.iconColor = AppColors.textWhite,
    this.iconBgColor,
    this.footer,
    this.isAlert = false,
  });

  @override
  Widget build(BuildContext context) {
    // ‚ö†Ô∏è CRITICAL FIX: Do NOT wrap this in Expanded. 
    // The parent widget (Home Screen) controls the size.
    return Container(
      padding: const EdgeInsets.all(16), 
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(16),
        border: isAlert 
            ? const Border(left: BorderSide(color: AppColors.errorRed, width: 4))
            : Border.all(color: AppColors.divider),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          // Header
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Flexible(
                child: Text(
                  title.toUpperCase(),
                  overflow: TextOverflow.ellipsis,
                  style: const TextStyle(
                    color: AppColors.textWhite54,
                    fontSize: 11,
                    fontWeight: FontWeight.bold,
                    letterSpacing: 0.5,
                  ),
                ),
              ),
              Container(
                padding: const EdgeInsets.all(8),
                decoration: BoxDecoration(
                  color: iconBgColor ?? AppColors.textWhite.withValues(alpha: 0.12),
                  borderRadius: BorderRadius.circular(8),
                ),
                child: Icon(icon, size: 18, color: iconColor),
              ),
            ],
          ),
          
          const SizedBox(height: 8),
          
          // Value
          Flexible(
            child: FittedBox(
              fit: BoxFit.scaleDown,
              alignment: Alignment.centerLeft,
              child: Text(
                value,
                style: const TextStyle(
                  color: AppColors.textWhite,
                  fontSize: 28,
                  fontWeight: FontWeight.bold,
                ),
              ),
            ),
          ),
          
          const SizedBox(height: 8),
          
          // Footer
          if (footer != null) 
            SizedBox(
              height: 24, 
              child: footer!,
            ),
        ],
      ),
    );
  }
}

class AlertBadge extends StatelessWidget {
  final String text;
  final String subText;

  const AlertBadge({super.key, required this.text, required this.subText});

  @override
  Widget build(BuildContext context) {
    return Row(
      mainAxisSize: MainAxisSize.min,
      children: [
        Container(
          padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
          decoration: BoxDecoration(
            color: AppColors.errorRed.withValues(alpha: 0.1),
            borderRadius: BorderRadius.circular(4),
          ),
          child: Row(
            mainAxisSize: MainAxisSize.min,
            children: [
              const Icon(Icons.warning_amber_rounded, size: 14, color: AppColors.errorRed),
              const SizedBox(width: 4),
              Text(
                text,
                style: const TextStyle(color: AppColors.errorRed, fontSize: 11, fontWeight: FontWeight.bold),
              ),
            ],
          ),
        ),
        const SizedBox(width: 8),
        Flexible(
          child: Text(
            subText,
            overflow: TextOverflow.ellipsis,
            style: const TextStyle(color: AppColors.textWhite38, fontSize: 11),
          ),
        ),
      ],
    );
  }
}
// ==========================================
// FILE: ./pc/widgets/dashboard/expense_dialog.dart
// ==========================================

import 'dart:ui';
// ignore: unused_import
import 'dart:math' as math;

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:intl/intl.dart';

import '../../../../core/constants/app_colors.dart';
import '../../../../data/models/finance_models.dart';
import '../../../../data/providers/expense_provider.dart';

class ExpenseDialog extends ConsumerStatefulWidget {
  final String schoolId;
  const ExpenseDialog({super.key, required this.schoolId});

  @override
  ConsumerState<ExpenseDialog> createState() => _ExpenseDialogState();
}

class _ExpenseDialogState extends ConsumerState<ExpenseDialog> {
  final _formKey = GlobalKey<FormState>();
  
  // Controllers
  final _titleController = TextEditingController();
  final _amountController = TextEditingController();
  final _dateController = TextEditingController();
  final _recipientController = TextEditingController();
  final _notesController = TextEditingController();

  DateTime _selectedDate = DateTime.now();
  String? _selectedCategory;
  String? _selectedPaymentMethod;

  @override
  void initState() {
    super.initState();
    _dateController.text = DateFormat('yyyy-MM-dd').format(_selectedDate);
  }

  @override
  void dispose() {
    _titleController.dispose();
    _amountController.dispose();
    _dateController.dispose();
    _recipientController.dispose();
    _notesController.dispose();
    super.dispose();
  }

  Future<void> _pickDate() async {
    final picked = await showDatePicker(
      context: context,
      initialDate: _selectedDate,
      firstDate: DateTime(2020),
      lastDate: DateTime(2030),
      builder: (context, child) {
        return Theme(
          data: ThemeData.dark().copyWith(
            colorScheme: const ColorScheme.dark(
              primary: AppColors.primaryBlue,
              onPrimary: AppColors.textWhite,
              surface: AppColors.surfaceGrey,
              onSurface: AppColors.textWhite,
            ),
            dialogTheme: const DialogThemeData(backgroundColor: AppColors.backgroundBlack),
          ),
          child: child!,
        );
      },
    );
    if (picked != null) {
      setState(() {
        _selectedDate = picked;
        _dateController.text = DateFormat('yyyy-MM-dd').format(picked);
      });
    }
  }

  Future<void> _submit() async {
    if (widget.schoolId.isEmpty) return; // Security check
    if (!_formKey.currentState!.validate()) return;

    final success = await ref.read(expenseControllerProvider.notifier).saveExpense(
      title: _titleController.text.trim(),
      amount: double.tryParse(_amountController.text.trim()) ?? 0.0,
      date: _selectedDate,
      category: _selectedCategory,
      recipient: _recipientController.text.trim(),
      notes: _notesController.text.trim(),
      paymentMethod: _selectedPaymentMethod,
    );

    if (success && mounted) {
      Navigator.of(context).pop();
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text("Expense Saved"), backgroundColor: AppColors.successGreen),
      );
    }
  }

  @override
  Widget build(BuildContext context) {
    // 1. Check if school ID is valid
    final hasSchool = widget.schoolId.isNotEmpty;

    final expensesAsync = ref.watch(recentExpensesProvider);
    final saveState = ref.watch(expenseControllerProvider);

    // Listen for errors
    ref.listen(expenseControllerProvider, (prev, next) {
      if (next.hasError && !next.isLoading) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text("Error: ${next.error}"), backgroundColor: AppColors.errorRed),
        );
      }
    });

    return Dialog(
      backgroundColor: Colors.transparent,
      insetPadding: const EdgeInsets.all(24),
      child: Container(
        width: 1100,
        height: 800,
        decoration: BoxDecoration(
          color: AppColors.backgroundBlack,
          borderRadius: BorderRadius.circular(16),
          border: Border.all(color: AppColors.surfaceLightGrey),
          boxShadow: [
            BoxShadow(color: Colors.black.withValues(alpha: 0.5), blurRadius: 20, offset: const Offset(0, 10))
          ],
        ),
        child: Column(
          children: [
            // HEADER
            _buildHeader(),
            const Divider(height: 1, color: AppColors.divider),

            // MAIN CONTENT
            Expanded(
              child: !hasSchool 
                ? _buildNoSchoolState()
                : _buildFormAndList(expensesAsync),
            ),

            const Divider(height: 1, color: AppColors.divider),
            
            // FOOTER (Disabled if no school)
            Padding(
              padding: const EdgeInsets.all(24),
              child: Row(
                mainAxisAlignment: MainAxisAlignment.end,
                children: [
                  TextButton(
                    onPressed: () => Navigator.of(context).pop(),
                    child: const Text("Cancel", style: TextStyle(color: AppColors.textWhite70)),
                  ),
                  const SizedBox(width: 16),
                  if (hasSchool)
                    ElevatedButton.icon(
                      onPressed: saveState.isLoading ? null : _submit,
                      style: ElevatedButton.styleFrom(
                        backgroundColor: AppColors.primaryBlue,
                        foregroundColor: AppColors.textWhite,
                        padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 16),
                        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
                      ),
                      icon: saveState.isLoading 
                        ? const SizedBox(width: 16, height: 16, child: CircularProgressIndicator(strokeWidth: 2, color: Colors.white)) 
                        : const Icon(Icons.check, size: 18),
                      label: Text(saveState.isLoading ? "Saving..." : "Save Expense", style: const TextStyle(fontWeight: FontWeight.bold)),
                    )
                  else
                    ElevatedButton(
                      onPressed: null,
                      style: ElevatedButton.styleFrom(
                        backgroundColor: AppColors.disabledGrey.withValues(alpha: 0.2),
                        padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 16),
                      ),
                      child: const Text("Action Disabled", style: TextStyle(color: AppColors.textWhite38)),
                    ),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }

  // --- CONTENT STATES ---

  Widget _buildNoSchoolState() {
    return Center(
      child: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          Icon(Icons.school_outlined, size: 64, color: AppColors.textGrey.withValues(alpha: 0.5)),
          const SizedBox(height: 24),
          const Text(
            "School Configuration Required",
            style: TextStyle(color: AppColors.textWhite, fontSize: 20, fontWeight: FontWeight.bold),
          ),
          const SizedBox(height: 8),
          const Text(
            "Please set up a school to start creating any student data\nor sync the school to the database.",
            textAlign: TextAlign.center,
            style: TextStyle(color: AppColors.textGrey, fontSize: 14),
          ),
        ],
      ),
    );
  }

  Widget _buildFormAndList(AsyncValue<List<Expense>> expensesAsync) {
    return Row(
      children: [
        // --- LEFT COLUMN: FORM ---
        Expanded(
          flex: 5,
          child: Padding(
            padding: const EdgeInsets.all(32),
            child: Form(
              key: _formKey,
              child: SingleChildScrollView(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    const Text("NEW EXPENSE ENTRY", style: TextStyle(color: AppColors.textGrey, fontSize: 12, fontWeight: FontWeight.bold, letterSpacing: 1.2)),
                    const SizedBox(height: 24),

                    _buildLabel("Expense Title"),
                    _buildTextField(
                      controller: _titleController,
                      hint: "e.g. Science Lab Equipment",
                      validator: (v) => v!.isEmpty ? "Required" : null,
                    ),
                    const SizedBox(height: 16),

                    Row(
                      children: [
                        Expanded(
                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              _buildLabel("Amount"),
                              _buildTextField(
                                controller: _amountController,
                                hint: "0.00",
                                prefix: "\$ ",
                                inputType: const TextInputType.numberWithOptions(decimal: true),
                                validator: (v) {
                                  if (v == null || v.isEmpty) return "Required";
                                  if (double.tryParse(v) == null) return "Invalid";
                                  return null;
                                },
                              ),
                            ],
                          ),
                        ),
                        const SizedBox(width: 16),
                        Expanded(
                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              _buildLabel("Incurred Date"),
                              GestureDetector(
                                onTap: _pickDate,
                                child: AbsorbPointer(
                                  child: _buildTextField(
                                    controller: _dateController,
                                    hint: "yyyy-mm-dd",
                                    suffixIcon: Icons.calendar_today_outlined,
                                  ),
                                ),
                              ),
                            ],
                          ),
                        ),
                      ],
                    ),
                    const SizedBox(height: 16),

                    Row(
                      children: [
                        Expanded(
                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              _buildLabel("Category"),
                              _buildDropdown(
                                hint: "Select category",
                                value: _selectedCategory,
                                items: ["Supplies", "Utilities", "Transport", "Events", "Maintenance", "Salaries"],
                                onChanged: (val) => setState(() => _selectedCategory = val),
                              ),
                            ],
                          ),
                        ),
                        const SizedBox(width: 16),
                        Expanded(
                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              _buildLabel("Payment Method"),
                              _buildDropdown(
                                hint: "Select method",
                                value: _selectedPaymentMethod,
                                items: ["Bank Transfer", "Credit Card", "Cash", "Petty Cash", "EcoCash"],
                                onChanged: (val) => setState(() => _selectedPaymentMethod = val),
                              ),
                            ],
                          ),
                        ),
                      ],
                    ),
                    const SizedBox(height: 16),

                    _buildLabel("Recipient / Vendor"),
                    _buildTextField(
                      controller: _recipientController,
                      hint: "e.g. Office Depot",
                      prefixIcon: Icons.storefront_outlined,
                    ),
                    const SizedBox(height: 16),

                    _buildLabel("Notes / Description"),
                    _buildTextField(
                      controller: _notesController,
                      hint: "Additional details...",
                      maxLines: 3,
                    ),
                    
                    const SizedBox(height: 24),
                    
                    // Visual Placeholder for Attachments (Custom Dashed Border)
                    Opacity(
                      opacity: 0.5,
                      child: _buildAttachmentArea(),
                    ),
                  ],
                ),
              ),
            ),
          ),
        ),

        const VerticalDivider(width: 1, color: AppColors.divider),

        // --- RIGHT COLUMN: RECENT LIST (Streamed from DB) ---
        Expanded(
          flex: 4,
          child: Container(
            color: AppColors.surfaceDarkGrey,
            padding: const EdgeInsets.all(24),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const Text("RECENT EXPENSES", style: TextStyle(color: AppColors.textGrey, fontSize: 12, fontWeight: FontWeight.bold, letterSpacing: 1.2)),
                const SizedBox(height: 24),
                Expanded(
                  child: expensesAsync.when(
                    data: (expenses) {
                      if (expenses.isEmpty) {
                        return const Center(child: Text("No expenses recorded yet.", style: TextStyle(color: AppColors.textGrey)));
                      }
                      return ListView.separated(
                        itemCount: expenses.length,
                        separatorBuilder: (_, __) => const SizedBox(height: 12),
                        itemBuilder: (context, index) {
                          return _buildExpenseItem(expenses[index]);
                        },
                      );
                    },
                    loading: () => const Center(child: CircularProgressIndicator(color: AppColors.primaryBlue)),
                    error: (e, stack) => const Center(child: Text("Error loading data", style: TextStyle(color: AppColors.errorRed))),
                  ),
                ),
              ],
            ),
          ),
        ),
      ],
    );
  }

  // --- WIDGET BUILDERS ---

  Widget _buildHeader() {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 32, vertical: 24),
      child: Row(
        children: [
          Container(
            padding: const EdgeInsets.all(8),
            decoration: BoxDecoration(
              color: AppColors.primaryBlue.withValues(alpha: 0.2), 
              borderRadius: BorderRadius.circular(8)
            ),
            child: const Icon(Icons.account_balance_wallet, color: AppColors.primaryBlue),
          ),
          const SizedBox(width: 16),
          const Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text("Manage Expenses", style: TextStyle(color: AppColors.textWhite, fontSize: 18, fontWeight: FontWeight.bold)),
              Text("Production Mode", style: TextStyle(color: AppColors.textGrey, fontSize: 13)),
            ],
          ),
          const Spacer(),
          IconButton(
            onPressed: () => Navigator.of(context).pop(),
            icon: const Icon(Icons.close, color: AppColors.textGrey),
          ),
        ],
      ),
    );
  }

  Widget _buildLabel(String text) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 8.0),
      child: Text(text, style: TextStyle(color: AppColors.textWhite.withValues(alpha: 0.9), fontSize: 14, fontWeight: FontWeight.w500)),
    );
  }

  Widget _buildTextField({
    required TextEditingController controller,
    required String hint,
    String? prefix, IconData? prefixIcon, IconData? suffixIcon,
    int maxLines = 1, TextInputType inputType = TextInputType.text,
    String? Function(String?)? validator,
  }) {
    return TextFormField(
      controller: controller, maxLines: maxLines, keyboardType: inputType,
      validator: validator,
      style: const TextStyle(color: AppColors.textWhite),
      decoration: InputDecoration(
        filled: true, 
        fillColor: AppColors.surfaceGrey, 
        hintText: hint,
        hintStyle: TextStyle(color: AppColors.textWhite.withValues(alpha: 0.3)),
        prefixText: prefix, prefixStyle: const TextStyle(color: AppColors.textWhite, fontWeight: FontWeight.bold),
        prefixIcon: prefixIcon != null ? Icon(prefixIcon, color: AppColors.textWhite54, size: 20) : null,
        suffixIcon: suffixIcon != null ? Icon(suffixIcon, color: AppColors.textWhite54, size: 20) : null,
        border: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.surfaceLightGrey)),
        enabledBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.surfaceLightGrey)),
        focusedBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.primaryBlue)),
        contentPadding: const EdgeInsets.symmetric(horizontal: 16, vertical: 16),
      ),
    );
  }

  Widget _buildDropdown({
    required String hint, required String? value, required List<String> items,
    required Function(String?) onChanged,
  }) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 16),
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey, borderRadius: BorderRadius.circular(8),
        border: Border.all(color: AppColors.surfaceLightGrey),
      ),
      child: DropdownButtonHideUnderline(
        child: DropdownButton<String>(
          value: value, 
          hint: Text(hint, style: TextStyle(color: AppColors.textWhite.withValues(alpha: 0.3))),
          dropdownColor: AppColors.surfaceGrey, 
          icon: const Icon(Icons.keyboard_arrow_down, color: AppColors.textWhite54),
          isExpanded: true, 
          style: const TextStyle(color: AppColors.textWhite),
          items: items.map((e) => DropdownMenuItem(value: e, child: Text(e))).toList(),
          onChanged: onChanged,
        ),
      ),
    );
  }

  Widget _buildAttachmentArea() {
    return _DashedBorder(
      color: AppColors.divider,
      strokeWidth: 2,
      gap: 6,
      radius: 12,
      child: Container(
        width: double.infinity, height: 80,
        alignment: Alignment.center,
        color: AppColors.surfaceGrey.withValues(alpha: 0.5),
        child: const Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Icon(Icons.cloud_off, color: AppColors.textWhite38, size: 28),
            SizedBox(height: 8),
            Text("Attachments not supported in offline schema", style: TextStyle(color: AppColors.textGrey, fontSize: 12)),
          ],
        ),
      ),
    );
  }

  Widget _buildExpenseItem(Expense item) {
    IconData icon = Icons.attach_money;
    Color color = AppColors.primaryBlue;
    
    final cat = (item.category ?? '').toLowerCase();
    if (cat.contains('utility')) { icon = Icons.bolt; color = AppColors.warningOrange; }
    else if (cat.contains('transport')) { icon = Icons.directions_bus; color = AppColors.accentPurple; }
    else if (cat.contains('supplies')) { icon = Icons.science; color = AppColors.successGreen; }
    else if (cat.contains('maint')) { icon = Icons.build; color = AppColors.errorRed; }

    final dateStr = DateFormat('MMM d').format(item.incurredAt);

    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey, 
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: AppColors.divider),
      ),
      child: Row(
        children: [
          Container(
            width: 48, height: 48,
            decoration: BoxDecoration(color: color.withValues(alpha: 0.1), borderRadius: BorderRadius.circular(10)),
            child: Icon(icon, color: color, size: 24),
          ),
          const SizedBox(width: 16),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(item.title, style: const TextStyle(color: AppColors.textWhite, fontWeight: FontWeight.bold)),
                Text("${item.category ?? 'General'} ‚Ä¢ $dateStr", 
                  style: const TextStyle(color: AppColors.textWhite54, fontSize: 12)),
              ],
            ),
          ),
          Column(
            crossAxisAlignment: CrossAxisAlignment.end,
            children: [
              Text("-\$${item.amount.toStringAsFixed(2)}", style: const TextStyle(color: AppColors.textWhite, fontWeight: FontWeight.bold)),
            ],
          ),
        ],
      ),
    );
  }
}

// --- CUSTOM DASHED BORDER WIDGET (Unchanged) ---
class _DashedBorder extends StatelessWidget {
  final Widget child;
  final Color color;
  final double strokeWidth;
  final double gap;
  final double radius;

  const _DashedBorder({
    required this.child,
    this.color = Colors.white,
    this.strokeWidth = 1.0,
    this.gap = 5.0,
    this.radius = 0.0,
  });

  @override
  Widget build(BuildContext context) {
    return CustomPaint(
      painter: _DashedBorderPainter(
        color: color,
        strokeWidth: strokeWidth,
        gap: gap,
        radius: radius,
      ),
      child: child,
    );
  }
}

class _DashedBorderPainter extends CustomPainter {
  final Color color;
  final double strokeWidth;
  final double gap;
  final double radius;

  _DashedBorderPainter({
    required this.color,
    required this.strokeWidth,
    required this.gap,
    required this.radius,
  });

  @override
  void paint(Canvas canvas, Size size) {
    final Paint paint = Paint()
      ..color = color
      ..strokeWidth = strokeWidth
      ..style = PaintingStyle.stroke;

    final Path path = Path()
      ..addRRect(RRect.fromRectAndRadius(
        Rect.fromLTWH(0, 0, size.width, size.height),
        Radius.circular(radius),
      ));

    final Path dashedPath = _dashPath(path, width: 6, space: gap);
    canvas.drawPath(dashedPath, paint);
  }

  Path _dashPath(Path source, {required double width, required double space}) {
    final Path path = Path();
    for (final PathMetric metric in source.computeMetrics()) {
      double distance = 0.0;
      while (distance < metric.length) {
        path.addPath(
          metric.extractPath(distance, distance + width),
          Offset.zero,
        );
        distance += width + space;
      }
    }
    return path;
  }

  @override
  bool shouldRepaint(_DashedBorderPainter oldDelegate) {
    return oldDelegate.color != color ||
        oldDelegate.strokeWidth != strokeWidth ||
        oldDelegate.gap != gap ||
        oldDelegate.radius != radius;
  }
}
// ==========================================
// FILE: ./pc/widgets/dashboard/revenue_chart.dart
// ==========================================

import 'package:fl_chart/fl_chart.dart';
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:intl/intl.dart';
import '../../../core/constants/app_colors.dart';
import '../../../data/providers/revenue_provider.dart';

class RevenueChart extends ConsumerWidget {
  const RevenueChart({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final revenueAsync = ref.watch(weeklyRevenueProvider);
    final currentFilter = ref.watch(revenueFilterProvider);

    return Container(
      padding: const EdgeInsets.all(24),
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: Colors.white10),
      ),
      child: revenueAsync.when(
        loading: () => const Center(child: CircularProgressIndicator()),
        error: (err, stack) => Center(child: Text('Error: $err', style: const TextStyle(color: Colors.red, fontSize: 12))),
        data: (data) {
          // Dynamic Y-Axis Scale
          double maxY = 100;
          for (var val in data.dailyTotals.values) {
            if (val > maxY) maxY = val;
          }
          maxY = maxY * 1.2; // Add breathing room

          return Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              // --- HEADER ---
              Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      const Text("Revenue & Collections", style: TextStyle(color: Colors.white, fontSize: 16, fontWeight: FontWeight.bold)),
                      const SizedBox(height: 4),
                      Text(
                        "Total: ${NumberFormat.simpleCurrency().format(data.totalWeekRevenue)}", 
                        style: const TextStyle(color: Colors.white54, fontSize: 13)
                      ),
                    ],
                  ),
                  
                  // --- FUNCTIONAL DROPDOWN ---
                  Container(
                    padding: const EdgeInsets.symmetric(horizontal: 12),
                    decoration: BoxDecoration(color: Colors.white10, borderRadius: BorderRadius.circular(6)),
                    child: DropdownButtonHideUnderline(
                      child: DropdownButton<RevenueFilter>(
                        value: currentFilter,
                        dropdownColor: const Color(0xFF2C2F36),
                        icon: const Icon(Icons.keyboard_arrow_down, size: 16, color: Colors.white),
                        style: const TextStyle(color: Colors.white, fontSize: 12),
                        onChanged: (RevenueFilter? newValue) {
                          if (newValue != null) {
                            // This triggers the provider to refresh
                            ref.read(revenueFilterProvider.notifier).state = newValue;
                          }
                        },
                        items: const [
                          DropdownMenuItem(value: RevenueFilter.thisWeek, child: Text("This Week")),
                          DropdownMenuItem(value: RevenueFilter.lastWeek, child: Text("Last Week")),
                        ],
                      ),
                    ),
                  )
                ],
              ),
              const SizedBox(height: 24),
              
              // --- CHART ---
              Expanded(
                child: LineChart(
                  LineChartData(
                    gridData: FlGridData(
                      show: true,
                      drawVerticalLine: false,
                      getDrawingHorizontalLine: (value) => const FlLine(color: Colors.white10, strokeWidth: 1),
                    ),
                    titlesData: FlTitlesData(
                      show: true,
                      rightTitles: const AxisTitles(sideTitles: SideTitles(showTitles: false)),
                      topTitles: const AxisTitles(sideTitles: SideTitles(showTitles: false)),
                      bottomTitles: AxisTitles(
                        sideTitles: SideTitles(
                          showTitles: true,
                          reservedSize: 30,
                          interval: 1, 
                          getTitlesWidget: (value, meta) {
                            const style = TextStyle(color: Colors.white38, fontSize: 12);
                            // Visual Map: 0=Mon, 2=Tue, 4=Wed, 6=Thu, 8=Fri
                            switch (value.toInt()) {
                              case 0: return const Text('Mon', style: style);
                              case 2: return const Text('Tue', style: style);
                              case 4: return const Text('Wed', style: style);
                              case 6: return const Text('Thu', style: style);
                              case 8: return const Text('Fri', style: style);
                            }
                            return const Text('');
                          },
                        ),
                      ),
                      leftTitles: AxisTitles(
                        sideTitles: SideTitles(
                          showTitles: true,
                          reservedSize: 40,
                          getTitlesWidget: (value, meta) {
                            if (value == 0) return const SizedBox.shrink();
                            return Text(
                              NumberFormat.compact().format(value),
                              style: const TextStyle(color: Colors.white38, fontSize: 10),
                            );
                          },
                        ),
                      ),
                    ),
                    borderData: FlBorderData(show: false),
                    minX: 0,
                    maxX: 8,
                    minY: 0,
                    maxY: maxY,
                    lineBarsData: [
                      LineChartBarData(
                        spots: [
                          // Mapping Real Data to Visual X Coordinates
                          FlSpot(0, data.dailyTotals[1] ?? 0),
                          FlSpot(2, data.dailyTotals[2] ?? 0),
                          FlSpot(4, data.dailyTotals[3] ?? 0),
                          FlSpot(6, data.dailyTotals[4] ?? 0),
                          FlSpot(8, data.dailyTotals[5] ?? 0),
                        ],
                        isCurved: true,
                        color: AppColors.primaryBlue,
                        barWidth: 3,
                        isStrokeCapRound: true,
                        dotData: const FlDotData(show: false),
                        belowBarData: BarAreaData(
                          show: true,
                          color: AppColors.primaryBlue.withAlpha(25),
                        ),
                      ),
                    ],
                    lineTouchData: LineTouchData(
                      touchTooltipData: LineTouchTooltipData(
                        getTooltipColor: (spot) => Colors.black87,
                        getTooltipItems: (touchedSpots) {
                          return touchedSpots.map((spot) {
                            return LineTooltipItem(
                              "\$${spot.y.toStringAsFixed(2)}",
                              const TextStyle(color: Colors.white, fontWeight: FontWeight.bold),
                            );
                          }).toList();
                        },
                      ),
                    ),
                  ),
                ),
              ),
            ],
          );
        },
      ),
    );
  }
}
// ==========================================
// FILE: ./pc/widgets/dashboard/quick_actions_grid.dart
// ==========================================

import 'package:flutter/material.dart';
import '../../../core/constants/app_colors.dart';

enum QuickActionType {
  recordPayment,
  addExpense,
  registerStudent,
  createCampaign,
}

class QuickActionItem {
  final String label;
  final IconData icon;
  final Color color;
  final QuickActionType type;

  const QuickActionItem({
    required this.label,
    required this.icon,
    required this.color,
    required this.type,
  });
}

class QuickActionsGrid extends StatelessWidget {
  final Function(QuickActionType) onActionSelected;

  const QuickActionsGrid({
    super.key,
    required this.onActionSelected,
  });

  // --- CONFIGURATION ---
  final List<QuickActionItem> _actions = const [
    QuickActionItem(
      label: "Record Payment",
      icon: Icons.attach_money,
      color: AppColors.successGreen,
      type: QuickActionType.recordPayment,
    ),
    QuickActionItem(
      label: "Add Expense",
      icon: Icons.receipt_long,
      color: AppColors.errorRed,
      type: QuickActionType.addExpense,
    ),
    QuickActionItem(
      label: "New Student",
      icon: Icons.person_add,
      color: AppColors.primaryBlueLight,
      type: QuickActionType.registerStudent,
    ),
    QuickActionItem(
      label: "New Campaign",
      icon: Icons.campaign,
      color: AppColors.accentPurple,
      type: QuickActionType.createCampaign,
    ),
  ];

  @override
  Widget build(BuildContext context) {
    // This Container fills the Zone (400px height)
    return Container(
      padding: const EdgeInsets.all(24), 
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: AppColors.divider),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          const Text(
            "Quick Actions",
            style: TextStyle(
              color: AppColors.textWhite,
              fontSize: 18,
              fontWeight: FontWeight.bold,
            ),
          ),
          const SizedBox(height: 24),
          
          // Use Spacers to distribute buttons evenly within the 400px fixed height
          // This avoids stretching the buttons themselves.
          Expanded(
            child: Row(
              children: [
                Expanded(child: _buildActionCard(_actions[0])),
                const SizedBox(width: 16),
                Expanded(child: _buildActionCard(_actions[1])),
              ],
            ),
          ),
          const SizedBox(height: 16),
          Expanded(
            child: Row(
              children: [
                Expanded(child: _buildActionCard(_actions[2])),
                const SizedBox(width: 16),
                Expanded(child: _buildActionCard(_actions[3])),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildActionCard(QuickActionItem action) {
    // Material wraps the InkWell for the ripple effect
    return Material(
      color: Colors.transparent,
      child: InkWell(
        onTap: () => onActionSelected(action.type),
        borderRadius: BorderRadius.circular(12),
        hoverColor: AppColors.textWhite.withValues(alpha: 0.04),
        child: Container(
          width: double.infinity, // Fill width of the grid cell
          // Note: No fixed height here; the 'Expanded' in the parent layout handles height allocation
          // but because there are only 2 rows in 400px (minus text/padding), 
          // they will naturally be about 130px tall, which is a good aspect ratio.
          decoration: BoxDecoration(
            borderRadius: BorderRadius.circular(12),
            border: Border.all(color: AppColors.textWhite.withValues(alpha: 0.06)),
            color: AppColors.textWhite.withValues(alpha: 0.02),
          ),
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              Container(
                padding: const EdgeInsets.all(12),
                decoration: BoxDecoration(
                  color: action.color.withValues(alpha: 0.12),
                  shape: BoxShape.circle,
                ),
                child: Icon(action.icon, color: action.color, size: 24),
              ),
              const SizedBox(height: 12),
              Padding(
                padding: const EdgeInsets.symmetric(horizontal: 4.0),
                child: Text(
                  action.label,
                  maxLines: 1,
                  overflow: TextOverflow.ellipsis,
                  style: const TextStyle(
                    color: AppColors.textWhite70,
                    fontSize: 13,
                    fontWeight: FontWeight.w600,
                  ),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}
// ==========================================
// FILE: ./pc/widgets/dashboard/student_dialog.dart
// ==========================================

import 'dart:math';
// ignore: unnecessary_import
import 'dart:ui'; 

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:intl/intl.dart';
import 'package:uuid/uuid.dart';

import '../../../../core/constants/app_colors.dart';
import '../../../../data/models/subjects.dart';
import '../../../../data/services/database_service.dart';

class StudentDialog extends ConsumerStatefulWidget {
  final String schoolId;
  
  const StudentDialog({
    super.key, 
    required this.schoolId,
  });

  @override
  ConsumerState<StudentDialog> createState() => _StudentDialogState();
}

class _StudentDialogState extends ConsumerState<StudentDialog> {
  final _formKey = GlobalKey<FormState>();
  final DatabaseService _dbService = DatabaseService();

  // -- Controllers --
  final _fullNameController = TextEditingController();
  final _studentIdController = TextEditingController();
  final _parentContactController = TextEditingController();
  final _addressController = TextEditingController();
  final _feeController = TextEditingController();
  final _initialPayController = TextEditingController();

  // -- State --
  DateTime _dob = DateTime(2010, 1, 1);
  final DateTime _registrationDate = DateTime.now();
  String _selectedGender = 'Male';
  String _selectedGrade = 'FORM 1';
  String _billingType = 'monthly';
  List<String> _selectedSubjects = [];
  bool _isLoading = false;

  // -- Constants --
  final List<String> _genders = ['Male', 'Female'];
  final List<String> _grades = [
    'ECD A', 'ECD B', 'GRADE 1', 'GRADE 2', 'GRADE 3', 'GRADE 4',
    'GRADE 5', 'GRADE 6', 'GRADE 7', 'FORM 1', 'FORM 2', 'FORM 3',
    'FORM 4', 'LOWER 6', 'UPPER 6'
  ];

  @override
  void initState() {
    super.initState();
    _generateNewId();
  }

  void _generateNewId() {
    final random = Random();
    final idNumber = 100000000 + random.nextInt(900000000); 
    _studentIdController.text = "STU-$idNumber";
  }

  @override
  void dispose() {
    _fullNameController.dispose();
    _studentIdController.dispose();
    _parentContactController.dispose();
    _addressController.dispose();
    _feeController.dispose();
    _initialPayController.dispose();
    super.dispose();
  }

  // --- LOGIC (Preserved Exactly) ---

  Future<void> _saveStudent() async {
    if (!_formKey.currentState!.validate()) return;

    setState(() => _isLoading = true);

    try {
      final db = _dbService;
      final newStudentUuid = const Uuid().v4();
      
      // 1. Prepare ID
      String displayId = _studentIdController.text.trim();
      if (displayId.isEmpty) {
        _generateNewId();
        displayId = _studentIdController.text;
      }

      final defaultFee = double.tryParse(_feeController.text.replaceAll(',', '')) ?? 0.0;
      final initialPay = double.tryParse(_initialPayController.text.replaceAll(',', '')) ?? 0.0;

      // 2. Billing Date Logic
      String? billingDateStr;
      if (_billingType == 'monthly') {
        billingDateStr = DateFormat('yyyy-MM-dd').format(_registrationDate);
      }

      // 3. Insert Student
      final studentData = {
        'id': newStudentUuid,
        'school_id': widget.schoolId,
        'student_id': displayId,
        'full_name': _fullNameController.text.trim(),
        'grade': _selectedGrade,
        'parent_contact': _parentContactController.text.trim(),
        'address': _addressController.text.trim(),
        'date_of_birth': DateFormat('yyyy-MM-dd').format(_dob),
        'gender': _selectedGender,
        'billing_type': _billingType,
        'default_fee': defaultFee,
        'subjects': _selectedSubjects.join(','),
        'registration_date': DateTime.now().toIso8601String(),
        'billing_date': billingDateStr,
        'enrollment_date': DateTime.now().toIso8601String(),
        'created_at': DateTime.now().toIso8601String(),
        'updated_at': DateTime.now().toIso8601String(),
        'is_active': 1,
        'owed_total': 0.0, 
        'paid_total': initialPay,
        'photo_consent': 0,
      };

      await db.insert('students', studentData);

      // 4. Auto-Billing
      String? generatedBillId;
      if (_billingType == 'monthly' && defaultFee > 0) {
        generatedBillId = await _attemptAutoBilling(newStudentUuid, defaultFee);
      }

      // 5. Initial Payment
      if (initialPay > 0) {
        await db.insert('payments', {
          'id': const Uuid().v4(),
          'school_id': widget.schoolId,
          'student_id': newStudentUuid,
          'bill_id': generatedBillId,
          'amount': initialPay,
          'date_paid': DateFormat('yyyy-MM-dd').format(DateTime.now()),
          'category': 'Tuition',
          'method': 'Cash', 
          'payer_name': _fullNameController.text.trim(), 
          'created_at': DateTime.now().toIso8601String(),
        });
      }

      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
            content: Text('Student registered successfully!'),
            backgroundColor: AppColors.successGreen,
          ),
        );
        Navigator.of(context).pop(); 
      }
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text('Error: $e'), backgroundColor: AppColors.errorRed),
        );
      }
    } finally {
      if (mounted) setState(() => _isLoading = false);
    }
  }

  Future<String?> _attemptAutoBilling(String studentId, double amount) async {
    try {
      final allYears = await _dbService.db.getAll('SELECT * FROM school_years WHERE school_id = ?', [widget.schoolId]);
      Map<String, dynamic>? activeYear;
      
      for (var y in allYears) {
        final start = DateTime.parse(y['start_date']);
        final end = DateTime.parse(y['end_date']);
        if (_registrationDate.isAfter(start.subtract(const Duration(days: 1))) && 
            _registrationDate.isBefore(end.add(const Duration(days: 1)))) {
          activeYear = y;
          break;
        }
      }

      if (activeYear == null) return null;

      final months = await _dbService.db.getAll('SELECT * FROM school_year_months WHERE school_year_id = ?', [activeYear['id']]);
      Map<String, dynamic>? activeMonth;

      for (var m in months) {
        final start = DateTime.parse(m['start_date']);
        final end = DateTime.parse(m['end_date']);
        if (_registrationDate.isAfter(start.subtract(const Duration(days: 1))) && 
            _registrationDate.isBefore(end.add(const Duration(days: 1)))) {
          activeMonth = m;
          break;
        }
      }

      if (activeMonth == null) return null;

      final billId = const Uuid().v4();
      await _dbService.insert('bills', {
        'id': billId,
        'school_id': widget.schoolId,
        'student_id': studentId,
        'title': 'Tuition - ${activeMonth['name']}',
        'total_amount': amount,
        'is_paid': 0,
        'bill_type': 'monthly',
        'billing_cycle_start': activeMonth['start_date'],
        'billing_cycle_end': activeMonth['end_date'],
        'month_year': activeMonth['name'],
        'school_year_id': activeYear['id'],
        'month_index': activeMonth['month_index'],
        'created_at': DateTime.now().toIso8601String(),
        'updated_at': DateTime.now().toIso8601String(),
      });

      return billId;
    } catch (e) {
      debugPrint("Auto-billing failed (silent): $e");
      return null;
    }
  }

  // --- SUB-DIALOGS ---

  void _openSubjectSelector() {
    showDialog(
      context: context,
      builder: (context) {
        final allSubjects = ZimsecSubject.allNames;
        List<String> tempSelected = List.from(_selectedSubjects);
        String searchQuery = "";
        
        return StatefulBuilder(
          builder: (context, setState) {
            final filteredSubjects = allSubjects.where((s) => s.toLowerCase().contains(searchQuery.toLowerCase())).toList();

            return AlertDialog(
              backgroundColor: AppColors.surfaceGrey,
              title: const Text("Select Subjects", style: TextStyle(color: AppColors.textWhite)),
              content: SizedBox(
                width: 400,
                height: 500,
                child: Column(
                  children: [
                    TextField(
                      onChanged: (val) => setState(() => searchQuery = val),
                      style: const TextStyle(color: AppColors.textWhite),
                      decoration: InputDecoration(
                        hintText: "Search subjects...",
                        hintStyle: const TextStyle(color: AppColors.textWhite38),
                        prefixIcon: const Icon(Icons.search, color: AppColors.textWhite54),
                        filled: true,
                        fillColor: Colors.black12,
                        border: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: BorderSide.none),
                      ),
                    ),
                    const SizedBox(height: 12),
                    Expanded(
                      child: ListView.builder(
                        itemCount: filteredSubjects.length,
                        itemBuilder: (context, index) {
                          final subject = filteredSubjects[index];
                          final isSelected = tempSelected.contains(subject);
                          return CheckboxListTile(
                            title: Text(subject, style: const TextStyle(color: AppColors.textWhite70)),
                            value: isSelected,
                            activeColor: AppColors.primaryBlue,
                            checkColor: AppColors.textWhite,
                            contentPadding: EdgeInsets.zero,
                            onChanged: (val) {
                              setState(() {
                                if (val == true) {
                                  tempSelected.add(subject);
                                } else {
                                  tempSelected.remove(subject);
                                }
                              });
                            },
                          );
                        },
                      ),
                    ),
                  ],
                ),
              ),
              actions: [
                TextButton(
                  onPressed: () => Navigator.pop(context),
                  child: const Text("Cancel", style: TextStyle(color: AppColors.textGrey)),
                ),
                ElevatedButton(
                  onPressed: () {
                    this.setState(() => _selectedSubjects = tempSelected);
                    Navigator.pop(context);
                  },
                  style: ElevatedButton.styleFrom(backgroundColor: AppColors.primaryBlue),
                  child: const Text("Confirm", style: TextStyle(color: AppColors.textWhite)),
                ),
              ],
            );
          }
        );
      },
    );
  }

  // --- UI BUILD ---

  @override
  Widget build(BuildContext context) {
    return Dialog(
      backgroundColor: Colors.transparent,
      insetPadding: const EdgeInsets.all(24),
      child: Container(
        width: 1100,
        height: 800,
        decoration: BoxDecoration(
          color: AppColors.backgroundBlack,
          borderRadius: BorderRadius.circular(16),
          border: Border.all(color: AppColors.surfaceLightGrey),
          boxShadow: [
            BoxShadow(color: Colors.black.withValues(alpha: 0.5), blurRadius: 20, offset: const Offset(0, 10))
          ],
        ),
        child: Column(
          children: [
            // --- HEADER ---
            Padding(
              padding: const EdgeInsets.symmetric(horizontal: 32, vertical: 24),
              child: Row(
                children: [
                  Container(
                    padding: const EdgeInsets.all(8),
                    decoration: BoxDecoration(
                      color: AppColors.primaryBlue.withValues(alpha: 0.2), 
                      borderRadius: BorderRadius.circular(8)
                    ),
                    child: const Icon(Icons.person_add, color: AppColors.primaryBlue),
                  ),
                  const SizedBox(width: 16),
                  const Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text("Register Student", style: TextStyle(color: AppColors.textWhite, fontSize: 18, fontWeight: FontWeight.bold)),
                      Text("Add new student details to the database", style: TextStyle(color: AppColors.textGrey, fontSize: 13)),
                    ],
                  ),
                  const Spacer(),
                  IconButton(
                    onPressed: () => Navigator.pop(context),
                    icon: const Icon(Icons.close, color: AppColors.textGrey),
                  ),
                ],
              ),
            ),
            const Divider(height: 1, color: AppColors.divider),

            // --- MAIN CONTENT ---
            Expanded(
              child: Row(
                children: [
                  // --- LEFT: FORM (Flex 5) ---
                  Expanded(
                    flex: 5,
                    child: Padding(
                      padding: const EdgeInsets.all(32),
                      child: Form(
                        key: _formKey,
                        child: SingleChildScrollView(
                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              const Text("STUDENT DETAILS", style: TextStyle(color: AppColors.textGrey, fontSize: 12, fontWeight: FontWeight.bold, letterSpacing: 1.2)),
                              const SizedBox(height: 24),

                              _buildLabel("Full Name", AppColors.textWhite),
                              _buildTextField(
                                controller: _fullNameController,
                                hint: "e.g. Gabriel",
                                prefixIcon: Icons.person_outline,
                              ),
                              const SizedBox(height: 16),

                              Row(
                                children: [
                                  Expanded(
                                    child: Column(
                                      crossAxisAlignment: CrossAxisAlignment.start,
                                      children: [
                                        _buildLabel("Student ID", AppColors.textWhite),
                                        _buildTextField(
                                          controller: _studentIdController,
                                          hint: "STU-...",
                                          suffixIcon: Icons.refresh,
                                          onSuffixTap: _generateNewId,
                                        ),
                                      ],
                                    ),
                                  ),
                                  const SizedBox(width: 16),
                                  Expanded(
                                    child: Column(
                                      crossAxisAlignment: CrossAxisAlignment.start,
                                      children: [
                                        _buildLabel("Grade", AppColors.textWhite),
                                        _buildDropdown(
                                          value: _selectedGrade,
                                          items: _grades,
                                          onChanged: (v) => setState(() => _selectedGrade = v!),
                                        ),
                                      ],
                                    ),
                                  ),
                                ],
                              ),
                              const SizedBox(height: 16),

                              Row(
                                children: [
                                  Expanded(
                                    child: Column(
                                      crossAxisAlignment: CrossAxisAlignment.start,
                                      children: [
                                        _buildLabel("Date of Birth", AppColors.textWhite),
                                        _buildDatePicker(context, _dob, (d) => setState(() => _dob = d)),
                                      ],
                                    ),
                                  ),
                                  const SizedBox(width: 16),
                                  Expanded(
                                    child: Column(
                                      crossAxisAlignment: CrossAxisAlignment.start,
                                      children: [
                                        _buildLabel("Gender", AppColors.textWhite),
                                        _buildDropdown(
                                          value: _selectedGender,
                                          items: _genders,
                                          onChanged: (v) => setState(() => _selectedGender = v!),
                                        ),
                                      ],
                                    ),
                                  ),
                                ],
                              ),
                              const SizedBox(height: 24),

                              const Text("CONTACT & FINANCIAL", style: TextStyle(color: AppColors.textGrey, fontSize: 12, fontWeight: FontWeight.bold, letterSpacing: 1.2)),
                              const SizedBox(height: 24),

                              Row(
                                children: [
                                  Expanded(
                                    child: Column(
                                      crossAxisAlignment: CrossAxisAlignment.start,
                                      children: [
                                        _buildLabel("Parent Contact", AppColors.textWhite),
                                        _buildTextField(
                                          controller: _parentContactController,
                                          hint: "+263 7...",
                                          prefixIcon: Icons.phone_outlined,
                                        ),
                                      ],
                                    ),
                                  ),
                                  const SizedBox(width: 16),
                                  Expanded(
                                    child: Column(
                                      crossAxisAlignment: CrossAxisAlignment.start,
                                      children: [
                                        _buildLabel("Billing Type", AppColors.textWhite),
                                        Container(
                                          height: 52, // Match input height
                                          decoration: BoxDecoration(
                                            color: AppColors.surfaceGrey,
                                            borderRadius: BorderRadius.circular(8),
                                            border: Border.all(color: AppColors.surfaceLightGrey),
                                          ),
                                          padding: const EdgeInsets.all(4),
                                          child: Row(
                                            children: ['monthly', 'termly'].map((type) {
                                              final isSelected = _billingType == type;
                                              return Expanded(
                                                child: GestureDetector(
                                                  onTap: () => setState(() => _billingType = type),
                                                  child: Container(
                                                    decoration: BoxDecoration(
                                                      color: isSelected ? AppColors.primaryBlue : Colors.transparent,
                                                      borderRadius: BorderRadius.circular(6),
                                                    ),
                                                    alignment: Alignment.center,
                                                    child: Text(
                                                      type.toUpperCase(),
                                                      style: TextStyle(
                                                        fontSize: 12, 
                                                        fontWeight: FontWeight.bold, 
                                                        color: isSelected ? AppColors.textWhite : AppColors.textGrey
                                                      ),
                                                    ),
                                                  ),
                                                ),
                                              );
                                            }).toList(),
                                          ),
                                        ),
                                      ],
                                    ),
                                  ),
                                ],
                              ),
                              const SizedBox(height: 16),

                              _buildLabel("Address", AppColors.textWhite),
                              _buildTextField(
                                controller: _addressController,
                                hint: "Street address...",
                                prefixIcon: Icons.location_on_outlined,
                              ),
                              const SizedBox(height: 16),

                              Row(
                                children: [
                                  Expanded(
                                    child: Column(
                                      crossAxisAlignment: CrossAxisAlignment.start,
                                      children: [
                                        _buildLabel("Tuition Fee", AppColors.textWhite),
                                        _buildTextField(
                                          controller: _feeController,
                                          hint: "0.00",
                                          prefix: "\$ ",
                                          isNumber: true,
                                        ),
                                      ],
                                    ),
                                  ),
                                  const SizedBox(width: 16),
                                  Expanded(
                                    child: Column(
                                      crossAxisAlignment: CrossAxisAlignment.start,
                                      children: [
                                        _buildLabel("Initial Payment", AppColors.textWhite),
                                        _buildTextField(
                                          controller: _initialPayController,
                                          hint: "0.00",
                                          prefix: "\$ ",
                                          isNumber: true,
                                        ),
                                      ],
                                    ),
                                  ),
                                ],
                              ),
                              const SizedBox(height: 16),

                              _buildLabel("Subjects", AppColors.textWhite),
                              InkWell(
                                onTap: _openSubjectSelector,
                                child: Container(
                                  padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 14),
                                  decoration: BoxDecoration(
                                    color: AppColors.surfaceGrey,
                                    borderRadius: BorderRadius.circular(8),
                                    border: Border.all(color: AppColors.surfaceLightGrey),
                                  ),
                                  child: Row(
                                    mainAxisAlignment: MainAxisAlignment.spaceBetween,
                                    children: [
                                      Text(
                                        _selectedSubjects.isEmpty ? "Select Subjects..." : "${_selectedSubjects.length} subjects selected",
                                        style: TextStyle(color: _selectedSubjects.isEmpty ? AppColors.textWhite54 : AppColors.textWhite),
                                      ),
                                      const Icon(Icons.arrow_drop_down, color: AppColors.textWhite54),
                                    ],
                                  ),
                                ),
                              ),
                              if (_selectedSubjects.isNotEmpty) ...[
                                const SizedBox(height: 8),
                                Wrap(
                                  spacing: 8,
                                  runSpacing: 8,
                                  children: _selectedSubjects.take(5).map((s) => Chip(
                                    label: Text(s, style: const TextStyle(fontSize: 10, color: AppColors.textWhite)),
                                    backgroundColor: AppColors.primaryBlue.withValues(alpha: 0.2),
                                    padding: EdgeInsets.zero,
                                    side: BorderSide.none,
                                  )).toList(),
                                ),
                              ],
                            ],
                          ),
                        ),
                      ),
                    ),
                  ),

                  const VerticalDivider(width: 1, color: AppColors.divider),

                  // --- RIGHT: LIST (Flex 4) ---
                  Expanded(
                    flex: 4,
                    child: Container(
                      color: AppColors.surfaceDarkGrey, 
                      padding: const EdgeInsets.all(24),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Row(
                            mainAxisAlignment: MainAxisAlignment.spaceBetween,
                            children: [
                              const Text("RECENTLY ADDED", style: TextStyle(color: AppColors.textGrey, fontSize: 12, fontWeight: FontWeight.bold, letterSpacing: 1.2)),
                              StreamBuilder<List<Map<String, dynamic>>>(
                                stream: _dbService.watchStudents(widget.schoolId), 
                                builder: (context, snapshot) {
                                  final count = snapshot.data?.length ?? 0;
                                  return Text("$count Total", style: const TextStyle(color: AppColors.textWhite, fontWeight: FontWeight.bold));
                                }
                              ),
                            ],
                          ),
                          const SizedBox(height: 24),
                          Expanded(
                            child: StreamBuilder<List<Map<String, dynamic>>>(
                              stream: _dbService.db.watch('SELECT * FROM students WHERE school_id = ? ORDER BY created_at DESC', parameters: [widget.schoolId]),
                              builder: (context, snapshot) {
                                if (!snapshot.hasData) return const Center(child: CircularProgressIndicator());
                                final students = snapshot.data ?? [];
                                if (students.isEmpty) return const Center(child: Text("No students yet.", style: TextStyle(color: AppColors.textGrey)));

                                return ListView.separated(
                                  itemCount: students.length,
                                  separatorBuilder: (_, __) => const SizedBox(height: 12),
                                  itemBuilder: (context, index) {
                                    final s = students[index];
                                    final name = s['full_name'] ?? 'Unknown';
                                    final id = s['student_id'] ?? 'N/A';
                                    final grade = s['grade'] ?? 'N/A';
                                    
                                    return Container(
                                      padding: const EdgeInsets.all(16),
                                      decoration: BoxDecoration(
                                        color: AppColors.surfaceGrey, 
                                        borderRadius: BorderRadius.circular(12),
                                        border: Border.all(color: Colors.white.withValues(alpha: 0.05)),
                                      ),
                                      child: Row(
                                        children: [
                                          CircleAvatar(
                                            backgroundColor: AppColors.primaryBlue.withValues(alpha: 0.1),
                                            child: Text(
                                              name.isNotEmpty ? name[0].toUpperCase() : '?',
                                              style: const TextStyle(color: AppColors.primaryBlue, fontWeight: FontWeight.bold)
                                            ),
                                          ),
                                          const SizedBox(width: 16),
                                          Expanded(
                                            child: Column(
                                              crossAxisAlignment: CrossAxisAlignment.start,
                                              children: [
                                                Text(name, style: const TextStyle(color: AppColors.textWhite, fontWeight: FontWeight.bold)),
                                                const SizedBox(height: 2),
                                                Text("$id ‚Ä¢ $grade", style: const TextStyle(color: AppColors.textGrey, fontSize: 12)),
                                              ],
                                            ),
                                          ),
                                        ],
                                      ),
                                    );
                                  },
                                );
                              },
                            ),
                          ),
                        ],
                      ),
                    ),
                  ),
                ],
              ),
            ),
            
            const Divider(height: 1, color: AppColors.divider),

            // --- FOOTER ---
            Padding(
              padding: const EdgeInsets.all(24),
              child: Row(
                mainAxisAlignment: MainAxisAlignment.end,
                children: [
                  TextButton(
                    onPressed: () => Navigator.of(context).pop(),
                    child: const Text("Cancel", style: TextStyle(color: AppColors.textWhite70)),
                  ),
                  const SizedBox(width: 16),
                  ElevatedButton.icon(
                    onPressed: _isLoading ? null : _saveStudent,
                    style: ElevatedButton.styleFrom(
                      backgroundColor: AppColors.primaryBlue,
                      padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 16),
                      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
                      foregroundColor: AppColors.textWhite,
                    ),
                    icon: _isLoading 
                      ? const SizedBox(width: 16, height: 16, child: CircularProgressIndicator(strokeWidth: 2, color: AppColors.textWhite)) 
                      : const Icon(Icons.check, size: 18),
                    label: Text(_isLoading ? "Saving..." : "Save Student", style: const TextStyle(fontWeight: FontWeight.bold)),
                  ),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }

  // --- WIDGET HELPERS ---

  Widget _buildLabel(String text, Color color) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 8.0),
      child: Text(text, style: TextStyle(color: color.withValues(alpha: 0.9), fontSize: 14, fontWeight: FontWeight.w500)),
    );
  }

  Widget _buildTextField({
    required TextEditingController controller,
    required String hint,
    String? prefix, IconData? prefixIcon, IconData? suffixIcon, VoidCallback? onSuffixTap,
    bool isNumber = false,
  }) {
    return TextFormField(
      controller: controller,
      keyboardType: isNumber ? const TextInputType.numberWithOptions(decimal: true) : TextInputType.text,
      validator: (val) => val == null || val.isEmpty ? 'Required' : null,
      style: const TextStyle(color: AppColors.textWhite),
      decoration: InputDecoration(
        filled: true, 
        fillColor: AppColors.surfaceGrey, 
        hintText: hint,
        hintStyle: TextStyle(color: AppColors.textWhite.withValues(alpha: 0.3)),
        prefixText: prefix, prefixStyle: const TextStyle(color: AppColors.textWhite, fontWeight: FontWeight.bold),
        prefixIcon: prefixIcon != null ? Icon(prefixIcon, color: AppColors.textWhite54, size: 20) : null,
        suffixIcon: suffixIcon != null 
          ? GestureDetector(onTap: onSuffixTap, child: Icon(suffixIcon, color: AppColors.textWhite54, size: 20)) 
          : null,
        border: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.surfaceLightGrey)),
        enabledBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.surfaceLightGrey)),
        contentPadding: const EdgeInsets.symmetric(horizontal: 16, vertical: 16),
      ),
    );
  }

  Widget _buildDropdown({
    required String value, required List<String> items,
    required Function(String?) onChanged,
  }) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 16),
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey, borderRadius: BorderRadius.circular(8),
        border: Border.all(color: AppColors.surfaceLightGrey),
      ),
      child: DropdownButtonHideUnderline(
        child: DropdownButton<String>(
          value: value,
          dropdownColor: AppColors.surfaceGrey, 
          icon: const Icon(Icons.keyboard_arrow_down, color: AppColors.textWhite54),
          isExpanded: true, 
          style: const TextStyle(color: AppColors.textWhite),
          items: items.map((e) => DropdownMenuItem(value: e, child: Text(e))).toList(),
          onChanged: onChanged,
        ),
      ),
    );
  }

  Widget _buildDatePicker(BuildContext context, DateTime initial, Function(DateTime) onPicked) {
    return GestureDetector(
      onTap: () async {
        final picked = await showDatePicker(
          context: context,
          initialDate: initial,
          firstDate: DateTime(1990),
          lastDate: DateTime(2030),
          builder: (context, child) => Theme(
            data: ThemeData.dark().copyWith(
              colorScheme: const ColorScheme.dark(
                primary: AppColors.primaryBlue, 
                onPrimary: AppColors.textWhite, 
                surface: AppColors.surfaceGrey
              ),
            ),
            child: child!,
          ),
        );
        if (picked != null) onPicked(picked);
      },
      child: Container(
        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 14),
        decoration: BoxDecoration(
          color: AppColors.surfaceGrey, borderRadius: BorderRadius.circular(8),
          border: Border.all(color: AppColors.surfaceLightGrey),
        ),
        child: Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            Text(DateFormat('MMM dd, yyyy').format(initial), style: const TextStyle(color: AppColors.textWhite)),
            const Icon(Icons.calendar_today_outlined, size: 18, color: AppColors.textWhite54),
          ],
        ),
      ),
    );
  }
}
// ==========================================
// FILE: ./pc/widgets/dashboard/campaign_dialog.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:intl/intl.dart';

import '../../../core/constants/app_colors.dart';
import '../../../data/providers/campaign_provider.dart';
import '../../../data/models/fundraiser_models.dart';

class CampaignDialog extends ConsumerStatefulWidget {
  final String schoolId;
  const CampaignDialog({super.key, required this.schoolId});

  @override
  ConsumerState<CampaignDialog> createState() => _CampaignDialogState();
}

class _CampaignDialogState extends ConsumerState<CampaignDialog> {
  final _formKey = GlobalKey<FormState>();
  
  // Controllers
  final _nameController = TextEditingController();
  final _goalController = TextEditingController();
  final _descController = TextEditingController();

  String _selectedType = 'Infrastructure';
  bool _forceCreateMode = false; // Toggle to override the "Active Campaign" warning

  @override
  void dispose() {
    _nameController.dispose();
    _goalController.dispose();
    _descController.dispose();
    super.dispose();
  }

  // --- ACTIONS ---

  Future<void> _submitCreate() async {
    if (!_formKey.currentState!.validate()) return;

    // Trigger the provider to create the campaign
    final success = await ref.read(campaignControllerProvider.notifier).createCampaign(
      schoolId: widget.schoolId,
      name: _nameController.text.trim(),
      goal: double.tryParse(_goalController.text.trim()) ?? 0.0,
      description: _descController.text.trim(),
      type: _selectedType,
    );

    if (success && mounted) {
      Navigator.of(context).pop();
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text("Campaign Launched Successfully"), 
          backgroundColor: AppColors.successGreen
        ),
      );
    }
  }

  Future<void> _closeExisting(String id) async {
    final success = await ref.read(campaignControllerProvider.notifier).closeCampaign(id);
    if (success && mounted) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text("Campaign Closed."), 
          backgroundColor: AppColors.primaryBlue
        ),
      );
      // Logic: The provider stream will update automatically, 
      // removing the active campaign and showing the form.
    }
  }

  // --- MAIN BUILD ---

  @override
  Widget build(BuildContext context) {
    final activeCampaignAsync = ref.watch(activeCampaignProvider(widget.schoolId));
    final controllerState = ref.watch(campaignControllerProvider);

    return Dialog(
      backgroundColor: Colors.transparent,
      insetPadding: const EdgeInsets.all(24),
      child: Container(
        width: 700,
        height: 800,
        decoration: BoxDecoration(
          color: AppColors.backgroundBlack,
          borderRadius: BorderRadius.circular(16),
          border: Border.all(color: AppColors.divider),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withValues(alpha: 0.5), 
              blurRadius: 20, 
              offset: const Offset(0, 10)
            )
          ],
        ),
        child: Column(
          children: [
            _buildHeader(),
            const Divider(height: 1, color: AppColors.divider),

            Expanded(
              child: activeCampaignAsync.when(
                loading: () => const Center(child: CircularProgressIndicator(color: AppColors.primaryBlue)),
                error: (e, _) => Center(child: Text("Error: $e", style: const TextStyle(color: AppColors.errorRed))),
                data: (existingCampaign) {
                  // If we have an active campaign AND we haven't forced "Create Mode"
                  if (existingCampaign != null && !_forceCreateMode) {
                    return _buildActiveCampaignWarning(existingCampaign, controllerState.isLoading);
                  }
                  // Otherwise show the form
                  return _buildCreateForm(controllerState.isLoading, existingCampaign != null);
                },
              ),
            ),
          ],
        ),
      ),
    );
  }

  // --- UI COMPONENTS ---

  Widget _buildHeader() {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 32, vertical: 24),
      child: Row(
        children: [
          Container(
            padding: const EdgeInsets.all(8),
            decoration: BoxDecoration(
              color: AppColors.accentPurple.withValues(alpha: 0.2), 
              borderRadius: BorderRadius.circular(8)
            ),
            child: const Icon(Icons.campaign, color: AppColors.accentPurple),
          ),
          const SizedBox(width: 16),
          const Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text("Campaign Manager", 
                style: TextStyle(color: AppColors.textWhite, fontSize: 18, fontWeight: FontWeight.bold)),
              Text("Fundraising & Projects", 
                style: TextStyle(color: AppColors.textWhite54, fontSize: 13)),
            ],
          ),
          const Spacer(),
          IconButton(
            onPressed: () => Navigator.of(context).pop(),
            icon: const Icon(Icons.close, color: AppColors.textGrey),
          ),
        ],
      ),
    );
  }

  Widget _buildActiveCampaignWarning(Campaign campaign, bool isLoading) {
    return Padding(
      padding: const EdgeInsets.all(32),
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Container(
            padding: const EdgeInsets.all(24),
            decoration: BoxDecoration(
              color: AppColors.warningOrange.withValues(alpha: 0.1),
              borderRadius: BorderRadius.circular(16),
              border: Border.all(color: AppColors.warningOrange.withValues(alpha: 0.3)),
            ),
            child: const Column(
              children: [
                Icon(Icons.warning_amber_rounded, size: 48, color: AppColors.warningOrange),
                SizedBox(height: 16),
                Text(
                  "Active Campaign Detected",
                  style: TextStyle(color: AppColors.warningOrange, fontSize: 20, fontWeight: FontWeight.bold),
                ),
                SizedBox(height: 8),
                Text(
                  "We recommend closing the current campaign before starting a new one to prevent data distortion.",
                  textAlign: TextAlign.center,
                  style: TextStyle(color: AppColors.textWhite70, height: 1.5),
                ),
              ],
            ),
          ),
          const SizedBox(height: 32),
          
          // Current Campaign Card
          Container(
            width: double.infinity,
            padding: const EdgeInsets.all(24),
            decoration: BoxDecoration(
              color: AppColors.surfaceGrey,
              borderRadius: BorderRadius.circular(12),
              border: Border.all(color: AppColors.divider),
            ),
            child: Row(
              children: [
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      const Text("RUNNING NOW", style: TextStyle(color: AppColors.textWhite54, fontSize: 11, fontWeight: FontWeight.bold)),
                      const SizedBox(height: 8),
                      Text(campaign.name, style: const TextStyle(color: AppColors.textWhite, fontSize: 22, fontWeight: FontWeight.bold)),
                      const SizedBox(height: 4),
                      Text("Goal: \$${NumberFormat().format(campaign.goalAmount)} ‚Ä¢ Type: ${campaign.type}", 
                        style: const TextStyle(color: AppColors.primaryBlueLight)),
                    ],
                  ),
                ),
                if (!isLoading)
                  ElevatedButton.icon(
                    onPressed: () => _closeExisting(campaign.id),
                    style: ElevatedButton.styleFrom(
                      backgroundColor: AppColors.errorRed,
                      foregroundColor: Colors.white,
                      padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 16),
                    ),
                    icon: const Icon(Icons.archive, size: 18),
                    label: const Text("Close This Campaign"),
                  ),
              ],
            ),
          ),

          const Spacer(),

          // Buttons
          Row(
            mainAxisAlignment: MainAxisAlignment.end,
            children: [
              TextButton(
                onPressed: () => Navigator.pop(context),
                child: const Text("Back", style: TextStyle(color: AppColors.textWhite70)),
              ),
              const SizedBox(width: 16),
              // THE "SCHOOL'S CONCERN" OPTION
              TextButton.icon(
                onPressed: () {
                  setState(() {
                    _forceCreateMode = true;
                  });
                },
                icon: const Icon(Icons.add_circle_outline, color: AppColors.warningOrange, size: 18),
                label: const Text("Start Concurrent Campaign (Advanced)", style: TextStyle(color: AppColors.warningOrange)),
              ),
            ],
          ),
        ],
      ),
    );
  }

  Widget _buildCreateForm(bool isLoading, bool isConcurrent) {
    return Padding(
      padding: const EdgeInsets.all(32),
      child: Form(
        key: _formKey,
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                const Text("START NEW CAMPAIGN", style: TextStyle(color: AppColors.textGrey, fontSize: 12, fontWeight: FontWeight.bold, letterSpacing: 1.2)),
                if (isConcurrent)
                  Container(
                    padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                    decoration: BoxDecoration(color: AppColors.warningOrange.withValues(alpha: 0.2), borderRadius: BorderRadius.circular(4)),
                    child: const Text("CONCURRENT MODE", style: TextStyle(color: AppColors.warningOrange, fontSize: 10, fontWeight: FontWeight.bold)),
                  )
              ],
            ),
            const SizedBox(height: 24),

            _buildLabel("Campaign Name"),
            _buildTextField(
              controller: _nameController,
              hint: "e.g. New Science Block 2025",
              validator: (v) => v!.isEmpty ? "Required" : null,
            ),
            const SizedBox(height: 16),

            Row(
              children: [
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      _buildLabel("Goal Amount"),
                      _buildTextField(
                        controller: _goalController,
                        hint: "0.00",
                        prefix: "\$ ",
                        inputType: const TextInputType.numberWithOptions(decimal: true),
                        validator: (v) {
                          if (v == null || v.isEmpty) return "Required";
                          if (double.tryParse(v) == null) return "Invalid";
                          return null;
                        },
                      ),
                    ],
                  ),
                ),
                const SizedBox(width: 16),
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      _buildLabel("Type"),
                      _buildDropdown(
                        value: _selectedType,
                        items: ["Infrastructure", "Event", "Charity", "Sports", "General"],
                        onChanged: (val) => setState(() => _selectedType = val!),
                      ),
                    ],
                  ),
                ),
              ],
            ),
            const SizedBox(height: 16),

            _buildLabel("Description / Purpose"),
            _buildTextField(
              controller: _descController,
              hint: "Describe the purpose of this fundraising...",
              maxLines: 4,
            ),

            const Spacer(),

            // Footer
            Row(
              mainAxisAlignment: MainAxisAlignment.end,
              children: [
                TextButton(
                  onPressed: () {
                    if (_forceCreateMode) {
                      setState(() => _forceCreateMode = false); // Go back to warning
                    } else {
                      Navigator.of(context).pop();
                    }
                  },
                  child: const Text("Cancel", style: TextStyle(color: AppColors.textWhite70)),
                ),
                const SizedBox(width: 16),
                ElevatedButton.icon(
                  onPressed: isLoading ? null : _submitCreate,
                  style: ElevatedButton.styleFrom(
                    backgroundColor: AppColors.primaryBlue,
                    foregroundColor: Colors.white,
                    padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 16),
                    shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
                  ),
                  icon: isLoading 
                    ? const SizedBox(width: 16, height: 16, child: CircularProgressIndicator(strokeWidth: 2, color: Colors.white)) 
                    : const Icon(Icons.rocket_launch, size: 18),
                  label: Text(isLoading ? "Launching..." : "Launch Campaign", style: const TextStyle(fontWeight: FontWeight.bold)),
                ),
              ],
            ),
          ],
        ),
      ),
    );
  }

  // --- UI HELPERS ---
  
  Widget _buildLabel(String text) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 8.0),
      child: Text(text, style: TextStyle(color: AppColors.textWhite.withValues(alpha: 0.9), fontSize: 14, fontWeight: FontWeight.w500)),
    );
  }

  Widget _buildTextField({
    required TextEditingController controller,
    required String hint,
    String? prefix,
    int maxLines = 1,
    TextInputType inputType = TextInputType.text,
    String? Function(String?)? validator,
  }) {
    return TextFormField(
      controller: controller, maxLines: maxLines, keyboardType: inputType,
      validator: validator,
      style: const TextStyle(color: AppColors.textWhite),
      decoration: InputDecoration(
        filled: true, fillColor: AppColors.surfaceGrey, hintText: hint,
        hintStyle: TextStyle(color: AppColors.textWhite.withValues(alpha: 0.3)),
        prefixText: prefix, prefixStyle: const TextStyle(color: AppColors.textWhite, fontWeight: FontWeight.bold),
        border: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.divider)),
        enabledBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.divider)),
        focusedBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.primaryBlue)),
      ),
    );
  }

  Widget _buildDropdown({
    required String value, required List<String> items,
    required Function(String?) onChanged,
  }) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 16),
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey, borderRadius: BorderRadius.circular(8),
        border: Border.all(color: AppColors.divider),
      ),
      child: DropdownButtonHideUnderline(
        child: DropdownButton<String>(
          value: value,
          dropdownColor: AppColors.surfaceGrey,
          icon: const Icon(Icons.keyboard_arrow_down, color: AppColors.textWhite54),
          isExpanded: true, style: const TextStyle(color: AppColors.textWhite),
          items: items.map((e) => DropdownMenuItem(value: e, child: Text(e))).toList(),
          onChanged: onChanged,
        ),
      ),
    );
  }
}
// ==========================================
// FILE: ./pc/widgets/dashboard/payment_dialog.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:intl/intl.dart';
import 'package:uuid/uuid.dart';

import '../../../../core/constants/app_colors.dart';
import '../../../../data/services/database_service.dart';

class PaymentDialog extends ConsumerStatefulWidget {
  final String schoolId;
  
  const PaymentDialog({
    super.key, 
    required this.schoolId,
  });

  @override
  ConsumerState<PaymentDialog> createState() => _PaymentDialogState();
}

class _PaymentDialogState extends ConsumerState<PaymentDialog> {
  final _formKey = GlobalKey<FormState>();
  final DatabaseService _dbService = DatabaseService();

  // Controllers
  final TextEditingController _amountController = TextEditingController();
  final TextEditingController _payerController = TextEditingController();
  
  // State Variables
  String? _selectedStudentId; // Stores the valid UUID
  DateTime _selectedDate = DateTime.now();
  String _selectedMethod = 'Cash';
  String _selectedCategory = 'Tuition';
  bool _isLoading = false;

  // Constants
  final List<String> _methods = ['Cash', 'Bank Transfer', 'Mobile Money', 'Cheque'];
  final List<String> _categories = ['Tuition', 'Uniform', 'Levy', 'Transport', 'Donation'];

  @override
  void dispose() {
    _amountController.dispose();
    _payerController.dispose();
    super.dispose();
  }

  // --- LOGIC ---

  Future<void> _savePayment() async {
    if (!_formKey.currentState!.validate()) return;
    
    // Validation: Ensure a student was actually selected from the list
    if (_selectedStudentId == null) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text('Please search and select a valid student from the list'), 
          backgroundColor: AppColors.errorRed
        ),
      );
      return;
    }

    setState(() => _isLoading = true);

    try {
      final newId = const Uuid().v4();
      final amount = double.tryParse(_amountController.text) ?? 0.0;

      final paymentData = {
        'id': newId,
        'school_id': widget.schoolId,
        'student_id': _selectedStudentId, // Valid UUID from autocomplete
        'amount': amount,
        'date_paid': DateFormat('yyyy-MM-dd').format(_selectedDate),
        'category': _selectedCategory,
        'payer_name': _payerController.text.trim(),
        'method': _selectedMethod,
        'created_at': DateTime.now().toIso8601String(),
      };

      await _dbService.insert('payments', paymentData);

      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
            content: Text('Payment recorded successfully!'),
            backgroundColor: AppColors.successGreen,
          ),
        );
        Navigator.of(context).pop(); 
      }
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text('Error: $e'), backgroundColor: AppColors.errorRed),
        );
      }
    } finally {
      if (mounted) setState(() => _isLoading = false);
    }
  }

  // --- UI BUILD ---

  @override
  Widget build(BuildContext context) {
    return Dialog(
      backgroundColor: Colors.transparent,
      insetPadding: const EdgeInsets.all(24),
      child: Container(
        width: 1100,
        height: 700,
        decoration: BoxDecoration(
          color: AppColors.backgroundBlack,
          borderRadius: BorderRadius.circular(16),
          border: Border.all(color: AppColors.surfaceLightGrey),
          boxShadow: [
            BoxShadow(color: Colors.black.withValues(alpha: 0.5), blurRadius: 20, offset: const Offset(0, 10))
          ],
        ),
        child: Column(
          children: [
            // --- HEADER ---
            Padding(
              padding: const EdgeInsets.symmetric(horizontal: 32, vertical: 24),
              child: Row(
                children: [
                  Container(
                    padding: const EdgeInsets.all(8),
                    decoration: BoxDecoration(
                      color: AppColors.primaryBlue.withValues(alpha: 0.2),
                      borderRadius: BorderRadius.circular(8),
                    ),
                    child: const Icon(Icons.account_balance_wallet, color: AppColors.primaryBlue),
                  ),
                  const SizedBox(width: 16),
                  const Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text("Manage Payments", style: TextStyle(color: AppColors.textWhite, fontSize: 18, fontWeight: FontWeight.bold)),
                      Text("Record incoming fees and track recent transactions", style: TextStyle(color: AppColors.textGrey, fontSize: 13)),
                    ],
                  ),
                  const Spacer(),
                  IconButton(
                    onPressed: () => Navigator.pop(context),
                    icon: const Icon(Icons.close, color: AppColors.textGrey),
                  ),
                ],
              ),
            ),
            const Divider(height: 1, color: AppColors.divider),
            
            // --- BODY (Split View) ---
            Expanded(
              child: Row(
                children: [
                  // --- LEFT: FORM SECTION (Flex 4) ---
                  Expanded(
                    flex: 4,
                    child: Padding(
                      padding: const EdgeInsets.all(32),
                      child: Form(
                        key: _formKey,
                        child: SingleChildScrollView(
                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              const Text("NEW PAYMENT ENTRY", style: TextStyle(color: AppColors.textGrey, fontSize: 12, fontWeight: FontWeight.bold, letterSpacing: 1.2)),
                              const SizedBox(height: 24),

                              // --- SEARCHABLE STUDENT FIELD ---
                              _buildLabel("Student (Search Name or ID)", AppColors.textWhite),
                              StreamBuilder<List<Map<String, dynamic>>>(
                                stream: _dbService.watchStudents(widget.schoolId),
                                builder: (context, snapshot) {
                                  if (!snapshot.hasData) {
                                    return const LinearProgressIndicator(color: AppColors.primaryBlue, backgroundColor: AppColors.surfaceGrey);
                                  }
                                  
                                  final students = snapshot.data!;
                                  
                                  return LayoutBuilder(
                                    builder: (context, constraints) {
                                      return Autocomplete<Map<String, dynamic>>(
                                        optionsBuilder: (TextEditingValue textEditingValue) {
                                          if (textEditingValue.text.isEmpty) {
                                            return students;
                                          }
                                          return students.where((student) {
                                            final name = student['full_name'].toString().toLowerCase();
                                            final id = (student['student_id'] ?? '').toString().toLowerCase();
                                            final query = textEditingValue.text.toLowerCase();
                                            return name.contains(query) || id.contains(query);
                                          });
                                        },
                                        displayStringForOption: (Map<String, dynamic> option) => 
                                            "${option['full_name']} (${option['student_id'] ?? 'N/A'})",
                                        
                                        onSelected: (Map<String, dynamic> selection) {
                                          setState(() {
                                            _selectedStudentId = selection['id'];
                                          });
                                        },

                                        // The Input Field
                                        fieldViewBuilder: (context, textEditingController, focusNode, onFieldSubmitted) {
                                          return TextFormField(
                                            controller: textEditingController,
                                            focusNode: focusNode,
                                            style: const TextStyle(color: AppColors.textWhite),
                                            decoration: InputDecoration(
                                              filled: true,
                                              fillColor: AppColors.surfaceGrey,
                                              hintText: "Type to search...",
                                              hintStyle: TextStyle(color: AppColors.textWhite.withValues(alpha: 0.3)),
                                              prefixIcon: const Icon(Icons.search, color: AppColors.textWhite54, size: 20),
                                              border: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.surfaceLightGrey)),
                                              enabledBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.surfaceLightGrey)),
                                              focusedBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.primaryBlue, width: 2)),
                                              contentPadding: const EdgeInsets.symmetric(horizontal: 16, vertical: 16),
                                            ),
                                            onChanged: (text) {
                                              if (_selectedStudentId != null) {
                                                // logic to clear if needed
                                              }
                                            },
                                          );
                                        },

                                        // The Dropdown List Styling
                                        optionsViewBuilder: (context, onSelected, options) {
                                          return Align(
                                            alignment: Alignment.topLeft,
                                            child: Material(
                                              color: AppColors.surfaceGrey,
                                              elevation: 4.0,
                                              borderRadius: const BorderRadius.vertical(bottom: Radius.circular(8)),
                                              child: Container(
                                                width: constraints.maxWidth,
                                                constraints: const BoxConstraints(maxHeight: 250),
                                                decoration: BoxDecoration(
                                                  border: Border.all(color: AppColors.surfaceLightGrey),
                                                  borderRadius: const BorderRadius.vertical(bottom: Radius.circular(8)),
                                                ),
                                                child: ListView.builder(
                                                  padding: EdgeInsets.zero,
                                                  itemCount: options.length,
                                                  itemBuilder: (BuildContext context, int index) {
                                                    final Map<String, dynamic> option = options.elementAt(index);
                                                    return ListTile(
                                                      title: Text(option['full_name'], style: const TextStyle(color: AppColors.textWhite)),
                                                      subtitle: Text(option['student_id'] ?? 'No ID', style: const TextStyle(color: AppColors.textGrey, fontSize: 12)),
                                                      onTap: () => onSelected(option),
                                                      hoverColor: AppColors.textWhite.withValues(alpha: 0.1),
                                                    );
                                                  },
                                                ),
                                              ),
                                            ),
                                          );
                                        },
                                      );
                                    }
                                  );
                                },
                              ),
                              const SizedBox(height: 16),

                              // Amount & Date Row
                              Row(
                                children: [
                                  Expanded(
                                    child: Column(
                                      crossAxisAlignment: CrossAxisAlignment.start,
                                      children: [
                                        _buildLabel("Amount", AppColors.textWhite),
                                        _buildTextInput(
                                          controller: _amountController, 
                                          hint: "0.00", 
                                          isNumber: true,
                                          prefix: "\$ "
                                        ),
                                      ],
                                    ),
                                  ),
                                  const SizedBox(width: 16),
                                  Expanded(
                                    child: Column(
                                      crossAxisAlignment: CrossAxisAlignment.start,
                                      children: [
                                        _buildLabel("Payment Date", AppColors.textWhite),
                                        _buildDatePicker(context, _selectedDate, (d) => setState(() => _selectedDate = d)),
                                      ],
                                    ),
                                  ),
                                ],
                              ),
                              const SizedBox(height: 16),

                              // Category & Method Row
                              Row(
                                children: [
                                  Expanded(
                                    child: Column(
                                      crossAxisAlignment: CrossAxisAlignment.start,
                                      children: [
                                        _buildLabel("Category", AppColors.textWhite),
                                        _buildDropdown(
                                          value: _selectedCategory,
                                          items: _categories,
                                          onChanged: (v) => setState(() => _selectedCategory = v!),
                                        ),
                                      ],
                                    ),
                                  ),
                                  const SizedBox(width: 16),
                                  Expanded(
                                    child: Column(
                                      crossAxisAlignment: CrossAxisAlignment.start,
                                      children: [
                                        _buildLabel("Payment Method", AppColors.textWhite),
                                        _buildDropdown(
                                          value: _selectedMethod,
                                          items: _methods,
                                          onChanged: (v) => setState(() => _selectedMethod = v!),
                                        ),
                                      ],
                                    ),
                                  ),
                                ],
                              ),
                              const SizedBox(height: 16),

                              // Payer Name
                              _buildLabel("Payer Name (Parent/Guardian)", AppColors.textWhite),
                              _buildTextInput(
                                controller: _payerController, 
                                hint: "e.g. Mr. Smith", 
                                prefixIcon: Icons.person_outline
                              ),
                              
                              const SizedBox(height: 40),
                            ],
                          ),
                        ),
                      ),
                    ),
                  ),

                  const VerticalDivider(width: 1, color: AppColors.divider),

                  // --- RIGHT: LIST SECTION (Flex 3) ---
                  Expanded(
                    flex: 3,
                    child: Container(
                      color: AppColors.surfaceDarkGrey,
                      padding: const EdgeInsets.all(24),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Row(
                            mainAxisAlignment: MainAxisAlignment.spaceBetween,
                            children: [
                              const Text("RECENT PAYMENTS", style: TextStyle(color: AppColors.textGrey, fontSize: 12, fontWeight: FontWeight.bold, letterSpacing: 1.2)),
                              StreamBuilder<List<Map<String, dynamic>>>(
                                stream: _dbService.watchAll('payments'), 
                                builder: (context, snapshot) {
                                  if (!snapshot.hasData) return const Text("\$0.00", style: TextStyle(color: AppColors.textWhite, fontWeight: FontWeight.bold));
                                  double total = 0;
                                  for(var p in snapshot.data!) {
                                    total += (p['amount'] as num?)?.toDouble() ?? 0.0;
                                  }
                                  return Text("Total: \$${total.toStringAsFixed(2)}", style: const TextStyle(color: AppColors.textWhite, fontWeight: FontWeight.bold));
                                }
                              ),
                            ],
                          ),
                          const SizedBox(height: 24),

                          // List of Payments
                          Expanded(
                            child: StreamBuilder<List<Map<String, dynamic>>>(
                              stream: _dbService.watchAll('payments'),
                              builder: (context, snapshot) {
                                if (snapshot.connectionState == ConnectionState.waiting) {
                                  return const Center(child: CircularProgressIndicator(color: AppColors.primaryBlue));
                                }
                                
                                final payments = snapshot.data ?? [];
                                
                                if (payments.isEmpty) {
                                  return Center(
                                    child: Column(
                                      mainAxisAlignment: MainAxisAlignment.center,
                                      children: [
                                        Icon(Icons.receipt_long, size: 48, color: AppColors.textGrey.withValues(alpha: 0.2)),
                                        const SizedBox(height: 12),
                                        const Text("No payments recorded yet", style: TextStyle(color: AppColors.textGrey)),
                                      ],
                                    ),
                                  );
                                }

                                return ListView.separated(
                                  itemCount: payments.length,
                                  separatorBuilder: (_, __) => const SizedBox(height: 12),
                                  itemBuilder: (context, index) {
                                    final payment = payments[index];
                                    final amount = (payment['amount'] as num?)?.toDouble() ?? 0.0;
                                    final dateStr = payment['date_paid'] ?? '';
                                    final payer = payment['payer_name'] ?? 'Unknown Payer';
                                    final method = payment['method'] ?? 'Cash';

                                    return Container(
                                      padding: const EdgeInsets.all(16),
                                      decoration: BoxDecoration(
                                        color: AppColors.surfaceGrey,
                                        borderRadius: BorderRadius.circular(12),
                                        border: Border.all(color: Colors.white.withValues(alpha: 0.05)),
                                      ),
                                      child: Row(
                                        children: [
                                          // Icon Box
                                          Container(
                                            width: 40, height: 40,
                                            decoration: BoxDecoration(
                                              color: _getMethodColor(method).withValues(alpha: 0.1),
                                              borderRadius: BorderRadius.circular(8),
                                            ),
                                            child: Icon(
                                              _getMethodIcon(method),
                                              color: _getMethodColor(method),
                                              size: 20,
                                            ),
                                          ),
                                          const SizedBox(width: 12),
                                          
                                          // Details
                                          Expanded(
                                            child: Column(
                                              crossAxisAlignment: CrossAxisAlignment.start,
                                              children: [
                                                Text(payer, style: const TextStyle(color: AppColors.textWhite, fontWeight: FontWeight.bold, fontSize: 14)),
                                                const SizedBox(height: 2),
                                                Text("$method ‚Ä¢ $dateStr", style: const TextStyle(color: AppColors.textGrey, fontSize: 12)),
                                              ],
                                            ),
                                          ),

                                          // Amount
                                          Text(
                                            "+\$${amount.toStringAsFixed(2)}",
                                            style: const TextStyle(color: AppColors.successGreen, fontWeight: FontWeight.bold, fontSize: 14),
                                          ),
                                        ],
                                      ),
                                    );
                                  },
                                );
                              },
                            ),
                          ),
                        ],
                      ),
                    ),
                  ),
                ],
              ),
            ),
            
            const Divider(height: 1, color: AppColors.divider),

            // --- FOOTER ---
            Padding(
              padding: const EdgeInsets.all(24),
              child: Row(
                mainAxisAlignment: MainAxisAlignment.end,
                children: [
                  TextButton(
                    onPressed: () => Navigator.pop(context),
                    child: const Text("Cancel", style: TextStyle(color: AppColors.textWhite70)),
                  ),
                  const SizedBox(width: 16),
                  ElevatedButton.icon(
                    onPressed: _isLoading ? null : _savePayment,
                    style: ElevatedButton.styleFrom(
                      backgroundColor: AppColors.primaryBlue,
                      padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 16),
                      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
                      foregroundColor: AppColors.textWhite,
                    ),
                    icon: _isLoading 
                      ? const SizedBox(width: 16, height: 16, child: CircularProgressIndicator(strokeWidth: 2, color: AppColors.textWhite)) 
                      : const Icon(Icons.check, size: 18),
                    label: Text(_isLoading ? "Saving..." : "Save Payment", style: const TextStyle(fontWeight: FontWeight.bold)),
                  ),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }

  // --- WIDGET BUILDERS (Uniform with StudentDialog) ---

  Widget _buildLabel(String text, Color color) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 8.0),
      child: Text(text, style: TextStyle(color: color.withValues(alpha: 0.9), fontSize: 14, fontWeight: FontWeight.w500)),
    );
  }

  Widget _buildTextInput({
    required TextEditingController controller, 
    required String hint, 
    bool isNumber = false,
    String? prefix,
    IconData? prefixIcon
  }) {
    return TextFormField(
      controller: controller,
      keyboardType: isNumber ? const TextInputType.numberWithOptions(decimal: true) : TextInputType.text,
      style: const TextStyle(color: AppColors.textWhite),
      validator: (val) => val == null || val.isEmpty ? 'Required' : null,
      decoration: InputDecoration(
        filled: true,
        fillColor: AppColors.surfaceGrey,
        hintText: hint,
        hintStyle: TextStyle(color: AppColors.textWhite.withValues(alpha: 0.3)),
        prefixText: prefix, prefixStyle: const TextStyle(color: AppColors.textWhite, fontWeight: FontWeight.bold),
        prefixIcon: prefixIcon != null ? Icon(prefixIcon, color: AppColors.textWhite54, size: 20) : null,
        border: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.surfaceLightGrey)),
        enabledBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.surfaceLightGrey)),
        focusedBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(8), borderSide: const BorderSide(color: AppColors.primaryBlue, width: 2)),
        contentPadding: const EdgeInsets.symmetric(horizontal: 16, vertical: 16),
      ),
    );
  }

  Widget _buildDropdown({
    required String value,
    required List<String> items,
    required Function(String?) onChanged,
  }) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 16),
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(8),
        border: Border.all(color: AppColors.surfaceLightGrey),
      ),
      child: DropdownButtonHideUnderline(
        child: DropdownButton<String>(
          value: value,
          dropdownColor: AppColors.surfaceGrey,
          icon: const Icon(Icons.keyboard_arrow_down, color: AppColors.textWhite54),
          isExpanded: true,
          style: const TextStyle(color: AppColors.textWhite),
          items: items.map((String val) {
            return DropdownMenuItem<String>(
              value: val,
              child: Text(val),
            );
          }).toList(),
          onChanged: onChanged,
        ),
      ),
    );
  }

  Widget _buildDatePicker(BuildContext context, DateTime initial, Function(DateTime) onPicked) {
    return GestureDetector(
      onTap: () async {
        final picked = await showDatePicker(
          context: context,
          initialDate: initial,
          firstDate: DateTime(2020),
          lastDate: DateTime.now().add(const Duration(days: 30)),
          builder: (context, child) {
            return Theme(
              data: ThemeData.dark().copyWith(
                colorScheme: const ColorScheme.dark(
                  primary: AppColors.primaryBlue,
                  onPrimary: AppColors.textWhite,
                  surface: AppColors.surfaceGrey,
                  onSurface: AppColors.textWhite,
                ),
              ),
              child: child!,
            );
          },
        );
        if (picked != null) onPicked(picked);
      },
      child: Container(
        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 14),
        decoration: BoxDecoration(
          color: AppColors.surfaceGrey,
          borderRadius: BorderRadius.circular(8),
          border: Border.all(color: AppColors.surfaceLightGrey),
        ),
        child: Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            Text(DateFormat('MMM dd, yyyy').format(initial), style: const TextStyle(color: AppColors.textWhite)),
            const Icon(Icons.calendar_today_outlined, size: 18, color: AppColors.textWhite54),
          ],
        ),
      ),
    );
  }

  // --- HELPERS ---

  Color _getMethodColor(String method) {
    switch (method.toLowerCase()) {
      case 'cash': return AppColors.successGreen;
      case 'bank transfer': return AppColors.primaryBlue;
      case 'mobile money': return AppColors.warningOrange;
      default: return AppColors.accentPurple;
    }
  }

  IconData _getMethodIcon(String method) {
    switch (method.toLowerCase()) {
      case 'cash': return Icons.attach_money;
      case 'bank transfer': return Icons.account_balance;
      case 'mobile money': return Icons.phone_android;
      default: return Icons.credit_card;
    }
  }
}
// ==========================================
// FILE: ./pc/widgets/notifications/notifications_kpi_cards.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../../core/constants/app_colors.dart';
import '../../../../data/models/announcement_model.dart';
import '../../../../data/providers/notifications_provider.dart';

class NotificationsKpiCards extends ConsumerWidget {
  const NotificationsKpiCards({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final notificationsAsync = ref.watch(notificationsProvider);

    return notificationsAsync.when(
      data: (notifications) {
        // Safe Calculation
        final urgentUnread = notifications
            .where((n) => n.category == AnnouncementCategory.urgent && !n.isRead)
            .length;
        
        final totalUnread = notifications
            .where((n) => !n.isRead)
            .length;

        final total = notifications.length;

        return Row(
          children: [
            _buildCard(
              "Urgent Alerts", 
              urgentUnread.toString(), 
              Icons.warning_amber_rounded, 
              AppColors.errorRed,
              AppColors.errorRed.withValues(alpha: 0.1)
            ),
            const SizedBox(width: 24),
            _buildCard(
              "New Messages", 
              totalUnread.toString(), 
              Icons.mark_email_unread_outlined, 
              AppColors.primaryBlue,
              AppColors.primaryBlue.withValues(alpha: 0.1)
            ),
            const SizedBox(width: 24),
            _buildCard(
              "Total History", 
              total.toString(), 
              Icons.history, 
              AppColors.successGreen,
              AppColors.successGreen.withValues(alpha: 0.1)
            ),
          ],
        );
      },
      // Shimmer / Skeleton Loading State
      loading: () => Row(
        children: List.generate(3, (index) => Expanded(
          child: Container(
            height: 100,
            margin: EdgeInsets.only(left: index == 0 ? 0 : 24),
            decoration: BoxDecoration(
              color: AppColors.surfaceGrey,
              borderRadius: BorderRadius.circular(12),
              border: Border.all(color: AppColors.divider),
            ),
            child: const Center(child: CircularProgressIndicator(strokeWidth: 2)),
          ),
        )),
      ),
      // Graceful Error State
      error: (e, s) => Container(
        padding: const EdgeInsets.all(20),
        decoration: BoxDecoration(
          border: Border.all(color: AppColors.errorRed.withValues(alpha: 0.3)),
          borderRadius: BorderRadius.circular(12),
        ),
        child: const Text("System Alerts unavailable at the moment.", style: TextStyle(color: AppColors.errorRed)),
      ),
    );
  }

  Widget _buildCard(String title, String count, IconData icon, Color color, Color bg) {
    return Expanded(
      child: Container(
        padding: const EdgeInsets.all(20),
        decoration: BoxDecoration(
          color: AppColors.surfaceGrey,
          borderRadius: BorderRadius.circular(12),
          border: Border.all(color: AppColors.divider),
        ),
        child: Row(
          children: [
            Container(
              padding: const EdgeInsets.all(12),
              decoration: BoxDecoration(
                color: bg,
                borderRadius: BorderRadius.circular(8),
              ),
              child: Icon(icon, color: color, size: 24),
            ),
            const SizedBox(width: 16),
            Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(title, style: const TextStyle(color: AppColors.textWhite70, fontSize: 13)),
                Text(count, style: const TextStyle(color: AppColors.textWhite, fontSize: 24, fontWeight: FontWeight.bold)),
              ],
            ),
          ],
        ),
      ),
    );
  }
}
// ==========================================
// FILE: ./pc/widgets/notifications/notifications_list.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:intl/intl.dart';
import '../../../../core/constants/app_colors.dart';
import '../../../../data/models/announcement_model.dart';
import '../../../../data/providers/notifications_provider.dart';

class NotificationsList extends ConsumerStatefulWidget {
  const NotificationsList({super.key});

  @override
  ConsumerState<NotificationsList> createState() => _NotificationsListState();
}

class _NotificationsListState extends ConsumerState<NotificationsList> {
  AnnouncementCategory? _categoryFilter;
  bool _showUnreadOnly = false;

  @override
  Widget build(BuildContext context) {
    final notificationsAsync = ref.watch(notificationsProvider);

    return Container(
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: AppColors.divider),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // --- DESKTOP OPTIMIZED FILTER PANEL ---
          Padding(
            padding: const EdgeInsets.all(20),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(
                  children: [
                    const Text("Filters",
                        style: TextStyle(
                            color: AppColors.textWhite,
                            fontWeight: FontWeight.bold)),
                    const Spacer(),
                    TextButton.icon(
                      onPressed: () =>
                          ref.read(notificationLogicProvider).markAllRead(),
                      icon: const Icon(Icons.done_all, size: 16),
                      label: const Text("Mark All Read"),
                      style: TextButton.styleFrom(
                          foregroundColor: AppColors.textWhite70),
                    ),
                  ],
                ),
                const SizedBox(height: 16),
                Wrap(
                  spacing: 10,
                  runSpacing: 10,
                  children: [
                    _buildFilterChip("All", null, Icons.all_inclusive),
                    _buildUnreadToggle(),
                    const _VerticalDivider(),
                    _buildFilterChip(
                        "Urgent", AnnouncementCategory.urgent, Icons.priority_high),
                    _buildFilterChip("Security", AnnouncementCategory.security,
                        Icons.shield_outlined),
                    _buildFilterChip(
                        "Errors", AnnouncementCategory.failure, Icons.error_outline),
                    _buildFilterChip("Warning", AnnouncementCategory.warning,
                        Icons.warning_amber),
                    const _VerticalDivider(),
                    _buildFilterChip("Financial", AnnouncementCategory.financial,
                        Icons.payments_outlined),
                    _buildFilterChip("Success", AnnouncementCategory.success,
                        Icons.check_circle_outline),
                    _buildFilterChip("System", AnnouncementCategory.system,
                        Icons.settings_input_component),
                  ],
                ),
              ],
            ),
          ),
          const Divider(height: 1, color: AppColors.divider),

          // --- DATA LIST ---
          notificationsAsync.when(
            data: (list) {
              var filtered = list;
              if (_categoryFilter != null) {
                filtered =
                    filtered.where((n) => n.category == _categoryFilter).toList();
              }
              if (_showUnreadOnly) {
                filtered = filtered.where((n) => !n.isRead).toList();
              }

              if (filtered.isEmpty) return _buildEmptyState();

              return ListView.separated(
                shrinkWrap: true,
                physics: const NeverScrollableScrollPhysics(),
                itemCount: filtered.length,
                separatorBuilder: (context, i) =>
                    const Divider(height: 1, color: AppColors.divider),
                itemBuilder: (context, i) => _buildNotificationItem(filtered[i]),
              );
            },
            loading: () => const Center(
                child: Padding(
                    padding: EdgeInsets.all(40),
                    child: CircularProgressIndicator())),
            error: (e, s) => Center(
                child: Padding(
                    padding: const EdgeInsets.all(40),
                    child: Text("System connection error: $e",
                        style: const TextStyle(color: AppColors.errorRed)))),
          ),
        ],
      ),
    );
  }

  // --- ITEM BUILDER ---

  Widget _buildNotificationItem(Announcement item) {
    final isUnread = !item.isRead;

    return InkWell(
      onTap: () => _showDetailsDialog(item),
      child: Container(
        padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 16),
        color: isUnread ? AppColors.backgroundBlack.withValues(alpha: 0.3) : null,
        child: Row(
          children: [
            // Category Icon
            Container(
              padding: const EdgeInsets.all(10),
              decoration: BoxDecoration(
                color: item.color.withValues(alpha: 0.1),
                shape: BoxShape.circle,
              ),
              child: Icon(item.icon, color: item.color, size: 20),
            ),
            const SizedBox(width: 16),

            // Content
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Row(
                    children: [
                      Text(
                        item.title,
                        style: TextStyle(
                          color: AppColors.textWhite,
                          fontWeight: isUnread ? FontWeight.bold : FontWeight.normal,
                          fontSize: 14,
                        ),
                      ),
                      if (isUnread) ...[
                        const SizedBox(width: 8),
                        Container(
                          width: 6,
                          height: 6,
                          decoration: const BoxDecoration(
                            color: AppColors.primaryBlue,
                            shape: BoxShape.circle,
                          ),
                        ),
                      ]
                    ],
                  ),
                  const SizedBox(height: 4),
                  Text(
                    item.body,
                    maxLines: 1,
                    overflow: TextOverflow.ellipsis,
                    style: const TextStyle(color: AppColors.textWhite70, fontSize: 13),
                  ),
                ],
              ),
            ),

            // Time & Quick Action
            const SizedBox(width: 16),
            Text(
              DateFormat('MMM d, h:mm a').format(item.time),
              style: const TextStyle(color: AppColors.textWhite38, fontSize: 12),
            ),
            const SizedBox(width: 16),
            if (isUnread)
              IconButton(
                onPressed: () => ref.read(notificationLogicProvider).markAsRead(item.id),
                icon: const Icon(Icons.check_circle_outline, size: 20),
                color: AppColors.textWhite38,
                tooltip: "Mark as read",
              )
            else
              const SizedBox(width: 48), // Spacer to maintain alignment
          ],
        ),
      ),
    );
  }

  // --- VISUAL DETAILS DIALOG ---

  void _showDetailsDialog(Announcement item) {
    // Auto-mark as read when opened
    if (!item.isRead) {
      ref.read(notificationLogicProvider).markAsRead(item.id);
    }

    showDialog(
      context: context,
      builder: (context) => Dialog(
        backgroundColor: AppColors.surfaceGrey,
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
        child: Container(
          width: 450,
          padding: const EdgeInsets.all(24),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Row(
                children: [
                  Container(
                    padding: const EdgeInsets.all(12),
                    decoration: BoxDecoration(
                      color: item.color.withValues(alpha: 0.1),
                      borderRadius: BorderRadius.circular(12),
                    ),
                    child: Icon(item.icon, color: item.color, size: 24),
                  ),
                  const SizedBox(width: 16),
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(
                          item.badgeLabel,
                          style: TextStyle(
                            color: item.color,
                            fontSize: 11,
                            fontWeight: FontWeight.bold,
                            letterSpacing: 1.1,
                          ),
                        ),
                        Text(
                          item.title,
                          style: const TextStyle(
                            color: AppColors.textWhite,
                            fontSize: 18,
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                      ],
                    ),
                  ),
                  IconButton(
                    onPressed: () => Navigator.pop(context),
                    icon: const Icon(Icons.close, color: AppColors.textWhite38),
                  ),
                ],
              ),
              const SizedBox(height: 24),
              const Divider(color: AppColors.divider),
              const SizedBox(height: 16),
              Text(
                item.body,
                style: const TextStyle(
                  color: AppColors.textWhite70,
                  fontSize: 15,
                  height: 1.6,
                ),
              ),
              const SizedBox(height: 32),
              Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  Text(
                    DateFormat('EEEE, MMMM d, yyyy ‚Ä¢ h:mm a').format(item.time),
                    style: const TextStyle(color: AppColors.textWhite38, fontSize: 12),
                  ),
                  ElevatedButton(
                    onPressed: () => Navigator.pop(context),
                    style: ElevatedButton.styleFrom(
                      backgroundColor: AppColors.backgroundBlack,
                      foregroundColor: AppColors.textWhite,
                      side: const BorderSide(color: AppColors.divider),
                    ),
                    child: const Text("Close"),
                  ),
                ],
              ),
            ],
          ),
        ),
      ),
    );
  }

  // --- HELPERS (Previously defined) ---

  Widget _buildFilterChip(String label, AnnouncementCategory? category, IconData icon) {
    final isSelected = _categoryFilter == category;
    final Color activeColor = _getCategoryColor(category);

    return InkWell(
      onTap: () => setState(() => _categoryFilter = category),
      borderRadius: BorderRadius.circular(8),
      child: AnimatedContainer(
        duration: const Duration(milliseconds: 200),
        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),
        decoration: BoxDecoration(
          color: isSelected ? activeColor.withValues(alpha: 0.15) : AppColors.backgroundBlack,
          borderRadius: BorderRadius.circular(8),
          border: Border.all(color: isSelected ? activeColor : AppColors.divider, width: 1),
        ),
        child: Row(
          mainAxisSize: MainAxisSize.min,
          children: [
            Icon(icon, size: 16, color: isSelected ? activeColor : AppColors.textWhite38),
            const SizedBox(width: 8),
            Text(label,
                style: TextStyle(
                  color: isSelected ? AppColors.textWhite : AppColors.textWhite70,
                  fontSize: 13,
                  fontWeight: isSelected ? FontWeight.bold : FontWeight.normal,
                )),
          ],
        ),
      ),
    );
  }

  Widget _buildUnreadToggle() {
    return InkWell(
      onTap: () => setState(() => _showUnreadOnly = !_showUnreadOnly),
      borderRadius: BorderRadius.circular(8),
      child: AnimatedContainer(
        duration: const Duration(milliseconds: 200),
        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),
        decoration: BoxDecoration(
          color: _showUnreadOnly ? AppColors.primaryBlue : AppColors.backgroundBlack,
          borderRadius: BorderRadius.circular(8),
          border: Border.all(color: _showUnreadOnly ? AppColors.primaryBlue : AppColors.divider),
        ),
        child: Row(
          mainAxisSize: MainAxisSize.min,
          children: [
            Icon(Icons.mark_email_unread_outlined,
                size: 16,
                color: _showUnreadOnly ? Colors.white : AppColors.textWhite38),
            const SizedBox(width: 8),
            Text("Unread Only",
                style: TextStyle(
                  color: _showUnreadOnly ? Colors.white : AppColors.textWhite70,
                  fontSize: 13,
                  fontWeight: _showUnreadOnly ? FontWeight.bold : FontWeight.normal,
                )),
          ],
        ),
      ),
    );
  }

  Color _getCategoryColor(AnnouncementCategory? category) {
    if (category == null) return AppColors.primaryBlue;
    switch (category) {
      case AnnouncementCategory.urgent:
      case AnnouncementCategory.failure:
        return AppColors.errorRed;
      case AnnouncementCategory.warning:
        return Colors.amber;
      case AnnouncementCategory.success:
        return AppColors.successGreen;
      case AnnouncementCategory.security:
        return const Color(0xFF9333EA);
      default:
        return AppColors.primaryBlue;
    }
  }

  Widget _buildEmptyState() {
    return Container(
      width: double.infinity,
      padding: const EdgeInsets.all(60),
      child: const Column(
        children: [
          Icon(Icons.inbox_outlined, size: 48, color: AppColors.textWhite38),
          SizedBox(height: 16),
          Text("No results found for these filters.",
              style: TextStyle(color: AppColors.textWhite54)),
        ],
      ),
    );
  }
}

class _VerticalDivider extends StatelessWidget {
  const _VerticalDivider();
  @override
  Widget build(BuildContext context) => Padding(
        padding: const EdgeInsets.symmetric(horizontal: 8),
        child: Container(width: 1, height: 32, color: AppColors.divider),
      );
}
// ==========================================
// FILE: ./pc/screens/settings_screen.dart
// ==========================================

import 'package:fees_up/pc/widgets/settings/integrations_settings_view.dart';
import 'package:fees_up/pc/widgets/settings/notifications_settings_view.dart';
import 'package:fees_up/pc/widgets/settings/school_year_settings_view.dart';
import 'package:fees_up/pc/widgets/settings/users_permissions_view.dart';
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../../core/constants/app_colors.dart';
import '../widgets/sidebar.dart';
import '../widgets/settings/settings_header.dart';
import '../widgets/settings/general_financial_view.dart';

class SettingsScreen extends ConsumerStatefulWidget {
  const SettingsScreen({super.key});

  @override
  ConsumerState<SettingsScreen> createState() => _SettingsScreenState();
}

class _SettingsScreenState extends ConsumerState<SettingsScreen> {
  int _selectedTabIndex = 0;
  
  // The tabs exactly as required for future expansion
  final List<String> _tabs = [
    "General & Financial",
    "School Year",
    "Users & Permissions",
    "Notifications",
    "Integrations"
  ];

  void _handleSearchNavigation(int tabIndex) {
    setState(() {
      _selectedTabIndex = tabIndex;
    });
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: AppColors.backgroundBlack,
      body: Row(
        children: [
          const DashboardSidebar(),
          Expanded(
            child: Column(
              children: [
                // 1. Header with wired search callback
                SettingsHeader(onSearchNavigation: _handleSearchNavigation),
                
                // 2. Inner Navigation Bar
                Container(
                  decoration: const BoxDecoration(
                    border: Border(bottom: BorderSide(color: AppColors.divider)),
                  ),
                  padding: const EdgeInsets.symmetric(horizontal: 32),
                  child: Row(
                    children: List.generate(_tabs.length, (index) {
                      final isSelected = _selectedTabIndex == index;
                      return GestureDetector(
                        onTap: () => setState(() => _selectedTabIndex = index),
                        child: Container(
                          padding: const EdgeInsets.symmetric(vertical: 16, horizontal: 4),
                          margin: const EdgeInsets.only(right: 32),
                          decoration: BoxDecoration(
                            border: isSelected 
                              ? const Border(bottom: BorderSide(color: AppColors.primaryBlue, width: 2))
                              : null,
                          ),
                          child: Text(
                            _tabs[index],
                            style: TextStyle(
                              color: isSelected ? AppColors.primaryBlue : AppColors.textWhite54,
                              fontWeight: isSelected ? FontWeight.bold : FontWeight.normal,
                              fontSize: 14,
                            ),
                          ),
                        ),
                      );
                    }),
                  ),
                ),

                // 3. Body Content (Switched based on tab)
                Expanded(
                  child: SingleChildScrollView(
                    padding: const EdgeInsets.all(32),
                    child: _buildBody(),
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildBody() {
    switch (_selectedTabIndex) {
      case 0:
        return const GeneralFinancialView();
      case 1:
        return const SchoolYearSettingsView();
      case 2:
        return const UsersPermissionsView();
      case 3:
        return const NotificationsSettingsView();
      case 4:
        return const IntegrationsSettingsView();
      default:
        return const SizedBox();
    }
  }
}
// ==========================================
// FILE: ./pc/screens/invoices_screen.dart
// ==========================================

import 'package:fees_up/pc/widgets/invoices/invoice_dialog.dart';
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';

import '../../../../core/constants/app_colors.dart';
import '../../../../data/providers/dashboard_provider.dart';
import '../widgets/sidebar.dart';
import '../widgets/invoices/invoices_header.dart';
import '../widgets/invoices/invoices_stats.dart';
import '../widgets/invoices/invoices_table.dart';

class InvoicesScreen extends ConsumerWidget {
  const InvoicesScreen({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    // Fetch School ID for the "Create New Invoice" action
    final dashboardAsync = ref.watch(dashboardDataProvider);

    return Scaffold(
      backgroundColor: AppColors.backgroundBlack,
      body: Row(
        children: [
          // 1. Sidebar (Shared)
          const DashboardSidebar(),

          // 2. Main Content
          Expanded(
            child: Column(
              children: [
                // A. Top Header
                const InvoicesHeader(),
                const Divider(height: 1, color: AppColors.divider),

                // B. Scrollable Body
                Expanded(
                  child: dashboardAsync.when(
                    loading: () => const Center(child: CircularProgressIndicator(color: AppColors.primaryBlue)),
                    error: (e, _) => Center(child: Text("Error: $e", style: const TextStyle(color: AppColors.errorRed))),
                    data: (data) => SingleChildScrollView(
                      padding: const EdgeInsets.all(32),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          // 1. Stats Row (Pass function to open dialog)
                          InvoicesStats(
                            onCreateInvoice: () {
                              showDialog(
                                context: context,
                                barrierDismissible: false,
                                builder: (_) => InvoiceDialog(schoolId: data.schoolId),
                              );
                            },
                          ),
                          const SizedBox(height: 32),

                          // 2. Filter Bar & Table
                          const InvoicesTable(),
                        ],
                      ),
                    ),
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }
}
// ==========================================
// FILE: ./pc/screens/auth/pc_signup_screen.dart
// ==========================================

import 'package:fees_up/mobile/screens/auth/mobile_signup_screen.dart';
import 'package:flutter/material.dart';

class PCSignupScreen extends StatelessWidget {
  final bool initialIsLogin; 

  const PCSignupScreen({
    super.key, 
    this.initialIsLogin = true,
  });

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Stack(
        fit: StackFit.expand,
        children: [
          // 1. BACKGROUND LAYER with CustomPaint
          CustomPaint(
            painter: WaveBackgroundPainter(),
            size: Size.infinite,
          ),

          // 2. CONTENT LAYER
          Center(
            child: ConstrainedBox(
              constraints: const BoxConstraints(
                maxWidth: 500,
                maxHeight: 900,
              ),
              child: Card(
                // Use a slightly transparent dark color to blend with your theme
                // Fixed: withAlpha expects an int, converted (0.9 * 255) to int
                color: const Color(0xFF0F172A).withAlpha((0.9 * 255).toInt()), 
                elevation: 20,
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(20),
                  // Fixed: withAlpha expects an int
                  side: BorderSide(color: Colors.white.withAlpha((0.1 * 255).toInt())),
                ),
                child: ClipRRect(
                  borderRadius: const BorderRadius.all(Radius.circular(20)),
                  child: MobileAuthScreen(initialIsLogin: initialIsLogin), 
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }
}

class WaveBackgroundPainter extends CustomPainter {
  @override
  void paint(Canvas canvas, Size size) {
    final paint = Paint()
      ..style = PaintingStyle.fill
      ..isAntiAlias = true;

    // Background gradient
    final rect = Rect.fromLTWH(0, 0, size.width, size.height);
    const backgroundGradient = LinearGradient(
      begin: Alignment.topLeft,
      end: Alignment.bottomRight,
      colors: [
        Color(0xFF0f1729),
        Color(0xFF280a2a),
      ],
    );
    paint.shader = backgroundGradient.createShader(rect);
    canvas.drawRect(rect, paint);

    // Wave 1
    final wave1Path = Path();
    wave1Path.moveTo(0, size.height);
    wave1Path.cubicTo(
      size.width * 0.1, size.height * 0.65,
      size.width * 0.3, size.height * 0.45,
      size.width * 0.5, size.height * 0.5,
    );
    wave1Path.cubicTo(
      size.width * 0.7, size.height * 0.55,
      size.width * 0.9, size.height * 0.6,
      size.width, size.height * 0.45,
    );
    wave1Path.lineTo(size.width, size.height);
    wave1Path.lineTo(0, size.height);
    wave1Path.close();

    paint.shader = LinearGradient(
      begin: Alignment.topLeft,
      end: Alignment.bottomRight,
      colors: [
        const Color(0xFF263a69).withAlpha((0.9 * 255).toInt()),
        const Color(0xFF692e69).withAlpha((0.9 * 255).toInt()),
      ],
    ).createShader(rect);
    canvas.drawPath(wave1Path, paint);

    // Wave 2
    final wave2Path = Path();
    wave2Path.moveTo(0, size.height);
    wave2Path.cubicTo(
      size.width * 0.15, size.height * 0.7,
      size.width * 0.35, size.height * 0.55,
      size.width * 0.5, size.height * 0.6,
    );
    wave2Path.cubicTo(
      size.width * 0.65, size.height * 0.65,
      size.width * 0.85, size.height * 0.7,
      size.width, size.height * 0.55,
    );
    wave2Path.lineTo(size.width, size.height);
    wave2Path.lineTo(0, size.height);
    wave2Path.close();

    paint.shader = LinearGradient(
      begin: Alignment.topLeft,
      end: Alignment.bottomRight,
      colors: [
        const Color(0xFF324c8a).withAlpha((0.9 * 255).toInt()),
        const Color(0xFF8a3c8a).withAlpha((0.9 * 255).toInt()),
      ],
    ).createShader(rect);
    canvas.drawPath(wave2Path, paint);

    // Wave 3 (Additional wave)
    final wave3Path = Path();
    wave3Path.moveTo(0, size.height);
    wave3Path.cubicTo(
      size.width * 0.2, size.height * 0.8,
      size.width * 0.4, size.height * 0.65,
      size.width * 0.5, size.height * 0.7,
    );
    wave3Path.cubicTo(
      size.width * 0.6, size.height * 0.75,
      size.width * 0.8, size.height * 0.8,
      size.width, size.height * 0.65,
    );
    wave3Path.lineTo(size.width, size.height);
    wave3Path.lineTo(0, size.height);
    wave3Path.close();

    paint.shader = LinearGradient(
      begin: Alignment.topLeft,
      end: Alignment.bottomRight,
      colors: [
        const Color(0xFF1b294a).withAlpha((0.9 * 255).toInt()),
        const Color(0xFF4a1f4a).withAlpha((0.9 * 255).toInt()),
      ],
    ).createShader(rect);
    canvas.drawPath(wave3Path, paint);
  }

  @override
  bool shouldRepaint(covariant CustomPainter oldDelegate) => false;
}
// ==========================================
// FILE: ./pc/screens/notifications_screen.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../../core/constants/app_colors.dart';
import '../widgets/sidebar.dart';
import '../widgets/notifications/notifications_kpi_cards.dart'; // Renamed & Moved
import '../widgets/notifications/notifications_list.dart'; // Renamed & Moved

class NotificationsScreen extends ConsumerWidget {
  const NotificationsScreen({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    return const Scaffold(
      backgroundColor: AppColors.backgroundBlack,
      body: Row(
        children: [
          DashboardSidebar(),
          Expanded(
            child: Column(
              children: [
                _NotificationsHeader(),
                Divider(height: 1, color: AppColors.divider),
                
                Expanded(
                  child: SingleChildScrollView(
                    padding: EdgeInsets.all(32),
                    child: Column(
                      children: [
                        // 1. Personal Stats (Unread / Urgent)
                        NotificationsKpiCards(),
                        SizedBox(height: 24),
                        
                        // 2. The Personal Inbox List
                        NotificationsList(),
                      ],
                    ),
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }
}

class _NotificationsHeader extends StatelessWidget {
  const _NotificationsHeader();

  @override
  Widget build(BuildContext context) {
    return Container(
      height: 70,
      padding: const EdgeInsets.symmetric(horizontal: 24),
      color: AppColors.backgroundBlack,
      child: Row(
        children: [
          const Icon(Icons.notifications_active_outlined, color: AppColors.primaryBlue, size: 28),
          const SizedBox(width: 12),
          const Text("My Notifications", style: TextStyle(color: AppColors.textWhite, fontSize: 20, fontWeight: FontWeight.bold)),
          const Spacer(),
          // Standard Search or Actions
          IconButton(
            onPressed: () {}, 
            icon: const Icon(Icons.filter_list, color: AppColors.textWhite54),
            tooltip: "Filter",
          ),
        ],
      ),
    );
  }
}
// ==========================================
// FILE: ./pc/screens/announcements_screen.dart
// ==========================================

/// -----------------------------------------------------------------
/// GREYWAY.CO / BATCH TECH - CONFIDENTIAL
/// -----------------------------------------------------------------
/// Author:  Nyasha Gabriel
/// Date:    2025-12-31
/// -----------------------------------------------------------------
library;

// ------------------------------------------
// NOTE: I want to comment on top of file
// ------------------------------------------

import 'package:flutter/material.dart';
import '../../../../core/constants/app_colors.dart';
import '../widgets/sidebar.dart';
import '../widgets/announcements/broadcast_kpi_cards.dart';
import '../widgets/announcements/broadcast_list.dart';

class AnnouncementsScreen extends StatelessWidget {
  const AnnouncementsScreen({super.key});

  @override
  Widget build(BuildContext context) {
    return const Scaffold(
      backgroundColor: AppColors.backgroundBlack,
      body: Row(
        children: [
          DashboardSidebar(),
          Expanded(
            child: Column(
              children: [
                _BroadcastsHeader(),
                Divider(height: 1, color: AppColors.divider),
                
                Expanded(
                  child: SingleChildScrollView(
                    padding: EdgeInsets.all(32),
                    child: Column(
                      children: [
                        BroadcastKpiCards(),
                        SizedBox(height: 24),
                        BroadcastList(),
                      ],
                    ),
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }
}

class _BroadcastsHeader extends StatelessWidget {
  const _BroadcastsHeader();

  @override
  Widget build(BuildContext context) {
    return Container(
      height: 70,
      padding: const EdgeInsets.symmetric(horizontal: 24),
      color: AppColors.backgroundBlack,
      child: Row(
        children: [
          const Icon(Icons.campaign, color: AppColors.primaryBlue, size: 28),
          const SizedBox(width: 12),
          const Text("School Broadcasts", style: TextStyle(color: AppColors.textWhite, fontSize: 20, fontWeight: FontWeight.bold)),
          const Spacer(),
          // Placeholder for search or other header actions
          IconButton(
            onPressed: () {}, 
            icon: const Icon(Icons.search, color: AppColors.textWhite54),
          ),
        ],
      ),
    );
  }
}
// ==========================================
// FILE: ./pc/screens/pc_home_screen.dart
// ==========================================

import 'package:fees_up/pc/widgets/dashboard/campaign_dialog.dart';
import 'package:fees_up/pc/widgets/dashboard/expense_dialog.dart';
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:intl/intl.dart';
import '../../../core/constants/app_colors.dart';
import '../../data/providers/dashboard_provider.dart';
import '../../data/providers/fundraising_provider.dart';
import '../../data/services/database_service.dart';
import '../widgets/sidebar.dart';
import '../widgets/dashboard/stat_cards.dart';
import '../widgets/dashboard/revenue_chart.dart';
import '../widgets/dashboard/quick_actions_grid.dart';
import '../widgets/dashboard/payment_dialog.dart';
import '../widgets/dashboard/student_dialog.dart';
import '../../mobile/widgets/dashboard/create_school_dialog.dart';

class PCHomeScreen extends ConsumerWidget {
  const PCHomeScreen({super.key});

  void _showCreateSchoolDialog(BuildContext context) {
    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (ctx) => const CreateSchoolDialog(),
    );
  }

  // Helper for Initials
  String _getInitials(String name) {
    if (name.isEmpty) return "U";
    final parts = name.trim().split(' ');
    if (parts.length > 1) {
      return "${parts[0][0]}${parts[1][0]}".toUpperCase();
    }
    return name[0].toUpperCase();
  }

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final dashboardAsync = ref.watch(dashboardDataProvider);
    final fundraisingAsync = ref.watch(fundraisingProvider);

    // Direct connectivity check for UI feedback
    final bool isConnected = DatabaseService().db.currentStatus.connected;

    return Scaffold(
      backgroundColor: AppColors.backgroundBlack,
      body: LayoutBuilder(
        builder: (context, constraints) {
          // ZONE RULE: Desktop Only. Block small screens.
          if (constraints.maxWidth < 1024) {
            return _buildScreenTooSmallError();
          }

          return Row(
            children: [
              const DashboardSidebar(),
              Expanded(
                child: dashboardAsync.when(
                  loading: () => const Center(
                    child:
                        CircularProgressIndicator(color: AppColors.primaryBlue),
                  ),
                  error: (err, stack) => Center(
                    child: Column(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        const Icon(Icons.error_outline,
                            color: AppColors.errorRed, size: 40),
                        const SizedBox(height: 16),
                        Text("Error: $err",
                            style: const TextStyle(color: AppColors.textWhite)),
                        const SizedBox(height: 16),
                        ElevatedButton(
                          onPressed: () => ref.refresh(dashboardDataProvider),
                          child: const Text("Retry"),
                        )
                      ],
                    ),
                  ),
                  data: (data) {
                    final bool hasSchool = data.schoolId.isNotEmpty &&
                        data.schoolName != 'Loading...';

                    return Stack(
                      children: [
                        Column(
                          children: [
                            // Updated Top Bar with Connectivity Logic
                            _buildTopBar(context, data.userName,
                                data.schoolName, hasSchool, isConnected),
                            Expanded(
                              child: SingleChildScrollView(
                                padding: const EdgeInsets.all(24),
                                child: Column(
                                  crossAxisAlignment: CrossAxisAlignment.start,
                                  children: [
                                    _buildHeader(data.schoolName),
                                    const SizedBox(height: 24),

                                    // ZONE 1: KPI Summary (Fixed Height: 160px)
                                    SizedBox(
                                      height: 160,
                                      child: _buildKpiSection(
                                          data, fundraisingAsync),
                                    ),

                                    const SizedBox(height: 24),

                                    // ZONE 2: Primary Analytics & Actions (Fixed Height: 400px)
                                    SizedBox(
                                      height: 400,
                                      child: Row(
                                        crossAxisAlignment:
                                            CrossAxisAlignment.stretch,
                                        children: [
                                          // Chart: Hero content
                                          const Expanded(
                                              flex: 2, child: RevenueChart()),
                                          const SizedBox(width: 24),

                                          // Actions: Secondary Panel
                                          Expanded(
                                            flex: 1,
                                            child: QuickActionsGrid(
                                              onActionSelected: (type) =>
                                                  _handleQuickAction(context,
                                                      type, data.schoolId),
                                            ),
                                          ),
                                        ],
                                      ),
                                    ),

                                    const SizedBox(height: 24),

                                    // ZONE 4: Data Tables (Fill remaining)
                                    _buildRecentPayments(data.recentPayments),
                                  ],
                                ),
                              ),
                            ),
                          ],
                        ),
                        if (!hasSchool)
                          _buildNoSchoolOverlay(context, isConnected),
                      ],
                    );
                  },
                ),
              ),
            ],
          );
        },
      ),
    );
  }

  // --- TOP BAR (FIXED) ---

  Widget _buildTopBar(BuildContext context, String userName, String schoolName,
      bool hasSchool, bool isConnected) {
    // Determine subtitle status (Offline / Syncing / School Name)
    String subtitle = schoolName;
    Color subtitleColor = AppColors.textWhite54;

    if (!hasSchool) {
      subtitle = isConnected ? "Tap avatar to setup" : "Waiting for Sync...";
      subtitleColor = AppColors.warningOrange;
    } else if (!isConnected) {
      subtitle = "Offline Mode";
      subtitleColor = AppColors.errorRed;
    } else if (schoolName == 'Loading...') {
      subtitle = "Syncing Data...";
      subtitleColor = AppColors.primaryBlueLight;
    }

    final initials = _getInitials(userName);

    return Container(
      height: 70,
      padding: const EdgeInsets.symmetric(horizontal: 24),
      decoration: const BoxDecoration(
          border: Border(bottom: BorderSide(color: AppColors.divider))),
      child: Row(
        children: [
          const Text("Financial Dashboard",
              style: TextStyle(
                  color: AppColors.textWhite,
                  fontSize: 18,
                  fontWeight: FontWeight.bold)),
          const Spacer(),

          // User Info Column
          Column(
            mainAxisAlignment: MainAxisAlignment.center,
            crossAxisAlignment: CrossAxisAlignment.end,
            children: [
              Text(userName.isEmpty ? "User" : userName,
                  style: const TextStyle(
                      color: AppColors.textWhite,
                      fontWeight: FontWeight.bold,
                      fontSize: 13)),
              Row(
                children: [
                  if (!isConnected) ...[
                    const Icon(Icons.wifi_off,
                        size: 10, color: AppColors.errorRed),
                    const SizedBox(width: 4),
                  ],
                  Text(subtitle,
                      style: TextStyle(color: subtitleColor, fontSize: 11)),
                ],
              ),
            ],
          ),
          const SizedBox(width: 12),

          // Profile Avatar
          InkWell(
            onTap: () {
              if (!hasSchool) _showCreateSchoolDialog(context);
            },
            borderRadius: BorderRadius.circular(50),
            child: CircleAvatar(
              backgroundColor: hasSchool
                  ? AppColors.primaryBlue.withValues(alpha: 0.2)
                  : AppColors.warningOrange.withValues(alpha: 0.2),
              child: hasSchool
                  ? Text(initials,
                      style: const TextStyle(
                          color: AppColors.primaryBlue,
                          fontWeight: FontWeight.bold,
                          fontSize: 12))
                  : const Icon(Icons.priority_high,
                      color: AppColors.warningOrange, size: 18),
            ),
          ),
        ],
      ),
    );
  }

  // --- HELPERS (Unchanged) ---

  Widget _buildScreenTooSmallError() {
    return Container(
      color: Colors.black,
      width: double.infinity,
      height: double.infinity,
      child: const Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Icon(Icons.desktop_windows, size: 64, color: AppColors.errorRed),
          SizedBox(height: 24),
          Text(
            "Window Size Too Small",
            style: TextStyle(
                color: AppColors.textWhite,
                fontSize: 24,
                fontWeight: FontWeight.bold),
          ),
          SizedBox(height: 12),
          Text(
            "This application requires a minimum resolution of 1024px width.",
            textAlign: TextAlign.center,
            style: TextStyle(color: AppColors.textWhite70, fontSize: 16),
          ),
        ],
      ),
    );
  }

  Widget _buildHeader(String schoolName) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        const Text("Overview",
            style: TextStyle(
                fontSize: 28,
                fontWeight: FontWeight.bold,
                color: AppColors.textWhite)),
        Text("Status for $schoolName",
            style: const TextStyle(color: AppColors.textWhite54)),
      ],
    );
  }

  Widget _buildKpiSection(dynamic data, AsyncValue fundraisingAsync) {
    return Row(
      crossAxisAlignment: CrossAxisAlignment.stretch,
      children: [
        Expanded(
          child: StatCard(
            title: "Outstanding Bills",
            value:
                NumberFormat.simpleCurrency().format(data.outstandingBalance),
            icon: Icons.receipt_long,
            iconColor: AppColors.errorRed,
            iconBgColor: AppColors.errorRedBg,
            isAlert: data.outstandingBalance > 0,
            footer: const AlertBadge(text: "Updated", subText: "Just now"),
          ),
        ),
        const SizedBox(width: 24),
        Expanded(
          child: fundraisingAsync.when(
            loading: () => const Center(child: CircularProgressIndicator()),
            error: (_, __) => const SizedBox(),
            data: (fundData) {
              if (fundData == null) {
                return const StatCard(
                  title: "No Active Campaign",
                  value: "-",
                  icon: Icons.volunteer_activism,
                  iconColor: AppColors.iconGrey,
                  iconBgColor: AppColors.divider,
                );
              }
              return StatCard(
                title: fundData.campaignName,
                value: "${fundData.percentage.toStringAsFixed(1)}%",
                icon: Icons.volunteer_activism,
                iconColor: AppColors.accentPurple,
                iconBgColor: AppColors.purpleBg,
                footer: Text(
                    "Raised \$${fundData.raisedAmount.toInt()} of \$${fundData.goalAmount.toInt()}",
                    style: const TextStyle(
                        color: AppColors.textWhite38, fontSize: 11)),
              );
            },
          ),
        ),
        const SizedBox(width: 24),
        Expanded(
          child: StatCard(
            title: "Active Students",
            value: data.studentCount.toString(),
            icon: Icons.school,
            iconColor: AppColors.primaryBlue,
            iconBgColor: AppColors.primaryBlueBg,
            footer: const Text("Enrolled",
                style: TextStyle(color: AppColors.textWhite38, fontSize: 11)),
          ),
        ),
      ],
    );
  }

  Widget _buildRecentPayments(List<dynamic> payments) {
    return Container(
      padding: const EdgeInsets.all(24),
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: AppColors.divider),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          const Text("Recent Payments",
              style: TextStyle(
                  color: AppColors.textWhite,
                  fontSize: 18,
                  fontWeight: FontWeight.bold)),
          const SizedBox(height: 16),
          if (payments.isEmpty)
            const Padding(
              padding: EdgeInsets.all(20.0),
              child: Text("No recent payments found.",
                  style: TextStyle(color: AppColors.textWhite54)),
            )
          else
            ...payments.map((payment) {
              return Column(
                children: [
                  _buildPaymentRow(
                    payment['payer_name'] ?? 'Unknown',
                    payment['date_paid'] != null
                        ? DateFormat('MMM d, yyyy')
                            .format(DateTime.parse(payment['date_paid']))
                        : 'Unknown Date',
                    payment['category'] ?? 'Fee',
                    NumberFormat.simpleCurrency().format(payment['amount']),
                    true,
                  ),
                  const Divider(color: AppColors.divider),
                ],
              );
            }),
        ],
      ),
    );
  }

  Widget _buildNoSchoolOverlay(BuildContext context, bool isConnected) {
    return Positioned.fill(
      child: Container(
        color: AppColors.overlayDark,
        child: Center(
          child: Container(
            width: 500,
            margin: const EdgeInsets.all(24),
            padding: const EdgeInsets.all(32),
            decoration: BoxDecoration(
              color: AppColors.surfaceGrey,
              borderRadius: BorderRadius.circular(16),
              border: Border.all(color: AppColors.divider),
              boxShadow: [
                BoxShadow(
                  color: Colors.black.withValues(alpha: 0.5),
                  blurRadius: 30,
                  offset: const Offset(0, 10),
                )
              ],
            ),
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                Icon(
                  isConnected ? Icons.domain_add : Icons.cloud_off,
                  size: 64,
                  color:
                      isConnected ? AppColors.primaryBlue : AppColors.iconGrey,
                ),
                const SizedBox(height: 24),
                Text(
                  isConnected ? "Welcome to Fees Up!" : "Syncing Data...",
                  style: const TextStyle(
                      color: AppColors.textWhite,
                      fontSize: 24,
                      fontWeight: FontWeight.bold),
                  textAlign: TextAlign.center,
                ),
                const SizedBox(height: 12),
                Text(
                  isConnected
                      ? "It looks like you haven't set up a school yet. Create one now to access the dashboard."
                      : "We are waiting for your school data to download. Please check your internet connection.",
                  style: const TextStyle(
                      color: AppColors.textWhite70, fontSize: 16),
                  textAlign: TextAlign.center,
                ),
                const SizedBox(height: 32),
                if (isConnected)
                  ElevatedButton(
                    onPressed: () => _showCreateSchoolDialog(context),
                    style: ElevatedButton.styleFrom(
                        backgroundColor: AppColors.primaryBlue,
                        foregroundColor: AppColors.textWhite,
                        padding: const EdgeInsets.symmetric(
                            horizontal: 40, vertical: 20),
                        textStyle: const TextStyle(
                            fontSize: 16, fontWeight: FontWeight.bold)),
                    child: const Text("Create School Profile"),
                  )
                else
                  const Column(
                    children: [
                      CircularProgressIndicator(color: AppColors.textWhite),
                      SizedBox(height: 16),
                      Text("Waiting for sync...",
                          style: TextStyle(color: AppColors.textWhite38))
                    ],
                  ),
              ],
            ),
          ),
        ),
      ),
    );
  }

  void _handleQuickAction(
      BuildContext context, QuickActionType type, String schoolId) {
    switch (type) {
      case QuickActionType.recordPayment:
        showDialog(
            context: context,
            barrierDismissible: false,
            barrierColor: Colors.black54,
            builder: (context) => PaymentDialog(schoolId: schoolId));
        break;
      case QuickActionType.addExpense:
        showDialog(
            context: context,
            barrierDismissible: false,
            barrierColor: Colors.black54,
            builder: (context) => ExpenseDialog(schoolId: schoolId));
        break;
      case QuickActionType.registerStudent:
        showDialog(
            context: context,
            barrierDismissible: false,
            barrierColor: Colors.black54,
            builder: (context) => StudentDialog(schoolId: schoolId));
        break;
      case QuickActionType.createCampaign:
        showDialog(
            context: context,
            barrierDismissible: false,
            barrierColor: Colors.black54,
            builder: (context) => CampaignDialog(schoolId: schoolId));
        break;
    }
  }

  Widget _buildPaymentRow(
      String name, String date, String desc, String amount, bool isPaid) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 12),
      child: Row(
        children: [
          const CircleAvatar(
              radius: 16,
              backgroundColor: AppColors.divider,
              child:
                  Icon(Icons.person, size: 16, color: AppColors.textWhite54)),
          const SizedBox(width: 12),
          Expanded(
              flex: 2,
              child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(name,
                        style: const TextStyle(color: AppColors.textWhite)),
                    Text(date,
                        style: const TextStyle(
                            color: AppColors.textWhite38, fontSize: 12))
                  ])),
          Expanded(
              flex: 3,
              child: Text(desc,
                  style: const TextStyle(color: AppColors.textWhite70))),
          Expanded(
              flex: 1,
              child: Text(amount,
                  style: const TextStyle(
                      color: AppColors.textWhite,
                      fontWeight: FontWeight.bold))),
          Container(
            padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
            decoration: BoxDecoration(
              color: isPaid
                  ? AppColors.successGreen.withValues(alpha: 0.2)
                  : AppColors.warningOrange.withValues(alpha: 0.2),
              borderRadius: BorderRadius.circular(4),
            ),
            child: Text(
              isPaid ? "Paid" : "Pending",
              style: TextStyle(
                  color:
                      isPaid ? AppColors.successGreen : AppColors.warningOrange,
                  fontSize: 11,
                  fontWeight: FontWeight.bold),
            ),
          ),
        ],
      ),
    );
  }
}

// ==========================================
// FILE: ./pc/screens/transactions_screen.dart
// ==========================================

import 'package:fees_up/pc/widgets/sidebar.dart';
import 'package:fees_up/pc/widgets/transactions/universal_entry_dialog.dart';
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../core/constants/app_colors.dart';
import '../../data/providers/dashboard_provider.dart'; // To get schoolId
import '../widgets/transactions/transactions_header.dart';
import '../widgets/transactions/transactions_kpi_cards.dart';
import '../widgets/transactions/transactions_table.dart';

class TransactionsScreen extends ConsumerWidget {
  const TransactionsScreen({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    // 1. We need the School ID to pass to the transaction dialogs
    final dashboardAsync = ref.watch(dashboardDataProvider);

    return Scaffold(
      backgroundColor: AppColors.backgroundBlack,
      body: Row(
        children: [
          // 1. SHARED SIDEBAR
          const DashboardSidebar(),

          // 2. MAIN CONTENT AREA
          Expanded(
            child: Column(
              children: [
                // Top Header (Search & Profile)
                const TransactionsHeader(),
                const Divider(height: 1, color: AppColors.divider),

                // Scrollable Body
                Expanded(
                  child: dashboardAsync.when(
                    // A. LOADING STATE
                    loading: () => const Center(
                      child: CircularProgressIndicator(color: AppColors.primaryBlue),
                    ),
                    // B. ERROR STATE
                    error: (err, stack) => Center(
                      child: Text("Error loading school data: $err",
                          style: const TextStyle(color: AppColors.errorRed)),
                    ),
                    // C. DATA LOADED
                    data: (data) {
                      return SingleChildScrollView(
                        padding: const EdgeInsets.all(32),
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            // Page Title & Action Buttons (Pass context & schoolId)
                            _buildPageActions(context, data.schoolId),
                            const SizedBox(height: 24),

                            // KPI Cards Row
                            const TransactionsKpiCards(),
                            const SizedBox(height: 32),

                            // Main Data Table
                            const TransactionsTable(),
                          ],
                        ),
                      );
                    },
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildPageActions(BuildContext context, String schoolId) {
    return Row(
      mainAxisAlignment: MainAxisAlignment.spaceBetween,
      children: [
        const Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              "Financial Records",
              style: TextStyle(
                color: AppColors.textWhite,
                fontSize: 24,
                fontWeight: FontWeight.bold,
              ),
            ),
            SizedBox(height: 4),
            Text(
              "Manage and audit all incoming and outgoing transactions.",
              style: TextStyle(color: AppColors.textWhite54, fontSize: 14),
            ),
          ],
        ),
        Row(
          children: [
            // EXPORT ACTION (Mock)
            OutlinedButton.icon(
              onPressed: () {
                ScaffoldMessenger.of(context).showSnackBar(
                  const SnackBar(
                    content: Text("Exporting CSV... (Mock Action)"),
                    backgroundColor: AppColors.surfaceLightGrey,
                    duration: Duration(seconds: 1),
                  ),
                );
              },
              icon: const Icon(Icons.download, size: 16),
              label: const Text("Export CSV"),
              style: OutlinedButton.styleFrom(
                foregroundColor: AppColors.textWhite,
                side: const BorderSide(color: AppColors.divider),
                padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 18),
              ),
            ),
            const SizedBox(width: 16),
            
            // NEW TRANSACTION ACTION (Real)
            ElevatedButton.icon(
              onPressed: () {
                showDialog(
                  context: context,
                  barrierDismissible: false, // Force explicit close
                  barrierColor: Colors.black54,
                  builder: (ctx) => UniversalTransactionDialog(
                    schoolId: schoolId,
                    initialType: TransactionType.payment, // Default to Payment
                  ),
                );
              }, 
              icon: const Icon(Icons.add, size: 16),
              label: const Text("New Transaction"),
              style: ElevatedButton.styleFrom(
                backgroundColor: AppColors.primaryBlue,
                foregroundColor: Colors.white,
                padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 18),
              ),
            ),
          ],
        ),
      ],
    );
  }
}
// ==========================================
// FILE: ./pc/screens/students_screen.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../../core/constants/app_colors.dart';
import '../../../../data/providers/dashboard_provider.dart';
import '../widgets/sidebar.dart';
import '../widgets/students/students_header.dart';
import '../widgets/students/students_stats.dart';
import '../widgets/students/students_table.dart';
import '../widgets/dashboard/student_dialog.dart'; // Reusing your existing dialog

class StudentsScreen extends ConsumerWidget {
  const StudentsScreen({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final dashboardAsync = ref.watch(dashboardDataProvider);

    return Scaffold(
      backgroundColor: AppColors.backgroundBlack,
      body: Row(
        children: [
          // 1. Shared Sidebar
          const DashboardSidebar(),

          // 2. Main Content
          Expanded(
            child: Column(
              children: [
                // A. Standardized Header
                const StudentsHeader(),
                const Divider(height: 1, color: AppColors.divider),

                // B. Body
                Expanded(
                  child: dashboardAsync.when(
                    loading: () => const Center(child: CircularProgressIndicator(color: AppColors.primaryBlue)),
                    error: (e, _) => Center(child: Text("Error: $e", style: const TextStyle(color: AppColors.errorRed))),
                    data: (data) {
                      return SingleChildScrollView(
                        padding: const EdgeInsets.all(32),
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            // 1. Page Title & Actions
                            _buildPageHeader(context, data.schoolId),
                            const SizedBox(height: 24),

                            // 2. Live KPI Cards (Passes schoolId to fetch stats)
                            StudentsStats(schoolId: data.schoolId),
                            const SizedBox(height: 32),

                            // 3. Main Data Table
                            StudentsTable(schoolId: data.schoolId),
                          ],
                        ),
                      );
                    },
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildPageHeader(BuildContext context, String schoolId) {
    return Row(
      mainAxisAlignment: MainAxisAlignment.spaceBetween,
      children: [
        const Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              "Student Directory",
              style: TextStyle(
                color: AppColors.textWhite,
                fontSize: 24,
                fontWeight: FontWeight.bold,
              ),
            ),
            SizedBox(height: 4),
            Text(
              "Manage enrollment, contact details, and financial status.",
              style: TextStyle(color: AppColors.textWhite54, fontSize: 14),
            ),
          ],
        ),
        Row(
          children: [
            // Export Button
            OutlinedButton.icon(
              onPressed: () {},
              icon: const Icon(Icons.download, size: 16),
              label: const Text("Export List"),
              style: OutlinedButton.styleFrom(
                foregroundColor: AppColors.textWhite,
                side: const BorderSide(color: AppColors.divider),
                padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 18),
              ),
            ),
            const SizedBox(width: 16),
            
            // Add Student Button
            ElevatedButton.icon(
              onPressed: () {
                showDialog(
                  context: context,
                  barrierDismissible: false,
                  builder: (_) => StudentDialog(schoolId: schoolId),
                );
              },
              icon: const Icon(Icons.add, size: 16),
              label: const Text("Add New Student"),
              style: ElevatedButton.styleFrom(
                backgroundColor: AppColors.primaryBlue,
                foregroundColor: Colors.white,
                padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 18),
              ),
            ),
          ],
        ),
      ],
    );
  }
}
// ==========================================
// FILE: ./pc/screens/profile_screen.dart
// ==========================================

import 'package:flutter/material.dart';
import '../../../../core/constants/app_colors.dart';
import '../widgets/sidebar.dart';
import '../widgets/profile/profile_header_card.dart';
import '../widgets/profile/personal_info_form.dart';
import '../widgets/profile/account_security_card.dart';
import '../widgets/profile/security_password_view.dart';
import '../widgets/profile/role_permissions_view.dart';
import '../widgets/profile/activity_log_view.dart';

class ProfileScreen extends StatefulWidget {
  const ProfileScreen({super.key});

  @override
  State<ProfileScreen> createState() => _ProfileScreenState();
}

class _ProfileScreenState extends State<ProfileScreen> {
  int _selectedIndex = 0;

  final List<Map<String, dynamic>> _navItems = [
    {'icon': Icons.person_outline, 'label': 'Personal Information'},
    {'icon': Icons.lock_outline, 'label': 'Security & Password'},
    {'icon': Icons.shield_outlined, 'label': 'Role & Permissions'},
    {'icon': Icons.history, 'label': 'Activity Log'},
  ];

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: AppColors.backgroundBlack,
      body: Row(
        // FIX: Pin Sidebar and Content to the top to prevent vertical jumping
        // when content height changes during navigation.
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          const DashboardSidebar(),
          Expanded(
            child: SingleChildScrollView(
              padding: const EdgeInsets.all(32),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  const Text("Profile Settings",
                      style: TextStyle(
                          color: AppColors.textWhite,
                          fontSize: 24,
                          fontWeight: FontWeight.bold)),
                  const SizedBox(height: 24),

                  // 1. Top Hero Card
                  const ProfileHeaderCard(),
                  const SizedBox(height: 24),

                  // 2. Main Content Area
                  Row(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      // LEFT COLUMN: Nav & Widget
                      Expanded(
                        flex: 1,
                        child: Column(
                          children: [
                            _buildInnerNav(),
                            // Only show the security summary on Personal & Security tabs
                            if (_selectedIndex == 0 || _selectedIndex == 1) ...[
                              const SizedBox(height: 24),
                              const AccountSecurityCard(),
                            ],
                          ],
                        ),
                      ),

                      const SizedBox(width: 24),

                      // RIGHT COLUMN: Dynamic Content
                      Expanded(
                        flex: 2,
                        child: _buildActiveContent(),
                      ),
                    ],
                  ),
                ],
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildActiveContent() {
    switch (_selectedIndex) {
      case 0:
        return const PersonalInfoForm();
      case 1:
        return const SecurityPasswordView();
      case 2:
        return const RolePermissionsView();
      case 3:
        return const ActivityLogView();
      default:
        return const PersonalInfoForm();
    }
  }

  Widget _buildInnerNav() {
    return Container(
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: AppColors.divider),
      ),
      child: ClipRRect(
        borderRadius: BorderRadius.circular(12),
        child: Column(
          children: List.generate(_navItems.length, (index) {
            final item = _navItems[index];
            final isSelected = _selectedIndex == index;
            return Column(
              children: [
                if (index > 0)
                  const Divider(height: 1, color: AppColors.divider),
                InkWell(
                  onTap: () => setState(() => _selectedIndex = index),
                  child: Container(
                    width: double.infinity,
                    padding: const EdgeInsets.symmetric(
                        horizontal: 20, vertical: 16),
                    decoration: isSelected
                        ? BoxDecoration(
                            border: const Border(
                                left: BorderSide(
                                    color: AppColors.primaryBlue, width: 3)),
                            color:
                                AppColors.primaryBlue.withValues(alpha: 0.05),
                          )
                        : null,
                    child: Row(
                      children: [
                        Icon(item['icon'],
                            size: 20,
                            color: isSelected
                                ? AppColors.primaryBlue
                                : AppColors.textWhite54),
                        const SizedBox(width: 12),
                        Expanded(
                          child: Text(
                            item['label'],
                            maxLines: 1,
                            overflow: TextOverflow.ellipsis,
                            style: TextStyle(
                                color: isSelected
                                    ? AppColors.primaryBlue
                                    : AppColors.textWhite70,
                                fontWeight: isSelected
                                    ? FontWeight.bold
                                    : FontWeight.normal,
                                fontSize: 13),
                          ),
                        ),
                      ],
                    ),
                  ),
                ),
              ],
            );
          }),
        ),
      ),
    );
  }
}

// ==========================================
// FILE: ./pc/screens/reports_screen.dart
// ==========================================

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:intl/intl.dart';
import '../../../../core/constants/app_colors.dart';
import '../../../../data/providers/report_builder_provider.dart';
import '../widgets/sidebar.dart';
import '../widgets/reports/reports_header.dart';
import '../widgets/reports/report_card.dart'; // Ensure this file exists or remove import

class ReportsScreen extends ConsumerWidget {
  const ReportsScreen({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    return Scaffold(
      backgroundColor: AppColors.backgroundBlack,
      body: Row(
        children: [
          const DashboardSidebar(),
          Expanded(
            child: Column(
              children: [
                // 1. Standardized Header
                const ReportsHeader(),
                const Divider(height: 1, color: AppColors.divider),
                
                // 2. Scrollable Body
                Expanded(
                  child: SingleChildScrollView(
                    padding: const EdgeInsets.all(32),
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        // A. Top Cards Section
                        _buildTopCardsSection(context),
                        const SizedBox(height: 32),
                        
                        // B. Custom Report Builder
                        _buildCustomReportBuilder(context, ref),
                      ],
                    ),
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  // --- TOP CARDS SECTION ---
  Widget _buildTopCardsSection(BuildContext context) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            const Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text("Generate Reports", style: TextStyle(color: AppColors.textWhite, fontSize: 24, fontWeight: FontWeight.bold)),
                SizedBox(height: 4),
                Text("Select parameters to create custom insights or view recent exports.", style: TextStyle(color: AppColors.textWhite54)),
              ],
            ),
            Row(
              children: [
                OutlinedButton.icon(
                  onPressed: () {}, 
                  icon: const Icon(Icons.history, size: 16),
                  label: const Text("Saved Reports"),
                  style: OutlinedButton.styleFrom(foregroundColor: AppColors.textWhite, side: const BorderSide(color: AppColors.divider), padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 18)),
                ),
                const SizedBox(width: 16),
                ElevatedButton.icon(
                  onPressed: () {
                     // Implement Create Template Dialog
                     // showDialog(context: context, builder: (_) => const CreateTemplateDialog());
                  },
                  icon: const Icon(Icons.add, size: 16),
                  label: const Text("Create New Template"),
                  style: ElevatedButton.styleFrom(backgroundColor: AppColors.primaryBlue, foregroundColor: Colors.white, padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 18)),
                ),
              ],
            ),
          ],
        ),
        const SizedBox(height: 24),
        SizedBox(
          height: 220, // Fixed height for uniformity
          child: Row(
            children: [
              Expanded(child: ReportCard(
                title: "Financial Summary",
                desc: "Comprehensive overview of income, expenses, and net revenue.",
                icon: Icons.account_balance,
                color: AppColors.primaryBlue,
                tags: const ["PDF", "CSV", "Excel"],
                isPopular: true,
                onTap: () {},
              )),
              const SizedBox(width: 24),
              Expanded(child: ReportCard(
                title: "Enrollment Trends",
                desc: "Analyze student capacity, retention rates, and new admissions.",
                icon: Icons.people_alt,
                color: AppColors.accentPurple,
                tags: const ["PDF", "Excel"],
                onTap: () {},
              )),
              const SizedBox(width: 24),
              Expanded(child: ReportCard(
                title: "Outstanding Balances",
                desc: "Detailed list of unpaid tuitions and payment aging reports.",
                icon: Icons.warning_amber_rounded,
                color: AppColors.errorRed,
                tags: const ["PDF", "CSV"],
                onTap: () {},
              )),
            ],
          ),
        ),
      ],
    );
  }

  // --- REPORT BUILDER SECTION ---
  Widget _buildCustomReportBuilder(BuildContext context, WidgetRef ref) {
    // Watching the state provided in previous steps
    final reportState = ref.watch(reportBuilderProvider);
    final notifier = ref.read(reportBuilderProvider.notifier);
    // This calls the helper provider to get the summary map
    final summary = ref.watch(reportSummaryProvider); 

    return Container(
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: AppColors.divider),
      ),
      child: Column(
        children: [
          // Header
          const Padding(
            padding: EdgeInsets.all(24),
            child: Row(
              children: [
                Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text("Custom Report Builder", style: TextStyle(color: AppColors.textWhite, fontSize: 18, fontWeight: FontWeight.bold)),
                    SizedBox(height: 4),
                    Text("Configure specific data points to generate a one-time report.", style: TextStyle(color: AppColors.textWhite54)),
                  ],
                ),
              ],
            ),
          ),
          const Divider(height: 1, color: AppColors.divider),
          
          // Form & Summary Row
          Padding(
            padding: const EdgeInsets.all(32),
            child: Row(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                // LEFT: FORM
                Expanded(
                  flex: 3,
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      _buildLabel("Report Category"),
                      _buildDropdown(
                        value: reportState.category, 
                        items: ["Tuition & Fee Collection", "Expense Analysis", "Student Attendance", "Payroll Summary"],
                        onChanged: (v) => notifier.setCategory(v!),
                      ),
                      const SizedBox(height: 24),
                      
                      Row(
                        children: [
                          Expanded(
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                _buildLabel("Date Range"),
                                _buildDateRangePicker(context, reportState.dateRange, (range) => notifier.setDateRange(range)),
                              ],
                            ),
                          ),
                          const SizedBox(width: 24),
                          Expanded(
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                _buildLabel("Grade Level / Department"),
                                _buildDropdown(
                                  value: reportState.gradeFilter, 
                                  items: ["All Grades", "Grade 1", "Grade 2", "Grade 3", "Grade 4", "Grade 5"],
                                  onChanged: (v) => notifier.setGradeFilter(v!),
                                ),
                              ],
                            ),
                          ),
                        ],
                      ),
                      const SizedBox(height: 24),

                      _buildLabel("Export Format"),
                      Row(
                        children: [
                          _buildRadioTile("PDF Document", "Best for printing", reportState.exportFormat == 'PDF', () => notifier.setExportFormat('PDF')),
                          const SizedBox(width: 16),
                          _buildRadioTile("Excel / CSV", "Best for analysis", reportState.exportFormat == 'Excel/CSV', () => notifier.setExportFormat('Excel/CSV')),
                        ],
                      ),
                    ],
                  ),
                ),
                
                const SizedBox(width: 48),

                // RIGHT: SUMMARY PANEL
                Expanded(
                  flex: 2,
                  child: Container(
                    padding: const EdgeInsets.all(24),
                    decoration: BoxDecoration(
                      color: AppColors.backgroundBlack, 
                      borderRadius: BorderRadius.circular(12),
                      border: Border.all(color: AppColors.divider),
                    ),
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        const Text("SUMMARY", style: TextStyle(color: AppColors.textWhite, fontWeight: FontWeight.bold, letterSpacing: 1.2, fontSize: 12)),
                        const SizedBox(height: 24),
                        
                        _buildSummaryRow("Type:", summary['Type']!),
                        _buildSummaryRow("Period:", summary['Period']!),
                        _buildSummaryRow("Scope:", summary['Scope']!),
                        _buildSummaryRow("Format:", summary['Format']!), 
                        
                        const SizedBox(height: 32),
                        
                        SizedBox(
                          width: double.infinity,
                          child: ElevatedButton(
                            onPressed: () {
                              // Trigger Report Generation Logic via Provider
                            },
                            style: ElevatedButton.styleFrom(
                              backgroundColor: AppColors.primaryBlue,
                              padding: const EdgeInsets.symmetric(vertical: 18),
                              shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
                            ),
                            child: const Text("Generate Report", style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold)),
                          ),
                        ),
                        const SizedBox(height: 12),
                        SizedBox(
                          width: double.infinity,
                          child: OutlinedButton(
                            onPressed: () {
                              // Trigger Preview Dialog
                            },
                            style: OutlinedButton.styleFrom(
                              side: const BorderSide(color: AppColors.divider),
                              padding: const EdgeInsets.symmetric(vertical: 18),
                              shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
                            ),
                            child: const Text("Preview Data", style: TextStyle(color: AppColors.textWhite)),
                          ),
                        ),
                      ],
                    ),
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  // --- UI HELPERS ---

  Widget _buildLabel(String text) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 8.0),
      child: Text(text, style: const TextStyle(color: AppColors.textWhite70, fontSize: 13)),
    );
  }

  Widget _buildDropdown({required String value, required List<String> items, required Function(String?) onChanged}) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 16),
      decoration: BoxDecoration(
        color: AppColors.backgroundBlack,
        borderRadius: BorderRadius.circular(8),
        border: Border.all(color: AppColors.divider),
      ),
      child: DropdownButtonHideUnderline(
        child: DropdownButton<String>(
          value: items.contains(value) ? value : items.first,
          isExpanded: true,
          dropdownColor: AppColors.surfaceGrey,
          icon: const Icon(Icons.keyboard_arrow_down, color: AppColors.textWhite54),
          style: const TextStyle(color: AppColors.textWhite),
          items: items.map((e) => DropdownMenuItem(value: e, child: Text(e))).toList(),
          onChanged: onChanged,
        ),
      ),
    );
  }

  Widget _buildDateRangePicker(BuildContext context, DateTimeRange current, Function(DateTimeRange) onSelect) {
    return InkWell(
      onTap: () async {
        final picked = await showDateRangePicker(
          context: context,
          firstDate: DateTime(2020),
          lastDate: DateTime.now(),
          initialDateRange: current,
          builder: (context, child) => Theme(
            data: ThemeData.dark().copyWith(
              colorScheme: const ColorScheme.dark(
                primary: AppColors.primaryBlue,
                onPrimary: Colors.white,
                surface: AppColors.surfaceGrey,
                onSurface: AppColors.textWhite,
              ),
            ),
            child: child!,
          ),
        );
        if (picked != null) onSelect(picked);
      },
      child: Container(
        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 14),
        decoration: BoxDecoration(
          color: AppColors.backgroundBlack,
          borderRadius: BorderRadius.circular(8),
          border: Border.all(color: AppColors.divider),
        ),
        child: Row(
          children: [
            const Icon(Icons.calendar_today, size: 16, color: AppColors.textWhite54),
            const SizedBox(width: 12),
            Text(
              "${DateFormat('MMM d, yyyy').format(current.start)} - ${DateFormat('MMM d, yyyy').format(current.end)}",
              style: const TextStyle(color: AppColors.textWhite),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildRadioTile(String title, String sub, bool selected, VoidCallback onTap) {
    return Expanded(
      child: InkWell(
        onTap: onTap,
        borderRadius: BorderRadius.circular(8),
        child: Container(
          padding: const EdgeInsets.all(16),
          decoration: BoxDecoration(
            color: selected ? AppColors.primaryBlue.withValues(alpha: 0.1) : AppColors.backgroundBlack,
            borderRadius: BorderRadius.circular(8),
            border: Border.all(color: selected ? AppColors.primaryBlue : AppColors.divider),
          ),
          child: Row(
            children: [
              Icon(
                selected ? Icons.radio_button_checked : Icons.radio_button_unchecked,
                color: selected ? AppColors.primaryBlue : AppColors.textWhite54,
                size: 20,
              ),
              const SizedBox(width: 12),
              Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(title, style: TextStyle(color: selected ? AppColors.primaryBlue : AppColors.textWhite, fontWeight: FontWeight.bold, fontSize: 13)),
                  Text(sub, style: const TextStyle(color: AppColors.textWhite38, fontSize: 11)),
                ],
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildSummaryRow(String label, String value) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 16.0),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          Text(label, style: const TextStyle(color: AppColors.textWhite54, fontSize: 13)),
          Text(value, style: const TextStyle(color: AppColors.textWhite, fontWeight: FontWeight.w600, fontSize: 13, letterSpacing: 0.5), textAlign: TextAlign.end),
        ],
      ),
    );
  }
}
// ==========================================
// FILE: ./shared/layout/responsive_layout.dart
// ==========================================

import 'package:flutter/material.dart';

class ResponsiveLayout extends StatelessWidget {
  final Widget mobileScaffold;
  final Widget pcScaffold;

  // Standard breakpoint: Tablets usually go up to 768px or 1024px.
  // We will treat anything above 850px as PC to accommodate larger tablets/landscape.
  static const double pcBreakpoint = 850.0;

  const ResponsiveLayout({
    super.key,
    required this.mobileScaffold,
    required this.pcScaffold,
  });

  @override
  Widget build(BuildContext context) {
    return LayoutBuilder(
      builder: (context, constraints) {
        if (constraints.maxWidth < pcBreakpoint) {
          return mobileScaffold;
        } else {
          return pcScaffold;
        }
      },
    );
  }
}
// ==========================================
// FILE: ./mobile/widgets/dashboard/create_school_dialog.dart
// ==========================================

import 'package:fees_up/data/providers/auth_provider.dart';
import 'package:fees_up/data/providers/school_provider.dart';
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';

class CreateSchoolDialog extends ConsumerStatefulWidget {
  const CreateSchoolDialog({super.key});

  @override
  ConsumerState<CreateSchoolDialog> createState() => _CreateSchoolDialogState();
}

class _CreateSchoolDialogState extends ConsumerState<CreateSchoolDialog> {
  final _formKey = GlobalKey<FormState>();
  final _nameController = TextEditingController();
  bool _isLoading = false;

  Future<void> _handleCreate() async {
    if (!_formKey.currentState!.validate()) return;
    setState(() => _isLoading = true);

    try {
      final user = ref.read(currentUserProvider);
      if (user == null) throw "User not authenticated";

      // Use the SchoolService to create school & profile atomically
      // This prevents the sync errors we fixed previously
      await ref.read(schoolServiceProvider).createSchool(
        adminId: user.id,
        schoolName: _nameController.text.trim(),
      );

      if (mounted) {
        Navigator.of(context).pop();
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
            content: Text("‚úÖ School Created! Syncing..."), 
            backgroundColor: Colors.green
          ),
        );
      }
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text("Error: $e"), backgroundColor: Colors.red),
        );
      }
    } finally {
      if (mounted) setState(() => _isLoading = false);
    }
  }

  @override
  Widget build(BuildContext context) {
    return Dialog(
      backgroundColor: const Color(0xFF1F2227),
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
      child: Padding(
        padding: const EdgeInsets.all(24.0),
        child: Form(
          key: _formKey,
          child: Column(
            mainAxisSize: MainAxisSize.min,
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              const Row(
                children: [
                  Icon(Icons.domain_add, color: Color(0xFF3B82F6), size: 28),
                  SizedBox(width: 12),
                  Text("Establish Your School", style: TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.bold)),
                ],
              ),
              const SizedBox(height: 16),
              const Text(
                "You are logged in, but no school profile was found. Create one now to start managing fees.",
                style: TextStyle(color: Colors.white70),
              ),
              const SizedBox(height: 24),
              TextFormField(
                controller: _nameController,
                style: const TextStyle(color: Colors.white),
                decoration: InputDecoration(
                  labelText: "School Name",
                  labelStyle: const TextStyle(color: Colors.white54),
                  filled: true,
                  fillColor: Colors.black26,
                  border: OutlineInputBorder(borderRadius: BorderRadius.circular(8)),
                  prefixIcon: const Icon(Icons.school, color: Colors.white24),
                ),
                validator: (v) => v?.isEmpty == true ? "Required" : null,
              ),
              const SizedBox(height: 24),
              SizedBox(
                width: double.infinity,
                height: 48,
                child: ElevatedButton(
                  onPressed: _isLoading ? null : _handleCreate,
                  style: ElevatedButton.styleFrom(
                    backgroundColor: const Color(0xFF3B82F6),
                    foregroundColor: Colors.white,
                  ),
                  child: _isLoading 
                    ? const SizedBox(height: 20, width: 20, child: CircularProgressIndicator(strokeWidth: 2, color: Colors.white))
                    : const Text("Create School"),
                ),
              )
            ],
          ),
        ),
      ),
    );
  }
}
// ==========================================
// FILE: ./mobile/widgets/dashboard/mobile_dashboard_widgets.dart
// ==========================================

import 'package:flutter/material.dart';
import '../../../core/constants/app_colors.dart';

// 1. CAROUSEL CARD (Fixed width for horizontal scrolling)
class MobileStatCard extends StatelessWidget {
  final String title;
  final String value;
  final IconData icon;
  final Color iconColor;
  final Color iconBgColor;
  final bool isAlert;
  final Widget? footer;

  const MobileStatCard({
    super.key,
    required this.title,
    required this.value,
    required this.icon,
    required this.iconColor,
    required this.iconBgColor,
    this.isAlert = false,
    this.footer,
  });

  @override
  Widget build(BuildContext context) {
    return Container(
      width: 280, // Fixed width for mobile carousel
      margin: const EdgeInsets.only(right: 12),
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(16),
        border: isAlert 
            ? const Border(left: BorderSide(color: AppColors.errorRed, width: 4))
            : Border.all(color: Colors.white10),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Text(
                title.toUpperCase(),
                style: const TextStyle(color: Colors.white54, fontSize: 11, fontWeight: FontWeight.bold),
              ),
              Container(
                padding: const EdgeInsets.all(8),
                decoration: BoxDecoration(color: iconBgColor, borderRadius: BorderRadius.circular(8)),
                child: Icon(icon, size: 16, color: iconColor),
              ),
            ],
          ),
          const SizedBox(height: 12),
          Text(
            value,
            style: const TextStyle(color: Colors.white, fontSize: 26, fontWeight: FontWeight.bold),
          ),
          const SizedBox(height: 12),
          if (footer != null) footer!,
        ],
      ),
    );
  }
}

// 2. QUICK ACTION BUTTON (Mobile Grid Style)
class MobileQuickAction extends StatelessWidget {
  final IconData icon;
  final String label;
  final VoidCallback onTap;
  final bool isPrimary;

  const MobileQuickAction({
    super.key, 
    required this.icon, 
    required this.label, 
    required this.onTap,
    this.isPrimary = false,
  });

  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onTap: onTap,
      child: Container(
        decoration: BoxDecoration(
          color: isPrimary ? AppColors.primaryBlue : AppColors.surfaceGrey,
          borderRadius: BorderRadius.circular(16),
          border: Border.all(color: Colors.white10),
        ),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Icon(
              icon, 
              size: 28, 
              color: isPrimary ? Colors.white : AppColors.primaryBlueLight
            ),
            const SizedBox(height: 8),
            Text(
              label,
              textAlign: TextAlign.center,
              style: TextStyle(
                color: isPrimary ? Colors.white : Colors.white70,
                fontSize: 12,
                fontWeight: FontWeight.bold,
              ),
            ),
          ],
        ),
      ),
    );
  }
}

// 3. TRANSACTION TILE (Compact List Item)
class MobileTransactionTile extends StatelessWidget {
  final String name;
  final String date;
  final String amount;
  final bool isPaid;

  const MobileTransactionTile({
    super.key,
    required this.name,
    required this.date,
    required this.amount,
    required this.isPaid,
  });

  @override
  Widget build(BuildContext context) {
    return Container(
      margin: const EdgeInsets.only(bottom: 12),
      padding: const EdgeInsets.all(12),
      decoration: BoxDecoration(
        color: AppColors.surfaceGrey,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: Colors.white.withAlpha(12)),
      ),
      child: Row(
        children: [
          CircleAvatar(
            backgroundColor: Colors.white10,
            radius: 20,
            child: Text(name[0], style: const TextStyle(color: Colors.white, fontWeight: FontWeight.bold)),
          ),
          const SizedBox(width: 12),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(name, style: const TextStyle(color: Colors.white, fontWeight: FontWeight.bold)),
                Text(date, style: const TextStyle(color: Colors.white38, fontSize: 12)),
              ],
            ),
          ),
          Column(
            crossAxisAlignment: CrossAxisAlignment.end,
            children: [
              Text(amount, style: const TextStyle(color: Colors.white, fontWeight: FontWeight.bold)),
              const SizedBox(height: 4),
              Container(
                padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                decoration: BoxDecoration(
                  color: isPaid ? AppColors.successGreen.withAlpha(51) : AppColors.errorRed.withAlpha(51),
                  borderRadius: BorderRadius.circular(4),
                ),
                child: Text(
                  isPaid ? "PAID" : "OWED",
                  style: TextStyle(
                    color: isPaid ? AppColors.successGreen : AppColors.errorRed,
                    fontSize: 10,
                    fontWeight: FontWeight.bold,
                  ),
                ),
              ),
            ],
          ),
        ],
      ),
    );
  }
}
// ==========================================
// FILE: ./mobile/screens/mobile_home_screen.dart
// ==========================================

import 'package:fees_up/mobile/widgets/dashboard/create_school_dialog.dart';
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:go_router/go_router.dart';
import 'package:intl/intl.dart';
import '../../../core/constants/app_colors.dart';
import '../../data/providers/dashboard_provider.dart';
import '../../data/services/database_service.dart'; // For connectivity
import '../widgets/dashboard/mobile_dashboard_widgets.dart';
import '../../pc/widgets/dashboard/stat_cards.dart';

class MobileHomeScreen extends ConsumerStatefulWidget {
  const MobileHomeScreen({super.key});

  @override
  ConsumerState<MobileHomeScreen> createState() => _MobileHomeScreenState();
}

class _MobileHomeScreenState extends ConsumerState<MobileHomeScreen> {
  // Visual state for nav bar
  int _calculateSelectedIndex(BuildContext context) {
    final String location = GoRouterState.of(context).uri.toString();
    if (location.startsWith('/transactions')) return 1;
    if (location.startsWith('/students')) return 2;
    if (location.startsWith('/profile')) return 3;
    return 0;
  }

  void _onItemTapped(int index) {
    if (index == 0) {
      context.go('/');
    } else if (index == 1) {
      context.go('/transactions');
    } else if (index == 2) {
      context.go('/students');
    } else if (index == 3) {
      context.go('/profile');
    }
  }

  void _showCreateSchoolDialog(BuildContext context) {
    showDialog(
      context: context,
      barrierDismissible: false, // Force decision
      builder: (ctx) => const CreateSchoolDialog(),
    );
  }

  @override
  Widget build(BuildContext context) {
    final dashboardAsync = ref.watch(dashboardDataProvider);
    final int navIndex = _calculateSelectedIndex(context);

    // Check connectivity status directly from your DatabaseService/PowerSync
    final bool isConnected = DatabaseService().db.currentStatus.connected;

    return Scaffold(
      backgroundColor: AppColors.backgroundBlack,
      body: dashboardAsync.when(
        // 1. LOADING STATE
        // ignore: prefer_const_constructors
        loading: () => Center(
          child: const Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              CircularProgressIndicator(color: AppColors.primaryBlue),
              SizedBox(height: 16),
              Text("Loading School Data...",
                  style: TextStyle(color: Colors.white54))
            ],
          ),
        ),

        // 2. ERROR STATE
        error: (err, stack) => Center(
          child: Padding(
            padding: const EdgeInsets.all(24.0),
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                const Icon(Icons.error_outline,
                    color: AppColors.errorRed, size: 40),
                const SizedBox(height: 16),
                Text("Error: $err",
                    style: const TextStyle(color: Colors.white),
                    textAlign: TextAlign.center),
                const SizedBox(height: 16),
                ElevatedButton(
                  onPressed: () => ref.refresh(dashboardDataProvider),
                  child: const Text("Retry"),
                )
              ],
            ),
          ),
        ),

        // 3. DATA LOADED
        data: (data) {
          // --- LOGIC: CHECK IF SCHOOL EXISTS ---
          // If schoolId is empty or name is "Loading...", we treat it as "No School Found"
          final bool hasSchool =
              data.schoolId.isNotEmpty && data.schoolName != 'Loading...';

          return Scaffold(
            backgroundColor: AppColors.backgroundBlack,

            appBar: AppBar(
              backgroundColor: AppColors.backgroundBlack,
              elevation: 0,
              title: Row(
                children: [
                  // --- PROFILE ICON WITH INTELLIGENT ON-TAP ---
                  InkWell(
                    onTap: () {
                      if (!hasSchool) {
                        // Triggers the global create dialog if school is missing
                        _showCreateSchoolDialog(context);
                      } else {
                        context.go('/profile');
                      }
                    },
                    borderRadius: BorderRadius.circular(50),
                    child: CircleAvatar(
                      backgroundColor: hasSchool
                          ? AppColors.surfaceGrey
                          : AppColors.warningOrange,
                      radius: 18,
                      child: hasSchool
                          ? Text(
                              data.userName.isNotEmpty ? data.userName[0] : "U",
                              style: const TextStyle(
                                  fontSize: 12,
                                  color: Colors.white,
                                  fontWeight: FontWeight.bold))
                          : const Icon(Icons.priority_high,
                              size: 18,
                              color: Colors.black), // Alert Icon if no school
                    ),
                  ),
                  const SizedBox(width: 12),
                  Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                          // Fallback name if loading
                          data.userName.isEmpty
                              ? "User"
                              : "Hello, ${data.userName.split(' ')[0]}",
                          style: const TextStyle(
                              fontSize: 14,
                              fontWeight: FontWeight.bold,
                              color: Colors.white)),

                      // Show "Syncing..." or School Name
                      Text(
                          hasSchool
                              ? data.schoolName
                              : (isConnected
                                  ? "Tap to Setup School"
                                  : "Waiting for Sync..."),
                          style: TextStyle(
                              fontSize: 10,
                              color: hasSchool
                                  ? Colors.white.withAlpha(127)
                                  : AppColors.warningOrange)),
                    ],
                  ),
                ],
              ),
              actions: [
                IconButton(
                    onPressed: () {},
                    icon: const Icon(Icons.notifications_none,
                        color: Colors.white)),
              ],
            ),

            body: Stack(
              children: [
                // MAIN CONTENT
                SingleChildScrollView(
                  padding: const EdgeInsets.all(16),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      const Text("Dashboard",
                          style: TextStyle(
                              color: Colors.white,
                              fontSize: 24,
                              fontWeight: FontWeight.bold)),
                      const SizedBox(height: 16),

                      // KPI CARDS CAROUSEL
                      SizedBox(
                        height: 170,
                        child: ListView(
                          scrollDirection: Axis.horizontal,
                          children: [
                            MobileStatCard(
                              title: "Outstanding",
                              value: NumberFormat.simpleCurrency()
                                  .format(data.outstandingBalance),
                              icon: Icons.receipt_long,
                              iconColor: AppColors.errorRed,
                              iconBgColor: const Color(0x22CF6679),
                              isAlert: data.outstandingBalance > 0,
                              footer: const AlertBadge(
                                  text: "Live", subText: "Updated via Sync"),
                            ),
                            MobileStatCard(
                              title: "Students",
                              value: data.studentCount.toString(),
                              icon: Icons.school,
                              iconColor: AppColors.primaryBlue,
                              iconBgColor: const Color(0x222962FF),
                            ),
                          ],
                        ),
                      ),

                      const SizedBox(height: 24),

                      // RECENT PAYMENTS LIST
                      Row(
                        mainAxisAlignment: MainAxisAlignment.spaceBetween,
                        children: [
                          const Text("Recent Transactions",
                              style: TextStyle(
                                  color: Colors.white,
                                  fontSize: 16,
                                  fontWeight: FontWeight.bold)),
                          TextButton(
                              onPressed: () {},
                              child: const Text("View All",
                                  style: TextStyle(fontSize: 12))),
                        ],
                      ),

                      if (data.recentPayments.isEmpty)
                        const Padding(
                          padding: EdgeInsets.only(top: 10),
                          child: Text("No transactions yet.",
                              style: TextStyle(color: Colors.grey)),
                        ),

                      ...data.recentPayments
                          .map((payment) => MobileTransactionTile(
                                name: payment['payer_name'] ?? 'Unknown',
                                date: payment['date_paid'] != null
                                    ? DateFormat('MMM d, h:mm a').format(
                                        DateTime.parse(payment['date_paid']))
                                    : '',
                                amount: NumberFormat.simpleCurrency()
                                    .format(payment['amount']),
                                isPaid: true,
                              )),

                      const SizedBox(height: 80),
                    ],
                  ),
                ),

                // --- GLOBAL OVERLAY: "NO SCHOOL" BLOCKER ---
                if (!hasSchool)
                  Positioned.fill(
                    child: Container(
                      color: Colors.black.withAlpha(0.85 * 255 as int), // Dim background
                      child: Center(
                        child: Container(
                          margin: const EdgeInsets.all(24),
                          padding: const EdgeInsets.all(24),
                          decoration: BoxDecoration(
                            color: AppColors.surfaceGrey,
                            borderRadius: BorderRadius.circular(16),
                            border: Border.all(color: Colors.white10),
                          ),
                          child: Column(
                            mainAxisSize: MainAxisSize.min,
                            children: [
                              // ICON: Depends on Internet Connection
                              Icon(
                                isConnected
                                    ? Icons.domain_add
                                    : Icons.cloud_off,
                                size: 48,
                                color: isConnected
                                    ? AppColors.primaryBlue
                                    : Colors.grey,
                              ),
                              const SizedBox(height: 16),

                              Text(
                                isConnected
                                    ? "Welcome to Fees Up!"
                                    : "Syncing Data...",
                                style: const TextStyle(
                                    color: Colors.white,
                                    fontSize: 20,
                                    fontWeight: FontWeight.bold),
                                textAlign: TextAlign.center,
                              ),
                              const SizedBox(height: 8),

                              // TEXT: Fallback Logic
                              Text(
                                isConnected
                                    ? "It looks like you haven't set up a school yet. Create one to get started."
                                    : "We are waiting for your school data to download. Please check your internet connection.",
                                style: const TextStyle(color: Colors.white70),
                                textAlign: TextAlign.center,
                              ),
                              const SizedBox(height: 24),

                              // ACTION BUTTON
                              if (isConnected)
                                ElevatedButton(
                                  onPressed: () =>
                                      _showCreateSchoolDialog(context),
                                  style: ElevatedButton.styleFrom(
                                    backgroundColor: AppColors.primaryBlue,
                                    padding: const EdgeInsets.symmetric(
                                        horizontal: 32, vertical: 12),
                                  ),
                                  child: const Text("Create School Profile",
                                      style: TextStyle(color: Colors.white)),
                                )
                              else
                                const Padding(
                                  padding: EdgeInsets.all(8.0),
                                  child: CircularProgressIndicator(
                                      color: Colors.white),
                                ),
                            ],
                          ),
                        ),
                      ),
                    ),
                  ),
              ],
            ),

            // BOTTOM NAV
            bottomNavigationBar: Container(
              decoration: const BoxDecoration(
                  border: Border(top: BorderSide(color: Colors.white10))),
              child: BottomNavigationBar(
                backgroundColor: AppColors.surfaceGrey,
                currentIndex: navIndex,
                onTap: _onItemTapped,
                selectedItemColor: AppColors.primaryBlue,
                unselectedItemColor: Colors.white38,
                type: BottomNavigationBarType.fixed,
                showUnselectedLabels: true,
                items: const [
                  BottomNavigationBarItem(
                      icon: Icon(Icons.grid_view_rounded), label: "Home"),
                  BottomNavigationBarItem(
                      icon: Icon(Icons.receipt_long_rounded),
                      label: "Transact"),
                  BottomNavigationBarItem(
                      icon: Icon(Icons.school_outlined), label: "Students"),
                  BottomNavigationBarItem(
                      icon: Icon(Icons.person_outline), label: "Profile"),
                ],
              ),
            ),
          );
        },
      ),
    );
  }
}
// ==========================================
// FILE: ./mobile/screens/auth/mobile_signup_screen.dart
// ==========================================

import 'package:fees_up/data/providers/auth_provider.dart';
import 'package:flutter/foundation.dart'; // For kIsWeb
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:supabase_flutter/supabase_flutter.dart';
import '../../../core/constants/app_colors.dart';

class MobileAuthScreen extends ConsumerStatefulWidget {
  final bool initialIsLogin; 
  const MobileAuthScreen({super.key, this.initialIsLogin = true});

  @override
  ConsumerState<MobileAuthScreen> createState() => _MobileAuthScreenState();
}

class _MobileAuthScreenState extends ConsumerState<MobileAuthScreen> {
  final _formKey = GlobalKey<FormState>();
  
  // Controllers
  final _emailController = TextEditingController();
  final _passwordController = TextEditingController();
  final _nameController = TextEditingController();
  final _schoolNameController = TextEditingController(); 

  late bool _isLogin;
  bool _isLoading = false;
  bool _isObscure = true;

  @override
  void initState() {
    super.initState();
    _isLogin = widget.initialIsLogin;
  }

  /// Handles Email/Password Auth
  Future<void> _handleAuth() async {
    if (!_formKey.currentState!.validate()) return;

    setState(() => _isLoading = true);
    try {
      final authRepo = ref.read(authRepositoryProvider);

      if (_isLogin) {
        await Supabase.instance.client.auth.signInWithPassword(
          email: _emailController.text.trim(),
          password: _passwordController.text.trim(),
        );
      } else {
        await authRepo.signUpWithSchool(
          fullName: _nameController.text.trim(),
          email: _emailController.text.trim(),
          password: _passwordController.text.trim(),
          schoolName: _schoolNameController.text.trim(),
        );
      }
      // Success is handled by the Router listening to Auth State changes
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text(e.toString()), backgroundColor: AppColors.errorRed),
        );
      }
    } finally {
      if (mounted) setState(() => _isLoading = false);
    }
  }

  /// Handles Google OAuth
  Future<void> _handleGoogleLogin() async {
    setState(() => _isLoading = true);
    try {
      // 1. Web: Redirects to URL
      // 2. Mobile: Opens Browser -> Redirects back to app via Deep Link
      // Ensure you added 'io.supabase.flutterquickstart://login-callback' (or your custom scheme) 
      // to the "Redirect URLs" in Supabase Auth Settings.
      await Supabase.instance.client.auth.signInWithOAuth(
        OAuthProvider.google,
        redirectTo: kIsWeb ? null : 'io.supabase.flutterquickstart://login-callback',
      );
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text("Google Login Failed: $e"), backgroundColor: AppColors.errorRed),
        );
      }
    } finally {
      if (mounted) setState(() => _isLoading = false);
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.transparent, 
      body: Container(
        // Fallback gradient if not covered by PC wrapper
        decoration: const BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
            colors: [Color(0xFF0F172A), Color(0xFF020617)],
          ),
        ),
        child: SafeArea(
          child: Center(
            child: SingleChildScrollView(
              padding: const EdgeInsets.symmetric(horizontal: 24.0, vertical: 16),
              child: Form(
                key: _formKey,
                child: Column(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    // --- HEADER ---
                    Container(
                      padding: const EdgeInsets.all(16),
                      decoration: BoxDecoration(
                        color: const Color(0xFF0F3946),
                        borderRadius: BorderRadius.circular(20),
                        border: Border.all(color: Colors.white10),
                      ),
                      child: Icon(
                        _isLogin ? Icons.lock_open : Icons.security, 
                        size: 32, 
                        color: AppColors.successGreen
                      ),
                    ),
                    const SizedBox(height: 24),
                    Text(
                      _isLogin ? "Welcome Back" : "Setup School",
                      style: Theme.of(context).textTheme.headlineMedium?.copyWith(
                        color: Colors.white, fontWeight: FontWeight.bold
                      ),
                    ),
                    const SizedBox(height: 8),
                    Text(
                      _isLogin 
                        ? "Login to access your financial dashboard" 
                        : "Create admin account & school profile",
                      style: const TextStyle(color: Colors.grey),
                      textAlign: TextAlign.center,
                    ),
                    const SizedBox(height: 40),

                    // --- FORM FIELDS ---
                    if (!_isLogin) ...[
                      _buildSectionLabel("ADMINISTRATOR"),
                      _buildTextField(
                        controller: _nameController,
                        icon: Icons.badge_outlined,
                        hint: "Admin Full Name",
                      ),
                      const SizedBox(height: 16),
                    ],

                    _buildTextField(
                      controller: _emailController,
                      icon: Icons.email_outlined,
                      hint: "admin@school.edu",
                      inputType: TextInputType.emailAddress,
                    ),
                    const SizedBox(height: 16),
                    _buildTextField(
                      controller: _passwordController,
                      icon: Icons.lock_outline,
                      hint: "Password",
                      isPassword: true,
                      isObscure: _isObscure,
                      onToggleObscure: () => setState(() => _isObscure = !_isObscure),
                    ),

                    if (!_isLogin) ...[
                      const SizedBox(height: 32),
                      _buildSectionLabel("SCHOOL DETAILS"),
                      _buildTextField(
                        controller: _schoolNameController,
                        icon: Icons.school_outlined,
                        hint: "School Name",
                      ),
                    ],

                    const SizedBox(height: 32),

                    // --- SUBMIT BUTTON ---
                    SizedBox(
                      width: double.infinity,
                      height: 56,
                      child: ElevatedButton(
                        onPressed: _isLoading ? null : _handleAuth,
                        style: ElevatedButton.styleFrom(
                          backgroundColor: const Color(0xFF3B82F6),
                          shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                          elevation: 4,
                        ),
                        child: _isLoading 
                          ? const SizedBox(width: 24, height: 24, child: CircularProgressIndicator(color: Colors.white, strokeWidth: 2))
                          : Row(
                              mainAxisAlignment: MainAxisAlignment.center,
                              children: [
                                Text(
                                  _isLogin ? "Log In" : "Create School", 
                                  style: const TextStyle(fontSize: 16, fontWeight: FontWeight.bold, color: Colors.white)
                                ),
                                const SizedBox(width: 8),
                                const Icon(Icons.arrow_forward, color: Colors.white),
                              ],
                            ),
                      ),
                    ),

                    const SizedBox(height: 32),

                    // --- GOOGLE LOGIN ---
                    Row(
                      children: [
                        const Expanded(child: Divider(color: Colors.white12)),
                        Padding(
                          padding: const EdgeInsets.symmetric(horizontal: 16),
                          child: Text(
                            "Or continue with",
                            style: TextStyle(color: Colors.white.withAlpha(128), fontSize: 12),
                          ),
                        ),
                        const Expanded(child: Divider(color: Colors.white12)),
                      ],
                    ),
                    const SizedBox(height: 24),
                    
                    SizedBox(
                      width: double.infinity,
                      child: OutlinedButton(
                        onPressed: _isLoading ? null : _handleGoogleLogin,
                        style: OutlinedButton.styleFrom(
                          padding: const EdgeInsets.symmetric(vertical: 16),
                          side: BorderSide(color: Colors.white.withAlpha(26)),
                          shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                          backgroundColor: Colors.white.withAlpha(13),
                        ),
                        child: const Row(
                          mainAxisAlignment: MainAxisAlignment.center,
                          children: [
                            // You can replace this Icon with an SVG asset for the colorful 'G' logo
                            Icon(Icons.g_mobiledata, color: Colors.white, size: 28),
                            SizedBox(width: 8),
                            Text("Sign in with Google", style: TextStyle(color: Colors.white, fontWeight: FontWeight.w600)),
                          ],
                        ),
                      ),
                    ),

                    const SizedBox(height: 32),
                    
                    // --- TOGGLE MODE ---
                    Row(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        Text(
                          _isLogin ? "Don't have an account? " : "Already have an admin account? ", 
                          style: const TextStyle(color: Colors.grey)
                        ),
                        GestureDetector(
                          onTap: () {
                            setState(() {
                              _isLogin = !_isLogin;
                              _formKey.currentState?.reset(); 
                            });
                          },
                          child: Text(
                            _isLogin ? "Create School" : "Log In", 
                            style: const TextStyle(color: Colors.white, fontWeight: FontWeight.bold, decoration: TextDecoration.underline)
                          ),
                        ),
                      ],
                    ),
                    const SizedBox(height: 40),
                  ],
                ),
              ),
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildSectionLabel(String label) {
    return Align(
      alignment: Alignment.centerLeft,
      child: Padding(
        padding: const EdgeInsets.only(bottom: 12.0),
        child: Text(
          label,
          style: const TextStyle(color: Color(0xFF3B82F6), fontWeight: FontWeight.bold, letterSpacing: 1.0, fontSize: 12),
        ),
      ),
    );
  }

  Widget _buildTextField({
    required TextEditingController controller,
    required IconData icon,
    required String hint,
    bool isPassword = false,
    bool isObscure = false,
    VoidCallback? onToggleObscure,
    TextInputType inputType = TextInputType.text,
  }) {
    return TextFormField(
      controller: controller,
      obscureText: isObscure,
      keyboardType: inputType,
      style: const TextStyle(color: Colors.white),
      decoration: InputDecoration(
        filled: true,
        fillColor: const Color(0xFF1E293B),
        hintText: hint,
        hintStyle: const TextStyle(color: Colors.white38),
        prefixIcon: Icon(icon, color: Colors.white54),
        suffixIcon: isPassword
            ? IconButton(
                icon: Icon(isObscure ? Icons.visibility_off : Icons.visibility, color: Colors.white54),
                onPressed: onToggleObscure,
              )
            : null,
        border: OutlineInputBorder(borderRadius: BorderRadius.circular(12), borderSide: BorderSide.none),
        focusedBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(12), borderSide: const BorderSide(color: Color(0xFF3B82F6), width: 1.5)),
      ),
      validator: (val) {
        if (val == null || val.isEmpty) return 'Required';
        if (isPassword && val.length < 6) return 'Min 6 chars';
        return null;
      },
    );
  }
}